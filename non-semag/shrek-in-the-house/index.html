<html>
<head><script>(function(w,i,g){w[g]=w[g]||[];if(typeof w[g].push=='function')w[g].push(i)})
(window,'AW-1055364430','google_tags_first_party');</script><script async src="/925q/"></script>
			<script>
				window.dataLayer = window.dataLayer || [];
				function gtag(){dataLayer.push(arguments);}
				gtag('js', new Date());
				gtag('set', 'developer_id.dYzg1YT', true);
				gtag('config', 'AW-1055364430');
			</script>
			
<!--Meta stuff-->
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.0.0/animate.min.css"/>
<script src="https://kit.fontawesome.com/9881acdaa7.js" crossorigin="anonymous"></script>
<script src="js/lagged.js" onload="LaggedAPI.init(true);"></script>
<title>Shrek In The House</title>
<style>
    * {
        -moz-box-sizing: border-box;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        font-family: sans-serif;
        font-weight: 400;
        outline: none;
        user-select: none;
        margin:0;
    }
    body{
        overflow: hidden;
        overscroll-behavior: contain;
        user-select: none;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
    body, canvas, object {
        touch-action: none;
        display: block;overflow: hidden;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -webkit-text-size-adjust: none;
        -webkit-tap-highlight-color: transparent;
        -webkit-tap-highlight-color: transparent;
        touch-action-delay: none;
    }
    canvas {
    display: block;
    width: 100vw;
    height: 100vh;
    }
</style>
<style>
    * {
        -moz-box-sizing: border-box;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        font-family: sans-serif;
        font-weight: 400;
        outline: none;
        user-select: none;
    }
    body {
        margin: 0;
        overflow: hidden;
    }
    #loading {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        color: white;
        text-align: center;
        font-size: 30px;
        font-weight: 100;
        background-color: #4153A5;
        text-shadow:         /* create a black outline */
        -1px -1px 0 #000,
         0   -1px 0 #000,
         1px -1px 0 #000,
         1px  0   0 #000,
         1px  1px 0 #000,
         0    1px 0 #000,
        -1px  1px 0 #000,
        -1px  0   0 #000;

    }
    #loading>div {
        margin-top: 30vh;
    }
    .progress {
        margin-top: 1vh;
        display: inline-block;
        border-radius: 10vw;
        width: 50vw;
        height: 1.5vw;
        background-color: #2B292A;
    }
    #progressbar {
        width: 0;
        border-radius: 10vw;
        height: 1.5vw;
        background: rgb(253,105,41);
        background: -moz-linear-gradient(90deg, rgba(253,105,41,1) 19%, rgba(244,192,41,1) 100%);
        background: -webkit-linear-gradient(90deg, rgba(253,105,41,1) 19%, rgba(244,192,41,1) 100%);
        background: linear-gradient(90deg, rgba(253,105,41,1) 19%, rgba(244,192,41,1) 100%);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr="#fd6929",endColorstr="#f4c029",GradientType=1);
    }
    #lagged {
        margin-bottom: 10vh;
        display: inline-block;
        width: 30vh;
        height: 30vh;
        background-image: url(Images/lagged.png);
        background-repeat: no-repeat;
        background-size:contain;
    }
    #c {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        display: block;
    }
    /* END */


    /* GAME UI */
    #gameUI {
        position: fixed;
        text-align: center;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        visibility: hidden;
    }
    #lvlNo {
        display: inline-block;
        margin-top: 5px;
        text-align: center;
        color: white;
        font-size: 300%;
        font-weight: 800;
        text-shadow: 0px 4px 0px rgba(0, 0, 0, 0.6),2px 2px 4px #000000,         /* create a black outline */
        -1px -1px 0 #000,
         0   -1px 0 #000,
         1px -1px 0 #000,
         1px  0   0 #000,
         1px  1px 0 #000,
         0    1px 0 #000,
        -1px  1px 0 #000,
        -1px  0   0 #000;
        opacity: 0.6;
    }
    #collectedList{
        display: inline-block;
        text-align: center;
        list-style-type:none;
        width: 100%;
        margin: 0;
        padding: 0;
        margin-top: 10px;
    }
    #collectedList li {
        display: inline-block;
        margin-left: 5px;
        background-image: url(Images/imageIcon.png);
        background-repeat: no-repeat;
        background-size:contain;
        width: 70px;
        height: 70px;

        -webkit-filter: grayscale(1) drop-shadow(2px 4px 6px black);
        -moz-filter: grayscale(1) drop-shadow(2px 4px 6px black);
        -ms-filter: grayscale(1) drop-shadow(2px 4px 6px black);
        -o-filter: grayscale(1) drop-shadow(2px 4px 6px black);
        filter: grayscale(1) drop-shadow(2px 4px 6px black);
    }
    /* END */


    /* GAMEOVER UI */
    #gameOverUI {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        text-align: center;
        visibility: hidden;
        background-color: rgba(0,0,0,0.4);
    }
    #moreGames {
        display: inline-block;
        width: 400px;
        height: 400px;
        background-color: rgba(0,0,0,0.5);
        color: white;
        margin-top: -5px;
        text-align: center;
        padding: 10px;
    }
    #moreGames h3{
        float: left;
        clear: both;
        width: 100%;
        line-height: 19px;
        height: 19px;
        font-size: 17px;
        font-weight: 600;
        margin: 0 0 5px 0;
    }
    .thumbWrapper {
        overflow: hidden;
        position: relative;
        background-color: #a5a5a5;
        box-shadow: 0 0 4px 0 rgb(0 0 0 / 50%);
        margin: 1% 2% 1% 2.6%;
        width: 45%;
        border-radius: 5px;
        float: left;
        display: block;
    }
    .thumbWrapper a {
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        z-index: 200;
        display: block;
        float: left;
        width: 100%;
    }
    .thumbWrapper img {
        width: 100%;
        height: auto;
        border-radius: 2px;
    }
    .thumbWrapper span.thumbname{
        position:absolute;transition:bottom .25s ease;font-size:15px;font-weight:700;letter-spacing:1px;width:100%;bottom:-125%;left:0;height:auto;min-height:18px;line-height:20px;padding:7px 0 4px;text-align:center;text-transform:uppercase;background-color:rgba(42,100,144,.8);color:#fff;border-bottom-left-radius:2px;border-bottom-right-radius:2px
    }
    .thumbWrapper:hover span.thumbname{
        bottom: -1%;
    }
    #btnNext{
        display: inline-block;
        margin-top: 15vh;
        background-image: url(Images/btnNextLevel.png);
        background-repeat: no-repeat;
        background-size:contain;
        width: 300px;
        height: 140px;
    }
    #btnRestart{
        display: inline-block;
        margin-top: 15vh;
        background-image: url(Images/btnRestart.png);
        background-repeat: no-repeat;
        background-size:contain;
        width: 300px;
        height: 140px;
    }
    #goMessage {
        color: white;
        font-size: 300%;
        font-weight: 800;

        display: inline-block;
        margin-top: 1%;
        text-shadow: 0px 4px 0px rgba(0, 0, 0, 0.6),2px 2px 4px #000000,
        -1px -1px 0 #000,
         0   -1px 0 #000,
         1px -1px 0 #000,
         1px  0   0 #000,
         1px  1px 0 #000,
         0    1px 0 #000,
        -1px  1px 0 #000,
        -1px  0   0 #000;
    }
    /* END */


    /*MISC*/
    #btnSound {
        position: fixed;
        left: 10px;
        top: 15px;
        font-size: 30px;
        visibility: hidden;
        color: white;
    }
    .button {
        transition: all .1s;
        cursor: pointer;
        user-select: none;
    }
    .button:hover {
        transform: scale(1.15);
    }
    #redFX{
        position: fixed;
        right: 0%;
        top: 0%;
        width: 100%;
        height: 100%;
        background-color: rgba(255,0,0,0.5);
        visibility: hidden;
        user-select: none;
        pointer-events: none;
        --animate-duration: 1.6s;
    }
    #touchLeft {
        position: fixed;
        left: 0%;
        top: 0%;
        width: 50%;
        height: 100%;
        opacity: 0.5;
    }
    #touchRight {
        position: fixed;
        right: 0%;
        top: 0%;
        width: 50%;
        height: 100%;
    }
    #tutorial {
        position: fixed;
        text-align: center;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        visibility: hidden;
        pointer-events: none;
    }
    #tutorialImage {
        display: inline-block;
        width: 700px;
        height: 500px;
        background-image: url(Images/keyboardControls.png);
        background-repeat: no-repeat;
        background-size: contain;
        margin-top: 250px;
        pointer-events: none;
    }
    /* END */


    /*RESPONSIVE*/
    #rotateDeviceBG {
        background-color: rgba(0,0,0,1);
        position: fixed;
        width: 100%;
        height: 100%;
        text-align: center;
        visibility: hidden;
    }
    .phone {
        margin-top: 20%;
        display: inline-block;
        height: 100px;
        width: 200px;
        border: 4px solid white;
        border-radius: 10px;
        animation: rotate 1.5s ease-in-out infinite alternate;
    }
    .message {
        position: fixed;
        width: 100%;
        height: 10%;
        left: 0;
        text-align: center;
        color: white;
        font-size: 200%;
        font-weight: 800;
        bottom: 10%;
      /* display: none; */
    }
    @keyframes rotate {
      0% {
            transform: rotate(0deg)
        }
        50% {
            transform: rotate(-90deg)
        }
        100% {
            transform: rotate(-90deg)
        }
    }
    @media only screen and (max-width: 950px) {
        #loading {
            font-size: 20px;
        }
        .progress {
            width: 70vw;
        }
        #lvlNo {
            font-size: 200%;
        }
        #collectedList li {
            width: 40px;
            height: 40px;
        }
        #btnSound {
            font-size: 25px;
        }
        #moreGames {
            width: 200px;
            height: 210px;
            margin-top: -5vh;
        }
        #goMessage {
            font-size: 150%;
            font-weight: 800;
            margin-top: 5px;
        }
        #btnNext{
            width: 200px;
            height: 90px;
            margin-top: 5vh;
        }
        #btnRestart{
            width: 200px;
            height: 90px;
            margin-top: 5vh;
        }
    }
    @media only screen and (max-height: 670px) {
        #goMessage {
            margin-top: -1px;
        }
        #btnNext{
            margin-top: 3vh;
        }
        #btnRestart{
            margin-top: 3vh;
        }
    }

</style>

</head>
<body>
<script src="./Libs/three.min.js"></script>
<script src="./Libs/FBXLoader.js"></script>
<script src="./Libs/inflate.min.js"></script>
<script src="./Libs/SkeletonUtils.js"></script>
<script src="./Libs/virtualjoystick.js"></script>

<div id="loading">
    <div>
        <div id="lagged"></div>
        <div id="progressText">0%</div>
        <div class="progress"><div id="progressbar"></div></div>
        <div>Loading...</div>
    </div>
</div>

<canvas id="c"></canvas>

<div id="gameUI">
    <div id="lvlNo">Level 1</div><br>
    <ul id="collectedList">

    </ul>
    <div id="touchLeft" ></div>
    <div id="touchRight" ></div>
</div>

<div id="tutorial">
    <div id="tutorialImage"></div><br>
</div>

<div id="gameOverUI">
    <div id="btnRestart" onclick="btnGO()" class="animate__animated animate__rubberBand animate__infinite animate__slow button"></div><br>
    <div id="btnNext" onclick="btnGO()" class="animate__animated animate__rubberBand animate__infinite animate__slow button"></div><br>
    <div id="goMessage" class="animate__animated animate__tada animate__infinite">Level Complete!</div><br>
</div>

<div id="btnSound"  class="button" onclick="btnSound()"><i class="fa-solid fa-volume-high"></i></div>
<div id="redFX" class="animate__fast"></div>

<div id="rotateDeviceBG">
    <div class="phone">
    </div>
    <div class="message">
      Please rotate your device!
    </div>
</div>

<script>
// GLOBAL VAR
console.warn = function(){};
var scene = null;
var camera = null;
var renderer = null;
var clock = new THREE.Clock();
var onMobile = false;
var joystick = null;

// RESETABLE VARS
var player = null;
var enemy = null;
var totalCollectibles = 0;
var gameOver = false;
var level = 1;

// Load save
var loadSave = null;
try{
    loadSave = parseInt(localStorage.getItem("shrekInTheHouseLaggedGameSave"));
}catch(e){
    console.log(e);
}
if (loadSave){
    level = loadSave;
}


// RESETABLE ARRAYS
var updateArray = [];
var doorArray = [];
var blinkLightsArray = [];
var colliders = [];
var triggersArray = [];
var collectibleArray = [];
var enemyVisionArray = [];
var enemyArray = [];

const BaseModel = {
    enemy: {url: 'Models/shrek.fbx'},
    level1: {url: 'Models/level1.fbx'},
    level2: {url: 'Models/level2.fbx'},
    level3: {url: 'Models/level3.fbx'},
    level4: {url: 'Models/level4.fbx'},
    level5: {url: 'Models/level5.fbx'},
    level6: {url: 'Models/level6.fbx'},
    level7: {url: 'Models/level7.fbx'},
    level8: {url: 'Models/level8.fbx'},
    collectible: {url: 'Models/collectible.fbx'},
}
const Anims = {
    idle: {url: 'Models/a_idle.fbx'},
    walk: {url: 'Models/a_walk.fbx'},
    jumpscare: {url: 'Models/a_jumpscare.fbx'},
}
const Textures = {
    shadow: {url: 'Images/shadow.png'},
}
const Sound = {
    button: {url: 'Sound/button.mp3'},
    gameOver: {url: 'Sound/gameOver.mp3'},
    jumpscare: {url: 'Sound/jumpscare.mp3'},
    music: {url: 'Sound/music.mp3'},
    walk: {url: 'Sound/walk.mp3'},
    collect: {url: 'Sound/collect.mp3'},
    breathing: {url: 'Sound/breathing.mp3'},
    chase: {url: 'Sound/chasing.mp3'},
}

// DOM elements
const CANVAS = document.querySelector('#c');
const PROGRESS_TEXT = document.querySelector('#progressText');

// GAME UI
const GAME_UI = document.querySelector('#gameUI');
const LEVEL_TEXT = document.querySelector('#lvlNo');
const COLLECTED_LIST = document.querySelector('#collectedList');

// GAMEOVER UI
const GAMEOVER_UI = document.querySelector('#gameOverUI');
const GO_MESSAGE = document.querySelector('#goMessage');
const BTN_RESTART = document.querySelector('#btnRestart');
const BTN_NEXT = document.querySelector('#btnNext');

// MISC
const BTN_SOUND = document.querySelector('#btnSound');
const TUTORIAL = document.querySelector('#tutorial');
const TUTORIAL_IMAGE = document.querySelector('#tutorialImage');
const RED_FX = document.querySelector('#redFX');
const ROTATE_MSG  = document.querySelector('#rotateDeviceBG');
const TOUCH_LEFT = document.querySelector('#touchLeft');
const TOUCH_RIGHT = document.querySelector('#touchRight');

function preload() {
    const progressbarElem = document.querySelector('#progressbar');
    let manager = new THREE.LoadingManager();
    manager.onStart = function ( url, itemsLoaded, itemsTotal ) {
        //console.log( 'Started loading file: ' + url + '.\nLoaded ' + itemsLoaded + ' of ' + itemsTotal + ' files.' );
    };
    manager.onLoad = function ( ) {
        //console.log( 'Loading complete!');
        init();
        // hide the loading bar
        const loadingElem = document.querySelector('#loading');
        loadingElem.style.display = 'none';
    };
    manager.onProgress = function ( url, itemsLoaded, itemsTotal ) {
        //console.log( 'Loading file: ' + url + '.\nLoaded ' + itemsLoaded + ' of ' + itemsTotal + ' files.' );
        progressbarElem.style.width = `${itemsLoaded / itemsTotal * 100 | 0}%`;
        PROGRESS_TEXT.innerHTML = `${itemsLoaded / itemsTotal * 100 | 0}%`;
    };
    manager.onError = function ( url ) {
        //console.log( 'There was an error loading ' + url );
    };

    var loader = new THREE.FBXLoader( manager );
    // load base character model
    for (const model of Object.values(BaseModel)) {
        loader.load( model.url, function ( fbx ) {
            model.fbx = fbx;
        });
    }
    // load anims
    for (const model of Object.values(Anims)) {
        loader.load( model.url, function ( fbx ) {
            //model.fbx = fbx;
            model.animation = fbx.animations[ 0 ];
        });
    }
    // load textures
    var loaderTex = new THREE.TextureLoader(manager);
    for (const img of Object.values(Textures)) {
        loaderTex.load( img.url, function(texture) {
            texture.encoding = THREE.sRGBEncoding;
            img.texture = texture;
        });
    }
    // load audio
    Sound.listener = new THREE.AudioListener();
    const audioLoader = new THREE.AudioLoader( manager );
    for (const key of Object.values(Sound)) {
        audioLoader.load( key.url, function(buffer) {
            key.sound = new THREE.Audio( Sound.listener );
            key.sound.setBuffer( buffer );
            key.sound.setVolume( 1 );
            if (key.url == 'Sound/music.mp3'){
                key.sound.setLoop( true );
                key.sound.setVolume( 1 );
            }
            if (key.url == 'Sound/jumpscare.mp3'){
                key.sound.setVolume( 3 );
            }
            if (key.url == 'Sound/breathing.mp3'){
                key.sound.setVolume( 2 );
            }
        });
    }
}

function init(){
    if (is_touch_device()){
        onMobile = true;
        joystick	= new VirtualJoystick({
            container	: TOUCH_LEFT,
            mouseSupport	: true,
            strokeStyle	: 'transparent',
            limitStickTravel: true,
            stickRadius	: 10
        });
        TOUCH_RIGHT.addEventListener('touchmove', touchMoved, false);
        TOUCH_RIGHT.addEventListener('touchstart', touchStart, false);
    }
    BTN_SOUND.style.visibility = "visible";
    GAME_UI.style.visibility = "visible";

    renderer = new THREE.WebGLRenderer({canvas: CANVAS, antialias: true,});
    renderer.setPixelRatio( 0.6 );
    renderer.setSize( window.innerWidth, window.innerHeight );
    renderer.outputEncoding = THREE.sRGBEncoding;


    camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 14000 );
    camera.position.set(0, 500, 1000);
    camera.lookAt(0,0,0);
    camera.add( Sound.listener );

    scene = new THREE.Scene();
    scene.background = new THREE.Color( 0x000000 );

    window.addEventListener('resize', onWindowResize, false );
    window.addEventListener("mousemove", onMouseMove, false);
    window.addEventListener("keydown", onKeyDown, false);
    window.addEventListener("keyup", onKeyUp, false);
    GAME_UI.onclick = function () {
         this.requestPointerLock();
    }

    setUpLevel();
    animate();
    Sound.walk.sound.play();
    Sound.walk.sound.pause();
}

function setUpLevel() {
    // UI
    GAME_UI.style.visibility = "visible";
    GAMEOVER_UI.style.visibility = "hidden";
    if (level == 1){
        if (!onMobile){
            TUTORIAL_IMAGE.style.backgroundImage = 'url(Images/keyboardControls.png)';
        }else {
            TUTORIAL_IMAGE.style.backgroundImage = 'url(Images/touchControls.png)';
            TUTORIAL_IMAGE.style.width = '80%';
            TUTORIAL_IMAGE.style.height = '100%';
            TUTORIAL_IMAGE.style.marginTop = '20px';
        }
        TUTORIAL.style.visibility = "visible";
        setTimeout(function(){
            TUTORIAL.style.visibility = "hidden";
        },2500)
    }
    LEVEL_TEXT.innerHTML = "LEVEL "+level;
    // END

    // LIGHTS
    var ambientLight = new THREE.AmbientLight( 0xFFFFFF, 0.05 );
    scene.add( ambientLight );

    // ENVIRONMENT - LEVEL
    levelModel = null;
    if (level < 9)
        levelModel = eval('BaseModel.level'+level+'.fbx.clone()');
    else {
        let randomLevel = rand(4,8);
        levelModel = eval('BaseModel.level'+randomLevel+'.fbx.clone()');
    }
    levelModel.traverse(function ( child ) {
        if ( child instanceof THREE.Mesh ) {
            const oldMat = child.material;
            child.material = new THREE.MeshPhongMaterial( {map: oldMat.map, color: oldMat.color, side: THREE.DoubleSide, shininess: 0} );
            //enemyVisionArray.push(child);
            if (oldMat.name == 'Door1' || oldMat.name == 'Door2' || oldMat.name == 'Door3'){
                doorArray.push(child);
                child.rotateTo = child.rotation.z;
                child.defaultRotation = child.rotation.z;

                enemyVisionArray.push(child);
            }
            else if (oldMat.name == 'collision'){
                colliders.push(child);
                child.material = new THREE.MeshBasicMaterial( { visible: false });
                child.box3 = new THREE.Box3().setFromObject(child);

                enemyVisionArray.push(child);
            }
            else if (oldMat.name == 'trigger'){ // mommy trigger
                // triggersArray.push(child);
                child.material = new THREE.MeshBasicMaterial( { visible: false });
                // child.box3 = new THREE.Box3().setFromObject(child);
                enemy = new Enemy(child.position);
            }
            else if (oldMat.name == 'Wall_End'){
                child.material = new THREE.MeshPhongMaterial( { map: oldMat.map, transparent: true, shininess: 0, side: THREE.DoubleSide, depthWrite: false});
            }
            else if (oldMat.name == 'Lamp'){
                child.material = new THREE.MeshBasicMaterial( { map: oldMat.map, });
            }
            else if (oldMat.name == 'Light'){
                let pointLight = new THREE.PointLight( 0xFFFFFF, 1, 1000 );
                pointLight.position.x = child.position.x;
                pointLight.position.y = child.position.y-50;
                pointLight.position.z = child.position.z;
                scene.add( pointLight );
                pointLight.timer = rand(30, 80);
                child.material = new THREE.MeshBasicMaterial( { map: oldMat.map });
                blinkLightsArray.push(pointLight);
                pointLight.model = child;
            }
            else if (oldMat.name == 'doll'){
                let collectible = BaseModel.collectible.fbx.clone();
                child.visible = false;
                collectible.traverse(function ( child ) {
                    if ( child instanceof THREE.Mesh ) {
                        const oldMat2 = child.material;
                        child.material = new THREE.MeshPhongMaterial( { emissiveIntensity: 1.3, map: oldMat2.map,});
                    }
                });
                scene.add(collectible);
                collectible.position.copy(child.position);
                collectible.position.y = -175;
                collectible.scale.set(0.7,0.7,0.7);
                collectible.box3 = new THREE.Box3().setFromObject(collectible);
                collectibleArray.push(collectible);
            }
            else {
                enemyVisionArray.push(child);
            }
        }
    });
    scene.add(levelModel);
    levelModel.position.y = -230;
    totalCollectibles = collectibleArray.length;
    COLLECTED_LIST.innerHTML = "";
    if (totalCollectibles > 0){
        for (let i = 0; i < totalCollectibles; i ++){
            var li = document.createElement("li");
            //li.setAttribute("class", "you");
            COLLECTED_LIST.appendChild(li);
        }
    }
    camera.lookAt(0,0,0);
    inputs.yaw = 0;
    inputs.pitch = 0;
    // END

    // SPAWN PLAYER AND ENEMY
    player = new Player();
    //enemy = new Enemy();
}

function Player() {
    var self = {
        score: 0,
        position: new THREE.Vector3(0, 0, 0),
        velocity: new THREE.Vector3(),
        maxMovementSpeed: 5,
        friction: 0,
        acceleration: 0,
        maxSpeedTime: 0.2,
        stopTime: 0.2,
        raycaster: new THREE.Raycaster(),
        dirTemp: new THREE.Vector3(0,0,0),
        posTemp: new THREE.Vector3(),
        sin: 0,
        state: 'idle',
        initialCooldown: 100,
        dollsCollected: 0,
        enemyIndex: null,
    }
    self.init = function(){
        self.friction= self.maxMovementSpeed / self.stopTime;
        self.acceleration= self.friction + self.maxMovementSpeed / self.maxSpeedTime;

        // boundingbox
        self.box = new THREE.Mesh(new THREE.BoxGeometry(70, 220, 60), new THREE.MeshBasicMaterial( { color: 0x124463, wireframe:true, /*side: THREE.DoubleSide,*/ visible: false }));
        scene.add(self.box);
        self.boundingBox = new THREE.BoxHelper(self.box, 0x00ff00);
        self.box3 = new THREE.Box3().setFromObject(self.box);
        enemyVisionArray.push(self.box);
        self.box.player = true;

        // Flashlight
        self.spotLight = new THREE.SpotLight(0xffffff, 1, 0, Math.PI * 0.115, 0.3);
        scene.add(self.spotLight);
        scene.add( self.spotLight.target );
    }
    self.getMovementDir = function() {
        var moveDir = new THREE.Vector3();
        if (inputs.moveForward) {
            moveDir.x += Math.sin(inputs.yaw);
            moveDir.z += Math.cos(inputs.yaw);
        } else if (inputs.moveBackward) {
            moveDir.x -= Math.sin(inputs.yaw);
            moveDir.z -= Math.cos(inputs.yaw);
        }
        if (inputs.moveRight) {
            moveDir.x -= Math.cos(inputs.yaw);
            moveDir.z += Math.sin(inputs.yaw);
        } else if (inputs.moveLeft) {
            moveDir.x += Math.cos(inputs.yaw);
            moveDir.z -= Math.sin(inputs.yaw);
        }
        return moveDir;
    }
    self.move = function(delta) {
        var moveDir = self.getMovementDir();

        var acc = self.acceleration;
        var fric = self.friction;

        var max = self.maxMovementSpeed;

        accelerate(delta, self.velocity, moveDir, acc, max);
        friction(delta, self.velocity, fric);

        self.position.add(self.velocity);
        self.box.position.copy(self.position);
        //self.box.position.y += 50;
    }
    self.collision = function(delta){
        for (let i in colliders){
            let child = colliders[i];
            if (child instanceof THREE.Mesh) {
                collision = self.box3.intersectsBox(child.box3);
                if (collision){

                    var overlapX = Math.min( self.box3.max.x, child.box3.max.x ) - Math.max( self.box3.min.x, child.box3.min.x );

                    if ( overlapX < 0 ) return false;

                    var overlapY = Math.min( self.box3.max.y, child.box3.max.y ) - Math.max( self.box3.min.y, child.box3.min.y );

                    if ( overlapY < 0 ) return false;

                    var overlapZ = Math.min( self.box3.max.z, child.box3.max.z ) - Math.max( self.box3.min.z, child.box3.min.z );

                    if ( overlapZ < 0 ) return false;

                    var minOverlap = Math.min( overlapX, overlapZ );
                    var x = y = z = 0;

                    switch ( minOverlap ) {

                        case overlapX:

                            x = Math.sign( self.box3.min.x + self.box3.max.x - child.box3.min.x - child.box3.max.x );
                            self.position.x += (x * minOverlap);
                            break;

                        case overlapY:

                            y = Math.sign( self.box3.min.y + self.box3.max.y - child.box3.min.y - child.box3.max.y );
                            break;

                        case overlapZ:

                            z = Math.sign( self.box3.min.z + self.box3.max.z - child.box3.min.z - child.box3.max.z );
                            self.position.z += (z * minOverlap);
                            break;
                    }
                }
            }
        }

        // opening closing doors when near and looking at
        self.posTemp.copy(camera.position);
        camera.getWorldDirection(self.dirTemp);
        self.raycaster.set(self.posTemp,self.dirTemp);
        const intersect = self.raycaster.intersectObjects(doorArray);
        if (intersect.length>0){
            if (intersect[0].distance < 700){
                // open doors
                intersect[0].object.rotateTo = intersect[0].object.defaultRotation+THREE.Math.degToRad(90);
            }
            else {
                intersect[0].object.rotateTo = intersect[0].object.defaultRotation;
            }
        }

        // collision withe enemy - JUMPSCARE & GAMEOVER
        self.initialCooldown -= 100*delta;
        if (enemy){
            for (let e in enemyArray){
                let collision = self.box3.intersectsBox(enemyArray[e].box3);
                if (collision && self.initialCooldown < 0){
                    // trigger jump scare
                    self.enemyIndex = e;
                    gameOver = true;
                    enemyArray[e].scare = true;
                    enemyArray[e].mixer.stopAllAction();
                    enemyArray[e].jumpScare.fadeIn(0.2);
                    enemyArray[e].jumpScare.play();

                    self.redFX();
                    levelModel.visible = false;
                    for (let ee in enemyArray){
                        if (enemyArray[ee].group.uuid != enemyArray[e].group.uuid){
                            enemyArray[ee].group.visible = false;
                        }
                    }
                    setTimeout(function(){
                        self.spotLight.intensity = 0;
                        gameOverFunction('loose');
                    },1800)
                    setTimeout(function(){
                        if (Sound.jumpscare.sound.isPlaying)
                            Sound.jumpscare.sound.stop();
                        Sound.jumpscare.sound.play();
                    },400)
                }
            }
        }
        // collect dolls
        for (let i in collectibleArray){
            let child = collectibleArray[i];
            let collision = self.box3.intersectsBox(child.box3);
            if (collision && self.initialCooldown < 0){
                scene.remove(collectibleArray[i]);
                collectibleArray.splice(i,1);
                let child_nodes = COLLECTED_LIST.childNodes;
                child_nodes[self.dollsCollected].style.filter = 'drop-shadow(2px 4px 6px black)';
                child_nodes[self.dollsCollected].style.webkitFilter = 'drop-shadow(2px 4px 6px black)';
                child_nodes[self.dollsCollected].style.MozFilter = 'drop-shadow(2px 4px 6px black)';
                child_nodes[self.dollsCollected].style.OFilter = 'drop-shadow(2px 4px 6px black)';
                child_nodes[self.dollsCollected].style.msFilter = 'drop-shadow(2px 4px 6px black)';


                self.dollsCollected ++;
                Sound.collect.sound.play();
                if (self.dollsCollected == totalCollectibles){
                    gameOver = true;
                    // if (enemy.chase){
                    // if (!enemy.chase){
                    //     enemy.group.position.copy(camera.position);
                    //     //enemy.group.position.y = 0;
                    //
                    // }
                    Sound.gameOver.sound.play();
                        //enemy.scare = true;
                        //enemy.mixer.stopAllAction();
                        //enemy.die.fadeIn(0.2);
                        //enemy.die.play();
                        // confetti
                        setTimeout(function(){
                            gameOverFunction('win');
                        },500)
                    // }
                    // else {
                    //     gameOverFunction('win');
                    // }
                }
            }
        }
    }
    self.redFX = function() {
        RED_FX.style.visibility = "visible";
        RED_FX.classList.add('animate__animated', 'animate__fadeOut');
        RED_FX.addEventListener('animationend', removeMenu);
        function removeMenu() {
            RED_FX.removeEventListener('animationend', removeMenu);
            RED_FX.classList.remove('animate__animated', 'animate__fadeOut');
            RED_FX.style.visibility = "hidden";
            RED_FX.style.opacity = "1";
        }
    }
    self.update = function(delta) {
        self.box3.setFromObject(self.box);
        self.boundingBox.setFromObject(self.box);
        // FLASHLIGHT
        self.spotLight.position.copy(camera.position);
        self.posTemp.x = camera.position.x;
        self.posTemp.z = camera.position.z;
        camera.getWorldDirection(self.dirTemp);
        var distance = 1000; // at what distance to determine pointB
        var pointB = new THREE.Vector3();
        pointB.addVectors ( self.posTemp, self.dirTemp.multiplyScalar( distance ) );
        let flashLightDelay = 7;
        self.spotLight.target.position.x = THREE.Math.lerp( self.spotLight.target.position.x, pointB.x, flashLightDelay*delta  );
        self.spotLight.target.position.y = THREE.Math.lerp( self.spotLight.target.position.y, pointB.y, flashLightDelay*delta  );
        self.spotLight.target.position.z = THREE.Math.lerp( self.spotLight.target.position.z, pointB.z, flashLightDelay*delta  );
        // END
        if(!gameOver) {
            self.collision(delta);
            self.move(delta);

            // WALK ANIM + RUN
            if (inputs.moveLeft || inputs.moveRight || inputs.moveForward || inputs.moveBackward) {
                self.sin += 20*delta;
                self.state = 'walk';
                self.maxMovementSpeed = 6;
                if (!Sound.walk.sound.isPlaying)
                    Sound.walk.sound.play();
            }
            else {
                self.state = 'idle';
                if (Sound.walk.sound.isPlaying)
                    Sound.walk.sound.stop();
            }
            // END

            // CAMERA AS PLAYER
            camera.quaternion.setFromEuler(new THREE.Euler(inputs.pitch, inputs.yaw + Math.PI, 0, "YXZ"));
            //camera.position.copy(self.position);
            camera.position.x = self.position.x;
            camera.position.z = self.position.z;
            // WALK ANIM
            if (self.state != 'idle'){
                // if (self.state == 'run')
                //     camera.position.y +=  Math.sin(self.sin)*(600*delta);
                // else
                    camera.position.y +=  Math.sin(self.sin)*(300*delta);
            }
            if (self.state == 'idle'){
                camera.position.y = 0;
            }
            // END
        }
        if (gameOver && self.enemyIndex){
            var worldPos = enemyArray[self.enemyIndex].group.getWorldPosition(new THREE.Vector3());
            worldPos.z -= 600;//-1500
            worldPos.y += 200;
            camera.position.lerp(worldPos, 20*delta);
            let pos = enemyArray[self.enemyIndex].group.position.clone();
            pos.y -= 500; // 200
            pos.z += 300; // 200
            camera.lookAt(pos);
            //enemyArray[self.enemyIndex].group.position.y = 1600;
        }
    }

    self.init();
    updateArray.push(self);
    return self;
}

function Enemy(spawnPos) {
    var self = {
        group: null,
        model: null,
        mixer: null,
        raycaster: new THREE.Raycaster(),
        tempDirVec: new THREE.Vector3(),
        chase: false,
        scare: false,
        breathingSoundCooldown: 0,
        chaseSoundCooldown: 0,
    }
    self.init = function(){
        // MODEL
        self.group = new THREE.Object3D();
        scene.add(self.group);
        self.group.position.set(spawnPos.x,0,spawnPos.z);

        self.model = THREE.SkeletonUtils.clone(BaseModel.enemy.fbx);
        self.model.traverse(function ( child ) {
            if ( child instanceof THREE.Mesh ) {
                const oldMat = child.material;
                // if (oldMat.name == 'hairs' || oldMat.name == 'hairs2'){
                //     child.material = new THREE.MeshLambertMaterial( {map: oldMat.map, transparent: true, skinning: true,side: THREE.DoubleSide});
                // }
                // else
                    child.material = new THREE.MeshPhongMaterial( {map: oldMat.map, skinning: true,side: THREE.DoubleSide, shininess: 0});//emissiveIntensity: 0.5
            }
            child.frustumCulled = false;
        });
        self.model.scale.set(1.4,1.4,1.4);
        self.model.position.y = -450;
        self.group.add(self.model);
        // END

        let rw = rand(1,2);
        // ANIMATIONS
        self.mixer = new THREE.AnimationMixer(self.model);
        self.idle = self.mixer.clipAction(Anims.idle.animation);
        self.walk = self.mixer.clipAction(Anims.walk.animation);
        self.jumpScare = self.mixer.clipAction(Anims.jumpscare.animation);
        self.jumpScare.timeScale = 1.2;
        self.walk.timeScale = 1;

        self.idle.play();

        self.jumpScare.setLoop( THREE.LoopOnce );
        self.jumpScare.clampWhenFinished = true;
        self.jumpScare._clip.name = "scare";

        self.mixer.addEventListener( 'finished', function( e ) {
            if (e.action._clip.name == "scare"){
                // gameOverFunction('loose');
            }
        });
        // END

        // SHADOW
        self.shadow = new THREE.Mesh(new THREE.CircleGeometry(240, 6, 15), new THREE.MeshBasicMaterial({
            map: Textures.shadow.texture,
            transparent: true,
            opacity: 0.35,
            depthWrite: false,
        }));
        self.shadow.rotation.x = THREE.Math.degToRad(-90);
        self.group.add(self.shadow);
        self.shadow.position.y -= 427;
        self.shadow.position.z += 50;
        // END

        // collider
        self.box = new THREE.Mesh(new THREE.BoxGeometry(150, 300, 150), new THREE.MeshBasicMaterial({ side: THREE.DoubleSide, visible: false}));
        self.box.position.y = -80;
        self.group.add(self.box);
        self.boundingBox = new THREE.BoxHelper(self.box, 0x00ff00);
        //scene.add(self.boundingBox);
        self.box3 = new THREE.Box3().setFromObject(self.box);
    }
    self.vision = function(delta) {
        // VISION
        self.group.getWorldDirection(self.tempDirVec);
        self.raycaster.set(self.group.position, self.tempDirVec);
        let intersect = self.raycaster.intersectObjects(enemyVisionArray);
        if (intersect.length > 0) {
            if (intersect[0].object.player)
                self.chase = true;
            else
                self.chase = false;
        }
        else {
            self.chase = false;
        }
        // END

        // MOVE
        if (self.chase){
            lerpSpeed = 1;
            let distance = self.group.position.distanceTo(camera.position);
            if (self.walk.isRunning()){
                //if (distance > 1000){
                    if (level == 2){
                        self.group.translateZ(500*delta);
                    }
                    else {
                        self.group.translateZ(500*delta);//700
                    }

                //}
                // else {
                //     self.group.position.x = THREE.MathUtils.lerp( self.group.position.x, camera.position.x, lerpSpeed*delta  );
                //     self.group.position.z = THREE.MathUtils.lerp( self.group.position.z, camera.position.z, lerpSpeed*delta  );
                //     self.group.position.y = 0;
                // }
            }
            if (!self.walk.isRunning()){
                self.mixer.stopAllAction();
                self.walk.fadeIn(0.4);
                self.walk.play();
            }
        }
        else {
            if (!self.idle.isRunning()){
                self.mixer.stopAllAction();
                self.idle.fadeIn(0.2);
                self.idle.play();
            }
        }
        // END
    }
    self.update = function(delta) {
        self.mixer.update(delta);
        self.boundingBox.setFromObject(self.box);
        self.box3.setFromObject(self.box);

        self.group.lookAt(camera.position);
        if (!self.scare)
            self.vision(delta);
        // else {
        //     // lerpSpeed = 1;
        //     // targetZ = self.group.position.z+100;
        //     // self.group.position.x = THREE.MathUtils.lerp( self.group.position.x, camera.position.x, lerpSpeed*delta  );
        //     // self.group.position.z = THREE.MathUtils.lerp( self.group.position.z, camera.position.z-300, lerpSpeed*delta  );
        //     //self.group.translateZ(THREE.MathUtils.lerp( self.group.position.z, targetZ, lerpSpeed*delta  ));
        //
        //     var worldPos = self.group.getWorldPosition(new THREE.Vector3());
        //     worldPos.z -= 100;//-1500
        //     //worldPos.y -= 330;
        //     //worldPos.y += 1000;// 808
        //     camera.position.lerp(worldPos, 20*delta);
        //     pos = self.group.position.clone();
        //     //pos.y -= 150; // 200
        //     //pos.z += 500; // 200
        //     camera.lookAt(pos);
        // }

        if (!gameOver){
            self.breathingSoundCooldown -= 10*delta;
            self.chaseSoundCooldown -= 10*delta;
            if (self.chase && self.chaseSoundCooldown < 0) {
                self.chaseSoundCooldown = 100;
                if (Sound.chase.sound.isPlaying)
                    Sound.chase.sound.stop();
                Sound.chase.sound.play();
                if (Sound.breathing.sound.isPlaying)
                    Sound.breathing.sound.stop();
                Sound.breathing.sound.play();
            }
            if (!self.chase && self.breathingSoundCooldown < 0) {
                self.breathingSoundCooldown = 100;
                if (Sound.breathing.sound.isPlaying)
                    Sound.breathing.sound.stop();
                Sound.breathing.sound.play();
            }
        }
    }

    self.init();
    updateArray.push(self);
    enemyArray.push(self);
    return self;
}

function gameOverFunction(type) {
    Sound.walk.sound.pause();
    //Sound.gameOver.sound.play();
    try{
        document.exitPointerLock();
    }catch(e){
        console.log(e);
    }
    
    console.log(type);
    gameOver = true;
    GAMEOVER_UI.style.visibility = "visible";

    if (type == 'loose'){
        GO_MESSAGE.innerHTML = "Try Again..!";
        BTN_RESTART.style.display = "inline-block";
        BTN_NEXT.style.display = "none";
    }
    else {
        level ++;
        GO_MESSAGE.innerHTML = "Level Complete!";
        BTN_RESTART.style.display = "none";
        BTN_NEXT.style.display = "inline-block";

        var ach=false;
        var ach_numb=[];
        if(level>2){
            ach=true;
            ach_numb.push("shrek_inthehouse_elzge001");
        }
        if(level>5){
            ach=true;
            ach_numb.push("shrek_inthehouse_elzge002");
        }
        if(level>10){
            ach=true;
            ach_numb.push("shrek_inthehouse_elzge003");
        }

        //can push more then one award at a time
        if(ach){
            LaggedAPI.Achievements.save(ach_numb, function(response) {
                if(response.success) {
                    console.log('achievement saved')
                }else {
                    console.log(response.errormsg);
                }
            });
        }

        // Save
        try{
            localStorage.setItem("shrekInTheHouseLaggedGameSave",level);
        }catch(e){
          console.log(e);
        }
    }
}

function reset() {
    for( var i = scene.children.length - 1; i >= 0; i--)
        scene.remove(scene.children[i]);
    player = null;
    enemy = null;
    gameOver = false;
    totalCollectibles = 0;
    updateArray = [];
    doorArray = [];
    blinkLightsArray = [];
    colliders = [];
    triggersArray = [];
    collectibleArray = [];
    enemyVisionArray = [];
    enemyArray = [];
}

// BUTTONS
function btnGO() {
    Sound.button.sound.play();
    // Lagged API show ad on after game over screen interaction
    if (Sound.music.sound.isPlaying)
        Sound.music.sound.pause();
    LaggedAPI.APIAds.show(function() {
        // ad is finished, unpause game/music
        console.log("ad completed");
        if (!Sound.music.sound.isPlaying)
            Sound.music.sound.play();
        // start new level below
        reset();
        setUpLevel();
    });
}

function btnSound() {
    Sound.button.sound.play();
    if (BTN_SOUND.style.opacity == 1){
        BTN_SOUND.style.opacity = 0.5;
        Sound.listener.setMasterVolume(0);
    }
    else {
        BTN_SOUND.style.opacity = 1;
        Sound.listener.setMasterVolume(1);
    }
}
// END

// CONTROLS
var inputs = {
  moveForward: false,
  moveBackward: false,
  moveLeft: false,
  moveRight: false,
  run: false,
  yaw: 0,
  pitch: 0,
};
var active = false;
document.onpointerlockchange = function () {
    if (document.pointerLockElement) {
        active = true;
        if (!Sound.music.sound.isPlaying)
            Sound.music.sound.play();
    } else {
        active = false;
    }
}

var previousEvent = {screenX: 0, screenY: 0};
function touchStart(event) {
    let touch = event.changedTouches[0];
    previousEvent.screenX = touch.pageX;
    previousEvent.screenY = touch.pageY;
    if (!Sound.music.sound.isPlaying)
        Sound.music.sound.play();
}

function touchMoved(event) {
    let movementX = 0;
    let movementY = 0;
    let touch = event.changedTouches[0];
    movementX = touch.pageX - previousEvent.screenX;
    movementY = touch.pageY - previousEvent.screenY;

    inputs.yaw -= movementX * 0.00006;// 0.001
    inputs.pitch -= movementY * 0.00006;// 0.001
    if (inputs.pitch < -1.5){
        inputs.pitch = -1.5;
    }
    else if (inputs.pitch > 1.5){
        inputs.pitch = 1.5;
    }

}

// touch walking
function touchControls() {
    if (!joystick) return;

    if ( joystick.left() ) {
        inputs.moveLeft = true;
    }
    else if (inputs.moveLeft) {
        inputs.moveLeft = false;
    }
    if ( joystick.right() ) {
        inputs.moveRight = true;
    }
    else if (inputs.moveRight){
        inputs.moveRight = false;
    }
    if ( joystick.up() ) {
        inputs.moveForward = true;
    }
    else if (inputs.moveForward){
        inputs.moveForward = false;
    }
    if ( joystick.down() ) {
        inputs.moveBackward = true;
    }
    else if (inputs.moveBackward){
        inputs.moveBackward = false;
    }
}

function onMouseMove(event) {
  if (active) {
    inputs.yaw -= event.movementX * 0.003;// 0.001
    inputs.pitch -= event.movementY * 0.003;// 0.001
      if (inputs.pitch < -1.5){
          inputs.pitch = -1.5;
      }
      else if (inputs.pitch > 1.5){
          inputs.pitch = 1.5;
      }
  }
}

function onKeyDown(event) {
  switch (event.keyCode) {
    case 87:
      inputs.moveForward = true;
      break;
    case 83:
      inputs.moveBackward = true;
      break;
    case 65:
      inputs.moveLeft = true;
      break;
    case 68:
      inputs.moveRight = true;
      break;
    case 82: // R to restart
        reset();
        setUpMenu();
        break;
    case 16:
      inputs.run = true;
      break;
  }
}

function onKeyUp(event) {
  switch (event.keyCode) {
    case 87:
      inputs.moveForward = false;
      break;
    case 83:
      inputs.moveBackward = false;
      break;
    case 65:
      inputs.moveLeft = false;
      break;
    case 68:
      inputs.moveRight = false;
      break;
    case 16:
      inputs.run = false;
      break;
  }
}
// END

// ACTUAL GAME
function animate(){
    requestAnimationFrame( animate );
    var delta = clock.getDelta();
    if (delta > 0.2)
        delta = 0;

    for (let i in updateArray){
        updateArray[i].update(delta);
    }
    for (let i in doorArray){
        doorArray[i].rotation.z = THREE.Math.lerp( doorArray[i].rotation.z, doorArray[i].rotateTo, 3*delta  );
    }
    for (let i in collectibleArray){
        collectibleArray[i].rotation.y += 1.3*delta;
    }
    for (let i in blinkLightsArray){
        blinkLightsArray[i].timer -= 10*delta;
        if (blinkLightsArray[i].timer < 0){
            blinkLightsArray[i].timer = rand(30, 80);
            blinkLightsArray[i].intensity = 0;
            blinkLightsArray[i].model.visible = false;
            setTimeout(function(){
                if (blinkLightsArray[i]){
                    blinkLightsArray[i].intensity = 0.5;
                    blinkLightsArray[i].model.visible = true;
                }
                setTimeout(function(){
                    if (blinkLightsArray[i]){
                        blinkLightsArray[i].intensity = 0;
                        blinkLightsArray[i].model.visible = false;
                    }
                    setTimeout(function(){
                        if (blinkLightsArray[i]){
                            blinkLightsArray[i].intensity = 1;
                            blinkLightsArray[i].model.visible = true;
                        }
                    }, 1000)
                }, 1000)
            }, 1000)
        }
    }

    touchControls();
    showLandscapeMessage();
    renderer.render( scene, camera );
}
preload();
// END

// HELPER AND EXTRA STUFF
function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();

    renderer.setSize( window.innerWidth, window.innerHeight );
}

function rand(min, max) {
    min = Math.ceil(min);
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min + 1)) + min; //The maximum is inclusive and the minimum is inclusive
}

function showLandscapeMessage() { // landscape on mobile
    if (onMobile) {
        if (window.innerWidth < window.innerHeight){
            ROTATE_MSG.style.visibility = "visible";
        }
        else if (ROTATE_MSG.style.visibility == "visible"){
            ROTATE_MSG.style.visibility = "hidden";
        }
    }
}

function is_touch_device() {
  try {
    document.createEvent("TouchEvent");
    return true;
  } catch (e) {
    return false;
  }
}
// END

// HELPER MOVE
function accelerate(delta, velocity, moveDir, acceleration, maxSpeed) {
  var projection = velocity.dot(moveDir);
  var amount = acceleration * delta;
  if (maxSpeed && projection + amount > maxSpeed) {
    amount = maxSpeed - projection;
  }
  velocity.add(moveDir.clone().multiplyScalar(amount));
}

function friction(delta, velocity, amount) {
  var speed = Math.hypot(velocity.x, velocity.z);
  if (speed > 0) {
    var newSpeed = speed - amount * delta;
    if (newSpeed < 0) newSpeed = 0;
    velocity.x *= newSpeed / speed;
    velocity.z *= newSpeed / speed;
  }
}
// END

</script>
</body>
</html>
