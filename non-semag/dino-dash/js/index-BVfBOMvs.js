function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
var eA=Object.defineProperty;var tA=(r,e,t)=>e in r?eA(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var Qn=(r,e,t)=>(tA(r,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();const sA="modulepreload",iA=function(r,e){return new URL(r,e).href},Y0={},B_=function(e,t,s){let i=Promise.resolve();if(t&&t.length>0){const n=document.getElementsByTagName("link");i=Promise.all(t.map(a=>{if(a=iA(a,s),a in Y0)return;Y0[a]=!0;const o=a.endsWith(".css"),l=o?'[rel="stylesheet"]':"";if(!!s)for(let h=n.length-1;h>=0;h--){const u=n[h];if(u.href===a&&(!o||u.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${a}"]${l}`))return;const d=document.createElement("link");if(d.rel=o?"stylesheet":sA,o||(d.as="script",d.crossOrigin=""),d.href=a,document.head.appendChild(d),o)return new Promise((h,u)=>{d.addEventListener("load",h),d.addEventListener("error",()=>u(new Error(`Unable to preload CSS for ${a}`)))})}))}return i.then(()=>e()).catch(n=>{const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=n,window.dispatchEvent(a),!a.defaultPrevented)throw n})},nA="GpuTimings",rA="1.69.0",aA="29eb799",oA=["undefined","number","string","boolean"],lA={"[object Array]":"array","[object Object]":"object","[object Function]":"function","[object Date]":"date","[object RegExp]":"regexp","[object Float32Array]":"float32array"};function Z0(r){if(r===null)return"null";const e=typeof r;return oA.includes(e)?e:lA[Object.prototype.toString.call(r)]}function Cr(r,e){for(const t in e){const s=e[t];Z0(s)==="object"?r[t]=Cr({},s):Z0(s)==="array"?r[t]=Cr([],s):r[t]=s}return r}class $c{static set(e,t=!0){}static get(e){return $c._traceChannels.has(e)}}$c._traceChannels=new Set;$c.stack=!1;class hA{constructor(e,t,s,i,n=!1){this.handler=void 0,this.name=void 0,this.callback=void 0,this.scope=void 0,this._once=void 0,this._removed=!1,this.handler=e,this.name=t,this.callback=s,this.scope=i,this._once=n}off(){this._removed||this.handler.off(this.name,this.callback,this.scope)}on(e,t,s=this){return this.handler._addCallback(e,t,s,!1)}once(e,t,s=this){return this.handler._addCallback(e,t,s,!0)}set removed(e){e&&(this._removed=!0)}get removed(){return this._removed}}class ie{constructor(){this._callbacks=new Map,this._callbackActive=new Map}initEventHandler(){this._callbacks=new Map,this._callbackActive=new Map}_addCallback(e,t,s,i){if(this._callbacks.has(e)||this._callbacks.set(e,[]),this._callbackActive.has(e)){const a=this._callbackActive.get(e);a&&a===this._callbacks.get(e)&&this._callbackActive.set(e,a.slice())}const n=new hA(this,e,t,s,i);return this._callbacks.get(e).push(n),n}on(e,t,s=this){return this._addCallback(e,t,s,!1)}once(e,t,s=this){return this._addCallback(e,t,s,!0)}off(e,t,s){if(e)this._callbackActive.has(e)&&this._callbackActive.get(e)===this._callbacks.get(e)&&this._callbackActive.set(e,this._callbackActive.get(e).slice());else for(const[i,n]of this._callbackActive)this._callbacks.has(i)&&this._callbacks.get(i)===n&&this._callbackActive.set(i,n.slice());if(e)if(t){const i=this._callbacks.get(e);if(!i)return this;for(let n=0;n<i.length;n++)i[n].callback===t&&(s&&i[n].scope!==s||(i[n].removed=!0,i.splice(n,1),n--));i.length===0&&this._callbacks.delete(e)}else{const i=this._callbacks.get(e);if(i){for(let n=0;n<i.length;n++)i[n].removed=!0;this._callbacks.delete(e)}}else{for(const i of this._callbacks.values())for(let n=0;n<i.length;n++)i[n].removed=!0;this._callbacks.clear()}return this}fire(e,t,s,i,n,a,o,l,c){if(!e)return this;const d=this._callbacks.get(e);if(!d)return this;let h;this._callbackActive.has(e)?this._callbackActive.get(e)!==d&&(h=d.slice()):this._callbackActive.set(e,d);for(let u=0;(h||this._callbackActive.get(e))&&u<(h||this._callbackActive.get(e)).length;u++){const f=(h||this._callbackActive.get(e))[u];if(f.callback&&(f.callback.call(f.scope,t,s,i,n,a,o,l,c),f._once)){const p=this._callbacks.get(e),_=p?p.indexOf(f):-1;if(_!==-1){this._callbackActive.get(e)===p&&this._callbackActive.set(e,this._callbackActive.get(e).slice());const m=this._callbacks.get(e);if(!m)continue;m[_].removed=!0,m.splice(_,1),m.length===0&&this._callbacks.delete(e)}}}return h||this._callbackActive.delete(e),this}hasEvent(e){var t;return!!((t=this._callbacks.get(e))!=null&&t.length)}}const oy={attach(r){const e=oy;return r._addCallback=e._addCallback,r.on=e.on,r.off=e.off,r.fire=e.fire,r.once=e.once,r.hasEvent=e.hasEvent,ie.prototype.initEventHandler.call(r),r},_addCallback:ie.prototype._addCallback,on:ie.prototype.on,off:ie.prototype.off,fire:ie.prototype.fire,once:ie.prototype.once,hasEvent:ie.prototype.hasEvent},cA={create(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(r){const e=Math.random()*16|0;return(r==="x"?e:e&3|8).toString(16)})}},me={delimiter:"/",join(...r){let e=r[0];for(let t=0;t<r.length-1;t++){const s=r[t],i=r[t+1];if(i[0]===me.delimiter){e=i;continue}s&&i&&s[s.length-1]!==me.delimiter&&i[0]!==me.delimiter?e+=me.delimiter+i:e+=i}return e},normalize(r){const e=r.startsWith(me.delimiter),t=r.endsWith(me.delimiter),s=r.split("/");let i="",n=[];for(let a=0;a<s.length;a++)if(s[a]!==""&&s[a]!=="."){if(s[a]===".."&&n.length>0){n=n.slice(0,n.length-2);continue}a>0&&n.push(me.delimiter),n.push(s[a])}return i=n.join(""),!e&&i[0]===me.delimiter&&(i=i.slice(1)),t&&i[i.length-1]!==me.delimiter&&(i+=me.delimiter),i},split(r){const e=r.lastIndexOf(me.delimiter);return e!==-1?[r.substring(0,e),r.substring(e+1)]:["",r]},getBasename(r){return me.split(r)[1]},getDirectory(r){return me.split(r)[0]},getExtension(r){const e=r.split("?")[0].split(".").pop();return e!==r?"."+e:""},isRelativePath(r){return r.charAt(0)!=="/"&&r.match(/:\/\//)===null},extractPath(r){let e="";const t=r.split("/");let s=0;if(t.length>1)if(me.isRelativePath(r))if(t[0]===".")for(s=0;s<t.length-1;++s)e+=s===0?t[s]:"/"+t[s];else if(t[0]==="..")for(s=0;s<t.length-1;++s)e+=s===0?t[s]:"/"+t[s];else for(e=".",s=0;s<t.length-1;++s)e+="/"+t[s];else for(s=0;s<t.length-1;++s)e+=s===0?t[s]:"/"+t[s];return e}};var J0,Q0,ev;const dA=()=>{let r=!1;try{const e=Object.defineProperty({},"passive",{get:function(){return r=!0,!1}});window.addEventListener("testpassive",null,e),window.removeEventListener("testpassive",null,e)}catch{}return r},Vi=typeof navigator<"u"?navigator.userAgent:"",vr=typeof window<"u"?"browser":typeof global<"u"?"node":"worker",lh=/android/i.test(Vi)?"android":/ip([ao]d|hone)/i.test(Vi)?"ios":/windows/i.test(Vi)?"windows":/mac os/i.test(Vi)?"osx":/linux/i.test(Vi)?"linux":/cros/i.test(Vi)?"cros":null,uA=vr!=="browser"?null:/(Chrome\/|Chromium\/|Edg.*\/)/.test(Vi)?"chrome":/Safari\//.test(Vi)?"safari":/Firefox\//.test(Vi)?"firefox":"other",fA=/xbox/i.test(Vi),pA=vr==="browser"&&("ontouchstart"in window||"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0),mA=vr==="browser"&&(!!navigator.getGamepads||!!navigator.webkitGetGamepads),_A=typeof Worker<"u",gA=dA(),Te={name:lh,environment:vr,global:(J0=(Q0=(ev=typeof globalThis<"u"&&globalThis)!=null?ev:vr==="browser"&&window)!=null?Q0:vr==="node"&&global)!=null?J0:vr==="worker"&&self,browser:vr==="browser",desktop:["windows","osx","linux","cros"].includes(lh),mobile:["android","ios"].includes(lh),ios:lh==="ios",android:lh==="android",xbox:fA,gamepads:mA,touch:pA,workers:_A,passiveEvents:gA,browserName:uA},$w="abcdefghijklmnopqrstuvwxyz",Xw="ABCDEFGHIJKLMNOPQRSTUVWXYZ",yA=$w+Xw,N_=55296,qw=56319,tv=56320,vA=57343,SA=8205,sv=127462,iv=127487,xA=127995,wA=127999,bA=8400,TA=8447,U_=65024,z_=65039;function V_(r,e=0){const t=r.length;if(e<0||e>=t)return null;const s=r.charCodeAt(e);if(t>1&&s>=N_&&s<=qw){const i=r.charCodeAt(e+1);if(i>=tv&&i<=vA)return{code:(s-N_)*1024+i-tv+65536,long:!0}}return{code:s,long:!1}}function pr(r,e,t){if(!r)return!1;const s=V_(r);if(s){const i=s.code;return i>=e&&i<=t}return!1}function EA(r,e){if(e===r.length-1)return 1;if(pr(r[e],N_,qw)){const t=r.substring(e,e+2),s=r.substring(e+2,e+4);return pr(s,xA,wA)||pr(t,sv,iv)&&pr(s,sv,iv)?4:pr(s,U_,z_)?3:2}return pr(r[e+1],U_,z_)?2:1}const yl={ASCII_LOWERCASE:$w,ASCII_UPPERCASE:Xw,ASCII_LETTERS:yA,format(r,...e){for(let t=0;t<e.length;t++)r=r.replace(`{${t}}`,e[t]);return r},getCodePoint(r,e){const t=V_(r,e);return t&&t.code},getCodePoints(r){if(typeof r!="string")throw new TypeError("Not a string");let e=0;const t=[];let s;for(;s=V_(r,e);)t.push(s.code),e+=s.long?2:1;return t},getSymbols(r){if(typeof r!="string")throw new TypeError("Not a string");let e=0;const t=r.length,s=[];let i=0,n;for(;e<t;){if(i+=EA(r,e+i),n=r[e+i],pr(n,bA,TA)&&(n=r[e+i++]),pr(n,U_,z_)&&(n=r[e+i++]),n&&n.charCodeAt(0)===SA){n=r[e+i++];continue}const a=r.substring(e,e+i);s.push(a),e+=i,i=0}return s},fromCodePoint(){const r=[];let e,t,s;for(let i=0;i<arguments.length;++i)e=Number(arguments[i]),t=e-65536,s=e>65535?[(t>>10)+55296,t%1024+56320]:[e],r.push(String.fromCharCode.apply(null,s));return r.join("")}};class CA{constructor(){this._list=[],this._index={}}push(e,t){if(this._index[e])throw Error("Key already in index "+e);const s=this._list.push(t)-1;this._index[e]=s}has(e){return this._index[e]!==void 0}get(e){const t=this._index[e];return t!==void 0?this._list[t]:null}remove(e){const t=this._index[e];if(t!==void 0){this._list.splice(t,1),delete this._index[e];for(e in this._index){const s=this._index[e];s>t&&(this._index[e]=s-1)}return!0}return!1}list(){return this._list}clear(){this._list.length=0;for(const e in this._index)delete this._index[e]}}const AA=r=>{const e={};let t=e;return()=>(t===e&&(t=r()),t)};class us{static loadScript(e,t){const s=document.createElement("script");s.setAttribute("src",e),s.onload=()=>{t(null)},s.onerror=()=>{t(`Failed to load script='${e}'`)},document.body.appendChild(s)}static loadWasm(e,t,s){const i=us.wasmSupported()&&t.glueUrl&&t.wasmUrl?t.glueUrl:t.fallbackUrl;i?us.loadScript(i,n=>{if(n)s(n,null);else{const a=window[e];window[e]=void 0,a({locateFile:()=>t.wasmUrl,onAbort:()=>{s("wasm module aborted.")}}).then(o=>{s(null,o)})}}):s("No supported wasm modules found.",null)}static getModule(e){return us.modules.hasOwnProperty(e)||(us.modules[e]={config:null,initializing:!1,instance:null,callbacks:[]}),us.modules[e]}static initialize(e,t){if(t.initializing)return;const s=t.config;(s.glueUrl||s.wasmUrl||s.fallbackUrl)&&(t.initializing=!0,us.loadWasm(e,s,(i,n)=>{i?s.errorHandler?s.errorHandler(i):console.error(`failed to initialize module=${e} error=${i}`):(t.instance=n,t.callbacks.forEach(a=>{a(n)}))}))}}us.modules={};us.wasmSupported=AA(()=>{try{if(typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function"){const r=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(r instanceof WebAssembly.Module)return new WebAssembly.Instance(r)instanceof WebAssembly.Instance}}catch{}return!1});class Qu{static setConfig(e,t){const s=us.getModule(e);s.config=t,s.callbacks.length>0&&us.initialize(e,s)}static getConfig(e){var t;return(t=us.modules)==null||(t=t[e])==null?void 0:t.config}static getInstance(e,t){const s=us.getModule(e);s.instance?t(s.instance):(s.callbacks.push(t),s.config&&us.initialize(e,s))}}class Kw{constructor(e){this.arraybuffer=e,this.dataView=new DataView(e),this.offset=0,this.stack=[]}get remainingBytes(){return this.dataView.byteLength-this.offset}reset(e=0){this.offset=e}skip(e){this.offset+=e}align(e){this.offset=this.offset+e-1&~(e-1)}_inc(e){return this.offset+=e,this.offset-e}readChar(){return String.fromCharCode(this.dataView.getUint8(this.offset++))}readChars(e){let t="";for(let s=0;s<e;++s)t+=this.readChar();return t}readU8(){return this.dataView.getUint8(this.offset++)}readU16(){return this.dataView.getUint16(this._inc(2),!0)}readU32(){return this.dataView.getUint32(this._inc(4),!0)}readU64(){return this.readU32()+2**32*this.readU32()}readU32be(){return this.dataView.getUint32(this._inc(4),!1)}readArray(e){for(let t=0;t<e.length;++t)e[t]=this.readU8()}readLine(){const e=this.dataView;let t="";for(;!(this.offset>=e.byteLength);){const s=String.fromCharCode(this.readU8());if(s===`
`)break;t+=s}return t}}class ef{constructor(e){this.items=[],this.length=0,this.loopIndex=-1,this._sortBy=void 0,this._sortHandler=void 0,this._sortBy=e.sortBy,this._sortHandler=this._doSort.bind(this)}_binarySearch(e){let t=0,s=this.items.length-1;const i=e[this._sortBy];let n,a;for(;t<=s;)n=Math.floor((t+s)/2),a=this.items[n][this._sortBy],a<=i?t=n+1:a>i&&(s=n-1);return t}_doSort(e,t){const s=this._sortBy;return e[s]-t[s]}insert(e){const t=this._binarySearch(e);this.items.splice(t,0,e),this.length++,this.loopIndex>=t&&this.loopIndex++}append(e){this.items.push(e),this.length++}remove(e){const t=this.items.indexOf(e);t<0||(this.items.splice(t,1),this.length--,this.loopIndex>=t&&this.loopIndex--)}sort(){const e=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),e!==null&&(this.loopIndex=this.items.indexOf(e))}}class Xc extends ie{constructor(e){super(),this._index={},this._list=[],this._parent=e}add(){let e=!1;const t=this._processArguments(arguments,!0);if(!t.length)return e;for(let s=0;s<t.length;s++)this._index[t[s]]||(e=!0,this._index[t[s]]=!0,this._list.push(t[s]),this.fire("add",t[s],this._parent));return e&&this.fire("change",this._parent),e}remove(){let e=!1;if(!this._list.length)return e;const t=this._processArguments(arguments,!0);if(!t.length)return e;for(let s=0;s<t.length;s++)this._index[t[s]]&&(e=!0,delete this._index[t[s]],this._list.splice(this._list.indexOf(t[s]),1),this.fire("remove",t[s],this._parent));return e&&this.fire("change",this._parent),e}clear(){if(!this._list.length)return;const e=this._list.slice(0);this._list=[],this._index={};for(let t=0;t<e.length;t++)this.fire("remove",e[t],this._parent);this.fire("change",this._parent)}has(){return this._list.length?this._has(this._processArguments(arguments)):!1}_has(e){if(!this._list.length||!e.length)return!1;for(let t=0;t<e.length;t++)if(e[t].length===1){if(this._index[e[t][0]])return!0}else{let s=!0;for(let i=0;i<e[t].length;i++)if(!this._index[e[t][i]]){s=!1;break}if(s)return!0}return!1}list(){return this._list.slice(0)}_processArguments(e,t){const s=[];let i=[];if(!e||!e.length)return s;for(let n=0;n<e.length;n++)if(e[n]instanceof Array){t||(i=[]);for(let a=0;a<e[n].length;a++)typeof e[n][a]=="string"&&(t?s.push(e[n][a]):i.push(e[n][a]));!t&&i.length&&s.push(i)}else typeof e[n]=="string"&&(t?s.push(e[n]):s.push([e[n]]));return s}get size(){return this._list.length}}Xc.EVENT_ADD="add";Xc.EVENT_REMOVE="remove";Xc.EVENT_CHANGE="change";const Zi=typeof window<"u"&&window.performance&&window.performance.now?performance.now.bind(performance):Date.now,PA=/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class pm{constructor(e){this.scheme=void 0,this.authority=void 0,this.path=void 0,this.query=void 0,this.fragment=void 0;const t=e.match(PA);this.scheme=t[2],this.authority=t[4],this.path=t[5],this.query=t[7],this.fragment=t[9]}toString(){let e="";return this.scheme&&(e+=this.scheme+":"),this.authority&&(e+="//"+this.authority),e+=this.path,this.query&&(e+="?"+this.query),this.fragment&&(e+="#"+this.fragment),e}getQuery(){const e={};if(this.query){const t=decodeURIComponent(this.query).split("&");for(const s of t){const i=s.split("=");e[i[0]]=i[1]}}return e}setQuery(e){let t="";for(const s in e)e.hasOwnProperty(s)&&(t!==""&&(t+="&"),t+=encodeURIComponent(s)+"="+encodeURIComponent(e[s]));this.query=t}}const MA=0,ly=1,nv=2,IA=3,rv=4,RA=5,H={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp(r,e,t){return r>=t?t:r<=e?e:r},intToBytes24(r){const e=r>>16&255,t=r>>8&255,s=r&255;return[e,t,s]},intToBytes32(r){const e=r>>24&255,t=r>>16&255,s=r>>8&255,i=r&255;return[e,t,s,i]},bytesToInt24(r,e,t){return r.length&&(t=r[2],e=r[1],r=r[0]),r<<16|e<<8|t},bytesToInt32(r,e,t,s){return r.length&&(s=r[3],t=r[2],e=r[1],r=r[0]),(r<<24|e<<16|t<<8|s)>>>0},lerp(r,e,t){return r+(e-r)*H.clamp(t,0,1)},lerpAngle(r,e,t){return e-r>180&&(e-=360),e-r<-180&&(e+=360),H.lerp(r,e,H.clamp(t,0,1))},powerOfTwo(r){return r!==0&&!(r&r-1)},nextPowerOfTwo(r){return r--,r|=r>>1,r|=r>>2,r|=r>>4,r|=r>>8,r|=r>>16,r++,r},nearestPowerOfTwo(r){return Math.pow(2,Math.round(Math.log(r)/Math.log(2)))},random(r,e){const t=e-r;return Math.random()*t+r},smoothstep(r,e,t){return t<=r?0:t>=e?1:(t=(t-r)/(e-r),t*t*(3-2*t))},smootherstep(r,e,t){return t<=r?0:t>=e?1:(t=(t-r)/(e-r),t*t*t*(t*(t*6-15)+10))},roundUp(r,e){return e===0?r:Math.ceil(r/e)*e},between(r,e,t,s){const i=Math.min(e,t),n=Math.max(e,t);return s?r>=i&&r<=n:r>i&&r<n}};var on;class k{constructor(e=0,t=0,s=0,i=1){this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0;const n=e.length;n===3||n===4?(this.r=e[0],this.g=e[1],this.b=e[2],this.a=e[3]!==void 0?e[3]:1):(this.r=e,this.g=t,this.b=s,this.a=i)}clone(){const e=this.constructor;return new e(this.r,this.g,this.b,this.a)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}equals(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}set(e,t,s,i=1){return this.r=e,this.g=t,this.b=s,this.a=i,this}lerp(e,t,s){return this.r=e.r+s*(t.r-e.r),this.g=e.g+s*(t.g-e.g),this.b=e.b+s*(t.b-e.b),this.a=e.a+s*(t.a-e.a),this}fromString(e){const t=parseInt(e.replace("#","0x"),16);let s;return e.length>7?s=H.intToBytes32(t):(s=H.intToBytes24(t),s[3]=255),this.set(s[0]/255,s[1]/255,s[2]/255,s[3]/255),this}toString(e){let t="#"+(16777216+(Math.round(this.r*255)<<16)+(Math.round(this.g*255)<<8)+Math.round(this.b*255)).toString(16).slice(1);if(e===!0){const s=Math.round(this.a*255).toString(16);this.a<16/255?t+="0"+s:t+=s}return t}}on=k;k.BLACK=Object.freeze(new on(0,0,0,1));k.BLUE=Object.freeze(new on(0,0,1,1));k.CYAN=Object.freeze(new on(0,1,1,1));k.GRAY=Object.freeze(new on(.5,.5,.5,1));k.GREEN=Object.freeze(new on(0,1,0,1));k.MAGENTA=Object.freeze(new on(1,0,1,1));k.RED=Object.freeze(new on(1,0,0,1));k.WHITE=Object.freeze(new on(1,1,1,1));k.YELLOW=Object.freeze(new on(1,1,0,1));class Yw{constructor(e,t=0){this._curve=void 0,this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._curve=e,this._reset(t)}evaluate(e,t=!1){(t||e<this._left||e>=this._right)&&this._reset(e);let s;const i=this._curve.type;if(i===RA)s=this._p0;else{const n=this._recip===0?0:(e-this._left)*this._recip;i===MA?s=H.lerp(this._p0,this._p1,n):i===ly?s=H.lerp(this._p0,this._p1,n*n*(3-2*n)):s=this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,n)}return s}_reset(e){const t=this._curve.keys,s=t.length;if(!s)this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0;else if(e<t[0][0])this._left=-1/0,this._right=t[0][0],this._recip=0,this._p0=this._p1=t[0][1],this._m0=this._m1=0;else if(e>=t[s-1][0])this._left=t[s-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=t[s-1][1],this._m0=this._m1=0;else{let i=0;for(;e>=t[i+1][0];)i++;this._left=t[i][0],this._right=t[i+1][0];const n=1/(this._right-this._left);this._recip=isFinite(n)?n:0,this._p0=t[i][1],this._p1=t[i+1][1],this._isHermite()&&this._calcTangents(t,i)}}_isHermite(){return this._curve.type===nv||this._curve.type===IA||this._curve.type===rv}_calcTangents(e,t){let s;const i=e[t],n=e[t+1];let a;if(t===0?s=[e[0][0]+(e[0][0]-e[1][0]),e[0][1]+(e[0][1]-e[1][1])]:s=e[t-1],t===e.length-2?a=[e[t+1][0]+(e[t+1][0]-e[t][0]),e[t+1][1]+(e[t+1][1]-e[t][1])]:a=e[t+2],this._curve.type===rv){const o=2*(n[0]-i[0])/(n[0]-s[0]),l=2*(n[0]-i[0])/(a[0]-i[0]);this._m0=this._curve.tension*(isFinite(o)?o:0)*(n[1]-s[1]),this._m1=this._curve.tension*(isFinite(l)?l:0)*(a[1]-i[1])}else{const o=(n[0]-i[0])/(i[0]-s[0]),l=(n[0]-i[0])/(a[0]-n[0]),c=i[1]+(s[1]-i[1])*(isFinite(o)?o:0),d=n[1]+(a[1]-n[1])*(isFinite(l)?l:0),h=this._curve.type===nv?.5:this._curve.tension;this._m0=h*(n[1]-c),this._m1=h*(d-i[1])}}_evaluateHermite(e,t,s,i,n){const a=n*n,o=n+n,l=1-n,c=l*l;return e*((1+o)*c)+s*(n*c)+t*(a*(3-o))+i*(a*(n-1))}}class dt{constructor(e){if(this.keys=[],this.type=ly,this.tension=.5,this._eval=new Yw(this),e)for(let t=0;t<e.length-1;t+=2)this.keys.push([e[t],e[t+1]]);this.sort()}get length(){return this.keys.length}add(e,t){const s=this.keys,i=s.length;let n=0;for(;n<i&&!(s[n][0]>e);n++);const a=[e,t];return this.keys.splice(n,0,a),a}get(e){return this.keys[e]}sort(){this.keys.sort(function(e,t){return e[0]-t[0]})}value(e){return this._eval.evaluate(e,!0)}closest(e){const t=this.keys,s=t.length;let i=2,n=null;for(let a=0;a<s;a++){const o=Math.abs(e-t[a][0]);if(i>=o)i=o,n=t[a];else break}return n}clone(){const e=new this.constructor;return e.keys=Cr(e.keys,this.keys),e.type=this.type,e.tension=this.tension,e}quantize(e){e=Math.max(e,2);const t=new Float32Array(e),s=1/(e-1);t[0]=this._eval.evaluate(0,!0);for(let i=1;i<e;i++)t[i]=this._eval.evaluate(s*i);return t}quantizeClamped(e,t,s){const i=this.quantize(e);for(let n=0;n<i.length;++n)i[n]=Math.min(s,Math.max(t,i[n]));return i}}class St{constructor(){if(this.curves=[],this._type=ly,arguments.length>1)for(let e=0;e<arguments.length;e++)this.curves.push(new dt(arguments[e]));else if(arguments.length===0)this.curves.push(new dt);else{const e=arguments[0];if(typeof e=="number")for(let t=0;t<e;t++)this.curves.push(new dt);else for(let t=0;t<e.length;t++)this.curves.push(new dt(e[t]))}}get length(){return this.curves.length}set type(e){this._type=e;for(let t=0;t<this.curves.length;t++)this.curves[t].type=e}get type(){return this._type}get(e){return this.curves[e]}value(e,t=[]){const s=this.curves.length;t.length=s;for(let i=0;i<s;i++)t[i]=this.curves[i].value(e);return t}clone(){const e=new this.constructor;e.curves=[];for(let t=0;t<this.curves.length;t++)e.curves.push(this.curves[t].clone());return e._type=this._type,e}quantize(e){e=Math.max(e,2);const t=this.curves.length,s=new Float32Array(e*t),i=1/(e-1);for(let n=0;n<t;n++){const a=new Yw(this.curves[n]);for(let o=0;o<e;o++)s[o*t+n]=a.evaluate(i*o)}return s}quantizeClamped(e,t,s){const i=this.quantize(e);for(let n=0;n<i.length;++n)i[n]=Math.min(s,Math.max(t,i[n]));return i}}const mm=1/255,Zw=new Float32Array(1),LA=new Int32Array(Zw.buffer);class Ke{static float2Half(e){Zw[0]=e;const t=LA[0];let s=t>>16&32768,i=t>>12&2047;const n=t>>23&255;return n<103?s:n>142?(s|=31744,s|=(n===255?0:1)&&t&8388607,s):n<113?(i|=2048,s|=(i>>114-n)+(i>>113-n&1),s):(s|=n-112<<10|i>>1,s+=i&1,s)}static float2Bytes(e,t,s,i){const n=255*e%1;if(t[s+0]=Math.round((e%1-mm*n)*255),i>1){const a=65025*e%1;if(t[s+1]=Math.round((n-mm*a)*255),i>2){const o=16581375*e%1;t[s+2]=Math.round((a-mm*o)*255),i>3&&(t[s+3]=Math.round(o*255))}}}static float2BytesRange(e,t,s,i,n,a){e=H.clamp((e-i)/(n-i),0,1),Ke.float2Bytes(e,t,s,a)}static float2MantissaExponent(e,t,s,i){const n=Math.floor(Math.log2(Math.abs(e)))+1;e/=Math.pow(2,n),Ke.float2BytesRange(e,t,s,-1,1,i-1),t[s+i-1]=Math.round(n+127)}}var Vn;class y{constructor(e=0,t=0,s=0){this.x=void 0,this.y=void 0,this.z=void 0,e.length===3?(this.x=e[0],this.y=e[1],this.z=e[2]):(this.x=e,this.y=t,this.z=s)}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}clone(){const e=this.constructor;return new e(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}cross(e,t){const s=e.x,i=e.y,n=e.z,a=t.x,o=t.y,l=t.z;return this.x=i*l-o*n,this.y=n*a-l*s,this.z=s*o-a*i,this}distance(e){const t=this.x-e.x,s=this.y-e.y,i=this.z-e.z;return Math.sqrt(t*t+s*s+i*i)}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}normalize(e=this){const t=e.x*e.x+e.y*e.y+e.z*e.z;if(t>0){const s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s,this.z=e.z*s}return this}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),this}project(e){const t=this.x*e.x+this.y*e.y+this.z*e.z,s=e.x*e.x+e.y*e.y+e.z*e.z,i=t/s;return this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this}set(e,t,s){return this.x=e,this.y=t,this.z=s,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}toString(){return`[${this.x}, ${this.y}, ${this.z}]`}}Vn=y;y.ZERO=Object.freeze(new Vn(0,0,0));y.ONE=Object.freeze(new Vn(1,1,1));y.UP=Object.freeze(new Vn(0,1,0));y.DOWN=Object.freeze(new Vn(0,-1,0));y.RIGHT=Object.freeze(new Vn(1,0,0));y.LEFT=Object.freeze(new Vn(-1,0,0));y.FORWARD=Object.freeze(new Vn(0,0,-1));y.BACK=Object.freeze(new Vn(0,0,1));var hy;class hi{constructor(){this.data=new Float32Array(9),this.data[0]=this.data[4]=this.data[8]=1}clone(){const e=this.constructor;return new e().copy(this)}copy(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],this}set(e){const t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this}getX(e=new y){return e.set(this.data[0],this.data[1],this.data[2])}getY(e=new y){return e.set(this.data[3],this.data[4],this.data[5])}getZ(e=new y){return e.set(this.data[6],this.data[7],this.data[8])}equals(e){const t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]}isIdentity(){const e=this.data;return e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===1&&e[5]===0&&e[6]===0&&e[7]===0&&e[8]===1}setIdentity(){const e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this}toString(){return"["+this.data.join(", ")+"]"}transpose(e=this){const t=e.data,s=this.data;if(t===s){let i;i=t[1],s[1]=t[3],s[3]=i,i=t[2],s[2]=t[6],s[6]=i,i=t[5],s[5]=t[7],s[7]=i}else s[0]=t[0],s[1]=t[3],s[2]=t[6],s[3]=t[1],s[4]=t[4],s[5]=t[7],s[6]=t[2],s[7]=t[5],s[8]=t[8];return this}setFromMat4(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[4],s[4]=t[5],s[5]=t[6],s[6]=t[8],s[7]=t[9],s[8]=t[10],this}invertMat4(e){const t=e.data,s=t[0],i=t[1],n=t[2],a=t[4],o=t[5],l=t[6],c=t[8],d=t[9],h=t[10],u=h*o-l*d,f=-h*i+n*d,p=l*i-n*o,_=-h*a+l*c,m=h*s-n*c,g=-l*s+n*a,v=d*a-o*c,x=-d*s+i*c,S=o*s-i*a,w=s*u+i*_+n*v;if(w===0)this.setIdentity();else{const T=1/w,b=this.data;b[0]=u*T,b[1]=f*T,b[2]=p*T,b[3]=_*T,b[4]=m*T,b[5]=g*T,b[6]=v*T,b[7]=x*T,b[8]=S*T}return this}transformVector(e,t=new y){const s=this.data,i=e.x,n=e.y,a=e.z;return t.x=i*s[0]+n*s[3]+a*s[6],t.y=i*s[1]+n*s[4]+a*s[7],t.z=i*s[2]+n*s[5]+a*s[8],t}}hy=hi;hi.IDENTITY=Object.freeze(new hy);hi.ZERO=Object.freeze(new hy().set([0,0,0,0,0,0,0,0,0]));var ro;class M{constructor(e=0,t=0){this.x=void 0,this.y=void 0,e.length===2?(this.x=e[0],this.y=e[1]):(this.x=e,this.y=t)}add(e){return this.x+=e.x,this.y+=e.y,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}clone(){const e=this.constructor;return new e(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}cross(e){return this.x*e.y-this.y*e.x}distance(e){const t=this.x-e.x,s=this.y-e.y;return Math.sqrt(t*t+s*s)}div(e){return this.x/=e.x,this.y/=e.y,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this}divScalar(e){return this.x/=e,this.y/=e,this}dot(e){return this.x*e.x+this.y*e.y}equals(e){return this.x===e.x&&this.y===e.y}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this}mul(e){return this.x*=e.x,this.y*=e.y,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this}mulScalar(e){return this.x*=e,this.y*=e,this}normalize(e=this){const t=e.x*e.x+e.y*e.y;if(t>0){const s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s}return this}rotate(e){const t=Math.atan2(this.x,this.y)+e*H.DEG_TO_RAD,s=Math.sqrt(this.x*this.x+this.y*this.y);return this.x=Math.sin(t)*s,this.y=Math.cos(t)*s,this}angle(){return Math.atan2(this.x,this.y)*H.RAD_TO_DEG}angleTo(e){return Math.atan2(this.x*e.y+this.y*e.x,this.x*e.x+this.y*e.y)*H.RAD_TO_DEG}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),this}set(e,t){return this.x=e,this.y=t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}subScalar(e){return this.x-=e,this.y-=e,this}toString(){return`[${this.x}, ${this.y}]`}static angleRad(e,t){return Math.atan2(e.x*t.y-e.y*t.x,e.x*t.x+e.y*t.y)}}ro=M;M.ZERO=Object.freeze(new ro(0,0));M.ONE=Object.freeze(new ro(1,1));M.UP=Object.freeze(new ro(0,1));M.DOWN=Object.freeze(new ro(0,-1));M.RIGHT=Object.freeze(new ro(1,0));M.LEFT=Object.freeze(new ro(-1,0));var cy;class P{constructor(e=0,t=0,s=0,i=0){this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,e.length===4?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i)}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}clone(){const e=this.constructor;return new e(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this.w=e.w/t.w,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this.w/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this.w=e.w+s*(t.w-e.w),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this.w=e.w*t.w,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}normalize(e=this){const t=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;if(t>0){const s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s,this.z=e.z*s,this.w=e.w*s}return this}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this.w=Math.floor(e.w),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this.w=Math.ceil(e.w),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this.w=Math.round(e.w),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}cy=P;P.ZERO=Object.freeze(new cy(0,0,0,0));P.ONE=Object.freeze(new cy(1,1,1,1));var dy;const hh=new M,ui=new y,Ri=new y,Li=new y,Nd=new y;class q{constructor(){this.data=new Float32Array(16),this.data[0]=this.data[5]=this.data[10]=this.data[15]=1}static _getPerspectiveHalfSize(e,t,s,i,n){n?(e.x=i*Math.tan(t*Math.PI/360),e.y=e.x/s):(e.y=i*Math.tan(t*Math.PI/360),e.x=e.y*s)}add2(e,t){const s=e.data,i=t.data,n=this.data;return n[0]=s[0]+i[0],n[1]=s[1]+i[1],n[2]=s[2]+i[2],n[3]=s[3]+i[3],n[4]=s[4]+i[4],n[5]=s[5]+i[5],n[6]=s[6]+i[6],n[7]=s[7]+i[7],n[8]=s[8]+i[8],n[9]=s[9]+i[9],n[10]=s[10]+i[10],n[11]=s[11]+i[11],n[12]=s[12]+i[12],n[13]=s[13]+i[13],n[14]=s[14]+i[14],n[15]=s[15]+i[15],this}add(e){return this.add2(this,e)}clone(){const e=this.constructor;return new e().copy(this)}copy(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15],this}equals(e){const t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]&&t[9]===s[9]&&t[10]===s[10]&&t[11]===s[11]&&t[12]===s[12]&&t[13]===s[13]&&t[14]===s[14]&&t[15]===s[15]}isIdentity(){const e=this.data;return e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1}mul2(e,t){const s=e.data,i=t.data,n=this.data,a=s[0],o=s[1],l=s[2],c=s[3],d=s[4],h=s[5],u=s[6],f=s[7],p=s[8],_=s[9],m=s[10],g=s[11],v=s[12],x=s[13],S=s[14],w=s[15];let T,b,C,E;return T=i[0],b=i[1],C=i[2],E=i[3],n[0]=a*T+d*b+p*C+v*E,n[1]=o*T+h*b+_*C+x*E,n[2]=l*T+u*b+m*C+S*E,n[3]=c*T+f*b+g*C+w*E,T=i[4],b=i[5],C=i[6],E=i[7],n[4]=a*T+d*b+p*C+v*E,n[5]=o*T+h*b+_*C+x*E,n[6]=l*T+u*b+m*C+S*E,n[7]=c*T+f*b+g*C+w*E,T=i[8],b=i[9],C=i[10],E=i[11],n[8]=a*T+d*b+p*C+v*E,n[9]=o*T+h*b+_*C+x*E,n[10]=l*T+u*b+m*C+S*E,n[11]=c*T+f*b+g*C+w*E,T=i[12],b=i[13],C=i[14],E=i[15],n[12]=a*T+d*b+p*C+v*E,n[13]=o*T+h*b+_*C+x*E,n[14]=l*T+u*b+m*C+S*E,n[15]=c*T+f*b+g*C+w*E,this}mulAffine2(e,t){const s=e.data,i=t.data,n=this.data,a=s[0],o=s[1],l=s[2],c=s[4],d=s[5],h=s[6],u=s[8],f=s[9],p=s[10],_=s[12],m=s[13],g=s[14];let v,x,S;return v=i[0],x=i[1],S=i[2],n[0]=a*v+c*x+u*S,n[1]=o*v+d*x+f*S,n[2]=l*v+h*x+p*S,n[3]=0,v=i[4],x=i[5],S=i[6],n[4]=a*v+c*x+u*S,n[5]=o*v+d*x+f*S,n[6]=l*v+h*x+p*S,n[7]=0,v=i[8],x=i[9],S=i[10],n[8]=a*v+c*x+u*S,n[9]=o*v+d*x+f*S,n[10]=l*v+h*x+p*S,n[11]=0,v=i[12],x=i[13],S=i[14],n[12]=a*v+c*x+u*S+_,n[13]=o*v+d*x+f*S+m,n[14]=l*v+h*x+p*S+g,n[15]=1,this}mul(e){return this.mul2(this,e)}transformPoint(e,t=new y){const s=this.data,i=e.x,n=e.y,a=e.z;return t.x=i*s[0]+n*s[4]+a*s[8]+s[12],t.y=i*s[1]+n*s[5]+a*s[9]+s[13],t.z=i*s[2]+n*s[6]+a*s[10]+s[14],t}transformVector(e,t=new y){const s=this.data,i=e.x,n=e.y,a=e.z;return t.x=i*s[0]+n*s[4]+a*s[8],t.y=i*s[1]+n*s[5]+a*s[9],t.z=i*s[2]+n*s[6]+a*s[10],t}transformVec4(e,t=new P){const s=this.data,i=e.x,n=e.y,a=e.z,o=e.w;return t.x=i*s[0]+n*s[4]+a*s[8]+o*s[12],t.y=i*s[1]+n*s[5]+a*s[9]+o*s[13],t.z=i*s[2]+n*s[6]+a*s[10]+o*s[14],t.w=i*s[3]+n*s[7]+a*s[11]+o*s[15],t}setLookAt(e,t,s){Li.sub2(e,t).normalize(),Ri.copy(s).normalize(),ui.cross(Ri,Li).normalize(),Ri.cross(Li,ui);const i=this.data;return i[0]=ui.x,i[1]=ui.y,i[2]=ui.z,i[3]=0,i[4]=Ri.x,i[5]=Ri.y,i[6]=Ri.z,i[7]=0,i[8]=Li.x,i[9]=Li.y,i[10]=Li.z,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this}setFrustum(e,t,s,i,n,a){const o=2*n,l=t-e,c=i-s,d=a-n,h=this.data;return h[0]=o/l,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=o/c,h[6]=0,h[7]=0,h[8]=(t+e)/l,h[9]=(i+s)/c,h[10]=(-a-n)/d,h[11]=-1,h[12]=0,h[13]=0,h[14]=-o*a/d,h[15]=0,this}setPerspective(e,t,s,i,n){return q._getPerspectiveHalfSize(hh,e,t,s,n),this.setFrustum(-hh.x,hh.x,-hh.y,hh.y,s,i)}setOrtho(e,t,s,i,n,a){const o=this.data;return o[0]=2/(t-e),o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2/(i-s),o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=-2/(a-n),o[11]=0,o[12]=-(t+e)/(t-e),o[13]=-(i+s)/(i-s),o[14]=-(a+n)/(a-n),o[15]=1,this}setFromAxisAngle(e,t){t*=H.DEG_TO_RAD;const s=e.x,i=e.y,n=e.z,a=Math.cos(t),o=Math.sin(t),l=1-a,c=l*s,d=l*i,h=this.data;return h[0]=c*s+a,h[1]=c*i+o*n,h[2]=c*n-o*i,h[3]=0,h[4]=c*i-o*n,h[5]=d*i+a,h[6]=d*n+o*s,h[7]=0,h[8]=c*n+o*i,h[9]=d*n-s*o,h[10]=l*n*n+a,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,this}setTranslate(e,t,s){const i=this.data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=e,i[13]=t,i[14]=s,i[15]=1,this}setScale(e,t,s){const i=this.data;return i[0]=e,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=t,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}setViewport(e,t,s,i){const n=this.data;return n[0]=s*.5,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=i*.5,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=.5,n[11]=0,n[12]=e+s*.5,n[13]=t+i*.5,n[14]=.5,n[15]=1,this}setReflection(e,t){const s=e.x,i=e.y,n=e.z,a=this.data;return a[0]=1-2*s*s,a[1]=-2*s*i,a[2]=-2*s*n,a[3]=0,a[4]=-2*s*i,a[5]=1-2*i*i,a[6]=-2*i*n,a[7]=0,a[8]=-2*s*n,a[9]=-2*i*n,a[10]=1-2*n*n,a[11]=0,a[12]=-2*s*t,a[13]=-2*i*t,a[14]=-2*n*t,a[15]=1,this}invert(e=this){const t=e.data,s=t[0],i=t[1],n=t[2],a=t[3],o=t[4],l=t[5],c=t[6],d=t[7],h=t[8],u=t[9],f=t[10],p=t[11],_=t[12],m=t[13],g=t[14],v=t[15],x=s*l-i*o,S=s*c-n*o,w=s*d-a*o,T=i*c-n*l,b=i*d-a*l,C=n*d-a*c,E=h*m-u*_,R=h*g-f*_,B=h*v-p*_,L=u*g-f*m,V=u*v-p*m,I=f*v-p*g,F=x*I-S*V+w*L+T*B-b*R+C*E;if(F===0)this.setIdentity();else{const D=1/F,A=this.data;A[0]=(l*I-c*V+d*L)*D,A[1]=(-i*I+n*V-a*L)*D,A[2]=(m*C-g*b+v*T)*D,A[3]=(-u*C+f*b-p*T)*D,A[4]=(-o*I+c*B-d*R)*D,A[5]=(s*I-n*B+a*R)*D,A[6]=(-_*C+g*w-v*S)*D,A[7]=(h*C-f*w+p*S)*D,A[8]=(o*V-l*B+d*E)*D,A[9]=(-s*V+i*B-a*E)*D,A[10]=(_*b-m*w+v*x)*D,A[11]=(-h*b+u*w-p*x)*D,A[12]=(-o*L+l*R-c*E)*D,A[13]=(s*L-i*R+n*E)*D,A[14]=(-_*T+m*S-g*x)*D,A[15]=(h*T-u*S+f*x)*D}return this}set(e){const t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this}setIdentity(){const e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}setTRS(e,t,s){const i=t.x,n=t.y,a=t.z,o=t.w,l=s.x,c=s.y,d=s.z,h=i+i,u=n+n,f=a+a,p=i*h,_=i*u,m=i*f,g=n*u,v=n*f,x=a*f,S=o*h,w=o*u,T=o*f,b=this.data;return b[0]=(1-(g+x))*l,b[1]=(_+T)*l,b[2]=(m-w)*l,b[3]=0,b[4]=(_-T)*c,b[5]=(1-(p+x))*c,b[6]=(v+S)*c,b[7]=0,b[8]=(m+w)*d,b[9]=(v-S)*d,b[10]=(1-(p+g))*d,b[11]=0,b[12]=e.x,b[13]=e.y,b[14]=e.z,b[15]=1,this}transpose(e=this){const t=e.data,s=this.data;if(t===s){let i;i=t[1],s[1]=t[4],s[4]=i,i=t[2],s[2]=t[8],s[8]=i,i=t[3],s[3]=t[12],s[12]=i,i=t[6],s[6]=t[9],s[9]=i,i=t[7],s[7]=t[13],s[13]=i,i=t[11],s[11]=t[14],s[14]=i}else s[0]=t[0],s[1]=t[4],s[2]=t[8],s[3]=t[12],s[4]=t[1],s[5]=t[5],s[6]=t[9],s[7]=t[13],s[8]=t[2],s[9]=t[6],s[10]=t[10],s[11]=t[14],s[12]=t[3],s[13]=t[7],s[14]=t[11],s[15]=t[15];return this}getTranslation(e=new y){return e.set(this.data[12],this.data[13],this.data[14])}getX(e=new y){return e.set(this.data[0],this.data[1],this.data[2])}getY(e=new y){return e.set(this.data[4],this.data[5],this.data[6])}getZ(e=new y){return e.set(this.data[8],this.data[9],this.data[10])}getScale(e=new y){return this.getX(ui),this.getY(Ri),this.getZ(Li),e.set(ui.length(),Ri.length(),Li.length()),e}get scaleSign(){return this.getX(ui),this.getY(Ri),this.getZ(Li),ui.cross(ui,Ri),ui.dot(Li)<0?-1:1}setFromEulerAngles(e,t,s){e*=H.DEG_TO_RAD,t*=H.DEG_TO_RAD,s*=H.DEG_TO_RAD;const i=Math.sin(-e),n=Math.cos(-e),a=Math.sin(-t),o=Math.cos(-t),l=Math.sin(-s),c=Math.cos(-s),d=this.data;return d[0]=o*c,d[1]=-o*l,d[2]=a,d[3]=0,d[4]=n*l+c*i*a,d[5]=n*c-i*a*l,d[6]=-o*i,d[7]=0,d[8]=i*l-n*c*a,d[9]=c*i+n*a*l,d[10]=n*o,d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,this}getEulerAngles(e=new y){this.getScale(Nd);const t=Nd.x,s=Nd.y,i=Nd.z;if(t===0||s===0||i===0)return e.set(0,0,0);const n=this.data,a=Math.asin(-n[2]/t),o=Math.PI*.5;let l,c;return a<o?a>-o?(l=Math.atan2(n[6]/s,n[10]/i),c=Math.atan2(n[1]/t,n[0]/t)):(c=0,l=-Math.atan2(n[4]/s,n[5]/s)):(c=0,l=Math.atan2(n[4]/s,n[5]/s)),e.set(l,a,c).mulScalar(H.RAD_TO_DEG)}toString(){return"["+this.data.join(", ")+"]"}}dy=q;q.IDENTITY=Object.freeze(new dy);q.ZERO=Object.freeze(new dy().set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));var uy;class re{constructor(e=0,t=0,s=0,i=1){this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,e.length===4?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i)}clone(){const e=this.constructor;return new e(this.x,this.y,this.z,this.w)}conjugate(e=this){return this.x=e.x*-1,this.y=e.y*-1,this.z=e.z*-1,this.w=e.w,this}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}getAxisAngle(e){let t=Math.acos(this.w)*2;const s=Math.sin(t/2);return s!==0?(e.x=this.x/s,e.y=this.y/s,e.z=this.z/s,(e.x<0||e.y<0||e.z<0)&&(e.x*=-1,e.y*=-1,e.z*=-1,t*=-1)):(e.x=1,e.y=0,e.z=0),t*H.RAD_TO_DEG}getEulerAngles(e=new y){let t,s,i;const n=this.x,a=this.y,o=this.z,l=this.w,c=2*(l*a-n*o);return c<=-.99999?(t=2*Math.atan2(n,l),s=-Math.PI/2,i=0):c>=.99999?(t=2*Math.atan2(n,l),s=Math.PI/2,i=0):(t=Math.atan2(2*(l*n+a*o),1-2*(n*n+a*a)),s=Math.asin(c),i=Math.atan2(2*(l*o+n*a),1-2*(a*a+o*o))),e.set(t,s,i).mulScalar(H.RAD_TO_DEG)}invert(e=this){return this.conjugate(e).normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}mul(e){const t=this.x,s=this.y,i=this.z,n=this.w,a=e.x,o=e.y,l=e.z,c=e.w;return this.x=n*a+t*c+s*l-i*o,this.y=n*o+s*c+i*a-t*l,this.z=n*l+i*c+t*o-s*a,this.w=n*c-t*a-s*o-i*l,this}mul2(e,t){const s=e.x,i=e.y,n=e.z,a=e.w,o=t.x,l=t.y,c=t.z,d=t.w;return this.x=a*o+s*d+i*c-n*l,this.y=a*l+i*d+n*o-s*c,this.z=a*c+n*d+s*l-i*o,this.w=a*d-s*o-i*l-n*c,this}normalize(e=this){let t=e.length();return t===0?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this.w=e.w*t),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}setFromAxisAngle(e,t){t*=.5*H.DEG_TO_RAD;const s=Math.sin(t),i=Math.cos(t);return this.x=s*e.x,this.y=s*e.y,this.z=s*e.z,this.w=i,this}setFromEulerAngles(e,t,s){if(e instanceof y){const h=e;e=h.x,t=h.y,s=h.z}const i=.5*H.DEG_TO_RAD;e*=i,t*=i,s*=i;const n=Math.sin(e),a=Math.cos(e),o=Math.sin(t),l=Math.cos(t),c=Math.sin(s),d=Math.cos(s);return this.x=n*l*d-a*o*c,this.y=a*o*d+n*l*c,this.z=a*l*c-n*o*d,this.w=a*l*d+n*o*c,this}setFromMat4(e){let t,s,i,n,a,o,l,c,d,h,u,f,p,_;if(e=e.data,t=e[0],s=e[1],i=e[2],n=e[4],a=e[5],o=e[6],l=e[8],c=e[9],d=e[10],f=t*t+s*s+i*i,f===0)return this;if(f=1/Math.sqrt(f),p=n*n+a*a+o*o,p===0)return this;if(p=1/Math.sqrt(p),_=l*l+c*c+d*d,_===0)return this;_=1/Math.sqrt(_),t*=f,s*=f,i*=f,n*=p,a*=p,o*=p,l*=_,c*=_,d*=_;const m=t+a+d;return m>=0?(h=Math.sqrt(m+1),this.w=h*.5,h=.5/h,this.x=(o-c)*h,this.y=(l-i)*h,this.z=(s-n)*h):t>a?t>d?(u=t-(a+d)+1,u=Math.sqrt(u),this.x=u*.5,u=.5/u,this.w=(o-c)*u,this.y=(s+n)*u,this.z=(i+l)*u):(u=d-(t+a)+1,u=Math.sqrt(u),this.z=u*.5,u=.5/u,this.w=(s-n)*u,this.x=(l+i)*u,this.y=(c+o)*u):a>d?(u=a-(d+t)+1,u=Math.sqrt(u),this.y=u*.5,u=.5/u,this.w=(l-i)*u,this.z=(o+c)*u,this.x=(n+s)*u):(u=d-(t+a)+1,u=Math.sqrt(u),this.z=u*.5,u=.5/u,this.w=(s-n)*u,this.x=(l+i)*u,this.y=(c+o)*u),this}setFromDirections(e,t){const s=1+e.dot(t);return s<Number.EPSILON?Math.abs(e.x)>Math.abs(e.y)?(this.x=-e.z,this.y=0,this.z=e.x,this.w=0):(this.x=0,this.y=-e.z,this.z=e.y,this.w=0):(this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this.w=s),this.normalize()}slerp(e,t,s){const i=e.x,n=e.y,a=e.z,o=e.w;let l=t.x,c=t.y,d=t.z,h=t.w,u=o*h+i*l+n*c+a*d;if(u<0&&(h=-h,l=-l,c=-c,d=-d,u=-u),Math.abs(u)>=1)return this.w=o,this.x=i,this.y=n,this.z=a,this;const f=Math.acos(u),p=Math.sqrt(1-u*u);if(Math.abs(p)<.001)return this.w=o*.5+h*.5,this.x=i*.5+l*.5,this.y=n*.5+c*.5,this.z=a*.5+d*.5,this;const _=Math.sin((1-s)*f)/p,m=Math.sin(s*f)/p;return this.w=o*_+h*m,this.x=i*_+l*m,this.y=n*_+c*m,this.z=a*_+d*m,this}transformVector(e,t=new y){const s=e.x,i=e.y,n=e.z,a=this.x,o=this.y,l=this.z,c=this.w,d=c*s+o*n-l*i,h=c*i+l*s-a*n,u=c*n+a*i-o*s,f=-a*s-o*i-l*n;return t.x=d*c+f*-a+h*-l-u*-o,t.y=h*c+f*-o+u*-a-d*-l,t.z=u*c+f*-l+d*-o-h*-a,t}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}uy=re;re.IDENTITY=Object.freeze(new uy(0,0,0,1));re.ZERO=Object.freeze(new uy(0,0,0,0));const go=new y,yo=new y,av=new y,ov=new y,DA=new y;class Re{constructor(e=new y,t=new y(.5,.5,.5)){this.center=void 0,this.halfExtents=void 0,this._min=new y,this._max=new y,this.center=e,this.halfExtents=t}add(e){const t=this.center,s=t.x,i=t.y,n=t.z,a=this.halfExtents,o=a.x,l=a.y,c=a.z;let d=s-o,h=s+o,u=i-l,f=i+l,p=n-c,_=n+c;const m=e.center,g=m.x,v=m.y,x=m.z,S=e.halfExtents,w=S.x,T=S.y,b=S.z,C=g-w,E=g+w,R=v-T,B=v+T,L=x-b,V=x+b;C<d&&(d=C),E>h&&(h=E),R<u&&(u=R),B>f&&(f=B),L<p&&(p=L),V>_&&(_=V),t.x=(d+h)*.5,t.y=(u+f)*.5,t.z=(p+_)*.5,a.x=(h-d)*.5,a.y=(f-u)*.5,a.z=(_-p)*.5}copy(e){this.center.copy(e.center),this.halfExtents.copy(e.halfExtents)}clone(){return new Re(this.center.clone(),this.halfExtents.clone())}intersects(e){const t=this.getMax(),s=this.getMin(),i=e.getMax(),n=e.getMin();return s.x<=i.x&&t.x>=n.x&&s.y<=i.y&&t.y>=n.y&&s.z<=i.z&&t.z>=n.z}_intersectsRay(e,t){const s=go.copy(this.getMin()).sub(e.origin),i=yo.copy(this.getMax()).sub(e.origin),n=e.direction;n.x===0?(s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.x/=n.x,i.x/=n.x),n.y===0?(s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.y/=n.y,i.y/=n.y),n.z===0?(s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.z/=n.z,i.z/=n.z);const a=av.set(Math.min(s.x,i.x),Math.min(s.y,i.y),Math.min(s.z,i.z)),o=ov.set(Math.max(s.x,i.x),Math.max(s.y,i.y),Math.max(s.z,i.z)),l=Math.min(Math.min(o.x,o.y),o.z),c=Math.max(Math.max(a.x,a.y),a.z),d=l>=c&&c>=0;return d&&t.copy(e.direction).mulScalar(c).add(e.origin),d}_fastIntersectsRay(e){const t=go,s=yo,i=av,n=ov,a=DA,o=e.direction;return t.sub2(e.origin,this.center),n.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),i.mul2(t,o),!(n.x>this.halfExtents.x&&i.x>=0||n.y>this.halfExtents.y&&i.y>=0||n.z>this.halfExtents.z&&i.z>=0||(a.set(Math.abs(o.x),Math.abs(o.y),Math.abs(o.z)),s.cross(o,t),s.set(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)),s.x>this.halfExtents.y*a.z+this.halfExtents.z*a.y)||s.y>this.halfExtents.x*a.z+this.halfExtents.z*a.x||s.z>this.halfExtents.x*a.y+this.halfExtents.y*a.x)}intersectsRay(e,t){return t?this._intersectsRay(e,t):this._fastIntersectsRay(e)}setMinMax(e,t){this.center.add2(t,e).mulScalar(.5),this.halfExtents.sub2(t,e).mulScalar(.5)}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(e){const t=this.getMin(),s=this.getMax();return!(e.x<t.x||e.x>s.x||e.y<t.y||e.y>s.y||e.z<t.z||e.z>s.z)}setFromTransformedAabb(e,t,s=!1){const i=e.center,n=e.halfExtents,a=t.data;let o=a[0],l=a[4],c=a[8],d=a[1],h=a[5],u=a[9],f=a[2],p=a[6],_=a[10];if(s){let m=o*o+l*l+c*c;if(m>0){const g=1/Math.sqrt(m);o*=g,l*=g,c*=g}if(m=d*d+h*h+u*u,m>0){const g=1/Math.sqrt(m);d*=g,h*=g,u*=g}if(m=f*f+p*p+_*_,m>0){const g=1/Math.sqrt(m);f*=g,p*=g,_*=g}}this.center.set(a[12]+o*i.x+l*i.y+c*i.z,a[13]+d*i.x+h*i.y+u*i.z,a[14]+f*i.x+p*i.y+_*i.z),this.halfExtents.set(Math.abs(o)*n.x+Math.abs(l)*n.y+Math.abs(c)*n.z,Math.abs(d)*n.x+Math.abs(h)*n.y+Math.abs(u)*n.z,Math.abs(f)*n.x+Math.abs(p)*n.y+Math.abs(_)*n.z)}static computeMinMax(e,t,s,i=e.length/3){if(i>0){let n=e[0],a=e[1],o=e[2],l=n,c=a,d=o;const h=i*3;for(let u=3;u<h;u+=3){const f=e[u],p=e[u+1],_=e[u+2];f<n&&(n=f),p<a&&(a=p),_<o&&(o=_),f>l&&(l=f),p>c&&(c=p),_>d&&(d=_)}t.set(n,a,o),s.set(l,c,d)}}compute(e,t){Re.computeMinMax(e,go,yo,t),this.setMinMax(go,yo)}intersectsBoundingSphere(e){return this._distanceToBoundingSphereSq(e)<=e.radius*e.radius}_distanceToBoundingSphereSq(e){const t=this.getMin(),s=this.getMax();let i=0;const n=["x","y","z"];for(let a=0;a<3;++a){let o=0;const l=e.center[n[a]],c=t[n[a]],d=s[n[a]];let h=0;l<c&&(h=c-l,o+=h*h),l>d&&(h=l-d,o+=h*h),i+=o}return i}_expand(e,t){go.add2(this.getMin(),e),yo.add2(this.getMax(),t),this.setMinMax(go,yo)}}const Ud=new y,OA=new y;class Al{constructor(e=new y,t=.5){this.center=void 0,this.radius=void 0,this.center=e,this.radius=t}containsPoint(e){const t=Ud.sub2(e,this.center).lengthSq(),s=this.radius;return t<s*s}intersectsRay(e,t){const s=Ud.copy(e.origin).sub(this.center),i=s.dot(OA.copy(e.direction).normalize()),n=s.dot(s)-this.radius*this.radius;if(n>0&&i>0)return!1;const a=i*i-n;if(a<0)return!1;const o=Math.abs(-i-Math.sqrt(a));return t&&t.copy(e.direction).mulScalar(o).add(e.origin),!0}intersectsBoundingSphere(e){Ud.sub2(e.center,this.center);const t=e.radius+this.radius;return Ud.lengthSq()<=t*t}}class Jw{constructor(){this.planes=[];for(let e=0;e<6;e++)this.planes[e]=[]}setFromMat4(e){const t=e.data;let s;const i=this.planes;s=i[0],s[0]=t[3]-t[0],s[1]=t[7]-t[4],s[2]=t[11]-t[8],s[3]=t[15]-t[12];let n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]);s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[1],s[0]=t[3]+t[0],s[1]=t[7]+t[4],s[2]=t[11]+t[8],s[3]=t[15]+t[12],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[2],s[0]=t[3]+t[1],s[1]=t[7]+t[5],s[2]=t[11]+t[9],s[3]=t[15]+t[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[3],s[0]=t[3]-t[1],s[1]=t[7]-t[5],s[2]=t[11]-t[9],s[3]=t[15]-t[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[4],s[0]=t[3]-t[2],s[1]=t[7]-t[6],s[2]=t[11]-t[10],s[3]=t[15]-t[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[5],s[0]=t[3]+t[2],s[1]=t[7]+t[6],s[2]=t[11]+t[10],s[3]=t[15]+t[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n}containsPoint(e){let t,s;for(t=0;t<6;t++)if(s=this.planes[t],s[0]*e.x+s[1]*e.y+s[2]*e.z+s[3]<=0)return!1;return!0}containsSphere(e){let t=0,s,i;const n=e.radius,a=e.center,o=a.x,l=a.y,c=a.z,d=this.planes;let h;for(i=0;i<6;i++){if(h=d[i],s=h[0]*o+h[1]*l+h[2]*c+h[3],s<=-n)return 0;s>n&&t++}return t===6?2:1}}class Ga{constructor(e,t){this.origin=new y,this.direction=y.FORWARD.clone(),e&&this.origin.copy(e),t&&this.direction.copy(t)}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.set(e.origin,e.direction)}clone(){return new this.constructor(this.origin,this.direction)}}new Ga;new y;new Al;new q;class FA{constructor(e=y.UP,t=0){this.normal=new y,this.distance=void 0,this.normal.copy(e),this.distance=t}setFromPointNormal(e,t){return this.normal.copy(t),this.distance=-this.normal.dot(e),this}intersectsLine(e,t,s){const i=this.distance,n=this.normal.dot(e)+i,a=this.normal.dot(t)+i,o=n/(n-a),l=o>=0&&o<=1;return l&&s&&s.lerp(e,t,o),l}intersectsRay(e,t){const s=this.normal.dot(e.direction);if(s===0)return!1;const i=-(this.normal.dot(e.origin)+this.distance)/s;return i>=0&&t&&t.copy(e.direction).mulScalar(i).add(e.origin),i>=0}copy(e){return this.normal.copy(e.normal),this.distance=e.distance,this}clone(){const e=this.constructor;return new e().copy(this)}}const np="linear",rp="inverse",Qw="exponential",Tt=0,ae=1,ap=2,fy=0,$t=1,kA=2,eb=4,BA=5,py=6,my=8,ci=0,NA=2,UA=3,zA=4,as=0,Pl=1,VA=2,GA=3,Ml=1,Il=2,yc=4,Et=0,Dr=1,Xh=2,HA=3,Ee=0,nt=1,qc=2,Kc=3,Yc=4,Or=5,WA=0,_y=1,tf=2,G_=3,jA=4,$A=5,XA=6,kn=7,H_=0,ai=1,Fr=2,gy=0,op=1,lp=2,Zc=3,hp=4,Jc=5,Gn=6,xe=7,Qc=8,cp=9,ql=10,Kl=11,yt=12,Yl=13,rt=14,Bn=15,Ha=16,Wa=17,ja=18,dp=19,up=20,ed=21,fp=22,pp=23,Zl=24,Jl=25,td=26,sd=27,yy=28,vy=29,Sy=30,xy=31,mp=32,wy=33,_p=34,gp=35,yp=36,vp=37,Sp=38,by=39,xp=40,wp=41,bp=42,Tp=43,Ep=44,Ty=45,Cp=46,Ap=47,Pp=48,Mp=49,id=50,Ip=51,vc=new Map([[gy,{name:"A8",size:1}],[op,{name:"L8",size:1}],[lp,{name:"LA8",size:2}],[Zc,{name:"RGB565",size:2}],[hp,{name:"RGBA5551",size:2}],[Jc,{name:"RGBA4",size:2}],[Gn,{name:"RGB8",size:4}],[xe,{name:"RGBA8",size:4}],[id,{name:"R16F",size:2}],[Ip,{name:"RG16F",size:4}],[Kl,{name:"RGB16F",size:8}],[yt,{name:"RGBA16F",size:8}],[Yl,{name:"RGB32F",size:16}],[rt,{name:"RGBA32F",size:16}],[Bn,{name:"R32F",size:4}],[Ha,{name:"DEPTH",size:4}],[Wa,{name:"DEPTHSTENCIL",size:4}],[ja,{name:"111110F",size:4}],[dp,{name:"SRGB",size:4}],[up,{name:"SRGBA",size:4}],[xy,{name:"BGRA8",size:4}],[Qc,{name:"DXT1",blockSize:8}],[cp,{name:"DXT3",blockSize:16}],[ql,{name:"DXT5",blockSize:16}],[ed,{name:"ETC1",blockSize:8}],[fp,{name:"ETC2_RGB",blockSize:8}],[pp,{name:"ETC2_RGBA",blockSize:16}],[Zl,{name:"PVRTC_2BPP_RGB_1",blockSize:8}],[Jl,{name:"PVRTC_2BPP_RGBA_1",blockSize:8}],[td,{name:"PVRTC_4BPP_RGB_1",blockSize:8}],[sd,{name:"PVRTC_4BPP_RGBA_1",blockSize:8}],[yy,{name:"ASTC_4x4",blockSize:16}],[vy,{name:"ATC_RGB",blockSize:8}],[Sy,{name:"ATC_RGBA",blockSize:16}],[mp,{name:"R8I",size:1,isInt:!0}],[wy,{name:"R8U",size:1,isInt:!0}],[_p,{name:"R16I",size:2,isInt:!0}],[gp,{name:"R16U",size:2,isInt:!0}],[yp,{name:"R32I",size:4,isInt:!0}],[vp,{name:"R32U",size:4,isInt:!0}],[Sp,{name:"RG8I",size:2,isInt:!0}],[by,{name:"RG8U",size:2,isInt:!0}],[xp,{name:"RG16I",size:4,isInt:!0}],[wp,{name:"RG16U",size:4,isInt:!0}],[bp,{name:"RG32I",size:8,isInt:!0}],[Tp,{name:"RG32U",size:8,isInt:!0}],[Ep,{name:"RGBA8I",size:4,isInt:!0}],[Ty,{name:"RGBA8U",size:4,isInt:!0}],[Cp,{name:"RGBA16I",size:8,isInt:!0}],[Ap,{name:"RGBA16U",size:8,isInt:!0}],[Pp,{name:"RGBA32I",size:16,isInt:!0}],[Mp,{name:"RGBA32U",size:16,isInt:!0}]]),W_=r=>{var e;return((e=vc.get(r))==null?void 0:e.blockSize)!==void 0},$o=r=>{var e;return((e=vc.get(r))==null?void 0:e.isInt)===!0},qA=r=>{switch(r){case Bn:case Yl:case rt:return Float32Array;case yp:case bp:case Pp:return Int32Array;case vp:case Tp:case Mp:return Uint32Array;case _p:case xp:case Cp:return Int16Array;case gp:case wp:case Ap:case Zc:case hp:case Jc:case id:case Ip:case Kl:case yt:return Uint16Array;case mp:case Sp:case Ep:return Int8Array;default:return Uint8Array}},Rp=0,Lp=1,tb=2,sb=3,Ln=4,Ji=5,Ia=6,ht="POSITION",Us="NORMAL",ln="TANGENT",hn="BLENDWEIGHT",Os="BLENDINDICES",Zt="COLOR",lv="TEXCOORD",zs="TEXCOORD0",Hr="TEXCOORD1",nd="TEXCOORD2",rd="TEXCOORD3",ad="TEXCOORD4",od="TEXCOORD5",ld="TEXCOORD6",hd="TEXCOORD7",KA="ATTR",sf="ATTR0",j_="ATTR1",ib="ATTR2",nb="ATTR3",rb="ATTR4",YA="ATTR5",ZA="ATTR6",JA="ATTR7",Ra="ATTR8",La="ATTR9",$_="ATTR10",X_="ATTR11",qh="ATTR12",Da="ATTR13",Kh="ATTR14",Ea="ATTR15",QA=1,vl=0,e1=2,t1=3,s1=5,_m=0,i1=1,hv=2,ps="default",Qi="rgbm",Ey="rgbe",Rl="rgbp",Ll="swizzleGGGR",Is="2d",Nh="2d-array",Uh="cube",ku="3d",Oa=0,Fa=1,Dl=2,cd=3,dd=4,n1="none",q_="cube",cv="equirect",r1="octahedral",ud="wgsl",ao=0,en=1,oo=2,Wr=3,fd=4,Ql=5,Me=6,Cy=7,Sl=0,$a=1,bi=2,kr=3,Rs=4,Xa=5,ka=6,Ba=7,Na=8,Sc=9,xc=10,wc=11,nf=12,bc=13,Ol=14,a1=15,o1=16,Dp=17,l1=18,h1=19,c1=20,Op=21,Fp=22,Ay=23,ab=24,d1=25,Fl=26,kl=27,Bl=28,Nl=29,Ul=30,kp=31,Bp=32,zl=33,Np=34,Up=35,Vl=36,zp=37,Vp=38,rf=39,Py=40,My=41,u1=42,f1=43,p1=44,m1=45,_1=46,g1=47,y1=48,v1=49,ob=["bool","int","float","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","mat2","mat3","mat4","sampler2D","samplerCube","","sampler2DShadow","samplerCubeShadow","sampler3D","","","","","sampler2DArray","uint","uvec2","uvec3","uvec4","","","","","","","","","","","","","isampler2D","usampler2D","isamplerCube","usamplerCube","isampler3D","usampler3D","isampler2DArray","usampler2DArray"],Yh="webgl1",Zo="webgl2",lb="webgpu",Bu="null",Gl=1,Ms=2,S1=4,Tc=0,K_=1,x1=["mesh","view"],pd="default",xl=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array],Zh=[1,1,2,2,4,4,4,2],Y_=[Uint8Array,Uint16Array,Uint32Array],w1=[1,2,4],Le={};Le[ht]=0;Le[Us]=1;Le[hn]=2;Le[Os]=3;Le[Zt]=4;Le[zs]=5;Le[Hr]=6;Le[nd]=7;Le[rd]=8;Le[ad]=9;Le[od]=10;Le[ld]=11;Le[hd]=12;Le[ln]=13;Le[sf]=0;Le[j_]=1;Le[ib]=2;Le[nb]=3;Le[rb]=4;Le[YA]=5;Le[ZA]=6;Le[JA]=7;Le[Ra]=8;Le[La]=9;Le[$_]=10;Le[X_]=11;Le[qh]=12;Le[Da]=13;Le[Kh]=14;Le[Ea]=15;const b1="1.65";function Ft(){return Ft=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(r[s]=t[s])}return r},Ft.apply(this,arguments)}const je={set(r,e,t,s=1){return r&~(s<<t)|e<<t},get(r,e,t=1){return r>>e&t},all(r,e,t=1){const s=t<<e;return(r&s)===s},any(r,e,t=1){return(r&t<<e)!==0}};var md;const zd=7,er=15,dv=0,uv=3,fv=7,pv=11,mv=14,_v=18,Z_=22,gv=23,yv=24,vv=25,Sv=26,T1=15,E1=Z_;class Xe{constructor(e=!1,t=ci,s=$t,i=fy,n,a,o,l=!0,c=!0,d=!0,h=!0){this.target0=0,this.setColorBlend(t,s,i),this.setAlphaBlend(n??t,a??s,o??i),this.setColorWrite(l,c,d,h),this.blend=e}set blend(e){this.target0=je.set(this.target0,e?1:0,Sv)}get blend(){return je.all(this.target0,Sv)}setColorBlend(e,t,s){this.target0=je.set(this.target0,e,dv,zd),this.target0=je.set(this.target0,t,uv,er),this.target0=je.set(this.target0,s,fv,er)}setAlphaBlend(e,t,s){this.target0=je.set(this.target0,e,pv,zd),this.target0=je.set(this.target0,t,mv,er),this.target0=je.set(this.target0,s,_v,er)}setColorWrite(e,t,s,i){this.redWrite=e,this.greenWrite=t,this.blueWrite=s,this.alphaWrite=i}get colorOp(){return je.get(this.target0,dv,zd)}get colorSrcFactor(){return je.get(this.target0,uv,er)}get colorDstFactor(){return je.get(this.target0,fv,er)}get alphaOp(){return je.get(this.target0,pv,zd)}get alphaSrcFactor(){return je.get(this.target0,mv,er)}get alphaDstFactor(){return je.get(this.target0,_v,er)}set redWrite(e){this.target0=je.set(this.target0,e?1:0,Z_)}get redWrite(){return je.all(this.target0,Z_)}set greenWrite(e){this.target0=je.set(this.target0,e?1:0,gv)}get greenWrite(){return je.all(this.target0,gv)}set blueWrite(e){this.target0=je.set(this.target0,e?1:0,yv)}get blueWrite(){return je.all(this.target0,yv)}set alphaWrite(e){this.target0=je.set(this.target0,e?1:0,vv)}get alphaWrite(){return je.all(this.target0,vv)}get allWrite(){return je.get(this.target0,E1,T1)}copy(e){return this.target0=e.target0,this}clone(){return new this.constructor().copy(this)}get key(){return this.target0}equals(e){return this.target0===e.target0}}md=Xe;Xe.NOBLEND=Object.freeze(new md);Xe.NOWRITE=Object.freeze(new md(void 0,void 0,void 0,void 0,void 0,void 0,void 0,!1,!1,!1,!1));Xe.ALPHABLEND=Object.freeze(new md(!0,ci,py,my));Xe.ADDBLEND=Object.freeze(new md(!0,ci,$t,$t));class _d{constructor(){this.map=new Map,this.id=0}get(e){let t=this.map.get(e);return t===void 0&&(t=this.id++,this.map.set(e,t)),t}}var Gp;const C1=new _d,xv=7,wv=0,bv=3;class kt{constructor(e=G_,t=!0){this.data=0,this._depthBias=0,this._depthBiasSlope=0,this.key=0,this.func=e,this.write=t}set test(e){this.func=e?G_:kn,this.updateKey()}get test(){return this.func!==kn}set write(e){this.data=je.set(this.data,e?1:0,bv),this.updateKey()}get write(){return je.all(this.data,bv)}set func(e){this.data=je.set(this.data,e,wv,xv),this.updateKey()}get func(){return je.get(this.data,wv,xv)}set depthBias(e){this._depthBias=e,this.updateKey()}get depthBias(){return this._depthBias}set depthBiasSlope(e){this._depthBiasSlope=e,this.updateKey()}get depthBiasSlope(){return this._depthBiasSlope}copy(e){return this.data=e.data,this._depthBias=e._depthBias,this._depthBiasSlope=e._depthBiasSlope,this.key=e.key,this}clone(){return new this.constructor().copy(this)}updateKey(){const{data:e,_depthBias:t,_depthBiasSlope:s}=this,i=`${e}-${t}-${s}`;this.key=C1.get(i)}equals(e){return this.key===e.key}}Gp=kt;kt.DEFAULT=Object.freeze(new Gp);kt.NODEPTH=Object.freeze(new Gp(kn,!1));kt.WRITEDEPTH=Object.freeze(new Gp(kn,!0));class hb{constructor(){this.globalId=0,this.revision=0}equals(e){return this.globalId===e.globalId&&this.revision===e.revision}copy(e){this.globalId=e.globalId,this.revision=e.revision}reset(){this.globalId=0,this.revision=0}}let Tv=0;class A1{constructor(){Tv++,this.version=new hb,this.version.globalId=Tv}increment(){this.version.revision++}}class P1{constructor(e){this.name=e,this.value=null,this.versionObject=new A1}toJSON(e){}setValue(e){this.value=e,this.versionObject.increment()}getValue(){return this.value}}class M1{constructor(e){this.name=e,this.variables=new Map}resolve(e){return this.variables.has(e)||this.variables.set(e,new P1(e)),this.variables.get(e)}removeValue(e){for(const t in this.variables){const s=this.variables[t];s.value===e&&(s.value=null)}}}let I1=0;class Mi{constructor(e,t,s,i=as,n){this.device=e,this.format=t,this.numVertices=s,this.usage=i,this.id=I1++,this.impl=e.createVertexBufferImpl(this,t),this.numBytes=t.verticesByteSize?t.verticesByteSize:t.size*s,this.adjustVramSizeTracking(e._vram,this.numBytes),n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}destroy(){const e=this.device,t=e.buffers.indexOf(this);t!==-1&&e.buffers.splice(t,1),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.vb+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength!==this.numBytes?!1:(this.storage=e,this.unlock(),!0)}}function Ec(r){let e=0;for(let t=0,s=r.length;t<s;t++)e=(e<<5)-e+r.charCodeAt(t),e|=0;return e}function cb(r){let t=2166136261;for(let s=0;s<r.length;s++)t^=r[s],t*=16777619;return t>>>0}class di{constructor(){this._cache=new Map}get(e,t){return this._cache.has(e)||(this._cache.set(e,t()),e.on("destroy",()=>{this.remove(e)}),e.on("devicelost",()=>{var s;(s=this._cache.get(e))==null||s.loseContext==null||s.loseContext(e)})),this._cache.get(e)}remove(e){var t;(t=this._cache.get(e))==null||t.destroy==null||t.destroy(e),this._cache.delete(e)}}const R1=new _d,L1=[2,4,8,12,16],D1=new di;class os{constructor(e,t,s){this.device=e,this._elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=s,this.interleaved=s===void 0,this.instancing=!1,this.size=t.reduce((l,c)=>l+Math.ceil(c.components*Zh[c.type]/4)*4,0);let i=0,n;for(let l=0,c=t.length;l<c;l++){var a,o;const d=t[l];n=d.components*Zh[d.type],s&&(i=H.roundUp(i,n));const h=(a=d.asInt)!=null?a:!1,u=h?!1:(o=d.normalize)!=null?o:!1,f={name:d.semantic,offset:s?i:d.hasOwnProperty("offset")?d.offset:i,stride:s?n:d.hasOwnProperty("stride")?d.stride:this.size,dataType:d.type,numComponents:d.components,normalize:u,size:n,asInt:h};this._elements.push(f),s?i+=n*s:i+=Math.ceil(n/4)*4,d.semantic===zs?this.hasUv0=!0:d.semantic===Hr?this.hasUv1=!0:d.semantic===Zt?this.hasColor=!0:d.semantic===ln&&(this.hasTangents=!0)}s&&(this.verticesByteSize=i),this._evaluateHash()}get elements(){return this._elements}static getDefaultInstancingFormat(e){return D1.get(e,()=>new os(e,[{semantic:qh,components:4,type:Me},{semantic:Da,components:4,type:Me},{semantic:Kh,components:4,type:Me},{semantic:Ea,components:4,type:Me}]))}static isElementValid(e,t){const s=t.components*Zh[t.type];return!(e.isWebGPU&&!L1.includes(s))}update(){this._evaluateHash()}_evaluateHash(){const e=[],t=[],s=this._elements.length;for(let n=0;n<s;n++){const{name:a,dataType:o,numComponents:l,normalize:c,offset:d,stride:h,size:u,asInt:f}=this._elements[n],p=a+o+l+c+f;e.push(p);const _=p+d+h+u;t.push(_)}e.sort();const i=e.join();this.batchingHash=Ec(i),this.shaderProcessingHashString=i,this.renderingHashString=t.join("_"),this.renderingHash=R1.get(this.renderingHashString)}}var db;const O1=new _d;class oi{set func(e){this._func=e,this._dirty=!0}get func(){return this._func}set ref(e){this._ref=e,this._dirty=!0}get ref(){return this._ref}set fail(e){this._fail=e,this._dirty=!0}get fail(){return this._fail}set zfail(e){this._zfail=e,this._dirty=!0}get zfail(){return this._zfail}set zpass(e){this._zpass=e,this._dirty=!0}get zpass(){return this._zpass}set readMask(e){this._readMask=e,this._dirty=!0}get readMask(){return this._readMask}set writeMask(e){this._writeMask=e,this._dirty=!0}get writeMask(){return this._writeMask}constructor(e={}){var t,s,i,n,a,o,l;this._func=void 0,this._ref=void 0,this._fail=void 0,this._zfail=void 0,this._zpass=void 0,this._readMask=void 0,this._writeMask=void 0,this._dirty=!0,this._key=void 0,this._func=(t=e.func)!=null?t:kn,this._ref=(s=e.ref)!=null?s:0,this._readMask=(i=e.readMask)!=null?i:255,this._writeMask=(n=e.writeMask)!=null?n:255,this._fail=(a=e.fail)!=null?a:vl,this._zfail=(o=e.zfail)!=null?o:vl,this._zpass=(l=e.zpass)!=null?l:vl,this._evalKey()}_evalKey(){const{_func:e,_ref:t,_fail:s,_zfail:i,_zpass:n,_readMask:a,_writeMask:o}=this,l=`${e},${t},${s},${i},${n},${a},${o}`;this._key=O1.get(l),this._dirty=!1}get key(){return this._dirty&&this._evalKey(),this._key}copy(e){return this._func=e._func,this._ref=e._ref,this._readMask=e._readMask,this._writeMask=e._writeMask,this._fail=e._fail,this._zfail=e._zfail,this._zpass=e._zpass,this._dirty=e._dirty,this._key=e._key,this}clone(){return new this.constructor().copy(this)}}db=oi;oi.DEFAULT=Object.freeze(new db);class ct extends ie{constructor(e,t){var s,i,n,a,o,l,c,d;super(),this.canvas=void 0,this.backBuffer=null,this.backBufferSize=new M,this.backBufferFormat=void 0,this.backBufferAntialias=!1,this.isWebGPU=!1,this.isWebGL1=!1,this.isWebGL2=!1,this.scope=void 0,this.boneLimit=void 0,this.maxAnisotropy=void 0,this.maxCubeMapSize=void 0,this.maxTextureSize=void 0,this.maxVolumeSize=void 0,this.maxColorAttachments=1,this.precision=void 0,this.samples=void 0,this.supportsStencil=void 0,this.supportsMrt=!1,this.supportsVolumeTextures=!1,this.supportsCompute=!1,this.renderTarget=null,this.shaders=[],this.textures=[],this.targets=new Set,this.renderVersion=0,this.renderPassIndex=void 0,this.insideRenderPass=!1,this.supportsInstancing=void 0,this.supportsUniformBuffers=!1,this.textureFloatRenderable=void 0,this.textureHalfFloatRenderable=void 0,this.textureFloatFilterable=!1,this.textureHalfFloatFilterable=!1,this.quadVertexBuffer=void 0,this.blendState=new Xe,this.depthState=new kt,this.stencilEnabled=!1,this.stencilFront=new oi,this.stencilBack=new oi,this.dynamicBuffers=void 0,this.gpuProfiler=void 0,this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:Ml|Il},this.canvas=e,this.initOptions=Ft({},t),(i=(s=this.initOptions).depth)!=null||(s.depth=!0),(a=(n=this.initOptions).stencil)!=null||(n.stencil=!0),(l=(o=this.initOptions).antialias)!=null||(o.antialias=!0),(d=(c=this.initOptions).powerPreference)!=null||(c.powerPreference="high-performance"),this._maxPixelRatio=Te.browser?Math.min(1,window.devicePixelRatio):1,this.buffers=[],this._vram={tex:0,vb:0,ib:0,ub:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.initializeContextCaches(),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(let h=Rp;h<=Ia;h++)this._primsPerFrame[h]=0;this._renderTargetCreationTime=0,this.scope=new M1("Device"),this.textureBias=this.scope.resolve("textureBias"),this.textureBias.setValue(0)}postInit(){const e=new os(this,[{semantic:ht,components:2,type:Me}]),t=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.quadVertexBuffer=new Mi(this,e,4,as,t)}destroy(){var e,t,s;this.fire("destroy"),(e=this.quadVertexBuffer)==null||e.destroy(),this.quadVertexBuffer=null,(t=this.dynamicBuffers)==null||t.destroy(),this.dynamicBuffers=null,(s=this.gpuProfiler)==null||s.destroy(),this.gpuProfiler=null}onDestroyShader(e){this.fire("destroy:shader",e);const t=this.shaders.indexOf(e);t!==-1&&this.shaders.splice(t,1)}postDestroy(){this.scope=null,this.canvas=null}toJSON(e){}initializeContextCaches(){this.indexBuffer=null,this.vertexBuffers=[],this.shader=null,this.shaderValid=void 0,this.shaderAsyncCompile=!1,this.renderTarget=null}initializeRenderState(){this.blendState=new Xe,this.depthState=new kt,this.cullMode=Dr,this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.blendColor=new k(0,0,0,0)}setStencilState(e,t){}setBlendState(e){}setBlendColor(e,t,s,i){}setDepthState(e){}setCullMode(e){}setRenderTarget(e){this.renderTarget=e}setIndexBuffer(e){this.indexBuffer=e}setVertexBuffer(e){e&&this.vertexBuffers.push(e)}getRenderTarget(){return this.renderTarget}initRenderTarget(e){e.initialized||(e.init(),this.targets.add(e))}_isBrowserInterface(e){return this._isImageBrowserInterface(e)||this._isImageCanvasInterface(e)||this._isImageVideoInterface(e)}_isImageBrowserInterface(e){return typeof ImageBitmap<"u"&&e instanceof ImageBitmap||typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement}_isImageCanvasInterface(e){return typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement}_isImageVideoInterface(e){return typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement}resizeCanvas(e,t){const s=Math.min(this._maxPixelRatio,Te.browser?window.devicePixelRatio:1),i=Math.floor(e*s),n=Math.floor(t*s);(i!==this.canvas.width||n!==this.canvas.height)&&this.setResolution(i,n)}setResolution(e,t){this.canvas.width=e,this.canvas.height=t,this.fire(ct.EVENT_RESIZE,e,t)}updateClientRect(){this.clientRect=this.canvas.getBoundingClientRect()}get width(){return this.canvas.width}get height(){return this.canvas.height}set fullscreen(e){}get fullscreen(){return!1}set maxPixelRatio(e){this._maxPixelRatio=e}get maxPixelRatio(){return this._maxPixelRatio}get deviceType(){return this._deviceType}getBoneLimit(){return this.boneLimit}setBoneLimit(e){this.boneLimit=e}startRenderPass(e){}endRenderPass(e){}startComputePass(){}endComputePass(){}frameStart(){this.renderPassIndex=0,this.renderVersion++}frameEnd(){}getRenderableHdrFormat(e=[ja,yt,rt],t=!0){for(let s=0;s<e.length;s++){const i=e[s];switch(i){case ja:{if(this.textureRG11B10Renderable)return i;break}case yt:if(this.textureHalfFloatRenderable&&(!t||this.textureHalfFloatFilterable))return i;break;case rt:if(this.textureFloatRenderable&&(!t||this.textureFloatFilterable))return i;break}}}}ct.EVENT_RESIZE="resizecanvas";let F1=0;class Ct{constructor(e={}){var t,s,i,n,a,o;this.name=void 0,this._device=void 0,this._colorBuffer=void 0,this._colorBuffers=void 0,this._depthBuffer=void 0,this._depth=void 0,this._stencil=void 0,this._samples=void 0,this.autoResolve=void 0,this._face=void 0,this.flipY=void 0,this.id=F1++;const l=arguments[1],c=arguments[2];if(e instanceof ct?(this._colorBuffer=l,e=c):this._colorBuffer=e.colorBuffer,this._colorBuffer&&(this._colorBuffers=[this._colorBuffer]),this._depthBuffer=e.depthBuffer,this._face=(t=e.face)!=null?t:0,this._depthBuffer){const m=this._depthBuffer._format;m===Ha?(this._depth=!0,this._stencil=!1):m===Wa?(this._depth=!0,this._stencil=!0):(this._depth=!1,this._stencil=!1)}else{var d,h;this._depth=(d=e.depth)!=null?d:!0,this._stencil=(h=e.stencil)!=null?h:!1}e.colorBuffers&&(this._colorBuffers||(this._colorBuffers=[...e.colorBuffers],this._colorBuffer=e.colorBuffers[0]));const u=((s=this._colorBuffer)==null?void 0:s.device)||((i=this._depthBuffer)==null?void 0:i.device)||e.graphicsDevice;this._device=u;const{maxSamples:f}=this._device;if(this._samples=Math.min((n=e.samples)!=null?n:1,f),u.isWebGPU&&(this._samples=this._samples>1?f:1),this.autoResolve=(a=e.autoResolve)!=null?a:!0,this.name=e.name,!this.name){var p;this.name=(p=this._colorBuffer)==null?void 0:p.name}if(!this.name){var _;this.name=(_=this._depthBuffer)==null?void 0:_.name}this.name||(this.name="Untitled"),this.flipY=(o=e.flipY)!=null?o:!1,this.validateMrt(),this.impl=u.createRenderTargetImpl(this)}destroy(){const e=this._device;e&&(e.targets.delete(this),e.renderTarget===this&&e.setRenderTarget(null),this.destroyFrameBuffers())}destroyFrameBuffers(){const e=this._device;e&&this.impl.destroy(e)}destroyTextureBuffers(){var e,t;(e=this._depthBuffer)==null||e.destroy(),this._depthBuffer=null,(t=this._colorBuffers)==null||t.forEach(s=>{s.destroy()}),this._colorBuffers=null,this._colorBuffer=null}resize(e,t){if(this.width!==e||this.height!==t){var s,i;const n=this._device;this.destroyFrameBuffers(),n.renderTarget===this&&n.setRenderTarget(null),(s=this._depthBuffer)==null||s.resize(e,t),(i=this._colorBuffers)==null||i.forEach(a=>{a.resize(e,t)}),this.validateMrt(),this.impl=n.createRenderTargetImpl(this)}}validateMrt(){}init(){this.impl.init(this._device,this)}get initialized(){return this.impl.initialized}get device(){return this._device}loseContext(){this.impl.loseContext()}resolve(e=!0,t=!!this._depthBuffer){this._device&&this._samples>1&&this.impl.resolve(this._device,this,e,t)}copy(e,t,s){if(!this._device)if(e._device)this._device=e._device;else return!1;return this._device.copyRenderTarget(e,this,t,s)}get samples(){return this._samples}get depth(){return this._depth}get stencil(){return this._stencil}get colorBuffer(){return this._colorBuffer}getColorBuffer(e){var t;return(t=this._colorBuffers)==null?void 0:t[e]}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get width(){var e,t;return((e=this._colorBuffer)==null?void 0:e.width)||((t=this._depthBuffer)==null?void 0:t.width)||this._device.width}get height(){var e,t;return((e=this._colorBuffer)==null?void 0:e.height)||((t=this._depthBuffer)==null?void 0:t.height)||this._device.height}}class k1{constructor(){this.bindGroup=void 0}update(e){this.destroy();const t=e.device,s=this.createDescriptor(t,e);this.bindGroup=t.wgpu.createBindGroup(s)}destroy(){this.bindGroup=null}createDescriptor(e,t){const s=[],i=t.format;let n=0;return t.uniformBuffers.forEach(o=>{const l=o.persistent?o.impl.buffer:o.allocation.gpuBuffer.buffer;s.push({binding:n++,resource:{buffer:l,offset:0,size:o.format.byteSize}})}),t.textures.forEach((o,l)=>{const c=o.impl,d=i.textureFormats[l],h=c.getView(e);s.push({binding:n++,resource:h});const u=c.getSampler(e,d.sampleType);s.push({binding:n++,resource:u})}),t.storageTextures.forEach((o,l)=>{const d=o.impl.getView(e);s.push({binding:n++,resource:d})}),{layout:t.format.impl.bindGroupLayout,entries:s}}}class Ev{static shaderStage(e){let t=0;return e&Gl&&(t|=GPUShaderStage.VERTEX),e&Ms&&(t|=GPUShaderStage.FRAGMENT),e&S1&&(t|=GPUShaderStage.COMPUTE),t}}const ue=[];ue[gy]="";ue[op]="r8unorm";ue[lp]="rg8unorm";ue[Zc]="";ue[hp]="";ue[Jc]="";ue[Gn]="rgba8unorm";ue[xe]="rgba8unorm";ue[Qc]="bc1-rgba-unorm";ue[cp]="bc2-rgba-unorm";ue[ql]="bc3-rgba-unorm";ue[Kl]="";ue[yt]="rgba16float";ue[id]="r16float";ue[Ip]="rg16float";ue[Yl]="";ue[rt]="rgba32float";ue[Bn]="r32float";ue[Ha]="depth32float";ue[Wa]="depth24plus-stencil8";ue[ja]="rg11b10ufloat";ue[dp]="";ue[up]="";ue[ed]="";ue[fp]="etc2-rgb8unorm";ue[pp]="etc2-rgba8unorm";ue[Zl]="";ue[Jl]="";ue[td]="";ue[sd]="";ue[yy]="astc-4x4-unorm";ue[vy]="";ue[Sy]="";ue[xy]="bgra8unorm";ue[mp]="r8sint";ue[wy]="r8uint";ue[_p]="r16sint";ue[gp]="r16uint";ue[yp]="r32sint";ue[vp]="r32uint";ue[Sp]="rg8sint";ue[by]="rg8uint";ue[xp]="rg16sint";ue[wp]="rg16uint";ue[bp]="rg32sint";ue[Tp]="rg32uint";ue[Ep]="rgba8sint";ue[Ty]="rgba8uint";ue[Cp]="rgba16sint";ue[Ap]="rgba16uint";ue[Pp]="rgba32sint";ue[Mp]="rgba32uint";const eh=[];eh[Oa]="filtering";eh[Fa]="non-filtering";eh[Dl]="comparison";eh[cd]="comparison";eh[dd]="comparison";const th=[];th[Oa]="float";th[Fa]="unfilterable-float";th[Dl]="depth";th[cd]="sint";th[dd]="uint";const B1=new _d;class N1{constructor(e){const t=e.device,{key:s,descr:i}=this.createDescriptor(e);this.key=B1.get(s),this.bindGroupLayout=t.wgpu.createBindGroupLayout(i)}destroy(){this.bindGroupLayout=null}loseContext(){}getTextureSlot(e,t){return e.bufferFormats.length+t*2}createDescriptor(e){const t=[];let s="",i=0;return e.bufferFormats.forEach(a=>{const o=Ev.shaderStage(a.visibility);s+=`#${i}U:${o}`,t.push({binding:i++,visibility:o,buffer:{type:"uniform",hasDynamicOffset:!0}})}),e.textureFormats.forEach(a=>{const o=Ev.shaderStage(a.visibility),l=a.sampleType,c=a.textureDimension,d=!1,h=th[l];s+=`#${i}T:${o}-${h}-${c}-${d}`,t.push({binding:i++,visibility:o,texture:{sampleType:h,viewDimension:c,multisampled:d}});const u=eh[l];s+=`#${i}S:${o}-${u}`,t.push({binding:i++,visibility:o,sampler:{type:u}})}),e.storageTextureFormats.forEach(a=>{const{format:o,textureDimension:l}=a;s+=`#${i}ST:${o}-${l}`,t.push({binding:i++,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:ue[o],viewDimension:l}})}),{key:s,descr:{entries:t}}}}class Iy{constructor(){this.buffer=null}destroy(e){this.buffer&&(this.buffer.destroy(),this.buffer=null)}get initialized(){return!!this.buffer}loseContext(){}unlock(e,t,s,i){var n,a;const o=e.wgpu;if(!this.buffer){const h=i.byteLength+3&-4;this.buffer=e.wgpu.createBuffer({size:h,usage:s|GPUBufferUsage.COPY_DST})}const l=(n=i.byteOffset)!=null?n:0,c=new Uint8Array((a=i.buffer)!=null?a:i,l,i.byteLength),d=new Uint8Array(this.buffer.size);d.set(c),o.queue.writeBuffer(this.buffer,0,d,0,d.length)}}class U1 extends Iy{constructor(e){super(),this.format=null,this.format=e.format===ai?"uint16":"uint32"}unlock(e){const t=e.device;super.unlock(t,e.usage,GPUBufferUsage.INDEX,e.storage)}}const z1={equals(r,e){if(r.size!==e.size)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}},Hn=[];Hn[ao]="sint8";Hn[en]="uint8";Hn[oo]="sint16";Hn[Wr]="uint16";Hn[fd]="sint32";Hn[Ql]="uint32";Hn[Me]="float32";Hn[Cy]="float16";const Wn=[];Wn[ao]="snorm8";Wn[en]="unorm8";Wn[oo]="snorm16";Wn[Wr]="unorm16";Wn[fd]="sint32";Wn[Ql]="uint32";Wn[Me]="float32";Wn[Cy]="float16";class V1{constructor(){this.cache=new Map}get(e,t=null){const s=this.getKey(e,t);let i=this.cache.get(s);return i||(i=this.create(e,t),this.cache.set(s,i)),i}getKey(e,t=null){return`${e==null?void 0:e.renderingHashString}-${t==null?void 0:t.renderingHashString}`}create(e,t){const s=[],i=n=>{const a=n.interleaved,o=n.instancing?"instance":"vertex";let l=[];const c=n.elements.length;for(let d=0;d<c;d++){const h=n.elements[d],u=Le[h.name],f=h.normalize?Wn:Hn;l.push({shaderLocation:u,offset:a?h.offset:0,format:`${f[h.dataType]}${h.numComponents>1?"x"+h.numComponents:""}`}),(!a||d===c-1)&&(s.push({attributes:l,arrayStride:h.stride,stepMode:o}),l=[])}};return e&&i(e),t&&i(t),s}}class ub{constructor(e){this.device=e}getPipelineLayout(e){const t=[];e.forEach(n=>{t.push(n.bindGroupLayout)});const s={bindGroupLayouts:t};return this.device.wgpu.createPipelineLayout(s)}}const G1=["point-list","line-list",void 0,"line-strip","triangle-list","triangle-strip",void 0],Cv=["add","subtract","reverse-subtract","min","max"],Vd=["zero","one","src","one-minus-src","dst","one-minus-dst","src-alpha","src-alpha-saturated","one-minus-src-alpha","dst-alpha","one-minus-dst-alpha","constant","one-minus-constant"],gm=["never","less","equal","less-equal","greater","not-equal","greater-equal","always"],H1=["none","back","front"],vo=["keep","zero","replace","increment-clamp","increment-wrap","decrement-clamp","decrement-wrap","invert"];class W1{constructor(){this.pipeline=void 0,this.hashes=void 0}}class j1 extends ub{constructor(e){super(e),this.lookupHashes=new Uint32Array(13),this.vertexBufferLayout=new V1,this.cache=new Map}get(e,t,s,i,n,a,o,l,c,d,h,u){var f,p,_,m,g,v,x,S;const w=this.lookupHashes;w[0]=e.type,w[1]=i.id,w[2]=c,w[3]=l.key,w[4]=o.key,w[5]=(f=t==null?void 0:t.renderingHash)!=null?f:0,w[6]=(p=s==null?void 0:s.renderingHash)!=null?p:0,w[7]=n.impl.key,w[8]=(_=(m=a[0])==null?void 0:m.key)!=null?_:0,w[9]=(g=(v=a[1])==null?void 0:v.key)!=null?g:0,w[10]=(x=(S=a[2])==null?void 0:S.key)!=null?x:0,w[11]=d?h.key:0,w[12]=d?u.key:0;const T=cb(w);let b=this.cache.get(T);if(b)for(let L=0;L<b.length;L++){const V=b[L];if(z1.equals(V.hashes,w))return V.pipeline}const C=G1[e.type],E=this.getPipelineLayout(a),R=this.vertexBufferLayout.get(t,s),B=new W1;return B.hashes=new Uint32Array(w),B.pipeline=this.create(C,i,n,E,o,l,R,c,d,h,u),b?b.push(B):b=[B],this.cache.set(T,b),B.pipeline}getBlend(e){let t;return e.blend&&(t={color:{operation:Cv[e.colorOp],srcFactor:Vd[e.colorSrcFactor],dstFactor:Vd[e.colorDstFactor]},alpha:{operation:Cv[e.alphaOp],srcFactor:Vd[e.alphaSrcFactor],dstFactor:Vd[e.alphaDstFactor]}}),t}getDepthStencil(e,t,s,i,n){let a;const{depth:o,stencil:l}=t;return(o||l)&&(a={format:t.impl.depthFormat},o?(a.depthWriteEnabled=e.write,a.depthCompare=gm[e.func],a.depthBias=e.depthBias,a.depthBiasSlopeScale=e.depthBiasSlope):(a.depthWriteEnabled=!1,a.depthCompare="always"),l&&s&&(a.stencilReadMas=i.readMask,a.stencilWriteMask=i.writeMask,a.stencilFront={compare:gm[i.func],failOp:vo[i.fail],passOp:vo[i.zpass],depthFailOp:vo[i.zfail]},a.stencilBack={compare:gm[n.func],failOp:vo[n.fail],passOp:vo[n.zpass],depthFailOp:vo[n.zfail]})),a}create(e,t,s,i,n,a,o,l,c,d,h){const u=this.device.wgpu,f=t.impl,p={vertex:{module:f.getVertexShaderModule(),entryPoint:f.vertexEntryPoint,buffers:o},primitive:{topology:e,frontFace:"ccw",cullMode:H1[l]},depthStencil:this.getDepthStencil(a,s,c,d,h),multisample:{count:s.samples},layout:i},_=s.impl.colorAttachments;if(_.length>0){p.fragment={module:f.getFragmentShaderModule(),entryPoint:f.fragmentEntryPoint,targets:[]};let g=0;n.redWrite&&(g|=GPUColorWrite.RED),n.greenWrite&&(g|=GPUColorWrite.GREEN),n.blueWrite&&(g|=GPUColorWrite.BLUE),n.alphaWrite&&(g|=GPUColorWrite.ALPHA);const v=this.getBlend(n);_.forEach(x=>{p.fragment.targets.push({format:x.format,writeMask:g,blend:v})})}return u.createRenderPipeline(p)}}class $1 extends ub{get(e,t){const s=this.getPipelineLayout([t.impl]);return this.create(e,s)}create(e,t){const s=this.device.wgpu,i=e.impl,n={compute:{module:i.getComputeShaderModule(),entryPoint:i.computeEntryPoint},layout:t};return s.createComputePipeline(n)}}const X1=new _d;class q1{constructor(){this.format=void 0,this.multisampledBuffer=void 0}destroy(){var e;(e=this.multisampledBuffer)==null||e.destroy(),this.multisampledBuffer=null}}class K1{constructor(e){this.initialized=!1,this.key=void 0,this.colorAttachments=[],this.depthFormat=void 0,this.hasStencil=void 0,this.depthTexture=null,this.depthTextureInternal=!1,this.assignedColorTexture=null,this.renderPassDescriptor={},this.renderTarget=e,e._colorBuffers&&e._colorBuffers.forEach((t,s)=>{this.setColorAttachment(s,void 0,t.impl.format)}),this.updateKey()}destroy(e){if(this.initialized=!1,this.depthTextureInternal){var t;(t=this.depthTexture)==null||t.destroy(),this.depthTexture=null}this.assignedColorTexture=null,this.colorAttachments.forEach(s=>{s.destroy()}),this.colorAttachments.length=0}updateKey(){const e=this.renderTarget;let t=`${e.samples}:${e.depth?this.depthFormat:"nodepth"}`;this.colorAttachments.forEach(s=>{t+=`:${s.format}`}),this.key=X1.get(t)}setDepthFormat(e){this.depthFormat=e,this.hasStencil=e==="depth24plus-stencil8"}assignColorTexture(e){this.assignedColorTexture=e;const t=e.createView(),s=this.renderPassDescriptor.colorAttachments[0];this.renderTarget.samples>1?s.resolveTarget=t:s.view=t,this.setColorAttachment(0,void 0,e.format),this.updateKey()}setColorAttachment(e,t,s){this.colorAttachments[e]||(this.colorAttachments[e]=new q1),t&&(this.colorAttachments[e].multisampledBuffer=t),s&&(this.colorAttachments[e].format=s)}init(e,t){var s,i;const n=e.wgpu;this.initDepthStencil(n,t),this.renderPassDescriptor.colorAttachments=[];const a=(s=(i=t._colorBuffers)==null?void 0:i.length)!=null?s:1;for(let l=0;l<a;++l){var o;const c=this.initColor(n,t,l),d=l===0&&((o=this.colorAttachments[0])==null?void 0:o.format);(c.view||d)&&this.renderPassDescriptor.colorAttachments.push(c)}this.initialized=!0}initDepthStencil(e,t){const{samples:s,width:i,height:n,depth:a,depthBuffer:o}=t;if(a||o){if(o)this.depthTexture=o.impl.gpuTexture,this.setDepthFormat(o.impl.format);else{this.setDepthFormat("depth24plus-stencil8");const l={size:[i,n,1],dimension:"2d",sampleCount:s,format:this.depthFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT};s>1?l.usage|=GPUTextureUsage.TEXTURE_BINDING:l.usage|=GPUTextureUsage.COPY_SRC,this.depthTexture=e.createTexture(l),this.depthTextureInternal=!0}this.renderPassDescriptor.depthStencilAttachment={view:this.depthTexture.createView()}}}initColor(e,t,s){const i={},{samples:n,width:a,height:o}=t,l=t.getColorBuffer(s);let c=null;if(l&&(l.cubemap?c=l.impl.createView({dimension:"2d",baseArrayLayer:t.face,arrayLayerCount:1,mipLevelCount:1}):c=l.impl.createView({mipLevelCount:1})),n>1){var d,h;const u={size:[a,o,1],dimension:"2d",sampleCount:n,format:(d=(h=this.colorAttachments[s])==null?void 0:h.format)!=null?d:l.impl.format,usage:GPUTextureUsage.RENDER_ATTACHMENT},f=e.createTexture(u);this.setColorAttachment(s,f,u.format),i.view=f.createView(),i.resolveTarget=c}else i.view=c;return i}setupForRenderPass(e){var t,s;const i=(t=(s=this.renderPassDescriptor.colorAttachments)==null?void 0:s.length)!=null?t:0;for(let a=0;a<i;++a){const o=this.renderPassDescriptor.colorAttachments[a],l=e.colorArrayOps[a];o.clearValue=l.clearValue,o.loadOp=l.clear?"clear":"load",o.storeOp=l.store?"store":"discard"}const n=this.renderPassDescriptor.depthStencilAttachment;n&&(n.depthClearValue=e.depthStencilOps.clearDepthValue,n.depthLoadOp=e.depthStencilOps.clearDepth?"clear":"load",n.depthStoreOp=e.depthStencilOps.storeDepth?"store":"discard",n.depthReadOnly=!1,this.hasStencil&&(n.stencilClearValue=e.depthStencilOps.clearStencilValue,n.stencilLoadOp=e.depthStencilOps.clearStencil?"clear":"load",n.stencilStoreOp=e.depthStencilOps.storeStencil?"store":"discard",n.stencilReadOnly=!1))}loseContext(){this.initialized=!1}resolve(e,t,s,i){}}const At=[];At[bi]=1;At[kr]=2;At[Rs]=3;At[Xa]=4;At[$a]=1;At[ka]=2;At[Ba]=3;At[Na]=4;At[Sl]=1;At[Sc]=2;At[xc]=3;At[wc]=4;At[nf]=8;At[bc]=12;At[Ol]=16;At[Fl]=1;At[kl]=2;At[Bl]=3;At[Nl]=4;class vt{get isArrayType(){return this.count>0}constructor(e,t,s=0){if(this.name=void 0,this.type=void 0,this.byteSize=void 0,this.offset=void 0,this.scopeId=void 0,this.count=void 0,this.numComponents=void 0,this.shortName=e,this.name=s?`${e}[0]`:e,this.type=t,this.numComponents=At[t],this.updateType=t,s>0)switch(t){case bi:this.updateType=Dp;break;case $a:this.updateType=Ul;break;case Fl:this.updateType=kp;break;case Sl:this.updateType=Bp;break;case kr:this.updateType=Op;break;case ka:this.updateType=zl;break;case kl:this.updateType=Np;break;case Sc:this.updateType=Up;break;case Rs:this.updateType=Fp;break;case Ba:this.updateType=Vl;break;case Bl:this.updateType=zp;break;case xc:this.updateType=Vp;break;case Xa:this.updateType=Ay;break;case Na:this.updateType=rf;break;case Nl:this.updateType=Py;break;case wc:this.updateType=My;break;case Ol:this.updateType=ab;break}this.count=s;let i=this.numComponents;s&&(i=H.roundUp(i,4)),this.byteSize=i*4,s&&(this.byteSize*=s)}calculateOffset(e){let t=this.byteSize<=8?this.byteSize:16;this.count&&(t=16),e=H.roundUp(e,t),this.offset=e/4}}class Hp{constructor(e,t){this.byteSize=0,this.map=new Map,this.scope=e.scope,this.uniforms=t;let s=0;for(let i=0;i<t.length;i++){const n=t[i];n.calculateOffset(s),s=n.offset*4+n.byteSize,n.scopeId=this.scope.resolve(n.name),this.map.set(n.name,n)}this.byteSize=H.roundUp(s,16)}get(e){return this.map.get(e)}getShaderDeclaration(e,t){const s=x1[e];let i=`layout(set = ${e}, binding = ${t}, std140) uniform ub_${s} {
`;return this.uniforms.forEach(n=>{const a=ob[n.type];i+=`    ${a} ${n.shortName}${n.count?`[${n.count}]`:""};
`}),i+`};
`}}let Y1=0;const Z1={[Is]:"texture2D",[Uh]:"textureCube",[ku]:"texture3D",[Nh]:"texture2DArray"};class Wp{constructor(e,t){this.name=e,this.visibility=t}}class ur{constructor(e,t,s=Is,i=Oa){this.scopeId=void 0,this.name=e,this.visibility=t,this.textureDimension=s,this.sampleType=i}}class jp{constructor(e,t=[],s=[],i=[],n={}){var a;this.compute=!1,this.id=Y1++,this.compute=(a=n.compute)!=null?a:!1,this.device=e;const o=e.scope;this.bufferFormats=t,this.bufferFormatsMap=new Map,t.forEach((l,c)=>this.bufferFormatsMap.set(l.name,c)),this.textureFormats=s,this.textureFormatsMap=new Map,s.forEach((l,c)=>{this.textureFormatsMap.set(l.name,c),l.scopeId=o.resolve(l.name)}),this.storageTextureFormats=i,this.storageTextureFormatsMap=new Map,i.forEach((l,c)=>{this.storageTextureFormatsMap.set(l.name,c),l.scopeId=o.resolve(l.name)}),this.impl=e.createBindGroupFormatImpl(this)}destroy(){this.impl.destroy()}getTexture(e){const t=this.textureFormatsMap.get(e);return t!==void 0?this.textureFormats[t]:null}getStorageTexture(e){const t=this.storageTextureFormatsMap.get(e);return t!==void 0?this.storageTextureFormats[t]:null}getShaderDeclarationTextures(e){let t="",s=this.bufferFormats.length;return this.textureFormats.forEach(i=>{let n=Z1[i.textureDimension],a="",o="";n==="texture2DArray"&&(a="_texture",o=`#define ${i.name} sampler2DArray(${i.name}${a}, ${i.name}_sampler)
`),i.sampleType===cd?n=`i${n}`:i.sampleType===dd&&(n=`u${n}`),t+=`layout(set = ${e}, binding = ${s++}) uniform ${n} ${i.name}${a};
layout(set = ${e}, binding = ${s++}) uniform sampler ${i.name}_sampler;
`+o}),t}loseContext(){}}const Av=/[ \t]*(\battribute\b|\bvarying\b|\buniform\b)/g,ym=/(\battribute\b|\bvarying\b|\bout\b|\buniform\b)[ \t]*([^;]+)([;]+)/g,vm="@@@",J1=/([\w-]+)\[(.*?)\]/,Q1=new Set(["highp","mediump","lowp"]),eP=new Set(["sampler2DShadow","samplerCubeShadow","sampler2DArrayShadow"]),tP={sampler2D:Is,sampler3D:ku,samplerCube:Uh,samplerCubeShadow:Uh,sampler2DShadow:Is,sampler2DArray:Nh,sampler2DArrayShadow:Nh,isampler2D:Is,usampler2D:Is,isampler3D:ku,usampler3D:ku,isamplerCube:Uh,usamplerCube:Uh,isampler2DArray:Nh,usampler2DArray:Nh};class sP{constructor(e,t){this.line=e;const s=e.trim().split(/\s+/);if(Q1.has(s[0])&&(this.precision=s.shift()),this.type=s.shift(),e.includes(","),e.includes("[")){const i=s.join(" "),n=J1.exec(i);this.name=n[1],this.arraySize=Number(n[2]),isNaN(this.arraySize)&&(t.failed=!0)}else this.name=s.shift(),this.arraySize=0;this.isSampler=this.type.indexOf("sampler")!==-1,this.isSignedInt=this.type.indexOf("isampler")!==-1,this.isUnsignedInt=this.type.indexOf("usampler")!==-1}}class Cs{static run(e,t,s){const i=new Map,n=Cs.extract(t.vshader),a=Cs.extract(t.fshader),o=Cs.processAttributes(n.attributes,t.attributes,t.processingOptions),l=Cs.processVaryings(n.varyings,i,!0),c=Cs.processVaryings(a.varyings,i,!1),d=Cs.processOuts(a.outs),h=n.uniforms.concat(a.uniforms),f=Array.from(new Set(h)).map(x=>new sP(x,s)),p=Cs.processUniforms(e,f,t.processingOptions,s),_=o+`
`+l+`
`+p.code,m=n.src.replace(vm,_),g=c+`
`+d+`
`+p.code,v=a.src.replace(vm,g);return{vshader:m,fshader:v,meshUniformBufferFormat:p.meshUniformBufferFormat,meshBindGroupFormat:p.meshBindGroupFormat}}static extract(e){const t=[],s=[],i=[],n=[];let a=`${vm}
`,o;for(;(o=Av.exec(e))!==null;){const l=o[1];switch(l){case"attribute":case"varying":case"uniform":case"out":{ym.lastIndex=o.index;const c=ym.exec(e);l==="attribute"?t.push(c[2]):l==="varying"?s.push(c[2]):l==="out"?i.push(c[2]):l==="uniform"&&n.push(c[2]),e=Cs.cutOut(e,o.index,ym.lastIndex,a),Av.lastIndex=o.index+a.length,a="";break}}}return{src:e,attributes:t,varyings:s,outs:i,uniforms:n}}static processUniforms(e,t,s,i){const n=[],a=[];t.forEach(f=>{f.isSampler?n.push(f):a.push(f)});const o=[];a.forEach(f=>{if(!s.hasUniform(f.name)){const p=ob.indexOf(f.type),_=new vt(f.name,p,f.arraySize);o.push(_)}});const l=o.length?new Hp(e,o):null,c=[];l&&c.push(new Wp(pd,Gl|Ms));const d=[];n.forEach(f=>{if(!s.hasTexture(f.name)){let p=Oa;f.isSignedInt?p=cd:f.isUnsignedInt?p=dd:(f.precision==="highp"&&(p=Fa),eP.has(f.type)&&(p=Dl));const _=tP[f.type];d.push(new ur(f.name,Gl|Ms,_,p))}});const h=new jp(e,c,d);let u="";return s.uniformFormats.forEach((f,p)=>{f&&(u+=f.getShaderDeclaration(p,0))}),l&&(u+=l.getShaderDeclaration(Tc,0)),s.bindGroupFormats.forEach((f,p)=>{f&&(u+=f.getShaderDeclarationTextures(p))}),u+=h.getShaderDeclarationTextures(Tc),{code:u,meshUniformBufferFormat:l,meshBindGroupFormat:h}}static processVaryings(e,t,s){let i="";const n=s?"out":"in";return e.forEach((a,o)=>{const l=Cs.splitToWords(a),c=l[0],d=l[1];s?t.set(d,o):o=t.get(d),i+=`layout(location = ${o}) ${n} ${c} ${d};
`}),i}static processOuts(e){let t="";return e.forEach((s,i)=>{t+=`layout(location = ${i}) out ${s};
`}),t}static getTypeCount(e){const t=e.substring(e.length-1),s=parseInt(t,10);return isNaN(s)?1:s}static processAttributes(e,t,s){let i="";return e.forEach(n=>{const a=Cs.splitToWords(n);let o=a[0],l=a[1];if(t.hasOwnProperty(l)){const c=t[l],d=Le[c];let h;const u=s.getVertexElement(c);if(u){const f=u.dataType;if(f!==Me&&f!==Cy&&!u.normalize&&!u.asInt){const p=Cs.getTypeCount(o),_=`_private_${l}`;h=`vec${p} ${l} = vec${p}(${_});
`,l=_;const m=f===ao||f===oo||f===fd;p===1?o=m?"int":"uint":o=m?`ivec${p}`:`uvec${p}`}}i+=`layout(location = ${d}) in ${o} ${l};
`,h&&(i+=h)}}),i}static splitToWords(e){return e=e.replace(/\s+/g," ").trim(),e.split(" ")}static cutOut(e,t,s,i){return e.substring(0,t)+i+e.substring(s)}}class iP{constructor(e){this._vertexCode=null,this._fragmentCode=null,this._computeCode=null,this.vertexEntryPoint="main",this.fragmentEntryPoint="main",this.computeEntryPoint="main",this.shader=e;const t=e.definition;if(t.shaderLanguage===ud){var s,i,n;this._vertexCode=(s=t.vshader)!=null?s:null,this._fragmentCode=(i=t.fshader)!=null?i:null,this._computeCode=(n=t.cshader)!=null?n:null,this.meshUniformBufferFormat=t.meshUniformBufferFormat,this.meshBindGroupFormat=t.meshBindGroupFormat,this.vertexEntryPoint="vertexMain",this.fragmentEntryPoint="fragmentMain",e.ready=!0}else t.processingOptions&&this.process()}destroy(e){this._vertexCode=null,this._fragmentCode=null}createShaderModule(e,t){return this.shader.device.wgpu.createShaderModule({code:e})}getVertexShaderModule(){return this.createShaderModule(this._vertexCode,"Vertex")}getFragmentShaderModule(){return this.createShaderModule(this._fragmentCode,"Fragment")}getComputeShaderModule(){return this.createShaderModule(this._computeCode,"Compute")}process(){const e=this.shader,t=Cs.run(e.device,e.definition,e);this._vertexCode=this.transpile(t.vshader,"vertex",e.definition.vshader),this._fragmentCode=this.transpile(t.fshader,"fragment",e.definition.fshader),this._vertexCode&&this._fragmentCode?e.ready=!0:e.failed=!0,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat}transpile(e,t,s){try{const i=this.shader.device.glslang.compileGLSL(e,t);return this.shader.device.twgsl.convertSpirV2WGSL(i)}catch(i){console.error(`Failed to transpile webgl ${t} shader [${this.shader.label}] to WebGPU: [${i.message}] while rendering undefined`,{processed:e,original:s,shader:this.shader})}}get vertexCode(){return this._vertexCode}get fragmentCode(){return this._fragmentCode}loseContext(){}restoreContext(e,t){}}class Dn{static calcLevelDimension(e,t){return Math.max(e>>t,1)}static calcMipLevelsCount(e,t,s=1){return 1+Math.floor(Math.log2(Math.max(e,t,s)))}static calcLevelGpuSize(e,t,s,i){var n,a,o;const l=vc.get(i),c=(n=(a=vc.get(i))==null?void 0:a.size)!=null?n:0;if(c>0)return e*t*s*c;const d=(o=l.blockSize)!=null?o:0;let h=Math.floor((e+3)/4);const u=Math.floor((t+3)/4),f=Math.floor((s+3)/4);return(i===Zl||i===Jl)&&(h=Math.max(Math.floor(h/2),1)),h*u*f*d}static calcGpuSize(e,t,s,i,n,a){let o=0;for(;o+=Dn.calcLevelGpuSize(e,t,s,i),!(!n||e===1&&t===1&&s===1);)e=Math.max(e>>1,1),t=Math.max(t>>1,1),s=Math.max(s>>1,1);return o*(a?6:1)}}const wl=[];wl[Tt]="repeat";wl[ae]="clamp-to-edge";wl[ap]="mirror-repeat";const On=[];On[Ee]={level:"nearest",mip:"nearest"};On[nt]={level:"linear",mip:"nearest"};On[qc]={level:"nearest",mip:"nearest"};On[Kc]={level:"nearest",mip:"linear"};On[Yc]={level:"linear",mip:"nearest"};On[Or]={level:"linear",mip:"linear"};const nP=r=>{};class rP{constructor(e){this.gpuTexture=void 0,this.view=void 0,this.samplers=[],this.descr=void 0,this.format=void 0,this.texture=e,this.format=ue[e.format],this.create(e.device)}create(e){const t=this.texture,s=e.wgpu,i=t.requiredMipLevels;this.descr={size:{width:t.width,height:t.height,depthOrArrayLayers:t.cubemap?6:t.array?t.arrayLength:1},format:this.format,mipLevelCount:i,sampleCount:1,dimension:t.volume?"3d":"2d",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC|(W_(t.format)?0:GPUTextureUsage.RENDER_ATTACHMENT)|(t.storage?GPUTextureUsage.STORAGE_BINDING:0)},this.gpuTexture=s.createTexture(this.descr);let n;this.texture.format===Wa&&(n={format:"depth24plus",aspect:"depth-only"}),this.view=this.createView(n)}destroy(e){}propertyChanged(e){this.samplers.length=0}getView(e){return this.uploadImmediate(e,this.texture),this.view}createView(e){var t,s,i,n,a,o,l;const c=e??{},d=this.descr,h=this.texture,u=()=>h.cubemap?"cube":h.volume?"3d":h.array?"2d-array":"2d",f={format:(t=c.format)!=null?t:d.format,dimension:(s=c.dimension)!=null?s:u(),aspect:(i=c.aspect)!=null?i:"all",baseMipLevel:(n=c.baseMipLevel)!=null?n:0,mipLevelCount:(a=c.mipLevelCount)!=null?a:d.mipLevelCount,baseArrayLayer:(o=c.baseArrayLayer)!=null?o:0,arrayLayerCount:(l=c.arrayLayerCount)!=null?l:d.depthOrArrayLayers};return this.gpuTexture.createView(f)}getSampler(e,t){let s=this.samplers[t];if(!s){const i=this.texture,n={addressModeU:wl[i.addressU],addressModeV:wl[i.addressV],addressModeW:wl[i.addressW]};!t&&i.compareOnRead&&(t=Dl),t===Dl||t===cd||t===dd?(n.compare="less",n.magFilter="linear",n.minFilter="linear"):t===Fa||this.texture.format===rt||this.texture.format===Wa||this.texture.format===yt||$o(this.texture.format)?(n.magFilter="nearest",n.minFilter="nearest",n.mipmapFilter="nearest"):(n.magFilter=On[i.magFilter].level,n.minFilter=On[i.minFilter].level,n.mipmapFilter=On[i.minFilter].mip);const a=n.minFilter==="linear"&&n.magFilter==="linear"&&n.mipmapFilter==="linear";n.maxAnisotropy=a?H.clamp(Math.round(i._anisotropy),1,e.maxTextureAnisotropy):1,s=e.wgpu.createSampler(n),this.samplers[t]=s}return s}loseContext(){}uploadImmediate(e,t){(t._needsUpload||t._needsMipmapsUpload)&&(this.uploadData(e),t._needsUpload=!1,t._needsMipmapsUpload=!1)}uploadData(e){const t=this.texture;if(t._levels){let s=!1,i=!1;const n=t.requiredMipLevels;for(let a=0;a<n;a++){const o=t._levels[a];if(o){if(t.cubemap)for(let l=0;l<6;l++){const c=o[l];c?this.isExternalImage(c)?(this.uploadExternalImage(e,c,a,l),s=!0):ArrayBuffer.isView(c)&&(this.uploadTypedArrayData(e,c,a,l),s=!0):i=!0}else if(!t._volume)if(t.array)if(t.arrayLength===o.length)for(let l=0;l<t._arrayLength;l++){const c=o[l];this.isExternalImage(c)?(this.uploadExternalImage(e,c,a,l),s=!0):ArrayBuffer.isView(c)&&(this.uploadTypedArrayData(e,c,a,l),s=!0)}else i=!0;else this.isExternalImage(o)?(this.uploadExternalImage(e,o,a,0),s=!0):ArrayBuffer.isView(o)&&(this.uploadTypedArrayData(e,o,a,0),s=!0)}else i=!0}s&&i&&t.mipmaps&&!W_(t.format)&&e.mipmapRenderer.generate(this),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize)}}isExternalImage(e){return e instanceof ImageBitmap||e instanceof HTMLVideoElement||e instanceof HTMLCanvasElement||e instanceof OffscreenCanvas}uploadExternalImage(e,t,s,i){const n={source:t,origin:[0,0],flipY:!1},a={texture:this.gpuTexture,mipLevel:s,origin:[0,0,i],aspect:"all"},o={width:this.descr.size.width,height:this.descr.size.height,depthOrArrayLayers:1};e.submit(),nP(t instanceof HTMLCanvasElement&&t.getContext("2d")),e.wgpu.queue.copyExternalImageToTexture(n,a,o)}uploadTypedArrayData(e,t,s,i){const n=this.texture,a=e.wgpu,o={texture:this.gpuTexture,origin:[0,0,i],mipLevel:s},l=Dn.calcLevelDimension(n.width,s),c=Dn.calcLevelDimension(n.height,s);Dn.calcLevelGpuSize(l,c,1,n.format);const d=vc.get(n.format);let h,u;if(d.size)h={offset:0,bytesPerRow:d.size*l,rowsPerImage:c},u={width:l,height:c};else if(d.blockSize){const f=p=>Math.floor((p+3)/4);h={offset:0,bytesPerRow:d.blockSize*f(l),rowsPerImage:f(c)},u={width:Math.max(4,l),height:Math.max(4,c)}}e.submit(),a.queue.writeTexture(o,t,h,u)}}class aP extends Iy{constructor(e){super()}destroy(e){super.destroy(e)}unlock(e){const t=e.device;super.unlock(t,void 0,GPUBufferUsage.UNIFORM,e.storage)}}class oP extends Iy{constructor(e,t){super()}destroy(e){super.destroy(e)}unlock(e){const t=e.device;super.unlock(t,e.usage,GPUBufferUsage.VERTEX,e.storage)}}const tr=/[ \t]*#(ifn?def|if|endif|else|elif|define|undef|extension)/g,Pv=/define[ \t]+([^\n]+)\r?(?:\n|$)/g,Mv=/extension[ \t]+([\w-]+)[ \t]*:[ \t]*(enable|require)/g,Iv=/undef[ \t]+([^\n]+)\r?(?:\n|$)/g,Sm=/(ifdef|ifndef|if)[ \t]*([^\r\n]+)\r?\n/g,xm=/(endif|else|elif)([ \t]+[^\r\n]+)?\r?(?:\n|$)/g,Rv=/([\w-]+)/,lP=/(!|\s)?defined\(([\w-]+)\)/,hP=/[><=|&+-]/g;class Sr{static run(e,t=!1){e=e.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1"),e=e.split(/\r?\n/).map(n=>n.trimEnd()).join(`
`);const s=new Map;if(t){const n=new Map,a=/(pcFragColor[1-8])\b/g,o=e.match(a);o==null||o.forEach(l=>{var c;const d=parseInt(l.charAt(l.length-1),10);n.set(d,((c=n.get(d))!=null?c:0)+1)}),n.forEach((l,c)=>{l===1&&s.set(`REMOVE_COLOR_ATTACHMENT_${c}`,"")})}e=this._preprocess(e,s);const i=new Map;return s.forEach((n,a)=>{Number.isInteger(parseFloat(n))&&!n.includes(".")&&i.set(a,n)}),e=this.RemoveEmptyLines(e),e=this.processArraySize(e,i),e}static processArraySize(e,t){return e!==null&&t.forEach((s,i)=>{e=e.replace(new RegExp(`\\[${i}\\]`,"g"),`[${s}]`)}),e}static RemoveEmptyLines(e){return e!==null&&(e=e.split(/\r?\n/).map(t=>t.trim()===""?"":t).join(`
`),e=e.replace(/(\n\n){3,}/gm,`

`)),e}static _preprocess(e,t=new Map){const s=e,i=[];let n=!1,a;for(;(a=tr.exec(e))!==null;){const o=a[1];switch(o){case"define":{Pv.lastIndex=a.index;const l=Pv.exec(e);n||(n=l===null);const c=l[1];Rv.lastIndex=l.index;const h=Rv.exec(c)[1];let u=c.substring(h.length).trim();u===""&&(u="true"),Sr._keep(i)&&t.set(h,u),tr.lastIndex=l.index+l[0].length;break}case"undef":{Iv.lastIndex=a.index;const l=Iv.exec(e),c=l[1].trim();Sr._keep(i)&&t.delete(c),tr.lastIndex=l.index+l[0].length;break}case"extension":{Mv.lastIndex=a.index;const l=Mv.exec(e);if(n||(n=l===null),l){const c=l[1];Sr._keep(i)&&t.set(c,"true")}tr.lastIndex=l.index+l[0].length;break}case"ifdef":case"ifndef":case"if":{Sm.lastIndex=a.index;const l=Sm.exec(e),c=l[2],d=Sr.evaluate(c,t);n||(n=d.error);let h=d.result;o==="ifndef"&&(h=!h),i.push({anyKeep:h,keep:h,start:a.index,end:Sm.lastIndex}),tr.lastIndex=l.index+l[0].length;break}case"endif":case"else":case"elif":{xm.lastIndex=a.index;const l=xm.exec(e),c=i.pop(),d=c.keep?e.substring(c.end,a.index):"";e=e.substring(0,c.start)+d+e.substring(xm.lastIndex),tr.lastIndex=c.start+d.length;const h=l[1];if(h==="else"||h==="elif"){let u=!1;if(!c.anyKeep)if(h==="else")u=!c.keep;else{const f=Sr.evaluate(l[2],t);u=f.result,n||(n=f.error)}i.push({anyKeep:c.anyKeep||u,keep:u,start:tr.lastIndex,end:tr.lastIndex})}break}}}return n?(console.warn("Failed to preprocess shader: ",{source:s}),s):e}static _keep(e){for(let t=0;t<e.length;t++)if(!e[t].keep)return!1;return!0}static evaluate(e,t){const s=hP.exec(e)===null;let i=!1;const n=lP.exec(e);n&&(i=n[1]==="!",e=n[2]),e=e.trim();let a=t.has(e);return i&&(a=!a),{result:a,error:!s}}}let cP=0;class Nn{constructor(e,t){if(this.meshUniformBufferFormat=void 0,this.meshBindGroupFormat=void 0,this.id=cP++,this.device=e,this.definition=t,this.name=t.name||"Untitled",this.init(),!t.cshader){t.vshader=Sr.run(t.vshader);const s=e.isWebGL2&&(Te.name==="osx"||Te.name==="ios");t.fshader=Sr.run(t.fshader,s)}this.impl=e.createShaderImpl(this)}init(){this.ready=!1,this.failed=!1}get label(){return`Shader Id ${this.id} ${this.name}`}destroy(){this.device.onDestroyShader(this),this.impl.destroy(this)}loseContext(){this.init(),this.impl.loseContext()}restoreContext(){this.impl.restoreContext(this.device,this)}}let dP=0;class gd{constructor(e,t,s){this.renderVersionUpdated=-1,this.uniformBuffers=void 0,this.uniformBufferOffsets=[],this.id=dP++,this.device=e,this.format=t,this.dirty=!0,this.impl=e.createBindGroupImpl(this),this.textures=[],this.storageTextures=[],this.uniformBuffers=[],this.defaultUniformBuffer=s,s&&this.setUniformBuffer(pd,s)}destroy(){this.impl.destroy(),this.impl=null,this.format=null,this.defaultUniformBuffer=null}setUniformBuffer(e,t){const s=this.format.bufferFormatsMap.get(e);this.uniformBuffers[s]!==t&&(this.uniformBuffers[s]=t,this.dirty=!0)}setTexture(e,t){const s=this.format.textureFormatsMap.get(e);this.textures[s]!==t?(this.textures[s]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}setStorageTexture(e,t){const s=this.format.storageTextureFormatsMap.get(e);this.storageTextures[s]!==t?(this.storageTextures[s]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}update(){const{textureFormats:e,storageTextureFormats:t}=this.format;for(let s=0;s<e.length;s++){const i=e[s],n=i.scopeId.value;this.setTexture(i.name,n)}for(let s=0;s<t.length;s++){const i=t[s],n=i.scopeId.value;this.setStorageTexture(i.name,n)}this.uniformBufferOffsets.length=this.uniformBuffers.length;for(let s=0;s<this.uniformBuffers.length;s++){const i=this.uniformBuffers[s];this.uniformBufferOffsets[s]=i.offset,this.renderVersionUpdated<i.renderVersionDirty&&(this.dirty=!0)}this.dirty&&(this.dirty=!1,this.renderVersionUpdated=this.device.renderVersion,this.impl.update(this))}}class uP{constructor(e){this.device=void 0,this.device=e}}class fP{constructor(){this.gpuBuffer=void 0,this.stagingBuffer=void 0,this.offset=void 0,this.size=void 0}}class pP{constructor(){this.storage=void 0,this.gpuBuffer=void 0,this.offset=void 0}}class mP{constructor(e,t,s){this.bufferSize=void 0,this.gpuBuffers=[],this.stagingBuffers=[],this.usedBuffers=[],this.activeBuffer=null,this.device=e,this.bufferSize=t,this.bufferAlignment=s}destroy(){this.gpuBuffers.forEach(e=>{e.destroy(this.device)}),this.gpuBuffers=null,this.stagingBuffers.forEach(e=>{e.destroy(this.device)}),this.stagingBuffers=null,this.usedBuffers=null,this.activeBuffer=null}alloc(e,t){if(this.activeBuffer){const n=H.roundUp(this.activeBuffer.size,this.bufferAlignment);this.bufferSize-n<t&&this.scheduleSubmit()}if(!this.activeBuffer){let n=this.gpuBuffers.pop();n||(n=this.createBuffer(this.device,this.bufferSize,!1));let a=this.stagingBuffers.pop();a||(a=this.createBuffer(this.device,this.bufferSize,!0)),this.activeBuffer=new fP,this.activeBuffer.stagingBuffer=a,this.activeBuffer.gpuBuffer=n,this.activeBuffer.offset=0,this.activeBuffer.size=0}const s=this.activeBuffer,i=H.roundUp(s.size,this.bufferAlignment);e.gpuBuffer=s.gpuBuffer,e.offset=i,e.storage=s.stagingBuffer.alloc(i,t),s.size=i+t}scheduleSubmit(){this.activeBuffer&&(this.usedBuffers.push(this.activeBuffer),this.activeBuffer=null)}submit(){this.scheduleSubmit()}}const Ue=[];Ue[bi]=function(r,e,t){const s=r.storageFloat32;s[t]=e};Ue[kr]=(r,e,t)=>{const s=r.storageFloat32;s[t]=e[0],s[t+1]=e[1]};Ue[Rs]=(r,e,t)=>{const s=r.storageFloat32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2]};Ue[Xa]=(r,e,t)=>{const s=r.storageFloat32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2],s[t+3]=e[3]};Ue[$a]=function(r,e,t){const s=r.storageInt32;s[t]=e};Ue[ka]=function(r,e,t){const s=r.storageInt32;s[t]=e[0],s[t+1]=e[1]};Ue[Ba]=function(r,e,t){const s=r.storageInt32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2]};Ue[Na]=function(r,e,t){const s=r.storageInt32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2],s[t+3]=e[3]};Ue[nf]=(r,e,t)=>{const s=r.storageFloat32;s[t]=e[0],s[t+1]=e[1],s[t+4]=e[2],s[t+5]=e[3],s[t+8]=e[4],s[t+9]=e[5]};Ue[bc]=(r,e,t)=>{const s=r.storageFloat32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2],s[t+4]=e[3],s[t+5]=e[4],s[t+6]=e[5],s[t+8]=e[6],s[t+9]=e[7],s[t+10]=e[8]};Ue[Dp]=function(r,e,t,s){const i=r.storageFloat32;for(let n=0;n<s;n++)i[t+n*4]=e[n]};Ue[Op]=(r,e,t,s)=>{const i=r.storageFloat32;for(let n=0;n<s;n++)i[t+n*4]=e[n*2],i[t+n*4+1]=e[n*2+1]};Ue[Fp]=(r,e,t,s)=>{const i=r.storageFloat32;for(let n=0;n<s;n++)i[t+n*4]=e[n*3],i[t+n*4+1]=e[n*3+1],i[t+n*4+2]=e[n*3+2]};Ue[Fl]=(r,e,t,s)=>{const i=r.storageUint32;i[t]=e};Ue[kl]=(r,e,t,s)=>{const i=r.storageUint32;i[t]=e[0],i[t+1]=e[1]};Ue[Bl]=(r,e,t,s)=>{const i=r.storageUint32;i[t]=e[0],i[t+1]=e[1],i[t+2]=e[2]};Ue[Nl]=(r,e,t,s)=>{const i=r.storageUint32;i[t]=e[0],i[t+1]=e[1],i[t+2]=e[2],i[t+3]=e[3]};Ue[Ul]=function(r,e,t,s){const i=r.storageInt32;for(let n=0;n<s;n++)i[t+n*4]=e[n]};Ue[Bp]=Ue[Ul];Ue[kp]=function(r,e,t,s){const i=r.storageUint32;for(let n=0;n<s;n++)i[t+n*4]=e[n]};Ue[zl]=(r,e,t,s)=>{const i=r.storageInt32;for(let n=0;n<s;n++)i[t+n*4]=e[n*2],i[t+n*4+1]=e[n*2+1]};Ue[Up]=Ue[zl];Ue[Np]=(r,e,t,s)=>{const i=r.storageUint32;for(let n=0;n<s;n++)i[t+n*4]=e[n*2],i[t+n*4+1]=e[n*2+1]};Ue[Vl]=(r,e,t,s)=>{const i=r.storageInt32;for(let n=0;n<s;n++)i[t+n*4]=e[n*3],i[t+n*4+1]=e[n*3+1],i[t+n*4+2]=e[n*3+2]};Ue[Vp]=Ue[Vl];Ue[zp]=(r,e,t,s)=>{const i=r.storageUint32;for(let n=0;n<s;n++)i[t+n*4]=e[n*3],i[t+n*4+1]=e[n*3+1],i[t+n*4+2]=e[n*3+2]};class $p{constructor(e,t,s=!0){if(this.device=void 0,this.persistent=void 0,this.allocation=void 0,this.storageFloat32=void 0,this.storageInt32=void 0,this.storageUint32=void 0,this.renderVersionDirty=0,this.device=e,this.format=t,this.persistent=s,s){this.impl=e.createUniformBufferImpl(this);const i=new ArrayBuffer(t.byteSize);this.assignStorage(new Int32Array(i)),e._vram.ub+=this.format.byteSize}else this.allocation=new pP}destroy(){if(this.persistent){const e=this.device;this.impl.destroy(e),e._vram.ub-=this.format.byteSize}}get offset(){return this.persistent?0:this.allocation.offset}assignStorage(e){this.storageInt32=e,this.storageUint32=new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4),this.storageFloat32=new Float32Array(e.buffer,e.byteOffset,e.byteLength/4)}loseContext(){var e;(e=this.impl)==null||e.loseContext()}setUniform(e){const t=e.offset,s=e.scopeId.value;if(s!=null){const i=Ue[e.updateType];i?i(this,s,t,e.count):this.storageFloat32.set(s,t)}}set(e){const t=this.format.map.get(e);t&&this.setUniform(t)}update(){const e=this.persistent;if(!e){const s=this.allocation,i=s.gpuBuffer;this.device.dynamicBuffers.alloc(s,this.format.byteSize),this.assignStorage(s.storage),i!==s.gpuBuffer&&(this.renderVersionDirty=this.device.renderVersion)}const t=this.format.uniforms;for(let s=0;s<t.length;s++)this.setUniform(t[s]);e?this.impl.unlock(this):(this.storageFloat32=null,this.storageInt32=null)}}const _P={type:Ji,base:0,count:4,indexed:!1};class gP{constructor(e){const t=`

						struct ub_mesh {
								color : vec4f,
								depth: f32
						}

						@group(0) @binding(0) var<uniform> ubMesh : ub_mesh;

						var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
								vec2(-1.0, 1.0), vec2(1.0, 1.0),
								vec2(-1.0, -1.0), vec2(1.0, -1.0)
						);

						struct VertexOutput {
								@builtin(position) position : vec4f
						}

						@vertex
						fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
								var output : VertexOutput;
								output.position = vec4(pos[vertexIndex], ubMesh.depth, 1.0);
								return output;
						}

						@fragment
						fn fragmentMain() -> @location(0) vec4f {
								return ubMesh.color;
						}
				`;this.shader=new Nn(e,{name:"WebGPUClearRendererShader",shaderLanguage:ud,vshader:t,fshader:t}),this.uniformBuffer=new $p(e,new Hp(e,[new vt("color",Xa),new vt("depth",bi)]),!1);const s=new jp(e,[new Wp(pd,Gl|Ms)]);this.bindGroup=new gd(e,s,this.uniformBuffer),this.colorData=new Float32Array(4),this.colorId=e.scope.resolve("color"),this.depthId=e.scope.resolve("depth")}destroy(){this.shader.destroy(),this.shader=null,this.uniformBuffer.destroy(),this.uniformBuffer=null,this.bindGroup.destroy(),this.bindGroup=null}clear(e,t,s,i){var n;s=s||i;const a=(n=s.flags)!=null?n:i.flags;if(a!==0){if(a&Ml&&t.colorBuffer){var o;const d=(o=s.color)!=null?o:i.color;this.colorData.set(d),e.setBlendState(Xe.NOBLEND)}else e.setBlendState(Xe.NOWRITE);if(this.colorId.setValue(this.colorData),a&Il&&t.depth){var l;const d=(l=s.depth)!=null?l:i.depth;this.depthId.setValue(d),e.setDepthState(kt.WRITEDEPTH)}else this.depthId.setValue(1),e.setDepthState(kt.NODEPTH);a&yc&&t.stencil,e.setCullMode(Et),e.setShader(this.shader);const c=this.bindGroup;c.defaultUniformBuffer.update(),c.update(),e.setBindGroup(Tc,c),e.draw(_P)}}}class yP{constructor(e){this.device=void 0,this.device=e;const t=`
 
						var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
								vec2(-1.0, 1.0), vec2(1.0, 1.0),
								vec2(-1.0, -1.0), vec2(1.0, -1.0)
						);

						struct VertexOutput {
								@builtin(position) position : vec4f,
								@location(0) texCoord : vec2f
						};

						@vertex
						fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
							var output : VertexOutput;
							output.texCoord = pos[vertexIndex] * vec2f(0.5, -0.5) + vec2f(0.5);
							output.position = vec4f(pos[vertexIndex], 0, 1);
							return output;
						}

						@group(0) @binding(0) var imgSampler : sampler;
						@group(0) @binding(1) var img : texture_2d<f32>;

						@fragment
						fn fragmentMain(@location(0) texCoord : vec2f) -> @location(0) vec4f {
							return textureSample(img, imgSampler, texCoord);
						}
				`;this.shader=new Nn(e,{name:"WebGPUMipmapRendererShader",shaderLanguage:ud,vshader:t,fshader:t}),this.minSampler=e.wgpu.createSampler({minFilter:"linear"})}destroy(){this.shader.destroy(),this.shader=null}generate(e){var t;const s=e.descr;if(s.mipLevelCount<=1||e.texture.volume)return;const i=this.device,n=i.wgpu,a=this.shader.impl,o=n.createRenderPipeline({layout:"auto",vertex:{module:a.getVertexShaderModule(),entryPoint:a.vertexEntryPoint},fragment:{module:a.getFragmentShaderModule(),entryPoint:a.fragmentEntryPoint,targets:[{format:s.format}]},primitive:{topology:"triangle-strip"}}),l=e.texture,c=l.cubemap?6:l.array?l.arrayLength:1,d=[];for(let u=0;u<c;u++)d.push(e.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:u}));const h=(t=i.commandEncoder)!=null?t:n.createCommandEncoder();for(let u=1;u<s.mipLevelCount;u++)for(let f=0;f<c;f++){const p=e.createView({dimension:"2d",baseMipLevel:u,mipLevelCount:1,baseArrayLayer:f}),_=h.beginRenderPass({colorAttachments:[{view:p,loadOp:"clear",storeOp:"store"}]}),m=n.createBindGroup({layout:o.getBindGroupLayout(0),entries:[{binding:0,resource:this.minSampler},{binding:1,resource:d[f]}]});_.setPipeline(o),_.setBindGroup(0,m),_.draw(4),_.end(),d[f]=p}if(!i.commandEncoder){const u=h.finish();i.addCommandBuffer(u)}i.pipeline=null}}class vP extends uP{constructor(e,t,s){super(e),this.buffer=null,this.mappedRange=null,this.buffer=e.wgpu.createBuffer({size:t,usage:s?GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:s}),s&&this.onAvailable(),e._vram.ub+=t}destroy(e){e._vram.ub-=this.buffer.size,this.buffer.destroy(),this.buffer=null}onAvailable(){this.mappedRange=this.buffer.getMappedRange()}alloc(e,t){return new Int32Array(this.mappedRange,e,t/4)}}class SP extends mP{constructor(...e){super(...e),this.pendingStagingBuffers=[]}createBuffer(e,t,s){return new vP(e,t,s)}submit(){super.submit();const e=this.usedBuffers.length;if(e){const t=this.device,s=this.gpuBuffers,i=t.wgpu.createCommandEncoder();for(let a=e-1;a>=0;a--){const o=this.usedBuffers[a],{stagingBuffer:l,gpuBuffer:c,offset:d,size:h}=o,u=l.buffer;u.unmap(),i.copyBufferToBuffer(u,d,c.buffer,d,h),s.push(c)}const n=i.finish();t.addCommandBuffer(n,!0);for(let a=0;a<e;a++){const o=this.usedBuffers[a].stagingBuffer;this.pendingStagingBuffers.push(o)}this.usedBuffers.length=0}}onCommandBuffersSubmitted(){const e=this.pendingStagingBuffers.length;if(e){for(let t=0;t<e;t++){const s=this.pendingStagingBuffers[t];s.buffer.mapAsync(GPUMapMode.WRITE).then(()=>{this.stagingBuffers&&(s.onAvailable(),this.stagingBuffers.push(s))})}this.pendingStagingBuffers.length=0}}}class fb{constructor(){this.frameAllocations=[],this.pastFrameAllocations=new Map,this._enabled=!1,this._enableRequest=!1,this._frameTime=0}loseContext(){this.pastFrameAllocations.clear()}set enabled(e){this._enableRequest=e}get enabled(){return this._enableRequest}processEnableRequest(){this._enableRequest!==this._enabled&&(this._enabled=this._enableRequest,this._enabled||(this._frameTime=0))}request(e){this.pastFrameAllocations.set(e,this.frameAllocations),this.frameAllocations=[]}report(e,t){if(t){const s=this.pastFrameAllocations.get(e);if(t.length>0&&(this._frameTime=t[0]),$c.get(nA))for(let i=0;i<s.length;++i)s[i]}this.pastFrameAllocations.delete(e)}getSlot(e){const t=this.frameAllocations.length;return this.frameAllocations.push(e),t}get slotCount(){return this.frameAllocations.length}}class xP{constructor(e,t,s){this.querySet=void 0,this.stagingBuffers=[],this.activeStagingBuffer=null,this.bytesPerSlot=void 0,this.device=e,this.capacity=s,this.bytesPerSlot=t?8:4;const i=e.wgpu;this.querySet=i.createQuerySet({type:t?"timestamp":"occlusion",count:s}),this.queryBuffer=i.createBuffer({size:this.bytesPerSlot*s,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST})}destroy(){var e,t;(e=this.querySet)==null||e.destroy(),this.querySet=null,(t=this.queryBuffer)==null||t.destroy(),this.queryBuffer=null,this.activeStagingBuffer=null,this.stagingBuffers.forEach(s=>{s.destroy()}),this.stagingBuffers=null}getStagingBuffer(){let e=this.stagingBuffers.pop();return e||(e=this.device.wgpu.createBuffer({size:this.queryBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),e}resolve(e){const t=this.device,s=t.wgpu.createCommandEncoder();s.resolveQuerySet(this.querySet,0,e,this.queryBuffer,0);const i=this.getStagingBuffer();this.activeStagingBuffer=i,s.copyBufferToBuffer(this.queryBuffer,0,i,0,this.bytesPerSlot*e);const n=s.finish();t.addCommandBuffer(n)}request(e,t){const s=this.activeStagingBuffer;return this.activeStagingBuffer=null,s.mapAsync(GPUMapMode.READ).then(()=>{var i;const n=new BigInt64Array(s.getMappedRange()),a=[];for(let o=0;o<e;o++)a.push(Number(n[o*2+1]-n[o*2])*1e-6);return s.unmap(),(i=this.stagingBuffers)==null||i.push(s),{renderVersion:t,timings:a}})}}class wP extends fb{constructor(e){super(),this.device=void 0,this.frameGPUMarkerSlot=void 0,this.device=e,this.timestampQueriesSet=e.supportsTimestampQuery?new xP(e,!0,512):null}destroy(){var e;(e=this.timestampQueriesSet)==null||e.destroy(),this.timestampQueriesSet=null}frameStart(){this.processEnableRequest()}frameEnd(){if(this._enabled){var e;(e=this.timestampQueriesSet)==null||e.resolve(this.slotCount*2)}}request(){if(this._enabled){var e;const t=this.device.renderVersion;(e=this.timestampQueriesSet)==null||e.request(this.slotCount,t).then(s=>{this.report(s.renderVersion,s.timings)}),super.request(t)}}}class bP{constructor(e){this.device=void 0,this.pipelineCache=new Map,this.device=e;const t=`
 
						var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
								vec2(-1.0, 1.0), vec2(1.0, 1.0), vec2(-1.0, -1.0), vec2(1.0, -1.0)
						);

						struct VertexOutput {
								@builtin(position) position : vec4f,
						};

						@vertex
						fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
							var output : VertexOutput;
							output.position = vec4f(pos[vertexIndex], 0, 1);
							return output;
						}

						@group(0) @binding(0) var img : texture_depth_multisampled_2d;

						@fragment
						fn fragmentMain(@builtin(position) fragColor: vec4f) -> @location(0) vec4f {
								// load th depth value from sample index 0
								var depth = textureLoad(img, vec2i(fragColor.xy), 0u);
								return vec4<f32>(depth, 0.0, 0.0, 0.0);
						}
				`;this.shader=new Nn(e,{name:"WebGPUResolverDepthShader",shaderLanguage:ud,vshader:t,fshader:t})}destroy(){this.shader.destroy(),this.shader=null,this.pipelineCache=null}getPipeline(e){let t=this.pipelineCache.get(e);return t||(t=this.createPipeline(e),this.pipelineCache.set(e,t)),t}createPipeline(e){const t=this.shader.impl;return this.device.wgpu.createRenderPipeline({layout:"auto",vertex:{module:t.getVertexShaderModule(),entryPoint:t.vertexEntryPoint},fragment:{module:t.getFragmentShaderModule(),entryPoint:t.fragmentEntryPoint,targets:[{format:e}]},primitive:{topology:"triangle-strip"}})}resolveDepth(e,t,s){const i=this.device,n=i.wgpu,a=this.getPipeline(s.format),o=t.depthOrArrayLayers;for(let l=0;l<o;l++){const c=t.createView({dimension:"2d",aspect:"depth-only",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:l}),d=s.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:l}),h=e.beginRenderPass({colorAttachments:[{view:d,loadOp:"clear",storeOp:"store"}]}),u=n.createBindGroup({layout:a.getBindGroupLayout(0),entries:[{binding:0,resource:c}]});h.setPipeline(a),h.setBindGroup(0,u),h.draw(4),h.end()}i.pipeline=null}}class TP{constructor(e){this.compute=e;const{device:t,shader:s}=e,{computeBindGroupFormat:i}=s.impl;this.bindGroup=new gd(t,i),this.pipeline=t.computePipeline.get(s,i)}dispatch(e,t,s){const i=this.compute.device;i.startComputePass();const{bindGroup:n}=this;n.update(),i.setBindGroup(0,n);const a=i.passEncoder;a.setPipeline(this.pipeline),a.dispatchWorkgroups(e,t,s),i.endComputePass()}}class EP extends ct{constructor(e,t={}){var s,i;super(e,t),this.renderPipeline=new j1(this),this.computePipeline=new $1(this),this.clearRenderer=void 0,this.mipmapRenderer=void 0,this.pipeline=void 0,this.bindGroupFormats=[],this.commandEncoder=null,this.commandBuffers=[],this.limits=void 0,t=this.initOptions,t.alpha=(s=t.alpha)!=null?s:!0,this.backBufferAntialias=(i=t.antialias)!=null?i:!1,this.isWebGPU=!0,this._deviceType=lb}destroy(){this.clearRenderer.destroy(),this.clearRenderer=null,this.mipmapRenderer.destroy(),this.mipmapRenderer=null,this.resolver.destroy(),this.resolver=null,super.destroy()}initDeviceCaps(){this.disableParticleSystem=!0;const e=this.gpuAdapter.limits;this.limits=e,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=e.maxTextureDimension2D,this.maxCubeMapSize=e.maxTextureDimension2D,this.maxVolumeSize=e.maxTextureDimension3D,this.maxColorAttachments=e.maxColorAttachments,this.maxPixelRatio=1,this.maxAnisotropy=16,this.fragmentUniformsCount=e.maxUniformBufferBindingSize/16,this.vertexUniformsCount=e.maxUniformBufferBindingSize/16,this.supportsInstancing=!0,this.supportsUniformBuffers=!0,this.supportsVolumeTextures=!0,this.supportsBoneTextures=!0,this.supportsMorphTargetTexturesCore=!0,this.supportsAreaLights=!0,this.supportsDepthShadow=!0,this.supportsGpuParticles=!1,this.supportsMrt=!0,this.supportsCompute=!0,this.extUintElement=!0,this.extTextureFloat=!0,this.textureFloatRenderable=!0,this.textureHalfFloatFilterable=!0,this.extTextureHalfFloat=!0,this.textureHalfFloatRenderable=!0,this.textureHalfFloatUpdatable=!0,this.boneLimit=1024,this.supportsImageBitmap=!0,this.extStandardDerivatives=!0,this.extBlendMinmax=!0,this.areaLightLutFormat=this.textureFloatFilterable?rt:xe,this.supportsTextureFetch=!0,this.samples=this.backBufferAntialias?4:1}async initWebGpu(e,t){if(!window.navigator.gpu)throw new Error("Unable to retrieve GPU. Ensure you are using a browser that supports WebGPU rendering.");const s=d=>{if(!me.isRelativePath(d))return d;const h=new URL(window.location.href);return h.pathname=d,h.search="",h.toString()},i=await Promise.all([B_(()=>import(`${s(t)}`),__vite__mapDeps([]),import.meta.url).then(d=>twgsl(t.replace(".js",".wasm"))),B_(()=>import(`${s(e)}`),__vite__mapDeps([]),import.meta.url).then(d=>d.default())]);this.twgsl=i[0],this.glslang=i[1];const n={powerPreference:this.initOptions.powerPreference!=="default"?this.initOptions.powerPreference:void 0};this.gpuAdapter=await window.navigator.gpu.requestAdapter(n);const a=[],o=d=>{const h=this.gpuAdapter.features.has(d);return h&&a.push(d),h};this.textureFloatFilterable=o("float32-filterable"),this.extCompressedTextureS3TC=o("texture-compression-bc"),this.extCompressedTextureETC=o("texture-compression-etc2"),this.extCompressedTextureASTC=o("texture-compression-astc"),this.supportsTimestampQuery=o("timestamp-query"),this.textureRG11B10Renderable=o("rg11b10ufloat-renderable");const l={requiredFeatures:a,requiredLimits:{},defaultQueue:{label:"Default Queue"}};this.wgpu=await this.gpuAdapter.requestDevice(l),this.initDeviceCaps(),this.gpuContext=this.canvas.getContext("webgpu");const c=navigator.gpu.getPreferredCanvasFormat();return this.backBufferFormat=c==="rgba8unorm"?xe:xy,this.canvasConfig={device:this.wgpu,colorSpace:"srgb",alphaMode:this.initOptions.alpha?"premultiplied":"opaque",format:c,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST,viewFormats:[]},this.gpuContext.configure(this.canvasConfig),this.createBackbuffer(),this.clearRenderer=new gP(this),this.mipmapRenderer=new yP(this),this.resolver=new bP(this),this.postInit(),this}postInit(){super.postInit(),this.initializeRenderState(),this.setupPassEncoderDefaults(),this.gpuProfiler=new wP(this),this.dynamicBuffers=new SP(this,1024*1024,this.limits.minUniformBufferOffsetAlignment)}createBackbuffer(){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new Ct({name:"WebgpuFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples})}frameStart(){super.frameStart(),this.gpuProfiler.frameStart(),this.submit();const e=this.gpuContext.getCurrentTexture();(this.backBufferSize.x!==e.width||this.backBufferSize.y!==e.height)&&(this.backBufferSize.set(e.width,e.height),this.backBuffer.destroy(),this.backBuffer=null,this.createBackbuffer());const t=this.backBuffer,s=t.impl;s.setColorAttachment(0,void 0,e.format),this.initRenderTarget(t),s.assignColorTexture(e)}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.submit(),this.gpuProfiler.request()}createUniformBufferImpl(e){return new aP(e)}createVertexBufferImpl(e,t){return new oP(e,t)}createIndexBufferImpl(e){return new U1(e)}createShaderImpl(e){return new iP(e)}createTextureImpl(e){return new rP(e)}createRenderTargetImpl(e){return new K1(e)}createBindGroupFormatImpl(e){return new N1(e)}createBindGroupImpl(e){return new k1}createComputeImpl(e){return new TP(e)}setBindGroup(e,t){this.passEncoder&&(this.passEncoder.setBindGroup(e,t.impl.bindGroup,t.uniformBufferOffsets),this.bindGroupFormats[e]=t.format.impl)}submitVertexBuffer(e,t){const s=e.format.elements,i=s.length,n=e.impl.buffer;for(let a=0;a<i;a++)this.passEncoder.setVertexBuffer(t+a,n,s[a].offset);return i}draw(e,t=1,s){if(this.shader.ready&&!this.shader.failed){const i=this.passEncoder,n=this.vertexBuffers[0],a=this.vertexBuffers[1];if(this.vertexBuffers.length=0,n){const c=this.submitVertexBuffer(n,0);a&&this.submitVertexBuffer(a,c)}const o=this.renderPipeline.get(e,n==null?void 0:n.format,a==null?void 0:a.format,this.shader,this.renderTarget,this.bindGroupFormats,this.blendState,this.depthState,this.cullMode,this.stencilEnabled,this.stencilFront,this.stencilBack);this.pipeline!==o&&(this.pipeline=o,i.setPipeline(o));const l=this.indexBuffer;l?(this.indexBuffer=null,i.setIndexBuffer(l.impl.buffer,l.impl.format),i.drawIndexed(e.count,t,e.base,0,0)):i.draw(e.count,t,e.base,0)}}setShader(e,t=!1){e!==this.shader&&(this.shader=e)}setBlendState(e){this.blendState.copy(e)}setDepthState(e){this.depthState.copy(e)}setStencilState(e,t){if(e||t){this.stencilEnabled=!0,this.stencilFront.copy(e??oi.DEFAULT),this.stencilBack.copy(t??oi.DEFAULT);const s=this.stencilFront.ref;this.stencilRef!==s&&(this.stencilRef=s,this.passEncoder.setStencilReference(s))}else this.stencilEnabled=!1}setBlendColor(e,t,s,i){const n=this.blendColor;(e!==n.r||t!==n.g||s!==n.b||i!==n.a)&&(n.set(e,t,s,i),this.passEncoder.setBlendConstant(n))}setCullMode(e){this.cullMode=e}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches()}setupPassEncoderDefaults(){this.pipeline=null,this.stencilRef=0,this.blendColor.set(0,0,0,0)}_uploadDirtyTextures(){this.textures.forEach(e=>{(e._needsUpload||e._needsMipmaps)&&e.upload()})}startRenderPass(e){this._uploadDirtyTextures();const t=e.renderTarget||this.backBuffer;this.renderTarget=t;const s=t.impl;this.commandEncoder=this.wgpu.createCommandEncoder(),t!==this.backBuffer&&this.initRenderTarget(t),s.setupForRenderPass(e);const i=s.renderPassDescriptor;if(this.gpuProfiler._enabled&&this.gpuProfiler.timestampQueriesSet){const o=this.gpuProfiler.getSlot(e.name);i.timestampWrites={querySet:this.gpuProfiler.timestampQueriesSet.querySet,beginningOfPassWriteIndex:o*2,endOfPassWriteIndex:o*2+1}}this.passEncoder=this.commandEncoder.beginRenderPass(i),this.setupPassEncoderDefaults();const{width:n,height:a}=t;this.setViewport(0,0,n,a),this.setScissor(0,0,n,a),this.insideRenderPass=!0}endRenderPass(e){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0;for(let s=0;s<e.colorArrayOps.length;s++)e.colorArrayOps[s].mipmaps&&this.mipmapRenderer.generate(e.renderTarget._colorBuffers[s].impl);const t=this.commandEncoder.finish();this.addCommandBuffer(t),this.commandEncoder=null}startComputePass(){this.commandEncoder=this.wgpu.createCommandEncoder(),this.pipeline=null,this.passEncoder=this.commandEncoder.beginComputePass(),this.insideRenderPass=!0}endComputePass(){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0;const e=this.commandEncoder.finish();this.addCommandBuffer(e),this.commandEncoder=null}addCommandBuffer(e,t=!1){t?this.commandBuffers.unshift(e):this.commandBuffers.push(e)}submit(){this.commandBuffers.length>0&&(this.dynamicBuffers.submit(),this.wgpu.queue.submit(this.commandBuffers),this.commandBuffers.length=0,this.dynamicBuffers.onCommandBuffersSubmitted())}clear(e){e.flags&&this.clearRenderer.clear(this,this.renderTarget,e,this.defaultClearOptions)}setViewport(e,t,s,i){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-i),this.vx=e,this.vy=t,this.vw=s,this.vh=i,this.passEncoder.setViewport(e,t,s,i,0,1))}setScissor(e,t,s,i){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-i),this.sx=e,this.sy=t,this.sw=s,this.sh=i,this.passEncoder.setScissorRect(e,t,s,i))}copyRenderTarget(e,t,s,i){var n;const a={width:e?e.width:t.width,height:e?e.height:t.height,depthOrArrayLayers:1},o=(n=this.commandEncoder)!=null?n:this.wgpu.createCommandEncoder();if(s){const l={texture:e?e.colorBuffer.impl.gpuTexture:this.renderTarget.impl.assignedColorTexture,mipLevel:0},c={texture:t?t.colorBuffer.impl.gpuTexture:this.renderTarget.impl.assignedColorTexture,mipLevel:0};o.copyTextureToTexture(l,c,a)}if(i){const c=(e||this.renderTarget).impl.depthTexture;if(e.samples>1){const d=t.colorBuffer.impl.gpuTexture;this.resolver.resolveDepth(o,c,d)}else{const d=t?t.depthBuffer.impl.gpuTexture:this.renderTarget.impl.depthTexture,h={texture:c,mipLevel:0},u={texture:d,mipLevel:0};o.copyTextureToTexture(h,u,a)}}if(!this.commandEncoder){const l=o.finish();this.addCommandBuffer(l)}return!0}}let CP=0;class _e{constructor(e,t={}){var s,i,n,a,o,l,c,d,h,u,f,p,_,m,g,v,x,S,w;if(this.name=void 0,this._gpuSize=0,this.id=CP++,this._invalid=!1,this._lockedLevel=-1,this._lockedMode=_m,this.renderVersionDirty=0,this._storage=!1,this.device=e,this.name=(s=t.name)!=null?s:"",this._width=Math.floor((i=t.width)!=null?i:4),this._height=Math.floor((n=t.height)!=null?n:4),this._format=(a=t.format)!=null?a:xe,this._compressed=W_(this._format),this._integerFormat=$o(this._format),this._integerFormat&&(t.mipmaps=!1,t.minFilter=Ee,t.magFilter=Ee),e.supportsVolumeTextures){var T,b,C;this._volume=(T=t.volume)!=null?T:!1,this._depth=Math.floor((b=t.depth)!=null?b:1),this._arrayLength=Math.floor((C=t.arrayLength)!=null?C:0)}else this._volume=!1,this._depth=1,this._arrayLength=0;this._storage=(o=t.storage)!=null?o:!1,this._cubemap=(l=t.cubemap)!=null?l:!1,this.fixCubemapSeams=(c=t.fixCubemapSeams)!=null?c:!1,this._flipY=(d=t.flipY)!=null?d:!1,this._premultiplyAlpha=(h=t.premultiplyAlpha)!=null?h:!1,this._mipmaps=(u=(f=t.mipmaps)!=null?f:t.autoMipmap)!=null?u:!0,this._minFilter=(p=t.minFilter)!=null?p:Or,this._magFilter=(_=t.magFilter)!=null?_:nt,this._anisotropy=(m=t.anisotropy)!=null?m:1,this._addressU=(g=t.addressU)!=null?g:Tt,this._addressV=(v=t.addressV)!=null?v:Tt,this._addressW=(x=t.addressW)!=null?x:Tt,this._compareOnRead=(S=t.compareOnRead)!=null?S:!1,this._compareFunc=(w=t.compareFunc)!=null?w:_y,this.type=ps,t.hasOwnProperty("type")?this.type=t.type:t.hasOwnProperty("rgbm")?this.type=t.rgbm?Qi:ps:t.hasOwnProperty("swizzleGGGR")&&(this.type=t.swizzleGGGR?Ll:ps),this.projection=n1,this._cubemap?this.projection=q_:t.projection&&t.projection!==q_&&(this.projection=t.projection),this.impl=e.createTextureImpl(this),this.dirtyAll(),this._levels=t.levels,this._levels?this.upload():this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null],e.textures.push(this)}destroy(){const e=this.device;if(e){const t=e.textures.indexOf(this);t!==-1&&e.textures.splice(t,1),e.scope.removeValue(this),this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this._gpuSize),this._levels=null,this.device=null}}resize(e,t,s=1){const i=this.device;this.adjustVramSizeTracking(i._vram,-this._gpuSize),this.impl.destroy(i),this._width=Math.floor(e),this._height=Math.floor(t),this._depth=Math.floor(s),this.impl=i.createTextureImpl(this),this.dirtyAll()}loseContext(){this.impl.loseContext(),this.dirtyAll()}adjustVramSizeTracking(e,t){e.tex+=t}propertyChanged(e){this.impl.propertyChanged(e),this.renderVersionDirty=this.device.renderVersion}get requiredMipLevels(){return this.mipmaps?Dn.calcMipLevelsCount(this.width,this.height):1}get lockedMode(){return this._lockedMode}set minFilter(e){this._minFilter!==e&&($o(this._format)||(this._minFilter=e,this.propertyChanged(1)))}get minFilter(){return this._minFilter}set magFilter(e){this._magFilter!==e&&($o(this._format)||(this._magFilter=e,this.propertyChanged(2)))}get magFilter(){return this._magFilter}set addressU(e){this._addressU!==e&&(this._addressU=e,this.propertyChanged(4))}get addressU(){return this._addressU}set addressV(e){this._addressV!==e&&(this._addressV=e,this.propertyChanged(8))}get addressV(){return this._addressV}set addressW(e){this.device.supportsVolumeTextures&&this._volume&&e!==this._addressW&&(this._addressW=e,this.propertyChanged(16))}get addressW(){return this._addressW}set compareOnRead(e){this._compareOnRead!==e&&(this._compareOnRead=e,this.propertyChanged(32))}get compareOnRead(){return this._compareOnRead}set compareFunc(e){this._compareFunc!==e&&(this._compareFunc=e,this.propertyChanged(64))}get compareFunc(){return this._compareFunc}set anisotropy(e){this._anisotropy!==e&&(this._anisotropy=e,this.propertyChanged(128))}get anisotropy(){return this._anisotropy}set mipmaps(e){this._mipmaps!==e&&(this.device.isWebGPU||$o(this._format)||(this._mipmaps=e),e&&(this._needsMipmapsUpload=!0))}get mipmaps(){return this._mipmaps}get storage(){return this._storage}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){const e=this.pot&&this._mipmaps&&!(this._compressed&&this._levels.length===1);return Dn.calcGpuSize(this._width,this._height,this._depth,this._format,e,this._cubemap)}get array(){return this._arrayLength>0}get arrayLength(){return this._arrayLength}get volume(){return this._volume}set flipY(e){this._flipY!==e&&(this._flipY=e,this._needsUpload=!0)}get flipY(){return this._flipY}set premultiplyAlpha(e){this._premultiplyAlpha!==e&&(this._premultiplyAlpha=e,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return H.powerOfTwo(this._width)&&H.powerOfTwo(this._height)}get encoding(){switch(this.type){case Qi:return"rgbm";case Ey:return"rgbe";case Rl:return"rgbp";default:return this.format===Kl||this.format===Yl||this.format===yt||this.format===rt||$o(this.format)?"linear":"srgb"}}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this.propertyChanged(255)}lock(e={}){var t,s,i;(t=e.level)!=null||(e.level=0),(s=e.face)!=null||(e.face=0),(i=e.mode)!=null||(e.mode=hv),this._lockedMode=e.mode,this._lockedLevel=e.level;const n=this.cubemap?this._levels[e.face]:this._levels;if(n[e.level]===null){const a=Math.max(1,this._width>>e.level),o=Math.max(1,this._height>>e.level),l=Math.max(1,this._depth>>e.level),c=new ArrayBuffer(Dn.calcLevelGpuSize(a,o,l,this._format));n[e.level]=new(qA(this._format))(c)}return n[e.level]}setSource(e,t=0){let s=!1,i,n;if(this._cubemap){if(e[0]){i=e[0].width||0,n=e[0].height||0;for(let a=0;a<6;a++){const o=e[a];if(!o||o.width!==i||o.height!==n||!this.device._isBrowserInterface(o)){s=!0;break}}}else s=!0;if(!s)for(let a=0;a<6;a++)this._levels[t][a]!==e[a]&&(this._levelsUpdated[t][a]=!0)}else this.device._isBrowserInterface(e)||(s=!0),s||(e!==this._levels[t]&&(this._levelsUpdated[t]=!0),i=e.width,n=e.height);if(s)if(this._width=4,this._height=4,this._cubemap)for(let a=0;a<6;a++)this._levels[t][a]=null,this._levelsUpdated[t][a]=!0;else this._levels[t]=null,this._levelsUpdated[t]=!0;else t===0&&(this._width=i,this._height=n),this._levels[t]=e;(this._invalid!==s||!s)&&(this._invalid=s,this.upload())}getSource(e=0){return this._levels[e]}unlock(){this._lockedMode,this._lockedMode===hv&&this.upload(),this._lockedLevel=-1,this._lockedMode=_m}upload(){var e,t;this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,(e=(t=this.impl).uploadImmediate)==null||e.call(t,this.device,this)}async downloadAsync(){const e=[];for(let i=0;i<(this.cubemap?6:1);i++){var t,s;const n=new Ct({colorBuffer:this,depth:!1,face:i});this.device.setRenderTarget(n),this.device.initRenderTarget(n);const a=this.cubemap?this._levels[i]:this._levels;let o=a[0];a[0]&&this.device._isBrowserInterface(a[0])&&(a[0]=null),o=this.lock({face:i});const l=(t=(s=this.device).readPixelsAsync)==null?void 0:t.call(s,0,0,this.width,this.height,o).then(()=>n.destroy());e.push(l)}await Promise.all(e)}}class pb{constructor(){this.bufferId=null}destroy(e){this.bufferId&&(e.gl.deleteBuffer(this.bufferId),this.bufferId=null)}get initialized(){return!!this.bufferId}loseContext(){this.bufferId=null}unlock(e,t,s,i){const n=e.gl;if(this.bufferId)n.bindBuffer(s,this.bufferId),n.bufferSubData(s,0,i);else{let a;switch(t){case as:a=n.STATIC_DRAW;break;case Pl:a=n.DYNAMIC_DRAW;break;case VA:a=n.STREAM_DRAW;break;case GA:a=e.isWebGL2?n.DYNAMIC_COPY:n.STATIC_DRAW;break}this.bufferId=n.createBuffer(),n.bindBuffer(s,this.bufferId),n.bufferData(s,i,a)}}}class AP extends pb{constructor(...e){super(...e),this.vao=null}destroy(e){super.destroy(e),e.unbindVertexArray()}loseContext(){super.loseContext(),this.vao=null}unlock(e){const t=e.device;super.unlock(t,e.usage,t.gl.ARRAY_BUFFER,e.storage)}}class PP extends pb{constructor(e){super();const t=e.device.gl,s=e.format;s===H_?this.glFormat=t.UNSIGNED_BYTE:s===ai?this.glFormat=t.UNSIGNED_SHORT:s===Fr&&(this.glFormat=t.UNSIGNED_INT)}unlock(e){const t=e.device;super.unlock(t,e.usage,t.gl.ELEMENT_ARRAY_BUFFER,e.storage)}}class Lv{constructor(e,t,s,i){if(this.locationId=i,this.scopeId=e.scope.resolve(t),this.version=new hb,t.substring(t.length-3)==="[0]")switch(s){case bi:s=Dp;break;case $a:s=Ul;break;case Fl:s=kp;break;case Sl:s=Bp;break;case kr:s=Op;break;case ka:s=zl;break;case kl:s=Np;break;case Sc:s=Up;break;case Rs:s=Fp;break;case Ba:s=Vl;break;case Bl:s=zp;break;case xc:s=Vp;break;case Xa:s=Ay;break;case Na:s=rf;break;case Nl:s=Py;break;case wc:s=My;break}this.dataType=s,this.value=[null,null,null,null],this.array=[]}}const MP=new Set(["gl_VertexID","gl_InstanceID","gl_DrawID","gl_BaseVertex","gl_BaseInstance"]);class IP{constructor(){this.map=new Map}destroy(e){this.map.forEach(t=>{e.gl.deleteShader(t)})}loseContext(e){this.map.clear()}}const RP=new di,LP=new di;class DP{constructor(e){this.compileDuration=0,this.init(),this.compile(e.device,e),this.link(e.device,e),e.device.shaders.push(e)}destroy(e){this.glProgram&&(e.device.gl.deleteProgram(this.glProgram),this.glProgram=null)}init(){this.uniforms=[],this.samplers=[],this.attributes=[],this.glProgram=null,this.glVertexShader=null,this.glFragmentShader=null}loseContext(){this.init()}restoreContext(e,t){this.compile(e,t)}compile(e,t){const s=t.definition;this.glVertexShader=this._compileShaderSource(e,s.vshader,!0),this.glFragmentShader=this._compileShaderSource(e,s.fshader,!1)}link(e,t){if(this.glProgram)return;const s=e.gl;if(s.isContextLost())return;const i=s.createProgram();this.glProgram=i,s.attachShader(i,this.glVertexShader),s.attachShader(i,this.glFragmentShader);const n=t.definition,a=n.attributes;if(e.isWebGL2&&n.useTransformFeedback){const o=[];for(const l in a)a.hasOwnProperty(l)&&o.push("out_"+l);s.transformFeedbackVaryings(i,o,s.INTERLEAVED_ATTRIBS)}for(const o in a)if(a.hasOwnProperty(o)){const l=a[o],c=Le[l];s.bindAttribLocation(i,c,o)}s.linkProgram(i)}_compileShaderSource(e,t,s){const i=e.gl,a=(s?RP:LP).get(e,()=>new IP);let o=a.map.get(t);if(!o){if(o=i.createShader(s?i.VERTEX_SHADER:i.FRAGMENT_SHADER),!o&&i.isContextLost())return o;i.shaderSource(o,t),i.compileShader(o),a.map.set(t,o)}return o}finalize(e,t){const s=e.gl;if(s.isContextLost())return!0;const i=this.glProgram,n=t.definition;if(!s.getProgramParameter(i,s.LINK_STATUS)){if(!this._isCompiled(e,t,this.glVertexShader,n.vshader,"vertex")||!this._isCompiled(e,t,this.glFragmentShader,n.fshader,"fragment"))return!1;const d="Failed to link shader program. Error: "+s.getProgramInfoLog(i);return console.error(d),!1}const o=s.getProgramParameter(i,s.ACTIVE_ATTRIBUTES);for(let d=0;d<o;d++){const h=s.getActiveAttrib(i,d),u=s.getAttribLocation(i,h.name);if(!MP.has(h.name))if(n.attributes[h.name]===void 0)console.error(`Vertex shader attribute "${h.name}" is not mapped to a semantic in shader definition, shader [${t.label}]`,t),t.failed=!0;else{const f=new Lv(e,n.attributes[h.name],e.pcUniformType[h.type],u);this.attributes.push(f)}}const l=e._samplerTypes,c=s.getProgramParameter(i,s.ACTIVE_UNIFORMS);for(let d=0;d<c;d++){const h=s.getActiveUniform(i,d),u=s.getUniformLocation(i,h.name),f=new Lv(e,h.name,e.pcUniformType[h.type],u);l.has(h.type)?this.samplers.push(f):this.uniforms.push(f)}return t.ready=!0,!0}_isCompiled(e,t,s,i,n){const a=e.gl;if(!a.getShaderParameter(s,a.COMPILE_STATUS)){const o=a.getShaderInfoLog(s),[l,c]=this._processError(i,o),d=`Failed to compile ${n} shader:

${o}
${l} while rendering undefined`;return console.error(d),!1}return!0}isLinked(e){const{extParallelShaderCompile:t}=e;return t?e.gl.getProgramParameter(this.glProgram,t.COMPLETION_STATUS_KHR):!0}_processError(e,t){const s={};let i="";if(e){const n=e.split(`
`);let a=0,o=n.length;if(t&&t.startsWith("ERROR:")){const l=t.match(/^ERROR:\s([0-9]+):([0-9]+):\s*(.+)/);l&&(s.message=l[3],s.line=parseInt(l[2],10),a=Math.max(0,s.line-6),o=Math.min(n.length,s.line+5))}for(let l=a;l<o;l++)i+=l+1+":	"+n[l]+`
`;s.source=e}return[i,s]}}function Dv(r,e){const t=r.width,s=r.height;if(t>e||s>e){const i=e/Math.max(t,s),n=Math.floor(t*i),a=Math.floor(s*i),o=document.createElement("canvas");return o.width=n,o.height=a,o.getContext("2d").drawImage(r,0,0,t,s,0,0,n,a),o}return r}class OP{constructor(){this._glTexture=null,this._glTarget=void 0,this._glFormat=void 0,this._glInternalFormat=void 0,this._glPixelType=void 0,this._glCreated=void 0,this.dirtyParameterFlags=0}destroy(e){if(this._glTexture){for(let t=0;t<e.textureUnits.length;t++){const s=e.textureUnits[t];for(let i=0;i<s.length;i++)s[i]===this._glTexture&&(s[i]=null)}e.gl.deleteTexture(this._glTexture),this._glTexture=null}}loseContext(){this._glTexture=null}propertyChanged(e){this.dirtyParameterFlags|=e}initialize(e,t){const s=e.gl;switch(this._glTexture=s.createTexture(),this._glTarget=t._cubemap?s.TEXTURE_CUBE_MAP:t._volume?s.TEXTURE_3D:t.array?s.TEXTURE_2D_ARRAY:s.TEXTURE_2D,t._format){case gy:this._glFormat=s.ALPHA,this._glInternalFormat=s.ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case op:this._glFormat=s.LUMINANCE,this._glInternalFormat=s.LUMINANCE,this._glPixelType=s.UNSIGNED_BYTE;break;case lp:this._glFormat=s.LUMINANCE_ALPHA,this._glInternalFormat=s.LUMINANCE_ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case Zc:this._glFormat=s.RGB,this._glInternalFormat=s.RGB,this._glPixelType=s.UNSIGNED_SHORT_5_6_5;break;case hp:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA,this._glPixelType=s.UNSIGNED_SHORT_5_5_5_1;break;case Jc:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA,this._glPixelType=s.UNSIGNED_SHORT_4_4_4_4;break;case Gn:this._glFormat=s.RGB,this._glInternalFormat=e.isWebGL2?s.RGB8:s.RGB,this._glPixelType=s.UNSIGNED_BYTE;break;case xe:this._glFormat=s.RGBA,this._glInternalFormat=e.isWebGL2?s.RGBA8:s.RGBA,this._glPixelType=s.UNSIGNED_BYTE;break;case Qc:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case cp:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case ql:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case ed:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;break;case Zl:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case Jl:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case td:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case sd:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case fp:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGB8_ETC2;break;case pp:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case yy:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case vy:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGB_ATC_WEBGL;break;case Sy:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case id:e.isWebGL2?(this._glFormat=s.RED,this._glInternalFormat=s.R16F,this._glPixelType=s.HALF_FLOAT):(this._glFormat=s.LUMINANCE,this._glInternalFormat=s.LUMINANCE,this._glPixelType=e.extTextureHalfFloat.HALF_FLOAT_OES);break;case Ip:e.isWebGL2?(this._glFormat=s.RG,this._glInternalFormat=s.RG16F,this._glPixelType=s.HALF_FLOAT):(this._glFormat=s.RG,this._glInternalFormat=s.RG,this._glPixelType=e.extTextureHalfFloat.HALF_FLOAT_OES);break;case Kl:this._glFormat=s.RGB,e.isWebGL2?(this._glInternalFormat=s.RGB16F,this._glPixelType=s.HALF_FLOAT):(this._glInternalFormat=s.RGB,this._glPixelType=e.extTextureHalfFloat.HALF_FLOAT_OES);break;case yt:this._glFormat=s.RGBA,e.isWebGL2?(this._glInternalFormat=s.RGBA16F,this._glPixelType=s.HALF_FLOAT):(this._glInternalFormat=s.RGBA,this._glPixelType=e.extTextureHalfFloat.HALF_FLOAT_OES);break;case Yl:this._glFormat=s.RGB,e.isWebGL2?this._glInternalFormat=s.RGB32F:this._glInternalFormat=s.RGB,this._glPixelType=s.FLOAT;break;case rt:this._glFormat=s.RGBA,e.isWebGL2?this._glInternalFormat=s.RGBA32F:this._glInternalFormat=s.RGBA,this._glPixelType=s.FLOAT;break;case Bn:this._glFormat=s.RED,this._glInternalFormat=s.R32F,this._glPixelType=s.FLOAT;break;case Ha:e.isWebGL2?(this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT32F,this._glPixelType=s.FLOAT):(this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT,this._glPixelType=s.UNSIGNED_SHORT);break;case Wa:this._glFormat=s.DEPTH_STENCIL,e.isWebGL2?(this._glInternalFormat=s.DEPTH24_STENCIL8,this._glPixelType=s.UNSIGNED_INT_24_8):(this._glInternalFormat=s.DEPTH_STENCIL,this._glPixelType=e.extDepthTexture.UNSIGNED_INT_24_8_WEBGL);break;case ja:this._glFormat=s.RGB,this._glInternalFormat=s.R11F_G11F_B10F,this._glPixelType=s.UNSIGNED_INT_10F_11F_11F_REV;break;case dp:this._glFormat=s.RGB,this._glInternalFormat=s.SRGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case up:this._glFormat=s.RGBA,this._glInternalFormat=s.SRGB8_ALPHA8,this._glPixelType=s.UNSIGNED_BYTE;break;case mp:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8I,this._glPixelType=s.BYTE;break;case wy:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case _p:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16I,this._glPixelType=s.SHORT;break;case gp:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case yp:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32I,this._glPixelType=s.INT;break;case vp:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32UI,this._glPixelType=s.UNSIGNED_INT;break;case Sp:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8I,this._glPixelType=s.BYTE;break;case by:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case xp:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16I,this._glPixelType=s.SHORT;break;case wp:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case bp:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32I,this._glPixelType=s.INT;break;case Tp:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32UI,this._glPixelType=s.UNSIGNED_INT;break;case Ep:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8I,this._glPixelType=s.BYTE;break;case Ty:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case Cp:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16I,this._glPixelType=s.SHORT;break;case Ap:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case Pp:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32I,this._glPixelType=s.INT;break;case Mp:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32UI,this._glPixelType=s.UNSIGNED_INT;break}this._glCreated=!1}upload(e,t){const s=e.gl;if(!t._needsUpload&&(t._needsMipmapsUpload&&t._mipmapsUploaded||!t.pot))return;let i=0,n,a;const o=t.requiredMipLevels;for(t.array&&s.texStorage3D(s.TEXTURE_2D_ARRAY,o,this._glInternalFormat,t._width,t._height,t._arrayLength);t._levels[i]||i===0;){if(!t._needsUpload&&i===0){i++;continue}else if(i&&(!t._needsMipmapsUpload||!t._mipmaps))break;if(n=t._levels[i],a=1/Math.pow(2,i),i===1&&!t._compressed&&!t._integerFormat&&t._levels.length<o&&(s.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._cubemap){let l;if(e._isBrowserInterface(n[0]))for(l=0;l<6;l++){if(!t._levelsUpdated[0][l])continue;let c=n[l];e._isImageBrowserInterface(c)&&(c.width>e.maxCubeMapSize||c.height>e.maxCubeMapSize)&&(c=Dv(c,e.maxCubeMapSize),i===0&&(t._width=c.width,t._height=c.height)),e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated?s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,0,0,this._glFormat,this._glPixelType,c):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,this._glInternalFormat,this._glFormat,this._glPixelType,c)}else for(a=1/Math.pow(2,i),l=0;l<6;l++){if(!t._levelsUpdated[0][l])continue;const c=n[l];t._compressed?this._glCreated&&c?s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,0,0,Math.max(t._width*a,1),Math.max(t._height*a,1),this._glInternalFormat,c):s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,this._glInternalFormat,Math.max(t._width*a,1),Math.max(t._height*a,1),0,c):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&c?s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,0,0,Math.max(t._width*a,1),Math.max(t._height*a,1),this._glFormat,this._glPixelType,c):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,this._glInternalFormat,Math.max(t._width*a,1),Math.max(t._height*a,1),0,this._glFormat,this._glPixelType,c))}}else if(t._volume)t._compressed?s.compressedTexImage3D(s.TEXTURE_3D,i,this._glInternalFormat,Math.max(t._width*a,1),Math.max(t._height*a,1),Math.max(t._depth*a,1),0,n):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s.texImage3D(s.TEXTURE_3D,i,this._glInternalFormat,Math.max(t._width*a,1),Math.max(t._height*a,1),Math.max(t._depth*a,1),0,this._glFormat,this._glPixelType,n));else if(t.array&&typeof n=="object"){if(t._arrayLength===n.length)if(t._compressed)for(let l=0;l<t._arrayLength;l++)s.compressedTexSubImage3D(s.TEXTURE_2D_ARRAY,i,0,0,l,Math.max(Math.floor(t._width*a),1),Math.max(Math.floor(t._height*a),1),1,this._glFormat,n[l]);else for(let l=0;l<t._arrayLength;l++)s.texSubImage3D(s.TEXTURE_2D_ARRAY,i,0,0,l,Math.max(Math.floor(t._width*a),1),Math.max(Math.floor(t._height*a),1),1,this._glFormat,this._glPixelType,n[l])}else{if(e._isBrowserInterface(n)){e._isImageBrowserInterface(n)&&(n.width>e.maxTextureSize||n.height>e.maxTextureSize)&&(n=Dv(n,e.maxTextureSize),i===0&&(t._width=n.width,t._height=n.height));const l=n.width||n.videoWidth,c=n.height||n.videoHeight;e.setUnpackFlipY(t._flipY),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&t._width===l&&t._height===c&&!e._isImageVideoInterface(n)?s.texSubImage2D(s.TEXTURE_2D,i,0,0,this._glFormat,this._glPixelType,n):(s.texImage2D(s.TEXTURE_2D,i,this._glInternalFormat,this._glFormat,this._glPixelType,n),i===0&&(t._width=l,t._height=c))}else a=1/Math.pow(2,i),t._compressed?this._glCreated&&n?s.compressedTexSubImage2D(s.TEXTURE_2D,i,0,0,Math.max(Math.floor(t._width*a),1),Math.max(Math.floor(t._height*a),1),this._glInternalFormat,n):s.compressedTexImage2D(s.TEXTURE_2D,i,this._glInternalFormat,Math.max(Math.floor(t._width*a),1),Math.max(Math.floor(t._height*a),1),0,n):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&n?s.texSubImage2D(s.TEXTURE_2D,i,0,0,Math.max(t._width*a,1),Math.max(t._height*a,1),this._glFormat,this._glPixelType,n):s.texImage2D(s.TEXTURE_2D,i,this._glInternalFormat,Math.max(t._width*a,1),Math.max(t._height*a,1),0,this._glFormat,this._glPixelType,n));i===0?t._mipmapsUploaded=!1:t._mipmapsUploaded=!0}i++}if(t._needsUpload)if(t._cubemap)for(let l=0;l<6;l++)t._levelsUpdated[0][l]=!1;else t._levelsUpdated[0]=!1;!t._compressed&&!t._integerFormat&&t._mipmaps&&t._needsMipmapsUpload&&(t.pot||e.isWebGL2)&&t._levels.length===1&&(s.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize),this._glCreated=!0}}class FP{constructor(e,t){this.msaaFB=void 0,this.resolveFB=void 0,this.msaaFB=e,this.resolveFB=t}destroy(e){this.msaaFB&&(e.deleteRenderbuffer(this.msaaFB),this.msaaFB=null),this.resolveFB&&(e.deleteRenderbuffer(this.resolveFB),this.resolveFB=null)}}class kP{constructor(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this.colorMrtFramebuffers=null,this._glMsaaColorBuffers=[],this._glMsaaDepthBuffer=null,this.suppliedColorFramebuffer=void 0,this._isInitialized=!1}destroy(e){var t;const s=e.gl;this._isInitialized=!1,this._glFrameBuffer&&(this._glFrameBuffer!==this.suppliedColorFramebuffer&&s.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(s.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(this._glResolveFrameBuffer!==this.suppliedColorFramebuffer&&s.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffers.forEach(i=>{s.deleteRenderbuffer(i)}),this._glMsaaColorBuffers.length=0,(t=this.colorMrtFramebuffers)==null||t.forEach(i=>{i.destroy(s)}),this.colorMrtFramebuffers=null,this._glMsaaDepthBuffer&&(s.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null),this.suppliedColorFramebuffer=void 0}get initialized(){return this._isInitialized}init(e,t){const s=e.gl;this._isInitialized=!0;const i=[];if(this.suppliedColorFramebuffer!==void 0)this._glFrameBuffer=this.suppliedColorFramebuffer;else{var n,a,o,l;this._glFrameBuffer=s.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);const h=(n=(a=t._colorBuffers)==null?void 0:a.length)!=null?n:0,u=e.isWebGL2?s.COLOR_ATTACHMENT0:(o=(l=e.extDrawBuffers)==null?void 0:l.COLOR_ATTACHMENT0_WEBGL)!=null?o:s.COLOR_ATTACHMENT0;for(let p=0;p<h;++p){const _=t.getColorBuffer(p);_&&(_.impl._glTexture||(_._width=Math.min(_.width,e.maxRenderBufferSize),_._height=Math.min(_.height,e.maxRenderBufferSize),e.setTexture(_,0)),s.framebufferTexture2D(s.FRAMEBUFFER,u+p,_._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,_.impl._glTexture,0),i.push(u+p))}e.drawBuffers&&e.drawBuffers(i);const f=t._depthBuffer;if(f)f.impl._glTexture||(f._width=Math.min(f.width,e.maxRenderBufferSize),f._height=Math.min(f.height,e.maxRenderBufferSize),e.setTexture(f,0)),t._stencil?s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,f._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,t._depthBuffer.impl._glTexture,0):s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,f._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,t._depthBuffer.impl._glTexture,0);else if(t._depth&&!(t._samples>1&&e.isWebGL2)){if(this._glDepthBuffer||(this._glDepthBuffer=s.createRenderbuffer()),s.bindRenderbuffer(s.RENDERBUFFER,this._glDepthBuffer),t._stencil)s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_STENCIL,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,this._glDepthBuffer);else{const _=e.isWebGL2?s.DEPTH_COMPONENT32F:s.DEPTH_COMPONENT16;s.renderbufferStorage(s.RENDERBUFFER,_,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,this._glDepthBuffer)}s.bindRenderbuffer(s.RENDERBUFFER,null)}}if(e.isWebGL2&&t._samples>1){var c,d;this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=s.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);const h=(c=(d=t._colorBuffers)==null?void 0:d.length)!=null?c:0;if(this.suppliedColorFramebuffer!==void 0){const u=s.createRenderbuffer();this._glMsaaColorBuffers.push(u);const f=e.backBufferFormat===xe?s.RGBA8:s.RGB8;s.bindRenderbuffer(s.RENDERBUFFER,u),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,f,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,u)}else for(let u=0;u<h;++u){const f=t.getColorBuffer(u);if(f){const p=s.createRenderbuffer();this._glMsaaColorBuffers.push(p),s.bindRenderbuffer(s.RENDERBUFFER,p),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,f.impl._glInternalFormat,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+u,s.RENDERBUFFER,p)}}t._depth&&(this._glMsaaDepthBuffer||(this._glMsaaDepthBuffer=s.createRenderbuffer()),s.bindRenderbuffer(s.RENDERBUFFER,this._glMsaaDepthBuffer),t._stencil?(s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,s.DEPTH24_STENCIL8,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,this._glMsaaDepthBuffer)):(s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,s.DEPTH_COMPONENT32F,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,this._glMsaaDepthBuffer))),h>1&&(this._createMsaaMrtFramebuffers(e,t,h),e.setFramebuffer(this._glFrameBuffer),e.drawBuffers(i))}}_createMsaaMrtFramebuffers(e,t,s){const i=e.gl;this.colorMrtFramebuffers=[];for(let n=0;n<s;++n){const a=t.getColorBuffer(n),o=i.createFramebuffer();e.setFramebuffer(o);const l=this._glMsaaColorBuffers[n];i.bindRenderbuffer(i.RENDERBUFFER,l),i.renderbufferStorageMultisample(i.RENDERBUFFER,t._samples,a.impl._glInternalFormat,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.RENDERBUFFER,l),e.drawBuffers([i.COLOR_ATTACHMENT0]);const c=i.createFramebuffer();e.setFramebuffer(c),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,a._cubemap?i.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:i.TEXTURE_2D,a.impl._glTexture,0),this.colorMrtFramebuffers[n]=new FP(o,c)}}_checkFbo(e,t,s=""){const i=e.gl;switch(i.checkFramebufferStatus(i.FRAMEBUFFER)){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:break;case i.FRAMEBUFFER_UNSUPPORTED:break}}loseContext(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffers.length=0,this._glMsaaDepthBuffer=null,this.colorMrtFramebuffers=null,this.suppliedColorFramebuffer=void 0,this._isInitialized=!1}internalResolve(e,t,s,i,n){e.setScissor(0,0,i.width,i.height);const a=e.gl;a.bindFramebuffer(a.READ_FRAMEBUFFER,t),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,s),a.blitFramebuffer(0,0,i.width,i.height,0,0,i.width,i.height,n,a.NEAREST)}resolve(e,t,s,i){if(e.isWebGL2){const n=e.gl;if(this.colorMrtFramebuffers){if(s)for(let a=0;a<this.colorMrtFramebuffers.length;a++){const o=this.colorMrtFramebuffers[a];this.internalResolve(e,o.msaaFB,o.resolveFB,t,n.COLOR_BUFFER_BIT)}i&&this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,n.DEPTH_BUFFER_BIT)}else this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0));n.bindFramebuffer(n.FRAMEBUFFER,this._glFrameBuffer)}}}var mb=`
#define pcFragColor0 gl_FragData[0]
#if COLOR_ATTACHMENT_1
#define pcFragColor1 gl_FragData[1]
#endif
#if COLOR_ATTACHMENT_2
#define pcFragColor2 gl_FragData[2]
#endif
#if COLOR_ATTACHMENT_3
#define pcFragColor3 gl_FragData[3]
#endif
#if COLOR_ATTACHMENT_4
#define pcFragColor4 gl_FragData[4]
#endif
#if COLOR_ATTACHMENT_5
#define pcFragColor5 gl_FragData[5]
#endif
#if COLOR_ATTACHMENT_6
#define pcFragColor6 gl_FragData[6]
#endif
#if COLOR_ATTACHMENT_7
#define pcFragColor7 gl_FragData[7]
#endif
#define texture2DBias texture2D
#define itexture2D texture2D
#define utexture2D texture2D
#define SHADOWMAP_PASS(name) name
#define SHADOWMAP_ACCEPT(name) sampler2D name
#define TEXTURE_PASS(name) name
#define TEXTURE_ACCEPT(name) sampler2D name
#ifndef SUPPORTS_TEXLOD
	#define texture2DLodEXT texture2D
	#define texture2DProjLodEXT textureProj
	#define textureCubeLodEXT textureCube
	#define textureShadow texture2D
#else
	#define textureShadow(res, uv) texture2DGradEXT(res, uv, vec2(1, 1), vec2(1, 1))
#endif
#ifdef SUPPORTS_MRT
	#define gl_FragColor pcFragColor0
#endif
`,_b=`
#ifndef outType_0
#define outType_0 vec4
#endif
layout(location = 0) out highp outType_0 pc_fragColor;
#ifndef REMOVE_COLOR_ATTACHMENT_1
#if COLOR_ATTACHMENT_1
layout(location = 1) out highp outType_1 pc_fragColor1;
#endif
#endif
#ifndef REMOVE_COLOR_ATTACHMENT_2
#if COLOR_ATTACHMENT_2
layout(location = 2) out highp outType_2 pc_fragColor2;
#endif
#endif
#ifndef REMOVE_COLOR_ATTACHMENT_3
#if COLOR_ATTACHMENT_3
layout(location = 3) out highp outType_3 pc_fragColor3;
#endif
#endif
#ifndef REMOVE_COLOR_ATTACHMENT_4
#if COLOR_ATTACHMENT_4
layout(location = 4) out highp outType_4 pc_fragColor4;
#endif
#endif
#ifndef REMOVE_COLOR_ATTACHMENT_5
#if COLOR_ATTACHMENT_5
layout(location = 5) out highp outType_5 pc_fragColor5;
#endif
#endif
#ifndef REMOVE_COLOR_ATTACHMENT_6
#if COLOR_ATTACHMENT_6
layout(location = 6) out highp outType_6 pc_fragColor6;
#endif
#endif
#ifndef REMOVE_COLOR_ATTACHMENT_7
#if COLOR_ATTACHMENT_7
layout(location = 7) out highp outType_7 pc_fragColor7;
#endif
#endif
#define gl_FragColor pc_fragColor
#define pcFragColor0 pc_fragColor
#define pcFragColor1 pc_fragColor1
#define pcFragColor2 pc_fragColor2
#define pcFragColor3 pc_fragColor3
#define pcFragColor4 pc_fragColor4
#define pcFragColor5 pc_fragColor5
#define pcFragColor6 pc_fragColor6
#define pcFragColor7 pc_fragColor7
#define varying in
#define texture2D texture
#define texture2DBias texture
#define textureCube texture
#define texture2DProj textureProj
#define texture2DLodEXT textureLod
#define texture2DProjLodEXT textureProjLod
#define textureCubeLodEXT textureLod
#define texture2DGradEXT textureGrad
#define texture2DProjGradEXT textureProjGrad
#define textureCubeGradEXT textureGrad
#define utexture2D texture
#define itexture2D texture
#define textureShadow(res, uv) textureGrad(res, uv, vec2(1, 1), vec2(1, 1))
#define SHADOWMAP_PASS(name) name
#define SHADOWMAP_ACCEPT(name) sampler2DShadow name
#define TEXTURE_PASS(name) name
#define TEXTURE_ACCEPT(name) sampler2D name
#define GL2
#define SUPPORTS_TEXLOD
#define SUPPORTS_MRT
`,gb=`
#define attribute in
#define varying out
#define texture2D texture
#define utexture2D texture
#define itexture2D texture
#define GL2
#define VERTEXSHADER
`,yb=`
#extension GL_EXT_samplerless_texture_functions : require
#ifndef outType_0
#define outType_0 vec4
#endif
#ifndef outType_1
#define outType_1 vec4
#endif
#ifndef outType_2
#define outType_2 vec4
#endif
#ifndef outType_3
#define outType_3 vec4
#endif
#ifndef outType_4
#define outType_4 vec4
#endif
#ifndef outType_5
#define outType_5 vec4
#endif
#ifndef outType_6
#define outType_6 vec4
#endif
#ifndef outType_7
#define outType_7 vec4
#endif
layout(location = 0) out highp outType_0 pc_fragColor;
layout(location = 1) out highp outType_1 pc_fragColor1;
layout(location = 2) out highp outType_2 pc_fragColor2;
layout(location = 3) out highp outType_3 pc_fragColor3;
layout(location = 4) out highp outType_4 pc_fragColor4;
layout(location = 5) out highp outType_5 pc_fragColor5;
layout(location = 6) out highp outType_6 pc_fragColor6;
layout(location = 7) out highp outType_7 pc_fragColor7;
#define gl_FragColor pc_fragColor
#define pcFragColor0 pc_fragColor
#define pcFragColor1 pc_fragColor1
#define pcFragColor2 pc_fragColor2
#define pcFragColor3 pc_fragColor3
#define pcFragColor4 pc_fragColor4
#define pcFragColor5 pc_fragColor5
#define pcFragColor6 pc_fragColor6
#define pcFragColor7 pc_fragColor7
#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)
#define texture2DBias(res, uv, bias) texture(sampler2D(res, res ## _sampler), uv, bias)
#define texture2DLodEXT(res, uv, lod) textureLod(sampler2D(res, res ## _sampler), uv, lod)
#define textureCube(res, uv) texture(samplerCube(res, res ## _sampler), uv)
#define textureCubeLodEXT(res, uv, lod) textureLod(samplerCube(res, res ## _sampler), uv, lod)
#define textureShadow(res, uv) textureLod(sampler2DShadow(res, res ## _sampler), uv, 0.0)
#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)
#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)
#define SHADOWMAP_PASS(name) name, name ## _sampler
#define SHADOWMAP_ACCEPT(name) texture2D name, sampler name ## _sampler
#define TEXTURE_PASS(name) name, name ## _sampler
#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler
#define GL2
#define WEBGPU
#define SUPPORTS_TEXLOD
#define SUPPORTS_MRT
`,vb=`
#extension GL_EXT_samplerless_texture_functions : require
#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)
#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)
#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)
#define GL2
#define WEBGPU
#define VERTEXSHADER
`,Ov=`
vec2 getGrabScreenPos(vec4 clipPos) {
	vec2 uv = (clipPos.xy / clipPos.w) * 0.5 + 0.5;
	#ifdef WEBGPU
		uv.y = 1.0 - uv.y;
	#endif
	return uv;
}
vec2 getImageEffectUV(vec2 uv) {
	#ifdef WEBGPU
		uv.y = 1.0 - uv.y;
	#endif
	return uv;
}
`;const BP={vertex_position:ht,vertex_normal:Us,vertex_tangent:ln,vertex_texCoord0:zs,vertex_texCoord1:Hr,vertex_texCoord2:nd,vertex_texCoord3:rd,vertex_texCoord4:ad,vertex_texCoord5:od,vertex_texCoord6:ld,vertex_texCoord7:hd,vertex_color:Zt,vertex_boneIndices:Os,vertex_boneWeights:hn};class Mt{static createDefinition(e,t){var s,i;const n=(u,f,p,_,m)=>{const g=e.isWebGPU?u:e.isWebGL2?f:Mt.gl1Extensions(e,m)+p;let v="";if(!_){var x;let w=(x=m.fragmentOutputTypes)!=null?x:"vec4";Array.isArray(w)||(w=[w]);for(let T=0;T<e.maxColorAttachments;T++){var S;v+=`#define COLOR_ATTACHMENT_${T}
`;const b=(S=w[T])!=null?S:"vec4";v+=`#define outType_${T} ${b}
`}}return v+g},a=(s=t.name)!=null?s:"Untitled",o=t.vertexDefines||n(vb,gb,"",!0,t),l=Mt.versionCode(e)+o+Ov+Mt.getShaderNameCode(a)+t.vertexCode,c=t.fragmentDefines||n(yb,_b,mb,!1,t),d=(t.fragmentPreamble||"")+Mt.versionCode(e)+c+Mt.precisionCode(e)+`
`+Ov+Mt.getShaderNameCode(a)+(t.fragmentCode||Mt.dummyFragmentCode()),h=(i=t.attributes)!=null?i:Mt.collectAttributes(t.vertexCode);return{name:a,attributes:h,vshader:l,fshader:d,useTransformFeedback:t.useTransformFeedback}}static getShaderNameCode(e){return`#define SHADER_NAME ${e}
`}static gl1Extensions(e,t,s){let i;return s?i=t.vertexExtensions?`${t.vertexExtensions}
`:"":(i=t.fragmentExtensions?`${t.fragmentExtensions}
`:"",e.extStandardDerivatives&&(i+=`#extension GL_OES_standard_derivatives : enable
`),e.extTextureLod&&(i+=`#extension GL_EXT_shader_texture_lod : enable
`,i+=`#define SUPPORTS_TEXLOD
`),e.extDrawBuffers&&(i+=`#extension GL_EXT_draw_buffers : require
`,i+=`#define SUPPORTS_MRT
`)),i}static dummyFragmentCode(){return"void main(void) {gl_FragColor = vec4(0.0);}"}static versionCode(e){return e.isWebGPU?`#version 450
`:e.isWebGL2?`#version 300 es
`:""}static precisionCode(e,t){let s="";t&&t!=="highp"&&t!=="mediump"&&t!=="lowp"&&(t=null),t&&(t==="highp"&&e.maxPrecision!=="highp"&&(t="mediump"),t==="mediump"&&e.maxPrecision==="lowp"&&(t="lowp"));const i=t||e.precision;return e.isWebGPU?s=`precision ${i} float;
precision ${i} int;
`:(s=`precision ${i} float;
`,e.isWebGL2&&(s+=`precision ${i} sampler2DShadow;
`)),s}static collectAttributes(e){const t={};let s=0,i=e.indexOf("attribute");for(;i>=0&&!(i>0&&e[i-1]==="/");){const n=e.indexOf(";",i),a=e.lastIndexOf(" ",n),o=e.substring(a+1,n),l=BP[o];l!==void 0?t[o]=l:(t[o]="ATTR"+s,s++),i=e.indexOf("attribute",i+1)}return t}}class NP{constructor(){this.renderVersion=void 0,this.queries=[]}destroy(e){this.queries.forEach(t=>e.deleteQuery(t)),this.queries=null}}class UP extends fb{constructor(e){super(),this.device=void 0,this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[],this.timings=[],this.device=e,this.ext=e.extDisjointTimerQuery}destroy(){this.freeQueries.forEach(e=>this.device.gl.deleteQuery(e)),this.frameQueries.forEach(e=>this.device.gl.deleteQuery(e)),this.previousFrameQueries.forEach(e=>e.destroy(this.device.gl)),this.freeQueries=null,this.frameQueries=null,this.previousFrameQueries=null}loseContext(){super.loseContext(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[]}restoreContext(){this.ext=this.device.extDisjointTimerQuery}getQuery(){var e;return(e=this.freeQueries.pop())!=null?e:this.device.gl.createQuery()}start(e){if(this.ext){const t=this.getSlot(e),s=this.getQuery();return this.frameQueries[t]=s,this.device.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,s),t}}end(e){e!==void 0&&this.device.gl.endQuery(this.ext.TIME_ELAPSED_EXT)}frameStart(){this.processEnableRequest(),this._enabled&&(this.frameGPUMarkerSlot=this.start("GpuFrame"))}frameEnd(){this._enabled&&this.end(this.frameGPUMarkerSlot)}request(){if(this._enabled){const e=this.ext,t=this.device.gl,s=this.device.renderVersion,i=this.frameQueries;if(i.length>0){this.frameQueries=[];const n=new NP;n.queries=i,n.renderVersion=s,this.previousFrameQueries.push(n)}if(this.previousFrameQueries.length>0){const n=this.previousFrameQueries[0],a=n.queries,o=a[a.length-1],l=t.getQueryParameter(o,t.QUERY_RESULT_AVAILABLE),c=t.getParameter(e.GPU_DISJOINT_EXT);if(l&&!c){this.previousFrameQueries.shift();const d=this.timings;d.length=0;for(let h=0;h<a.length;h++){const u=a[h],f=t.getQueryParameter(u,t.QUERY_RESULT);d[h]=f*1e-6,this.freeQueries.push(u)}this.report(n.renderVersion,d)}c&&(this.previousFrameQueries.forEach(d=>{this.report(d.renderVersion,null),d.destroy(t)}),this.previousFrameQueries.length=0)}super.request(s)}}}const So=[],J_=`
attribute vec2 vertex_position;
varying vec2 vUv0;
void main(void)
{
	gl_Position = vec4(vertex_position, 0.5, 1.0);
	vUv0 = vertex_position.xy*0.5+0.5;
}
`,zP=`
void main(void) { 
	gl_FragColor = vec4(2147483648.0);
}
`,VP=`
uniform sampler2D source;
vec4 packFloat(float depth) {
	const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);
	const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);
	vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);
	res -= res.xxyz * bit_mask;
	return res;
}
void main(void) {
	float c = texture2D(source, vec2(0.0)).r;
	float diff = abs(c - 2147483648.0) / 2147483648.0;
	gl_FragColor = packFloat(diff);
}
`,GP=`
varying vec2 vUv0;
uniform sampler2D source;
void main(void) {
	gl_FragColor = texture2D(source, vUv0);
}
`;function Q_(r,e,t){const s=r.renderTarget;r.setRenderTarget(e),r.updateBegin(),r.setCullMode(Et),r.setBlendState(Xe.NOBLEND),r.setDepthState(kt.NODEPTH),r.setStencilState(null,null),r.setVertexBuffer(r.quadVertexBuffer,0),r.setShader(t),r.draw({type:Ji,base:0,count:4,indexed:!1}),r.updateEnd(),r.setRenderTarget(s),r.updateBegin()}function Fv(r,e){let t=!0;const s=r.createTexture();r.bindTexture(r.TEXTURE_2D,s),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,2,2,0,r.RGBA,e,null);const i=r.createFramebuffer();return r.bindFramebuffer(r.FRAMEBUFFER,i),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,s,0),r.checkFramebufferStatus(r.FRAMEBUFFER)!==r.FRAMEBUFFER_COMPLETE&&(t=!1),r.bindTexture(r.TEXTURE_2D,null),r.deleteTexture(s),r.bindFramebuffer(r.FRAMEBUFFER,null),r.deleteFramebuffer(i),t}function HP(r,e){let t=!0;const s=r.createTexture();r.bindTexture(r.TEXTURE_2D,s),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE);const i=new Uint16Array(4*2*2);return r.texImage2D(r.TEXTURE_2D,0,r.RGBA,2,2,0,r.RGBA,e,i),r.getError()!==r.NO_ERROR&&(t=!1,console.log("Above error related to HALF_FLOAT_OES can be ignored, it was triggered by testing half float texture support")),r.bindTexture(r.TEXTURE_2D,null),r.deleteTexture(s),t}function WP(r){if(!r.textureFloatRenderable)return!1;const e=new Nn(r,Mt.createDefinition(r,{name:"ptest1",vertexCode:J_,fragmentCode:zP})),t=new Nn(r,Mt.createDefinition(r,{name:"ptest2",vertexCode:J_,fragmentCode:VP})),s={format:rt,width:1,height:1,mipmaps:!1,minFilter:Ee,magFilter:Ee,name:"testFHP"},i=new _e(r,s),n=new Ct({colorBuffer:i,depth:!1});Q_(r,n,e),s.format=xe;const a=new _e(r,s),o=new Ct({colorBuffer:a,depth:!1});r.constantTexSource.setValue(i),Q_(r,o,t);const l=r.activeFramebuffer;r.setFramebuffer(o.impl._glFrameBuffer);const c=new Uint8Array(4);r.readPixels(0,0,1,1,c),r.setFramebuffer(l);const d=c[0]/255,h=c[1]/255,u=c[2]/255,f=c[3]/255,p=d/(256*256*256)+h/(256*256)+u/256+f;return i.destroy(),n.destroy(),a.destroy(),o.destroy(),e.destroy(),t.destroy(),p===0}class Sb extends ct{constructor(e,t={}){var s;super(e,t),this.gl=void 0,this._defaultFramebuffer=null,this._defaultFramebufferChanged=!1,t=this.initOptions,this.updateClientRect(),this.initTextureUnits(),this.contextLost=!1,this._contextLostHandler=_=>{_.preventDefault(),this.contextLost=!0,this.loseContext(),this.fire("devicelost")},this._contextRestoredHandler=()=>{this.contextLost=!1,this.restoreContext(),this.fire("devicerestored")};const i=typeof navigator<"u"&&navigator.userAgent;if(this.forceDisableMultisampling=i&&i.includes("AppleWebKit")&&(i.includes("15.4")||i.includes("15_4")),this.forceDisableMultisampling&&(t.antialias=!1),Te.browserName==="firefox"&&Te.name==="windows"){const m=(typeof navigator<"u"?navigator.userAgent:"").match(/Firefox\/(\d+(\.\d+)*)/),g=m?m[1]:null;if(g){const v=parseFloat(g);(v>=120||v===115)&&(t.antialias=!1)}}let n=null;if(this.backBufferAntialias=(s=t.antialias)!=null?s:!1,t.antialias=!1,t.gl)n=t.gl;else{const m=(t.preferWebGl2!==void 0?t.preferWebGl2:!0)?["webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"];for(let g=0;g<m.length&&(n=e.getContext(m[g],t),!n);g++);}if(!n)throw new Error("WebGL not supported");this.gl=n,this.isWebGL2=typeof WebGL2RenderingContext<"u"&&n instanceof WebGL2RenderingContext,this.isWebGL1=!this.isWebGL2,this._deviceType=this.isWebGL2?Zo:Yh,this.updateBackbufferFormat(null);const a=Te.browserName==="chrome",o=Te.browserName==="safari",l=Te.browser&&navigator.appVersion.indexOf("Mac")!==-1;this._tempEnableSafariTextureUnitWorkaround=o,this._tempMacChromeBlitFramebufferWorkaround=l&&a&&!t.alpha,e.addEventListener("webglcontextlost",this._contextLostHandler,!1),e.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.createBackbuffer(null),this.supportsImageBitmap=!o&&typeof ImageBitmap<"u",this._samplerTypes=new Set([n.SAMPLER_2D,n.SAMPLER_CUBE,...this.isWebGL2?[n.UNSIGNED_INT_SAMPLER_2D,n.INT_SAMPLER_2D,n.SAMPLER_2D_SHADOW,n.SAMPLER_CUBE_SHADOW,n.SAMPLER_3D,n.INT_SAMPLER_3D,n.UNSIGNED_INT_SAMPLER_3D,n.SAMPLER_2D_ARRAY,n.INT_SAMPLER_2D_ARRAY,n.UNSIGNED_INT_SAMPLER_2D_ARRAY]:[]]),this.glAddress=[n.REPEAT,n.CLAMP_TO_EDGE,n.MIRRORED_REPEAT],this.glBlendEquation=[n.FUNC_ADD,n.FUNC_SUBTRACT,n.FUNC_REVERSE_SUBTRACT,this.isWebGL2?n.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:n.FUNC_ADD,this.isWebGL2?n.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:n.FUNC_ADD],this.glBlendFunctionColor=[n.ZERO,n.ONE,n.SRC_COLOR,n.ONE_MINUS_SRC_COLOR,n.DST_COLOR,n.ONE_MINUS_DST_COLOR,n.SRC_ALPHA,n.SRC_ALPHA_SATURATE,n.ONE_MINUS_SRC_ALPHA,n.DST_ALPHA,n.ONE_MINUS_DST_ALPHA,n.CONSTANT_COLOR,n.ONE_MINUS_CONSTANT_COLOR],this.glBlendFunctionAlpha=[n.ZERO,n.ONE,n.SRC_COLOR,n.ONE_MINUS_SRC_COLOR,n.DST_COLOR,n.ONE_MINUS_DST_COLOR,n.SRC_ALPHA,n.SRC_ALPHA_SATURATE,n.ONE_MINUS_SRC_ALPHA,n.DST_ALPHA,n.ONE_MINUS_DST_ALPHA,n.CONSTANT_ALPHA,n.ONE_MINUS_CONSTANT_ALPHA],this.glComparison=[n.NEVER,n.LESS,n.EQUAL,n.LEQUAL,n.GREATER,n.NOTEQUAL,n.GEQUAL,n.ALWAYS],this.glStencilOp=[n.KEEP,n.ZERO,n.REPLACE,n.INCR,n.INCR_WRAP,n.DECR,n.DECR_WRAP,n.INVERT],this.glClearFlag=[0,n.COLOR_BUFFER_BIT,n.DEPTH_BUFFER_BIT,n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT,n.STENCIL_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.COLOR_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.DEPTH_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT],this.glCull=[0,n.BACK,n.FRONT,n.FRONT_AND_BACK],this.glFilter=[n.NEAREST,n.LINEAR,n.NEAREST_MIPMAP_NEAREST,n.NEAREST_MIPMAP_LINEAR,n.LINEAR_MIPMAP_NEAREST,n.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[n.POINTS,n.LINES,n.LINE_LOOP,n.LINE_STRIP,n.TRIANGLES,n.TRIANGLE_STRIP,n.TRIANGLE_FAN],this.glType=[n.BYTE,n.UNSIGNED_BYTE,n.SHORT,n.UNSIGNED_SHORT,n.INT,n.UNSIGNED_INT,n.FLOAT,n.HALF_FLOAT],this.pcUniformType={},this.pcUniformType[n.BOOL]=Sl,this.pcUniformType[n.INT]=$a,this.pcUniformType[n.FLOAT]=bi,this.pcUniformType[n.FLOAT_VEC2]=kr,this.pcUniformType[n.FLOAT_VEC3]=Rs,this.pcUniformType[n.FLOAT_VEC4]=Xa,this.pcUniformType[n.INT_VEC2]=ka,this.pcUniformType[n.INT_VEC3]=Ba,this.pcUniformType[n.INT_VEC4]=Na,this.pcUniformType[n.BOOL_VEC2]=Sc,this.pcUniformType[n.BOOL_VEC3]=xc,this.pcUniformType[n.BOOL_VEC4]=wc,this.pcUniformType[n.FLOAT_MAT2]=nf,this.pcUniformType[n.FLOAT_MAT3]=bc,this.pcUniformType[n.FLOAT_MAT4]=Ol,this.pcUniformType[n.SAMPLER_2D]=a1,this.pcUniformType[n.SAMPLER_CUBE]=o1,this.pcUniformType[n.UNSIGNED_INT]=Fl,this.pcUniformType[n.UNSIGNED_INT_VEC2]=kl,this.pcUniformType[n.UNSIGNED_INT_VEC3]=Bl,this.pcUniformType[n.UNSIGNED_INT_VEC4]=Nl,this.isWebGL2&&(this.pcUniformType[n.SAMPLER_2D_SHADOW]=l1,this.pcUniformType[n.SAMPLER_CUBE_SHADOW]=h1,this.pcUniformType[n.SAMPLER_2D_ARRAY]=d1,this.pcUniformType[n.SAMPLER_3D]=c1,this.pcUniformType[n.INT_SAMPLER_2D]=u1,this.pcUniformType[n.UNSIGNED_INT_SAMPLER_2D]=f1,this.pcUniformType[n.INT_SAMPLER_CUBE]=p1,this.pcUniformType[n.UNSIGNED_INT_SAMPLER_2D]=m1,this.pcUniformType[n.INT_SAMPLER_3D]=_1,this.pcUniformType[n.UNSIGNED_INT_SAMPLER_3D]=g1,this.pcUniformType[n.INT_SAMPLER_2D_ARRAY]=y1,this.pcUniformType[n.UNSIGNED_INT_SAMPLER_2D_ARRAY]=v1),this.targetToSlot={},this.targetToSlot[n.TEXTURE_2D]=0,this.targetToSlot[n.TEXTURE_CUBE_MAP]=1,this.targetToSlot[n.TEXTURE_3D]=2;let c,d,h,u,f;this.commitFunction=[],this.commitFunction[Sl]=function(_,m){_.value!==m&&(n.uniform1i(_.locationId,m),_.value=m)},this.commitFunction[$a]=this.commitFunction[Sl],this.commitFunction[bi]=function(_,m){_.value!==m&&(n.uniform1f(_.locationId,m),_.value=m)},this.commitFunction[kr]=function(_,m){f=_.value,c=m[0],d=m[1],(f[0]!==c||f[1]!==d)&&(n.uniform2fv(_.locationId,m),f[0]=c,f[1]=d)},this.commitFunction[Rs]=function(_,m){f=_.value,c=m[0],d=m[1],h=m[2],(f[0]!==c||f[1]!==d||f[2]!==h)&&(n.uniform3fv(_.locationId,m),f[0]=c,f[1]=d,f[2]=h)},this.commitFunction[Xa]=function(_,m){f=_.value,c=m[0],d=m[1],h=m[2],u=m[3],(f[0]!==c||f[1]!==d||f[2]!==h||f[3]!==u)&&(n.uniform4fv(_.locationId,m),f[0]=c,f[1]=d,f[2]=h,f[3]=u)},this.commitFunction[ka]=function(_,m){f=_.value,c=m[0],d=m[1],(f[0]!==c||f[1]!==d)&&(n.uniform2iv(_.locationId,m),f[0]=c,f[1]=d)},this.commitFunction[Sc]=this.commitFunction[ka],this.commitFunction[Ba]=function(_,m){f=_.value,c=m[0],d=m[1],h=m[2],(f[0]!==c||f[1]!==d||f[2]!==h)&&(n.uniform3iv(_.locationId,m),f[0]=c,f[1]=d,f[2]=h)},this.commitFunction[xc]=this.commitFunction[Ba],this.commitFunction[Na]=function(_,m){f=_.value,c=m[0],d=m[1],h=m[2],u=m[3],(f[0]!==c||f[1]!==d||f[2]!==h||f[3]!==u)&&(n.uniform4iv(_.locationId,m),f[0]=c,f[1]=d,f[2]=h,f[3]=u)},this.commitFunction[wc]=this.commitFunction[Na],this.commitFunction[nf]=function(_,m){n.uniformMatrix2fv(_.locationId,!1,m)},this.commitFunction[bc]=function(_,m){n.uniformMatrix3fv(_.locationId,!1,m)},this.commitFunction[Ol]=function(_,m){n.uniformMatrix4fv(_.locationId,!1,m)},this.commitFunction[Dp]=function(_,m){n.uniform1fv(_.locationId,m)},this.commitFunction[Op]=function(_,m){n.uniform2fv(_.locationId,m)},this.commitFunction[Fp]=function(_,m){n.uniform3fv(_.locationId,m)},this.commitFunction[Ay]=function(_,m){n.uniform4fv(_.locationId,m)},this.commitFunction[Fl]=function(_,m){_.value!==m&&(n.uniform1ui(_.locationId,m),_.value=m)},this.commitFunction[kl]=function(_,m){f=_.value,c=m[0],d=m[1],(f[0]!==c||f[1]!==d)&&(n.uniform2uiv(_.locationId,m),f[0]=c,f[1]=d)},this.commitFunction[Bl]=function(_,m){f=_.value,c=m[0],d=m[1],h=m[2],(f[0]!==c||f[1]!==d||f[2]!==h)&&(n.uniform3uiv(_.locationId,m),f[0]=c,f[1]=d,f[2]=h)},this.commitFunction[Nl]=function(_,m){f=_.value,c=m[0],d=m[1],h=m[2],u=m[3],(f[0]!==c||f[1]!==d||f[2]!==h||f[3]!==u)&&(n.uniform4uiv(_.locationId,m),f[0]=c,f[1]=d,f[2]=h,f[3]=u)},this.commitFunction[Ul]=function(_,m){n.uniform1iv(_.locationId,m)},this.commitFunction[kp]=function(_,m){n.uniform1uiv(_.locationId,m)},this.commitFunction[Bp]=this.commitFunction[Ul],this.commitFunction[zl]=function(_,m){n.uniform2iv(_.locationId,m)},this.commitFunction[Np]=function(_,m){n.uniform2uiv(_.locationId,m)},this.commitFunction[Up]=this.commitFunction[zl],this.commitFunction[Vl]=function(_,m){n.uniform3iv(_.locationId,m)},this.commitFunction[zp]=function(_,m){n.uniform3uiv(_.locationId,m)},this.commitFunction[Vp]=this.commitFunction[Vl],this.commitFunction[rf]=function(_,m){n.uniform4iv(_.locationId,m)},this.commitFunction[Py]=function(_,m){n.uniform4uiv(_.locationId,m)},this.commitFunction[My]=this.commitFunction[rf],this.commitFunction[ab]=function(_,m){n.uniformMatrix4fv(_.locationId,!1,m)},this.supportsBoneTextures=this.extTextureFloat&&this.maxVertexTextures>0;let p=this.vertexUniformsCount;p-=4*4,p-=8,p-=1,p-=4*4,this.boneLimit=Math.floor(p/3),this.boneLimit=Math.min(this.boneLimit,128),this.unmaskedRenderer==="Mali-450 MP"&&(this.boneLimit=34),this.constantTexSource=this.scope.resolve("source"),this.extTextureFloat?this.isWebGL2?this.textureFloatRenderable=!!this.extColorBufferFloat:this.textureFloatRenderable=Fv(n,n.FLOAT):this.textureFloatRenderable=!1,this.extColorBufferHalfFloat?this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat:this.extTextureHalfFloat?this.isWebGL2?this.textureHalfFloatRenderable=!!this.extColorBufferFloat:this.textureHalfFloatRenderable=Fv(n,this.extTextureHalfFloat.HALF_FLOAT_OES):this.textureHalfFloatRenderable=!1,this.supportsMorphTargetTexturesCore=this.maxPrecision==="highp"&&this.maxVertexTextures>=2,this.supportsDepthShadow=this.isWebGL2,this._textureFloatHighPrecision=void 0,this._textureHalfFloatUpdatable=void 0,this.areaLightLutFormat=xe,this.extTextureHalfFloat&&this.textureHalfFloatUpdatable&&this.extTextureHalfFloatLinear?this.areaLightLutFormat=yt:this.extTextureFloat&&this.extTextureFloatLinear&&(this.areaLightLutFormat=rt),this.postInit()}postInit(){super.postInit(),this.gpuProfiler=new UP(this)}destroy(){super.destroy();const e=this.gl;this.isWebGL2&&this.feedback&&e.deleteTransformFeedback(this.feedback),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,super.postDestroy()}createBackbuffer(e){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new Ct({name:"WebglFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.suppliedColorFramebuffer=e}updateBackbufferFormat(e){const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e);const s=this.gl.getParameter(this.gl.ALPHA_BITS);this.backBufferFormat=s?xe:Gn}updateBackbuffer(){const e=this.canvas.width!==this.backBufferSize.x||this.canvas.height!==this.backBufferSize.y;(this._defaultFramebufferChanged||e)&&(this._defaultFramebufferChanged&&this.updateBackbufferFormat(this._defaultFramebuffer),this._defaultFramebufferChanged=!1,this.backBufferSize.set(this.canvas.width,this.canvas.height),this.backBuffer.destroy(),this.createBackbuffer(this._defaultFramebuffer))}createVertexBufferImpl(e,t){return new AP}createIndexBufferImpl(e){return new PP(e)}createShaderImpl(e){return new DP(e)}createTextureImpl(e){return new OP}createRenderTargetImpl(e){return new kP}getPrecision(){const e=this.gl;let t="highp";if(e.getShaderPrecisionFormat){const s=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT),i=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT),n=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT),a=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT);if(s&&i&&n&&a){const o=s.precision>0&&n.precision>0,l=i.precision>0&&a.precision>0;o||(l?t="mediump":t="lowp")}}return t}getExtension(){for(let e=0;e<arguments.length;e++)if(this.supportedExtensions.indexOf(arguments[e])!==-1)return this.gl.getExtension(arguments[e]);return null}get extDisjointTimerQuery(){return this._extDisjointTimerQuery||this.isWebGL2&&(this._extDisjointTimerQuery=this.getExtension("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")),this._extDisjointTimerQuery}initializeExtensions(){var e;const t=this.gl;if(this.supportedExtensions=(e=t.getSupportedExtensions())!=null?e:[],this._extDisjointTimerQuery=null,this.isWebGL2)this.extBlendMinmax=!0,this.extDrawBuffers=!0,this.drawBuffers=t.drawBuffers.bind(t),this.extInstancing=!0,this.extStandardDerivatives=!0,this.extTextureFloat=!0,this.extTextureHalfFloat=!0,this.textureHalfFloatFilterable=!0,this.extTextureLod=!0,this.extUintElement=!0,this.extVertexArrayObject=!0,this.extColorBufferFloat=this.getExtension("EXT_color_buffer_float"),this.extDepthTexture=!0,this.textureRG11B10Renderable=!0;else{var s;if(this.extBlendMinmax=this.getExtension("EXT_blend_minmax"),this.extDrawBuffers=this.getExtension("WEBGL_draw_buffers"),this.extInstancing=this.getExtension("ANGLE_instanced_arrays"),this.drawBuffers=(s=this.extDrawBuffers)==null?void 0:s.drawBuffersWEBGL.bind(this.extDrawBuffers),this.extInstancing){const i=this.extInstancing;t.drawArraysInstanced=i.drawArraysInstancedANGLE.bind(i),t.drawElementsInstanced=i.drawElementsInstancedANGLE.bind(i),t.vertexAttribDivisor=i.vertexAttribDivisorANGLE.bind(i)}if(this.extStandardDerivatives=this.getExtension("OES_standard_derivatives"),this.extTextureFloat=this.getExtension("OES_texture_float"),this.extTextureLod=this.getExtension("EXT_shader_texture_lod"),this.extUintElement=this.getExtension("OES_element_index_uint"),this.extVertexArrayObject=this.getExtension("OES_vertex_array_object"),this.extVertexArrayObject){const i=this.extVertexArrayObject;t.createVertexArray=i.createVertexArrayOES.bind(i),t.deleteVertexArray=i.deleteVertexArrayOES.bind(i),t.isVertexArray=i.isVertexArrayOES.bind(i),t.bindVertexArray=i.bindVertexArrayOES.bind(i)}this.extColorBufferFloat=null,this.extDepthTexture=t.getExtension("WEBGL_depth_texture"),this.extTextureHalfFloat=this.getExtension("OES_texture_half_float"),this.extTextureHalfFloatLinear=this.getExtension("OES_texture_half_float_linear"),this.textureHalfFloatFilterable=!!this.extTextureHalfFloatLinear}this.extDebugRendererInfo=this.getExtension("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=this.getExtension("OES_texture_float_linear"),this.textureFloatFilterable=!!this.extTextureFloatLinear,this.extFloatBlend=this.getExtension("EXT_float_blend"),this.extTextureFilterAnisotropic=this.getExtension("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extCompressedTextureETC1=this.getExtension("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=this.getExtension("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=this.getExtension("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=this.getExtension("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureATC=this.getExtension("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=this.getExtension("WEBGL_compressed_texture_astc"),this.extParallelShaderCompile=this.getExtension("KHR_parallel_shader_compile"),this.extColorBufferHalfFloat=this.getExtension("EXT_color_buffer_half_float")}initializeCapabilities(){var e,t;const s=this.gl;let i;const n=typeof navigator<"u"?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();const a=s.getContextAttributes();this.supportsMsaa=(e=a==null?void 0:a.antialias)!=null?e:!1,this.supportsStencil=(t=a==null?void 0:a.stencil)!=null?t:!1,this.supportsInstancing=!!this.extInstancing,this.maxTextureSize=s.getParameter(s.MAX_TEXTURE_SIZE),this.maxCubeMapSize=s.getParameter(s.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=s.getParameter(s.MAX_RENDERBUFFER_SIZE),this.maxTextures=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=s.getParameter(s.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=s.getParameter(s.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=s.getParameter(s.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=s.getParameter(s.MAX_FRAGMENT_UNIFORM_VECTORS),this.isWebGL2?(this.maxDrawBuffers=s.getParameter(s.MAX_DRAW_BUFFERS),this.maxColorAttachments=s.getParameter(s.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=s.getParameter(s.MAX_3D_TEXTURE_SIZE),this.supportsMrt=!0,this.supportsVolumeTextures=!0):(i=this.extDrawBuffers,this.supportsMrt=!!i,this.maxDrawBuffers=i?s.getParameter(i.MAX_DRAW_BUFFERS_WEBGL):1,this.maxColorAttachments=i?s.getParameter(i.MAX_COLOR_ATTACHMENTS_WEBGL):1,this.maxVolumeSize=1),i=this.extDebugRendererInfo,this.unmaskedRenderer=i?s.getParameter(i.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=i?s.getParameter(i.UNMASKED_VENDOR_WEBGL):"";const o=/\bMali-G52+/,l=/SM-[a-zA-Z0-9]+/;this.supportsGpuParticles=!(this.unmaskedVendor==="ARM"&&n.match(l))&&!this.unmaskedRenderer.match(o),i=this.extTextureFilterAnisotropic,this.maxAnisotropy=i?s.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;const c=this.isWebGL2&&!this.forceDisableMultisampling;this.maxSamples=c?s.getParameter(s.MAX_SAMPLES):1,this.maxSamples=Math.min(this.maxSamples,4),this.samples=c&&this.backBufferAntialias?this.maxSamples:1,this.supportsAreaLights=this.isWebGL2||!Te.android,this.supportsTextureFetch=this.isWebGL2,this.maxTextures<=8&&(this.supportsAreaLights=!1)}initializeRenderState(){super.initializeRenderState();const e=this.gl;e.disable(e.BLEND),e.blendFunc(e.ONE,e.ZERO),e.blendEquation(e.FUNC_ADD),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.depthMask(!0),this.stencil=!1,e.disable(e.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=kn,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,e.stencilFunc(e.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=vl,this.stencilZfailFront=this.stencilZfailBack=vl,this.stencilZpassFront=this.stencilZpassBack=vl,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,this.isWebGL2&&(e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.RASTERIZER_DISCARD)),this.depthBiasEnabled=!1,e.disable(e.POLYGON_OFFSET_FILL),this.clearDepth=1,e.clearDepth(1),this.clearColor=new k(0,0,0,0),e.clearColor(0,0,0,0),this.clearStencil=0,e.clearStencil(0),this.isWebGL2?e.hint(e.FRAGMENT_SHADER_DERIVATIVE_HINT,e.NICEST):this.extStandardDerivatives&&e.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,e.NICEST),e.enable(e.SCISSOR_TEST),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),this.unpackFlipY=!1,e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.pixelStorei(e.UNPACK_ALIGNMENT,1)}initTextureUnits(e=16){this.textureUnits=[];for(let t=0;t<e;t++)this.textureUnits.push([null,null,null])}initializeContextCaches(){super.initializeContextCaches(),this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.initTextureUnits(this.maxCombinedTextures)}loseContext(){var e;this.backBufferSize.set(-1,-1);for(const t of this.shaders)t.loseContext();for(const t of this.textures)t.loseContext();for(const t of this.buffers)t.loseContext();for(const t of this.targets)t.loseContext();(e=this.gpuProfiler)==null||e.loseContext()}restoreContext(){var e;this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches();for(const t of this.shaders)t.restoreContext();for(const t of this.buffers)t.unlock();(e=this.gpuProfiler)==null||e.restoreContext()}setViewport(e,t,s,i){(this.vx!==e||this.vy!==t||this.vw!==s||this.vh!==i)&&(this.gl.viewport(e,t,s,i),this.vx=e,this.vy=t,this.vw=s,this.vh=i)}setScissor(e,t,s,i){(this.sx!==e||this.sy!==t||this.sw!==s||this.sh!==i)&&(this.gl.scissor(e,t,s,i),this.sx=e,this.sy=t,this.sw=s,this.sh=i)}setFramebuffer(e){if(this.activeFramebuffer!==e){const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e),this.activeFramebuffer=e}}copyRenderTarget(e,t,s,i){const n=this.gl;if(e===this.backBuffer&&(e=null),!this.isWebGL2&&i)return!1;if(s){if(t){if(e&&(!e._colorBuffer||!t._colorBuffer||e._colorBuffer._format!==t._colorBuffer._format))return!1}else if(!e._colorBuffer)return!1}if(i&&e&&!e._depth&&(!e._depthBuffer||!t._depthBuffer||e._depthBuffer._format!==t._depthBuffer._format))return!1;if(this.isWebGL2&&t){var a;const o=this.renderTarget;this.renderTarget=t,this.updateBegin();const l=e?e.impl._glFrameBuffer:(a=this.backBuffer)==null?void 0:a.impl._glFrameBuffer,c=t.impl._glFrameBuffer;n.bindFramebuffer(n.READ_FRAMEBUFFER,l),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,c);const d=e?e.width:t.width,h=e?e.height:t.height;n.blitFramebuffer(0,0,d,h,0,0,d,h,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0),n.NEAREST),this.renderTarget=o,n.bindFramebuffer(n.FRAMEBUFFER,o?o.impl._glFrameBuffer:null)}else{const o=this.getCopyShader();this.constantTexSource.setValue(e._colorBuffer),Q_(this,t,o)}return!0}getCopyShader(){return this._copyShader||(this._copyShader=new Nn(this,Mt.createDefinition(this,{name:"outputTex2D",vertexCode:J_,fragmentCode:GP}))),this._copyShader}frameStart(){super.frameStart(),this.updateBackbuffer(),this.gpuProfiler.frameStart()}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.gpuProfiler.request()}startRenderPass(e){var t;const s=(t=e.renderTarget)!=null?t:this.backBuffer;this.renderTarget=s,this.updateBegin();const{width:i,height:n}=s;this.setViewport(0,0,i,n),this.setScissor(0,0,i,n);const a=e.colorOps,o=e.depthStencilOps;if(a!=null&&a.clear||o.clearDepth||o.clearStencil){let l=0;const c={};a!=null&&a.clear&&(l|=Ml,c.color=[a.clearValue.r,a.clearValue.g,a.clearValue.b,a.clearValue.a]),o.clearDepth&&(l|=Il,c.depth=o.clearDepthValue),o.clearStencil&&(l|=yc,c.stencil=o.clearStencilValue),c.flags=l,this.clear(c)}this.insideRenderPass=!0}endRenderPass(e){this.unbindVertexArray();const t=this.renderTarget,s=e.colorArrayOps.length;if(t){var i;if(this.isWebGL2){So.length=0;const n=this.gl;for(let a=0;a<s;a++){const o=e.colorArrayOps[a];o.store||o.resolve||So.push(n.COLOR_ATTACHMENT0+a)}t!==this.backBuffer&&(e.depthStencilOps.storeDepth||So.push(n.DEPTH_ATTACHMENT),e.depthStencilOps.storeStencil||So.push(n.STENCIL_ATTACHMENT)),So.length>0&&e.fullSizeClearRect&&n.invalidateFramebuffer(n.DRAW_FRAMEBUFFER,So)}(i=e.colorOps)!=null&&i.resolve&&this.isWebGL2&&e.samples>1&&t.autoResolve&&t.resolve(!0,!1);for(let n=0;n<s;n++)if(e.colorArrayOps[n].mipmaps){const o=t._colorBuffers[n];o&&o.impl._glTexture&&o.mipmaps&&(o.pot||this.isWebGL2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(o),this.gl.generateMipmap(o.impl._glTarget))}}this.insideRenderPass=!1}set defaultFramebuffer(e){this._defaultFramebuffer!==e&&(this._defaultFramebuffer=e,this._defaultFramebufferChanged=!0)}get defaultFramebuffer(){return this._defaultFramebuffer}updateBegin(){var e;if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(let i=0;i<this.textureUnits.length;++i)for(let n=0;n<3;++n)this.textureUnits[i][n]=null;const t=(e=this.renderTarget)!=null?e:this.backBuffer,s=t.impl;s.initialized||this.initRenderTarget(t),this.setFramebuffer(s._glFrameBuffer)}updateEnd(){this.unbindVertexArray();const e=this.renderTarget;if(e&&e!==this.backBuffer){this.isWebGL2&&e._samples>1&&e.autoResolve&&e.resolve();const t=e._colorBuffer;t&&t.impl._glTexture&&t.mipmaps&&(t.pot||this.isWebGL2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(t),this.gl.generateMipmap(t.impl._glTarget))}}setUnpackFlipY(e){if(this.unpackFlipY!==e){this.unpackFlipY=e;const t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e)}}setUnpackPremultiplyAlpha(e){if(this.unpackPremultiplyAlpha!==e){this.unpackPremultiplyAlpha=e;const t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e)}}activeTexture(e){this.textureUnit!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.textureUnit=e)}bindTexture(e){const t=e.impl,s=t._glTarget,i=t._glTexture,n=this.textureUnit,a=this.targetToSlot[s];this.textureUnits[n][a]!==i&&(this.gl.bindTexture(s,i),this.textureUnits[n][a]=i)}bindTextureOnUnit(e,t){const s=e.impl,i=s._glTarget,n=s._glTexture,a=this.targetToSlot[i];this.textureUnits[t][a]!==n&&(this.activeTexture(t),this.gl.bindTexture(i,n),this.textureUnits[t][a]=n)}setTextureParameters(e){const t=this.gl,s=e.impl.dirtyParameterFlags,i=e.impl._glTarget;if(s&1){let n=e._minFilter;(!e.pot&&!this.isWebGL2||!e._mipmaps||e._compressed&&e._levels.length===1)&&(n===qc||n===Kc?n=Ee:(n===Yc||n===Or)&&(n=nt)),t.texParameteri(i,t.TEXTURE_MIN_FILTER,this.glFilter[n])}if(s&2&&t.texParameteri(i,t.TEXTURE_MAG_FILTER,this.glFilter[e._magFilter]),s&4&&(this.isWebGL2?t.texParameteri(i,t.TEXTURE_WRAP_S,this.glAddress[e._addressU]):t.texParameteri(i,t.TEXTURE_WRAP_S,this.glAddress[e.pot?e._addressU:ae])),s&8&&(this.isWebGL2?t.texParameteri(i,t.TEXTURE_WRAP_T,this.glAddress[e._addressV]):t.texParameteri(i,t.TEXTURE_WRAP_T,this.glAddress[e.pot?e._addressV:ae])),s&16&&this.isWebGL2&&t.texParameteri(i,t.TEXTURE_WRAP_R,this.glAddress[e._addressW]),s&32&&this.isWebGL2&&t.texParameteri(i,t.TEXTURE_COMPARE_MODE,e._compareOnRead?t.COMPARE_REF_TO_TEXTURE:t.NONE),s&64&&this.isWebGL2&&t.texParameteri(i,t.TEXTURE_COMPARE_FUNC,this.glComparison[e._compareFunc]),s&128){const n=this.extTextureFilterAnisotropic;n&&t.texParameterf(i,n.TEXTURE_MAX_ANISOTROPY_EXT,H.clamp(Math.round(e._anisotropy),1,this.maxAnisotropy))}}setTexture(e,t){const s=e.impl;s._glTexture||s.initialize(this,e),s.dirtyParameterFlags>0||e._needsUpload||e._needsMipmapsUpload?(this.activeTexture(t),this.bindTexture(e),s.dirtyParameterFlags&&(this.setTextureParameters(e),s.dirtyParameterFlags=0),(e._needsUpload||e._needsMipmapsUpload)&&(s.upload(this,e),e._needsUpload=!1,e._needsMipmapsUpload=!1)):this.bindTextureOnUnit(e,t)}createVertexArray(e){let t,s;const i=e.length>1;if(i){t="";for(let n=0;n<e.length;n++){const a=e[n];t+=a.id+a.format.renderingHash}s=this._vaoMap.get(t)}if(!s){const n=this.gl;s=n.createVertexArray(),n.bindVertexArray(s),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);for(let a=0;a<e.length;a++){const o=e[a];n.bindBuffer(n.ARRAY_BUFFER,o.impl.bufferId);const l=o.format.elements;for(let c=0;c<l.length;c++){const d=l[c],h=Le[d.name];d.asInt?n.vertexAttribIPointer(h,d.numComponents,this.glType[d.dataType],d.stride,d.offset):n.vertexAttribPointer(h,d.numComponents,this.glType[d.dataType],d.normalize,d.stride,d.offset),n.enableVertexAttribArray(h),o.format.instancing&&n.vertexAttribDivisor(h,1)}}n.bindVertexArray(null),n.bindBuffer(n.ARRAY_BUFFER,null),i&&this._vaoMap.set(t,s)}return s}unbindVertexArray(){this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null))}setBuffers(){const e=this.gl;let t;if(this.vertexBuffers.length===1){const i=this.vertexBuffers[0];i.impl.vao||(i.impl.vao=this.createVertexArray(this.vertexBuffers)),t=i.impl.vao}else t=this.createVertexArray(this.vertexBuffers);this.boundVao!==t&&(this.boundVao=t,e.bindVertexArray(t)),this.vertexBuffers.length=0;const s=this.indexBuffer?this.indexBuffer.impl.bufferId:null;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s)}draw(e,t,s){const i=this.gl;if(this.activateShader(this),!this.shaderValid)return;let n,a,o,l,c,d,h,u;const f=this.shader;if(!f)return;const p=f.impl.samplers,_=f.impl.uniforms;s||this.setBuffers();let m=0;for(let x=0,S=p.length;x<S;x++){if(n=p[x],a=n.scopeId.value,!a)return;if(a instanceof _e)o=a,this.setTexture(o,m),n.slot!==m&&(i.uniform1i(n.locationId,m),n.slot=m),m++;else{n.array.length=0,l=a.length;for(let w=0;w<l;w++)o=a[w],this.setTexture(o,m),n.array[w]=m,m++;i.uniform1iv(n.locationId,n.array)}}for(let x=0,S=_.length;x<S;x++)c=_[x],d=c.scopeId,h=c.version,u=d.versionObject.version,(h.globalId!==u.globalId||h.revision!==u.revision)&&(h.globalId=u.globalId,h.revision=u.revision,d.value!==null&&this.commitFunction[c.dataType](c,d.value));this.isWebGL2&&this.transformFeedbackBuffer&&(i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),i.beginTransformFeedback(i.POINTS));const g=this.glPrimitive[e.type],v=e.count;if(e.indexed){const x=this.indexBuffer,S=x.impl.glFormat,w=e.base*x.bytesPerIndex;t>0?i.drawElementsInstanced(g,v,S,w,t):i.drawElements(g,v,S,w)}else{const x=e.base;t>0?i.drawArraysInstanced(g,x,v,t):i.drawArrays(g,x,v)}this.isWebGL2&&this.transformFeedbackBuffer&&(i.endTransformFeedback(),i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}clear(e){var t;const s=this.defaultClearOptions;e=e||s;const i=(t=e.flags)!=null?t:s.flags;if(i!==0){const l=this.gl;if(i&Ml){var n;const c=(n=e.color)!=null?n:s.color,d=c[0],h=c[1],u=c[2],f=c[3],p=this.clearColor;(d!==p.r||h!==p.g||u!==p.b||f!==p.a)&&(this.gl.clearColor(d,h,u,f),this.clearColor.set(d,h,u,f)),this.setBlendState(Xe.NOBLEND)}if(i&Il){var a;const c=(a=e.depth)!=null?a:s.depth;c!==this.clearDepth&&(this.gl.clearDepth(c),this.clearDepth=c),this.setDepthState(kt.WRITEDEPTH)}if(i&yc){var o;const c=(o=e.stencil)!=null?o:s.stencil;c!==this.clearStencil&&(this.gl.clearStencil(c),this.clearStencil=c)}l.clear(this.glClearFlag[i])}}submit(){this.gl.flush()}readPixels(e,t,s,i,n){const a=this.gl;a.readPixels(e,t,s,i,a.RGBA,a.UNSIGNED_BYTE,n)}async readPixelsAsync(e,t,s,i,n){var a,o,l;const c=this.gl;if(!this.isWebGL2){this.readPixels(e,t,s,i,n);return}const d=(_,m)=>{const g=c.fenceSync(c.SYNC_GPU_COMMANDS_COMPLETE,0);return this.submit(),new Promise((v,x)=>{function S(){const w=c.clientWaitSync(g,_,0);w===c.WAIT_FAILED?(c.deleteSync(g),x(new Error("webgl clientWaitSync sync failed"))):w===c.TIMEOUT_EXPIRED?setTimeout(S,m):(c.deleteSync(g),v())}S()})},h=(a=this.renderTarget.colorBuffer)==null?void 0:a.impl,u=(o=h==null?void 0:h._glFormat)!=null?o:c.RGBA,f=(l=h==null?void 0:h._glPixelType)!=null?l:c.UNSIGNED_BYTE,p=c.createBuffer();c.bindBuffer(c.PIXEL_PACK_BUFFER,p),c.bufferData(c.PIXEL_PACK_BUFFER,n.byteLength,c.STREAM_READ),c.readPixels(e,t,s,i,u,f,0),c.bindBuffer(c.PIXEL_PACK_BUFFER,null),await d(0,20),c.bindBuffer(c.PIXEL_PACK_BUFFER,p),c.getBufferSubData(c.PIXEL_PACK_BUFFER,0,n),c.bindBuffer(c.PIXEL_PACK_BUFFER,null),c.deleteBuffer(p)}setAlphaToCoverage(e){this.isWebGL1||this.alphaToCoverage!==e&&(this.alphaToCoverage=e,e?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))}setTransformFeedbackBuffer(e){if(this.transformFeedbackBuffer!==e&&(this.transformFeedbackBuffer=e,this.isWebGL2)){const t=this.gl;e?(this.feedback||(this.feedback=t.createTransformFeedback()),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,this.feedback)):t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,null)}}setRaster(e){this.raster!==e&&(this.raster=e,this.isWebGL2&&(e?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))}setStencilTest(e){if(this.stencil!==e){const t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.stencil=e}}setStencilFunc(e,t,s){(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==s||this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==s)&&(this.gl.stencilFunc(this.glComparison[e],t,s),this.stencilFuncFront=this.stencilFuncBack=e,this.stencilRefFront=this.stencilRefBack=t,this.stencilMaskFront=this.stencilMaskBack=s)}setStencilFuncFront(e,t,s){if(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==s){const i=this.gl;i.stencilFuncSeparate(i.FRONT,this.glComparison[e],t,s),this.stencilFuncFront=e,this.stencilRefFront=t,this.stencilMaskFront=s}}setStencilFuncBack(e,t,s){if(this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==s){const i=this.gl;i.stencilFuncSeparate(i.BACK,this.glComparison[e],t,s),this.stencilFuncBack=e,this.stencilRefBack=t,this.stencilMaskBack=s}}setStencilOperation(e,t,s,i){(this.stencilFailFront!==e||this.stencilZfailFront!==t||this.stencilZpassFront!==s||this.stencilFailBack!==e||this.stencilZfailBack!==t||this.stencilZpassBack!==s)&&(this.gl.stencilOp(this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailFront=this.stencilFailBack=e,this.stencilZfailFront=this.stencilZfailBack=t,this.stencilZpassFront=this.stencilZpassBack=s),(this.stencilWriteMaskFront!==i||this.stencilWriteMaskBack!==i)&&(this.gl.stencilMask(i),this.stencilWriteMaskFront=i,this.stencilWriteMaskBack=i)}setStencilOperationFront(e,t,s,i){(this.stencilFailFront!==e||this.stencilZfailFront!==t||this.stencilZpassFront!==s)&&(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailFront=e,this.stencilZfailFront=t,this.stencilZpassFront=s),this.stencilWriteMaskFront!==i&&(this.gl.stencilMaskSeparate(this.gl.FRONT,i),this.stencilWriteMaskFront=i)}setStencilOperationBack(e,t,s,i){(this.stencilFailBack!==e||this.stencilZfailBack!==t||this.stencilZpassBack!==s)&&(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailBack=e,this.stencilZfailBack=t,this.stencilZpassBack=s),this.stencilWriteMaskBack!==i&&(this.gl.stencilMaskSeparate(this.gl.BACK,i),this.stencilWriteMaskBack=i)}setBlendState(e){const t=this.blendState;if(!t.equals(e)){const s=this.gl,{blend:i,colorOp:n,alphaOp:a,colorSrcFactor:o,colorDstFactor:l,alphaSrcFactor:c,alphaDstFactor:d}=e;if(t.blend!==i&&(i?s.enable(s.BLEND):s.disable(s.BLEND)),t.colorOp!==n||t.alphaOp!==a){const h=this.glBlendEquation;s.blendEquationSeparate(h[n],h[a])}(t.colorSrcFactor!==o||t.colorDstFactor!==l||t.alphaSrcFactor!==c||t.alphaDstFactor!==d)&&s.blendFuncSeparate(this.glBlendFunctionColor[o],this.glBlendFunctionColor[l],this.glBlendFunctionAlpha[c],this.glBlendFunctionAlpha[d]),t.allWrite!==e.allWrite&&this.gl.colorMask(e.redWrite,e.greenWrite,e.blueWrite,e.alphaWrite),t.copy(e)}}setBlendColor(e,t,s,i){const n=this.blendColor;(e!==n.r||t!==n.g||s!==n.b||i!==n.a)&&(this.gl.blendColor(e,t,s,i),n.set(e,t,s,i))}setStencilState(e,t){if(e||t)if(this.setStencilTest(!0),e===t)this.setStencilFunc(e.func,e.ref,e.readMask),this.setStencilOperation(e.fail,e.zfail,e.zpass,e.writeMask);else{var s,i;(s=e)!=null||(e=oi.DEFAULT),this.setStencilFuncFront(e.func,e.ref,e.readMask),this.setStencilOperationFront(e.fail,e.zfail,e.zpass,e.writeMask),(i=t)!=null||(t=oi.DEFAULT),this.setStencilFuncBack(t.func,t.ref,t.readMask),this.setStencilOperationBack(t.fail,t.zfail,t.zpass,t.writeMask)}else this.setStencilTest(!1)}setDepthState(e){const t=this.depthState;if(!t.equals(e)){const s=this.gl,i=e.write;t.write!==i&&s.depthMask(i);let{func:n,test:a}=e;!a&&i&&(a=!0,n=kn),t.func!==n&&s.depthFunc(this.glComparison[n]),t.test!==a&&(a?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST));const{depthBias:o,depthBiasSlope:l}=e;o||l?(this.depthBiasEnabled||(this.depthBiasEnabled=!0,this.gl.enable(this.gl.POLYGON_OFFSET_FILL)),s.polygonOffset(l,o)):this.depthBiasEnabled&&(this.depthBiasEnabled=!1,this.gl.disable(this.gl.POLYGON_OFFSET_FILL)),t.copy(e)}}setCullMode(e){if(this.cullMode!==e){if(e===Et)this.gl.disable(this.gl.CULL_FACE);else{this.cullMode===Et&&this.gl.enable(this.gl.CULL_FACE);const t=this.glCull[e];this.cullFace!==t&&(this.gl.cullFace(t),this.cullFace=t)}this.cullMode=e}}setShader(e,t=!1){e!==this.shader&&(this.shader=e,this.shaderAsyncCompile=t,this.shaderValid=void 0)}activateShader(e){const{shader:t}=this,{impl:s}=t;this.shaderValid===void 0&&(t.failed?this.shaderValid=!1:t.ready||(this.shaderAsyncCompile?s.isLinked(e)?s.finalize(this,t)||(t.failed=!0,this.shaderValid=!1):this.shaderValid=!1:s.finalize(this,t)||(t.failed=!0,this.shaderValid=!1))),this.shaderValid===void 0&&(this.gl.useProgram(s.glProgram),this.shaderValid=!0)}clearVertexArrayObjectCache(){const e=this.gl;this._vaoMap.forEach((t,s,i)=>{e.deleteVertexArray(t)}),this._vaoMap.clear()}set fullscreen(e){e?this.gl.canvas.requestFullscreen():document.exitFullscreen()}get fullscreen(){return!!document.fullscreenElement}get textureFloatHighPrecision(){return this._textureFloatHighPrecision===void 0&&(this._textureFloatHighPrecision=WP(this)),this._textureFloatHighPrecision}get textureHalfFloatUpdatable(){return this._textureHalfFloatUpdatable===void 0&&(this.isWebGL2?this._textureHalfFloatUpdatable=!0:this._textureHalfFloatUpdatable=HP(this.gl,this.extTextureHalfFloat.HALF_FLOAT_OES)),this._textureHalfFloatUpdatable}}class jP{unlock(e){}}class $P{destroy(e){}init(e,t){}loseContext(){}resolve(e,t,s,i){}}class XP{destroy(e){}loseContext(){}restoreContext(e,t){}}class qP{destroy(e){}propertyChanged(e){}loseContext(){}}class KP{destroy(e){}unlock(e){}}class YP extends ct{constructor(e,t={}){super(e,t),t=this.initOptions,this.isNull=!0,this._deviceType=Bu,this.samples=1}destroy(){super.destroy()}initDeviceCaps(){this.disableParticleSystem=!0,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=4096,this.maxCubeMapSize=4096,this.maxVolumeSize=4096,this.maxColorAttachments=8,this.maxPixelRatio=1,this.maxAnisotropy=16,this.supportsInstancing=!0,this.supportsUniformBuffers=!1,this.supportsVolumeTextures=!0,this.supportsBoneTextures=!0,this.supportsMorphTargetTexturesCore=!0,this.supportsAreaLights=!0,this.supportsDepthShadow=!0,this.supportsGpuParticles=!1,this.supportsMrt=!0,this.extUintElement=!0,this.extTextureFloat=!0,this.textureFloatRenderable=!0,this.extTextureHalfFloat=!0,this.textureHalfFloatRenderable=!0,this.textureHalfFloatUpdatable=!0,this.boneLimit=1024,this.supportsImageBitmap=!0,this.extStandardDerivatives=!0,this.extBlendMinmax=!0,this.areaLightLutFormat=xe,this.supportsTextureFetch=!0}postInit(){super.postInit()}frameStart(){super.frameStart()}frameEnd(){super.frameEnd()}updateBegin(){}updateEnd(){}readPixels(e,t,s,i,n){}createVertexBufferImpl(e,t){return new KP(e,t)}createIndexBufferImpl(e){return new jP(e)}createShaderImpl(e){return new XP(e)}createTextureImpl(e){return new qP(e)}createRenderTargetImpl(e){return new $P(e)}draw(e,t=1,s){}setShader(e,t=!1){}setBlendState(e){}setDepthState(e){}setStencilState(e,t){}setBlendColor(e,t,s,i){}setCullMode(e){}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches()}clear(e){}setViewport(e,t,s,i){}setScissor(e,t,s,i){}copyRenderTarget(e,t,s,i){return!0}}function ZP(r,e={}){var t;const s=(t=e.deviceTypes)!=null?t:[];if(s.includes(Zo)||s.push(Zo),s.includes(Yh)||s.push(Yh),s.includes(Bu)||s.push(Bu),Te.browser&&navigator.xr){var i;(i=e.xrCompatible)!=null||(e.xrCompatible=!0)}const n=[];for(let o=0;o<s.length;o++){var a;const l=s[o];l===lb&&(a=window)!=null&&(a=a.navigator)!=null&&a.gpu&&n.push(()=>new EP(r,e).initWebGpu(e.glslangUrl,e.twgslUrl)),(l===Yh||l===Zo)&&n.push(()=>(e.preferWebGl2=l===Zo,new Sb(r,e))),l===Bu&&n.push(()=>new YP(r,e))}return new Promise((o,l)=>{let c=0;const d=()=>{c>=n.length?l(new Error("Failed to create a graphics device")):Promise.resolve(n[c++]()).then(h=>{h?o(h):d()}).catch(h=>{console.log(h),d()})};d()})}let JP=0;class Br{constructor(e,t,s,i=as,n){this.device=e,this.format=t,this.numIndices=s,this.usage=i,this.id=JP++,this.impl=e.createIndexBufferImpl(this);const a=w1[t];this.bytesPerIndex=a,this.numBytes=this.numIndices*a,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.adjustVramSizeTracking(e._vram,this.numBytes),this.device.buffers.push(this)}destroy(){const e=this.device,t=e.buffers.indexOf(this);t!==-1&&e.buffers.splice(t,1),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.ib+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength!==this.numBytes?!1:(this.storage=e,this.unlock(),!0)}_lockTypedArray(){const e=this.lock();return this.format===Fr?new Uint32Array(e):this.format===ai?new Uint16Array(e):new Uint8Array(e)}writeData(e,t){const s=this._lockTypedArray();if(e.length>t)if(ArrayBuffer.isView(e))e=e.subarray(0,t),s.set(e);else for(let i=0;i<t;i++)s[i]=e[i];else s.set(e);this.unlock()}readData(e){const t=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(e))e.set(t);else{e.length=0;for(let i=0;i<s;i++)e[i]=t[i]}return s}}class QP{constructor(){this.clearValue=new k(0,0,0,1),this.clear=!1,this.store=!1,this.resolve=!0,this.mipmaps=!1}}class eM{constructor(){this.clearDepthValue=1,this.clearStencilValue=0,this.clearDepth=!1,this.clearStencil=!1,this.storeDepth=!1,this.storeStencil=!1}}class Hs{get colorOps(){return this.colorArrayOps[0]}constructor(e){this._name=void 0,this.device=void 0,this._enabled=!0,this.executeEnabled=!0,this.renderTarget=void 0,this._options=void 0,this.samples=0,this.colorArrayOps=[],this.depthStencilOps=void 0,this.requiresCubemaps=!0,this.fullSizeClearRect=!0,this.beforePasses=[],this.afterPasses=[],this.device=e}set name(e){this._name=e}get name(){return this._name||(this._name=this.constructor.name),this._name}set options(e){if(this._options=e,e){var t,s;this._options.scaleX=(t=this._options.scaleX)!=null?t:1,this._options.scaleY=(s=this._options.scaleY)!=null?s:1}}get options(){return this._options}init(e=null,t=null){var s;this.options=t,this.renderTarget=e,this.samples=Math.max(this.renderTarget?this.renderTarget.samples:this.device.samples,1),this.depthStencilOps=new eM;const i=e?(s=e._colorBuffers)==null?void 0:s.length:1;this.colorArrayOps.length=0;for(let a=0;a<i;a++){var n;const o=new QP;this.colorArrayOps[a]=o,this.samples===1&&(o.store=!0,o.resolve=!1),(n=this.renderTarget)!=null&&(n=n._colorBuffers)!=null&&n[a].mipmaps&&(o.mipmaps=!0)}this.postInit()}destroy(){}postInit(){}frameUpdate(){if(this._options&&this.renderTarget){var e;const t=(e=this._options.resizeSource)!=null?e:this.device.backBuffer,s=Math.floor(t.width*this._options.scaleX),i=Math.floor(t.height*this._options.scaleY);this.renderTarget.resize(s,i)}}before(){}execute(){}after(){}onEnable(){}onDisable(){}set enabled(e){this._enabled!==e&&(this._enabled=e,e?this.onEnable():this.onDisable())}get enabled(){return this._enabled}setClearColor(e){const t=this.colorArrayOps.length;for(let s=0;s<t;s++){const i=this.colorArrayOps[s];e&&i.clearValue.copy(e),i.clear=!!e}}setClearDepth(e){e&&(this.depthStencilOps.clearDepthValue=e),this.depthStencilOps.clearDepth=e!==void 0}setClearStencil(e){e&&(this.depthStencilOps.clearStencilValue=e),this.depthStencilOps.clearStencil=e!==void 0}render(){if(this.enabled){const e=this.device,t=this.renderTarget!==void 0;this.before(),this.executeEnabled&&(t&&e.startRenderPass(this),this.execute(),t&&e.endRenderPass(this)),this.after(),e.renderPassIndex++}}}class lo{constructor(e,t,s){this.uniformFormats=[],this.bindGroupFormats=[],this.vertexFormat=void 0,this.uniformFormats[K_]=e,this.bindGroupFormats[K_]=t,this.vertexFormat=s}hasUniform(e){for(let t=0;t<this.uniformFormats.length;t++){const s=this.uniformFormats[t];if(s!=null&&s.get(e))return!0}return!1}hasTexture(e){for(let t=0;t<this.bindGroupFormats.length;t++){const s=this.bindGroupFormats[t];if(s!=null&&s.getTexture(e))return!0}return!1}getVertexElement(e){var t;return(t=this.vertexFormat)==null?void 0:t.elements.find(s=>s.name===e)}generateKey(e){let t=JSON.stringify(this.uniformFormats)+JSON.stringify(this.bindGroupFormats);if(e.isWebGPU){var s;t+=(s=this.vertexFormat)==null?void 0:s.shaderProcessingHashString}return t}}function tM(r){this.array[this.index]=r}function sM(r,e){this.array[this.index]=r,this.array[this.index+1]=e}function iM(r,e,t){this.array[this.index]=r,this.array[this.index+1]=e,this.array[this.index+2]=t}function nM(r,e,t,s){this.array[this.index]=r,this.array[this.index+1]=e,this.array[this.index+2]=t,this.array[this.index+3]=s}function rM(r,e,t){this.array[r]=e[t]}function aM(r,e,t){this.array[r]=e[t],this.array[r+1]=e[t+1]}function oM(r,e,t){this.array[r]=e[t],this.array[r+1]=e[t+1],this.array[r+2]=e[t+2]}function lM(r,e,t){this.array[r]=e[t],this.array[r+1]=e[t+1],this.array[r+2]=e[t+2],this.array[r+3]=e[t+3]}function hM(r,e,t){e[t]=this.array[r]}function cM(r,e,t){e[t]=this.array[r],e[t+1]=this.array[r+1]}function dM(r,e,t){e[t]=this.array[r],e[t+1]=this.array[r+1],e[t+2]=this.array[r+2]}function uM(r,e,t){e[t]=this.array[r],e[t+1]=this.array[r+1],e[t+2]=this.array[r+2],e[t+3]=this.array[r+3]}class fM{constructor(e,t,s){switch(this.index=0,this.numComponents=t.numComponents,s.interleaved?this.array=new xl[t.dataType](e,t.offset):this.array=new xl[t.dataType](e,t.offset,s.vertexCount*t.numComponents),this.stride=t.stride/this.array.constructor.BYTES_PER_ELEMENT,t.numComponents){case 1:this.set=tM,this.getToArray=hM,this.setFromArray=rM;break;case 2:this.set=sM,this.getToArray=cM,this.setFromArray=aM;break;case 3:this.set=iM,this.getToArray=dM,this.setFromArray=oM;break;case 4:this.set=nM,this.getToArray=uM,this.setFromArray=lM;break}}get(e){return this.array[this.index+e]}set(e,t,s,i){}getToArray(e,t,s){}setFromArray(e,t,s){}}class Jh{constructor(e){this.vertexBuffer=e,this.vertexFormatSize=e.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};const t=this.vertexBuffer.getFormat();for(let s=0;s<t.elements.length;s++){const i=t.elements[s];this.accessors[s]=new fM(this.buffer,i,t),this.element[i.name]=this.accessors[s]}}next(e=1){let t=0;const s=this.accessors,i=this.accessors.length;for(;t<i;){const n=s[t++];n.index+=e*n.stride}}end(){this.vertexBuffer.unlock()}writeData(e,t,s){const i=this.element[e];if(i){s>this.vertexBuffer.numVertices&&(s=this.vertexBuffer.numVertices);const n=i.numComponents;if(this.vertexBuffer.getFormat().interleaved){let a=0;for(let o=0;o<s;o++)i.setFromArray(a,t,o*n),a+=i.stride}else if(t.length>s*n){const a=s*n;if(ArrayBuffer.isView(t))t=t.subarray(0,a),i.array.set(t);else for(let o=0;o<a;o++)i.array[o]=t[o]}else i.array.set(t)}}readData(e,t){const s=this.element[e];let i=0;if(s){i=this.vertexBuffer.numVertices;let n;const a=s.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(t)&&(t.length=0),s.index=0;let o=0;for(n=0;n<i;n++)s.getToArray(o,t,n*a),o+=s.stride}else if(ArrayBuffer.isView(t))t.set(s.array);else{t.length=0;const o=i*a;for(n=0;n<o;n++)t[n]=s.array[n]}}return i}}const Ry="mousedown",Ly="mousemove",Dy="mouseup",Oy="mousewheel",pM="touchstart",mM="touchend",_M="touchmove",gM="touchcancel",yM=-1,vM=0,SM=1,xM=2,wM=3,bM=4,TM=5,EM=6,CM=7,AM=8,PM=9,MM=10,IM=11,RM=12,LM=13,DM=14,OM=15,FM=16,kM=0,BM=1,NM=2,UM=3,zM="gamepadconnected",VM="gamepaddisconnected",GM=0,HM=1,WM=2,jM=3,$M=2,XM=0,qM=1,KM=3,YM=4,ZM=5;class JM{constructor(e,t){t?(this.key=t.keyCode,this.element=t.target,this.event=t):(this.key=null,this.element=null,this.event=null)}}const Gd=new JM;function wm(r){return Gd.key=r.keyCode,Gd.element=r.target,Gd.event=r,Gd}function Hd(r){return typeof r=="string"?r.toUpperCase().charCodeAt(0):r}const QM={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"};class Fy extends ie{constructor(e,t={}){super(),this._element=null,this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),this._visibilityChangeHandler=this._handleVisibilityChange.bind(this),this._windowBlurHandler=this._handleWindowBlur.bind(this),this._keymap={},this._lastmap={},e&&this.attach(e),this.preventDefault=t.preventDefault||!1,this.stopPropagation=t.stopPropagation||!1}attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1),document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.addEventListener("blur",this._windowBlurHandler,!1)}detach(){this._element&&(this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.removeEventListener("blur",this._windowBlurHandler,!1))}toKeyIdentifier(e){e=Hd(e);const t=QM[e.toString()];if(t)return t;let s=e.toString(16).toUpperCase();const i=s.length;for(let n=0;n<4-i;n++)s="0"+s;return"U+"+s}_handleKeyDown(e){const t=e.keyCode||e.charCode;if(t===void 0)return;const s=this.toKeyIdentifier(t);this._keymap[s]=!0,this.fire("keydown",wm(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleKeyUp(e){const t=e.keyCode||e.charCode;if(t===void 0)return;const s=this.toKeyIdentifier(t);delete this._keymap[s],this.fire("keyup",wm(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleKeyPress(e){this.fire("keypress",wm(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleVisibilityChange(){document.visibilityState==="hidden"&&this._handleWindowBlur()}_handleWindowBlur(){this._keymap={},this._lastmap={}}update(){for(const e in this._lastmap)delete this._lastmap[e];for(const e in this._keymap)this._keymap.hasOwnProperty(e)&&(this._lastmap[e]=this._keymap[e])}isPressed(e){const t=Hd(e),s=this.toKeyIdentifier(t);return!!this._keymap[s]}wasPressed(e){const t=Hd(e),s=this.toKeyIdentifier(t);return!!this._keymap[s]&&!this._lastmap[s]}wasReleased(e){const t=Hd(e),s=this.toKeyIdentifier(t);return!this._keymap[s]&&!!this._lastmap[s]}}Fy.EVENT_KEYDOWN="keydown";Fy.EVENT_KEYUP="keyup";function eg(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}let zh=class xb{constructor(e,t){let s={x:0,y:0};if(t){if(t instanceof xb)throw Error("Expected MouseEvent");s=e._getTargetCoords(t)}else t={};if(s)this.x=s.x,this.y=s.y;else if(eg())this.x=0,this.y=0;else return;this.wheelDelta=0,t.type==="wheel"&&(t.deltaY>0?this.wheelDelta=1:t.deltaY<0&&(this.wheelDelta=-1)),eg()?(this.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,this.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(this.dx=this.x-e._lastX,this.dy=this.y-e._lastY),t.type==="mousedown"||t.type==="mouseup"?this.button=t.button:this.button=yM,this.buttons=e._buttons.slice(0),this.element=t.target,this.ctrlKey=t.ctrlKey||!1,this.altKey=t.altKey||!1,this.shiftKey=t.shiftKey||!1,this.metaKey=t.metaKey||!1,this.event=t}};class Nr extends ie{constructor(e){super(),this._lastX=0,this._lastY=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=t=>{t.preventDefault()},this._target=null,this._attached=!1,this.attach(e)}static isPointerLocked(){return eg()}attach(e){if(this._target=e,this._attached)return;this._attached=!0;const t=Te.passiveEvents?{passive:!1}:!1;window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t)}detach(){if(!this._attached)return;this._attached=!1,this._target=null;const e=Te.passiveEvents?{passive:!1}:!1;window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)}disableContextMenu(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)}enableContextMenu(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)}enablePointerLock(e,t){if(!document.body.requestPointerLock){t&&t();return}const s=()=>{e(),document.removeEventListener("pointerlockchange",s)},i=()=>{t(),document.removeEventListener("pointerlockerror",i)};e&&document.addEventListener("pointerlockchange",s,!1),t&&document.addEventListener("pointerlockerror",i,!1),document.body.requestPointerLock()}disablePointerLock(e){if(!document.exitPointerLock)return;const t=()=>{e(),document.removeEventListener("pointerlockchange",t)};e&&document.addEventListener("pointerlockchange",t,!1),document.exitPointerLock()}update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]}isPressed(e){return this._buttons[e]}wasPressed(e){return this._buttons[e]&&!this._lastbuttons[e]}wasReleased(e){return!this._buttons[e]&&this._lastbuttons[e]}_handleUp(e){this._buttons[e.button]=!1;const t=new zh(this,e);t.event&&this.fire(Dy,t)}_handleDown(e){this._buttons[e.button]=!0;const t=new zh(this,e);t.event&&this.fire(Ry,t)}_handleMove(e){const t=new zh(this,e);t.event&&(this.fire(Ly,t),this._lastX=t.x,this._lastY=t.y)}_handleWheel(e){const t=new zh(this,e);t.event&&this.fire(Oy,t)}_getTargetCoords(e){const t=this._target.getBoundingClientRect(),s=Math.floor(t.left),i=Math.floor(t.top);return e.clientX<s||e.clientX>=s+this._target.clientWidth||e.clientY<i||e.clientY>=i+this._target.clientHeight?null:{x:e.clientX-s,y:e.clientY-i}}}Nr.EVENT_MOUSEMOVE=Ly;Nr.EVENT_MOUSEDOWN=Ry;Nr.EVENT_MOUSEUP=Dy;Nr.EVENT_MOUSEWHEEL=Oy;const wb=Object.freeze([]);let tg=function(){return wb};typeof navigator<"u"&&(tg=(navigator.getGamepads||navigator.webkitGetGamepads||tg).bind(navigator));const kv={buttons:{PAD_FACE_1:vM,PAD_FACE_2:SM,PAD_FACE_3:xM,PAD_FACE_4:wM,PAD_L_SHOULDER_1:bM,PAD_R_SHOULDER_1:TM,PAD_L_SHOULDER_2:EM,PAD_R_SHOULDER_2:CM,PAD_SELECT:AM,PAD_START:PM,PAD_L_STICK_BUTTON:MM,PAD_R_STICK_BUTTON:IM,PAD_UP:RM,PAD_DOWN:LM,PAD_LEFT:DM,PAD_RIGHT:OM,PAD_VENDOR:FM,XRPAD_TRIGGER:XM,XRPAD_SQUEEZE:qM,XRPAD_TOUCHPAD_BUTTON:$M,XRPAD_STICK_BUTTON:KM,XRPAD_A:YM,XRPAD_B:ZM},axes:{PAD_L_STICK_X:kM,PAD_L_STICK_Y:BM,PAD_R_STICK_X:NM,PAD_R_STICK_Y:UM,XRPAD_TOUCHPAD_X:GM,XRPAD_TOUCHPAD_Y:HM,XRPAD_STICK_X:WM,XRPAD_STICK_Y:jM}},ch={DEFAULT:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},DEFAULT_DUAL:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],synthesizedButtons:{PAD_UP:{axis:0,min:0,max:1},PAD_DOWN:{axis:0,min:-1,max:0},PAD_LEFT:{axis:0,min:-1,max:0},PAD_RIGHT:{axis:0,min:0,max:1}}},PS3:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_4","PAD_FACE_3","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],mapping:"standard"},DEFAULT_XR:{buttons:["XRPAD_TRIGGER","XRPAD_SQUEEZE","XRPAD_TOUCHPAD_BUTTON","XRPAD_STICK_BUTTON","XRPAD_A","XRPAD_B"],axes:["XRPAD_TOUCHPAD_X","XRPAD_TOUCHPAD_Y","XRPAD_STICK_X","XRPAD_STICK_Y"],mapping:"xr-standard"}},Bv={"Product: 0268":"PS3"},Nu={};function bb(r){const e=Nu[r.id];if(e)return e;for(const i in Bv)if(r.id.indexOf(i)!==-1){const n=Bv[i];if(!r.mapping){const a=ch["RAW_"+n];if(a)return a}return ch[n]}if(r.mapping==="xr-standard")return ch.DEFAULT_XR;const t=ch.DEFAULT,s=r.buttons.length<t.buttons.length?ch.DEFAULT_DUAL:t;return s.mapping=r.mapping,s}let sg=.25;function eI(r){return new Promise(e=>{setTimeout(e,r)})}class ig{constructor(e,t){if(this.value=0,this.pressed=!1,this.touched=!1,this.wasPressed=!1,this.wasReleased=!1,this.wasTouched=!1,typeof e=="number")this.value=e,this.pressed=e===1,this.touched=e>0;else{var s;this.value=e.value,this.pressed=e.pressed,this.touched=(s=e.touched)!=null?s:e.value>0}if(t)if(typeof t=="number")this.wasPressed=t!==1&&this.pressed,this.wasReleased=t===1&&!this.pressed,this.wasTouched=t===0&&this.touched;else{var i;this.wasPressed=!t.pressed&&this.pressed,this.wasReleased=t.pressed&&!this.pressed,this.wasTouched=!((i=t.touched)!=null?i:t.value>0)&&this.touched}}update(e){var t;const{value:s,pressed:i}=e,n=(t=e.touched)!=null?t:s>0;this.wasPressed=!this.pressed&&i,this.wasReleased=this.pressed&&!i,this.wasTouched=!this.touched&&n,this.value=s,this.pressed=i,this.touched=n}}const bm=Object.freeze(new ig(0));class Nv{constructor(e,t){this._compiledMapping={buttons:[],axes:[]},this.id=e.id,this.index=e.index,this._buttons=e.buttons.map(s=>new ig(s)),this._axes=[...e.axes],this._previousAxes=[...e.axes],this.mapping=t.mapping,this.map=t,this.hand=e.hand||"none",this.pad=e,this._compileMapping()}get connected(){return this.pad.connected}_compileMapping(){const{axes:e,buttons:t}=this._compiledMapping,s=kv.axes,i=kv.buttons;e.length=0,t.length=0,this.map.axes&&this.map.axes.forEach((l,c)=>{e[s[l]]=()=>this.pad.axes[c]||0});for(let l=0,c=e.length;l<c;l++)e[l]||(e[l]=()=>0);const a=this.map.buttons;a&&a.forEach((l,c)=>{t[i[l]]=()=>this._buttons[c]||bm});const o=this.map.synthesizedButtons;o&&Object.entries(o).forEach(l=>{const{axis:c,max:d,min:h}=l[1];t[i[l[0]]]=()=>{var u,f;return new ig(Math.abs(H.clamp((u=this._axes[c])!=null?u:0,h,d)),Math.abs(H.clamp((f=this._previousAxes[c])!=null?f:0,h,d)))}});for(let l=0,c=t.length;l<c;l++)t[l]||(t[l]=()=>bm)}update(e){this.pad=e;const t=this._previousAxes,s=this._axes;t.length=0,t.push(...s),s.length=0,s.push(...e.axes);const i=this._buttons;for(let n=0,a=i.length;n<a;n++)i[n].update(e.buttons[n]);return this}updateMap(e){e.mapping="custom",Nu[this.id]=e,this.map=e,this.mapping="custom",this._compileMapping()}resetMap(){if(Nu[this.id]){delete Nu[this.id];const e=bb(this.pad);this.map=e,this.mapping=e.mapping,this._compileMapping()}}get axes(){return this._compiledMapping.axes.map(e=>e())}get buttons(){return this._compiledMapping.buttons.map(e=>e())}async pulse(e,t,s){const i=this.pad.vibrationActuator?[this.pad.vibrationActuator]:this.pad.hapticActuators||wb;if(i.length){var n,a,o;const l=(n=s==null?void 0:s.startDelay)!=null?n:0,c=(a=s==null?void 0:s.strongMagnitude)!=null?a:e,d=(o=s==null?void 0:s.weakMagnitude)!=null?o:e;return(await Promise.all(i.map(async function(u){return u?u.playEffect?u.playEffect(u.type,{duration:t,startDelay:l,strongMagnitude:c,weakMagnitude:d}):u.pulse?(await eI(l),u.pulse(e,t)):!1:!0}))).some(u=>u===!0||u==="complete")}return!1}getButton(e){const t=this._compiledMapping.buttons[e];return t?t():bm}isPressed(e){return this.getButton(e).pressed}wasPressed(e){return this.getButton(e).wasPressed}wasReleased(e){return this.getButton(e).wasReleased}isTouched(e){return this.getButton(e).touched}wasTouched(e){return this.getButton(e).wasTouched}getValue(e){return this.getButton(e).value}getAxis(e){const t=this.axes[e];return t&&Math.abs(t)>sg?t:0}}class Tb extends ie{constructor(){super(),this.gamepadsSupported=Te.gamepads,this.current=[],this._previous=[],this._ongamepadconnectedHandler=this._ongamepadconnected.bind(this),this._ongamepaddisconnectedHandler=this._ongamepaddisconnected.bind(this),window.addEventListener("gamepadconnected",this._ongamepadconnectedHandler,!1),window.addEventListener("gamepaddisconnected",this._ongamepaddisconnectedHandler,!1),this.poll()}set deadZone(e){sg=e}get deadZone(){return sg}get previous(){const e=this.current;for(let t=0,s=e.length;t<s;t++){const i=e[t]._buttons;this._previous[t]||(this._previous[t]=[]);for(let n=0,a=i.length;n<a;n++){const o=i[t];this.previous[t][n]=o?!o.wasPressed&&o.pressed||o.wasReleased:!1}}return this._previous.length=this.current.length,this._previous}_ongamepadconnected(e){const t=new Nv(e.gamepad,this.getMap(e.gamepad)),s=this.current;let i=s.findIndex(n=>n.index===t.index);for(;i!==-1;)s.splice(i,1),i=s.findIndex(n=>n.index===t.index);s.push(t),this.fire(zM,t)}_ongamepaddisconnected(e){const t=this.current,s=t.findIndex(i=>i.index===e.gamepad.index);s!==-1&&(this.fire(VM,t[s]),t.splice(s,1))}update(){this.poll()}poll(e=[]){e.length>0&&(e.length=0);const t=tg();for(let s=0,i=t.length;s<i;s++)if(t[s]){const n=this.findByIndex(t[s].index);if(n)e.push(n.update(t[s]));else{const a=new Nv(t[s],this.getMap(t[s]));this.current.push(a),e.push(a)}}return e}destroy(){window.removeEventListener("gamepadconnected",this._ongamepadconnectedHandler,!1),window.removeEventListener("gamepaddisconnected",this._ongamepaddisconnectedHandler,!1)}getMap(e){return bb(e)}isPressed(e,t){var s;return((s=this.current[e])==null?void 0:s.isPressed(t))||!1}wasPressed(e,t){var s;return((s=this.current[e])==null?void 0:s.wasPressed(t))||!1}wasReleased(e,t){var s;return((s=this.current[e])==null?void 0:s.wasReleased(t))||!1}getAxis(e,t){var s;return((s=this.current[e])==null?void 0:s.getAxis(t))||0}pulse(e,t,s,i){const n=this.current[e];return n?n.pulse(t,s,i):Promise.resolve(!1)}pulseAll(e,t,s){return Promise.all(this.current.map(i=>i.pulse(e,t,s)))}findById(e){return this.current.find(t=>t&&t.id===e)||null}findByIndex(e){return this.current.find(t=>t&&t.index===e)||null}}Tb.EVENT_GAMEPADCONNECTED="gamepadconnected";Tb.EVENT_GAMEPADDISCONNECTED="gamepaddisconnected";function tI(r){let e=0,t=0,s=r.target;for(;!(s instanceof HTMLElement);)s=s.parentNode;let i=s;do e+=i.offsetLeft-i.scrollLeft,t+=i.offsetTop-i.scrollTop,i=i.offsetParent;while(i);return{x:r.pageX-e,y:r.pageY-t}}let Uv=class{constructor(e){const t=tI(e);this.id=e.identifier,this.x=t.x,this.y=t.y,this.target=e.target,this.touch=e}},Vh=class{constructor(e,t){if(this.element=t.target,this.event=t,this.touches=[],this.changedTouches=[],t){for(let s=0,i=t.touches.length;s<i;s++)this.touches.push(new Uv(t.touches[s]));for(let s=0,i=t.changedTouches.length;s<i;s++)this.changedTouches.push(new Uv(t.changedTouches[s]))}}getTouchById(e,t){for(let s=0,i=t.length;s<i;s++)if(t[s].id===e)return t[s];return null}};class sI extends ie{constructor(e){super(),this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(e)}attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)}detach(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null}_handleTouchStart(e){this.fire("touchstart",new Vh(this,e))}_handleTouchEnd(e){this.fire("touchend",new Vh(this,e))}_handleTouchMove(e){e.preventDefault(),this.fire("touchmove",new Vh(this,e))}_handleTouchCancel(e){this.fire("touchcancel",new Vh(this,e))}}class be{get(e,t,s){return typeof t=="function"&&(s=t,t={}),this.request("GET",e,t,s)}post(e,t,s,i){return typeof s=="function"&&(i=s,s={}),s.postdata=t,this.request("POST",e,s,i)}put(e,t,s,i){return typeof s=="function"&&(i=s,s={}),s.postdata=t,this.request("PUT",e,s,i)}del(e,t,s){return typeof t=="function"&&(s=t,t={}),this.request("DELETE",e,t,s)}request(e,t,s,i){let n,a,o,l=!1;if(typeof s=="function"&&(i=s,s={}),s.retry&&(s=Object.assign({retries:0,maxRetries:5},s)),s.callback=i,s.async==null&&(s.async=!0),s.headers==null&&(s.headers={}),s.postdata!=null)if(s.postdata instanceof Document)o=s.postdata;else if(s.postdata instanceof FormData)o=s.postdata;else if(s.postdata instanceof Object){let d=s.headers["Content-Type"];switch(d===void 0&&(s.headers["Content-Type"]=be.ContentType.FORM_URLENCODED,d=s.headers["Content-Type"]),d){case be.ContentType.FORM_URLENCODED:{o="";let h=!0;for(const u in s.postdata)if(s.postdata.hasOwnProperty(u)){h?h=!1:o+="&";const f=encodeURIComponent(u),p=encodeURIComponent(s.postdata[u]);o+=`${f}=${p}`}break}default:case be.ContentType.JSON:d==null&&(s.headers["Content-Type"]=be.ContentType.JSON),o=JSON.stringify(s.postdata);break}}else o=s.postdata;if(s.cache===!1){const d=Zi();n=new pm(t),n.query?n.query=n.query+"&ts="+d:n.query="ts="+d,t=n.toString()}s.query&&(n=new pm(t),a=Cr(n.getQuery(),s.query),n.setQuery(a),t=n.toString());const c=new XMLHttpRequest;c.open(e,t,s.async),c.withCredentials=s.withCredentials!==void 0?s.withCredentials:!1,c.responseType=s.responseType||this._guessResponseType(t);for(const d in s.headers)s.headers.hasOwnProperty(d)&&c.setRequestHeader(d,s.headers[d]);c.onreadystatechange=()=>{this._onReadyStateChange(e,t,s,c)},c.onerror=()=>{this._onError(e,t,s,c),l=!0};try{c.send(o)}catch(d){l||s.error(c.status,c,d)}return c}_guessResponseType(e){const t=new pm(e),s=me.getExtension(t.path).toLowerCase();return be.binaryExtensions.indexOf(s)>=0?be.ResponseType.ARRAY_BUFFER:s===".json"?be.ResponseType.JSON:s===".xml"?be.ResponseType.DOCUMENT:be.ResponseType.TEXT}_isBinaryContentType(e){return[be.ContentType.BASIS,be.ContentType.BIN,be.ContentType.DDS,be.ContentType.GLB,be.ContentType.MP3,be.ContentType.MP4,be.ContentType.OGG,be.ContentType.OPUS,be.ContentType.WAV].indexOf(e)>=0}_isBinaryResponseType(e){return e===be.ResponseType.ARRAY_BUFFER||e===be.ResponseType.BLOB||e===be.ResponseType.JSON}_onReadyStateChange(e,t,s,i){if(i.readyState===4)switch(i.status){case 0:{i.responseURL&&i.responseURL.startsWith("file:///")?this._onSuccess(e,t,s,i):this._onError(e,t,s,i);break}case 200:case 201:case 206:case 304:{this._onSuccess(e,t,s,i);break}default:{this._onError(e,t,s,i);break}}}_onSuccess(e,t,s,i){let n,a;const o=i.getResponseHeader("Content-Type");o&&(a=o.split(";")[0].trim());try{this._isBinaryContentType(a)||this._isBinaryResponseType(i.responseType)?n=i.response:a===be.ContentType.JSON||t.split("?")[0].endsWith(".json")?n=JSON.parse(i.responseText):i.responseType===be.ResponseType.DOCUMENT||a===be.ContentType.XML?n=i.responseXML:n=i.responseText,s.callback(null,n)}catch(l){s.callback(l)}}_onError(e,t,s,i){if(!s.retrying)if(s.retry&&s.retries<s.maxRetries){s.retries++,s.retrying=!0;const n=H.clamp(Math.pow(2,s.retries)*be.retryDelay,0,s.maxRetryDelay||5e3);console.log(`${e}: ${t} - Error ${i.status}. Retrying in ${n} ms`),setTimeout(()=>{s.retrying=!1,this.request(e,t,s,s.callback)},n)}else s.callback(i.status===0?"Network error":i.status,null)}}be.ContentType={AAC:"audio/aac",BASIS:"image/basis",BIN:"application/octet-stream",DDS:"image/dds",FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",GLB:"model/gltf-binary",JPEG:"image/jpeg",JSON:"application/json",MP3:"audio/mpeg",MP4:"audio/mp4",OGG:"audio/ogg",OPUS:'audio/ogg; codecs="opus"',PNG:"image/png",TEXT:"text/plain",WAV:"audio/x-wav",XML:"application/xml"};be.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"};be.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".opus"];be.retryDelay=100;const at=new be;function jn(){return typeof AudioContext<"u"||typeof webkitAudioContext<"u"}class af{constructor(e,t,s={}){var i,n,a;if(this.volume=(i=s.volume)!=null?i:1,this.loop=(n=s.loop)!=null?n:!1,this.pitch=(a=s.pitch)!=null?a:1,this.sound=t,this.paused=!1,this.suspended=!1,this.manager=e,this.source=null,jn()){this.startTime=0,this.startOffset=0;const o=e.context;this.gain=o.createGain()}else t.audio&&(this.source=t.audio.cloneNode(!1),this.source.pause())}getVolume(){return this.volume}getLoop(){return this.loop}setLoop(e){this.loop=e,this.source&&(this.source.loop=e)}getPitch(){return this.pitch}onManagerVolumeChange(){this.setVolume(this.getVolume())}onManagerSuspend(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())}onManagerResume(){this.suspended&&(this.suspended=!1,this.unpause())}play(){if(this.source)throw new Error("Call stop() before calling play()");this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend())}pause(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)}unpause(){if(this.source||!this.paused){console.warn("Call pause() before unpausing.");return}this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1)}stop(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)}setVolume(e){e=H.clamp(e,0,1),this.volume=e,this.gain&&(this.gain.gain.value=e*this.manager.volume)}setPitch(e){this.pitch=e,this.source&&(this.source.playbackRate.value=e)}isPlaying(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE}getDuration(){return this.source?this.source.buffer.duration:0}_createSource(){const e=this.manager.context;this.sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this)))}}jn()||Object.assign(af.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(r){r=H.clamp(r,0,1),this.volume=r,this.source&&(this.source.volume=r*this.manager.volume)},setPitch:function(r){this.pitch=r,this.source&&(this.source.playbackRate=r)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}});const iI=1e4;class Tr extends af{constructor(e,t,s){super(e,t,s),this.position=new y,this.velocity=new y,jn()?this.panner=e.context.createPanner():(this.maxDistance=iI,this.minDistance=1,this.rollOffFactor=1,this.distanceModel=rp)}getPosition(){return this.position}setPosition(e){this.position.copy(e);const t=this.panner;"positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z)}getVelocity(){return this.velocity}setVelocity(e){this.velocity.copy(e)}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(e){this.panner.maxDistance=e}getMinDistance(){return this.panner.refDistance}setMinDistance(e){this.panner.refDistance=e}getRollOffFactor(){return this.panner.rolloffFactor}setRollOffFactor(e){this.panner.rolloffFactor=e}getDistanceModel(){return this.panner.distanceModel}setDistanceModel(e){this.panner.distanceModel=e}_createSource(){const e=this.manager.context;this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this))}}if(!jn()){let r=new y;const e=function(s,i,n,a,o,l){r=r.sub2(s,i);const c=r.length();if(c<n)return 1;if(c>a)return 0;let d=0;return l===np?d=1-o*(c-n)/(a-n):l===rp?d=n/(n+o*(c-n)):l===Qw&&(d=Math.pow(c/n,-o)),H.clamp(d,0,1)};Object.assign(Tr.prototype,{setPosition:function(t){if(this.position.copy(t),this.source){const i=this.manager.listener.getPosition(),n=e(i,this.position,this.minDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),a=this.getVolume();this.source.volume=a*n}},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(t){this.maxDistance=t},getMinDistance:function(){return this.minDistance},setMinDistance:function(t){this.minDistance=t},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(t){this.rollOffFactor=t},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(t){this.distanceModel=t}})}class nI{constructor(e){this._manager=e,this.position=new y,this.velocity=new y,this.orientation=new q}getPosition(){return this.position}setPosition(e){this.position.copy(e);const t=this.listener;t&&("positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z))}getVelocity(){return this.velocity}setVelocity(e){}setOrientation(e){this.orientation.copy(e);const t=this.listener;if(t){const s=e.data;"forwardX"in t?(t.forwardX.value=-s[8],t.forwardY.value=-s[9],t.forwardZ.value=-s[10],t.upX.value=s[4],t.upY.value=s[5],t.upZ.value=s[6]):t.setOrientation&&t.setOrientation(-s[8],-s[9],-s[10],s[4],s[5],s[6])}}getOrientation(){return this.orientation}get listener(){const e=this._manager.context;return e?e.listener:null}}const Wd="running",zv=["click","touchstart","mousedown"];let Xp=class extends ie{constructor(){super(),this._context=null,this.AudioContext=typeof AudioContext<"u"&&AudioContext||typeof webkitAudioContext<"u"&&webkitAudioContext,this.AudioContext,this._unlockHandlerFunc=this._unlockHandler.bind(this),this._userSuspended=!1,this.listener=new nI(this),this._volume=1}set volume(e){e=H.clamp(e,0,1),this._volume=e,this.fire("volumechange",e)}get volume(){return this._volume}get suspended(){return this._userSuspended}get context(){return!this._context&&this.AudioContext&&(this._context=new this.AudioContext,this._context.state!==Wd&&this._registerUnlockListeners()),this._context}suspend(){this._userSuspended||(this._userSuspended=!0,this._context&&this._context.state===Wd&&this._suspend())}resume(){this._userSuspended&&(this._userSuspended=!1,this._context&&this._context.state!==Wd&&this._resume())}destroy(){if(this.fire("destroy"),this._context){var e;this._removeUnlockListeners(),(e=this._context)==null||e.close(),this._context=null}}playSound(e,t={}){let s=null;return af&&(s=new af(this,e,t),s.play()),s}playSound3d(e,t,s={}){let i=null;return Tr&&(i=new Tr(this,e,s),i.setPosition(t),s.volume&&i.setVolume(s.volume),s.loop&&i.setLoop(s.loop),s.maxDistance&&i.setMaxDistance(s.maxDistance),s.minDistance&&i.setMinDistance(s.minDistance),s.rollOffFactor&&i.setRollOffFactor(s.rollOffFactor),s.distanceModel&&i.setDistanceModel(s.distanceModel),i.play()),i}_resume(){this._context.resume().then(()=>{const e=this._context.createBufferSource();e.buffer=this._context.createBuffer(1,1,this._context.sampleRate),e.connect(this._context.destination),e.start(0),e.onended=t=>{e.disconnect(0),this.fire("resume")}},e=>{}).catch(e=>{})}_suspend(){this._context.suspend().then(()=>{this.fire("suspend")},e=>{}).catch(e=>{})}_unlockHandler(){this._removeUnlockListeners(),!this._userSuspended&&this._context.state!==Wd&&this._resume()}_registerUnlockListeners(){zv.forEach(e=>{window.addEventListener(e,this._unlockHandlerFunc,!1)})}_removeUnlockListeners(){zv.forEach(e=>{window.removeEventListener(e,this._unlockHandlerFunc,!1)})}},rI=class{constructor(e){this.audio=void 0,this.buffer=void 0,e instanceof Audio?this.audio=e:this.buffer=e}get duration(){let e=0;return this.buffer?e=this.buffer.duration:this.audio&&(e=this.audio.duration),e||0}};const hs=0,Jo=1,yi=2;function cs(r,e){return r%e||0}class ri extends ie{constructor(e,t,s){super(),this.source=null,this._manager=e,this._volume=s.volume!==void 0?H.clamp(Number(s.volume)||0,0,1):1,this._pitch=s.pitch!==void 0?Math.max(.01,Number(s.pitch)||0):1,this._loop=!!(s.loop!==void 0&&s.loop),this._sound=t,this._state=yi,this._suspended=!1,this._suspendEndEvent=0,this._suspendInstanceEvents=!1,this._playWhenLoaded=!0,this._startTime=Math.max(0,Number(s.startTime)||0),this._duration=Math.max(0,Number(s.duration)||0),this._startOffset=null,this._onPlayCallback=s.onPlay,this._onPauseCallback=s.onPause,this._onResumeCallback=s.onResume,this._onStopCallback=s.onStop,this._onEndCallback=s.onEnd,jn()?(this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._inputNode=null,this._connectorNode=null,this._firstNode=null,this._lastNode=null,this._waitingContextSuspension=!1,this._initializeNodes(),this._endedHandler=this._onEnded.bind(this)):(this._isReady=!1,this._loadedMetadataHandler=this._onLoadedMetadata.bind(this),this._timeUpdateHandler=this._onTimeUpdate.bind(this),this._endedHandler=this._onEnded.bind(this),this._createSource())}set currentTime(e){if(!(e<0))if(this._state===hs){const t=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this.stop(),this._startOffset=e,this.play(),this._suspendInstanceEvents=t}else this._startOffset=e,this._currentTime=e}get currentTime(){return this._startOffset!==null?this._startOffset:this._state===Jo?this._currentTime:this._state===yi||!this.source?0:(this._updateCurrentTime(),this._currentTime)}set duration(e){this._duration=Math.max(0,Number(e)||0);const t=this._state===hs;this.stop(),t&&this.play()}get duration(){return this._sound?this._duration?cs(this._duration,this._sound.duration):this._sound.duration:0}get isPaused(){return this._state===Jo}get isPlaying(){return this._state===hs}get isStopped(){return this._state===yi}get isSuspended(){return this._suspended}set loop(e){this._loop=!!e,this.source&&(this.source.loop=this._loop)}get loop(){return this._loop}set pitch(e){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}get pitch(){return this._pitch}set sound(e){this._sound=e,this._state!==yi?this.stop():this._createSource()}get sound(){return this._sound}set startTime(e){this._startTime=Math.max(0,Number(e)||0);const t=this._state===hs;this.stop(),t&&this.play()}get startTime(){return this._startTime}set volume(e){e=H.clamp(e,0,1),this._volume=e,this.gain&&(this.gain.gain.value=e*this._manager.volume)}get volume(){return this._volume}_onPlay(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)}_onPause(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)}_onResume(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)}_onStop(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)}_onEnded(){if(this._suspendEndEvent>0){this._suspendEndEvent--;return}this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop()}_onManagerVolumeChange(){this.volume=this._volume}_onManagerSuspend(){this._state===hs&&!this._suspended&&(this._suspended=!0,this.pause())}_onManagerResume(){this._suspended&&(this._suspended=!1,this.resume())}_initializeNodes(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}play(){return this._state!==yi&&this.stop(),this._state=hs,this._playWhenLoaded=!1,this._waitingContextSuspension?!1:this._manager.suspended?(this._manager.once("resume",this._playAudioImmediate,this),this._waitingContextSuspension=!0,!1):(this._playAudioImmediate(),!0)}_playAudioImmediate(){if(this._waitingContextSuspension=!1,this._state!==hs)return;this.source||this._createSource();let e=cs(this._startOffset,this.duration);e=cs(this._startTime+e,this._sound.duration),this._startOffset=null,this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._suspendInstanceEvents||this._onPlay()}pause(){return this._playWhenLoaded=!1,this._state!==hs?!1:(this._state=Jo,this._waitingContextSuspension||(this._updateCurrentTime(),this._suspendEndEvent++,this.source.stop(0),this.source=null,this._startOffset=null,this._suspendInstanceEvents||this._onPause()),!0)}resume(){if(this._state!==Jo)return!1;let e=this.currentTime;return this._state=hs,this._waitingContextSuspension||(this.source||this._createSource(),this._startOffset!==null&&(e=cs(this._startOffset,this.duration),e=cs(this._startTime+e,this._sound.duration),this._startOffset=null),this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume()),!0}stop(){if(this._playWhenLoaded=!1,this._state===yi)return!1;const e=this._state===hs;return this._state=yi,this._waitingContextSuspension||(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._suspendEndEvent++,e&&this.source&&this.source.stop(0),this.source=null,this._suspendInstanceEvents||this._onStop()),!0}setExternalNodes(e,t){if(!e){console.error("The firstNode must be a valid Audio Node");return}t||(t=e);const s=this._manager.context.destination;this._firstNode!==e&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(s),this._firstNode=e,this._connectorNode.connect(e)),this._lastNode!==t&&(this._lastNode&&this._lastNode.disconnect(s),this._lastNode=t,this._lastNode.connect(s))}clearExternalNodes(){const e=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(e),this._lastNode=null),this._connectorNode.connect(e)}getExternalNodes(){return[this._firstNode,this._lastNode]}_createSource(){if(!this._sound)return null;const e=this._manager.context;return this._sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=cs(this._startTime,this.source.buffer.duration),this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,cs(this._startTime+this._duration,this.source.buffer.duration)))),this.source}_updateCurrentTime(){this._currentTime=cs((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset,this.duration)}_onManagerDestroy(){this.source&&this._state===hs&&(this.source.stop(0),this.source=null)}}ri.EVENT_PLAY="play";ri.EVENT_PAUSE="pause";ri.EVENT_RESUME="resume";ri.EVENT_STOP="stop";ri.EVENT_END="end";jn()||(Object.assign(ri.prototype,{play:function(){return this._state!==yi&&this.stop(),!this.source&&!this._createSource()?!1:(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=hs,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0)},pause:function(){return!this.source||this._state!==hs?!1:(this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=!1,this._state=Jo,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){return!this.source||this._state!==Jo?!1:(this._state=hs,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),!0)},stop:function(){return!this.source||this._state===yi?!1:(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=!1,this._state=yi,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;let r=cs(this._startOffset,this.duration);r=cs(this._startTime+r,this._sound.duration),this._startOffset=null,this.source.currentTime=r},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>cs(this._startTime+this._duration,this.source.duration)&&(this.loop?this.source.currentTime=cs(this._startTime,this.source.duration):(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(ri.prototype,"volume",{get:function(){return this._volume},set:function(r){r=H.clamp(r,0,1),this._volume=r,this.source&&(this.source.volume=r*this._manager.volume)}}),Object.defineProperty(ri.prototype,"pitch",{get:function(){return this._pitch},set:function(r){this._pitch=Math.max(Number(r)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(ri.prototype,"sound",{get:function(){return this._sound},set:function(r){this.stop(),this._sound=r}}),Object.defineProperty(ri.prototype,"currentTime",{get:function(){return this._startOffset!==null?this._startOffset:this._state===yi||!this.source?0:this.source.currentTime-this._startTime},set:function(r){r<0||(this._startOffset=r,this.source&&this._isReady&&(this.source.currentTime=cs(this._startTime+cs(r,this.duration),this._sound.duration),this._startOffset=null))}}));const aI=1e4;class Xo extends ri{constructor(e,t,s={}){super(e,t,s),this._position=new y,this._velocity=new y,s.position&&(this.position=s.position),this.maxDistance=s.maxDistance!==void 0?Number(s.maxDistance):aI,this.refDistance=s.refDistance!==void 0?Number(s.refDistance):1,this.rollOffFactor=s.rollOffFactor!==void 0?Number(s.rollOffFactor):1,this.distanceModel=s.distanceModel!==void 0?s.distanceModel:np}_initializeNodes(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}set position(e){this._position.copy(e);const t=this.panner;"positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z)}get position(){return this._position}set velocity(e){this._velocity.copy(e)}get velocity(){return this._velocity}set maxDistance(e){this.panner.maxDistance=e}get maxDistance(){return this.panner.maxDistance}set refDistance(e){this.panner.refDistance=e}get refDistance(){return this.panner.refDistance}set rollOffFactor(e){this.panner.rolloffFactor=e}get rollOffFactor(){return this.panner.rolloffFactor}set distanceModel(e){this.panner.distanceModel=e}get distanceModel(){return this.panner.distanceModel}}if(!jn()){let r=new y;const e=function(s,i,n,a,o,l){r=r.sub2(s,i);const c=r.length();if(c<n)return 1;if(c>a)return 0;let d=0;return l===np?d=1-o*(c-n)/(a-n):l===rp?d=n/(n+o*(c-n)):l===Qw&&(d=Math.pow(c/n,-o)),H.clamp(d,0,1)};Object.defineProperty(Xo.prototype,"position",{get:function(){return this._position},set:function(t){if(this._position.copy(t),this.source){const i=this._manager.listener.getPosition(),n=e(i,this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),a=this.volume;this.source.volume=a*n*this._manager.volume}}}),Object.defineProperty(Xo.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(t){this._maxDistance=t}}),Object.defineProperty(Xo.prototype,"refDistance",{get:function(){return this._refDistance},set:function(t){this._refDistance=t}}),Object.defineProperty(Xo.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(t){this._rollOffFactor=t}}),Object.defineProperty(Xo.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(t){this._distanceModel=t}})}const Eb=0,ky=1,Bt=2,ms=3,qa=4,By=5,Ny=6,Cb=7,Ab=8,Pb=9,Mb=10,qp="none",oI="linear",Uy=2,lI=0,hI=2,Ib=15,Ws=0,_s=1,zy=2,Ti=3,Kp=4,fe=0,Oe=1,Ge=2,Ut=0,cI=1,dI=2,uI=3,Vy=0,fI=1,xt=0,ei=1,Si=2,si=3,wi=4,Wi=5,ss=6,jr={};jr[xt]="PCF3";jr[ei]="VSM8";jr[Si]="VSM16";jr[si]="VSM32";jr[wi]="PCF5";jr[Wi]="PCF1";jr[ss]="PCSS";const Gy=1,ng=0,Rb=0,zi=0,Lb=1,Uu=0,pI=1,Gi=0,Ua=1,Qh=0,ua=1,jd=2,Db=0,mI=1,tn=0,yd=1,Vv="mul",vd=0,Hy=1,_I=2,Sd=3,xd=0,gI=1,yI=2,vI=3,SI=4,xI=0,Cc=1,rg=2,of=1,Ac=2,Ob=4,Fb=8,kb=16,Pc=32,lf=64,Wy=128,Mc=256,jy=512,Ic=1024,Rc=2048,Lc=4096,$y=8192,Ci=0,Ka=1,Xy=2,Rn=0,ag=1,Fs=1,ji=2,$i=4,wd=0,sn=1,Xi=2,bd=3,Bb=4,hf=5,Pn=0,wt=1,mt=2,zu=1,$d=0,Vu=0,wI=1,bI=2,Gv=3,TI=4,EI=5,qy=0,og=1,pe=0,Pe=1,Gu="infinite",CI="box",AI="dome",gs="none",Hv="bayer8";class Ky{constructor(){this._refCount=0}incRefCount(){this._refCount++}decRefCount(){this._refCount--}get refCount(){return this._refCount}}let PI=0;class Hi{constructor(){this.initDefaults()}initDefaults(){this.recreate=!1,this.verticesUsage=as,this.indicesUsage=as,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null}_changeVertexCount(e,t){this.vertexCount||(this.vertexCount=e)}}Hi.DEFAULT_COMPONENTS_POSITION=3;Hi.DEFAULT_COMPONENTS_NORMAL=3;Hi.DEFAULT_COMPONENTS_UV=2;Hi.DEFAULT_COMPONENTS_COLORS=4;class MI{constructor(e,t,s,i){this.data=e,this.componentCount=t,this.dataType=s,this.dataTypeNormalize=i}}class Vs extends Ky{constructor(e){super(),this._aabbVer=0,this._aabb=new Re,this.id=PI++,this.device=e,this.vertexBuffer=null,this.indexBuffer=[null],this.primitive=[{type:0,base:0,count:0}],this.skin=null,this._morph=null,this._geometryData=null,this.boneAabb=null}set morph(e){e!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=e,e&&e.incRefCount())}get morph(){return this._morph}set aabb(e){this._aabb=e,this._aabbVer++}get aabb(){return this._aabb}destroy(){const e=this.morph;e&&(this.morph=null,e.refCount<1&&e.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(let t=0;t<this.indexBuffer.length;t++)this._destroyIndexBuffer(t);this.indexBuffer.length=0,this._geometryData=null}_destroyIndexBuffer(e){this.indexBuffer[e]&&(this.indexBuffer[e].destroy(),this.indexBuffer[e]=null)}_initBoneAabbs(e){this.boneAabb=[],this.boneUsed=[];let t,s,i,n,a;const o=[],l=[],c=this.boneUsed,d=this.skin.boneNames.length;let h,u,f;for(let S=0;S<d;S++)o[S]=new y(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),l[S]=new y(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);const p=new Jh(this.vertexBuffer),_=p.element[ht],m=p.element[hn],g=p.element[Os],v=this.vertexBuffer.numVertices;for(let S=0;S<v;S++){for(let w=0;w<4;w++)if(m.array[m.index+w]>0){const b=g.array[g.index+w];if(c[b]=!0,t=_.array[_.index],s=_.array[_.index+1],i=_.array[_.index+2],n=l[b],a=o[b],a.x>t&&(a.x=t),a.y>s&&(a.y=s),a.z>i&&(a.z=i),n.x<t&&(n.x=t),n.y<s&&(n.y=s),n.z<i&&(n.z=i),e){let C=h=t,E=u=s,R=f=i;for(let B=0;B<e.length;B++){const L=e[B],V=L.deltaPositions[S*3],I=L.deltaPositions[S*3+1],F=L.deltaPositions[S*3+2];V<0?C+=V:h+=V,I<0?E+=I:u+=I,F<0?R+=F:f+=F}a.x>C&&(a.x=C),a.y>E&&(a.y=E),a.z>R&&(a.z=R),n.x<h&&(n.x=h),n.y<u&&(n.y=u),n.z<f&&(n.z=f)}}p.next()}const x=this.vertexBuffer.getFormat().elements.find(S=>S.name===ht);if(x&&x.normalize){const S=(()=>{switch(x.dataType){case ao:return w=>Math.max(w/127,-1);case en:return w=>w/255;case oo:return w=>Math.max(w/32767,-1);case Wr:return w=>w/65535;default:return w=>w}})();for(let w=0;w<d;w++)if(c[w]){const T=o[w],b=l[w];T.set(S(T.x),S(T.y),S(T.z)),b.set(S(b.x),S(b.y),S(b.z))}}for(let S=0;S<d;S++){const w=new Re;w.setMinMax(o[S],l[S]),this.boneAabb.push(w)}}_initGeometryData(){this._geometryData||(this._geometryData=new Hi,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))}clear(e,t,s=0,i=0){this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=s,this._geometryData.maxIndices=i,this._geometryData.verticesUsage=e?as:Pl,this._geometryData.indicesUsage=t?as:Pl}setVertexStream(e,t,s,i,n=Me,a=!1){this._initGeometryData();const o=i||t.length/s;this._geometryData._changeVertexCount(o,e),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[e]=new MI(t,s,n,a)}getVertexStream(e,t){let s=0,i=!1;if(this._geometryData){const n=this._geometryData.vertexStreamDictionary[e];n&&(i=!0,s=this._geometryData.vertexCount,ArrayBuffer.isView(t)?t.set(n.data):(t.length=0,t.push(n.data)))}return i||this.vertexBuffer&&(s=new Jh(this.vertexBuffer).readData(e,t)),s}setPositions(e,t=Hi.DEFAULT_COMPONENTS_POSITION,s){this.setVertexStream(ht,e,t,s,Me,!1)}setNormals(e,t=Hi.DEFAULT_COMPONENTS_NORMAL,s){this.setVertexStream(Us,e,t,s,Me,!1)}setUvs(e,t,s=Hi.DEFAULT_COMPONENTS_UV,i){this.setVertexStream(lv+e,t,s,i,Me,!1)}setColors(e,t=Hi.DEFAULT_COMPONENTS_COLORS,s){this.setVertexStream(Zt,e,t,s,Me,!1)}setColors32(e,t){this.setVertexStream(Zt,e,Hi.DEFAULT_COMPONENTS_COLORS,t,en,!0)}setIndices(e,t){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=e,this._geometryData.indexCount=t||e.length}getPositions(e){return this.getVertexStream(ht,e)}getNormals(e){return this.getVertexStream(Us,e)}getUvs(e,t){return this.getVertexStream(lv+e,t)}getColors(e){return this.getVertexStream(Zt,e)}getIndices(e){let t=0;if(this._geometryData&&this._geometryData.indices){const s=this._geometryData.indices;if(t=this._geometryData.indexCount,ArrayBuffer.isView(e))e.set(s);else{e.length=0;for(let i=0,n=s.length;i<n;i++)e.push(s[i])}}else this.indexBuffer.length>0&&this.indexBuffer[0]&&(t=this.indexBuffer[0].readData(e));return t}update(e=Ln,t=!0){if(this._geometryData){if(t){const n=this._geometryData.vertexStreamDictionary[ht];n&&n.componentCount===3&&(this._aabb.compute(n.data,this._geometryData.vertexCount),this._aabbVer++)}let s=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(s=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),s&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);let i=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(i=!0,this._geometryData.maxIndices=this._geometryData.indexCount),i&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=e,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}}_buildVertexFormat(e){const t=[];for(const s in this._geometryData.vertexStreamDictionary){const i=this._geometryData.vertexStreamDictionary[s];t.push({semantic:s,components:i.componentCount,type:i.dataType,normalize:i.dataTypeNormalize})}return new os(this.device,t,e)}_updateVertexBuffer(){if(!this.vertexBuffer){const s=this._geometryData.maxVertices,i=this._buildVertexFormat(s);this.vertexBuffer=new Mi(this.device,i,s,this._geometryData.verticesUsage)}const e=new Jh(this.vertexBuffer),t=this._geometryData.vertexCount;for(const s in this._geometryData.vertexStreamDictionary){const i=this._geometryData.vertexStreamDictionary[s];e.writeData(s,i.data,t),delete this._geometryData.vertexStreamDictionary[s]}e.end()}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){const t=this._geometryData.maxVertices>65535?Fr:ai;this.indexBuffer[0]=new Br(this.device,t,this._geometryData.maxIndices,this._geometryData.indicesUsage)}const e=this._geometryData.indices;e&&(this.indexBuffer[0].writeData(e,this._geometryData.indexCount),this._geometryData.indices=null)}prepareRenderState(e){e===ua?this.generateWireframe():e===jd&&(this.primitive[jd]={type:Rp,base:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})}updateRenderStates(){this.primitive[jd]&&this.prepareRenderState(jd),this.primitive[ua]&&this.prepareRenderState(ua)}generateWireframe(){this._destroyIndexBuffer(ua);const e=this.vertexBuffer.numVertices,t=[];let s;if(this.indexBuffer.length>0&&this.indexBuffer[0]){const a=[[0,1],[1,2],[2,0]],o=this.primitive[Qh].base,l=this.primitive[Qh].count,c=this.indexBuffer[Qh],d=new Y_[c.format](c.storage),h=new Set;for(let u=o;u<o+l;u+=3)for(let f=0;f<3;f++){const p=d[u+a[f][0]],_=d[u+a[f][1]],m=p>_?_*e+p:p*e+_;h.has(m)||(h.add(m),t.push(p,_))}s=c.format}else{for(let a=0;a<e;a+=3)t.push(a,a+1,a+1,a+2,a+2,a);s=t.length>65535?Fr:ai}const i=new Br(this.vertexBuffer.device,s,t.length);new Y_[i.format](i.storage).set(t),i.unlock(),this.primitive[ua]={type:Lp,base:0,count:t.length,indexed:!0},this.indexBuffer[ua]=i}}const As=4/64,Ys=1-As*2,dh=[];function II(r,e){const t=e.length/3,s=r.length/3,i=new y,n=new y,a=new y,o=new y,l=new y,c=new y,d=[];for(let h=0;h<r.length;h++)d[h]=0;for(let h=0;h<t;h++){const u=e[h*3],f=e[h*3+1],p=e[h*3+2];i.set(r[u*3],r[u*3+1],r[u*3+2]),n.set(r[f*3],r[f*3+1],r[f*3+2]),a.set(r[p*3],r[p*3+1],r[p*3+2]),o.sub2(n,i),l.sub2(a,i),c.cross(o,l).normalize(),d[u*3]+=c.x,d[u*3+1]+=c.y,d[u*3+2]+=c.z,d[f*3]+=c.x,d[f*3+1]+=c.y,d[f*3+2]+=c.z,d[p*3]+=c.x,d[p*3+1]+=c.y,d[p*3+2]+=c.z}for(let h=0;h<s;h++){const u=d[h*3],f=d[h*3+1],p=d[h*3+2],_=1/Math.sqrt(u*u+f*f+p*p);d[h*3]*=_,d[h*3+1]*=_,d[h*3+2]*=_}return d}function ho(r,e,t,s){const i=s.length/3,n=r.length/3,a=new y,o=new y,l=new y,c=new M,d=new M,h=new M,u=new y,f=new y,p=new Float32Array(n*3),_=new Float32Array(n*3),m=[];for(let w=0;w<i;w++){const T=s[w*3],b=s[w*3+1],C=s[w*3+2];a.set(r[T*3],r[T*3+1],r[T*3+2]),o.set(r[b*3],r[b*3+1],r[b*3+2]),l.set(r[C*3],r[C*3+1],r[C*3+2]),c.set(t[T*2],t[T*2+1]),d.set(t[b*2],t[b*2+1]),h.set(t[C*2],t[C*2+1]);const E=o.x-a.x,R=l.x-a.x,B=o.y-a.y,L=l.y-a.y,V=o.z-a.z,I=l.z-a.z,F=d.x-c.x,D=h.x-c.x,A=d.y-c.y,N=h.y-c.y,U=F*N-D*A;if(U===0)u.set(0,1,0),f.set(1,0,0);else{const G=1/U;u.set((N*E-A*R)*G,(N*B-A*L)*G,(N*V-A*I)*G),f.set((F*R-D*E)*G,(F*L-D*B)*G,(F*I-D*V)*G)}p[T*3+0]+=u.x,p[T*3+1]+=u.y,p[T*3+2]+=u.z,p[b*3+0]+=u.x,p[b*3+1]+=u.y,p[b*3+2]+=u.z,p[C*3+0]+=u.x,p[C*3+1]+=u.y,p[C*3+2]+=u.z,_[T*3+0]+=f.x,_[T*3+1]+=f.y,_[T*3+2]+=f.z,_[b*3+0]+=f.x,_[b*3+1]+=f.y,_[b*3+2]+=f.z,_[C*3+0]+=f.x,_[C*3+1]+=f.y,_[C*3+2]+=f.z}const g=new y,v=new y,x=new y,S=new y;for(let w=0;w<n;w++){x.set(e[w*3],e[w*3+1],e[w*3+2]),g.set(p[w*3],p[w*3+1],p[w*3+2]),v.set(_[w*3],_[w*3+1],_[w*3+2]);const T=x.dot(g);S.copy(x).mulScalar(T),S.sub2(g,S).normalize(),m[w*4]=S.x,m[w*4+1]=S.y,m[w*4+2]=S.z,S.cross(x,g),m[w*4+3]=S.dot(v)<0?-1:1}return m}function nn(r,e,t){const s=new Vs(r);return s.setPositions(e),t&&(t.normals&&s.setNormals(t.normals),t.tangents&&s.setVertexStream(ln,t.tangents,4),t.colors&&s.setColors32(t.colors),t.uvs&&s.setUvs(0,t.uvs),t.uvs1&&s.setUvs(1,t.uvs1),t.blendIndices&&s.setVertexStream(Os,t.blendIndices,4,t.blendIndices.length/4,en),t.blendWeights&&s.setVertexStream(hn,t.blendWeights,4),t.indices&&s.setIndices(t.indices)),s.update(),s}function RI(r,e={}){var t,s,i,n,a,o;const l=(t=e.tubeRadius)!=null?t:.2,c=(s=e.ringRadius)!=null?s:.3,d=((i=e.sectorAngle)!=null?i:360)*H.DEG_TO_RAD,h=(n=e.segments)!=null?n:30,u=(a=e.sides)!=null?a:20,f=(o=e.calculateTangents)!=null?o:!1,p=[],_=[],m=[],g=[];for(let x=0;x<=u;x++)for(let S=0;S<=h;S++){const w=Math.cos(d*S/h)*(c+l*Math.cos(2*Math.PI*x/u)),T=Math.sin(2*Math.PI*x/u)*l,b=Math.sin(d*S/h)*(c+l*Math.cos(2*Math.PI*x/u)),C=Math.cos(d*S/h)*Math.cos(2*Math.PI*x/u),E=Math.sin(2*Math.PI*x/u),R=Math.sin(d*S/h)*Math.cos(2*Math.PI*x/u),B=x/u,L=1-S/h;if(p.push(w,T,b),_.push(C,E,R),m.push(B,1-L),x<u&&S<h){const V=x*(h+1)+S,I=(x+1)*(h+1)+S,F=x*(h+1)+(S+1),D=(x+1)*(h+1)+(S+1);g.push(V,I,F),g.push(I,D,F)}}const v={normals:_,uvs:m,uvs1:m,indices:g};return f&&(v.tangents=ho(p,_,m,g)),nn(r,p,v)}function Yy(r,e,t,s,i,n){const a=new y,o=new y,l=new y,c=new y,d=new y,h=new y,u=[],f=[],p=[],_=[],m=[];let g;if(t>0)for(let v=0;v<=s;v++)for(let x=0;x<=i;x++){const S=x/i*2*Math.PI-Math.PI,w=Math.sin(S),T=Math.cos(S);d.set(w*r,-t/2,T*r),c.set(w*e,t/2,T*e),a.lerp(d,c,v/s),o.sub2(c,d).normalize(),h.set(T,0,-w),l.cross(h,o).normalize(),u.push(a.x,a.y,a.z),f.push(l.x,l.y,l.z);let b=x/i,C=v/s;p.push(b,1-C);const E=C;if(C=b,b=E,b=b*Ys+As,C=C*Ys+As,b/=3,_.push(b,1-C),v<s&&x<i){const R=v*(i+1)+x,B=v*(i+1)+(x+1),L=(v+1)*(i+1)+x,V=(v+1)*(i+1)+(x+1);m.push(R,B,L),m.push(B,V,L)}}if(n){const v=Math.floor(i/2),x=i,S=t/2;for(let w=0;w<=v;w++){const T=w*Math.PI*.5/v,b=Math.sin(T),C=Math.cos(T);for(let E=0;E<=x;E++){const R=E*2*Math.PI/x-Math.PI/2,B=Math.sin(R),V=Math.cos(R)*b,I=C,F=B*b;let D=1-E/x,A=1-w/v;u.push(V*e,I*e+S,F*e),f.push(V,I,F),p.push(D,1-A),D=D*Ys+As,A=A*Ys+As,D/=3,A/=3,D+=1/3,_.push(D,1-A)}}g=(s+1)*(i+1);for(let w=0;w<v;++w)for(let T=0;T<x;++T){const b=w*(x+1)+T,C=b+x+1;m.push(g+b+1,g+C,g+b),m.push(g+b+1,g+C+1,g+C)}for(let w=0;w<=v;w++){const T=Math.PI*.5+w*Math.PI*.5/v,b=Math.sin(T),C=Math.cos(T);for(let E=0;E<=x;E++){const R=E*2*Math.PI/x-Math.PI/2,B=Math.sin(R),V=Math.cos(R)*b,I=C,F=B*b;let D=1-E/x,A=1-w/v;u.push(V*e,I*e-S,F*e),f.push(V,I,F),p.push(D,1-A),D=D*Ys+As,A=A*Ys+As,D/=3,A/=3,D+=2/3,_.push(D,1-A)}}g=(s+1)*(i+1)+(x+1)*(v+1);for(let w=0;w<v;++w)for(let T=0;T<x;++T){const b=w*(x+1)+T,C=b+x+1;m.push(g+b+1,g+C,g+b),m.push(g+b+1,g+C+1,g+C)}}else{if(g=(s+1)*(i+1),r>0)for(let v=0;v<i;v++){const x=v/i*2*Math.PI,S=Math.sin(x),w=-t/2,T=Math.cos(x);let b=1-(S+1)/2,C=(T+1)/2;u.push(S*r,w,T*r),f.push(0,-1,0),p.push(b,1-C),b=b*Ys+As,C=C*Ys+As,b/=3,C/=3,b+=1/3,_.push(b,1-C),v>1&&m.push(g,g+v,g+v-1)}if(g+=i,e>0)for(let v=0;v<i;v++){const x=v/i*2*Math.PI,S=Math.sin(x),w=t/2,T=Math.cos(x);let b=1-(S+1)/2,C=(T+1)/2;u.push(S*e,w,T*e),f.push(0,1,0),p.push(b,1-C),b=b*Ys+As,C=C*Ys+As,b/=3,C/=3,b+=2/3,_.push(b,1-C),v>1&&m.push(g,g+v-1,g+v)}}return{positions:u,normals:f,uvs:p,uvs1:_,indices:m}}function LI(r,e={}){var t,s,i,n,a;const o=(t=e.radius)!=null?t:.5,l=(s=e.height)!=null?s:1,c=(i=e.heightSegments)!=null?i:5,d=(n=e.capSegments)!=null?n:20,h=(a=e.calculateTangents)!=null?a:!1,u=Yy(o,o,l,c,d,!1);return h&&(u.tangents=ho(u.positions,u.normals,u.uvs,u.indices)),nn(r,u.positions,u)}function DI(r,e={}){var t,s,i,n,a;const o=(t=e.radius)!=null?t:.3,l=(s=e.height)!=null?s:1,c=(i=e.heightSegments)!=null?i:1,d=(n=e.sides)!=null?n:20,h=(a=e.calculateTangents)!=null?a:!1,u=Yy(o,o,l-2*o,c,d,!0);return h&&(u.tangents=ho(u.positions,u.normals,u.uvs,u.indices)),nn(r,u.positions,u)}function OI(r,e={}){var t,s,i,n,a,o;const l=(t=e.baseRadius)!=null?t:.5,c=(s=e.peakRadius)!=null?s:0,d=(i=e.height)!=null?i:1,h=(n=e.heightSegments)!=null?n:5,u=(a=e.capSegments)!=null?a:18,f=(o=e.calculateTangents)!=null?o:!1,p=Yy(l,c,d,h,u,!1);return f&&(p.tangents=ho(p.positions,p.normals,p.uvs,p.indices)),nn(r,p.positions,p)}function FI(r,e={}){var t,s,i,n;const a=(t=e.radius)!=null?t:.5,o=(s=e.latitudeBands)!=null?s:16,l=(i=e.longitudeBands)!=null?i:16,c=(n=e.calculateTangents)!=null?n:!1,d=[],h=[],u=[],f=[];for(let _=0;_<=o;_++){const m=_*Math.PI/o,g=Math.sin(m),v=Math.cos(m);for(let x=0;x<=l;x++){const S=x*2*Math.PI/l-Math.PI/2,w=Math.sin(S),b=Math.cos(S)*g,C=v,E=w*g,R=1-x/l,B=1-_/o;d.push(b*a,C*a,E*a),h.push(b,C,E),u.push(R,1-B)}}for(let _=0;_<o;++_)for(let m=0;m<l;++m){const g=_*(l+1)+m,v=g+l+1;f.push(g+1,v,g),f.push(g+1,v+1,v)}const p={normals:h,uvs:u,uvs1:u,indices:f};return c&&(p.tangents=ho(d,h,u,f)),nn(r,d,p)}function kI(r,e={}){var t,s,i,n;const a=(t=e.halfExtents)!=null?t:new M(.5,.5),o=(s=e.widthSegments)!=null?s:5,l=(i=e.lengthSegments)!=null?i:5,c=(n=e.calculateTangents)!=null?n:!1,d=[],h=[],u=[],f=[];let p=0;for(let m=0;m<=o;m++)for(let g=0;g<=l;g++){const v=-a.x+2*a.x*m/o,x=0,S=-(-a.y+2*a.y*g/l),w=m/o,T=g/l;d.push(v,x,S),h.push(0,1,0),u.push(w,1-T),m<o&&g<l&&(f.push(p+l+1,p+1,p),f.push(p+l+1,p+l+2,p+1)),p++}const _={normals:h,uvs:u,uvs1:u,indices:f};return c&&(_.tangents=ho(d,h,u,f)),nn(r,d,_)}function cf(r,e={}){var t,s,i,n,a,o;const l=(t=e.halfExtents)!=null?t:new y(.5,.5,.5),c=(s=e.widthSegments)!=null?s:1,d=(i=e.lengthSegments)!=null?i:1,h=(n=e.heightSegments)!=null?n:1,u=(a=e.calculateTangents)!=null?a:!1,f=(o=e.yOffset)!=null?o:0,p=-l.y+f,_=l.y+f,m=[new y(-l.x,p,l.z),new y(l.x,p,l.z),new y(l.x,_,l.z),new y(-l.x,_,l.z),new y(l.x,p,-l.z),new y(-l.x,p,-l.z),new y(-l.x,_,-l.z),new y(l.x,_,-l.z)],g=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],v=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],x={FRONT:0,BACK:1,TOP:2,BOTTOM:3,RIGHT:4,LEFT:5},S=[],w=[],T=[],b=[],C=[];let E=0;const R=(L,V,I)=>{const F=new y,D=new y,A=new y,N=new y;for(let U=0;U<=V;U++)for(let G=0;G<=I;G++){F.lerp(m[g[L][0]],m[g[L][1]],U/V),D.lerp(m[g[L][0]],m[g[L][2]],G/I),A.sub2(D,m[g[L][0]]),N.add2(F,A);let X=U/V,j=G/I;S.push(N.x,N.y,N.z),w.push(v[L][0],v[L][1],v[L][2]),T.push(X,1-j),X=X*Ys+As,j=j*Ys+As,X/=3,j/=3,X+=L%3/3,j+=Math.floor(L/3)/3,b.push(X,1-j),U<V&&G<I&&(C.push(E+I+1,E+1,E),C.push(E+I+1,E+I+2,E+1)),E++}};R(x.FRONT,c,h),R(x.BACK,c,h),R(x.TOP,c,d),R(x.BOTTOM,c,d),R(x.RIGHT,d,h),R(x.LEFT,d,h);const B={normals:w,uvs:T,uvs1:b,indices:C};return u&&(B.tangents=ho(S,w,T,C)),nn(r,S,B)}function Nb(r,e){let t=null;for(let s=0;s<dh.length;s++)dh[s].type===e&&dh[s].device===r&&(t=dh[s].primData);if(!t){let s,i;switch(e){case"box":s=cf(r),i={x:2,y:2,z:2,uv:2/3};break;case"capsule":s=DI(r,{radius:.5,height:2}),i={x:Math.PI*2,y:Math.PI,z:Math.PI*2,uv:1/3+1/3/3*2};break;case"cone":s=OI(r,{baseRadius:.5,peakRadius:0,height:1}),i={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":s=LI(r,{radius:.5,height:1}),i={x:Math.PI,y:.79*2,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":s=kI(r,{halfExtents:new M(.5,.5),widthSegments:1,lengthSegments:1}),i={x:0,y:1,z:0,uv:1};break;case"sphere":s=FI(r,{radius:.5}),i={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case"torus":s=RI(r,{tubeRadius:.2,ringRadius:.3}),i={x:Math.PI*.5*.5-Math.PI*.1*.1,y:.4,z:.4,uv:1};break;default:throw new Error("Invalid primitive type: "+e)}s.incRefCount(),t={mesh:s,area:i},dh.push({type:e,device:r,primData:t})}return t}var BI=`
uniform float alpha_ref;
void alphaTest(float a) {
	if (a < alpha_ref) discard;
}
`,NI=`
void addAmbient(vec3 worldNormal) {
	dDiffuseLight += light_globalAmbient;
}
`,UI=`
#ifndef ENV_ATLAS
#define ENV_ATLAS
uniform sampler2D texture_envAtlas;
#endif
void addAmbient(vec3 worldNormal) {
	vec3 dir = normalize(cubeMapRotate(worldNormal) * vec3(-1.0, 1.0, 1.0));
	vec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);
	vec4 raw = texture2D(texture_envAtlas, uv);
	vec3 linear = $DECODE(raw);
	dDiffuseLight += processEnvironment(linear);
}
`,zI=`
uniform vec3 ambientSH[9];
void addAmbient(vec3 worldNormal) {
	vec3 n = cubeMapRotate(worldNormal);
	vec3 color =
		ambientSH[0] +
		ambientSH[1] * n.x +
		ambientSH[2] * n.y +
		ambientSH[3] * n.z +
		ambientSH[4] * n.x * n.z +
		ambientSH[5] * n.z * n.y +
		ambientSH[6] * n.y * n.x +
		ambientSH[7] * (3.0 * n.z * n.z - 1.0) +
		ambientSH[8] * (n.x * n.x - n.y * n.y);
	dDiffuseLight += processEnvironment(max(color, vec3(0.0)));
}
`,VI=`
void getAO() {
	dAo = 1.0;
	#ifdef MAPTEXTURE
	float aoBase = texture2DBias($SAMPLER, $UV, textureBias).$CH;
	dAo *= addAoDetail(aoBase);
	#endif
	#ifdef MAPVERTEX
	dAo *= saturate(vVertexColor.$VC);
	#endif
}
`,GI=`
float addAoDetail(float ao) {
#ifdef MAPTEXTURE
	float aoDetail = texture2DBias($SAMPLER, $UV, textureBias).$CH;
	return detailMode_$DETAILMODE(vec3(ao), vec3(aoDetail)).r;
#else
	return ao;
#endif
}
`,HI=`
void occludeDiffuse(float ao) {
	dDiffuseLight *= ao;
}
`,WI=`
uniform float material_occludeSpecularIntensity;
void occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {
	float specPow = exp2(gloss * 11.0);
	float specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01*specPow) - 1.0 + ao);
	specOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);
	dSpecularLight *= specOcc;
	dReflection *= specOcc;
	
#ifdef LIT_SHEEN
	sSpecularLight *= specOcc;
	sReflection *= specOcc;
#endif
}
`,jI=`
void occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {
	float specPow = exp2(gloss * 11.0);
	float specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01*specPow) - 1.0 + ao);
	dSpecularLight *= specOcc;
	dReflection *= specOcc;
	
#ifdef LIT_SHEEN
	sSpecularLight *= specOcc;
	sReflection *= specOcc;
#endif
}
`,$I=`
void occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {
	dSpecularLight *= ao;
	dReflection *= ao;
#ifdef LIT_SHEEN
	sSpecularLight *= ao;
	sReflection *= ao;
#endif
}
`,XI=`
uniform float material_occludeSpecularIntensity;
void occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {
	float specOcc = mix(1.0, ao, material_occludeSpecularIntensity);
	dSpecularLight *= specOcc;
	dReflection *= specOcc;
#ifdef LIT_SHEEN
	sSpecularLight *= specOcc;
	sReflection *= specOcc;
#endif
}
`,qI=`
uniform vec3 view_position;
uniform vec3 light_globalAmbient;
float square(float x) {
	return x*x;
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec3 saturate(vec3 x) {
	return clamp(x, vec3(0.0), vec3(1.0));
}
`,KI=`
attribute vec3 vertex_position;
attribute vec3 vertex_normal;
attribute vec4 vertex_tangent;
attribute vec2 vertex_texCoord0;
attribute vec2 vertex_texCoord1;
attribute vec4 vertex_color;
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
uniform mat3 matrix_normal;
vec3 dPositionW;
mat4 dModelMatrix;
mat3 dNormalMatrix;
`,YI=`
#define NINESLICED
varying vec2 vMask;
varying vec2 vTiledUv;
uniform mediump vec4 innerOffset;
uniform mediump vec2 outerScale;
uniform mediump vec4 atlasRect;
vec2 nineSlicedUv;
`,ZI=`
#define NINESLICED
varying vec2 vMask;
varying vec2 vTiledUv;
uniform mediump vec4 innerOffset;
uniform mediump vec2 outerScale;
uniform mediump vec4 atlasRect;
`,JI=`
#define NINESLICED
#define NINESLICETILED
varying vec2 vMask;
varying vec2 vTiledUv;
uniform mediump vec4 innerOffset;
uniform mediump vec2 outerScale;
uniform mediump vec4 atlasRect;
vec2 nineSlicedUv;
`,QI=`
float bayer2(vec2 p) {
	return mod(2.0 * p.y + p.x + 1.0, 4.0);
}
float bayer4(vec2 p) {
	vec2 p1 = mod(p, 2.0);
	vec2 p2 = floor(0.5 * mod(p, 4.0));
	return 4.0 * bayer2(p1) + bayer2(p2);
}
float bayer8(vec2 p) {
	vec2 p1 = mod(p, 2.0);
	vec2 p2 = floor(0.5 * mod(p, 4.0));
	vec2 p4 = floor(0.25 * mod(p, 8.0));
	return 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);
}
`,eR=`
#define SHADOWBIAS
#define SHADOW_SAMPLE_Z_BIAS
float getShadowBias(float resolution, float maxBias) {
	return maxBias;
}
`,tR=`
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
#ifdef GAUSS
uniform float weight[SAMPLES];
#endif
#ifdef PACKED
float decodeFloatRG(vec2 rg) {
	return rg.y*(1.0/255.0) + rg.x;
}
vec2 encodeFloatRG( float v ) {
	vec2 enc = vec2(1.0, 255.0) * v;
	enc = fract(enc);
	enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);
	return enc;
}
#endif
void main(void) {
	vec3 moments = vec3(0.0);
	vec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);
	for (int i=0; i<SAMPLES; i++) {
		vec4 c = texture2D(source, uv + pixelOffset * float(i));
		#ifdef PACKED
		c.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));
		#endif
		#ifdef GAUSS
		moments += c.xyz * weight[i];
		#else
		moments += c.xyz;
		#endif
	}
	#ifndef GAUSS
	moments /= float(SAMPLES);
	#endif
	#ifdef PACKED
	gl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));
	#else
	gl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);
	#endif
}
`,sR=`
#ifdef MAPFLOAT
uniform float material_clearCoat;
#endif
void getClearCoat() {
	ccSpecularity = 1.0;
	#ifdef MAPFLOAT
	ccSpecularity *= material_clearCoat;
	#endif
	#ifdef MAPTEXTURE
	ccSpecularity *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	ccSpecularity *= saturate(vVertexColor.$VC);
	#endif
}
`,iR=`
#ifdef MAPFLOAT
uniform float material_clearCoatGloss;
#endif
void getClearCoatGlossiness() {
	ccGlossiness = 1.0;
	#ifdef MAPFLOAT
	ccGlossiness *= material_clearCoatGloss;
	#endif
	#ifdef MAPTEXTURE
	ccGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	ccGlossiness *= saturate(vVertexColor.$VC);
	#endif
	#ifdef MAPINVERT
	ccGlossiness = 1.0 - ccGlossiness;
	#endif
	ccGlossiness += 0.0000001;
}
`,nR=`
#ifdef MAPTEXTURE
uniform float material_clearCoatBumpiness;
#endif
void getClearCoatNormal() {
#ifdef MAPTEXTURE
	vec3 normalMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));
	normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness);
	ccNormalW = normalize(dTBN * normalMap);
#else
	ccNormalW = dVertexNormalW;
#endif
}
`,rR=`
vec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)
{
	vec3 vAbs = abs(dir);
	float ma;
	vec2 uv;
	if (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {
		faceIndex = dir.z < 0.0 ? 5.0 : 4.0;
		ma = 0.5 / vAbs.z;
		uv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);
		tileOffset.x = 2.0;
		tileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;
	} else if(vAbs.y >= vAbs.x) {
		faceIndex = dir.y < 0.0 ? 3.0 : 2.0;
		ma = 0.5 / vAbs.y;
		uv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);
		tileOffset.x = 1.0;
		tileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;
	} else {
		faceIndex = dir.x < 0.0 ? 1.0 : 0.0;
		ma = 0.5 / vAbs.x;
		uv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);
		tileOffset.x = 0.0;
		tileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;
	}
	return uv * ma + 0.5;
}
vec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {
	float faceIndex;
	vec2 tileOffset;
	vec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);
	float atlasFaceSize = omniAtlasViewport.z;
	float tileSize = shadowTextureResolution * atlasFaceSize;
	float offset = shadowEdgePixels / tileSize;
	uv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);
	uv *= atlasFaceSize;
	uv += tileOffset * atlasFaceSize;
	uv += omniAtlasViewport.xy;
	return uv;
}
`,aR=`
vec3 _getCookieClustered(TEXTURE_ACCEPT(tex), vec2 uv, float intensity, bool isRgb, vec4 cookieChannel) {
	vec4 pixel = mix(vec4(1.0), texture2DLodEXT(tex, uv, 0.0), intensity);
	return isRgb == true ? pixel.rgb : vec3(dot(pixel, cookieChannel));
}
vec3 getCookie2DClustered(TEXTURE_ACCEPT(tex), mat4 transform, vec3 worldPosition, float intensity, bool isRgb, vec4 cookieChannel) {
	vec4 projPos = transform * vec4(worldPosition, 1.0);
	return _getCookieClustered(TEXTURE_PASS(tex), projPos.xy / projPos.w, intensity, isRgb, cookieChannel);
}
vec3 getCookieCubeClustered(TEXTURE_ACCEPT(tex), vec3 dir, float intensity, bool isRgb, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);
	return _getCookieClustered(TEXTURE_PASS(tex), uv, intensity, isRgb, cookieChannel);
}
`,oR=`
void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {
	vec4 projPos = shadowMatrix * vec4(wPos, 1.0);
	projPos.xyz /= projPos.w;
	dShadowCoord = projPos.xyz;
}
void getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams, vec3 normal) {
	vec3 wPos = vPositionW + normal * shadowParams.y;
	_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);
}
vec3 normalOffsetPointShadow(vec4 shadowParams, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {
	float distScale = length(lightDir);
	vec3 wPos = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
	vec3 dir = wPos - lightPos;
	return dir;
}
#ifdef GL2
	#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	float getShadowOmniClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
		float shadowTextureResolution = shadowParams.x;
		vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
		return textureShadow(shadowMap, vec3(uv, shadowZ));
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF3)
	float getShadowOmniClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
		float shadowTextureResolution = shadowParams.x;
		vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
		vec3 shadowCoord = vec3(uv, shadowZ);
		return getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	float getShadowOmniClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
		float shadowTextureResolution = shadowParams.x;
		vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
		vec3 shadowCoord = vec3(uv, shadowZ);
		return getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
	}
	#endif
#else
	#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	float getShadowOmniClusteredPCF1(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
		float shadowTextureResolution = shadowParams.x;
		vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		float depth = unpackFloat(textureShadow(shadowMap, uv));
		float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
		return depth > shadowZ ? 1.0 : 0.0;
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF3)
	float getShadowOmniClusteredPCF3(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
		float shadowTextureResolution = shadowParams.x;
		vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
		vec3 shadowCoord = vec3(uv, shadowZ);
		return getShadowPCF3x3(shadowMap, shadowCoord, shadowParams);
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	float getShadowOmniClusteredPCF5(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
		float shadowTextureResolution = shadowParams.x;
		vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
		vec3 shadowCoord = vec3(uv, shadowZ);
		return getShadowPCF3x3(shadowMap, shadowCoord, shadowParams);
	}
	#endif
#endif
#ifdef GL2
	#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	float getShadowSpotClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
		return textureShadow(shadowMap, shadowCoord);
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF3)
	float getShadowSpotClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
		return getShadowSpotPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	float getShadowSpotClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
		return getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
	}
	#endif
#else
	#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	float getShadowSpotClusteredPCF1(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {
		float depth = unpackFloat(textureShadow(shadowMap, shadowCoord.xy));
		return depth > shadowCoord.z ? 1.0 : 0.0;
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF3)
	float getShadowSpotClusteredPCF3(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {
		return getShadowSpotPCF3x3(shadowMap, shadowCoord, shadowParams);
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	float getShadowSpotClusteredPCF5(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {
		return getShadowSpotPCF3x3(shadowMap, shadowCoord, shadowParams);
	}
	#endif
#endif
`,lR=`
uniform highp sampler2D clusterWorldTexture;
uniform highp sampler2D lightsTexture8;
uniform highp sampler2D lightsTextureFloat;
#if defined(CLUSTER_COOKIES)
	#define CLUSTER_COOKIES_OR_SHADOWS
#endif
#if defined(CLUSTER_SHADOWS)
	#define CLUSTER_COOKIES_OR_SHADOWS
#endif
#ifdef CLUSTER_SHADOWS
	#ifdef GL2
		uniform sampler2DShadow shadowAtlasTexture;
	#else
		uniform sampler2D shadowAtlasTexture;
	#endif
#endif
#ifdef CLUSTER_COOKIES
	uniform sampler2D cookieAtlasTexture;
#endif
#ifdef GL2
	uniform int clusterMaxCells;
#else
	uniform float clusterMaxCells;
	uniform vec4 lightsTextureInvSize;
#endif
uniform float clusterSkip;
uniform vec3 clusterCellsCountByBoundsSize;
uniform vec3 clusterTextureSize;
uniform vec3 clusterBoundsMin;
uniform vec3 clusterBoundsDelta;
uniform vec3 clusterCellsDot;
uniform vec3 clusterCellsMax;
uniform vec2 clusterCompressionLimit0;
uniform vec2 shadowAtlasParams;
struct ClusterLightData {
	vec3 halfWidth;
	float lightType;
	vec3 halfHeight;
	#ifdef GL2
		int lightIndex;
	#else
		float lightV;
	#endif
	vec3 position;
	float shape;
	vec3 direction;
	float falloffMode;
	vec3 color;
	float shadowIntensity;
	vec3 omniAtlasViewport;
	float range;
	vec4 cookieChannelMask;
	float shadowBias;
	float shadowNormalBias;
	float innerConeAngleCos;
	float outerConeAngleCos;
	float cookie;
	float cookieRgb;
	float cookieIntensity;
	float mask;
};
mat4 lightProjectionMatrix;
#define isClusteredLightCastShadow(light) ( light.shadowIntensity > 0.0 )
#define isClusteredLightCookie(light) (light.cookie > 0.5 )
#define isClusteredLightCookieRgb(light) (light.cookieRgb > 0.5 )
#define isClusteredLightSpot(light) ( light.lightType > 0.5 )
#define isClusteredLightFalloffLinear(light) ( light.falloffMode < 0.5 )
#define isClusteredLightArea(light) ( light.shape > 0.1 )
#define isClusteredLightRect(light) ( light.shape < 0.3 )
#define isClusteredLightDisk(light) ( light.shape < 0.6 )
#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS
	#define acceptLightMask(light) ( light.mask < 0.75)
#else
	#define acceptLightMask(light) ( light.mask > 0.25)
#endif
vec4 decodeClusterLowRange4Vec4(vec4 d0, vec4 d1, vec4 d2, vec4 d3) {
	return vec4(
		bytes2floatRange4(d0, -2.0, 2.0),
		bytes2floatRange4(d1, -2.0, 2.0),
		bytes2floatRange4(d2, -2.0, 2.0),
		bytes2floatRange4(d3, -2.0, 2.0)
	);
}
#ifdef GL2
	vec4 sampleLightsTexture8(const ClusterLightData clusterLightData, int index) {
		return texelFetch(lightsTexture8, ivec2(index, clusterLightData.lightIndex), 0);
	}
	vec4 sampleLightTextureF(const ClusterLightData clusterLightData, int index) {
		return texelFetch(lightsTextureFloat, ivec2(index, clusterLightData.lightIndex), 0);
	}
#else
	vec4 sampleLightsTexture8(const ClusterLightData clusterLightData, float index) {
		return texture2DLodEXT(lightsTexture8, vec2(index * lightsTextureInvSize.z, clusterLightData.lightV), 0.0);
	}
	vec4 sampleLightTextureF(const ClusterLightData clusterLightData, float index) {
		return texture2DLodEXT(lightsTextureFloat, vec2(index * lightsTextureInvSize.x, clusterLightData.lightV), 0.0);
	}
#endif
void decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {
	#ifdef GL2
		clusterLightData.lightIndex = int(lightIndex);
	#else
		clusterLightData.lightV = (lightIndex + 0.5) * lightsTextureInvSize.w;
	#endif
	vec4 lightInfo = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_FLAGS);
	clusterLightData.lightType = lightInfo.x;
	clusterLightData.shape = lightInfo.y;
	clusterLightData.falloffMode = lightInfo.z;
	clusterLightData.shadowIntensity = lightInfo.w;
	vec4 colorA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_A);
	vec4 colorB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_B);
	clusterLightData.color = vec3(bytes2float2(colorA.xy), bytes2float2(colorA.zw), bytes2float2(colorB.xy)) * clusterCompressionLimit0.y;
	clusterLightData.cookie = colorB.z;
	clusterLightData.mask = colorB.w;
	#ifdef CLUSTER_TEXTURE_FLOAT
		vec4 lightPosRange = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_POSITION_RANGE);
		clusterLightData.position = lightPosRange.xyz;
		clusterLightData.range = lightPosRange.w;
		vec4 lightDir_Unused = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_SPOT_DIRECTION);
		clusterLightData.direction = lightDir_Unused.xyz;
	#else
		vec4 encPosX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_X);
		vec4 encPosY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Y);
		vec4 encPosZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Z);
		clusterLightData.position = vec3(bytes2float4(encPosX), bytes2float4(encPosY), bytes2float4(encPosZ)) * clusterBoundsDelta + clusterBoundsMin;
		vec4 encRange = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_RANGE);
		clusterLightData.range = bytes2float4(encRange) * clusterCompressionLimit0.x;
		vec4 encDirX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_X);
		vec4 encDirY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Y);
		vec4 encDirZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Z);
		clusterLightData.direction = vec3(bytes2float4(encDirX), bytes2float4(encDirY), bytes2float4(encDirZ)) * 2.0 - 1.0;
	#endif
}
void decodeClusterLightSpot(inout ClusterLightData clusterLightData) {
	vec4 coneAngle = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_ANGLES);
	clusterLightData.innerConeAngleCos = bytes2float2(coneAngle.xy) * 2.0 - 1.0;
	clusterLightData.outerConeAngleCos = bytes2float2(coneAngle.zw) * 2.0 - 1.0;
}
void decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {
	#ifdef CLUSTER_TEXTURE_FLOAT
		clusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0).xyz;
	#else
		vec4 viewportA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_A);
		vec4 viewportB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_B);
		clusterLightData.omniAtlasViewport = vec3(bytes2float2(viewportA.xy), bytes2float2(viewportA.zw), bytes2float2(viewportB.xy));
	#endif
}
void decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {
	#ifdef CLUSTER_TEXTURE_FLOAT
		clusterLightData.halfWidth = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_WIDTH).xyz;
		clusterLightData.halfHeight = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_HEIGHT).xyz;
	#else
		vec4 areaWidthX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_X);
		vec4 areaWidthY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Y);
		vec4 areaWidthZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Z);
		clusterLightData.halfWidth = vec3(mantissaExponent2Float(areaWidthX), mantissaExponent2Float(areaWidthY), mantissaExponent2Float(areaWidthZ));
		vec4 areaHeightX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_X);
		vec4 areaHeightY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Y);
		vec4 areaHeightZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Z);
		clusterLightData.halfHeight = vec3(mantissaExponent2Float(areaHeightX), mantissaExponent2Float(areaHeightY), mantissaExponent2Float(areaHeightZ));
	#endif
}
void decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {
	
	#ifdef CLUSTER_TEXTURE_FLOAT
		vec4 m0 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0);
		vec4 m1 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_1);
		vec4 m2 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_2);
		vec4 m3 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_3);
	#else
		vec4 m00 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_00);
		vec4 m01 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_01);
		vec4 m02 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_02);
		vec4 m03 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_03);
		vec4 m0 = decodeClusterLowRange4Vec4(m00, m01, m02, m03);
		vec4 m10 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_10);
		vec4 m11 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_11);
		vec4 m12 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_12);
		vec4 m13 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_13);
		vec4 m1 = decodeClusterLowRange4Vec4(m10, m11, m12, m13);
		vec4 m20 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_20);
		vec4 m21 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_21);
		vec4 m22 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_22);
		vec4 m23 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_23);
		vec4 m2 = decodeClusterLowRange4Vec4(m20, m21, m22, m23);
		vec4 m30 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_30);
		vec4 m31 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_31);
		vec4 m32 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_32);
		vec4 m33 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_33);
		vec4 m3 = vec4(mantissaExponent2Float(m30), mantissaExponent2Float(m31), mantissaExponent2Float(m32), mantissaExponent2Float(m33));
	#endif
	
	lightProjectionMatrix = mat4(m0, m1, m2, m3);
}
void decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {
	
	vec4 biases = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SHADOW_BIAS);
	clusterLightData.shadowBias = bytes2floatRange2(biases.xy, -1.0, 20.0),
	clusterLightData.shadowNormalBias = bytes2float2(biases.zw);
}
void decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {
	vec4 cookieA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_A);
	clusterLightData.cookieIntensity = cookieA.x;
	clusterLightData.cookieRgb = cookieA.y;
	clusterLightData.cookieChannelMask = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_B);
}
void evaluateLight(
	ClusterLightData light, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir,
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	vec3 cookieAttenuation = vec3(1.0);
	float diffuseAttenuation = 1.0;
	float falloffAttenuation = 1.0;
	getLightDirPoint(light.position);
	#ifdef CLUSTER_AREALIGHTS
	if (isClusteredLightArea(light)) {
		decodeClusterLightAreaData(light);
		if (isClusteredLightRect(light)) {
			calcRectLightValues(light.position, light.halfWidth, light.halfHeight);
		} else if (isClusteredLightDisk(light)) {
			calcDiskLightValues(light.position, light.halfWidth, light.halfHeight);
		} else {
			calcSphereLightValues(light.position, light.halfWidth, light.halfHeight);
		}
		falloffAttenuation = getFalloffWindow(light.range, dLightDirW);
	} else
	#endif
	{
		if (isClusteredLightFalloffLinear(light))
			falloffAttenuation = getFalloffLinear(light.range, dLightDirW);
		else
			falloffAttenuation = getFalloffInvSquared(light.range, dLightDirW);
	}
	if (falloffAttenuation > 0.00001) {
		#ifdef CLUSTER_AREALIGHTS
		if (isClusteredLightArea(light)) {
			if (isClusteredLightRect(light)) {
				diffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;
			} else if (isClusteredLightDisk(light)) {
				diffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;
			} else {
				diffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;
			}
		} else
		#endif
		{
			falloffAttenuation *= getLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW); 
		}
		if (isClusteredLightSpot(light)) {
			decodeClusterLightSpot(light);
			falloffAttenuation *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, dLightDirNormW);
		}
		#if defined(CLUSTER_COOKIES_OR_SHADOWS)
		if (falloffAttenuation > 0.00001) {
			if (isClusteredLightCastShadow(light) || isClusteredLightCookie(light)) {
				if (isClusteredLightSpot(light)) {
					decodeClusterLightProjectionMatrixData(light);
				} else {
					decodeClusterLightOmniAtlasViewport(light);
				}
				float shadowTextureResolution = shadowAtlasParams.x;
				float shadowEdgePixels = shadowAtlasParams.y;
				#ifdef CLUSTER_COOKIES
				if (isClusteredLightCookie(light)) {
					decodeClusterLightCookieData(light);
					if (isClusteredLightSpot(light)) {
						cookieAttenuation = getCookie2DClustered(TEXTURE_PASS(cookieAtlasTexture), lightProjectionMatrix, vPositionW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask);
					} else {
						cookieAttenuation = getCookieCubeClustered(TEXTURE_PASS(cookieAtlasTexture), dLightDirW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);
					}
				}
				#endif
				#ifdef CLUSTER_SHADOWS
				if (isClusteredLightCastShadow(light)) {
					decodeClusterLightShadowData(light);
					vec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);
					if (isClusteredLightSpot(light)) {
						getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);
						
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							float shadow = getShadowSpotClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							float shadow = getShadowSpotClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							float shadow = getShadowSpotClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCSS)
							float shadow = getShadowSpotClusteredPCSS(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);
						#endif
						falloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);
					} else {
						vec3 dir = normalOffsetPointShadow(shadowParams, dLightPosW, dLightDirW, dLightDirNormW, geometricNormal);
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							float shadow = getShadowOmniClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							float shadow = getShadowOmniClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							float shadow = getShadowOmniClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#endif
						falloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);
					}
				}
				#endif
			}
		}
		#endif
		#ifdef CLUSTER_AREALIGHTS
		if (isClusteredLightArea(light)) {
			{
				vec3 areaDiffuse = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;
				#if defined(LIT_SPECULAR)
					#if defined(LIT_CONSERVE_ENERGY)
						areaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);
					#endif
				#endif
				dDiffuseLight += areaDiffuse;
			}
			#ifdef LIT_SPECULAR
				float areaLightSpecular;
				if (isClusteredLightRect(light)) {
					areaLightSpecular = getRectLightSpecular(worldNormal, viewDir);
				} else if (isClusteredLightDisk(light)) {
					areaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);
				} else {
					areaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);
				}
				dSpecularLight += dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;
				#ifdef LIT_CLEARCOAT
					float areaLightSpecularCC;
					if (isClusteredLightRect(light)) {
						areaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);
					} else if (isClusteredLightDisk(light)) {
						areaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);
					} else {
						areaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);
					}
					ccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;
				#endif
			#endif
		} else
		#endif
		{
			{
				vec3 punctualDiffuse = falloffAttenuation * light.color * cookieAttenuation;
				#if defined(CLUSTER_AREALIGHTS)
				#if defined(LIT_SPECULAR)
				#if defined(LIT_CONSERVE_ENERGY)
					punctualDiffuse = mix(punctualDiffuse, vec3(0), specularity);
				#endif
				#endif
				#endif
				dDiffuseLight += punctualDiffuse;
			}
	 
			#ifdef LIT_SPECULAR
				vec3 halfDir = normalize(-dLightDirNormW + viewDir);
				
				#ifdef LIT_SPECULAR_FRESNEL
					dSpecularLight += 
						getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dLightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * 
						getFresnel(
							dot(viewDir, halfDir), 
							gloss, 
							specularity
						#if defined(LIT_IRIDESCENCE)
							, iridescenceFresnel,
							iridescence_intensity
						#endif
							);
				#else
					dSpecularLight += getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dLightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;
				#endif
				#ifdef LIT_CLEARCOAT
					#ifdef LIT_SPECULAR_FRESNEL
						ccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, dLightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));
					#else
						ccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, dLightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation; 
					#endif
				#endif
				#ifdef LIT_SHEEN
					sSpecularLight += getLightSpecularSheen(halfDir, worldNormal, viewDir, dLightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;
				#endif
			#endif
		}
	}
	dAtten = falloffAttenuation;
	dAttenD = diffuseAttenuation;
	dAtten3 = cookieAttenuation;
}
void evaluateClusterLight(
	float lightIndex, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	ClusterLightData clusterLightData;
	decodeClusterLightCore(clusterLightData, lightIndex);
	if (acceptLightMask(clusterLightData))
		evaluateLight(
			clusterLightData, 
			worldNormal, 
			viewDir, 
			reflectionDir, 
#if defined(LIT_CLEARCOAT)
			clearcoatReflectionDir, 
#endif
			gloss, 
			specularity, 
			geometricNormal, 
			tbn, 
#if defined(LIT_IRIDESCENCE)
			iridescenceFresnel,
#endif
			clearcoat_worldNormal,
			clearcoat_gloss,
			sheen_gloss,
			iridescence_intensity
		);
}
void addClusteredLights(
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	if (clusterSkip > 0.5)
		return;
	vec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);
	if (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {
		float cellIndex = dot(clusterCellsDot, cellCoords);
		float clusterV = floor(cellIndex * clusterTextureSize.y);
		float clusterU = cellIndex - (clusterV * clusterTextureSize.x);
		#ifdef GL2
			for (int lightCellIndex = 0; lightCellIndex < clusterMaxCells; lightCellIndex++) {
				float lightIndex = texelFetch(clusterWorldTexture, ivec2(int(clusterU) + lightCellIndex, clusterV), 0).x;
				if (lightIndex <= 0.0)
						return;
				evaluateClusterLight(
					lightIndex * 255.0, 
					worldNormal, 
					viewDir, 
					reflectionDir,
#if defined(LIT_CLEARCOAT)
					clearcoatReflectionDir,
#endif
					gloss, 
					specularity, 
					geometricNormal, 
					tbn, 
#if defined(LIT_IRIDESCENCE)
					iridescenceFresnel,
#endif
					clearcoat_worldNormal,
					clearcoat_gloss,
					sheen_gloss,
					iridescence_intensity
				); 
			}
		#else
			clusterV = (clusterV + 0.5) * clusterTextureSize.z;
			const float maxLightCells = 256.0;
			for (float lightCellIndex = 0.5; lightCellIndex < maxLightCells; lightCellIndex++) {
				float lightIndex = texture2DLodEXT(clusterWorldTexture, vec2(clusterTextureSize.y * (clusterU + lightCellIndex), clusterV), 0.0).x;
				if (lightIndex <= 0.0)
					return;
				
				evaluateClusterLight(
					lightIndex * 255.0, 
					worldNormal, 
					viewDir, 
					reflectionDir,
#if defined(LIT_CLEARCOAT)
					clearcoatReflectionDir,
#endif
					gloss, 
					specularity, 
					geometricNormal, 
					tbn, 
#if defined(LIT_IRIDESCENCE)
					iridescenceFresnel,
#endif
					clearcoat_worldNormal,
					clearcoat_gloss,
					sheen_gloss,
					iridescence_intensity
				); 
				if (lightCellIndex >= clusterMaxCells) {
					break;
				}
			}
		#endif
	}
}
`,hR=`
vec3 combineColor(vec3 albedo, vec3 sheenSpecularity, float clearcoatSpecularity) {
	vec3 ret = vec3(0);
#ifdef LIT_OLD_AMBIENT
	ret += (dDiffuseLight - light_globalAmbient) * albedo + material_ambient * light_globalAmbient;
#else
	ret += albedo * dDiffuseLight;
#endif
#ifdef LIT_SPECULAR
	ret += dSpecularLight;
#endif
#ifdef LIT_REFLECTIONS
	ret += dReflection.rgb * dReflection.a;
#endif
#ifdef LIT_SHEEN
	float sheenScaling = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;
	ret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;
#endif
#ifdef LIT_CLEARCOAT
	float clearCoatScaling = 1.0 - ccFresnel * clearcoatSpecularity;
	ret = ret * clearCoatScaling + (ccSpecularLight + ccReflection.rgb) * clearcoatSpecularity;
#endif
	return ret;
}
`,cR=`
vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);
}
vec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);
	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);
}
vec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	projPos.xy += cookieOffset;
	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);
	return mix(vec4(1.0), texture2D(tex, uv), intensity);
}
vec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	projPos.xy += cookieOffset;
	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);
	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);
	return mix(vec4(1.0), texture2D(tex, uv), intensity);
}
vec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {
	return mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);
}
`,dR=`
uniform vec3 envBoxMin;
uniform vec3 envBoxMax;
vec3 cubeMapProject(vec3 nrdir) {
	nrdir = cubeMapRotate(nrdir);
	vec3 rbmax = (envBoxMax - vPositionW) / nrdir;
	vec3 rbmin = (envBoxMin - vPositionW) / nrdir;
	vec3 rbminmax;
	rbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;
	rbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;
	rbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;
	float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);
	vec3 posonbox = vPositionW + nrdir * fa;
	vec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;
	return normalize(posonbox - envBoxPos);
}
`,uR=`
vec3 cubeMapProject(vec3 dir) {
	return cubeMapRotate(dir);
}
`,fR=`
#ifdef CUBEMAP_ROTATION
uniform mat3 cubeMapRotationMatrix;
#endif
vec3 cubeMapRotate(vec3 refDir) {
#ifdef CUBEMAP_ROTATION
	return refDir * cubeMapRotationMatrix;
#else
	return refDir;
#endif
}
`,pR=`
#ifdef DEBUG_ALBEDO_PASS
gl_FragColor = vec4(gammaCorrectOutput(litArgs_albedo), 1.0);
#endif
#ifdef DEBUG_UV0_PASS
gl_FragColor = vec4(litArgs_albedo , 1.0);
#endif
#ifdef DEBUG_WORLD_NORMAL_PASS
gl_FragColor = vec4(litArgs_worldNormal * 0.5 + 0.5, 1.0);
#endif
#ifdef DEBUG_OPACITY_PASS
gl_FragColor = vec4(vec3(litArgs_opacity) , 1.0);
#endif
#ifdef DEBUG_SPECULARITY_PASS
gl_FragColor = vec4(litArgs_specularity, 1.0);
#endif
#ifdef DEBUG_GLOSS_PASS
gl_FragColor = vec4(vec3(litArgs_gloss) , 1.0);
#endif
#ifdef DEBUG_METALNESS_PASS
gl_FragColor = vec4(vec3(litArgs_metalness) , 1.0);
#endif
#ifdef DEBUG_AO_PASS
gl_FragColor = vec4(vec3(litArgs_ao) , 1.0);
#endif
#ifdef DEBUG_EMISSION_PASS
gl_FragColor = vec4(gammaCorrectOutput(litArgs_emission), 1.0);
#endif
`,mR=`
#ifdef DEBUG_LIGHTING_PASS
litArgs_albedo = vec3(0.5);
#endif
#ifdef DEBUG_UV0_PASS
#ifdef VARYING_VUV0
litArgs_albedo = vec3(vUv0, 0);
#else
litArgs_albedo = vec3(0);
#endif
#endif
`,Ub=`
vec3 decodeLinear(vec4 raw) {
	return raw.rgb;
}
float decodeGamma(float raw) {
	return pow(raw, 2.2);
}
vec3 decodeGamma(vec3 raw) {
	return pow(raw, vec3(2.2));
}
vec3 decodeGamma(vec4 raw) {
	return pow(raw.xyz, vec3(2.2));
}
vec3 decodeRGBM(vec4 raw) {
	vec3 color = (8.0 * raw.a) * raw.rgb;
	return color * color;
}
vec3 decodeRGBP(vec4 raw) {
	vec3 color = raw.rgb * (-raw.a * 7.0 + 8.0);
	return color * color;
}
vec3 decodeRGBE(vec4 raw) {
	if (raw.a == 0.0) {
		return vec3(0.0, 0.0, 0.0);
	} else {
		return raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);
	}
}
vec4 passThrough(vec4 raw) {
	return raw;
}
`,_R=`
vec3 detailMode_mul(vec3 c1, vec3 c2) {
	return c1 * c2;
}
vec3 detailMode_add(vec3 c1, vec3 c2) {
	return c1 + c2;
}
vec3 detailMode_screen(vec3 c1, vec3 c2) {
	return 1.0 - (1.0 - c1)*(1.0 - c2);
}
vec3 detailMode_overlay(vec3 c1, vec3 c2) {
	return mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));
}
vec3 detailMode_min(vec3 c1, vec3 c2) {
	return min(c1, c2);
}
vec3 detailMode_max(vec3 c1, vec3 c2) {
	return max(c1, c2);
}
`,gR=`
#ifdef MAPCOLOR
uniform vec3 material_diffuse;
#endif
void getAlbedo() {
	dAlbedo = vec3(1.0);
#ifdef MAPCOLOR
	dAlbedo *= material_diffuse.rgb;
#endif
#ifdef MAPTEXTURE
	vec3 albedoBase = $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;
	dAlbedo *= addAlbedoDetail(albedoBase);
#endif
#ifdef MAPVERTEX
	dAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));
#endif
}
`,yR=`
vec3 addAlbedoDetail(vec3 albedo) {
#ifdef MAPTEXTURE
	vec3 albedoDetail = $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;
	return detailMode_$DETAILMODE(albedo, albedoDetail);
#else
	return albedo;
#endif
}
`,vR=`
#ifdef MAPCOLOR
uniform vec3 material_emissive;
#endif
#ifdef MAPFLOAT
uniform float material_emissiveIntensity;
#endif
void getEmission() {
	dEmission = vec3(1.0);
	#ifdef MAPFLOAT
	dEmission *= material_emissiveIntensity;
	#endif
	#ifdef MAPCOLOR
	dEmission *= material_emissive;
	#endif
	#ifdef MAPTEXTURE
	dEmission *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;
	#endif
	#ifdef MAPVERTEX
	dEmission *= gammaCorrectInput(saturate(vVertexColor.$VC));
	#endif
}
`,zb=`
vec4 encodeLinear(vec3 source) {
	return vec4(source, 1.0);
}
vec4 encodeGamma(vec3 source) {
	return vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);
}
vec4 encodeRGBM(vec3 source) {
	vec4 result;
	result.rgb = pow(source.rgb, vec3(0.5));
	result.rgb *= 1.0 / 8.0;
	result.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );
	result.a = ceil(result.a * 255.0) / 255.0;
	result.rgb /= result.a;
	return result;
}
vec4 encodeRGBP(vec3 source) {
	vec3 gamma = pow(source, vec3(0.5));
	float maxVal = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));
	float v = 1.0 - ((maxVal - 1.0) / 7.0);
	v = ceil(v * 255.0) / 255.0;
	return vec4(gamma / (-v * 7.0 + 8.0), v);	
}
vec4 encodeRGBE(vec3 source) {
	float maxVal = max(source.x, max(source.y, source.z));
	if (maxVal < 1e-32) {
		return vec4(0, 0, 0, 0);
	} else {
		float e = ceil(log2(maxVal));
		return vec4(source / pow(2.0, e), (e + 128.0) / 255.0);
	}
}
`,SR=`
	gl_FragColor.rgb = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);
	gl_FragColor.rgb += litArgs_emission;
	gl_FragColor.rgb = addFog(gl_FragColor.rgb);
	#ifndef HDR
	gl_FragColor.rgb = toneMap(gl_FragColor.rgb);
	gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);
	#endif
`,xR=`
`,wR=`
const float atlasSize = 512.0;
const float seamSize = 1.0 / atlasSize;
vec2 mapUv(vec2 uv, vec4 rect) {
	return vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),
				mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));
}
vec2 mapRoughnessUv(vec2 uv, float level) {
	float t = 1.0 / exp2(level);
	return mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));
}
vec2 mapShinyUv(vec2 uv, float level) {
	float t = 1.0 / exp2(level);
	return mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));
}
`,bR=`
vec3 processEnvironment(vec3 color) {
	return color;
}
`,TR=`
uniform float skyboxIntensity;
vec3 processEnvironment(vec3 color) {
	return color * skyboxIntensity;
}
`,ER=`
`,CR=`
`,AR=`
float getFalloffWindow(float lightRadius, vec3 lightDir) {
	float sqrDist = dot(lightDir, lightDir);
	float invRadius = 1.0 / lightRadius;
	return square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );
}
float getFalloffInvSquared(float lightRadius, vec3 lightDir) {
	float sqrDist = dot(lightDir, lightDir);
	float falloff = 1.0 / (sqrDist + 1.0);
	float invRadius = 1.0 / lightRadius;
	falloff *= 16.0;
	falloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );
	return falloff;
}
`,PR=`
float getFalloffLinear(float lightRadius, vec3 lightDir) {
	float d = length(lightDir);
	return max(((lightRadius - d) / lightRadius), 0.0);
}
`,MR=`
vec3 fixSeams(vec3 vec, float mipmapIndex) {
	return vec;
}
vec3 fixSeams(vec3 vec) {
	return vec;
}
vec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {
	return vec;
}
vec3 calcSeam(vec3 vec) {
	return vec3(0);
}
vec3 applySeam(vec3 vec, vec3 seam, float scale) {
	return vec;
}
`,IR=`
vec3 fixSeams(vec3 vec, float mipmapIndex) {
	vec3 avec = abs(vec);
	float scale = 1.0 - exp2(mipmapIndex) / 128.0;
	float M = max(max(avec.x, avec.y), avec.z);
	if (avec.x != M) vec.x *= scale;
	if (avec.y != M) vec.y *= scale;
	if (avec.z != M) vec.z *= scale;
	return vec;
}
vec3 fixSeams(vec3 vec) {
	vec3 avec = abs(vec);
	float scale = 1.0 - 1.0 / 128.0;
	float M = max(max(avec.x, avec.y), avec.z);
	if (avec.x != M) vec.x *= scale;
	if (avec.y != M) vec.y *= scale;
	if (avec.z != M) vec.z *= scale;
	return vec;
}
vec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {
	vec3 avec = abs(vec);
	float scale = invRecMipSize;
	float M = max(max(avec.x, avec.y), avec.z);
	if (avec.x != M) vec.x *= scale;
	if (avec.y != M) vec.y *= scale;
	if (avec.z != M) vec.z *= scale;
	return vec;
}
vec3 calcSeam(vec3 vec) {
	vec3 avec = abs(vec);
	float M = max(avec.x, max(avec.y, avec.z));
	return vec3(avec.x != M ? 1.0 : 0.0,
				avec.y != M ? 1.0 : 0.0,
				avec.z != M ? 1.0 : 0.0);
}
vec3 applySeam(vec3 vec, vec3 seam, float scale) {
	return vec * (seam * -scale + vec3(1.0));
}
`,RR=`
float bytes2float2(vec2 data) {
	return dot(data, vec2(1.0, 1.0 / 255.0));
}
float bytes2float3(vec3 data) {
	return dot(data, vec3(1.0, 1.0 / 255.0, 1.0 / 65025.0));
}
float bytes2float4(vec4 data) {
	return dot(data, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));
}
float bytes2floatRange2(vec2 data, float min, float max) {
	return mix(min, max, bytes2float2(data));
}
float bytes2floatRange3(vec3 data, float min, float max) {
	return mix(min, max, bytes2float3(data));
}
float bytes2floatRange4(vec4 data, float min, float max) {
	return mix(min, max, bytes2float4(data));
}
float mantissaExponent2Float(vec4 pack)
{
	float value = bytes2floatRange3(pack.xyz, -1.0, 1.0);
	float exponent = floor(pack.w * 255.0 - 127.0);
	return value * exp2(exponent);
}
`,LR=`
uniform vec3 fog_color;
uniform float fog_density;
float dBlendModeFogFactor = 1.0;
vec3 addFog(vec3 color) {
	float depth = gl_FragCoord.z / gl_FragCoord.w;
	float fogFactor = exp(-depth * fog_density);
	fogFactor = clamp(fogFactor, 0.0, 1.0);
	return mix(fog_color * dBlendModeFogFactor, color, fogFactor);
}
`,DR=`
uniform vec3 fog_color;
uniform float fog_density;
float dBlendModeFogFactor = 1.0;
vec3 addFog(vec3 color) {
	float depth = gl_FragCoord.z / gl_FragCoord.w;
	float fogFactor = exp(-depth * depth * fog_density * fog_density);
	fogFactor = clamp(fogFactor, 0.0, 1.0);
	return mix(fog_color * dBlendModeFogFactor, color, fogFactor);
}
`,OR=`
uniform vec3 fog_color;
uniform float fog_start;
uniform float fog_end;
float dBlendModeFogFactor = 1.0;
vec3 addFog(vec3 color) {
	float depth = gl_FragCoord.z / gl_FragCoord.w;
	float fogFactor = (fog_end - depth) / (fog_end - fog_start);
	fogFactor = clamp(fogFactor, 0.0, 1.0);
	return mix(fog_color * dBlendModeFogFactor, color, fogFactor);
}
`,FR=`
float dBlendModeFogFactor = 1.0;
vec3 addFog(vec3 color) {
	return color;
}
`,kR=`
vec3 getFresnel(
		float cosTheta, 
		float gloss, 
		vec3 specularity
#if defined(LIT_IRIDESCENCE)
		, vec3 iridescenceFresnel, 
		float iridescenceIntensity
#endif
	) {
	float fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);
	float glossSq = gloss * gloss;
	vec3 ret = specularity + (max(vec3(glossSq), specularity) - specularity) * fresnel;
#if defined(LIT_IRIDESCENCE)
	return mix(ret, iridescenceFresnel, iridescenceIntensity);
#else
	return ret;
#endif	
}
float getFresnelCC(float cosTheta) {
	float fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);
	return 0.04 + (1.0 - 0.04) * fresnel;
}
`,BR=`
varying vec2 vUv0;
uniform sampler2D source;
void main(void) {
	gl_FragColor = texture2D(source, vUv0);
}
`,NR=`
attribute vec2 vertex_position;
varying vec2 vUv0;
void main(void)
{
	gl_Position = vec4(vertex_position, 0.5, 1.0);
	vUv0 = vertex_position.xy*0.5+0.5;
}
`,UR=`
float gammaCorrectInput(float color) {
	return color;
}
vec3 gammaCorrectInput(vec3 color) {
	return color;
}
vec4 gammaCorrectInput(vec4 color) {
	return color;
}
vec3 gammaCorrectOutput(vec3 color) {
	return color;
}
`,zR=`
float gammaCorrectInput(float color) {
	return decodeGamma(color);
}
vec3 gammaCorrectInput(vec3 color) {
	return decodeGamma(color);
}
vec4 gammaCorrectInput(vec4 color) {
	return vec4(decodeGamma(color.xyz), color.w);
}
vec3 gammaCorrectOutput(vec3 color) {
#ifdef HDR
	return color;
#else
	return pow(color + 0.0000001, vec3(1.0 / 2.2));
#endif
}
`,VR=`
#ifdef MAPFLOAT
uniform float material_gloss;
#endif
void getGlossiness() {
	dGlossiness = 1.0;
	#ifdef MAPFLOAT
	dGlossiness *= material_gloss;
	#endif
	#ifdef MAPTEXTURE
	dGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	dGlossiness *= saturate(vVertexColor.$VC);
	#endif
	#ifdef MAPINVERT
	dGlossiness = 1.0 - dGlossiness;
	#endif
	dGlossiness += 0.0000001;
}
`,GR=`
uniform float material_iridescenceRefractionIndex;
#ifndef PI
#define PI 3.14159265
#endif
float iridescence_iorToFresnel(float transmittedIor, float incidentIor) {
	return pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);
}
vec3 iridescence_iorToFresnel(vec3 transmittedIor, float incidentIor) {
	return pow((transmittedIor - vec3(incidentIor)) / (transmittedIor + vec3(incidentIor)), vec3(2.0));
}
vec3 iridescence_fresnelToIor(vec3 f0) {
	vec3 sqrtF0 = sqrt(f0);
	return (vec3(1.0) + sqrtF0) / (vec3(1.0) - sqrtF0);
}
vec3 iridescence_sensitivity(float opd, vec3 shift) {
	float phase = 2.0 * PI * opd * 1.0e-9;
	const vec3 val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);
	const vec3 pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);
	const vec3 var = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);
	vec3 xyz = val * sqrt(2.0 * PI * var) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var);
	xyz.x += 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));
	xyz /= vec3(1.0685e-07);
	const mat3 XYZ_TO_REC709 = mat3(
		3.2404542, -0.9692660,  0.0556434,
	   -1.5371385,  1.8760108, -0.2040259,
	   -0.4985314,  0.0415560,  1.0572252
	);
	return XYZ_TO_REC709 * xyz;
}
float iridescence_fresnel(float cosTheta, float f0) {
	float x = clamp(1.0 - cosTheta, 0.0, 1.0);
	float x2 = x * x;
	float x5 = x * x2 * x2;
	return f0 + (1.0 - f0) * x5;
} 
vec3 iridescence_fresnel(float cosTheta, vec3 f0) {
	float x = clamp(1.0 - cosTheta, 0.0, 1.0);
	float x2 = x * x;
	float x5 = x * x2 * x2; 
	return f0 + (vec3(1.0) - f0) * x5;
}
vec3 calcIridescence(float outsideIor, float cosTheta, vec3 base_f0, float iridescenceThickness) {
	float iridescenceIor = mix(outsideIor, material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));
	float sinTheta2Sq = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));
	float cosTheta2Sq = 1.0 - sinTheta2Sq;
	if (cosTheta2Sq < 0.0) {
		return vec3(1.0);
	}
	float cosTheta2 = sqrt(cosTheta2Sq);
	float r0 = iridescence_iorToFresnel(iridescenceIor, outsideIor);
	float r12 = iridescence_fresnel(cosTheta, r0);
	float r21 = r12;
	float t121 = 1.0 - r12;
	float phi12 = iridescenceIor < outsideIor ? PI : 0.0;
	float phi21 = PI - phi12;
	vec3 baseIor = iridescence_fresnelToIor(base_f0 + vec3(0.0001));
	vec3 r1 = iridescence_iorToFresnel(baseIor, iridescenceIor);
	vec3 r23 = iridescence_fresnel(cosTheta2, r1);
	vec3 phi23 = vec3(0.0);
	if (baseIor[0] < iridescenceIor) phi23[0] = PI;
	if (baseIor[1] < iridescenceIor) phi23[1] = PI;
	if (baseIor[2] < iridescenceIor) phi23[2] = PI;
	float opd = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;
	vec3 phi = vec3(phi21) + phi23; 
	vec3 r123Sq = clamp(r12 * r23, 1e-5, 0.9999);
	vec3 r123 = sqrt(r123Sq);
	vec3 rs = pow(t121, 2.0) * r23 / (1.0 - r123Sq);
	vec3 c0 = r12 + rs;
	vec3 i = c0;
	vec3 cm = rs - t121;
	for (int m = 1; m <= 2; m++) {
		cm *= r123;
		vec3 sm = 2.0 * iridescence_sensitivity(float(m) * opd, float(m) * phi);
		i += cm * sm;
	}
	return max(i, vec3(0.0));
}
vec3 getIridescence(float cosTheta, vec3 specularity, float iridescenceThickness) {
	return calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);
}
`,HR=`
#ifdef MAPFLOAT
uniform float material_iridescence;
#endif
void getIridescence() {
	float iridescence = 1.0;
	#ifdef MAPFLOAT
	iridescence *= material_iridescence;
	#endif
	#ifdef MAPTEXTURE
	iridescence *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	dIridescence = iridescence; 
}
`,WR=`
uniform float material_iridescenceThicknessMax;
#ifdef MAPTEXTURE
uniform float material_iridescenceThicknessMin;
#endif
void getIridescenceThickness() {
	#ifdef MAPTEXTURE
	float blend = texture2DBias($SAMPLER, $UV, textureBias).$CH;
	float iridescenceThickness = mix(material_iridescenceThicknessMin, material_iridescenceThicknessMax, blend);
	#else
	float iridescenceThickness = material_iridescenceThicknessMax;
	#endif
	dIridescenceThickness = iridescenceThickness; 
}
`,jR=`
attribute vec4 instance_line1;
attribute vec4 instance_line2;
attribute vec4 instance_line3;
attribute vec4 instance_line4;
`,$R=`
#ifdef MAPFLOAT
uniform float material_refractionIndex;
#endif
void getIor() {
#ifdef MAPFLOAT
	dIor = material_refractionIndex;
#else
	dIor = 1.0 / 1.5;
#endif
}
`,XR=`
float getLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	return max(dot(worldNormal, -lightDirNorm), 0.0);
}
`,qR=`
void getLightDirPoint(vec3 lightPosW) {
	dLightDirW = vPositionW - lightPosW;
	dLightDirNormW = normalize(dLightDirW);
	dLightPosW = lightPosW;
}
`,KR=`
void addLightMap(
	vec3 lightmap, 
	vec3 dir, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
	float gloss, 
	vec3 specularity, 
	vec3 vertexNormal, 
	mat3 tbn
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel, 
	float iridescenceIntensity
#endif
) {
	dDiffuseLight += lightmap;
}
`,YR=`
void addLightMap(
	vec3 lightmap, 
	vec3 dir, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
	float gloss, 
	vec3 specularity, 
	vec3 vertexNormal, 
	mat3 tbn
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel, 
	float iridescenceIntensity
#endif
) {
	if (dot(dir, dir) < 0.0001) {
		dDiffuseLight += lightmap;
	} else {
		float vlight = saturate(dot(dir, -vertexNormal));
		float flight = saturate(dot(dir, -worldNormal));
		float nlight = (flight / max(vlight, 0.01)) * 0.5;
		dDiffuseLight += lightmap * nlight * 2.0;
		vec3 halfDir = normalize(-dir + viewDir);
		vec3 specularLight = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);
#ifdef LIT_SPECULAR_FRESNEL
		specularLight *= 
			getFresnel(dot(viewDir, halfDir), 
			gloss, 
			specularity
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			iridescenceIntensity
		#endif
			);
#endif
		dSpecularLight += specularLight;
	}
}
`,ZR=`
uniform sampler2D texture_lightMap;
uniform sampler2D texture_dirLightMap;
void getLightMap() {
	dLightmap = $DECODE(texture2DBias(texture_lightMap, $UV, textureBias)).$CH;
	vec3 dir = texture2DBias(texture_dirLightMap, $UV, textureBias).xyz * 2.0 - 1.0;
	float dirDot = dot(dir, dir);
	dLightmapDir = (dirDot > 0.001) ? dir / sqrt(dirDot) : vec3(0.0);
}
`,JR=`
void getLightMap() {
	dLightmap = vec3(1.0);
	#ifdef MAPTEXTURE
	dLightmap *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;
	#endif
	#ifdef MAPVERTEX
	dLightmap *= saturate(vVertexColor.$VC);
	#endif
}
`,QR=`
float calcLightSpecular(float gloss, vec3 worldNormal, vec3 viewDir, vec3 h, vec3 lightDirNorm, mat3 tbn) {
	float PI = 3.141592653589793;
	float roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	float anisotropy = material_anisotropy * roughness;
 
	float at = max((roughness + anisotropy), roughness / 4.0);
	float ab = max((roughness - anisotropy), roughness / 4.0);
	float NoH = dot(worldNormal, h);
	float ToH = dot(tbn[0], h);
	float BoH = dot(tbn[1], h);
	float a2 = at * ab;
	vec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);
	float v2 = dot(v, v);
	float w2 = a2 / v2;
	float D = a2 * w2 * w2 * (1.0 / PI);
	float ToV = dot(tbn[0], viewDir);
	float BoV = dot(tbn[1], viewDir);
	float ToL = dot(tbn[0], -lightDirNorm);
	float BoL = dot(tbn[1], -lightDirNorm);
	float NoV = dot(worldNormal, viewDir);
	float NoL = dot(worldNormal, -lightDirNorm);
	float lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));
	float lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));
	float G = 0.5 / (lambdaV + lambdaL);
	return D * G;
}
float getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {
	return calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);
}
`,eL=`
float calcLightSpecular(float gloss, vec3 worldNormal, vec3 h) {
	float nh = max( dot( h, worldNormal ), 0.0 );
	float specPow = exp2(gloss * 11.0);
	specPow = max(specPow, 0.0001);
	return pow(nh, specPow) * (specPow + 2.0) / 8.0;
}
float getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {
	return calcLightSpecular(gloss, worldNormal, h);
}
`,tL=`
float calcLightSpecular(float gloss, vec3 reflDir, vec3 lightDirNorm) {
	float specPow = gloss;
	return pow(max(dot(reflDir, -lightDirNorm), 0.0), specPow + 0.0001);
}
float getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {
	return calcLightSpecular(gloss, reflDir, lightDirNorm);
}
`,sL=`
float sheenD(vec3 normal, vec3 h, float roughness) {
	float invR = 1.0 / (roughness * roughness);
	float cos2h = max(dot(normal, h), 0.0);
	cos2h *= cos2h;
	float sin2h = max(1.0 - cos2h, 0.0078125);
	return (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);
}
float sheenV(vec3 normal, vec3 viewDir, vec3 light) {
	float NoV = max(dot(normal, viewDir), 0.000001);
	float NoL = max(dot(normal, light), 0.000001);
	return 1.0 / (4.0 * (NoL + NoV - NoL * NoV));
}
float getLightSpecularSheen(vec3 h, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float sheenGloss) {
	float D = sheenD(worldNormal, h, sheenGloss);
	float V = sheenV(worldNormal, viewDir, -lightDirNorm);
	return D * V;
}
`,iL=`
#ifndef LINEARIZE_DEPTH
#define LINEARIZE_DEPTH
float linearizeDepth(float z, vec4 cameraParams) {
	if (cameraParams.w == 0.0)
		return (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));
	else
		return cameraParams.z + z * (cameraParams.y - cameraParams.z);
}
#ifndef CAMERAPLANES
#define CAMERAPLANES
uniform vec4 camera_params;
#endif
#ifdef GL2
float linearizeDepth(float z) {
	return linearizeDepth(z, camera_params);
}
#else
#ifndef UNPACKFLOAT
#define UNPACKFLOAT
float unpackFloat(vec4 rgbaDepth) {
	const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);
	return dot(rgbaDepth, bitShift);
}
#endif
#endif
#endif
`,nL=`
vec3 litArgs_albedo;
float litArgs_opacity;
vec3 litArgs_emission;
vec3 litArgs_worldNormal;
float litArgs_ao;
vec3 litArgs_lightmap;
vec3 litArgs_lightmapDir;
float litArgs_metalness;
vec3 litArgs_specularity;
float litArgs_specularityFactor;
float litArgs_gloss;
float litArgs_sheen_gloss;
vec3 litArgs_sheen_specularity;
float litArgs_transmission;
float litArgs_thickness;
float litArgs_ior;
float litArgs_iridescence_intensity;
float litArgs_iridescence_thickness;
vec3 litArgs_clearcoat_worldNormal;
float litArgs_clearcoat_specularity;
float litArgs_clearcoat_gloss;
`,rL=`
mat3 transposeMat3( const in mat3 m ) {
	mat3 tmp;
	tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );
	tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );
	tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );
	return tmp;
}
vec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	float dotNV = saturate( dot( N, V ) );
	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );
	uv = uv * LUT_SCALE + LUT_BIAS;
	return uv;
}
float LTC_ClippedSphereFormFactor( const in vec3 f ) {
	float l = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
vec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {
	float x = dot( v1, v2 );
	float y = abs( x );
	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	float b = 3.4175940 + ( 4.1616724 + y ) * y;
	float v = a / b;
	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;
	return cross( v1, v2 ) * theta_sintheta;
}
struct Coords {
	vec3 coord0;
	vec3 coord1;
	vec3 coord2;
	vec3 coord3;
};
float LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {
	vec3 v1 = rectCoords.coord1 - rectCoords.coord0;
	vec3 v2 = rectCoords.coord3 - rectCoords.coord0;
	
	vec3 lightNormal = cross( v1, v2 );
	float factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));
	vec3 T1, T2;
	T1 = normalize( V - N * dot( V, N ) );
	T2 =  factor * cross( N, T1 );
	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );
	vec3 coords[ 4 ];
	coords[ 0 ] = mat * ( rectCoords.coord0 - P );
	coords[ 1 ] = mat * ( rectCoords.coord1 - P );
	coords[ 2 ] = mat * ( rectCoords.coord2 - P );
	coords[ 3 ] = mat * ( rectCoords.coord3 - P );
	coords[ 0 ] = normalize( coords[ 0 ] );
	coords[ 1 ] = normalize( coords[ 1 ] );
	coords[ 2 ] = normalize( coords[ 2 ] );
	coords[ 3 ] = normalize( coords[ 3 ] );
	vec3 vectorFormFactor = vec3( 0.0 );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );
	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return result;
}
Coords dLTCCoords;
Coords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){
	Coords coords;
	coords.coord0 = lightPos + halfWidth - halfHeight;
	coords.coord1 = lightPos - halfWidth - halfHeight;
	coords.coord2 = lightPos - halfWidth + halfHeight;
	coords.coord3 = lightPos + halfWidth + halfHeight;
	return coords;
}
float dSphereRadius;
Coords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){
	dSphereRadius = max(length(halfWidth), length(halfHeight));
	vec3 f = reflect(normalize(lightPos - view_position), vNormalW);
	vec3 w = normalize(cross(f, halfHeight));
	vec3 h = normalize(cross(f, w));
	return getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);
}
vec2 dLTCUV;
#ifdef LIT_CLEARCOAT
vec2 ccLTCUV;
#endif
vec2 getLTCLightUV(float gloss, vec3 worldNormal, vec3 viewDir)
{
	float roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	return LTC_Uv( worldNormal, viewDir, roughness );
}
vec3 dLTCSpecFres;
#ifdef LIT_CLEARCOAT
vec3 ccLTCSpecFres;
#endif
vec3 getLTCLightSpecFres(vec2 uv, vec3 specularity)
{
	vec4 t2 = texture2DLodEXT(areaLightsLutTex2, uv, 0.0);
	#ifdef AREA_R8_G8_B8_A8_LUTS
	t2 *= vec4(0.693103,1,1,1);
	t2 += vec4(0.306897,0,0,0);
	#endif
	return specularity * t2.x + ( vec3( 1.0 ) - specularity) * t2.y;
}
void calcLTCLightValues(float gloss, vec3 worldNormal, vec3 viewDir, vec3 specularity, float clearcoatGloss, vec3 clearcoatWorldNormal, float clearcoatSpecularity)
{
	dLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);
	dLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity); 
#ifdef LIT_CLEARCOAT
	ccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);
	ccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(clearcoatSpecularity));
#endif
}
void calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)
{
	dLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);
}
void calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)
{
	calcRectLightValues(lightPos, halfWidth, halfHeight);
}
void calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)
{
	dLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);
}
vec3 SolveCubic(vec4 Coefficient)
{
	float pi = 3.14159;
	Coefficient.xyz /= Coefficient.w;
	Coefficient.yz /= 3.0;
	float A = Coefficient.w;
	float B = Coefficient.z;
	float C = Coefficient.y;
	float D = Coefficient.x;
	vec3 Delta = vec3(
		-Coefficient.z * Coefficient.z + Coefficient.y,
		-Coefficient.y * Coefficient.z + Coefficient.x,
		dot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)
	);
	float Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);
	vec3 RootsA, RootsD;
	vec2 xlc, xsc;
	{
		float A_a = 1.0;
		float C_a = Delta.x;
		float D_a = -2.0 * B * Delta.x + Delta.y;
		float Theta = atan(sqrt(Discriminant), -D_a) / 3.0;
		float x_1a = 2.0 * sqrt(-C_a) * cos(Theta);
		float x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);
		float xl;
		if ((x_1a + x_3a) > 2.0 * B)
			xl = x_1a;
		else
			xl = x_3a;
		xlc = vec2(xl - B, A);
	}
	{
		float A_d = D;
		float C_d = Delta.z;
		float D_d = -D * Delta.y + 2.0 * C * Delta.z;
		float Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;
		float x_1d = 2.0 * sqrt(-C_d) * cos(Theta);
		float x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);
		float xs;
		if (x_1d + x_3d < 2.0 * C)
			xs = x_1d;
		else
			xs = x_3d;
		xsc = vec2(-D, xs + C);
	}
	float E =  xlc.y * xsc.y;
	float F = -xlc.x * xsc.y - xlc.y * xsc.x;
	float G =  xlc.x * xsc.x;
	vec2 xmc = vec2(C * F - B * G, -B * F + C * E);
	vec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);
	if (Root.x < Root.y && Root.x < Root.z)
		Root.xyz = Root.yxz;
	else if (Root.z < Root.x && Root.z < Root.y)
		Root.xyz = Root.xzy;
	return Root;
}
float LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)
{
	vec3 T1, T2;
	T1 = normalize(V - N * dot(V, N));
	T2 = cross(N, T1);
	mat3 R = transposeMat3( mat3( T1, T2, N ) );
	vec3 L_[ 3 ];
	L_[ 0 ] = R * ( points.coord0 - P );
	L_[ 1 ] = R * ( points.coord1 - P );
	L_[ 2 ] = R * ( points.coord2 - P );
	vec3 Lo_i = vec3(0);
	vec3 C  = 0.5 * (L_[0] + L_[2]);
	vec3 V1 = 0.5 * (L_[1] - L_[2]);
	vec3 V2 = 0.5 * (L_[1] - L_[0]);
	C  = Minv * C;
	V1 = Minv * V1;
	V2 = Minv * V2;
	float a, b;
	float d11 = dot(V1, V1);
	float d22 = dot(V2, V2);
	float d12 = dot(V1, V2);
	if (abs(d12) / sqrt(d11 * d22) > 0.0001)
	{
		float tr = d11 + d22;
		float det = -d12 * d12 + d11 * d22;
		det = sqrt(det);
		float u = 0.5 * sqrt(tr - 2.0 * det);
		float v = 0.5 * sqrt(tr + 2.0 * det);
		float e_max = (u + v) * (u + v);
		float e_min = (u - v) * (u - v);
		vec3 V1_, V2_;
		if (d11 > d22)
		{
			V1_ = d12 * V1 + (e_max - d11) * V2;
			V2_ = d12 * V1 + (e_min - d11) * V2;
		}
		else
		{
			V1_ = d12*V2 + (e_max - d22)*V1;
			V2_ = d12*V2 + (e_min - d22)*V1;
		}
		a = 1.0 / e_max;
		b = 1.0 / e_min;
		V1 = normalize(V1_);
		V2 = normalize(V2_);
	}
	else
	{
		a = 1.0 / dot(V1, V1);
		b = 1.0 / dot(V2, V2);
		V1 *= sqrt(a);
		V2 *= sqrt(b);
	}
	vec3 V3 = cross(V1, V2);
	if (dot(C, V3) < 0.0)
		V3 *= -1.0;
	float L  = dot(V3, C);
	float x0 = dot(V1, C) / L;
	float y0 = dot(V2, C) / L;
	float E1 = inversesqrt(a);
	float E2 = inversesqrt(b);
	a *= L * L;
	b *= L * L;
	float c0 = a * b;
	float c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;
	float c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);
	float c3 = 1.0;
	vec3 roots = SolveCubic(vec4(c0, c1, c2, c3));
	float e1 = roots.x;
	float e2 = roots.y;
	float e3 = roots.z;
	vec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);
	mat3 rotate = mat3(V1, V2, V3);
	avgDir = rotate * avgDir;
	avgDir = normalize(avgDir);
	float L1 = sqrt(-e2 / e3);
	float L2 = sqrt(-e2 / e1);
	float formFactor = L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2));
	
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	vec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);
	uv = uv*LUT_SCALE + LUT_BIAS;
	float scale = texture2DLodEXT(areaLightsLutTex2, uv, 0.0).w;
	return formFactor*scale;
}
float getRectLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );
}
float getDiskLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	return LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );
}
float getSphereLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	float falloff = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);
	return getLightDiffuse(worldNormal, viewDir, lightDir, lightDirNorm) * falloff;
}
mat3 getLTCLightInvMat(vec2 uv)
{
	vec4 t1 = texture2DLodEXT(areaLightsLutTex1, uv, 0.0);
	#ifdef AREA_R8_G8_B8_A8_LUTS
	t1 *= vec4(1.001, 0.3239, 0.60437568, 1.0);
	t1 += vec4(0.0, -0.2976, -0.01381, 0.0);
	#endif
	return mat3(
		vec3( t1.x, 0, t1.y ),
		vec3(	0, 1,	0 ),
		vec3( t1.z, 0, t1.w )
	);
}
float calcRectLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {
	mat3 mInv = getLTCLightInvMat(uv);
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
float getRectLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcRectLightSpecular(worldNormal, viewDir, dLTCUV);
}
float calcDiskLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {
	mat3 mInv = getLTCLightInvMat(uv);
	return LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
float getDiskLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
float getSphereLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
`,aL=`
#ifdef MAPFLOAT
uniform float material_metalness;
#endif
void getMetalness() {
	float metalness = 1.0;
	#ifdef MAPFLOAT
	metalness *= material_metalness;
	#endif
	#ifdef MAPTEXTURE
	metalness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	metalness *= saturate(vVertexColor.$VC);
	#endif
	dMetalness = metalness;
}
`,oL=`
uniform sampler2D texture_msdfMap;
#ifdef GL_OES_standard_derivatives
#define USE_FWIDTH
#endif
#ifdef GL2
#define USE_FWIDTH
#endif
float median(float r, float g, float b) {
	return max(min(r, g), min(max(r, g), b));
}
float map (float min, float max, float v) {
	return (v - min) / (max - min);
}
uniform float font_sdfIntensity;
uniform float font_pxrange;
uniform float font_textureWidth;
#ifdef UNIFORM_TEXT_PARAMETERS
uniform vec4 outline_color;
uniform float outline_thickness;
uniform vec4 shadow_color;
uniform vec2 shadow_offset;
#else
varying vec4 outline_color;
varying float outline_thickness;
varying vec4 shadow_color;
varying vec2 shadow_offset;
#endif
vec4 applyMsdf(vec4 color) {
	vec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;
	vec2 uvShdw = vUv0 - shadow_offset;
	vec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;
	float sigDist = median(tsample.r, tsample.g, tsample.b);
	float sigDistShdw = median(ssample.r, ssample.g, ssample.b);
	float smoothingMax = 0.2;
	#ifdef USE_FWIDTH
	vec2 w = fwidth(vUv0);
	float smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);
	#else
	float font_size = 16.0;
	float smoothing = clamp(font_pxrange / font_size, 0.0, smoothingMax);
	#endif
	float mapMin = 0.05;
	float mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);
	float sigDistInner = map(mapMin, mapMax, sigDist);
	float sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);
	sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);
	float center = 0.5;
	float inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);
	float outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);
	float shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);
	vec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);
	tcolor = mix(tcolor, color, inside);
	vec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;
	tcolor = mix(scolor, tcolor, outline);
	
	return tcolor;
}
`,lL=`
vec3 getSpecularModulate(in vec3 specularity, in vec3 albedo, in float metalness, in float f0) {
	vec3 dielectricF0 = f0 * specularity;
	return mix(dielectricF0, albedo, metalness);
}
vec3 getAlbedoModulate(in vec3 albedo, in float metalness) {
	return albedo * (1.0 - metalness);
}
`,hL=`
attribute vec3 vertex_outlineParameters;
attribute vec3 vertex_shadowParameters;
varying vec4 outline_color;
varying float outline_thickness;
varying vec4 shadow_color;
varying vec2 shadow_offset;
void unpackMsdfParams() {
	vec3 little = mod(vertex_outlineParameters, 256.);
	vec3 big = (vertex_outlineParameters - little) / 256.;
	outline_color.rb = little.xy / 255.;
	outline_color.ga = big.xy / 255.;
	outline_thickness = little.z / 255. * 0.2;
	little = mod(vertex_shadowParameters, 256.);
	big = (vertex_shadowParameters - little) / 256.;
	shadow_color.rb = little.xy / 255.;
	shadow_color.ga = big.xy / 255.;
	shadow_offset = (vec2(little.z, big.z) / 127. - 1.) * 0.005;
}
`,cL=`
#ifdef MORPHING_TEXTURE_BASED_NORMAL
uniform highp sampler2D morphNormalTex;
#endif
vec3 getNormal() {
	#ifdef SKIN
	dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);
	#elif defined(INSTANCING)
	dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);
	#else
	dNormalMatrix = matrix_normal;
	#endif
	vec3 tempNormal = vertex_normal;
	#ifdef MORPHING
	#ifdef MORPHING_NRM03
	tempNormal += morph_weights_a[0] * morph_nrm0;
	tempNormal += morph_weights_a[1] * morph_nrm1;
	tempNormal += morph_weights_a[2] * morph_nrm2;
	tempNormal += morph_weights_a[3] * morph_nrm3;
	#endif
	#ifdef MORPHING_NRM47
	tempNormal += morph_weights_b[0] * morph_nrm4;
	tempNormal += morph_weights_b[1] * morph_nrm5;
	tempNormal += morph_weights_b[2] * morph_nrm6;
	tempNormal += morph_weights_b[3] * morph_nrm7;
	#endif
	#endif
	#ifdef MORPHING_TEXTURE_BASED_NORMAL
		#ifdef WEBGPU
			ivec2 morphUV = getTextureMorphCoords();
			vec3 morphNormal = texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz;
		#else
			vec2 morphUV = getTextureMorphCoords();
			vec3 morphNormal = texture2D(morphNormalTex, morphUV).xyz;
		#endif
	tempNormal += morphNormal;
	#endif
	return normalize(dNormalMatrix * tempNormal);
}
`,dL=`
#ifdef MAPTEXTURE
uniform float material_normalDetailMapBumpiness;
vec3 blendNormals(vec3 n1, vec3 n2) {
	n1 += vec3(0, 0, 1);
	n2 *= vec3(-1, -1, 1);
	return n1 * dot(n1, n2) / n1.z - n2;
}
#endif
vec3 addNormalDetail(vec3 normalMap) {
#ifdef MAPTEXTURE
	vec3 normalDetailMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));
	normalDetailMap = mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness);
	return blendNormals(normalMap, normalDetailMap);
#else
	return normalMap;
#endif
}
`,uL=`
vec3 getNormal() {
	dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);
	return normalize(dNormalMatrix * vertex_normal);
}
`,fL=`
#ifdef MAPTEXTURE
uniform float material_bumpiness;
#endif
void getNormal() {
#ifdef MAPTEXTURE
	vec3 normalMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));
	normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);
	dNormalW = normalize(dTBN * addNormalDetail(normalMap));
#else
	dNormalW = dVertexNormalW;
#endif
}
`,pL=`
vec3 getNormal() {
	dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);
	return normalize(dNormalMatrix * vertex_normal);
}
`,mL=`
vec3 unpackNormal(vec4 nmap) {
	vec3 normal;
	normal.xy = nmap.wy * 2.0 - 1.0;
	normal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));
	return normal;
}
`,_L=`
vec3 unpackNormal(vec4 nmap) {
	return nmap.xyz * 2.0 - 1.0;
}
`,gL=`
#ifdef MAPFLOAT
uniform float material_opacity;
#endif
void getOpacity() {
	dAlpha = 1.0;
	#ifdef MAPFLOAT
	dAlpha *= material_opacity;
	#endif
	#ifdef MAPTEXTURE
	dAlpha *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	dAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);
	#endif
}
`,yL=`
uniform vec4 blueNoiseJitter;
#ifndef DITHER_BAYER8
	uniform sampler2D blueNoiseTex32;
#endif
void opacityDither(float alpha, float id) {
	#ifdef DITHER_BAYER8
		float noise = bayer8(floor(mod(gl_FragCoord.xy + blueNoiseJitter.xy + id, 8.0))) / 64.0;
	#else
		vec2 uv = fract(gl_FragCoord.xy / 32.0 + blueNoiseJitter.xy + id);
		float noise = texture2DLodEXT(blueNoiseTex32, uv, 0.0).y;
	#endif
	if (alpha < noise)
		discard;
}
`,vL=`
`,SL=`
gl_FragColor.a = litArgs_opacity;
`,xL=`
	gl_FragColor.a = 1.0;
`,wL=`
gl_FragColor.rgb *= litArgs_opacity;
gl_FragColor.a = litArgs_opacity;
`,bL=`
varying vec2 vUv0;
uniform sampler2D source;
void main(void) {
	gl_FragColor = texture2D(source, vUv0);
}
`,TL=`
vec4 packFloat(float depth) {
	const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);
	const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);
	vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);
	res -= res.xxyz * bit_mask;
	return res;
}
`,EL=`
#ifdef MAPCOLOR
uniform vec3 material_sheen;
#endif
void getSheen() {
	vec3 sheenColor = vec3(1, 1, 1);
	#ifdef MAPCOLOR
	sheenColor *= material_sheen;
	#endif
	#ifdef MAPTEXTURE
	sheenColor *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;
	#endif
	#ifdef MAPVERTEX
	sheenColor *= saturate(vVertexColor.$VC);
	#endif
	sSpecularity = sheenColor;
}
`,CL=`
#ifdef MAPFLOAT
uniform float material_sheenGloss;
#endif
void getSheenGlossiness() {
	float sheenGlossiness = 1.0;
	#ifdef MAPFLOAT
	sheenGlossiness *= material_sheenGloss;
	#endif
	#ifdef MAPTEXTURE
	sheenGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	sheenGlossiness *= saturate(vVertexColor.$VC);
	#endif
	#ifdef MAPINVERT
	sheenGlossiness = 1.0 - sheenGlossiness;
	#endif
	sheenGlossiness += 0.0000001;
	sGlossiness = sheenGlossiness;
}
`,AL=`
uniform float material_heightMapFactor;
void getParallax() {
	float parallaxScale = material_heightMapFactor;
	float height = texture2DBias($SAMPLER, $UV, textureBias).$CH;
	height = height * parallaxScale - parallaxScale*0.5;
	vec3 viewDirT = dViewDirW * dTBN;
	viewDirT.z += 0.42;
	dUvOffset = height * (viewDirT.xy / viewDirT.z);
}
`,PL=`
varying vec4 texCoordsAlphaLife;
uniform sampler2D colorMap;
uniform sampler2D colorParam;
uniform float graphSampleSize;
uniform float graphNumSamples;
#ifndef CAMERAPLANES
#define CAMERAPLANES
uniform vec4 camera_params;
#endif
uniform float softening;
uniform float colorMult;
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
#ifndef UNPACKFLOAT
#define UNPACKFLOAT
float unpackFloat(vec4 rgbaDepth) {
	const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);
	float depth = dot(rgbaDepth, bitShift);
	return depth;
}
#endif
void main(void) {
	vec4 tex  = gammaCorrectInput(texture2D(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)));
	vec4 ramp = gammaCorrectInput(texture2D(colorParam, vec2(texCoordsAlphaLife.w, 0.0)));
	ramp.rgb *= colorMult;
	ramp.a += texCoordsAlphaLife.z;
	vec3 rgb = tex.rgb * ramp.rgb;
	float a  = tex.a * ramp.a;
`,ML=`
vec3 unpack3NFloats(float src) {
	float r = fract(src);
	float g = fract(src * 256.0);
	float b = fract(src * 65536.0);
	return vec3(r, g, b);
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc) {
	return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );
}
vec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {
	vec4 a = texture2D(tex,tc);
	vec4 b = texture2D(tex,tc + graphSampleSize);
	float c = fract(tc.x*graphNumSamples);
	vec3 unpackedA = unpack3NFloats(a.w);
	vec3 unpackedB = unpack3NFloats(b.w);
	w = mix(unpackedA, unpackedB, c);
	return mix(a, b, c);
}
vec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {
	float c = cos(pRotation);
	float s = sin(pRotation);
	mat2 m = mat2(c, -s, s, c);
	rotMatrix = m;
	return m * quadXY;
}
vec3 billboard(vec3 InstanceCoords, vec2 quadXY) {
	#ifdef SCREEN_SPACE
		vec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;
	#else
		vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;
	#endif
	return pos;
}
vec3 customFace(vec3 InstanceCoords, vec2 quadXY) {
	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;
	return pos;
}
vec2 safeNormalize(vec2 v) {
	float l = length(v);
	return (l > 1e-06) ? v / l : v;
}
void main(void) {
	vec3 meshLocalPos = particle_vertexData.xyz;
	float id = floor(particle_vertexData.w);
	float rndFactor = fract(sin(id + 1.0 + seed));
	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
	float uv = id / numParticlesPot;
	readInput(uv);
#ifdef LOCAL_SPACE
	inVel = mat3(matrix_model) * inVel;
#endif
	vec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);
	float particleLifetime = lifetime;
	if (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);
	vec2 quadXY = meshLocalPos.xy;
	float nlife = clamp(inLife / particleLifetime, 0.0, 1.0);
	vec3 paramDiv;
	vec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);
	float scale = params.y;
	float scaleDiv = paramDiv.x;
	float alphaDiv = paramDiv.z;
	scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);
#ifndef USE_MESH
	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);
#else
	texCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);
#endif
	vec3 particlePos = inPos;
	vec3 particlePosMoved = vec3(0.0);
	mat2 rotMatrix;
`,IL=`
	float animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);
`,RL=`
	float animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));
`,LL=`
	float animationIndex;
	if (animTexIndexParams.y == 1.0) {
		animationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);
	} else {
		animationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);
	}
	float atlasX = (animationIndex + animFrame) * animTexTilesParams.x;
	float atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;
	atlasX = fract(atlasX);
	texCoordsAlphaLife.xy *= animTexTilesParams.xy;
	texCoordsAlphaLife.xy += vec2(atlasX, atlasY);
`,DL=`
void readInput(float uv) {
	vec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));
	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));
	inPos = tex.xyz;
	inVel = tex2.xyz;
	inAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;
	inShow = tex.w >= 0.0;
	inLife = tex2.w;
}
`,OL=`
#define PI2 6.283185307179586
uniform vec3 inBoundsSize;
uniform vec3 inBoundsCenter;
uniform float maxVel;
float decodeFloatRG(vec2 rg) {
	return rg.y*(1.0/255.0) + rg.x;
}
float decodeFloatRGBA( vec4 rgba ) {
	return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );
}
void readInput(float uv) {
	vec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));
	vec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));
	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));
	vec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));
	inPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));
	inPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;
	inVel = tex2.xyz;
	inVel = (inVel - vec3(0.5)) * maxVel;
	inAngle = decodeFloatRG(tex1.ba) * PI2;
	inShow = tex2.a > 0.5;
	inLife = decodeFloatRGBA(tex3);
	float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));
	float maxPosLife = lifetime+1.0;
	inLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;
}
`,FL=`
void writeOutput() {
	if (gl_FragCoord.y<1.0) {
		gl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);
	} else {
		gl_FragColor = vec4(outVel, outLife);
	}
}
`,kL=`
uniform vec3 outBoundsMul;
uniform vec3 outBoundsAdd;
vec2 encodeFloatRG( float v ) {
	vec2 enc = vec2(1.0, 255.0) * v;
	enc = fract(enc);
	enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);
	return enc;
}
vec4 encodeFloatRGBA( float v ) {
	vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;
	enc = fract(enc);
	enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);
	return enc;
}
void writeOutput() {
	outPos = outPos * outBoundsMul + outBoundsAdd;
	outAngle = fract(outAngle / PI2);
	outVel = (outVel / maxVel) + vec3(0.5);
	float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));
	float maxPosLife = lifetime+1.0;
	outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);
	if (gl_FragCoord.y < 1.0) {
		gl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));
	} else if (gl_FragCoord.y < 2.0) {
		gl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));
	} else if (gl_FragCoord.y < 3.0) {
		gl_FragColor = vec4(outVel, visMode*0.5+0.5);
	} else {
		gl_FragColor = encodeFloatRGBA(outLife);
	}
}
`,BL=`
uniform mat3 spawnBounds;
uniform vec3 spawnPosInnerRatio;
vec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {
	vec3 pos = inBounds - vec3(0.5);
	vec3 posAbs = abs(pos);
	vec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));
	vec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;
	pos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);
	pos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);
	pos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);
#ifndef LOCAL_SPACE
	return emitterPos + spawnBounds * pos;
#else
	return spawnBounds * pos;
#endif
}
void addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {
	localVelocity -= vec3(0, 0, initialVelocity);
}
`,NL=`
	writeOutput();
}
`,UL=`
varying vec2 vUv0;
uniform highp sampler2D particleTexIN;
uniform highp sampler2D internalTex0;
uniform highp sampler2D internalTex1;
uniform highp sampler2D internalTex2;
uniform highp sampler2D internalTex3;
uniform mat3 emitterMatrix, emitterMatrixInv;
uniform vec3 emitterScale;
uniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;
uniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;
uniform float startAngle, startAngle2;
uniform float initialVelocity;
uniform float graphSampleSize;
uniform float graphNumSamples;
vec3 inPos;
vec3 inVel;
float inAngle;
bool inShow;
float inLife;
float visMode;
vec3 outPos;
vec3 outVel;
float outAngle;
bool outShow;
float outLife;
`,zL=`
	if (outLife >= lifetime) {
		outLife -= max(lifetime, (numParticles - 1.0) * particleRate);
		visMode = -1.0;
	}
`,VL=`
	visMode = outLife < 0.0? -1.0: visMode;
`,GL=`
	if (outLife >= lifetime) {
		outLife -= max(lifetime, (numParticles - 1.0) * particleRate);
		visMode = 1.0;
	}
	visMode = outLife < 0.0? 1.0: visMode;
`,HL=`
uniform float spawnBoundsSphere;
uniform float spawnBoundsSphereInnerRatio;
vec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {
	float rnd4 = fract(rndFactor * 1000.0);
	vec3 norm = normalize(inBounds.xyz - vec3(0.5));
	float r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;
#ifndef LOCAL_SPACE
	return emitterPos + norm * r * spawnBoundsSphere;
#else
	return norm * r * spawnBoundsSphere;
#endif
}
void addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {
	localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;
}
`,WL=`
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec3 unpack3NFloats(float src) {
	float r = fract(src);
	float g = fract(src * 256.0);
	float b = fract(src * 65536.0);
	return vec3(r, g, b);
}
vec3 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {
	vec4 a = texture2D(tex, tc);
	vec4 b = texture2D(tex, tc + graphSampleSize);
	float c = fract(tc.x * graphNumSamples);
	vec3 unpackedA = unpack3NFloats(a.w);
	vec3 unpackedB = unpack3NFloats(b.w);
	w = mix(unpackedA, unpackedB, c);
	return mix(a.xyz, b.xyz, c);
}
#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)
vec4 hash41(float p) {
	vec4 p4 = fract(vec4(p) * HASHSCALE4);
	p4 += dot(p4, p4.wzxy+19.19);
	return fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));
}
void main(void) {
	if (gl_FragCoord.x > numParticles) discard;
	readInput(vUv0.x);
	visMode = inShow? 1.0 : -1.0;
	vec4 rndFactor = hash41(gl_FragCoord.x + seed);
	float particleRate = rate + rateDiv * rndFactor.x;
	outLife = inLife + delta;
	float nlife = clamp(outLife / lifetime, 0.0, 1.0);
	vec3 localVelocityDiv;
	vec3 velocityDiv;
	vec3 paramDiv;
	vec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);
	vec3 velocity =	  tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);
	vec3 params =		tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);
	float rotSpeed = params.x;
	float rotSpeedDiv = paramDiv.y;
	vec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);
	float radialSpeed = radialParams.x;
	float radialSpeedDiv = radialParams.y;
	bool respawn = inLife <= 0.0 || outLife >= lifetime;
	inPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;
	inAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;
#ifndef LOCAL_SPACE
	vec3 radialVel = inPos - emitterPos;
#else
	vec3 radialVel = inPos;
#endif
	radialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);
	radialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;
	localVelocity +=	(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;
	velocity +=		 (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;
	rotSpeed +=		 (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;
	addInitialVelocity(localVelocity, rndFactor.xyz);
#ifndef LOCAL_SPACE
	outVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;
#else
	outVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;
#endif
	outPos = inPos + outVel * delta;
	outAngle = inAngle + rotSpeed * delta;
`,jL=`
	quadXY = rotate(quadXY, inAngle, rotMatrix);
	vec3 localPos = billboard(particlePos, quadXY);
`,$L=`
	dBlendModeFogFactor = 0.0;
	rgb *= saturate(gammaCorrectInput(max(a, 0.0)));
	if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;
`,XL=`
	rgb = mix(vec3(1.0), rgb, vec3(a));
	if (rgb.r + rgb.g + rgb.b > 2.99) discard;
`,qL=`
	if (a < 0.01) discard;
`,KL=`
attribute vec4 particle_vertexData;
attribute vec4 particle_vertexData2;
attribute vec4 particle_vertexData3;
attribute float particle_vertexData4;
#ifndef USE_MESH
attribute vec2 particle_vertexData5;
#else
attribute vec4 particle_vertexData5;
#endif
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
uniform mat3 matrix_normal;
uniform mat4 matrix_viewInverse;
uniform float numParticles;
uniform float lifetime;
uniform float stretch;
uniform float seed;
uniform vec3 wrapBounds;
uniform vec3 emitterScale;
uniform vec3 faceTangent;
uniform vec3 faceBinorm;
uniform highp sampler2D internalTex0;
uniform highp sampler2D internalTex1;
uniform highp sampler2D internalTex2;
uniform vec3 emitterPos;
varying vec4 texCoordsAlphaLife;
vec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)
{
	float c = cos(pRotation);
	float s = sin(pRotation);
	mat2 m = mat2(c, -s, s, c);
	rotMatrix = m;
	return m * quadXY;
}
vec3 billboard(vec3 InstanceCoords, vec2 quadXY)
{
	vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;
	return pos;
}
vec3 customFace(vec3 InstanceCoords, vec2 quadXY)
{
	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;
	return pos;
}
void main(void)
{
	vec3 particlePos = particle_vertexData.xyz;
	vec3 inPos = particlePos;
	vec3 vertPos = particle_vertexData3.xyz;
	vec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);
	float id = floor(particle_vertexData4);
	float rndFactor = fract(sin(id + 1.0 + seed));
	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
#ifdef LOCAL_SPACE
	inVel = mat3(matrix_model) * inVel;
#endif
	vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);
	vec2 quadXY = vertPos.xy;
#ifdef USE_MESH
	texCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);
#else
	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);
#endif
	mat2 rotMatrix;
	float inAngle = particle_vertexData2.x;
	vec3 particlePosMoved = vec3(0.0);
	vec3 meshLocalPos = particle_vertexData3.xyz;
`,YL=`
	localPos *= particle_vertexData2.y * emitterScale;
	localPos += particlePos;
	gl_Position = matrix_viewProjection * vec4(localPos, 1.0);
`,ZL=`
	quadXY = rotate(quadXY, inAngle, rotMatrix);
	vec3 localPos = customFace(particlePos, quadXY);
`,JL=`
	rgb = addFog(rgb);
	rgb = toneMap(rgb);
	rgb = gammaCorrectOutput(rgb);
	gl_FragColor = vec4(rgb, a);
}
`,QL=`
	localPos *= scale * emitterScale;
	localPos += particlePos;
	#ifdef SCREEN_SPACE
	gl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);
	#else
	gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);
	#endif
`,eD=`
	vec3 negNormal = normal*0.5+0.5;
	vec3 posNormal = -normal*0.5+0.5;
	negNormal *= negNormal;
	posNormal *= posNormal;
`,tD=`
attribute vec4 particle_vertexData;
#ifdef USE_MESH
attribute vec2 particle_uv;
#endif
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
uniform mat3 matrix_normal;
uniform mat4 matrix_viewInverse;
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
uniform float numParticles, numParticlesPot;
uniform float graphSampleSize;
uniform float graphNumSamples;
uniform float stretch;
uniform vec3 wrapBounds;
uniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;
uniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;
uniform sampler2D particleTexOUT, particleTexIN;
uniform highp sampler2D internalTex0;
uniform highp sampler2D internalTex1;
uniform highp sampler2D internalTex2;
#ifndef CAMERAPLANES
#define CAMERAPLANES
uniform vec4 camera_params;
#endif
varying vec4 texCoordsAlphaLife;
vec3 inPos;
vec3 inVel;
float inAngle;
bool inShow;
float inLife;
`,sD=`
	vec3 negNormal = max(normal, vec3(0.0));
	vec3 posNormal = max(-normal, vec3(0.0));
`,iD=`
	vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +
						negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +
						negNormal.z*lightCube[4] + posNormal.z*lightCube[5];
	rgb *= light;
`,nD=`
	particlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;
`,rD=`
	vec3 localPos = meshLocalPos;
	localPos.xy = rotate(localPos.xy, inAngle, rotMatrix);
	localPos.yz = rotate(localPos.yz, inAngle, rotMatrix);
	billboard(particlePos, quadXY);
`,aD=`
	Normal = normalize(localPos + matrix_viewInverse[2].xyz);
`,oD=`
	vec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);
	vec3 normal = ParticleMat * normalMap;
`,lD=`
	inAngle = atan(velocityV.x, velocityV.y);
`,hD=`
	float depth = getLinearScreenDepth();
	float particleDepth = vDepth;
	float depthDiff = saturate(abs(particleDepth - depth) * softening);
	a *= depthDiff;
`,cD=`
	vDepth = getLinearDepth(localPos);
`,dD=`
	vec3 moveDir = inVel * stretch;
	vec3 posPrev = particlePos - moveDir;
	posPrev += particlePosMoved;
	vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);
	float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;
	particlePos = mix(particlePos, posPrev, interpolation);
`,uD=`
	mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);
	ParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;
`,fD=`
	vec3 origParticlePos = particlePos;
	particlePos -= matrix_model[3].xyz;
	particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;
	particlePos += matrix_model[3].xyz;
	particlePosMoved = particlePos - origParticlePos;
`,pD=`
void getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {
	dReflDirW = normalize(-reflect(viewDir, worldNormal));
}
`,mD=`
void getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {
	float roughness = sqrt(1.0 - min(gloss, 1.0));
	float anisotropy = material_anisotropy * roughness;
	vec3 anisotropicDirection = anisotropy >= 0.0 ? tbn[1] : tbn[0];
	vec3 anisotropicTangent = cross(anisotropicDirection, viewDir);
	vec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);
	vec3 bentNormal = normalize(mix(normalize(worldNormal), normalize(anisotropicNormal), anisotropy));
	dReflDirW = reflect(-viewDir, bentNormal);
}
`,_D=`
#ifdef LIT_CLEARCOAT
void addReflectionCC(vec3 reflDir, float gloss) {
	ccReflection += calcReflection(reflDir, gloss);
}
#endif
`,gD=`
uniform samplerCube texture_cubeMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 lookupVec = fixSeams(cubeMapProject(reflDir));
	lookupVec.x *= -1.0;
	return $DECODE(textureCube(texture_cubeMap, lookupVec));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,yD=`
#ifndef ENV_ATLAS
#define ENV_ATLAS
uniform sampler2D texture_envAtlas;
#endif
uniform samplerCube texture_cubeMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);
	vec2 uv = toSphericalUv(dir);
	float level = saturate(1.0 - gloss) * 5.0;
	float ilevel = floor(level);
	float flevel = level - ilevel;
	vec3 sharp = $DECODE_CUBEMAP(textureCube(texture_cubeMap, fixSeams(dir)));
	vec3 roughA = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel)));
	vec3 roughB = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,vD=`
#ifndef ENV_ATLAS
#define ENV_ATLAS
uniform sampler2D texture_envAtlas;
#endif
uniform float material_reflectivity;
float shinyMipLevel(vec2 uv) {
	vec2 dx = dFdx(uv);
	vec2 dy = dFdy(uv);
	vec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);
	vec2 dx2 = dFdx(uv2);
	vec2 dy2 = dFdy(uv2);
	float maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));
	return clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);
}
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);
	vec2 uv = toSphericalUv(dir);
	float level = saturate(1.0 - gloss) * 5.0;
	float ilevel = floor(level);
	float level2 = shinyMipLevel(uv * atlasSize);
	float ilevel2 = floor(level2);
	vec2 uv0, uv1;
	float weight;
	if (ilevel == 0.0) {
		uv0 = mapShinyUv(uv, ilevel2);
		uv1 = mapShinyUv(uv, ilevel2 + 1.0);
		weight = level2 - ilevel2;
	} else {
		uv0 = uv1 = mapRoughnessUv(uv, ilevel);
		weight = 0.0;
	}
	vec3 linearA = $DECODE(texture2D(texture_envAtlas, uv0));
	vec3 linearB = $DECODE(texture2D(texture_envAtlas, uv1));
	vec3 linear0 = mix(linearA, linearB, weight);
	vec3 linear1 = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(linear0, linear1, level - ilevel));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,SD=`
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
uniform sampler2D texture_sphereMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 reflDirV = (mat3(matrix_view) * reflDir).xyz;
	float m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );
	vec2 sphereMapUv = reflDirV.xy / m + 0.5;
	return $DECODE(texture2D(texture_sphereMap, sphereMapUv));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,xD=`
void addReflectionSheen(vec3 worldNormal, vec3 viewDir, float gloss) {
	float NoV = dot(worldNormal, viewDir);
	float alphaG = gloss * gloss;
	float a = gloss < 0.25 ? -339.2 * alphaG + 161.4 * gloss - 25.9 : -8.48 * alphaG + 14.3 * gloss - 9.95;
	float b = gloss < 0.25 ? 44.0 * alphaG - 23.7 * gloss + 3.26 : 1.97 * alphaG - 3.27 * gloss + 0.72;
	float DG = exp( a * NoV + b ) + ( gloss < 0.25 ? 0.0 : 0.1 * ( gloss - 0.25 ) );
	sReflection += calcReflection(worldNormal, 0.0) * saturate(DG);
}
`,wD=`
vec3 refract2(vec3 viewVec, vec3 normal, float IOR) {
	float vn = dot(viewVec, normal);
	float k = 1.0 - IOR * IOR * (1.0 - vn * vn);
	vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;
	return refrVec;
}
void addRefraction(
	vec3 worldNormal, 
	vec3 viewDir, 
	float thickness, 
	float gloss, 
	vec3 specularity, 
	vec3 albedo, 
	float transmission,
	float refractionIndex
#if defined(LIT_IRIDESCENCE)
	, vec3 iridescenceFresnel,
	float iridescenceIntensity
#endif 
) {
	vec4 tmpRefl = dReflection;
	vec3 reflectionDir = refract2(-viewDir, worldNormal, refractionIndex);
	dReflection = vec4(0);
	addReflection(reflectionDir, gloss);
	dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);
	dReflection = tmpRefl;
}
`,bD=`
uniform float material_invAttenuationDistance;
uniform vec3 material_attenuation;
void addRefraction(
	vec3 worldNormal, 
	vec3 viewDir, 
	float thickness, 
	float gloss, 
	vec3 specularity, 
	vec3 albedo, 
	float transmission,
	float refractionIndex
#if defined(LIT_IRIDESCENCE)
	, vec3 iridescenceFresnel,
	float iridescenceIntensity
#endif
) {
	vec3 modelScale;
	modelScale.x = length(vec3(matrix_model[0].xyz));
	modelScale.y = length(vec3(matrix_model[1].xyz));
	modelScale.z = length(vec3(matrix_model[2].xyz));
	vec3 refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * thickness * modelScale;
	vec4 pointOfRefraction = vec4(vPositionW + refractionVector, 1.0);
	vec4 projectionPoint = matrix_viewProjection * pointOfRefraction;
	vec2 uv = getGrabScreenPos(projectionPoint);
	#ifdef SUPPORTS_TEXLOD
		float iorToRoughness = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);
		float refractionLod = log2(uScreenSize.x) * iorToRoughness;
		vec3 refraction = texture2DLodEXT(uSceneColorMap, uv, refractionLod).rgb;
	#else
		vec3 refraction = texture2D(uSceneColorMap, uv).rgb;
	#endif
	vec3 transmittance;
	if (material_invAttenuationDistance != 0.0)
	{
		vec3 attenuation = -log(material_attenuation) * material_invAttenuationDistance;
		transmittance = exp(-attenuation * length(refractionVector));
	}
	else
	{
		transmittance = refraction;
	}
	vec3 fresnel = vec3(1.0) - 
		getFresnel(
			dot(viewDir, worldNormal), 
			gloss, 
			specularity
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			iridescenceIntensity
		#endif
		);
	dDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);
}
`,TD=`
varying vec2 vUv0;
#ifdef CUBEMAP_SOURCE
	uniform samplerCube sourceCube;
#else
	uniform sampler2D sourceTex;
#endif
#ifdef USE_SAMPLES_TEX
	uniform sampler2D samplesTex;
	uniform vec2 samplesTexInverseSize;
#endif
uniform vec4 params;
uniform vec2 params2;
float targetFace() { return params.x; }
float specularPower() { return params.y; }
float sourceCubeSeamScale() { return params.z; }
float targetCubeSeamScale() { return params.w; }
float targetTotalPixels() { return params2.x; }
float sourceTotalPixels() { return params2.y; }
float PI = 3.141592653589793;
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
${Ub}
${zb}
vec3 modifySeams(vec3 dir, float scale) {
	vec3 adir = abs(dir);
	float M = max(max(adir.x, adir.y), adir.z);
	return dir / M * vec3(
		adir.x == M ? 1.0 : scale,
		adir.y == M ? 1.0 : scale,
		adir.z == M ? 1.0 : scale
	);
}
vec2 toSpherical(vec3 dir) {
	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));
}
vec3 fromSpherical(vec2 uv) {
	return vec3(cos(uv.y) * sin(uv.x),
				sin(uv.y),
				cos(uv.y) * cos(uv.x));
}
vec3 getDirectionEquirect() {
	return fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));
}
float signNotZero(float k){
	return(k >= 0.0) ? 1.0 : -1.0;
}
vec2 signNotZero(vec2 v) {
	return vec2(signNotZero(v.x), signNotZero(v.y));
}
vec3 octDecode(vec2 o) {
	vec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);
	if (v.y < 0.0) {
		v.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);
	}
	return normalize(v);
}
vec3 getDirectionOctahedral() {
	return octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);
}
vec2 octEncode(in vec3 v) {
	float l1norm = abs(v.x) + abs(v.y) + abs(v.z);
	vec2 result = v.xz * (1.0 / l1norm);
	if (v.y < 0.0) {
		result = (1.0 - abs(result.yx)) * signNotZero(result.xy);
	}
	return result;
}
#ifdef CUBEMAP_SOURCE
	vec4 sampleCubemap(vec3 dir) {
		return textureCube(sourceCube, modifySeams(dir, 1.0 - sourceCubeSeamScale()));
	}
	vec4 sampleCubemap(vec2 sph) {
	return sampleCubemap(fromSpherical(sph));
}
	vec4 sampleCubemap(vec3 dir, float mipLevel) {
		return textureCubeLodEXT(sourceCube, modifySeams(dir, 1.0 - exp2(mipLevel) * sourceCubeSeamScale()), mipLevel);
	}
	vec4 sampleCubemap(vec2 sph, float mipLevel) {
		return sampleCubemap(fromSpherical(sph), mipLevel);
	}
#else
	vec4 sampleEquirect(vec2 sph) {
		vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;
		return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));
	}
	vec4 sampleEquirect(vec3 dir) {
		return sampleEquirect(toSpherical(dir));
	}
	vec4 sampleEquirect(vec2 sph, float mipLevel) {
		vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;
		return texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);
	}
	vec4 sampleEquirect(vec3 dir, float mipLevel) {
		return sampleEquirect(toSpherical(dir), mipLevel);
	}
	vec4 sampleOctahedral(vec3 dir) {
		vec2 uv = octEncode(dir) * 0.5 + 0.5;
		return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));
	}
	vec4 sampleOctahedral(vec2 sph) {
		return sampleOctahedral(fromSpherical(sph));
	}
	vec4 sampleOctahedral(vec3 dir, float mipLevel) {
		vec2 uv = octEncode(dir) * 0.5 + 0.5;
		return texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);
	}
	vec4 sampleOctahedral(vec2 sph, float mipLevel) {
		return sampleOctahedral(fromSpherical(sph), mipLevel);
	}
#endif
vec3 getDirectionCubemap() {
	vec2 st = vUv0 * 2.0 - 1.0;
	float face = targetFace();
	vec3 vec;
	if (face == 0.0) {
		vec = vec3(1, -st.y, -st.x);
	} else if (face == 1.0) {
		vec = vec3(-1, -st.y, st.x);
	} else if (face == 2.0) {
		vec = vec3(st.x, 1, st.y);
	} else if (face == 3.0) {
		vec = vec3(st.x, -1, -st.y);
	} else if (face == 4.0) {
		vec = vec3(st.x, -st.y, 1);
	} else {
		vec = vec3(-st.x, -st.y, -1);
	}
	return normalize(modifySeams(vec, 1.0 / (1.0 - targetCubeSeamScale())));
}
mat3 matrixFromVector(vec3 n) {
	float a = 1.0 / (1.0 + n.z);
	float b = -n.x * n.y * a;
	vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);
	vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);
	return mat3(b1, b2, n);
}
mat3 matrixFromVectorSlow(vec3 n) {
	vec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);
	vec3 x = normalize(cross(up, n));
	vec3 y = cross(n, x);
	return mat3(x, y, n);
}
vec4 reproject() {
	if (NUM_SAMPLES <= 1) {
		return ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));
	} else {
		vec3 t = TARGET_FUNC();
		vec3 tu = dFdx(t);
		vec3 tv = dFdy(t);
		vec3 result = vec3(0.0);
		for (float u = 0.0; u < NUM_SAMPLES_SQRT; ++u) {
			for (float v = 0.0; v < NUM_SAMPLES_SQRT; ++v) {
				result += DECODE_FUNC(SOURCE_FUNC(normalize(t +
															tu * (u / NUM_SAMPLES_SQRT - 0.5) +
															tv * (v / NUM_SAMPLES_SQRT - 0.5))));
			}
		}
		return ENCODE_FUNC(result / (NUM_SAMPLES_SQRT * NUM_SAMPLES_SQRT));
	}
}
vec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);
#ifdef USE_SAMPLES_TEX
	void unpackSample(int i, out vec3 L, out float mipLevel) {
		float u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;
		float v = (floor(u) + 0.5) * samplesTexInverseSize.y;
		vec4 raw;
		raw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);
		L.xyz = raw.xyz * 2.0 - 1.0;
		mipLevel = raw.w * 8.0;
	}
	vec4 prefilterSamples() {
		mat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());
		vec3 L;
		float mipLevel;
		vec3 result = vec3(0.0);
		float totalWeight = 0.0;
		for (int i = 0; i < NUM_SAMPLES; ++i) {
			unpackSample(i, L, mipLevel);
			result += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel)) * L.z;
			totalWeight += L.z;
		}
		return ENCODE_FUNC(result / totalWeight);
	}
	vec4 prefilterSamplesUnweighted() {
		mat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());
		vec3 L;
		float mipLevel;
		vec3 result = vec3(0.0);
		float totalWeight = 0.0;
		for (int i = 0; i < NUM_SAMPLES; ++i) {
			unpackSample(i, L, mipLevel);
			result += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel));
		}
		return ENCODE_FUNC(result / float(NUM_SAMPLES));
	}
#endif
void main(void) {
	gl_FragColor = PROCESS_FUNC();
}
`,ED=`
vec4 SampleTextureCatmullRom(TEXTURE_ACCEPT(tex), vec2 uv, vec2 texSize) {
	vec2 samplePos = uv * texSize;
	vec2 texPos1 = floor(samplePos - 0.5) + 0.5;
	vec2 f = samplePos - texPos1;
	vec2 w0 = f * (-0.5 + f * (1.0 - 0.5 * f));
	vec2 w1 = 1.0 + f * f * (-2.5 + 1.5 * f);
	vec2 w2 = f * (0.5 + f * (2.0 - 1.5 * f));
	vec2 w3 = f * f * (-0.5 + 0.5 * f);
	vec2 w12 = w1 + w2;
	vec2 offset12 = w2 / (w1 + w2);
	vec2 texPos0 = (texPos1 - 1.0) / texSize;
	vec2 texPos3 = (texPos1 + 2.0) / texSize;
	vec2 texPos12 = (texPos1 + offset12) / texSize;
	vec4 result = vec4(0.0);
	result += texture2DLodEXT(tex, vec2(texPos0.x, texPos0.y), 0.0) * w0.x * w0.y;
	result += texture2DLodEXT(tex, vec2(texPos12.x, texPos0.y), 0.0) * w12.x * w0.y;
	result += texture2DLodEXT(tex, vec2(texPos3.x, texPos0.y), 0.0) * w3.x * w0.y;
	result += texture2DLodEXT(tex, vec2(texPos0.x, texPos12.y), 0.0) * w0.x * w12.y;
	result += texture2DLodEXT(tex, vec2(texPos12.x, texPos12.y), 0.0) * w12.x * w12.y;
	result += texture2DLodEXT(tex, vec2(texPos3.x, texPos12.y), 0.0) * w3.x * w12.y;
	result += texture2DLodEXT(tex, vec2(texPos0.x, texPos3.y), 0.0) * w0.x * w3.y;
	result += texture2DLodEXT(tex, vec2(texPos12.x, texPos3.y), 0.0) * w12.x * w3.y;
	result += texture2DLodEXT(tex, vec2(texPos3.x, texPos3.y), 0.0) * w3.x * w3.y;
	return result;
}
`,CD=`
uniform highp sampler2D uSceneDepthMap;
#ifndef SCREENSIZE
#define SCREENSIZE
uniform vec4 uScreenSize;
#endif
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
#ifndef LINEARIZE_DEPTH
#ifndef CAMERAPLANES
#define CAMERAPLANES
uniform vec4 camera_params;
#endif
#define LINEARIZE_DEPTH
#ifdef GL2
float linearizeDepth(float z) {
	if (camera_params.w == 0.0)
		return (camera_params.z * camera_params.y) / (camera_params.y + z * (camera_params.z - camera_params.y));
	else
		return camera_params.z + z * (camera_params.y - camera_params.z);
}
#else
#ifndef UNPACKFLOAT
#define UNPACKFLOAT
float unpackFloat(vec4 rgbaDepth) {
	const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);
	return dot(rgbaDepth, bitShift);
}
#endif
#endif
#endif
float getLinearScreenDepth(vec2 uv) {
	#ifdef GL2
		return linearizeDepth(texture2D(uSceneDepthMap, uv).r);
	#else
		return unpackFloat(texture2D(uSceneDepthMap, uv)) * camera_params.y;
	#endif
}
#ifndef VERTEXSHADER
float getLinearScreenDepth() {
	vec2 uv = gl_FragCoord.xy * uScreenSize.zw;
	return getLinearScreenDepth(uv);
}
#endif
float getLinearDepth(vec3 pos) {
	return -(matrix_view * vec4(pos, 1.0)).z;
}
`,AD=`
const float maxCascades = 4.0;
mat4 cascadeShadowMat;
void getShadowCascadeMatrix(mat4 shadowMatrixPalette[4], float shadowCascadeDistances[4], float shadowCascadeCount) {
	float depth = 1.0 / gl_FragCoord.w;
	float cascadeIndex = 0.0;
	for (float i = 0.0; i < maxCascades; i++) {
		if (depth < shadowCascadeDistances[int(i)]) {
			cascadeIndex = i;
			break;
		}
	}
	cascadeIndex = min(cascadeIndex, shadowCascadeCount - 1.0);
	#ifdef GL2
		cascadeShadowMat = shadowMatrixPalette[int(cascadeIndex)];
	#else
		if (cascadeIndex == 0.0) {
			cascadeShadowMat = shadowMatrixPalette[0];
		}
		else if (cascadeIndex == 1.0) {
			cascadeShadowMat = shadowMatrixPalette[1];
		}
		else if (cascadeIndex == 2.0) {
			cascadeShadowMat = shadowMatrixPalette[2];
		}
		else {
			cascadeShadowMat = shadowMatrixPalette[3];
		}
	#endif
}
void fadeShadow(float shadowCascadeDistances[4]) {				  
	float depth = 1.0 / gl_FragCoord.w;
	if (depth > shadowCascadeDistances[int(maxCascades - 1.0)]) {
		dShadowCoord.z = -9999999.0;
	}
}
`,PD=`
float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {
	vec3 moments = texture2D(tex, texCoords).xyz;
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
float getShadowVSM$(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	return VSM$(shadowMap, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
float getShadowSpotVSM$(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	return VSM$(shadowMap, shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);
}
`,MD=`
float VSM$(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {
	float pixelSize = 1.0 / resolution;
	texCoords -= vec2(pixelSize);
	vec3 s00 = texture2D(tex, texCoords).xyz;
	vec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;
	vec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;
	vec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;
	vec2 fr = fract(texCoords * resolution);
	vec3 h0 = mix(s00, s10, fr.x);
	vec3 h1 = mix(s01, s11, fr.x);
	vec3 moments = mix(h0, h1, fr.y);
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
float getShadowVSM$(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	return VSM$(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
float getShadowSpotVSM$(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	return VSM$(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);
}
`,ID=`
#define PCSS_SAMPLE_COUNT 16
uniform float pcssDiskSamples[PCSS_SAMPLE_COUNT];
uniform float pcssSphereSamples[PCSS_SAMPLE_COUNT];
vec2 vogelDisk(int sampleIndex, float count, float phi, float r) {
	const float GoldenAngle = 2.4;
	float theta = float(sampleIndex) * GoldenAngle + phi;
	float sine = sin(theta);
	float cosine = cos(theta);
	return vec2(r * cosine, r * sine);
}
vec3 vogelSphere(int sampleIndex, float count, float phi, float r) {
	const float GoldenAngle = 2.4;
	float theta = float(sampleIndex) * GoldenAngle + phi;
	float weight = float(sampleIndex) / count;
	return vec3(cos(theta) * r, weight, sin(theta) * r);
}
float noise(vec2 screenPos) {
	const float PHI = 1.61803398874989484820459;
	return fract(sin(dot(screenPos * PHI, screenPos)) * screenPos.x);
}
#ifndef UNPACKFLOAT
#define UNPACKFLOAT
float unpackFloat(vec4 rgbaDepth) {
	const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);
	return dot(rgbaDepth, bitShift);
}
#endif
float viewSpaceDepth(float depth, mat4 invProjection) {
	float z = depth * 2.0 - 1.0;
	vec4 clipSpace = vec4(0.0, 0.0, z, 1.0);
	vec4 viewSpace = invProjection * clipSpace;
	return viewSpace.z;
}
float PCSSBlockerDistance(TEXTURE_ACCEPT(shadowMap), vec2 sampleCoords[PCSS_SAMPLE_COUNT], vec2 shadowCoords, vec2 searchSize, float z) {
	float blockers = 0.0;
	float averageBlocker = 0.0;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		vec2 offset = sampleCoords[i] * searchSize;
		vec2 sampleUV = shadowCoords + offset;
	#ifdef GL2
		float blocker = textureLod(shadowMap, sampleUV, 0.0).r;
	#else
		float blocker = unpackFloat(texture2D(shadowMap, sampleUV));
	#endif		
		float isBlocking = step(blocker, z);
		blockers += isBlocking;
		averageBlocker += blocker * isBlocking;
	}
	if (blockers > 0.0)
		return averageBlocker /= blockers;
	return -1.0;
}
float PCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec2 shadowSearchArea) {
	float receiverDepth = shadowCoords.z;
#ifndef GL2
	receiverDepth *= 1.0 / (cameraParams.y - cameraParams.z);
#endif
	vec2 samplePoints[PCSS_SAMPLE_COUNT];
	float noise = noise( gl_FragCoord.xy ) * 2.0 * PI;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		float pcssPresample = pcssDiskSamples[i];
		samplePoints[i] = vogelDisk(i, float(PCSS_SAMPLE_COUNT), noise, pcssPresample);
	}
	float averageBlocker = PCSSBlockerDistance(TEXTURE_PASS(shadowMap), samplePoints, shadowCoords.xy, shadowSearchArea, receiverDepth);
	if (averageBlocker == -1.0) {
		return 1.0;
	} else {
		vec2 filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea * cameraParams.x;
		float shadow = 0.0;
		for (int i = 0; i < PCSS_SAMPLE_COUNT; i ++)
		{
			vec2 sampleUV = samplePoints[i] * filterRadius;
			sampleUV = shadowCoords.xy + sampleUV;
		#ifdef GL2
			float depth = textureLod(shadowMap, sampleUV, 0.0).r;
		#else
			float depth = unpackFloat(texture2D(shadowMap, sampleUV));
		#endif
			shadow += step(receiverDepth, depth);
		}
		return shadow / float(PCSS_SAMPLE_COUNT);
	} 
}
float PCSSCubeBlockerDistance(samplerCube shadowMap, vec3 lightDirNorm, vec3 samplePoints[PCSS_SAMPLE_COUNT], float z, float shadowSearchArea) {
	float blockers = 0.0;
	float averageBlocker = 0.0;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		vec3 sampleDir = lightDirNorm + samplePoints[i] * shadowSearchArea;
		sampleDir = normalize(sampleDir);
	#ifdef GL2
		float blocker = textureCubeLodEXT(shadowMap, sampleDir, 0.0).r;
	#else
		float blocker = unpackFloat(textureCube(shadowMap, sampleDir));
	#endif
		float isBlocking = step(blocker, z);
		blockers += isBlocking;
		averageBlocker += blocker * isBlocking;
	}
	if (blockers > 0.0)
		return averageBlocker /= float(blockers);
	return -1.0;
}
float PCSSCube(samplerCube shadowMap, vec4 shadowParams, vec3 shadowCoords, vec4 cameraParams, float shadowSearchArea, vec3 lightDir) {
	
	vec3 samplePoints[PCSS_SAMPLE_COUNT];
	float noise = noise( gl_FragCoord.xy ) * 2.0 * PI;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		float r = pcssSphereSamples[i];
		samplePoints[i] = vogelSphere(i, float(PCSS_SAMPLE_COUNT), noise, r);
	}
	float receiverDepth = length(lightDir) * shadowParams.w + shadowParams.z;
	vec3 lightDirNorm = normalize(lightDir);
	
	float averageBlocker = PCSSCubeBlockerDistance(shadowMap, lightDirNorm, samplePoints, receiverDepth, shadowSearchArea);
	if (averageBlocker == -1.0) {
		return 1.0;
	} else {
		float filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea;
		float shadow = 0.0;
		for (int i = 0; i < PCSS_SAMPLE_COUNT; i++)
		{
			vec3 offset = samplePoints[i] * filterRadius;
			vec3 sampleDir = lightDirNorm + offset;
			sampleDir = normalize(sampleDir);
			#ifdef GL2
				float depth = textureCubeLodEXT(shadowMap, sampleDir, 0.0).r;
			#else
				float depth = unpackFloat(textureCube(shadowMap, sampleDir));
			#endif
			shadow += step(receiverDepth, depth);
		}
		return shadow / float(PCSS_SAMPLE_COUNT);
	}
}
float getShadowPointPCSS(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {
	return PCSSCube(shadowMap, shadowParams, shadowCoord, cameraParams, shadowSearchArea.x, lightDir);
}
float getShadowSpotPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {
	return PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);
}
float getShadowPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {
	return PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);
}
`,RD=`
vec3 getShadowSampleCoord$LIGHT(mat4 shadowTransform, vec4 shadowParams, vec3 worldPosition, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {
	vec3 surfacePosition = worldPosition;
#ifdef SHADOW_SAMPLE_POINT
	#ifdef SHADOW_SAMPLE_NORMAL_OFFSET
		float distScale = length(lightDir);
		surfacePosition = worldPosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
		lightDir = surfacePosition - lightPos;
		return lightDir;
	#endif
#else
	#ifdef SHADOW_SAMPLE_SOURCE_ZBUFFER
		#ifdef SHADOW_SAMPLE_NORMAL_OFFSET
			surfacePosition = worldPosition + normal * shadowParams.y;
		#endif
	#else
		#ifdef SHADOW_SAMPLE_NORMAL_OFFSET
			#ifdef SHADOW_SAMPLE_ORTHO
				float distScale = 1.0;
			#else
				float distScale = abs(dot(vPositionW - lightPos, lightDirNorm));
			#endif
			surfacePosition = worldPosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
		#endif
	#endif
	vec4 positionInShadowSpace = shadowTransform * vec4(surfacePosition, 1.0);
	#ifdef SHADOW_SAMPLE_ORTHO
		positionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;
	#else
		#ifdef SHADOW_SAMPLE_SOURCE_ZBUFFER
			positionInShadowSpace.xyz /= positionInShadowSpace.w;
		#else
			positionInShadowSpace.xy /= positionInShadowSpace.w;
			positionInShadowSpace.z = length(lightDir) * shadowParams.w;
		#endif
	#endif
	#ifdef SHADOW_SAMPLE_Z_BIAS
		positionInShadowSpace.z += getShadowBias(shadowParams.x, shadowParams.z);
	#endif
	surfacePosition = positionInShadowSpace.xyz;
#endif
	return surfacePosition;
}
`,LD=`
vec3 lessThan2(vec3 a, vec3 b) {
	return clamp((b - a)*1000.0, 0.0, 1.0);
}
#ifndef UNPACKFLOAT
#define UNPACKFLOAT
	float unpackFloat(vec4 rgbaDepth) {
		const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);
		return dot(rgbaDepth, bitShift);
	}
#endif
#ifdef GL2
float _getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {
	float z = shadowCoord.z;
	vec2 uv = shadowCoord.xy * shadowParams.x;
	float shadowMapSizeInv = 1.0 / shadowParams.x;
	vec2 base_uv = floor(uv + 0.5);
	float s = (uv.x + 0.5 - base_uv.x);
	float t = (uv.y + 0.5 - base_uv.y);
	base_uv -= vec2(0.5);
	base_uv *= shadowMapSizeInv;
	float sum = 0.0;
	float uw0 = (3.0 - 2.0 * s);
	float uw1 = (1.0 + 2.0 * s);
	float u0 = (2.0 - s) / uw0 - 1.0;
	float u1 = s / uw1 + 1.0;
	float vw0 = (3.0 - 2.0 * t);
	float vw1 = (1.0 + 2.0 * t);
	float v0 = (2.0 - t) / vw0 - 1.0;
	float v1 = t / vw1 + 1.0;
	u0 = u0 * shadowMapSizeInv + base_uv.x;
	v0 = v0 * shadowMapSizeInv + base_uv.y;
	u1 = u1 * shadowMapSizeInv + base_uv.x;
	v1 = v1 * shadowMapSizeInv + base_uv.y;
	sum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));
	sum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));
	sum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));
	sum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));
	sum *= 1.0f / 16.0;
	return sum;
}
float getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
float getShadowSpotPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
float getShadowPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return textureShadow(shadowMap, shadowCoord);
}
float getShadowSpotPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return textureShadow(shadowMap, shadowCoord);
}
#else
float _xgetShadowPCF3x3(mat3 depthKernel, vec3 shadowCoord, sampler2D shadowMap, vec3 shadowParams) {
	mat3 shadowKernel;
	vec3 shadowZ = vec3(shadowCoord.z);
	shadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));
	shadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));
	shadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));
	vec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );
	shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);
	shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);
	vec4 shadowValues;
	shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);
	shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);
	shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);
	shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);
	return dot( shadowValues, vec4( 1.0 ) ) * 0.25;
}
float _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowCoord, vec3 shadowParams) {
	float xoffset = 1.0 / shadowParams.x;
	float dx0 = -xoffset;
	float dx1 = xoffset;
	mat3 depthKernel;
	depthKernel[0][0] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));
	depthKernel[0][1] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));
	depthKernel[0][2] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));
	depthKernel[1][0] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));
	depthKernel[1][1] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy));
	depthKernel[1][2] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));
	depthKernel[2][0] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));
	depthKernel[2][1] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));
	depthKernel[2][2] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));
	return _xgetShadowPCF3x3(depthKernel, shadowCoord, shadowMap, shadowParams);
}
float getShadowPCF3x3(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF3x3(shadowMap, shadowCoord, shadowParams.xyz);
}
float getShadowSpotPCF3x3(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF3x3(shadowMap, shadowCoord, shadowParams.xyz);
}
float _getShadowPCF1x1(sampler2D shadowMap, vec3 shadowCoord) {
	float shadowSample = unpackFloat(textureShadow(shadowMap, shadowCoord.xy));
	return shadowSample > shadowCoord.z ? 1.0 : 0.0;
}
float getShadowPCF1x1(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF1x1(shadowMap, shadowCoord);
}
float getShadowSpotPCF1x1(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF1x1(shadowMap, shadowCoord);
}
#endif
#ifndef WEBGPU
float _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {
	vec3 tc = normalize(dir);
	vec3 tcAbs = abs(tc);
	vec4 dirX = vec4(1,0,0, tc.x);
	vec4 dirY = vec4(0,1,0, tc.y);
	float majorAxisLength = tc.z;
	if ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {
		dirX = vec4(0,0,1, tc.z);
		dirY = vec4(0,1,0, tc.y);
		majorAxisLength = tc.x;
	} else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {
		dirX = vec4(1,0,0, tc.x);
		dirY = vec4(0,0,1, tc.z);
		majorAxisLength = tc.y;
	}
	float shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);
	vec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);
	vec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);
	vec3 dx0 = -xoffset;
	vec3 dy0 = -yoffset;
	vec3 dx1 = xoffset;
	vec3 dy1 = yoffset;
	mat3 shadowKernel;
	mat3 depthKernel;
	depthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));
	depthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));
	depthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));
	depthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));
	depthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));
	depthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));
	depthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));
	depthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));
	depthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));
	vec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);
	shadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));
	shadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));
	shadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));
	vec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;
	vec2 fractionalCoord = fract( uv * shadowParams.x );
	shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);
	shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);
	vec4 shadowValues;
	shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);
	shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);
	shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);
	shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);
	return 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;
}
float getShadowPointPCF3x3(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {
	return _getShadowPoint(shadowMap, shadowParams, lightDir);
}
#endif
`,DD=`
float _getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {
	float z = shadowCoord.z;
	vec2 uv = shadowCoord.xy * shadowParams.x;
	float shadowMapSizeInv = 1.0 / shadowParams.x;
	vec2 base_uv = floor(uv + 0.5);
	float s = (uv.x + 0.5 - base_uv.x);
	float t = (uv.y + 0.5 - base_uv.y);
	base_uv -= vec2(0.5);
	base_uv *= shadowMapSizeInv;
	float uw0 = (4.0 - 3.0 * s);
	float uw1 = 7.0;
	float uw2 = (1.0 + 3.0 * s);
	float u0 = (3.0 - 2.0 * s) / uw0 - 2.0;
	float u1 = (3.0 + s) / uw1;
	float u2 = s / uw2 + 2.0;
	float vw0 = (4.0 - 3.0 * t);
	float vw1 = 7.0;
	float vw2 = (1.0 + 3.0 * t);
	float v0 = (3.0 - 2.0 * t) / vw0 - 2.0;
	float v1 = (3.0 + t) / vw1;
	float v2 = t / vw2 + 2.0;
	float sum = 0.0;
	u0 = u0 * shadowMapSizeInv + base_uv.x;
	v0 = v0 * shadowMapSizeInv + base_uv.y;
	u1 = u1 * shadowMapSizeInv + base_uv.x;
	v1 = v1 * shadowMapSizeInv + base_uv.y;
	u2 = u2 * shadowMapSizeInv + base_uv.x;
	v2 = v2 * shadowMapSizeInv + base_uv.y;
	sum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));
	sum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));
	sum += uw2 * vw0 * textureShadow(shadowMap, vec3(u2, v0, z));
	sum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));
	sum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));
	sum += uw2 * vw1 * textureShadow(shadowMap, vec3(u2, v1, z));
	sum += uw0 * vw2 * textureShadow(shadowMap, vec3(u0, v2, z));
	sum += uw1 * vw2 * textureShadow(shadowMap, vec3(u1, v2, z));
	sum += uw2 * vw2 * textureShadow(shadowMap, vec3(u2, v2, z));
	sum *= 1.0f / 144.0;
	sum = saturate(sum);
	return sum;
}
float getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
float getShadowSpotPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
`,OD=`
float calculateVSM8(vec3 moments, float Z, float vsmBias) {
	float VSMBias = vsmBias;
	float depthScale = VSMBias * Z;
	float minVariance1 = depthScale * depthScale;
	return chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);
}
float decodeFloatRG(vec2 rg) {
	return rg.y*(1.0/255.0) + rg.x;
}
float VSM8(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {
	vec4 c = texture2D(tex, texCoords);
	vec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);
	return calculateVSM8(moments, Z, vsmBias);
}
float getShadowVSM8(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	return VSM8(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, 0.0);
}
float getShadowSpotVSM8(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	return VSM8(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);
}
`,FD=`
float linstep(float a, float b, float v) {
	return saturate((v - a) / (b - a));
}
float reduceLightBleeding(float pMax, float amount) {
	 return linstep(amount, 1.0, pMax);
}
float chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {
	float variance = moments.y - (moments.x * moments.x);
	variance = max(variance, minVariance);
	float d = mean - moments.x;
	float pMax = variance / (variance + (d * d));
	pMax = reduceLightBleeding(pMax, lightBleedingReduction);
	return (mean <= moments.x ? 1.0 : pMax);
}
float calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {
	Z = 2.0 * Z - 1.0;
	float warpedDepth = exp(exponent * Z);
	moments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);
	float VSMBias = vsmBias;
	float depthScale = VSMBias * exponent * warpedDepth;
	float minVariance1 = depthScale * depthScale;
	return chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);
}
`,kD=`
attribute float vertex_boneIndices;
uniform vec4 matrix_pose[BONE_LIMIT * 3];
mat4 getBoneMatrix(const in float i) {
	vec4 v1 = matrix_pose[int(3.0 * i)];
	vec4 v2 = matrix_pose[int(3.0 * i + 1.0)];
	vec4 v3 = matrix_pose[int(3.0 * i + 2.0)];
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, 1
	);
}
`,BD=`
attribute float vertex_boneIndices;
uniform highp sampler2D texture_poseMap;
uniform vec4 texture_poseMapSize;
mat4 getBoneMatrix(const in float i) {
	float j = i * 3.0;
	float dx = texture_poseMapSize.z;
	float dy = texture_poseMapSize.w;
	float y = floor(j * dx);
	float x = j - (y * texture_poseMapSize.x);
	y = dy * (y + 0.5);
	vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));
	vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));
	vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, 1
	);
}
`,ND=`
attribute vec4 vertex_boneWeights;
attribute vec4 vertex_boneIndices;
uniform vec4 matrix_pose[BONE_LIMIT * 3];
void getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {
	v1 = matrix_pose[int(3.0 * i)];
	v2 = matrix_pose[int(3.0 * i + 1.0)];
	v3 = matrix_pose[int(3.0 * i + 2.0)];
}
mat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {
	vec4 a1, a2, a3;
	getBoneMatrix(indices.x, a1, a2, a3);
	vec4 b1, b2, b3;
	getBoneMatrix(indices.y, b1, b2, b3);
	vec4 c1, c2, c3;
	getBoneMatrix(indices.z, c1, c2, c3);
	vec4 d1, d2, d3;
	getBoneMatrix(indices.w, d1, d2, d3);
	vec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;
	vec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;
	vec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;
	float one = dot(weights, vec4(1.0));
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, one
	);
}
`,UD=`
attribute vec4 vertex_boneWeights;
attribute vec4 vertex_boneIndices;
uniform highp sampler2D texture_poseMap;
uniform vec4 texture_poseMapSize;
void getBoneMatrix(const in float index, out vec4 v1, out vec4 v2, out vec4 v3) {
	float i = float(index);
	float j = i * 3.0;
	float dx = texture_poseMapSize.z;
	float dy = texture_poseMapSize.w;
	
	float y = floor(j * dx);
	float x = j - (y * texture_poseMapSize.x);
	y = dy * (y + 0.5);
	v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));
	v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));
	v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));
}
mat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {
	vec4 a1, a2, a3;
	getBoneMatrix(indices.x, a1, a2, a3);
	vec4 b1, b2, b3;
	getBoneMatrix(indices.y, b1, b2, b3);
	vec4 c1, c2, c3;
	getBoneMatrix(indices.z, c1, c2, c3);
	vec4 d1, d2, d3;
	getBoneMatrix(indices.w, d1, d2, d3);
	vec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;
	vec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;
	vec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;
	float one = dot(weights, vec4(1.0));
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, one
	);
}
`,zD=`
varying vec3 vViewDir;
uniform sampler2D texture_envAtlas;
uniform float mipLevel;
void main(void) {
	vec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);
	vec2 uv = toSphericalUv(normalize(dir));
	vec3 linear = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));
	gl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);
}
`,VD=`
varying vec3 vViewDir;
uniform samplerCube texture_cubeMap;
#ifdef SKYMESH
	varying vec3 vWorldPos;
	uniform mat3 cubeMapRotationMatrix;
	uniform vec3 projectedSkydomeCenter;
#endif
void main(void) {
	#ifdef SKYMESH
		vec3 envDir = normalize(vWorldPos - projectedSkydomeCenter);
		vec3 dir = envDir * cubeMapRotationMatrix;
	#else
		vec3 dir = vViewDir;
	#endif
	dir.x *= -1.0;
	vec3 linear = $DECODE(textureCube(texture_cubeMap, fixSeamsStatic(dir, $FIXCONST)));
	gl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);
}
`,GD=`
attribute vec3 aPosition;
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
uniform mat4 matrix_projectionSkybox;
uniform mat3 cubeMapRotationMatrix;
varying vec3 vViewDir;
#ifdef SKYMESH
	uniform mat4 matrix_model;
	varying vec3 vWorldPos;
#endif
void main(void) {
	mat4 view = matrix_view;
	#ifdef SKYMESH
		vec4 worldPos = matrix_model * vec4(aPosition, 1.0);
		vWorldPos = worldPos.xyz;
		gl_Position = matrix_projectionSkybox * view * worldPos;
	#else
		view[3][0] = view[3][1] = view[3][2] = 0.0;
		gl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);
		vViewDir = aPosition * cubeMapRotationMatrix;
	#endif
	gl_Position.z = gl_Position.w - 0.00001;
}
`,HD=`
#ifdef MAPCOLOR
uniform vec3 material_specular;
#endif
void getSpecularity() {
	vec3 specularColor = vec3(1,1,1);
	#ifdef MAPCOLOR
	specularColor *= material_specular;
	#endif
	#ifdef MAPTEXTURE
	specularColor *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;
	#endif
	#ifdef MAPVERTEX
	specularColor *= saturate(vVertexColor.$VC);
	#endif
	dSpecularity = specularColor;
}
`,WD=`
const float PI = 3.141592653589793;
vec2 toSpherical(vec3 dir) {
	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));
}
vec2 toSphericalUv(vec3 dir) {
	vec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;
	return vec2(uv.x, 1.0 - uv.y);
}
`,jD=`
#ifdef MAPFLOAT
uniform float material_specularityFactor;
#endif
void getSpecularityFactor() {
	float specularityFactor = 1.0;
	#ifdef MAPFLOAT
	specularityFactor *= material_specularityFactor;
	#endif
	#ifdef MAPTEXTURE
	specularityFactor *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	specularityFactor *= saturate(vVertexColor.$VC);
	#endif
	dSpecularityFactor = specularityFactor;
}
`,$D=`
float getSpotEffect(vec3 lightSpotDir, float lightInnerConeAngle, float lightOuterConeAngle, vec3 lightDirNorm) {
	float cosAngle = dot(lightDirNorm, lightSpotDir);
	return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);
}
`,XD=`
void main(void) {
	dReflection = vec4(0);
	#ifdef LIT_CLEARCOAT
	ccSpecularLight = vec3(0);
	ccReflection = vec3(0);
	#endif
`,qD=`
void main(void) {
	gl_Position = getPosition();
`,KD=`
	nineSlicedUv = vUv0;
	nineSlicedUv.y = 1.0 - nineSlicedUv.y;
`,YD=`
	vec2 tileMask = step(vMask, vec2(0.99999));
	vec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);
	vec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);
	vec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));
	clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;
	nineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);
	nineSlicedUv.y = 1.0 - nineSlicedUv.y;
	
`,ZD=`
float exponent = VSM_EXPONENT;
depth = 2.0 * depth - 1.0;
depth =  exp(exponent * depth);
gl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);
`,JD=`
vec3 getTangent() {
	return normalize(dNormalMatrix * vertex_tangent.xyz);
}
vec3 getBinormal() {
	return cross(vNormalW, vTangentW) * vertex_tangent.w;
}
`,QD=`
void getTBN(vec3 tangent, vec3 binormal, vec3 normal) {
	dTBN = mat3(normalize(tangent), normalize(binormal), normalize(normal));
}
`,e2=`
uniform float tbnBasis;
void getTBN(vec3 tangent, vec3 binormal, vec3 normal) {
	vec2 uv = $UV;
	vec3 dp1 = dFdx( vPositionW );
	vec3 dp2 = dFdy( vPositionW );
	vec2 duv1 = dFdx( uv );
	vec2 duv2 = dFdy( uv );
	vec3 dp2perp = cross( dp2, normal );
	vec3 dp1perp = cross( normal, dp1 );
	vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;
	vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;
	float denom = max( dot(T,T), dot(B,B) );
	float invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );
	dTBN = mat3(T * invmax, -B * invmax, normal );
}
`,t2=`
void getTBN(vec3 tangent, vec3 binormal, vec3 normal) {
	dTBN = mat3(tangent, binormal, normal);
}
`,s2=`
void getTBN(vec3 tangent, vec3 binormal, vec3 normal) {
	vec3 B = cross(normal, vObjectSpaceUpW);
	vec3 T = cross(normal, B);
	if (dot(B,B)==0.0)
	{
		float major=max(max(normal.x, normal.y), normal.z);
		if (normal.x == major)
		{
			B=cross(normal, vec3(0,1,0));
			T=cross(normal, B);
		}
		else if (normal.y == major)
		{
			B=cross(normal, vec3(0,0,1));
			T=cross(normal, B);
		}
		else if (normal.z == major)
		{
			B=cross(normal, vec3(1,0,0));
			T=cross(normal, B);
		}
	}
	dTBN = mat3(normalize(T), normalize(B), normalize(normal));
}
`,i2=`
vec4 texture2DSRGB(sampler2D tex, vec2 uv) {
	return gammaCorrectInput(texture2D(tex, uv));
}
vec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {
	return gammaCorrectInput(texture2D(tex, uv, bias));
}
vec3 texture2DRGBM(sampler2D tex, vec2 uv) {
	return decodeRGBM(texture2D(tex, uv));
}
vec3 texture2DRGBM(sampler2D tex, vec2 uv, float bias) {
	return decodeRGBM(texture2D(tex, uv, bias));
}
vec3 texture2DRGBE(sampler2D tex, vec2 uv) {
	return decodeRGBM(texture2D(tex, uv));
}
vec3 texture2DRGBE(sampler2D tex, vec2 uv, float bias) {
	return decodeRGBM(texture2D(tex, uv, bias));
}
`,n2=`
#ifdef MAPFLOAT
uniform float material_thickness;
#endif
void getThickness() {
	dThickness = 1.0;
	#ifdef MAPFLOAT
	dThickness *= material_thickness;
	#endif
	#ifdef MAPTEXTURE
	dThickness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	dThickness *= saturate(vVertexColor.$VC);
	#endif
}
`,r2=`
uniform float exposure;
vec3 toneMap(vec3 color) {
	float tA = 2.51;
	float tB = 0.03;
	float tC = 2.43;
	float tD = 0.59;
	float tE = 0.14;
	vec3 x = color * exposure;
	return (x*(tA*x+tB))/(x*(tC*x+tD)+tE);
}
`,a2=`
uniform float exposure;
const mat3 ACESInputMat = mat3(
	0.59719, 0.35458, 0.04823,
	0.07600, 0.90834, 0.01566,
	0.02840, 0.13383, 0.83777
);
const mat3 ACESOutputMat = mat3(
	 1.60475, -0.53108, -0.07367,
	-0.10208,  1.10813, -0.00605,
	-0.00327, -0.07276,  1.07602
);
vec3 RRTAndODTFit(vec3 v) {
	vec3 a = v * (v + 0.0245786) - 0.000090537;
	vec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;
	return a / b;
}
vec3 toneMap(vec3 color) {
	color *= exposure / 0.6;
	color = color * ACESInputMat;
	color = RRTAndODTFit(color);
	color = color * ACESOutputMat;
	color = clamp(color, 0.0, 1.0);
	return color;
}
`,o2=`
const float A =  0.15;
const float B =  0.50;
const float C =  0.10;
const float D =  0.20;
const float E =  0.02;
const float F =  0.30;
const float W =  11.2;
uniform float exposure;
vec3 uncharted2Tonemap(vec3 x) {
	 return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;
}
vec3 toneMap(vec3 color) {
	color = uncharted2Tonemap(color * exposure);
	vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));
	color = color * whiteScale;
	return color;
}
`,l2=`
uniform float exposure;
vec3 toneMap(vec3 color) {
	color *= exposure;
	const float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;
	const float Scl = 1.25;
	vec3 h = max( vec3(0.0), color - vec3(0.004) );
	return (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);
}
`,h2=`
uniform float exposure;
vec3 toneMap(vec3 color) {
	return color * exposure;
}
`,c2=`
vec3 toneMap(vec3 color) {
	return color;
}
`,d2=`
#ifdef PIXELSNAP
uniform vec4 uScreenSize;
#endif
#ifdef SCREENSPACE
uniform float projectionFlipY;
#endif
#ifdef MORPHING
uniform vec4 morph_weights_a;
uniform vec4 morph_weights_b;
#endif
#ifdef MORPHING_TEXTURE_BASED
	uniform vec4 morph_tex_params;
	#ifdef WEBGPU
		ivec2 getTextureMorphCoords() {
			ivec2 textureSize = ivec2(morph_tex_params.xy);
			int morphGridV = int(morph_vertex_id / textureSize.x);
			int morphGridU = int(morph_vertex_id - (morphGridV * textureSize.x));
			morphGridV = textureSize.y - morphGridV - 1;
			return ivec2(morphGridU, morphGridV);
		}
	#else
		vec2 getTextureMorphCoords() {
			vec2 textureSize = morph_tex_params.xy;
			vec2 invTextureSize = morph_tex_params.zw;
			float morphGridV = floor(morph_vertex_id * invTextureSize.x);
			float morphGridU = morph_vertex_id - (morphGridV * textureSize.x);
			return vec2(morphGridU, morphGridV) * invTextureSize + (0.5 * invTextureSize);
		}
	#endif
#endif
#ifdef MORPHING_TEXTURE_BASED_POSITION
uniform highp sampler2D morphPositionTex;
#endif
mat4 getModelMatrix() {
	#ifdef DYNAMICBATCH
	return getBoneMatrix(vertex_boneIndices);
	#elif defined(SKIN)
	return matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);
	#elif defined(INSTANCING)
	return mat4(instance_line1, instance_line2, instance_line3, instance_line4);
	#else
	return matrix_model;
	#endif
}
vec4 getPosition() {
	dModelMatrix = getModelMatrix();
	vec3 localPos = vertex_position;
	#ifdef NINESLICED
	localPos.xz *= outerScale;
	vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));
	vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));
	localPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;
	vTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;
	localPos.xz *= -0.5;
	localPos = localPos.xzy;
	#endif
	#ifdef MORPHING
	#ifdef MORPHING_POS03
	localPos.xyz += morph_weights_a[0] * morph_pos0;
	localPos.xyz += morph_weights_a[1] * morph_pos1;
	localPos.xyz += morph_weights_a[2] * morph_pos2;
	localPos.xyz += morph_weights_a[3] * morph_pos3;
	#endif
	#ifdef MORPHING_POS47
	localPos.xyz += morph_weights_b[0] * morph_pos4;
	localPos.xyz += morph_weights_b[1] * morph_pos5;
	localPos.xyz += morph_weights_b[2] * morph_pos6;
	localPos.xyz += morph_weights_b[3] * morph_pos7;
	#endif
	#endif
	#ifdef MORPHING_TEXTURE_BASED_POSITION
		#ifdef WEBGPU
			ivec2 morphUV = getTextureMorphCoords();
			vec3 morphPos = texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz;
		#else
			vec2 morphUV = getTextureMorphCoords();
			vec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;
		#endif
		localPos += morphPos;
	#endif
	vec4 posW = dModelMatrix * vec4(localPos, 1.0);
	#ifdef SCREENSPACE
	posW.zw = vec2(0.0, 1.0);
	#endif
	dPositionW = posW.xyz;
	vec4 screenPos;
	#ifdef UV1LAYOUT
	screenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);
		#ifdef WEBGPU
		screenPos.y *= -1.0;
		#endif
	#else
	#ifdef SCREENSPACE
	screenPos = posW;
	screenPos.y *= projectionFlipY;
	#else
	screenPos = matrix_viewProjection * posW;
	#endif
	#ifdef PIXELSNAP
	screenPos.xy = (screenPos.xy * 0.5) + 0.5;
	screenPos.xy *= uScreenSize.xy;
	screenPos.xy = floor(screenPos.xy);
	screenPos.xy *= uScreenSize.zw;
	screenPos.xy = (screenPos.xy * 2.0) - 1.0;
	#endif
	#endif
	return screenPos;
}
vec3 getWorldPosition() {
	return dPositionW;
}
`,u2=`
attribute vec3 vertex_position;
uniform mat4 matrix_model;
uniform mat4 matrix_viewProjection;
vec3 dPositionW;
mat4 dModelMatrix;
`,f2=`
#ifdef MAPFLOAT
uniform float material_refraction;
#endif
void getRefraction() {
	float refraction = 1.0;
	#ifdef MAPFLOAT
	refraction = material_refraction;
	#endif
	#ifdef MAPTEXTURE
	refraction *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	refraction *= saturate(vVertexColor.$VC);
	#endif
	dTransmission = refraction;
}
`,p2=`
#ifdef NINESLICED
vec2 getUv0() {
	vec2 uv = vertex_position.xz;
	vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));
	vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));
	uv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;
	uv = uv * -0.5 + 0.5;
	uv = uv * atlasRect.zw + atlasRect.xy;
	vMask = vertex_texCoord0.xy;
	return uv;
}
#else
vec2 getUv0() {
	return vertex_texCoord0;
}
#endif
`,m2=`
vec2 getUv1() {
	return vertex_texCoord1;
}
`,_2=`
void getViewDir() {
	dViewDirW = normalize(view_position - vPositionW);
}
`,g2=`
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
vec3 getViewNormal() {
	return mat3(matrix_view) * vNormalW;
}
`;const W={alphaTestPS:BI,ambientConstantPS:NI,ambientEnvPS:UI,ambientSHPS:zI,aoPS:VI,aoDetailMapPS:GI,aoDiffuseOccPS:HI,aoSpecOccPS:WI,aoSpecOccConstPS:jI,aoSpecOccConstSimplePS:$I,aoSpecOccSimplePS:XI,basePS:qI,baseVS:KI,baseNineSlicedPS:YI,baseNineSlicedVS:ZI,baseNineSlicedTiledPS:JI,bayerPS:QI,biasConstPS:eR,blurVSMPS:tR,clearCoatPS:sR,clearCoatGlossPS:iR,clearCoatNormalPS:nR,clusteredLightCookiesPS:aR,clusteredLightShadowsPS:oR,clusteredLightUtilsPS:rR,clusteredLightPS:lR,combinePS:hR,cookiePS:cR,cubeMapProjectBoxPS:dR,cubeMapProjectNonePS:uR,cubeMapRotatePS:fR,debugOutputPS:pR,debugProcessFrontendPS:mR,detailModesPS:_R,diffusePS:gR,diffuseDetailMapPS:yR,decodePS:Ub,emissivePS:vR,encodePS:zb,endPS:SR,endVS:xR,envAtlasPS:wR,envConstPS:bR,envMultiplyPS:TR,extensionPS:ER,extensionVS:CR,falloffInvSquaredPS:AR,falloffLinearPS:PR,fixCubemapSeamsNonePS:MR,fixCubemapSeamsStretchPS:IR,floatUnpackingPS:RR,fogExpPS:LR,fogExp2PS:DR,fogLinearPS:OR,fogNonePS:FR,fresnelSchlickPS:kR,fullscreenQuadPS:BR,fullscreenQuadVS:NR,gamma1_0PS:UR,gamma2_2PS:zR,gles2PS:mb,gles3PS:_b,gles3VS:gb,glossPS:VR,iridescenceDiffractionPS:GR,iridescencePS:HR,iridescenceThicknessPS:WR,instancingVS:jR,iorPS:$R,lightDiffuseLambertPS:XR,lightDirPointPS:qR,lightmapAddPS:KR,lightmapDirAddPS:YR,lightmapDirPS:ZR,lightmapSinglePS:JR,lightSpecularAnisoGGXPS:QR,lightSpecularBlinnPS:eL,lightSpecularPhongPS:tL,lightSheenPS:sL,linearizeDepthPS:iL,litShaderArgsPS:nL,ltcPS:rL,metalnessPS:aL,metalnessModulatePS:lL,msdfPS:oL,msdfVS:hL,normalVS:cL,normalDetailMapPS:dL,normalInstancedVS:uL,normalMapPS:fL,normalSkinnedVS:pL,normalXYPS:mL,normalXYZPS:_L,opacityPS:gL,opacityDitherPS:yL,outputPS:vL,outputAlphaPS:SL,outputAlphaOpaquePS:xL,outputAlphaPremulPS:wL,outputTex2DPS:bL,packDepthPS:TL,sheenPS:EL,sheenGlossPS:CL,parallaxPS:AL,particlePS:PL,particleVS:ML,particleAnimFrameClampVS:IL,particleAnimFrameLoopVS:RL,particleAnimTexVS:LL,particleInputFloatPS:DL,particleInputRgba8PS:OL,particleOutputFloatPS:FL,particleOutputRgba8PS:kL,particleUpdaterAABBPS:BL,particleUpdaterEndPS:NL,particleUpdaterInitPS:UL,particleUpdaterNoRespawnPS:zL,particleUpdaterOnStopPS:VL,particleUpdaterRespawnPS:GL,particleUpdaterSpherePS:HL,particleUpdaterStartPS:WL,particle_billboardVS:jL,particle_blendAddPS:$L,particle_blendMultiplyPS:XL,particle_blendNormalPS:qL,particle_cpuVS:KL,particle_cpu_endVS:YL,particle_customFaceVS:ZL,particle_endPS:JL,particle_endVS:QL,particle_halflambertPS:eD,particle_initVS:tD,particle_lambertPS:sD,particle_lightingPS:iD,particle_localShiftVS:nD,particle_meshVS:rD,particle_normalVS:aD,particle_normalMapPS:oD,particle_pointAlongVS:lD,particle_softPS:hD,particle_softVS:cD,particle_stretchVS:dD,particle_TBNVS:uD,particle_wrapVS:fD,reflDirPS:pD,reflDirAnisoPS:mD,reflectionCCPS:_D,reflectionCubePS:gD,reflectionEnvHQPS:yD,reflectionEnvPS:vD,reflectionSpherePS:SD,reflectionSheenPS:xD,refractionCubePS:wD,refractionDynamicPS:bD,reprojectPS:TD,sampleCatmullRomPS:ED,screenDepthPS:CD,shadowCascadesPS:AD,shadowEVSMPS:PD,shadowEVSMnPS:MD,shadowPCSSPS:ID,shadowSampleCoordPS:RD,shadowStandardPS:LD,shadowStandardGL2PS:DD,shadowVSM8PS:OD,shadowVSM_commonPS:FD,skinBatchConstVS:kD,skinBatchTexVS:BD,skinConstVS:ND,skinTexVS:UD,skyboxEnvPS:zD,skyboxHDRPS:VD,skyboxVS:GD,specularPS:HD,sphericalPS:WD,specularityFactorPS:jD,spotPS:$D,startPS:XD,startVS:qD,startNineSlicedPS:KD,startNineSlicedTiledPS:YD,storeEVSMPS:ZD,tangentBinormalVS:JD,TBNPS:QD,TBNderivativePS:e2,TBNfastPS:t2,TBNObjectSpacePS:s2,textureSamplePS:i2,thicknessPS:n2,tonemappingAcesPS:r2,tonemappingAces2PS:a2,tonemappingFilmicPS:o2,tonemappingHejlPS:l2,tonemappingLinearPS:h2,tonemappingNonePS:c2,transformVS:d2,transformDeclVS:u2,transmissionPS:f2,uv0VS:p2,uv1VS:m2,viewDirPS:_2,viewNormalVS:g2,webgpuPS:yb,webgpuVS:vb},Vb=new di;function cn(r){return Vb.get(r)}function Gb(r,e){Vb.get(r,()=>e)}class Be{static begin(){return`void main(void)
{
`}static end(){return`}
`}static skinCode(e,t=W){return e.supportsBoneTextures?t.skinTexVS:"#define BONE_LIMIT "+e.getBoneLimit()+`
`+t.skinConstVS}static fogCode(e,t=W){return e==="linear"?t.fogLinearPS?t.fogLinearPS:W.fogLinearPS:e==="exp"?t.fogExpPS?t.fogExpPS:W.fogExpPS:e==="exp2"?t.fogExp2PS?t.fogExp2PS:W.fogExp2PS:t.fogNonePS?t.fogNonePS:W.fogNonePS}static gammaCode(e,t=W){return e===Hy||e===_I?t.gamma2_2PS?t.gamma2_2PS:W.gamma2_2PS:e===Sd?`#define HDR
`+(t.gamma2_2PS?t.gamma2_2PS:W.gamma2_2PS):t.gamma1_0PS?t.gamma1_0PS:W.gamma1_0PS}static tonemapCode(e,t=W){return e===gI?t.tonemappingFilmicPS?t.tonemappingFilmicPS:W.tonemappingFilmicPS:e===xd?t.tonemappingLinearPS?t.tonemappingLinearPS:W.tonemappingLinearPS:e===yI?t.tonemappingHejlPS?t.tonemappingHejlPS:W.tonemappingHejlPS:e===vI?t.tonemappingAcesPS?t.tonemappingAcesPS:W.tonemappingAcesPS:e===SI?t.tonemappingAces2PS?t.tonemappingAces2PS:W.tonemappingAces2PS:t.tonemapingNonePS?t.tonemapingNonePS:W.tonemappingNonePS}}function y2(r,e,t,s=!1,i={}){return typeof s=="boolean"?i.useTransformFeedback=s:typeof s=="object"&&(i=Ft({},i,s)),new Nn(r,Mt.createDefinition(r,Ft({},i,{name:`${e}_${t}`,vertexCode:W[e],fragmentCode:W[t]})))}function ks(r,e,t,s,i,n=!1,a={}){typeof n=="boolean"?a.useTransformFeedback=n:typeof n=="object"&&(a=Ft({},a,n));const o=cn(r);let l=o.getCachedShader(s);return l||(l=new Nn(r,Mt.createDefinition(r,Ft({},a,{name:s,vertexCode:e,fragmentCode:t,attributes:i}))),o.setCachedShader(s,l)),l}class v2 extends Be{constructor(e,t){super(),this.key=e,this.shaderDefinition=t}generateKey(e){return this.key}createShaderDefinition(e,t){return this.shaderDefinition}}function Hb(r,e){var t;const s=r.definition,n=`${(t=s.name)!=null?t:"shader"}-id-${r.id}`,a=new v2(n,s),o="shader",l=cn(r.device);l.register(o,a);const c=l.getProgram(o,{},e);return r.definition.shaderLanguage===ud&&(c.meshUniformBufferFormat=s.meshUniformBufferFormat,c.meshBindGroupFormat=s.meshBindGroupFormat),l.unregister(o),c}W.createShader=y2;W.createShaderFromCode=ks;const S2={type:Ji,base:0,count:4,indexed:!1},uh=new P,fh=new P;class df{constructor(e){this.uniformBuffer=void 0,this.bindGroup=void 0;const t=e.device;if(this.shader=e,t.supportsUniformBuffers){const s=new lo;this.shader=Hb(e,s);const i=this.shader.meshUniformBufferFormat;i&&(this.uniformBuffer=new $p(t,i,!1));const n=this.shader.meshBindGroupFormat;this.bindGroup=new gd(t,n,this.uniformBuffer)}}destroy(){var e,t;(e=this.uniformBuffer)==null||e.destroy(),this.uniformBuffer=null,(t=this.bindGroup)==null||t.destroy(),this.bindGroup=null}render(e,t){const s=this.shader.device;if(e){var i;uh.set(s.vx,s.vy,s.vw,s.vh),fh.set(s.sx,s.sy,s.sw,s.sh),t=(i=t)!=null?i:e,s.setViewport(e.x,e.y,e.z,e.w),s.setScissor(t.x,t.y,t.z,t.w)}s.setVertexBuffer(s.quadVertexBuffer,0);const n=this.shader;if(s.setShader(n),s.supportsUniformBuffers){var a;const o=this.bindGroup;(a=o.defaultUniformBuffer)==null||a.update(),o.update(),s.setBindGroup(Tc,o)}s.draw(S2),e&&(s.setViewport(uh.x,uh.y,uh.z,uh.w),s.setScissor(fh.x,fh.y,fh.z,fh.w))}}class x2 extends Hs{constructor(e,t,s,i){super(e),this.quad=t,this.rect=s,this.scissorRect=i}execute(){const{device:e}=this;e.setCullMode(Et),e.setDepthState(kt.NODEPTH),e.setStencilState(null,null),this.quad.render(this.rect,this.scissorRect)}}const w2=new P;function Ya(r,e,t,s,i){const n=new df(t);s||(s=w2,s.x=0,s.y=0,s.z=e?e.width:r.width,s.w=e?e.height:r.height);const a=new x2(r,n,s,i);a.init(e),a.colorOps.clear=!1,a.depthStencilOps.clearDepth=!1,r.isWebGPU&&e===null&&r.samples>1&&(a.colorOps.store=!0),a.render(),n.destroy()}const b2=new di;class T2{constructor(e,t,s={}){this.index=void 0,this.name=void 0,this.shaderDefines=void 0,this.name=e,this.index=t,Object.assign(this,s),this.shaderDefines=this.buildShaderDefines()}buildShaderDefines(){let e;this.isShadow?e="SHADOW":this.isForward?e="FORWARD":this.index===Xi?e="DEPTH":this.index===bd&&(e="PICK");const t=e?`#define ${e}_PASS
`:"",s=`#define ${this.name.toUpperCase()}_PASS
`;return t+s}}class Ii{constructor(){this.passesNamed=new Map,this.passesIndexed=[],this.nextIndex=0;const e=(t,s,i)=>{this.allocate(t,i)};e("forward",wd,{isForward:!0}),e("forward_hdr",sn,{isForward:!0}),e("depth"),e("pick"),e("shadow"),e("prepass")}static get(e){return b2.get(e,()=>new Ii)}allocate(e,t){let s=this.passesNamed.get(e);return s===void 0&&(s=new T2(e,this.nextIndex,t),this.passesNamed.set(s.name,s),this.passesIndexed[s.index]=s,this.nextIndex++),s}getByIndex(e){return this.passesIndexed[e]}getByName(e){return this.passesNamed.get(e)}}class E2 extends Be{generateKey(e){let t="basic";return e.fog&&(t+="_fog"),e.alphaTest&&(t+="_atst"),e.vertexColors&&(t+="_vcol"),e.diffuseMap&&(t+="_diff"),e.skin&&(t+="_skin"),e.screenSpace&&(t+="_ss"),e.useInstancing&&(t+="_inst"),e.useMorphPosition&&(t+="_morphp"),e.useMorphNormal&&(t+="_morphn"),e.useMorphTextureBased&&(t+="_morpht"),t+="_"+e.pass,t}createShaderDefinition(e,t){const s={vertex_position:ht};t.skin&&(s.vertex_boneWeights=hn,s.vertex_boneIndices=Os),t.vertexColors&&(s.vertex_color=Zt),t.diffuseMap&&(s.vertex_texCoord0=zs);const n=Ii.get(e).getByIndex(t.pass).shaderDefines;let a=n;a+=W.transformDeclVS,t.skin?(a+=Be.skinCode(e),a+=W.transformSkinnedVS):a+=W.transformVS,t.vertexColors&&(a+=`attribute vec4 vertex_color;
`,a+=`varying vec4 vColor;
`),t.diffuseMap&&(a+=`attribute vec2 vertex_texCoord0;
`,a+=`varying vec2 vUv0;
`),t.pass===Xi&&(a+=`varying float vDepth;
`,a+=`#ifndef VIEWMATRIX
`,a+=`#define VIEWMATRIX
`,a+=`uniform mat4 matrix_view;
`,a+=`#endif
`,a+=`#ifndef CAMERAPLANES
`,a+=`#define CAMERAPLANES
`,a+=`uniform vec4 camera_params;

`,a+=`#endif
`),a+=Be.begin(),a+=`   gl_Position = getPosition();
`,t.pass===Xi&&(a+=`    vDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;
`),t.vertexColors&&(a+=`    vColor = vertex_color;
`),t.diffuseMap&&(a+=`    vUv0 = vertex_texCoord0;
`),a+=Be.end();let o=n;return t.vertexColors?o+=`varying vec4 vColor;
`:o+=`uniform vec4 uColor;
`,t.diffuseMap&&(o+=`varying vec2 vUv0;
`,o+=`uniform sampler2D texture_diffuseMap;
`),t.fog&&(o+=Be.fogCode(t.fog)),t.alphaTest&&(o+=W.alphaTestPS),t.pass===Xi&&(o+=`varying float vDepth;
`,o+=W.packDepthPS),o+=Be.begin(),t.vertexColors?o+=`    gl_FragColor = vColor;
`:o+=`    gl_FragColor = uColor;
`,t.diffuseMap&&(o+=`    gl_FragColor *= texture2D(texture_diffuseMap, vUv0);
`),t.alphaTest&&(o+=`   alphaTest(gl_FragColor.a);
`),t.pass!==bd&&(t.pass===Xi?o+=`    gl_FragColor = packFloat(vDepth);
`:t.fog&&(o+=`   glFragColor.rgb = addFog(gl_FragColor.rgb);
`)),o+=Be.end(),Mt.createDefinition(e,{name:"BasicShader",attributes:s,vertexCode:a,fragmentCode:o})}}const C2=new E2,Wb=new di;function sh(r){return Wb.get(r)}function A2(r,e){Wb.get(r,()=>e)}const ys=[];ys[Eb]={src:$t,dst:$t,op:NA};ys[ms]={src:$t,dst:fy,op:ci};ys[Bt]={src:py,dst:my,op:ci};ys[qa]={src:$t,dst:my,op:ci};ys[ky]={src:$t,dst:$t,op:ci};ys[Ny]={src:py,dst:$t,op:ci};ys[Cb]={src:eb,dst:kA,op:ci};ys[Ab]={src:BA,dst:$t,op:ci};ys[By]={src:eb,dst:fy,op:ci};ys[Pb]={src:$t,dst:$t,op:UA};ys[Mb]={src:$t,dst:$t,op:zA};let P2=0;class Jt{constructor(){this._shader=null,this.meshInstances=[],this.name="Untitled",this.userId="",this.id=P2++,this.variants=new Map,this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this._blendState=new Xe,this._depthState=new kt,this.cull=Dr,this.stencilFront=null,this.stencilBack=null,this._shaderVersion=0,this._scene=null,this.dirty=!0}set depthBias(e){this._depthState.depthBias=e}get depthBias(){return this._depthState.depthBias}set slopeDepthBias(e){this._depthState.depthBiasSlope=e}get slopeDepthBias(){return this._depthState.depthBiasSlope}set redWrite(e){this._blendState.redWrite=e}get redWrite(){return this._blendState.redWrite}set greenWrite(e){this._blendState.greenWrite=e}get greenWrite(){return this._blendState.greenWrite}set blueWrite(e){this._blendState.blueWrite=e}get blueWrite(){return this._blendState.blueWrite}set alphaWrite(e){this._blendState.alphaWrite=e}get alphaWrite(){return this._blendState.alphaWrite}set shader(e){this._shader=e}get shader(){return this._shader}get transparent(){return this._blendState.blend}_updateTransparency(){const e=this.transparent,t=this.meshInstances;for(let s=0;s<t.length;s++)t[s].transparent=e}set blendState(e){this._blendState.copy(e),this._updateTransparency()}get blendState(){return this._blendState}set blendType(e){const t=ys[e];this._blendState.setColorBlend(t.op,t.src,t.dst),this._blendState.setAlphaBlend(t.op,t.src,t.dst);const s=e!==ms;this._blendState.blend!==s&&(this._blendState.blend=s,this._updateTransparency()),this._updateMeshInstanceKeys()}get blendType(){if(!this.transparent)return ms;const{colorOp:e,colorSrcFactor:t,colorDstFactor:s,alphaOp:i,alphaSrcFactor:n,alphaDstFactor:a}=this._blendState;for(let o=0;o<ys.length;o++){const l=ys[o];if(l.src===t&&l.dst===s&&l.op===e&&l.src===n&&l.dst===a&&l.op===i)return o}return Bt}set depthState(e){this._depthState.copy(e)}get depthState(){return this._depthState}set depthTest(e){this._depthState.test=e}get depthTest(){return this._depthState.test}set depthFunc(e){this._depthState.func=e}get depthFunc(){return this._depthState.func}set depthWrite(e){this._depthState.write=e}get depthWrite(){return this._depthState.write}copy(e){var t;return this.name=e.name,this._shader=e._shader,this.alphaTest=e.alphaTest,this.alphaToCoverage=e.alphaToCoverage,this._blendState.copy(e._blendState),this._depthState.copy(e._depthState),this.cull=e.cull,this.stencilFront=(t=e.stencilFront)==null?void 0:t.clone(),e.stencilBack&&(this.stencilBack=e.stencilFront===e.stencilBack?this.stencilFront:e.stencilBack.clone()),this}clone(){return new this.constructor().copy(this)}_updateMeshInstanceKeys(){const e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].updateKey()}updateUniforms(e,t){}getShaderVariant(e,t,s,i,n,a,o,l,c){const d=new lo(o,l,c);return Hb(this._shader,d)}update(){this.dirty=!0,this._shader&&(this._shader.failed=!1)}clearParameters(){this.parameters={}}getParameters(){return this.parameters}clearVariants(){this.variants.clear();const e=this.meshInstances,t=e.length;for(let s=0;s<t;s++)e[s].clearShaders()}getParameter(e){return this.parameters[e]}setParameter(e,t){if(t===void 0&&typeof e=="object"){const i=e;if(i.length){for(let n=0;n<i.length;n++)this.setParameter(i[n]);return}e=i.name,t=i.value}const s=this.parameters[e];s?s.data=t:this.parameters[e]={scopeId:null,data:t}}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){const s=this.parameters;t===void 0&&(t=s);for(const i in t){const n=s[i];n&&(n.scopeId||(n.scopeId=e.scope.resolve(i)),n.scopeId.setValue(n.data))}}destroy(){this.variants.clear(),this._shader=null;for(let e=0;e<this.meshInstances.length;e++){const t=this.meshInstances[e];if(t.clearShaders(),t._material=null,t.mesh){const s=sh(t.mesh.device);this!==s&&(t.material=s)}}this.meshInstances.length=0}addMeshInstanceRef(e){this.meshInstances.push(e)}removeMeshInstanceRef(e){const t=this.meshInstances,s=t.indexOf(e);s!==-1&&t.splice(s,1)}}class M2 extends Jt{constructor(...e){super(...e),this.color=new k(1,1,1,1),this.colorUniform=new Float32Array(4),this.colorMap=null,this.vertexColors=!1}copy(e){return super.copy(e),this.color.copy(e.color),this.colorMap=e.colorMap,this.vertexColors=e.vertexColors,this}updateUniforms(e,t){this.clearParameters(),this.colorUniform[0]=this.color.r,this.colorUniform[1]=this.color.g,this.colorUniform[2]=this.color.b,this.colorUniform[3]=this.color.a,this.setParameter("uColor",this.colorUniform),this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)}getShaderVariant(e,t,s,i,n,a,o,l,c){const d={skin:s&&(s&Ac)!==0,screenSpace:s&&(s&Mc)!==0,useInstancing:s&&(s&Pc)!==0,useMorphPosition:s&&(s&Ic)!==0,useMorphNormal:s&&(s&Rc)!==0,useMorphTextureBased:s&&(s&Lc)!==0,alphaTest:this.alphaTest>0,vertexColors:this.vertexColors,diffuseMap:!!this.colorMap,pass:n},h=new lo(o,l,c),u=cn(e);return u.register("basic",C2),u.getProgram("basic",d,h,this.userId)}}class lg{constructor(e,t,s){this._aabb=new Re,this.origMeshInstances=void 0,this.meshInstance=null,this.dynamic=void 0,this.batchGroupId=void 0,this.origMeshInstances=e,this.dynamic=t,this.batchGroupId=s}destroy(e,t){this.meshInstance&&(this.removeFromLayers(e,t),this.meshInstance.destroy(),this.meshInstance=null)}addToLayers(e,t){for(let s=0;s<t.length;s++){const i=e.layers.getLayerById(t[s]);i&&i.addMeshInstances([this.meshInstance])}}removeFromLayers(e,t){for(let s=0;s<t.length;s++){const i=e.layers.getLayerById(t[s]);i&&i.removeMeshInstances([this.meshInstance])}}updateBoundingBox(){this._aabb.copy(this.origMeshInstances[0].aabb);for(let e=1;e<this.origMeshInstances.length;e++)this._aabb.add(this.origMeshInstances[e].aabb);this.meshInstance.aabb=this._aabb,this.meshInstance._aabbVer=0}}class _t{constructor(e,t,s,i,n=[Ws]){this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]},this.id=void 0,this.name=void 0,this.dynamic=void 0,this.maxAabbSize=void 0,this.layers=void 0,this.id=e,this.name=t,this.dynamic=s,this.maxAabbSize=i,this.layers=n}}_t.MODEL="model";_t.ELEMENT="element";_t.SPRITE="sprite";_t.RENDER="render";const Wv=new q;class Td{constructor(e){this.bones=void 0,this.boneTextureSize=void 0,this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,e&&this.initSkin(e)}set rootBone(e){this._rootBone=e}get rootBone(){return this._rootBone}init(e,t){if(e.supportsBoneTextures){const s=t*3;let i=Math.ceil(Math.sqrt(s));i=H.roundUp(i,3);const n=Math.ceil(s/i);this.boneTexture=new _e(e,{width:i,height:n,format:rt,mipmaps:!1,minFilter:Ee,magFilter:Ee,name:"skin"}),this.boneTextureSize=[i,n,1/i,1/n],this.matrixPalette=this.boneTexture.lock({mode:i1}),this.boneTexture.unlock()}else this.matrixPalette=new Float32Array(t*12)}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)}resolve(e,t){this.rootBone=e;const s=this.skin,i=[];for(let n=0;n<s.boneNames.length;n++){const a=s.boneNames[n];let o=e.findByName(a);o||(o=t),i.push(o)}this.bones=i}initSkin(e){this.skin=e,this.bones=[];const t=e.inverseBindPose.length;this.init(e.device,t),this.matrices=[];for(let s=0;s<t;s++)this.matrices[s]=new q}uploadBones(e){e.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}_updateMatrices(e,t){if(this._skinUpdateIndex!==t){this._skinUpdateIndex=t,Wv.copy(e.getWorldTransform()).invert();for(let s=this.bones.length-1;s>=0;s--)this.matrices[s].mulAffine2(Wv,this.bones[s].getWorldTransform()),this.matrices[s].mulAffine2(this.matrices[s],this.skin.inverseBindPose[s])}}updateMatrices(e,t){this._updateBeforeCull&&this._updateMatrices(e,t)}updateMatrixPalette(e,t){this._updateMatrices(e,t);const s=this.matrixPalette,i=this.bones.length;for(let n=0;n<i;n++){const a=this.matrices[n].data,o=n*12;s[o]=a[0],s[o+1]=a[4],s[o+2]=a[8],s[o+3]=a[12],s[o+4]=a[1],s[o+5]=a[5],s[o+6]=a[9],s[o+7]=a[13],s[o+8]=a[2],s[o+9]=a[6],s[o+10]=a[10],s[o+11]=a[14]}this.uploadBones(this.skin.device)}}class jv extends Td{constructor(e,t,s){super();const i=t.length;this.init(e,i),this.device=e,this.rootNode=s,this.bones=t}updateMatrices(e,t){}updateMatrixPalette(e,t){const s=this.matrixPalette,i=this.bones.length;for(let n=0;n<i;n++){const a=this.bones[n].getWorldTransform().data,o=n*12;s[o]=a[0],s[o+1]=a[4],s[o+2]=a[8],s[o+3]=a[12],s[o+4]=a[1],s[o+5]=a[5],s[o+6]=a[9],s[o+7]=a[13],s[o+8]=a[2],s[o+9]=a[6],s[o+10]=a[10],s[o+11]=a[14]}this.uploadBones(this.device)}}const $v=new q,Tm=new y,Xv=new re,Em=new re,qv=new y,Kv=new y,I2=new q,R2=new re,Ss=new y,Yv=new q,xs=new re,xo=new re,Zv=new q,Cm=new y,Xd=new y;function Jv(r,e){return r instanceof Function?r:t=>{let s=t[r];return s instanceof Function&&(s=s()),s===e}}function jb(r,e){if(e(r))return r;const t=r._children,s=t.length;for(let i=0;i<s;++i){const n=jb(t[i],e);if(n)return n}return null}class ze extends ie{constructor(e="Untitled"){super(),this.name=void 0,this.tags=new Xc(this),this._labels={},this.localPosition=new y,this.localRotation=new re,this.localScale=new y(1,1,1),this.localEulerAngles=new y,this.position=new y,this.rotation=new re,this.eulerAngles=new y,this._scale=null,this.localTransform=new q,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new q,this._dirtyWorld=!1,this._worldScaleSign=0,this._normalMatrix=new hi,this._dirtyNormal=!0,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1,this.name=e}get right(){return this._right||(this._right=new y),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new y),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new y),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}get normalMatrix(){const e=this._normalMatrix;return this._dirtyNormal&&(e.invertMat4(this.getWorldTransform()).transpose(),this._dirtyNormal=!1),e}set enabled(e){if(this._enabled!==e){var t;this._enabled=e,(e&&(t=this._parent)!=null&&t.enabled||!e)&&this._notifyHierarchyStateChanged(this,e)}}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){let e=this._parent;if(!e)return"";let t=this.name;for(;e&&e._parent;)t=`${e.name}/${t}`,e=e._parent;return t}get root(){let e=this;for(;e._parent;)e=e._parent;return e}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(e,t){e._onHierarchyStateChanged(t);const s=e._children;for(let i=0,n=s.length;i<n;i++)s[i]._enabled&&this._notifyHierarchyStateChanged(s[i],t)}_onHierarchyStateChanged(e){this._enabledInHierarchy=e,e&&!this._frozen&&this._unfreezeParentToRoot()}_cloneInternal(e){e.name=this.name;const t=this.tags._list;e.tags.clear();for(let s=0;s<t.length;s++)e.tags.add(t[s]);e._labels=Object.assign({},this._labels),e.localPosition.copy(this.localPosition),e.localRotation.copy(this.localRotation),e.localScale.copy(this.localScale),e.localEulerAngles.copy(this.localEulerAngles),e.position.copy(this.position),e.rotation.copy(this.rotation),e.eulerAngles.copy(this.eulerAngles),e.localTransform.copy(this.localTransform),e._dirtyLocal=this._dirtyLocal,e.worldTransform.copy(this.worldTransform),e._dirtyWorld=this._dirtyWorld,e._dirtyNormal=this._dirtyNormal,e._aabbVer=this._aabbVer+1,e._enabled=this._enabled,e.scaleCompensation=this.scaleCompensation,e._enabledInHierarchy=!1}clone(){const e=new this.constructor;return this._cloneInternal(e),e}copy(e){return e._cloneInternal(this),this}destroy(){this.remove();const e=this._children;for(;e.length;){const t=e.pop();t._parent=null,t.destroy()}this.fire("destroy",this),this.off()}find(e,t){const s=[],i=Jv(e,t);return this.forEach(n=>{i(n)&&s.push(n)}),s}findOne(e,t){const s=Jv(e,t);return jb(this,s)}findByTag(){const e=arguments,t=[],s=(i,n)=>{n&&i.tags.has(...e)&&t.push(i);for(let a=0;a<i._children.length;a++)s(i._children[a],!0)};return s(this,!1),t}findByName(e){return this.findOne("name",e)}findByPath(e){const t=Array.isArray(e)?e:e.split("/");let s=this;for(let i=0,n=t.length;i<n;++i)if(s=s.children.find(a=>a.name===t[i]),!s)return null;return s}forEach(e,t){e.call(t,this);const s=this._children,i=s.length;for(let n=0;n<i;++n)s[n].forEach(e,t)}isDescendantOf(e){let t=this._parent;for(;t;){if(t===e)return!0;t=t._parent}return!1}isAncestorOf(e){return e.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new y),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return!this._dirtyLocal&&!this._dirtyWorld?this.worldTransform:(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform)}get worldScaleSign(){return this._worldScaleSign===0&&(this._worldScaleSign=this.getWorldTransform().scaleSign),this._worldScaleSign}remove(){var e;(e=this._parent)==null||e.removeChild(this)}reparent(e,t){this.remove(),e&&(t>=0?e.insertChild(this,t):e.addChild(this))}setLocalEulerAngles(e,t,s){this.localRotation.setFromEulerAngles(e,t,s),this._dirtyLocal||this._dirtifyLocal()}setLocalPosition(e,t,s){e instanceof y?this.localPosition.copy(e):this.localPosition.set(e,t,s),this._dirtyLocal||this._dirtifyLocal()}setLocalRotation(e,t,s,i){e instanceof re?this.localRotation.copy(e):this.localRotation.set(e,t,s,i),this._dirtyLocal||this._dirtifyLocal()}setLocalScale(e,t,s){e instanceof y?this.localScale.copy(e):this.localScale.set(e,t,s),this._dirtyLocal||this._dirtifyLocal()}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())}_unfreezeParentToRoot(){let e=this._parent;for(;e;)e._frozen=!1,e=e._parent}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(let e=0;e<this._children.length;e++)this._children[e]._dirtyWorld||this._children[e]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._worldScaleSign=0,this._aabbVer++}setPosition(e,t,s){e instanceof y?Ss.copy(e):Ss.set(e,t,s),this._parent===null?this.localPosition.copy(Ss):(Yv.copy(this._parent.getWorldTransform()).invert(),Yv.transformPoint(Ss,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}setRotation(e,t,s,i){if(e instanceof re?xs.copy(e):xs.set(e,t,s,i),this._parent===null)this.localRotation.copy(xs);else{const n=this._parent.getRotation();xo.copy(n).invert(),this.localRotation.copy(xo).mul(xs)}this._dirtyLocal||this._dirtifyLocal()}setEulerAngles(e,t,s){if(this.localRotation.setFromEulerAngles(e,t,s),this._parent!==null){const i=this._parent.getRotation();xo.copy(i).invert(),this.localRotation.mul2(xo,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()}addChild(e){this._prepareInsertChild(e),this._children.push(e),this._onInsertChild(e)}addChildAndSaveTransform(e){const t=e.getPosition(),s=e.getRotation();this._prepareInsertChild(e),e.setPosition(I2.copy(this.worldTransform).invert().transformPoint(t)),e.setRotation(R2.copy(this.getRotation()).invert().mul(s)),this._children.push(e),this._onInsertChild(e)}insertChild(e,t){this._prepareInsertChild(e),this._children.splice(t,0,e),this._onInsertChild(e)}_prepareInsertChild(e){e.remove()}_fireOnHierarchy(e,t,s){this.fire(e,s);for(let i=0;i<this._children.length;i++)this._children[i]._fireOnHierarchy(t,t,s)}_onInsertChild(e){e._parent=this;const t=e._enabled&&this.enabled;e._enabledInHierarchy!==t&&(e._enabledInHierarchy=t,e._notifyHierarchyStateChanged(e,t)),e._updateGraphDepth(),e._dirtifyWorld(),this._frozen&&e._unfreezeParentToRoot(),e._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",e)}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._updateGraphDepth()}removeChild(e){const t=this._children.indexOf(e);t!==-1&&(this._children.splice(t,1),e._parent=null,e._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",e))}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(this._parent===null)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){let e;const t=this._parent;let s=this.localScale,i=t;if(i){for(;i&&i.scaleCompensation;)i=i._parent;i&&(i=i._parent,i&&(e=i.worldTransform.getScale(),qv.mul2(e,this.localScale),s=qv))}Em.setFromMat4(t.worldTransform),Xv.mul2(Em,this.localRotation);let n=t.worldTransform;t.scaleCompensation&&(Kv.mul2(e,t.getLocalScale()),$v.setTRS(t.worldTransform.getTranslation(Tm),Em,Kv),n=$v),n.transformPoint(this.localPosition,Tm),this.worldTransform.setTRS(Tm,Xv,s)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}}syncHierarchy(){if(!this._enabled||this._frozen)return;this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();const e=this._children;for(let t=0,s=e.length;t<s;t++)e[t].syncHierarchy()}lookAt(e,t,s,i=0,n=1,a=0){if(e instanceof y)Cm.copy(e),t instanceof y?Xd.copy(t):Xd.copy(y.UP);else{if(s===void 0)return;Cm.set(e,t,s),Xd.set(i,n,a)}Zv.setLookAt(this.getPosition(),Cm,Xd),xs.setFromMat4(Zv),this.setRotation(xs)}translate(e,t,s){e instanceof y?Ss.copy(e):Ss.set(e,t,s),Ss.add(this.getPosition()),this.setPosition(Ss)}translateLocal(e,t,s){e instanceof y?Ss.copy(e):Ss.set(e,t,s),this.localRotation.transformVector(Ss,Ss),this.localPosition.add(Ss),this._dirtyLocal||this._dirtifyLocal()}rotate(e,t,s){if(xs.setFromEulerAngles(e,t,s),this._parent===null)this.localRotation.mul2(xs,this.localRotation);else{const i=this.getRotation(),n=this._parent.getRotation();xo.copy(n).invert(),xs.mul2(xo,xs),this.localRotation.mul2(xs,i)}this._dirtyLocal||this._dirtifyLocal()}rotateLocal(e,t,s){xs.setFromEulerAngles(e,t,s),this.localRotation.mul(xs),this._dirtyLocal||this._dirtifyLocal()}}class L2{constructor(){this.cache=new Map}destroy(){this.cache.forEach((e,t)=>{t.destroy()}),this.cache.clear()}incRef(e){const t=(this.cache.get(e)||0)+1;this.cache.set(e,t)}decRef(e){if(e){let t=this.cache.get(e);t&&(t--,t===0?(this.cache.delete(e),e.destroy()):this.cache.set(e,t))}}}class En{static incRef(e){this.cache.incRef(e)}static decRef(e){this.cache.decRef(e)}static destroy(){this.cache.destroy()}}En.cache=new L2;let D2=0;const O2=new Re,qd=new Re,Am=new Al,Pm=new Set;class F2{constructor(e){this.vertexBuffer=null,this.count=e}}class k2{constructor(){this.shader=void 0,this.bindGroup=null}getBindGroup(e){if(!this.bindGroup){const t=this.shader,s=t.meshUniformBufferFormat,i=new $p(e,s,!1),n=t.meshBindGroupFormat;this.bindGroup=new gd(e,n,i)}return this.bindGroup}destroy(){const e=this.bindGroup;if(e){var t;(t=e.defaultUniformBuffer)==null||t.destroy(),e.destroy(),this.bindGroup=null}}}class B2{constructor(){this.shaderInstances=new Map}destroy(){this.shaderInstances.forEach(e=>e.destroy()),this.shaderInstances.clear()}}class Fe{constructor(e,t,s=null){if(this.visible=!0,this.castShadow=!1,this.transparent=!1,this._material=null,this._shaderCache=[],this.id=D2++,this.pick=!0,e instanceof ze){const i=e;e=t,t=s,s=i}this._key=[0,0],this.node=s,this._mesh=e,e.incRefCount(),this.material=t,this._shaderDefs=Fs<<16,this._shaderDefs|=e.vertexBuffer.format.hasUv0?Ob:0,this._shaderDefs|=e.vertexBuffer.format.hasUv1?Fb:0,this._shaderDefs|=e.vertexBuffer.format.hasColor?kb:0,this._shaderDefs|=e.vertexBuffer.format.hasTangents?jy:0,this.layer=Ib,this._renderStyle=Qh,this._receiveShadow=!0,this._screenSpace=!1,this.cull=!0,this._updateAabb=!0,this._updateAabbFunc=null,this._calculateSortDistance=null,this.updateKey(),this._skinInstance=null,this._morphInstance=null,this.gsplatInstance=null,this.instancingData=null,this._customAabb=null,this.aabb=new Re,this._aabbVer=-1,this._aabbMeshVer=-1,this.drawOrder=0,this.visibleThisFrame=!1,this.isVisibleFunc=null,this.parameters={},this.stencilFront=null,this.stencilBack=null,this.flipFacesFactor=1}set renderStyle(e){this._renderStyle=e,this.mesh.prepareRenderState(e)}get renderStyle(){return this._renderStyle}set mesh(e){e!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=e,e&&e.incRefCount())}get mesh(){return this._mesh}set aabb(e){this._aabb=e}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);let e=this._customAabb,t=!!e;if(!e){if(e=O2,this.skinInstance){if(!this.mesh.boneAabb){const n=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(n)}const s=this.mesh.boneUsed;let i=!0;for(let n=0;n<this.mesh.boneAabb.length;n++)s[n]&&(qd.setFromTransformedAabb(this.mesh.boneAabb[n],this.skinInstance.matrices[n]),i?(i=!1,e.center.copy(qd.center),e.halfExtents.copy(qd.halfExtents)):e.add(qd));t=!0}else if(this.node._aabbVer!==this._aabbVer||this.mesh._aabbVer!==this._aabbMeshVer){if(this.mesh?(e.center.copy(this.mesh.aabb.center),e.halfExtents.copy(this.mesh.aabb.halfExtents)):(e.center.set(0,0,0),e.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph){const s=this.mesh.morph.aabb;e._expand(s.getMin(),s.getMax())}t=!0,this._aabbVer=this.node._aabbVer,this._aabbMeshVer=this.mesh._aabbVer}}return t&&this._aabb.setFromTransformedAabb(e,this.node.getWorldTransform()),this._aabb}clearShaders(){const e=this._shaderCache;for(let s=0;s<e.length;s++){var t;(t=e[s])==null||t.destroy(),e[s]=null}}getShaderInstance(e,t,s,i,n,a){let o,l=this._shaderCache[e];if(l?o=l.shaderInstances.get(t):(l=new B2,this._shaderCache[e]=l),!o){const c=this._material,d=this._shaderDefs,h=e+"_"+d+"_"+t;if(o=new k2,o.shader=c.variants.get(h),!o.shader){const u=c.getShaderVariant(this.mesh.device,s,d,null,e,a,i,n,this._mesh.vertexBuffer.format);c.variants.set(h,u),o.shader=u}l.shaderInstances.set(t,o)}return o}set material(e){this.clearShaders();const t=this._material;t&&t.removeMeshInstanceRef(this),this._material=e,e&&(e.addMeshInstanceRef(this),this.transparent=e.transparent,this.updateKey())}get material(){return this._material}set layer(e){this._layer=e,this.updateKey()}get layer(){return this._layer}_updateShaderDefs(e){e!==this._shaderDefs&&(this._shaderDefs=e,this.clearShaders())}set calculateSortDistance(e){this._calculateSortDistance=e}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(e){this._receiveShadow!==e&&(this._receiveShadow=e,this._updateShaderDefs(e?this._shaderDefs&~of:this._shaderDefs|of))}get receiveShadow(){return this._receiveShadow}set skinInstance(e){this._skinInstance=e,this._updateShaderDefs(e?this._shaderDefs|Ac:this._shaderDefs&~Ac),this._setupSkinUpdate()}get skinInstance(){return this._skinInstance}set morphInstance(e){var t;(t=this._morphInstance)==null||t.destroy(),this._morphInstance=e;let s=this._shaderDefs;s=e&&e.morph.useTextureMorph?s|Lc:s&~Lc,s=e&&e.morph.morphPositions?s|Ic:s&~Ic,s=e&&e.morph.morphNormals?s|Rc:s&~Rc,this._updateShaderDefs(s)}get morphInstance(){return this._morphInstance}set screenSpace(e){this._screenSpace!==e&&(this._screenSpace=e,this._updateShaderDefs(e?this._shaderDefs|Mc:this._shaderDefs&~Mc))}get screenSpace(){return this._screenSpace}set key(e){this._key[Rn]=e}get key(){return this._key[Rn]}set mask(e){const t=this._shaderDefs&65535;this._updateShaderDefs(t|e<<16)}get mask(){return this._shaderDefs>>16}set instancingCount(e){this.instancingData&&(this.instancingData.count=e)}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){var e,t;const s=this.mesh;s&&(this.mesh=null,s.refCount<1&&s.destroy()),this.setRealtimeLightmap(Fe.lightmapParamNames[0],null),this.setRealtimeLightmap(Fe.lightmapParamNames[1],null),(e=this._skinInstance)==null||e.destroy(),this._skinInstance=null,(t=this.morphInstance)==null||t.destroy(),this.morphInstance=null,this.clearShaders(),this.material=null}static _prepareRenderStyleForArray(e,t){if(e){for(let s=0;s<e.length;s++){e[s]._renderStyle=t;const i=e[s].mesh;Pm.has(i)||(Pm.add(i),i.prepareRenderState(t))}Pm.clear()}}_isVisible(e){return this.visible?this.isVisibleFunc?this.isVisibleFunc(e):(Am.center=this.aabb.center,Am.radius=this._aabb.halfExtents.length(),e.frustum.containsSphere(Am)):!1}updateKey(){const e=this.material,t=e.alphaToCoverage||e.alphaTest?Bt:e.blendType;this._key[Rn]=(this.layer&15)<<27|(t===ms?1:0)<<26|(e.id&33554431)<<0}setInstancing(e,t=!1){e?(this.instancingData=new F2(e.numVertices),this.instancingData.vertexBuffer=e,e.format.instancing=!0,this.cull=t):(this.instancingData=null,this.cull=!0),this._updateShaderDefs(e?this._shaderDefs|Pc:this._shaderDefs&~Pc)}ensureMaterial(e){this.material||(this.material=sh(e))}clearParameters(){this.parameters={}}getParameters(){return this.parameters}getParameter(e){return this.parameters[e]}setParameter(e,t,s=-262141){if(t===void 0&&typeof e=="object"){const n=e;if(n.length){for(let a=0;a<n.length;a++)this.setParameter(n[a]);return}e=n.name,t=n.value}const i=this.parameters[e];i?(i.data=t,i.passFlags=s):this.parameters[e]={scopeId:null,data:t,passFlags:s}}setRealtimeLightmap(e,t){const s=this.getParameter(e);s!==t&&(s&&En.decRef(s.data),t?(En.incRef(t),this.setParameter(e,t)):this.deleteParameter(e))}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){const s=this.parameters;for(const i in s){const n=s[i];n.passFlags&t&&(n.scopeId||(n.scopeId=e.scope.resolve(i)),n.scopeId.setValue(n.data))}}setLightmapped(e){e?this.mask=(this.mask|ji)&~(Fs|$i):(this.setRealtimeLightmap(Fe.lightmapParamNames[0],null),this.setRealtimeLightmap(Fe.lightmapParamNames[1],null),this._shaderDefs&=~(lf|Wy|$y),this.mask=(this.mask|Fs)&~(ji|$i))}setCustomAabb(e){e?this._customAabb?this._customAabb.copy(e):this._customAabb=e.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)}}Fe.lightmapParamNames=["texture_lightMap","texture_dirLightMap"];function Qv(r,e){if(r&&!e||!r&&e)return!1;if(r=r.data,e=e.data,r===e)return!0;if(r instanceof Float32Array&&e instanceof Float32Array){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}return!1}function N2(r,e){for(const t in r)if(r.hasOwnProperty(t)&&!Qv(r[t],e[t]))return!1;for(const t in e)if(e.hasOwnProperty(t)&&!Qv(e[t],r[t]))return!1;return!0}const U2=[0,1,3,2,3,1],z2=[0,1,3,0,3,2],eS=new hi;function Mm(r){return r.node.worldTransform.scaleSign}class V2{constructor(e,t,s){this.device=e,this.rootNode=t,this.scene=s,this._init=!1,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[]}destroy(){this.device=null,this.rootNode=null,this.scene=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[]}addGroup(e,t,s,i,n){if(i===void 0&&(i=this._batchGroupCounter,this._batchGroupCounter++),this._batchGroups[i])return;const a=new _t(i,e,t,s,n);return this._batchGroups[i]=a,a}removeGroup(e){if(!this._batchGroups[e])return;const t=[];for(let s=0;s<this._batchList.length;s++)this._batchList[s].batchGroupId===e?this.destroyBatch(this._batchList[s]):t.push(this._batchList[s]);this._batchList=t,this._removeModelsFromBatchGroup(this.rootNode,e),delete this._batchGroups[e]}markGroupDirty(e){this._dirtyGroups.indexOf(e)<0&&this._dirtyGroups.push(e)}getGroupByName(e){const t=this._batchGroups;for(const s in t)if(t.hasOwnProperty(s)&&t[s].name===e)return t[s];return null}getBatches(e){const t=[],s=this._batchList.length;for(let i=0;i<s;i++){const n=this._batchList[i];n.batchGroupId===e&&t.push(n)}return t}_removeModelsFromBatchGroup(e,t){if(e.enabled){e.model&&e.model.batchGroupId===t&&(e.model.batchGroupId=-1),e.render&&e.render.batchGroupId===t&&(e.render.batchGroupId=-1),e.element&&e.element.batchGroupId===t&&(e.element.batchGroupId=-1),e.sprite&&e.sprite.batchGroupId===t&&(e.sprite.batchGroupId=-1);for(let s=0;s<e._children.length;s++)this._removeModelsFromBatchGroup(e._children[s],t)}}insert(e,t,s){const i=this._batchGroups[t];i&&i._obj[e].indexOf(s)<0&&(i._obj[e].push(s),this.markGroupDirty(t))}remove(e,t,s){const i=this._batchGroups[t];if(i){const n=i._obj[e].indexOf(s);n>=0&&(i._obj[e].splice(n,1),this.markGroupDirty(t))}}_extractRender(e,t,s,i){return e.render&&(t=i[e.render.batchGroupId]=t.concat(e.render.meshInstances),e.render.removeFromLayers()),t}_extractModel(e,t,s,i){return e.model&&e.model.model&&(t=i[e.model.batchGroupId]=t.concat(e.model.meshInstances),e.model.removeModelFromLayers()),t}_extractElement(e,t,s){if(!e.element)return;let i=!1;e.element._text&&e.element._text._model.meshInstances.length>0?(t.push(e.element._text._model.meshInstances[0]),e.element.removeModelFromLayers(e.element._text._model),i=!0):e.element._image&&(t.push(e.element._image._renderable.meshInstance),e.element.removeModelFromLayers(e.element._image._renderable.model),e.element._image._renderable.unmaskMeshInstance&&(t.push(e.element._image._renderable.unmaskMeshInstance),(!e.element._image._renderable.unmaskMeshInstance.stencilFront||!e.element._image._renderable.unmaskMeshInstance.stencilBack)&&(e.element._dirtifyMask(),e.element._onPrerender())),i=!0),i&&(s._ui=!0)}_collectAndRemoveMeshInstances(e,t){for(let s=0;s<t.length;s++){const i=t[s],n=this._batchGroups[i];if(!n)continue;let a=e[i];a||(a=e[i]=[]);for(let o=0;o<n._obj.model.length;o++)a=this._extractModel(n._obj.model[o],a,n,e);for(let o=0;o<n._obj.render.length;o++)a=this._extractRender(n._obj.render[o],a,n,e);for(let o=0;o<n._obj.element.length;o++)this._extractElement(n._obj.element[o],a,n);for(let o=0;o<n._obj.sprite.length;o++){const l=n._obj.sprite[o];l.sprite&&l.sprite._meshInstance&&(n.dynamic||l.sprite.sprite._renderMode===Pn)&&(a.push(l.sprite._meshInstance),l.sprite.removeModelFromLayers(),n._sprite=!0,l.sprite._batchGroup=n)}}}generate(e){const t={};e||(e=Object.keys(this._batchGroups));const s=[];for(let l=0;l<this._batchList.length;l++){if(e.indexOf(this._batchList[l].batchGroupId)<0){s.push(this._batchList[l]);continue}this.destroyBatch(this._batchList[l])}if(this._batchList=s,this._collectAndRemoveMeshInstances(t,e),e===this._dirtyGroups)this._dirtyGroups.length=0;else{const l=[];for(let c=0;c<this._dirtyGroups.length;c++)e.indexOf(this._dirtyGroups[c])<0&&l.push(this._dirtyGroups[c]);this._dirtyGroups=l}let i,n,a,o;for(const l in t)if(t.hasOwnProperty(l)&&(i=t[l],a=this._batchGroups[l],!!a)){n=this.prepare(i,a.dynamic,a.maxAabbSize,a._ui||a._sprite);for(let c=0;c<n.length;c++)o=this.create(n[c],a.dynamic,parseInt(l,10)),o&&o.addToLayers(this.scene,a.layers)}}prepare(e,t,s=Number.POSITIVE_INFINITY,i){if(e.length===0)return[];const n=s*.5,a=this.device.supportsBoneTextures?1024:this.device.boneLimit,o=this.device.extUintElement?4294967295:65535,l=new Re,c=new Re;let d=null,h;const u=[];let f=0;i&&e.sort(function(g,v){return g.drawOrder-v.drawOrder});let p=e,_;const m=i?function(g){d?d.add(g.aabb):d=g.aabb.clone(),_.push(g)}:function(g){_.push(g)};for(;p.length>0;){u[f]=[p[0]],_=[];const g=p[0].material,v=p[0].layer,x=p[0]._shaderDefs,S=p[0].parameters,w=p[0].stencilFront;let T=p[0].mesh.vertexBuffer.getNumVertices();const b=p[0].drawOrder;l.copy(p[0].aabb);const C=Mm(p[0]),E=p[0].mesh.vertexBuffer.format.batchingHash,R=p[0].mesh.primitive[0].indexed;d=null;for(let B=1;B<p.length;B++){const L=p[B];if(t&&u[f].length>=a){_=_.concat(p.slice(B));break}if(g!==L.material||v!==L.layer||E!==L.mesh.vertexBuffer.format.batchingHash||R!==L.mesh.primitive[0].indexed||x!==L._shaderDefs||T+L.mesh.vertexBuffer.getNumVertices()>o){m(L);continue}if(c.copy(l),c.add(L.aabb),c.halfExtents.x>n||c.halfExtents.y>n||c.halfExtents.z>n){m(L);continue}if(w&&(!(h=L.stencilFront)||w.func!==h.func||w.zpass!==h.zpass)){m(L);continue}if(C!==Mm(L)){m(L);continue}if(!N2(S,L.parameters)){m(L);continue}if(i&&d&&d.intersects(L.aabb)&&L.drawOrder!==b){m(L);continue}l.add(L.aabb),T+=L.mesh.vertexBuffer.getNumVertices(),u[f].push(L)}f++,p=_}return u}collectBatchedMeshData(e,t){let s=null,i=0,n=0,a=null;for(let o=0;o<e.length;o++)if(e[o].visible){const l=e[o].mesh,c=l.vertexBuffer.numVertices;if(i+=c,l.primitive[0].indexed)n+=l.primitive[0].count;else{const d=l.primitive[0].type;(d===Ia||d===Ji)&&l.primitive[0].count===4&&(n+=6)}if(!s){a=e[o].material,s={};const d=l.vertexBuffer.format.elements;for(let h=0;h<d.length;h++){const u=d[h].name;s[u]={numComponents:d[h].numComponents,dataType:d[h].dataType,normalize:d[h].normalize,count:0}}t&&(s[Os]={numComponents:1,dataType:Me,normalize:!1,count:0})}}return{streams:s,batchNumVerts:i,batchNumIndices:n,material:a}}create(e,t,s){if(!this._init){const d="#define BONE_LIMIT "+this.device.getBoneLimit()+`
`;this.transformVS=d+`#define DYNAMICBATCH
`+W.transformVS,this.skinTexVS=W.skinBatchTexVS,this.skinConstVS=W.skinBatchConstVS,this.vertexFormats={},this._init=!0}let i=null,n,a,o,l=null;const c=this.collectBatchedMeshData(e,t);if(c.streams){const d=c.streams;let h=c.material;const u=c.batchNumVerts,f=c.batchNumIndices;l=new lg(e,t,s),this._batchList.push(l);let p,_,m,g=0,v=0,x;const S=new y,w=u<=65535?Uint16Array:Uint32Array,T=new w(f);for(n in d)i=d[n],i.typeArrayType=xl[i.dataType],i.elementByteSize=Zh[i.dataType],i.buffer=new i.typeArrayType(u*i.numComponents);for(let E=0;E<e.length;E++)if(e[E].visible){a=e[E].mesh,o=a.vertexBuffer.numVertices,t||(x=e[E].node.getWorldTransform());for(n in d)if(n!==Os){i=d[n];const R=new i.typeArrayType(i.buffer.buffer,i.elementByteSize*i.count),B=a.getVertexStream(n,R)*i.numComponents;if(i.count+=B,!t&&i.numComponents>=3){if(n===ht)for(let L=0;L<B;L+=i.numComponents)S.set(R[L],R[L+1],R[L+2]),x.transformPoint(S,S),R[L]=S.x,R[L+1]=S.y,R[L+2]=S.z;else if(n===Us||n===ln){eS.invertMat4(x).transpose();for(let L=0;L<B;L+=i.numComponents)S.set(R[L],R[L+1],R[L+2]),eS.transformVector(S,S),R[L]=S.x,R[L+1]=S.y,R[L+2]=S.z}}}if(t){i=d[Os];for(let R=0;R<o;R++)i.buffer[i.count++]=E}if(a.primitive[0].indexed){p=a.primitive[0].base,_=a.primitive[0].count;const R=a.indexBuffer[0].getFormat();m=new Y_[R](a.indexBuffer[0].storage)}else{const R=a.primitive[0].type;if(R===Ia||R===Ji)if(a.primitive[0].count===4)p=0,_=6,m=R===Ia?U2:z2;else{_=0;continue}}for(let R=0;R<_;R++)T[R+v]=m[p+R]+g;v+=_,g+=o}a=new Vs(this.device);for(n in d)i=d[n],a.setVertexStream(n,i.buffer,i.numComponents,void 0,i.dataType,i.normalize);T.length>0&&a.setIndices(T),a.update(Ln,!1),t&&(h=h.clone(),h.chunks.transformVS=this.transformVS,h.chunks.skinTexVS=this.skinTexVS,h.chunks.skinConstVS=this.skinConstVS,h.update());const b=new Fe(a,h,this.rootNode);b.castShadow=l.origMeshInstances[0].castShadow,b.parameters=l.origMeshInstances[0].parameters,b.layer=l.origMeshInstances[0].layer,b._shaderDefs=l.origMeshInstances[0]._shaderDefs,b.cull=l.origMeshInstances[0].cull;const C=this._batchGroups[s];if(C&&C._ui&&(b.cull=!1),t){const E=[];for(let R=0;R<l.origMeshInstances.length;R++)E.push(l.origMeshInstances[R].node);b.skinInstance=new jv(this.device,E,this.rootNode)}b._updateAabb=!1,b.drawOrder=l.origMeshInstances[0].drawOrder,b.stencilFront=l.origMeshInstances[0].stencilFront,b.stencilBack=l.origMeshInstances[0].stencilBack,b.flipFacesFactor=Mm(l.origMeshInstances[0]),b.castShadow=l.origMeshInstances[0].castShadow,l.meshInstance=b,l.updateBoundingBox()}return l}updateAll(){this._dirtyGroups.length>0&&this.generate(this._dirtyGroups);for(let e=0;e<this._batchList.length;e++)this._batchList[e].dynamic&&this._batchList[e].updateBoundingBox()}clone(e,t){const s=new lg(t,e.dynamic,e.batchGroupId);this._batchList.push(s);const i=[];for(let n=0;n<t.length;n++)i.push(t[n].node);return s.meshInstance=new Fe(e.meshInstance.mesh,e.meshInstance.material,e.meshInstance.node),s.meshInstance._updateAabb=!1,s.meshInstance.parameters=t[0].parameters,s.meshInstance.cull=t[0].cull,s.meshInstance.layer=t[0].layer,e.dynamic&&(s.meshInstance.skinInstance=new jv(this.device,i,this.rootNode)),s.meshInstance.castShadow=e.meshInstance.castShadow,s.meshInstance._shader=e.meshInstance._shader.slice(),s.meshInstance.castShadow=e.meshInstance.castShadow,s}destroyBatch(e){e.destroy(this.scene,this._batchGroups[e.batchGroupId].layers)}}const tS=["uSceneColorMap","texture_grabPass"];class G2 extends Hs{constructor(...e){super(...e),this.colorRenderTarget=null,this.source=null}destroy(){super.destroy(),this.releaseRenderTarget(this.colorRenderTarget)}shouldReallocate(e,t,s){if((e==null?void 0:e.colorBuffer.format)!==s)return!0;const n=(t==null?void 0:t.width)||this.device.width,a=(t==null?void 0:t.height)||this.device.height;return!e||n!==e.width||a!==e.height}allocateRenderTarget(e,t,s,i){const n=s.isWebGL2,a=new _e(s,{name:tS[0],format:i,width:t?t.colorBuffer.width:s.width,height:t?t.colorBuffer.height:s.height,mipmaps:n,minFilter:n?Or:nt,magFilter:nt,addressU:ae,addressV:ae});return e?(e.destroyFrameBuffers(),e._colorBuffer=a,e._colorBuffers=[a]):e=new Ct({name:"ColorGrabRT",colorBuffer:a,depth:!1,stencil:!1,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}frameUpdate(){var e;const t=this.device,s=this.source,i=(e=s==null?void 0:s.colorBuffer.format)!=null?e:this.device.backBufferFormat;this.shouldReallocate(this.colorRenderTarget,s==null?void 0:s.colorBuffer,i)&&(this.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=this.allocateRenderTarget(this.colorRenderTarget,s,t,i));const n=this.colorRenderTarget.colorBuffer;tS.forEach(a=>t.scope.resolve(a).setValue(n))}execute(){const e=this.device,t=this.source,s=this.colorRenderTarget.colorBuffer;if(e.isWebGPU)e.copyRenderTarget(t,this.colorRenderTarget,!0,!1),e.mipmapRenderer.generate(this.colorRenderTarget.colorBuffer.impl);else if(e.isWebGL2)e.copyRenderTarget(t,this.colorRenderTarget,!0,!1),e.activeTexture(e.maxCombinedTextures-1),e.bindTexture(s),e.gl.generateMipmap(s.impl._glTarget);else{s.impl._glTexture||s.impl.initialize(e,s),e.bindTexture(s);const i=e.gl;i.copyTexImage2D(i.TEXTURE_2D,0,s.impl._glFormat,0,0,s.width,s.height,0),s._needsUpload=!1,s._needsMipmapsUpload=!1}}}const sS=["uSceneDepthMap","uDepthMap"];class H2 extends Hs{constructor(e,t){super(e),this.depthRenderTarget=null,this.camera=null,this.camera=t}destroy(){super.destroy(),this.releaseRenderTarget(this.depthRenderTarget)}shouldReallocate(e,t){const s=(t==null?void 0:t.width)||this.device.width,i=(t==null?void 0:t.height)||this.device.height;return!e||s!==e.width||i!==e.height}allocateRenderTarget(e,t,s,i,n){const a=new _e(s,{name:sS[0],format:i,width:t?t.colorBuffer.width:s.width,height:t?t.colorBuffer.height:s.height,mipmaps:!1,minFilter:Ee,magFilter:Ee,addressU:ae,addressV:ae});return e?(e.destroyFrameBuffers(),n?e._depthBuffer=a:(e._colorBuffer=a,e._colorBuffers=[a])):e=new Ct({name:"DepthGrabRT",colorBuffer:n?null:a,depthBuffer:n?a:null,depth:!n,stencil:s.supportsStencil,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}before(){var e,t,s,i;const n=this.camera,a=this.device,o=(e=n==null?void 0:n.renderTarget)!=null?e:a.backBuffer;let l=!0,c=o.stencil?Wa:Ha;a.isWebGPU&&o.samples>1&&(c=Bn,l=!1);const d=(t=(s=n.renderTarget)==null?void 0:s.depthBuffer)!=null?t:(i=n.renderTarget)==null?void 0:i.colorBuffer;this.shouldReallocate(this.depthRenderTarget,d)&&(this.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=this.allocateRenderTarget(this.depthRenderTarget,n.renderTarget,a,c,l));const h=l?this.depthRenderTarget.depthBuffer:this.depthRenderTarget.colorBuffer;sS.forEach(u=>a.scope.resolve(u).setValue(h))}execute(){const e=this.device;if(e.isWebGL2&&e.renderTarget.samples>1){const t=e.renderTarget.impl._glFrameBuffer,s=this.depthRenderTarget;e.renderTarget=s,e.updateBegin(),this.depthRenderTarget.impl.internalResolve(e,t,s.impl._glFrameBuffer,this.depthRenderTarget,e.gl.DEPTH_BUFFER_BIT)}else e.copyRenderTarget(e.renderTarget,this.depthRenderTarget,!1,!0)}}const W2=new k(254/255,254/255,254/255,254/255),Im=[],j2=[[],[],[]],Rm=["uSceneDepthMap","uDepthMap"];class $2 extends Hs{constructor(e,t,s){super(e),this.renderer=t,this.camera=s,this.setupRenderTarget()}destroy(){super.destroy(),this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null)}update(e){this.scene=e}setupRenderTarget(){const e=new _e(this.device,{name:Rm[0],format:xe,width:4,height:4,mipmaps:!1,minFilter:Ee,magFilter:Ee,addressU:ae,addressV:ae}),t=new Ct({name:`${Rm[0]}RT}`,colorBuffer:e,depth:!0,stencil:!1});this.init(t,{}),this.setClearColor(W2),this.setClearDepth(1)}before(){const e=this.device,t=this.renderTarget.colorBuffer;Rm.forEach(s=>e.scope.resolve(s).setValue(t))}execute(){const{device:e,renderer:t,camera:s,scene:i,renderTarget:n}=this,a=i.layers.layerList,o=i.layers.subLayerEnabled,l=i.layers.subLayerList;for(let d=0;d<a.length;d++){const h=a[d];if(h.enabled&&o[d]&&h.camerasSet.has(s)){if(h.id===_s)break;const u=h.getCulledInstances(s),f=l[d]?u.transparent:u.opaque;for(let p=0;p<f.length;p++){var c;const _=f[p];(c=_.material)!=null&&c.depthWrite&&Im.push(_)}t.setCameraUniforms(s,n),t.renderForward(s,Im,j2,Xi,p=>{e.setBlendState(Xe.NOBLEND)},h),Im.length=0}}}}const wo=new y,ph=new y,iS=new y,nS=new q,X2=[new y,new y,new y,new y,new y,new y,new y,new y];class Ed{constructor(){this.shaderPassInfo=null,this.renderPassColorGrab=null,this.renderPassDepthGrab=null,this.renderPasses=[],this.jitter=0,this._aspectRatio=16/9,this._aspectRatioMode=qy,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new k(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[Ws,_s,zy,Kp,Ti],this._layersSet=new Set(this._layers),this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=Gi,this._rect=new P(0,0,1,1),this._renderTarget=null,this._scissorRect=new P(0,0,1,1),this._scissorRectClear=!1,this._aperture=16,this._shutter=1/1e3,this._sensitivity=1e3,this._projMat=new q,this._projMatDirty=!0,this._projMatSkybox=new q,this._viewMat=new q,this._viewMatDirty=!0,this._viewProjMat=new q,this._viewProjMatDirty=!0,this._shaderMatricesVersion=0,this._viewProjInverse=new q,this._viewProjCurrent=null,this._viewProjPrevious=new q,this._jitters=[0,0,0,0],this.frustum=new Jw,this._xr=null,this._xrProperties={horizontalFov:this._horizontalFov,fov:this._fov,aspectRatio:this._aspectRatio,farClip:this._farClip,nearClip:this._nearClip}}destroy(){var e,t;(e=this.renderPassColorGrab)==null||e.destroy(),this.renderPassColorGrab=null,(t=this.renderPassDepthGrab)==null||t.destroy(),this.renderPassDepthGrab=null,this.renderPasses.length=0}_storeShaderMatrices(e,t,s,i){if(this._shaderMatricesVersion!==i){var n,a;this._shaderMatricesVersion=i,this._viewProjPrevious.copy((n=this._viewProjCurrent)!=null?n:e),(a=this._viewProjCurrent)!=null||(this._viewProjCurrent=new q),this._viewProjCurrent.copy(e),this._viewProjInverse.invert(e),this._jitters[2]=this._jitters[0],this._jitters[3]=this._jitters[1],this._jitters[0]=t,this._jitters[1]=s}}get fullSizeClearRect(){const e=this._scissorRectClear?this.scissorRect:this._rect;return e.x===0&&e.y===0&&e.z===1&&e.w===1}set aspectRatio(e){this._aspectRatio!==e&&(this._aspectRatio=e,this._projMatDirty=!0)}get aspectRatio(){var e;return(e=this.xr)!=null&&e.active?this._xrProperties.aspectRatio:this._aspectRatio}set aspectRatioMode(e){this._aspectRatioMode!==e&&(this._aspectRatioMode=e,this._projMatDirty=!0)}get aspectRatioMode(){return this._aspectRatioMode}set calculateProjection(e){this._calculateProjection=e,this._projMatDirty=!0}get calculateProjection(){return this._calculateProjection}set calculateTransform(e){this._calculateTransform=e}get calculateTransform(){return this._calculateTransform}set clearColor(e){this._clearColor.copy(e)}get clearColor(){return this._clearColor}set clearColorBuffer(e){this._clearColorBuffer=e}get clearColorBuffer(){return this._clearColorBuffer}set clearDepth(e){this._clearDepth=e}get clearDepth(){return this._clearDepth}set clearDepthBuffer(e){this._clearDepthBuffer=e}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencil(e){this._clearStencil=e}get clearStencil(){return this._clearStencil}set clearStencilBuffer(e){this._clearStencilBuffer=e}get clearStencilBuffer(){return this._clearStencilBuffer}set cullFaces(e){this._cullFaces=e}get cullFaces(){return this._cullFaces}set farClip(e){this._farClip!==e&&(this._farClip=e,this._projMatDirty=!0)}get farClip(){var e;return(e=this.xr)!=null&&e.active?this._xrProperties.farClip:this._farClip}set flipFaces(e){this._flipFaces=e}get flipFaces(){return this._flipFaces}set fov(e){this._fov!==e&&(this._fov=e,this._projMatDirty=!0)}get fov(){var e;return(e=this.xr)!=null&&e.active?this._xrProperties.fov:this._fov}set frustumCulling(e){this._frustumCulling=e}get frustumCulling(){return this._frustumCulling}set horizontalFov(e){this._horizontalFov!==e&&(this._horizontalFov=e,this._projMatDirty=!0)}get horizontalFov(){var e;return(e=this.xr)!=null&&e.active?this._xrProperties.horizontalFov:this._horizontalFov}set layers(e){this._layers=e.slice(0),this._layersSet=new Set(this._layers)}get layers(){return this._layers}get layersSet(){return this._layersSet}set nearClip(e){this._nearClip!==e&&(this._nearClip=e,this._projMatDirty=!0)}get nearClip(){var e;return(e=this.xr)!=null&&e.active?this._xrProperties.nearClip:this._nearClip}set node(e){this._node=e}get node(){return this._node}set orthoHeight(e){this._orthoHeight!==e&&(this._orthoHeight=e,this._projMatDirty=!0)}get orthoHeight(){return this._orthoHeight}set projection(e){this._projection!==e&&(this._projection=e,this._projMatDirty=!0)}get projection(){return this._projection}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}set rect(e){this._rect.copy(e)}get rect(){return this._rect}set renderTarget(e){this._renderTarget=e}get renderTarget(){return this._renderTarget}set scissorRect(e){this._scissorRect.copy(e)}get scissorRect(){return this._scissorRect}get viewMatrix(){if(this._viewMatDirty){const e=this._node.getWorldTransform();this._viewMat.copy(e).invert(),this._viewMatDirty=!1}return this._viewMat}set aperture(e){this._aperture=e}get aperture(){return this._aperture}set sensitivity(e){this._sensitivity=e}get sensitivity(){return this._sensitivity}set shutter(e){this._shutter=e}get shutter(){return this._shutter}set xr(e){this._xr!==e&&(this._xr=e,this._projMatDirty=!0)}get xr(){return this._xr}clone(){return new Ed().copy(this)}copy(e){return this._aspectRatio=e._aspectRatio,this._farClip=e._farClip,this._fov=e._fov,this._horizontalFov=e._horizontalFov,this._nearClip=e._nearClip,this._xrProperties.aspectRatio=e._xrProperties.aspectRatio,this._xrProperties.farClip=e._xrProperties.farClip,this._xrProperties.fov=e._xrProperties.fov,this._xrProperties.horizontalFov=e._xrProperties.horizontalFov,this._xrProperties.nearClip=e._xrProperties.nearClip,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepth=e.clearDepth,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencil=e.clearStencil,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.flipFaces=e.flipFaces,this.frustumCulling=e.frustumCulling,this.layers=e.layers,this.orthoHeight=e.orthoHeight,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.aperture=e.aperture,this.shutter=e.shutter,this.sensitivity=e.sensitivity,this.shaderPassInfo=e.shaderPassInfo,this.jitter=e.jitter,this._projMatDirty=!0,this}_enableRenderPassColorGrab(e,t){if(t)this.renderPassColorGrab||(this.renderPassColorGrab=new G2(e));else{var s;(s=this.renderPassColorGrab)==null||s.destroy(),this.renderPassColorGrab=null}}_enableRenderPassDepthGrab(e,t,s){if(s)this.renderPassDepthGrab||(this.renderPassDepthGrab=e.isWebGL1?new $2(e,t,this):new H2(e,this));else{var i;(i=this.renderPassDepthGrab)==null||i.destroy(),this.renderPassDepthGrab=null}}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)}worldToScreen(e,t,s,i=new y){this._updateViewProjMat(),this._viewProjMat.transformPoint(e,i);const n=this._viewProjMat.data,a=e.x*n[3]+e.y*n[7]+e.z*n[11]+1*n[15];return i.x=(i.x/a+1)*.5*t,i.y=(1-i.y/a)*.5*s,i}screenToWorld(e,t,s,i,n,a=new y){const o=this.farClip-this.nearClip;if(wo.set(e/i,(n-t)/n,s/o),wo.mulScalar(2),wo.sub(y.ONE),this._projection===Gi){q._getPerspectiveHalfSize(ph,this.fov,this.aspectRatio,this.nearClip,this.horizontalFov),ph.x*=wo.x,ph.y*=wo.y;const l=this._node.getWorldTransform();ph.z=-this.nearClip,l.transformPoint(ph,iS);const c=this._node.getPosition();a.sub2(iS,c),a.normalize(),a.mulScalar(s),a.add(c)}else this._updateViewProjMat(),nS.copy(this._viewProjMat).invert(),nS.transformPoint(wo,a);return a}_evaluateProjectionMatrix(){if(this._projMatDirty){if(this._projection===Gi)this._projMat.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip,this.horizontalFov),this._projMatSkybox.copy(this._projMat);else{const e=this._orthoHeight,t=e*this.aspectRatio;this._projMat.setOrtho(-t,t,-e,e,this.nearClip,this.farClip),this._projMatSkybox.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip)}this._projMatDirty=!1}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}getExposure(){const e=Math.log2(this._aperture*this._aperture/this._shutter*100/this._sensitivity);return 1/(Math.pow(2,e)*1.2)}getScreenSize(e){if(this._projection===Gi){const t=this._node.getPosition().distance(e.center);if(t<e.radius)return 1;const s=Math.asin(e.radius/t),i=Math.tan(s),n=Math.tan(this.fov/2*H.DEG_TO_RAD);return Math.min(i/n,1)}return H.clamp(e.radius/this._orthoHeight,0,1)}getFrustumCorners(e=this.nearClip,t=this.farClip){const s=this.fov*Math.PI/180;let i=this._projection===Gi?Math.tan(s/2)*e:this._orthoHeight,n=i*this.aspectRatio;const a=X2;return a[0].x=n,a[0].y=-i,a[0].z=-e,a[1].x=n,a[1].y=i,a[1].z=-e,a[2].x=-n,a[2].y=i,a[2].z=-e,a[3].x=-n,a[3].y=-i,a[3].z=-e,this._projection===Gi&&(i=Math.tan(s/2)*t,n=i*this.aspectRatio),a[4].x=n,a[4].y=-i,a[4].z=-t,a[5].x=n,a[5].y=i,a[5].z=-t,a[6].x=-n,a[6].y=i,a[6].z=-t,a[7].x=-n,a[7].y=-i,a[7].z=-t,a}setXrProperties(e){Object.assign(this._xrProperties,e),this._projMatDirty=!0}}class Zy{constructor(){this.hasTangents=!1,this.chunks={},this.pass=0,this.alphaTest=!1,this.blendType=ms,this.separateAmbient=!1,this.screenSpace=!1,this.skin=!1,this.useInstancing=!1,this.useMorphPosition=!1,this.useMorphNormal=!1,this.useMorphTextureBased=!1,this.nineSlicedMode=0,this.clusteredLightingEnabled=!0,this.clusteredLightingCookiesEnabled=!1,this.clusteredLightingShadowsEnabled=!1,this.clusteredLightingShadowType=0,this.clusteredLightingAreaLightsEnabled=!1,this.vertexColors=!1,this.lightMapEnabled=!1,this.dirLightMapEnabled=!1,this.useHeights=!1,this.useNormals=!1,this.useClearCoatNormals=!1,this.useAo=!1,this.diffuseMapEnabled=!1,this.useAmbientTint=!1,this.customFragmentShader=null,this.pixelSnap=!1,this.shadingModel=0,this.ambientSH=!1,this.fastTbn=!1,this.twoSidedLighting=!1,this.occludeDirect=!1,this.occludeSpecular=0,this.occludeSpecularFloat=!1,this.useMsdf=!1,this.msdfTextAttribute=!1,this.alphaToCoverage=!1,this.opacityFadesSpecular=!1,this.opacityDither=gs,this.opacityShadowDither=gs,this.cubeMapProjection=0,this.conserveEnergy=!1,this.useSpecular=!1,this.useSpecularityFactor=!1,this.enableGGXSpecular=!1,this.fresnelModel=0,this.useRefraction=!1,this.useClearCoat=!1,this.useSheen=!1,this.useIridescence=!1,this.useMetalness=!1,this.useDynamicRefraction=!1,this.fog=qp,this.gamma=vd,this.toneMap=-1,this.fixSeams=!1,this.reflectionSource=null,this.reflectionEncoding=null,this.reflectionCubemapEncoding=null,this.ambientSource="constant",this.ambientEncoding=null,this.skyboxIntensity=1,this.useCubeMapRotation=!1,this.lightMapWithoutAmbient=!1,this.lights=[],this.noShadow=!1,this.lightMaskDynamic=0,this.userAttributes={}}}class q2{constructor(){this.usedUvs=void 0,this.shaderChunk=void 0,this.litOptions=new Zy}}class vi{static update(e,t,s,i,n,a){vi.updateSharedOptions(e,t,s,i,n),vi.updateMaterialOptions(e,t),vi.updateEnvOptions(e,t,s),vi.updateLightingOptions(e,t,i,a),n===sn&&(e.gamma=Sd,e.toneMap=xd)}static updateSharedOptions(e,t,s,i,n){e.chunks=t.chunks,e.pass=n,e.alphaTest=t.alphaTest>0,e.blendType=t.blendType,e.screenSpace=i&&(i&Mc)!==0,e.skin=i&&(i&Ac)!==0,e.useInstancing=i&&(i&Pc)!==0,e.useMorphPosition=i&&(i&Ic)!==0,e.useMorphNormal=i&&(i&Rc)!==0,e.useMorphTextureBased=i&&(i&Lc)!==0,e.hasTangents=i&&(i&jy)!==0,e.nineSlicedMode=t.nineSlicedMode||Pn,t.useLighting&&s.clusteredLightingEnabled?(e.clusteredLightingEnabled=!0,e.clusteredLightingCookiesEnabled=s.lighting.cookiesEnabled,e.clusteredLightingShadowsEnabled=s.lighting.shadowsEnabled,e.clusteredLightingShadowType=s.lighting.shadowType,e.clusteredLightingAreaLightsEnabled=s.lighting.areaLightsEnabled):(e.clusteredLightingEnabled=!1,e.clusteredLightingCookiesEnabled=!1,e.clusteredLightingShadowsEnabled=!1,e.clusteredLightingAreaLightsEnabled=!1)}static updateMaterialOptions(e,t){e.useAmbientTint=!1,e.separateAmbient=!1,e.customFragmentShader=null,e.pixelSnap=t.pixelSnap,e.shadingModel=t.shadingModel,e.ambientSH=t.ambientSH,e.fastTbn=t.fastTbn,e.twoSidedLighting=t.twoSidedLighting,e.occludeDirect=t.occludeDirect,e.occludeSpecular=t.occludeSpecular,e.occludeSpecularFloat=t.occludeSpecularIntensity!==1,e.useMsdf=!1,e.msdfTextAttribute=!1,e.alphaToCoverage=t.alphaToCoverage,e.opacityFadesSpecular=t.opacityFadesSpecular,e.opacityDither=t.opacityDither,e.opacityShadowDither=t.opacityShadowDither,e.cubeMapProjection=Db,e.conserveEnergy=t.conserveEnergy&&t.shadingModel===yd,e.useSpecular=t.hasSpecular,e.useSpecularityFactor=t.hasSpecularityFactor,e.enableGGXSpecular=t.ggxSpecular,e.fresnelModel=t.fresnelModel,e.useRefraction=t.hasRefraction,e.useClearCoat=t.hasClearCoat,e.useSheen=t.hasSheen,e.useIridescence=t.hasIrridescence,e.useMetalness=t.hasMetalness,e.useDynamicRefraction=t.dynamicRefraction,e.vertexColors=!1,e.lightMapEnabled=t.hasLighting,e.dirLightMapEnabled=t.dirLightMap,e.useHeights=t.hasHeights,e.useNormals=t.hasNormals,e.useClearCoatNormals=t.hasClearCoatNormals,e.useAo=t.hasAo,e.diffuseMapEnabled=t.hasDiffuseMap}static updateEnvOptions(e,t,s){e.fog=t.useFog?s.fog:"none",e.gamma=t.useGammaTonemap?s.gammaCorrection:vd,e.toneMap=t.useGammaTonemap?s.toneMapping:-1,e.fixSeams=!1,t.useSkybox&&s.envAtlas&&s.skybox?(e.reflectionSource="envAtlasHQ",e.reflectionEncoding=s.envAtlas.encoding,e.reflectionCubemapEncoding=s.skybox.encoding):t.useSkybox&&s.envAtlas?(e.reflectionSource="envAtlas",e.reflectionEncoding=s.envAtlas.encoding):t.useSkybox&&s.skybox?(e.reflectionSource="cubeMap",e.reflectionEncoding=s.skybox.encoding):(e.reflectionSource=null,e.reflectionEncoding=null),t.ambientSH?(e.ambientSource="ambientSH",e.ambientEncoding=null):e.reflectionSource&&s.envAtlas?(e.ambientSource="envAtlas",e.ambientEncoding=s.envAtlas.encoding):(e.ambientSource="constant",e.ambientEncoding=null);const i=!!e.reflectionSource;e.skyboxIntensity=i&&(s.skyboxIntensity!==1||s.physicalUnits),e.useCubeMapRotation=i&&s._skyboxRotationShaderInclude}static updateLightingOptions(e,t,s,i){if(e.lightMapWithoutAmbient=!1,t.useLighting){const n=[],a=s?s>>16:Fs;e.lightMaskDynamic=!!(a&Fs),e.lightMapWithoutAmbient=!1,i&&(vi.collectLights(fe,i[fe],n,a),vi.collectLights(Oe,i[Oe],n,a),vi.collectLights(Ge,i[Ge],n,a)),e.lights=n}else e.lights=[];(e.lights.length===0||s&of)&&(e.noShadow=!0)}static collectLights(e,t,s,i){for(let n=0;n<t.length;n++){const a=t[n];a.enabled&&a.mask&i&&s.push(a)}}}class Er{constructor(){this.code=""}append(...e){e.forEach(t=>{t.endsWith(`
`)?this.code+=t:this.code+=t+`
`})}prepend(...e){e.forEach(t=>{t.endsWith(`
`)?this.code=t+this.code:this.code=t+`
`+this.code})}}const K2={linear:"decodeLinear",srgb:"decodeGamma",rgbm:"decodeRGBM",rgbe:"decodeRGBE",rgbp:"decodeRGBP"},Y2={linear:"encodeLinear",srgb:"encodeGamma",rgbm:"encodeRGBM",rgbe:"encodeRGBE",rgbp:"encodeRGBP"};class xi{static decodeFunc(e){return K2[e]||"decodeGamma"}static encodeFunc(e){return Y2[e]||"encodeGamma"}}const rS=new q,aS=new q,oS=new q;class Ei{static create(e,t,s){const i=new Ed;switch(i.node=new ze(e),i.aspectRatio=1,i.aspectRatioMode=og,i._scissorRectClear=!0,t){case Oe:i.node.setRotation(Ei.pointLightRotations[s]),i.fov=90,i.projection=Gi;break;case Ge:i.projection=Gi;break;case fe:i.projection=Ua;break}return i}static evalSpotCookieMatrix(e){let t=Ei._spotCookieCamera;t||(t=Ei.create("SpotCookieCamera",Ge),Ei._spotCookieCamera=t),t.fov=e._outerConeAngle*2;const s=t._node;s.setPosition(e._node.getPosition()),s.setRotation(e._node.getRotation()),s.rotateLocal(-90,0,0),rS.setTRS(s.getPosition(),s.getRotation(),y.ONE).invert(),aS.mul2(t.projectionMatrix,rS);const i=e.cookieMatrix,n=e.atlasViewport;return oS.setViewport(n.x,n.y,n.z,n.w),i.mul2(oS,aS),i}}Ei.pointLightRotations=[new re().setFromEulerAngles(0,90,180),new re().setFromEulerAngles(0,-90,180),new re().setFromEulerAngles(90,0,0),new re().setFromEulerAngles(-90,0,0),new re().setFromEulerAngles(0,180,180),new re().setFromEulerAngles(0,0,180)];Ei._spotCookieCamera=null;const mh=1e-6,Nt=new y,Kr=new Float32Array(6),Z2=new y(-.5,0,0),J2=new y(0,0,.5),ws={FLAGS:0,COLOR_A:1,COLOR_B:2,SPOT_ANGLES:3,SHADOW_BIAS:4,COOKIE_A:5,COOKIE_B:6,COUNT_ALWAYS:7,POSITION_X:7,POSITION_Y:8,POSITION_Z:9,RANGE:10,SPOT_DIRECTION_X:11,SPOT_DIRECTION_Y:12,SPOT_DIRECTION_Z:13,PROJ_MAT_00:14,ATLAS_VIEWPORT_A:14,PROJ_MAT_01:15,ATLAS_VIEWPORT_B:15,PROJ_MAT_02:16,PROJ_MAT_03:17,PROJ_MAT_10:18,PROJ_MAT_11:19,PROJ_MAT_12:20,PROJ_MAT_13:21,PROJ_MAT_20:22,PROJ_MAT_21:23,PROJ_MAT_22:24,PROJ_MAT_23:25,PROJ_MAT_30:26,PROJ_MAT_31:27,PROJ_MAT_32:28,PROJ_MAT_33:29,AREA_DATA_WIDTH_X:30,AREA_DATA_WIDTH_Y:31,AREA_DATA_WIDTH_Z:32,AREA_DATA_HEIGHT_X:33,AREA_DATA_HEIGHT_Y:34,AREA_DATA_HEIGHT_Z:35,COUNT:36},Pt={POSITION_RANGE:0,SPOT_DIRECTION:1,PROJ_MAT_0:2,ATLAS_VIEWPORT:2,PROJ_MAT_1:3,PROJ_MAT_2:4,PROJ_MAT_3:5,AREA_DATA_WIDTH:6,AREA_DATA_HEIGHT:7,COUNT:8},_h=0,Q2=1,eO=new di;class Dc{static getLightTextureFormat(e){return e.extTextureFloat&&e.maxTextures>8?_h:Q2}static getShaderDefines(e){return eO.get(e,()=>{const t=(a,o,l,c)=>Object.keys(o).map(d=>`#define ${l}${d} ${o[d]}${c}`).join(`
`),i=Dc.getLightTextureFormat(e)===_h?"FLOAT":"8BIT",n=e.supportsTextureFetch?"":".5";return`
								
#define CLUSTER_TEXTURE_${i}
								${t(e,ws,"CLUSTER_TEXTURE_8_",n)}
								${t(e,Pt,"CLUSTER_TEXTURE_F_",n)}
						`})}constructor(e){this.device=e,this.cookiesEnabled=!1,this.shadowsEnabled=!1,this.areaLightsEnabled=!1,this.maxLights=255;let t=ws.COUNT_ALWAYS,s=0;this.lightTextureFormat=Dc.getLightTextureFormat(e),this.lightTextureFormat===_h?s=Pt.COUNT:t=ws.COUNT,this.lights8=new Uint8ClampedArray(4*t*this.maxLights),this.lightsTexture8=this.createTexture(this.device,t,this.maxLights,xe,"LightsTexture8"),this._lightsTexture8Id=this.device.scope.resolve("lightsTexture8"),s?(this.lightsFloat=new Float32Array(4*s*this.maxLights),this.lightsTextureFloat=this.createTexture(this.device,s,this.maxLights,rt,"LightsTextureFloat"),this._lightsTextureFloatId=this.device.scope.resolve("lightsTextureFloat")):(this.lightsFloat=null,this.lightsTextureFloat=null,this._lightsTextureFloatId=void 0),this._lightsTextureInvSizeId=this.device.scope.resolve("lightsTextureInvSize"),this._lightsTextureInvSizeData=new Float32Array(4),this._lightsTextureInvSizeData[0]=s?1/this.lightsTextureFloat.width:0,this._lightsTextureInvSizeData[1]=s?1/this.lightsTextureFloat.height:0,this._lightsTextureInvSizeData[2]=1/this.lightsTexture8.width,this._lightsTextureInvSizeData[3]=1/this.lightsTexture8.height,this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new y,this.boundsDelta=new y}destroy(){this.lightsTexture8&&(this.lightsTexture8.destroy(),this.lightsTexture8=null),this.lightsTextureFloat&&(this.lightsTextureFloat.destroy(),this.lightsTextureFloat=null)}createTexture(e,t,s,i,n){return new _e(e,{name:n,width:t,height:s,mipmaps:!1,format:i,addressU:ae,addressV:ae,type:ps,magFilter:Ee,minFilter:Ee,anisotropy:1})}setCompressionRanges(e,t){this.invMaxColorValue=1/t,this.invMaxAttenuation=1/e}setBounds(e,t){this.boundsMin.copy(e),this.boundsDelta.copy(t)}uploadTextures(){this.lightsTextureFloat&&(this.lightsTextureFloat.lock().set(this.lightsFloat),this.lightsTextureFloat.unlock()),this.lightsTexture8.lock().set(this.lights8),this.lightsTexture8.unlock()}updateUniforms(){this._lightsTexture8Id.setValue(this.lightsTexture8),this.lightTextureFormat===_h&&this._lightsTextureFloatId.setValue(this.lightsTextureFloat),this._lightsTextureInvSizeId.setValue(this._lightsTextureInvSizeData)}getSpotDirection(e,t){t._node.getWorldTransform().getY(e).mulScalar(-1),e.normalize()}getLightAreaSizes(e){const t=e._node.getWorldTransform();return t.transformVector(Z2,Nt),Kr[0]=Nt.x,Kr[1]=Nt.y,Kr[2]=Nt.z,t.transformVector(J2,Nt),Kr[3]=Nt.x,Kr[4]=Nt.y,Kr[5]=Nt.z,Kr}addLightDataFlags(e,t,s,i,n,a){e[t+0]=i?255:0,e[t+1]=s._shape*64,e[t+2]=s._falloffMode*255,e[t+3]=n?a*255:0}addLightDataColor(e,t,s,i,n){const a=this.invMaxColorValue,o=i?s._linearFinalColor:s._finalColor;Ke.float2Bytes(o[0]*a,e,t+0,2),Ke.float2Bytes(o[1]*a,e,t+2,2),Ke.float2Bytes(o[2]*a,e,t+4,2),e[t+6]=n?255:0;const l=!!(s.mask&Fs),c=!!(s.mask&ji);e[t+7]=l&&c?127:c?255:0}addLightDataSpotAngles(e,t,s){Ke.float2Bytes(s._innerConeAngleCos*(.5-mh)+.5,e,t+0,2),Ke.float2Bytes(s._outerConeAngleCos*(.5-mh)+.5,e,t+2,2)}addLightDataShadowBias(e,t,s){const i=s.getRenderData(null,0),n=s._getUniformBiasValues(i);Ke.float2BytesRange(n.bias,e,t,-1,20,2),Ke.float2Bytes(n.normalBias,e,t+2,2)}addLightDataPositionRange(e,t,s,i){const n=Nt.sub2(i,this.boundsMin).div(this.boundsDelta);Ke.float2Bytes(n.x,e,t+0,4),Ke.float2Bytes(n.y,e,t+4,4),Ke.float2Bytes(n.z,e,t+8,4),Ke.float2Bytes(s.attenuationEnd*this.invMaxAttenuation,e,t+12,4)}addLightDataSpotDirection(e,t,s){this.getSpotDirection(Nt,s),Ke.float2Bytes(Nt.x*(.5-mh)+.5,e,t+0,4),Ke.float2Bytes(Nt.y*(.5-mh)+.5,e,t+4,4),Ke.float2Bytes(Nt.z*(.5-mh)+.5,e,t+8,4)}addLightDataLightProjMatrix(e,t,s){const i=s.data;for(let n=0;n<12;n++)Ke.float2BytesRange(i[n],e,t+4*n,-2,2,4);for(let n=12;n<16;n++)Ke.float2MantissaExponent(i[n],e,t+4*n,4)}addLightDataCookies(e,t,s){const i=s._cookieChannel==="rgb";if(e[t+0]=Math.floor(s.cookieIntensity*255),e[t+1]=i?255:0,!i){const n=s._cookieChannel;e[t+4]=n==="rrr"?255:0,e[t+5]=n==="ggg"?255:0,e[t+6]=n==="bbb"?255:0,e[t+7]=n==="aaa"?255:0}}addLightAtlasViewport(e,t,s){Ke.float2Bytes(s.x,e,t+0,2),Ke.float2Bytes(s.y,e,t+2,2),Ke.float2Bytes(s.z/3,e,t+4,2)}addLightAreaSizes(e,t,s){const i=this.getLightAreaSizes(s);for(let n=0;n<6;n++)Ke.float2MantissaExponent(i[n],e,t+4*n,4)}addLightData(e,t,s){const i=e._type===Ge,n=e.atlasViewportAllocated,a=this.cookiesEnabled&&!!e._cookie&&n,o=this.areaLightsEnabled&&e.shape!==Ut,l=this.shadowsEnabled&&e.castShadows&&n,c=e._node.getPosition();let d=null,h=null;i?l?d=e.getRenderData(null,0).shadowMatrix:a&&(d=Ei.evalSpotCookieMatrix(e)):(l||a)&&(h=e.atlasViewport);const u=this.lights8,f=t*this.lightsTexture8.width*4;if(this.addLightDataFlags(u,f+4*ws.FLAGS,e,i,l,e.shadowIntensity),this.addLightDataColor(u,f+4*ws.COLOR_A,e,s,a),i&&this.addLightDataSpotAngles(u,f+4*ws.SPOT_ANGLES,e),e.castShadows&&this.addLightDataShadowBias(u,f+4*ws.SHADOW_BIAS,e),a&&this.addLightDataCookies(u,f+4*ws.COOKIE_A,e),this.lightTextureFormat===_h){const p=this.lightsFloat,_=t*this.lightsTextureFloat.width*4;if(p[_+4*Pt.POSITION_RANGE+0]=c.x,p[_+4*Pt.POSITION_RANGE+1]=c.y,p[_+4*Pt.POSITION_RANGE+2]=c.z,p[_+4*Pt.POSITION_RANGE+3]=e.attenuationEnd,i&&(this.getSpotDirection(Nt,e),p[_+4*Pt.SPOT_DIRECTION+0]=Nt.x,p[_+4*Pt.SPOT_DIRECTION+1]=Nt.y,p[_+4*Pt.SPOT_DIRECTION+2]=Nt.z),d){const m=d.data;for(let g=0;g<16;g++)p[_+4*Pt.PROJ_MAT_0+g]=m[g]}if(h&&(p[_+4*Pt.ATLAS_VIEWPORT+0]=h.x,p[_+4*Pt.ATLAS_VIEWPORT+1]=h.y,p[_+4*Pt.ATLAS_VIEWPORT+2]=h.z/3),o){const m=this.getLightAreaSizes(e);p[_+4*Pt.AREA_DATA_WIDTH+0]=m[0],p[_+4*Pt.AREA_DATA_WIDTH+1]=m[1],p[_+4*Pt.AREA_DATA_WIDTH+2]=m[2],p[_+4*Pt.AREA_DATA_HEIGHT+0]=m[3],p[_+4*Pt.AREA_DATA_HEIGHT+1]=m[4],p[_+4*Pt.AREA_DATA_HEIGHT+2]=m[5]}}else this.addLightDataPositionRange(u,f+4*ws.POSITION_X,e,c),i&&this.addLightDataSpotDirection(u,f+4*ws.SPOT_DIRECTION_X,e),d&&this.addLightDataLightProjMatrix(u,f+4*ws.PROJ_MAT_00,d),h&&this.addLightAtlasViewport(u,f+4*ws.ATLAS_VIEWPORT_A,h),o&&this.addLightAreaSizes(u,f+4*ws.AREA_DATA_WIDTH_X,e)}}const Lm={vertex_normal:Us,vertex_tangent:ln,vertex_texCoord0:zs,vertex_texCoord1:Hr,vertex_color:Zt,vertex_boneWeights:hn,vertex_boneIndices:Os},lS={vVertexColor:"vec4",vPositionW:"vec3",vNormalV:"vec3",vNormalW:"vec3",vTangentW:"vec3",vBinormalW:"vec3",vObjectSpaceUpW:"vec3",vUv0:"vec2",vUv1:"vec2"};class tO{constructor(e,t){if(this.device=e,this.options=t,this.attributes={vertex_position:ht},t.userAttributes)for(const[s,i]of Object.entries(t.userAttributes))this.attributes[i]=s;if(t.chunks){const s=t.chunks;this.chunks=Object.create(W);for(const i in W)if(s.hasOwnProperty(i)){const n=s[i];for(const a in Lm)Lm.hasOwnProperty(a)&&n.indexOf(a)>=0&&(this.attributes[a]=Lm[a]);this.chunks[i]=n}}else this.chunks=W;this.shaderPassInfo=Ii.get(this.device).getByIndex(t.pass),this.shadowPass=this.shaderPassInfo.isShadow,this.lighting=t.lights.length>0||t.dirLightMapEnabled||t.clusteredLightingEnabled,this.reflections=!!t.reflectionSource,this.needsNormal=this.lighting||this.reflections||t.useSpecular||t.ambientSH||t.useHeights||t.enableGGXSpecular||t.clusteredLightingEnabled&&!this.shadowPass||t.useClearCoatNormals,this.needsNormal=this.needsNormal&&!this.shadowPass,this.needsSceneColor=t.useDynamicRefraction,this.needsScreenSize=t.useDynamicRefraction,this.needsTransforms=t.useDynamicRefraction,this.varyings="",this.varyingDefines="",this.vshader=null,this.frontendDecl=null,this.frontendCode=null,this.frontendFunc=null,this.lightingUv=null,this.defines=[],this.fshader=null}_vsAddBaseCode(e,t,s){return e+=t.baseVS,(s.nineSlicedMode===wt||s.nineSlicedMode===mt)&&(e+=t.baseNineSlicedVS),e}_vsAddTransformCode(e,t,s,i){return e+=this.chunks.transformVS,e}_setMapTransform(e,t,s,i){const n=s+i*100;if(!e[3][n]){const a=`texture_${t}MapTransform`;e[0]+=`uniform vec3 ${a}0;
`,e[0]+=`uniform vec3 ${a}1;
`,e[1]+=`varying vec2 vUV${i}_${s};
`,e[2]+=`   vUV${i}_${s} = vec2(dot(vec3(uv${i}, 1), ${a}0), dot(vec3(uv${i}, 1), ${a}1));
`,e[3][n]=!0}return e}_fsGetBaseCode(){const e=this.options,t=this.chunks;let s=this.chunks.basePS;return e.nineSlicedMode===wt?s+=t.baseNineSlicedPS:e.nineSlicedMode===mt&&(s+=t.baseNineSlicedTiledPS),s}_fsGetStartCode(e,t,s,i){let n=s.startPS;return i.nineSlicedMode===wt?n+=s.startNineSlicedPS:i.nineSlicedMode===mt&&(n+=s.startNineSlicedTiledPS),n}_getLightSourceShapeString(e){switch(e){case cI:return"Rect";case dI:return"Disk";case uI:return"Sphere";default:return""}}generateVertexShader(e,t,s){const i=this.device,n=this.options,a=this.chunks;let o="",l="";o=this._vsAddBaseCode(o,a,n),l+=`   vPositionW    = getWorldPosition();
`,this.options.pass===Xi&&(o+=`varying float vDepth;
`,o+=`#ifndef VIEWMATRIX
`,o+=`#define VIEWMATRIX
`,o+=`uniform mat4 matrix_view;
`,o+=`#endif
`,o+=`#ifndef CAMERAPLANES
`,o+=`#define CAMERAPLANES
`,o+=`uniform vec4 camera_params;

`,o+=`#endif
`,l+=`    vDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;
`),this.options.pass,this.options.useInstancing&&(this.attributes.instance_line1=qh,this.attributes.instance_line2=Da,this.attributes.instance_line3=Kh,this.attributes.instance_line4=Ea,o+=a.instancingVS),this.needsNormal&&(this.attributes.vertex_normal=Us,l+=`   vNormalW = getNormal();
`,n.reflectionSource==="sphereMap"&&i.fragmentUniformsCount<=16&&(o+=a.viewNormalVS,l+=`   vNormalV    = getViewNormal();
`),n.hasTangents&&(n.useHeights||n.useNormals||n.enableGGXSpecular)?(this.attributes.vertex_tangent=ln,o+=a.tangentBinormalVS,l+=`   vTangentW   = getTangent();
`,l+=`   vBinormalW  = getBinormal();
`):(n.enableGGXSpecular||!i.extStandardDerivatives)&&(l+=`   vObjectSpaceUpW = normalize(dNormalMatrix * vec3(0, 1, 0));
`));const c=2;for(let u=0;u<c;u++)e[u]&&(this.attributes["vertex_texCoord"+u]="TEXCOORD"+u,o+=a["uv"+u+"VS"],l+="   vec2 uv"+u+" = getUv"+u+`();
`),t[u]&&(l+="   vUv"+u+" = uv"+u+`;
`);const d=[o,this.varyings,l,[]];if(s.forEach(u=>{this._setMapTransform(d,u.name,u.id,u.uv)}),o=d[0],this.varyings=d[1],l=d[2],n.vertexColors&&(this.attributes.vertex_color=Zt,l+=`   vVertexColor = vertex_color;
`),n.useMsdf&&n.msdfTextAttribute&&(this.attributes.vertex_outlineParameters=Ra,this.attributes.vertex_shadowParameters=La,l+=`    unpackMsdfParams();
`,o+=a.msdfVS),n.useMorphPosition||n.useMorphNormal)if(n.useMorphTextureBased){o+=`#define MORPHING_TEXTURE_BASED
`,n.useMorphPosition&&(o+=`#define MORPHING_TEXTURE_BASED_POSITION
`),n.useMorphNormal&&(o+=`#define MORPHING_TEXTURE_BASED_NORMAL
`),this.attributes.morph_vertex_id=Ea;const u=i.isWebGPU?"uint":"float";o+=`attribute ${u} morph_vertex_id;
`}else o+=`#define MORPHING
`,n.useMorphPosition?(this.attributes.morph_pos0=Ra,this.attributes.morph_pos1=La,this.attributes.morph_pos2=$_,this.attributes.morph_pos3=X_,o+=`#define MORPHING_POS03
`,o+=`attribute vec3 morph_pos0;
`,o+=`attribute vec3 morph_pos1;
`,o+=`attribute vec3 morph_pos2;
`,o+=`attribute vec3 morph_pos3;
`):n.useMorphNormal&&(this.attributes.morph_nrm0=Ra,this.attributes.morph_nrm1=La,this.attributes.morph_nrm2=$_,this.attributes.morph_nrm3=X_,o+=`#define MORPHING_NRM03
`,o+=`attribute vec3 morph_nrm0;
`,o+=`attribute vec3 morph_nrm1;
`,o+=`attribute vec3 morph_nrm2;
`,o+=`attribute vec3 morph_nrm3;
`),n.useMorphNormal?(this.attributes.morph_nrm4=qh,this.attributes.morph_nrm5=Da,this.attributes.morph_nrm6=Kh,this.attributes.morph_nrm7=Ea,o+=`#define MORPHING_NRM47
`,o+=`attribute vec3 morph_nrm4;
`,o+=`attribute vec3 morph_nrm5;
`,o+=`attribute vec3 morph_nrm6;
`,o+=`attribute vec3 morph_nrm7;
`):(this.attributes.morph_pos4=qh,this.attributes.morph_pos5=Da,this.attributes.morph_pos6=Kh,this.attributes.morph_pos7=Ea,o+=`#define MORPHING_POS47
`,o+=`attribute vec3 morph_pos4;
`,o+=`attribute vec3 morph_pos5;
`,o+=`attribute vec3 morph_pos6;
`,o+=`attribute vec3 morph_pos7;
`);n.skin?(this.attributes.vertex_boneWeights=hn,this.attributes.vertex_boneIndices=Os,o+=Be.skinCode(i,a),o+=`#define SKIN
`):n.useInstancing&&(o+=`#define INSTANCING
`),n.screenSpace&&(o+=`#define SCREENSPACE
`),n.pixelSnap&&(o+=`#define PIXELSNAP
`),o=this._vsAddTransformCode(o,i,a,n),this.needsNormal&&(o+=a.normalVS),o+=`
`,o+=a.startVS,o+=l,o+=a.endVS,o+="}",Object.keys(lS).forEach(u=>{o.indexOf(u)>=0&&(this.varyings+=`varying ${lS[u]} ${u};
`,this.varyingDefines+=`#define VARYING_${u.toUpperCase()}
`)});const h=this.shaderPassInfo.shaderDefines;this.vshader=h+this.varyings+o}_fsGetBeginCode(){let e=this.shaderPassInfo.shaderDefines;for(let t=0;t<this.defines.length;t++)e+=`#define ${this.defines[t]}
`;return e}_fsGetPickPassCode(){let e=this._fsGetBeginCode();return e+=`uniform vec4 uColor;
`,e+=this.varyings,e+=this.varyingDefines,e+=this.frontendDecl,e+=this.frontendCode,e+=Be.begin(),e+=this.frontendFunc,e+=`    gl_FragColor = uColor;
`,e+=Be.end(),e}_fsGetDepthPassCode(){const e=this.chunks;let t=this._fsGetBeginCode();return t+=`varying float vDepth;
`,t+=this.varyings,t+=this.varyingDefines,t+=e.packDepthPS,t+=this.frontendDecl,t+=this.frontendCode,t+=Be.begin(),t+=this.frontendFunc,t+=`    gl_FragColor = packFloat(vDepth);
`,t+=Be.end(),t}_fsGetPrePassVelocityCode(){return`
						void main(void)
						{
								gl_FragColor = vec4(1, 0, 0, 1);
						}
						`}_fsGetShadowPassCode(){const e=this.device,t=this.options,s=this.chunks,i=this.varyings,n=this.shaderPassInfo.lightType;let a=this.shaderPassInfo.shadowType;n!==fe&&t.clusteredLightingEnabled&&(a===ei||a===Si||a===si||a===ss)&&(a=xt);let o=this._fsGetBeginCode();e.extStandardDerivatives&&e.isWebGL1&&(o+=`uniform vec2 polygonOffset;
`),a===si?e.textureFloatHighPrecision?o+=`#define VSM_EXPONENT 15.0

`:o+=`#define VSM_EXPONENT 5.54

`:a===Si&&(o+=`#define VSM_EXPONENT 5.54

`),n!==fe&&(o+=`uniform vec3 view_position;
`,o+=`uniform float light_radius;
`),o+=i,o+=this.varyingDefines,o+=this.frontendDecl,o+=this.frontendCode;const l=a===Wi||a===xt||a===wi||a===ss,c=n===Oe&&a!==ss&&!t.clusteredLightingEnabled,d=l&&!e.supportsDepthShadow||c;d?o+=s.packDepthPS:a===ei&&(o+=`vec2 encodeFloatRG( float v ) {
`,o+=`    vec2 enc = vec2(1.0, 255.0) * v;
`,o+=`    enc = fract(enc);
`,o+=`    enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);
`,o+=`    return enc;
`,o+=`}

`),a===ss&&(o+=W.linearizeDepthPS),o+=Be.begin(),o+=this.frontendFunc;const h=a===ei||a===Si||a===si,u=e.isWebGL1&&e.extStandardDerivatives,f=n===fe||!h&&n===Ge;let p=!1;return f?o+=`    float depth = gl_FragCoord.z;
`:(o+=`    float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);
`,p=!0),u&&(o+=`    float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);
`,o+=`    depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;
`,p=!0),d?o+=`    gl_FragColor = packFloat(depth);
`:h?a===ei?o+=`    gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));
`:o+=s.storeEVSMPS:a===ss?o+=`    gl_FragColor.r = depth;
`:(p&&(o+=`    gl_FragDepth = depth;
`),o+=`    gl_FragColor = vec4(1.0);
`),o+=Be.end(),o}_fsGetLitPassCode(){const e=this.device,t=this.options,s=this.chunks,i=new Er,n=new Er,a=new Er,o=new Er;t.opacityFadesSpecular===!1&&i.append("uniform float material_alphaFade;"),t.useSpecular&&(this.defines.push("LIT_SPECULAR"),this.reflections&&this.defines.push("LIT_REFLECTIONS"),t.useClearCoat&&this.defines.push("LIT_CLEARCOAT"),t.fresnelModel>0&&this.defines.push("LIT_SPECULAR_FRESNEL"),t.conserveEnergy&&this.defines.push("LIT_CONSERVE_ENERGY"),t.useSheen&&this.defines.push("LIT_SHEEN"),t.useIridescence&&this.defines.push("LIT_IRIDESCENCE"));const l=[];let c=0,d=!1,h=!1,u=!1,f=t.lights.some(function(I){return I._shape&&I._shape!==Ut});t.clusteredLightingEnabled&&t.clusteredLightingAreaLightsEnabled&&(f=!0);let p="highp";e.areaLightLutFormat===xe&&(i.append("#define AREA_R8_G8_B8_A8_LUTS"),p="lowp"),(f||t.clusteredLightingEnabled)&&(i.append("#define AREA_LIGHTS"),i.append(`uniform ${p} sampler2D areaLightsLutTex1;`),i.append(`uniform ${p} sampler2D areaLightsLutTex2;`));for(let I=0;I<t.lights.length;I++){const F=t.lights[I],D=F._type;if(t.clusteredLightingEnabled&&D!==fe)continue;const A=f&&F._shape?F._shape:Ut;i.append("uniform vec3 light"+I+"_color;"),F._shadowType===ss&&F.castShadows&&!t.noShadow&&(i.append(`uniform float light${I}_shadowSearchArea;`),i.append(`uniform vec4 light${I}_cameraParams;`)),D===fe?i.append("uniform vec3 light"+I+"_direction;"):(i.append("uniform vec3 light"+I+"_position;"),i.append("uniform float light"+I+"_radius;"),D===Ge&&(i.append("uniform vec3 light"+I+"_direction;"),i.append("uniform float light"+I+"_innerConeAngle;"),i.append("uniform float light"+I+"_outerConeAngle;"))),A!==Ut&&(D===fe&&i.append("uniform vec3 light"+I+"_position;"),i.append("uniform vec3 light"+I+"_halfWidth;"),i.append("uniform vec3 light"+I+"_halfHeight;")),F.castShadows&&!t.noShadow&&(i.append("uniform mat4 light"+I+"_shadowMatrix;"),i.append("uniform float light"+I+"_shadowIntensity;"),D===fe&&(i.append("uniform mat4 light"+I+"_shadowMatrixPalette[4];"),i.append("uniform float light"+I+"_shadowCascadeDistances[4];"),i.append("uniform float light"+I+"_shadowCascadeCount;")),i.append("uniform vec4 light"+I+"_shadowParams;"),D===fe&&(d=!0),D===Oe?i.append("uniform samplerCube light"+I+"_shadowMap;"):F._isPcf&&e.supportsDepthShadow?i.append("uniform sampler2DShadow light"+I+"_shadowMap;"):i.append("uniform sampler2D light"+I+"_shadowMap;"),c++,l[F._shadowType]=!0,F._isVsm&&(h=!0),F._shadowType===ss&&(u=!0)),F._cookie&&(F._cookie._cubemap?D===Oe&&(i.append("uniform samplerCube light"+I+"_cookie;"),i.append("uniform float light"+I+"_cookieIntensity;"),(!F.castShadows||t.noShadow)&&i.append("uniform mat4 light"+I+"_shadowMatrix;")):D===Ge&&(i.append("uniform sampler2D light"+I+"_cookie;"),i.append("uniform float light"+I+"_cookieIntensity;"),(!F.castShadows||t.noShadow)&&i.append("uniform mat4 light"+I+"_shadowMatrix;"),F._cookieTransform&&(i.append("uniform vec4 light"+I+"_cookieMatrix;"),i.append("uniform vec2 light"+I+"_cookieOffset;"))))}const _=this.needsNormal&&(t.useNormals||t.useClearCoatNormals||t.enableGGXSpecular&&!t.useHeights);if(_&&(t.hasTangents?n.append(t.fastTbn?s.TBNfastPS:s.TBNPS):e.extStandardDerivatives&&(t.useNormals||t.useClearCoatNormals)?n.append(s.TBNderivativePS.replace(/\$UV/g,this.lightingUv)):n.append(s.TBNObjectSpacePS)),n.append(s.sphericalPS),n.append(s.decodePS),n.append(Be.gammaCode(t.gamma,s)),n.append(Be.tonemapCode(t.toneMap,s)),n.append(Be.fogCode(t.fog,s)),n.append(this.frontendCode),t.useCubeMapRotation&&i.append("#define CUBEMAP_ROTATION"),this.needsNormal&&(n.append(s.cubeMapRotatePS),n.append(t.cubeMapProjection>0?s.cubeMapProjectBoxPS:s.cubeMapProjectNonePS),n.append(t.skyboxIntensity?s.envMultiplyPS:s.envConstPS)),(this.lighting&&t.useSpecular||this.reflections)&&(t.useMetalness&&n.append(s.metalnessModulatePS),t.fresnelModel===Uy&&n.append(s.fresnelSchlickPS),t.useIridescence&&n.append(s.iridescenceDiffractionPS)),t.useAo)switch(n.append(s.aoDiffuseOccPS),t.occludeSpecular){case Cc:n.append(t.occludeSpecularFloat?s.aoSpecOccSimplePS:s.aoSpecOccConstSimplePS);break;case rg:n.append(t.occludeSpecularFloat?s.aoSpecOccPS:s.aoSpecOccConstPS);break}t.reflectionSource==="envAtlasHQ"?(n.append(t.fixSeams?s.fixCubemapSeamsStretchPS:s.fixCubemapSeamsNonePS),n.append(s.envAtlasPS),n.append(s.reflectionEnvHQPS.replace(/\$DECODE_CUBEMAP/g,xi.decodeFunc(t.reflectionCubemapEncoding)).replace(/\$DECODE/g,xi.decodeFunc(t.reflectionEncoding)))):t.reflectionSource==="envAtlas"?(n.append(s.envAtlasPS),n.append(s.reflectionEnvPS.replace(/\$DECODE/g,xi.decodeFunc(t.reflectionEncoding)))):t.reflectionSource==="cubeMap"?(n.append(t.fixSeams?s.fixCubemapSeamsStretchPS:s.fixCubemapSeamsNonePS),n.append(s.reflectionCubePS.replace(/\$DECODE/g,xi.decodeFunc(t.reflectionEncoding)))):t.reflectionSource==="sphereMap"&&n.append(s.reflectionSpherePS.replace(/\$DECODE/g,xi.decodeFunc(t.reflectionEncoding))),this.reflections&&(t.useClearCoat&&n.append(s.reflectionCCPS),t.useSheen&&n.append(s.reflectionSheenPS)),t.useRefraction&&(t.useDynamicRefraction?n.append(s.refractionDynamicPS):this.reflections&&n.append(s.refractionCubePS)),t.useSheen&&n.append(s.lightSheenPS),t.clusteredLightingEnabled&&(n.append(s.clusteredLightUtilsPS),t.clusteredLightingCookiesEnabled&&n.append(s.clusteredLightCookiesPS),t.clusteredLightingShadowsEnabled&&!t.noShadow&&(l[xt]=!0,l[wi]=!0,l[ss]=!0)),(c>0||t.clusteredLightingEnabled)&&(d&&n.append(s.shadowCascadesPS),(l[Wi]||l[xt])&&n.append(s.shadowStandardPS),l[wi]&&!e.isWebGL1&&n.append(s.shadowStandardGL2PS),h&&(n.append(s.shadowVSM_commonPS),l[ei]&&n.append(s.shadowVSM8PS),l[Si]&&n.append(e.extTextureHalfFloatLinear?s.shadowEVSMPS.replace(/\$/g,"16"):s.shadowEVSMnPS.replace(/\$/g,"16")),l[si]&&n.append(e.extTextureFloatLinear?s.shadowEVSMPS.replace(/\$/g,"32"):s.shadowEVSMnPS.replace(/\$/g,"32"))),u&&(n.append(s.linearizeDepthPS),n.append(s.shadowPCSSPS)),e.isWebGL2||e.isWebGPU||e.extStandardDerivatives||n.append(s.biasConstPS)),t.enableGGXSpecular&&n.append("uniform float material_anisotropy;"),this.lighting&&(n.append(s.lightDiffuseLambertPS),(f||t.clusteredLightingAreaLightsEnabled)&&n.append(s.ltcPS));let m=!1;t.useSpecular&&(this.lighting&&n.append(t.shadingModel===tn?s.lightSpecularPhongPS:t.enableGGXSpecular?s.lightSpecularAnisoGGXPS:s.lightSpecularBlinnPS),!t.fresnelModel&&!this.reflections&&!t.diffuseMapEnabled&&(i.append("uniform vec3 material_ambient;"),i.append("#define LIT_OLD_AMBIENT"),m=!0)),n.append(s.combinePS),t.lightMapEnabled&&n.append(t.useSpecular&&t.dirLightMapEnabled?s.lightmapDirAddPS:s.lightmapAddPS);const g=!t.lightMapEnabled||t.lightMapWithoutAmbient;g&&(t.ambientSource==="ambientSH"?n.append(s.ambientSHPS):t.ambientSource==="envAtlas"?(t.reflectionSource!=="envAtlas"&&t.reflectionSource!=="envAtlasHQ"&&n.append(s.envAtlasPS),n.append(s.ambientEnvPS.replace(/\$DECODE/g,xi.decodeFunc(t.ambientEncoding)))):n.append(s.ambientConstantPS)),t.useAmbientTint&&!m&&i.append("uniform vec3 material_ambient;"),t.useMsdf&&(t.msdfTextAttribute||i.append("#define UNIFORM_TEXT_PARAMETERS"),n.append(s.msdfPS)),this.needsNormal&&(n.append(s.viewDirPS),t.useSpecular&&n.append(t.enableGGXSpecular?s.reflDirAnisoPS:s.reflDirPS));let v=!1,x=!1,S=!1,w=!1,T=!1,b;if(t.clusteredLightingEnabled&&this.lighting&&(w=!0,v=!0,x=!0,T=!0,n.append(s.floatUnpackingPS),t.lightMaskDynamic&&i.append("#define CLUSTER_MESH_DYNAMIC_LIGHTS"),t.clusteredLightingCookiesEnabled&&i.append("#define CLUSTER_COOKIES"),t.clusteredLightingShadowsEnabled&&!t.noShadow&&(i.append("#define CLUSTER_SHADOWS"),i.append("#define CLUSTER_SHADOW_TYPE_"+jr[t.clusteredLightingShadowType])),t.clusteredLightingAreaLightsEnabled&&i.append("#define CLUSTER_AREALIGHTS"),i.append(Dc.getShaderDefines(e)),t.clusteredLightingShadowsEnabled&&!t.noShadow&&n.append(s.clusteredLightShadowsPS),n.append(s.clusteredLightPS)),t.twoSidedLighting&&i.append("uniform float twoSidedLightingNegScaleFactor;"),o.append(this._fsGetStartCode(o,e,s,t)),this.needsNormal&&(t.twoSidedLighting?o.append("    dVertexNormalW = normalize(gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor);"):o.append("    dVertexNormalW = normalize(vNormalW);"),(t.useHeights||t.useNormals)&&t.hasTangents&&(t.twoSidedLighting?(o.append("    dTangentW = gl_FrontFacing ? vTangentW * twoSidedLightingNegScaleFactor : -vTangentW * twoSidedLightingNegScaleFactor;"),o.append("    dBinormalW = gl_FrontFacing ? vBinormalW * twoSidedLightingNegScaleFactor : -vBinormalW * twoSidedLightingNegScaleFactor;")):(o.append("    dTangentW = vTangentW;"),o.append("    dBinormalW = vBinormalW;"))),o.append("    getViewDir();"),_&&o.append("    getTBN(dTangentW, dBinormalW, dVertexNormalW);")),o.append(this.frontendFunc),this.needsNormal&&(t.useSpecular&&a.append("    getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);"),t.useClearCoat&&a.append("    ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));")),(this.lighting&&t.useSpecular||this.reflections)&&(t.useMetalness&&(a.append("    float f0 = 1.0 / litArgs_ior; f0 = (f0 - 1.0) / (f0 + 1.0); f0 *= f0;"),a.append("    litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);"),a.append("    litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);")),t.useIridescence&&a.append("    vec3 iridescenceFresnel = getIridescence(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);")),g&&(a.append("    addAmbient(litArgs_worldNormal);"),t.conserveEnergy&&t.useSpecular&&a.append("   dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);"),t.separateAmbient&&a.append(`
										vec3 dAmbientLight = dDiffuseLight;
										dDiffuseLight = vec3(0);
								`)),t.useAmbientTint&&!m&&a.append("    dDiffuseLight *= material_ambient;"),t.useAo&&!t.occludeDirect&&a.append("    occludeDiffuse(litArgs_ao);"),t.lightMapEnabled&&a.append(`    addLightMap(
								litArgs_lightmap, 
								litArgs_lightmapDir, 
								litArgs_worldNormal, 
								dViewDirW, 
								dReflDirW, 
								litArgs_gloss, 
								litArgs_specularity, 
								dVertexNormalW,
								dTBN
						#if defined(LIT_IRIDESCENCE)
								, iridescenceFresnel,
								litArgs_iridescence_intensity
						#endif
								);`),this.lighting||this.reflections){this.reflections&&(t.useClearCoat&&(a.append("    addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);"),t.fresnelModel>0?(a.append("    ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));"),a.append("    ccReflection.rgb *= ccFresnel;")):a.append("    ccFresnel = 0.0;")),t.useSpecularityFactor&&a.append("    ccReflection.rgb *= litArgs_specularityFactor;"),t.useSheen&&a.append("    addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);"),a.append("    addReflection(dReflDirW, litArgs_gloss);"),t.fresnelModel>0?a.append(`    dReflection.rgb *= 
												getFresnel(
														dot(dViewDirW, litArgs_worldNormal), 
														litArgs_gloss, 
														litArgs_specularity
												#if defined(LIT_IRIDESCENCE)
														, iridescenceFresnel,
														litArgs_iridescence_intensity
												#endif
														);`):a.append("    dReflection.rgb *= litArgs_specularity;"),t.useSpecularityFactor&&a.append("    dReflection.rgb *= litArgs_specularityFactor;")),f&&(a.append("    dSpecularLight *= litArgs_specularity;"),t.useSpecular&&a.append("    calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);"));for(let I=0;I<t.lights.length;I++){const F=t.lights[I],D=F._type;if(t.clusteredLightingEnabled&&D!==fe)continue;b=!1;const A=f&&F._shape?F.shape:Ut,N=f&&F._shape?this._getLightSourceShapeString(A):"";if(A!==Ut&&a.append("    calc"+N+"LightValues(light"+I+"_position, light"+I+"_halfWidth, light"+I+"_halfHeight);"),D===fe?(a.append("    dLightDirNormW = light"+I+"_direction;"),a.append("    dAtten = 1.0;")):(F._cookie&&(D===Ge&&!F._cookie._cubemap||D===Oe&&F._cookie._cubemap)&&(T=!0,b=!0),a.append("    getLightDirPoint(light"+I+"_position);"),v=!0,b&&(D===Ge?a.append("    dAtten3 = getCookie2D"+(F._cookieFalloff?"":"Clip")+(F._cookieTransform?"Xform":"")+"(light"+I+"_cookie, light"+I+"_shadowMatrix, light"+I+"_cookieIntensity"+(F._cookieTransform?", light"+I+"_cookieMatrix, light"+I+"_cookieOffset":"")+")."+F._cookieChannel+";"):a.append("    dAtten3 = getCookieCube(light"+I+"_cookie, light"+I+"_shadowMatrix, light"+I+"_cookieIntensity)."+F._cookieChannel+";")),A===Ut?F._falloffMode===Vy?(a.append("    dAtten = getFalloffLinear(light"+I+"_radius, dLightDirW);"),x=!0):(a.append("    dAtten = getFalloffInvSquared(light"+I+"_radius, dLightDirW);"),S=!0):(a.append("    dAtten = getFalloffWindow(light"+I+"_radius, dLightDirW);"),S=!0),a.append("    if (dAtten > 0.00001) {"),D===Ge&&(b&&!F._cookieFalloff||(a.append("    dAtten *= getSpotEffect(light"+I+"_direction, light"+I+"_innerConeAngle, light"+I+"_outerConeAngle, dLightDirNormW);"),w=!0))),A!==Ut?D===fe?a.append("    dAttenD = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirW, dLightDirNormW);"):a.append("    dAttenD = get"+N+"LightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirW, dLightDirNormW) * 16.0;"):a.append("    dAtten *= getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirW, dLightDirNormW);"),F.castShadows&&!t.noShadow){const U=F._shadowType===ss,G=F._shadowType===ei||F._shadowType===Si||F._shadowType===si,X=F._shadowType===Wi||F._shadowType===xt||F._shadowType===wi;let j=null,J;switch(F._shadowType){case ei:j="VSM8",J="0.0";break;case Si:j="VSM16",J="5.54";break;case si:j="VSM32",e.textureFloatHighPrecision?J="15.0":J="5.54";break;case Wi:j="PCF1x1";break;case wi:j="PCF5x5";break;case ss:j="PCSS";break;case xt:default:j="PCF3x3";break}if(j!==null){F._normalOffsetBias&&!F._isVsm&&n.append("#define SHADOW_SAMPLE_NORMAL_OFFSET"),D===fe&&n.append("#define SHADOW_SAMPLE_ORTHO"),((X||U)&&e.isWebGL2||e.isWebGPU||e.extStandardDerivatives)&&n.append("#define SHADOW_SAMPLE_SOURCE_ZBUFFER"),D===Oe&&n.append("#define SHADOW_SAMPLE_POINT");const ee=s.shadowSampleCoordPS;n.append(ee.replace("$LIGHT",I)),n.append("#undef SHADOW_SAMPLE_NORMAL_OFFSET"),n.append("#undef SHADOW_SAMPLE_ORTHO"),n.append("#undef SHADOW_SAMPLE_SOURCE_ZBUFFER"),n.append("#undef SHADOW_SAMPLE_POINT");let se=`light${I}_shadowMatrix`;D===fe&&F.numCascades>1&&(a.append(`    getShadowCascadeMatrix(light${I}_shadowMatrixPalette, light${I}_shadowCascadeDistances, light${I}_shadowCascadeCount);`),se="cascadeShadowMat"),a.append(`    dShadowCoord = getShadowSampleCoord${I}(${se}, light${I}_shadowParams, vPositionW, dLightPosW, dLightDirW, dLightDirNormW, dVertexNormalW);`),D===fe&&a.append(`    fadeShadow(light${I}_shadowCascadeDistances);`);var C=`SHADOWMAP_PASS(light${I}_shadowMap), dShadowCoord, light${I}_shadowParams`;if(G)C=`${C}, ${J}, dLightDirW`;else if(U){let oe=`vec2(light${I}_shadowSearchArea)`;A!==Ut&&(oe=`vec2(length(light${I}_halfWidth), length(light${I}_halfHeight)) * light${I}_shadowSearchArea`),C=`${C}, light${I}_cameraParams, ${oe}, dLightDirW`}D===Oe?(j=`Point${j}`,U||(C=`${C}, dLightDirW`)):D===Ge&&(j=`Spot${j}`),a.append(`    float shadow${I} = getShadow${j}(${C});`),a.append(`    dAtten *= mix(1.0, shadow${I}, light${I}_shadowIntensity);`)}}if(A!==Ut?t.conserveEnergy&&t.useSpecular?a.append("    dDiffuseLight += ((dAttenD * dAtten) * light"+I+"_color"+(b?" * dAtten3":"")+") * (1.0 - dLTCSpecFres);"):a.append("    dDiffuseLight += (dAttenD * dAtten) * light"+I+"_color"+(b?" * dAtten3":"")+";"):f&&t.conserveEnergy&&t.useSpecular?a.append("    dDiffuseLight += (dAtten * light"+I+"_color"+(b?" * dAtten3":"")+") * (1.0 - litArgs_specularity);"):a.append("    dDiffuseLight += dAtten * light"+I+"_color"+(b?" * dAtten3":"")+";"),t.useSpecular&&a.append("    dHalfDirW = normalize(-dLightDirNormW + dViewDirW);"),F.affectSpecularity)if(A!==Ut)t.useClearCoat&&a.append(`    ccSpecularLight += ccLTCSpecFres * get${N}LightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * light${I}_color`+(b?" * dAtten3":"")+";"),t.useSpecular&&a.append(`    dSpecularLight += dLTCSpecFres * get${N}LightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * light${I}_color`+(b?" * dAtten3":"")+";");else{var E=!1;D===fe&&t.fresnelModel>0&&(E=!0),t.useClearCoat&&a.append(`    ccSpecularLight += getLightSpecular(dHalfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * light${I}_color`+(b?" * dAtten3":"")+(E?" * getFresnelCC(dot(dViewDirW, dHalfDirW));":";")),t.useSheen&&a.append(`    sSpecularLight += getLightSpecularSheen(dHalfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * light${I}_color`+(b?" * dAtten3;":";")),t.useSpecular&&a.append(`    dSpecularLight += getLightSpecular(dHalfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * light${I}_color`+(b?" * dAtten3":"")+(E?` 
																		* getFresnel(
																				dot(dViewDirW, dHalfDirW), 
																				litArgs_gloss, 
																				litArgs_specularity
																		#if defined(LIT_IRIDESCENCE)
																				, iridescenceFresnel, 
																				litArgs_iridescence_intensity
																		#endif
																		);`:"* litArgs_specularity;"))}D!==fe&&a.append("    }")}t.clusteredLightingEnabled&&this.lighting&&(x=!0,S=!0,v=!0,a.append(`    addClusteredLights(
																				litArgs_worldNormal, 
																				dViewDirW, 
																				dReflDirW,
																#if defined(LIT_CLEARCOAT)
																				ccReflDirW,
																#endif
																				litArgs_gloss, 
																				litArgs_specularity, 
																				dVertexNormalW, 
																				dTBN, 
																#if defined(LIT_IRIDESCENCE)
																				iridescenceFresnel,
																#endif
																				litArgs_clearcoat_worldNormal, 
																				litArgs_clearcoat_gloss,
																				litArgs_sheen_gloss,
																				litArgs_iridescence_intensity
																		);`)),f&&(t.useClearCoat&&a.append("    litArgs_clearcoat_specularity = 1.0;"),t.useSpecular&&a.append("    litArgs_specularity = vec3(1);")),t.useRefraction&&a.append(`    addRefraction(
												litArgs_worldNormal, 
												dViewDirW, 
												litArgs_thickness, 
												litArgs_gloss, 
												litArgs_specularity, 
												litArgs_albedo, 
												litArgs_transmission,
												litArgs_ior
										#if defined(LIT_IRIDESCENCE)
												, iridescenceFresnel, 
												litArgs_iridescence_intensity
										#endif
										);`)}t.useAo&&(t.occludeDirect&&a.append("    occludeDiffuse(litArgs_ao);"),(t.occludeSpecular===Cc||t.occludeSpecular===rg)&&a.append("    occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);")),t.useSpecularityFactor&&a.append("    dSpecularLight *= litArgs_specularityFactor;"),t.opacityFadesSpecular===!1&&((t.blendType===Bt||t.blendType===qa)&&(a.append("float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3( 0.2126, 0.7152, 0.0722 ));"),a.append(`#ifdef LIT_CLEARCOAT
 specLum += dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection.rgb * litArgs_clearcoat_specularity, vec3( 0.2126, 0.7152, 0.0722 ));
#endif`),a.append("litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);")),a.append("litArgs_opacity *= material_alphaFade;")),a.append(s.endPS),t.blendType===Bt||t.blendType===Ny||t.alphaToCoverage?a.append(s.outputAlphaPS):t.blendType===qa?a.append(s.outputAlphaPremulPS):a.append(s.outputAlphaOpaquePS),t.useMsdf&&a.append("    gl_FragColor = applyMsdf(gl_FragColor);"),a.append(s.outputPS),a.append(s.debugOutputPS),v&&n.prepend(s.lightDirPointPS),x&&n.prepend(s.falloffLinearPS),S&&n.prepend(s.falloffInvSquaredPS),w&&n.prepend(s.spotPS),T&&!t.clusteredLightingEnabled&&n.prepend(s.cookiePS);let R="";const B=`void evaluateBackend() {
${a.code}
}`;n.append(B),o.append(s.debugProcessFrontendPS),o.append("    evaluateBackend();"),o.append(Be.end());const L=i.code+n.code+o.code;return L.includes("dTBN")&&(R+=`mat3 dTBN;
`),L.includes("dVertexNormalW")&&(R+=`vec3 dVertexNormalW;
`),L.includes("dTangentW")&&(R+=`vec3 dTangentW;
`),L.includes("dBinormalW")&&(R+=`vec3 dBinormalW;
`),L.includes("dViewDirW")&&(R+=`vec3 dViewDirW;
`),L.includes("dReflDirW")&&(R+=`vec3 dReflDirW;
`),L.includes("dHalfDirW")&&(R+=`vec3 dHalfDirW;
`),L.includes("ccReflDirW")&&(R+=`vec3 ccReflDirW;
`),L.includes("dLightDirNormW")&&(R+=`vec3 dLightDirNormW;
`),L.includes("dLightDirW")&&(R+=`vec3 dLightDirW;
`),L.includes("dLightPosW")&&(R+=`vec3 dLightPosW;
`),L.includes("dShadowCoord")&&(R+=`vec3 dShadowCoord;
`),L.includes("dReflection")&&(R+=`vec4 dReflection;
`),L.includes("dDiffuseLight")&&(R+=`vec3 dDiffuseLight;
`),L.includes("dSpecularLight")&&(R+=`vec3 dSpecularLight;
`),L.includes("dAtten")&&(R+=`float dAtten;
`),L.includes("dAttenD")&&(R+=`float dAttenD;
`),L.includes("dAtten3")&&(R+=`vec3 dAtten3;
`),L.includes("dMsdf")&&(R+=`vec4 dMsdf;
`),L.includes("ccFresnel")&&(R+=`float ccFresnel;
`),L.includes("ccReflection")&&(R+=`vec3 ccReflection;
`),L.includes("ccSpecularLight")&&(R+=`vec3 ccSpecularLight;
`),L.includes("ccSpecularityNoFres")&&(R+=`float ccSpecularityNoFres;
`),L.includes("sSpecularLight")&&(R+=`vec3 sSpecularLight;
`),L.includes("sReflection")&&(R+=`vec3 sReflection;
`),this._fsGetBeginCode()+this.varyings+this.varyingDefines+this._fsGetBaseCode()+R+this.frontendDecl+L}generateFragmentShader(e,t,s,i){var n;const a=this.options;this.frontendDecl=e,this.frontendCode=t,this.frontendFunc=s,this.lightingUv=i,a.pass===bd?this.fshader=this._fsGetPickPassCode():a.pass===Xi?this.fshader=this._fsGetDepthPassCode():a.pass===hf?this.fshader=this._fsGetPrePassVelocityCode():this.shadowPass?this.fshader=this._fsGetShadowPassCode():a.customFragmentShader?this.fshader=this._fsGetBeginCode()+a.customFragmentShader:this.fshader=this._fsGetLitPassCode(),(n=this.handleCompatibility)==null||n.call(this)}getDefinition(){const e=Mt.createDefinition(this.device,{name:"LitShader",attributes:this.attributes,vertexCode:this.vshader,fragmentCode:this.fshader});return this.shaderPassInfo.isForward&&(e.tag=QA),e}}const hg={generateKey(r){return"lit"+Object.keys(r).sort().map(e=>e==="chunks"?hg.generateChunksKey(r):e==="lights"?hg.generateLightsKey(r):e+r[e]).join(`
`)},generateLightsKey(r){return"lights:"+r.lights.map(e=>!r.clusteredLightingEnabled||e._type===fe?`${e.key},`:"").join("")},generateChunksKey(r){var e;return`chunks:
`+Object.keys((e=r.chunks)!=null?e:{}).sort().map(t=>t+r.chunks[t]).join("")}};new q2;const Kd=new y,Yd=new y,Zd=new y,Dm=new Re,hS=1e-6;class cS{constructor(){this.light=null,this.min=new y,this.max=new y}}class cg{constructor(e){this.clusterTexture=void 0,this.device=e,this.name="Untitled",this.reportCount=0,this.boundsMin=new y,this.boundsMax=new y,this.boundsDelta=new y,this._cells=new y(1,1,1),this._cellsLimit=new y,this.cells=this._cells,this.maxCellLightCount=4,this._maxAttenuation=0,this._maxColorValue=0,this._usedLights=[],this._usedLights.push(new cS),this.lightsBuffer=new Dc(e),this.registerUniforms(e)}set maxCellLightCount(e){e!==this._maxCellLightCount&&(this._maxCellLightCount=e,this._cellsDirty=!0)}get maxCellLightCount(){return this._maxCellLightCount}set cells(e){Kd.copy(e).floor(),this._cells.equals(Kd)||(this._cells.copy(Kd),this._cellsLimit.copy(Kd).sub(y.ONE),this._cellsDirty=!0)}get cells(){return this._cells}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture()}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)}registerUniforms(e){this._clusterSkipId=e.scope.resolve("clusterSkip"),this._clusterMaxCellsId=e.scope.resolve("clusterMaxCells"),this._clusterWorldTextureId=e.scope.resolve("clusterWorldTexture"),this._clusterTextureSizeId=e.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=e.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=e.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=e.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=e.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=e.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3),this._clusterCompressionLimit0Id=e.scope.resolve("clusterCompressionLimit0"),this._clusterCompressionLimit0Data=new Float32Array(2)}updateParams(e){e&&(this.cells=e.cells,this.maxCellLightCount=e.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=e.cookiesEnabled,this.lightsBuffer.shadowsEnabled=e.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=e.areaLightsEnabled)}updateCells(){if(this._cellsDirty){this._cellsDirty=!1;const e=this._cells.x,t=this._cells.y,s=this._cells.z,i=e*t*s,n=this.maxCellLightCount*i;let a=Math.ceil(Math.sqrt(n));a=H.roundUp(a,this.maxCellLightCount);const o=Math.ceil(n/a);this._clusterCellsMaxData[0]=e,this._clusterCellsMaxData[1]=t,this._clusterCellsMaxData[2]=s,this._clusterCellsDotData[0]=this.maxCellLightCount,this._clusterCellsDotData[1]=e*s*this.maxCellLightCount,this._clusterCellsDotData[2]=e*this.maxCellLightCount,this.clusters=new Uint8ClampedArray(n),this.counts=new Int32Array(i),this._clusterTextureSizeData[0]=a,this._clusterTextureSizeData[1]=1/a,this._clusterTextureSizeData[2]=1/o,this.releaseClusterTexture(),this.clusterTexture=this.lightsBuffer.createTexture(this.device,a,o,op,"ClusterTexture")}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures()}updateUniforms(){this._clusterSkipId.setValue(this._usedLights.length>1?0:1),this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture),this._clusterMaxCellsId.setValue(this.maxCellLightCount);const e=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/e.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/e.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/e.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=e.x,this._clusterBoundsDeltaData[1]=e.y,this._clusterBoundsDeltaData[2]=e.z,this._clusterCompressionLimit0Data[0]=this._maxAttenuation,this._clusterCompressionLimit0Data[1]=this._maxColorValue,this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData),this._clusterCompressionLimit0Id.setValue(this._clusterCompressionLimit0Data)}evalLightCellMinMax(e,t,s){t.copy(e.min),t.sub(this.boundsMin),t.div(this.boundsDelta),t.mul2(t,this.cells),t.floor(),s.copy(e.max),s.sub(this.boundsMin),s.div(this.boundsDelta),s.mul2(s,this.cells),s.ceil(),t.max(y.ZERO),s.min(this._cellsLimit)}collectLights(e){const t=this.lightsBuffer.maxLights,s=this._usedLights;let i=1;e.forEach(n=>{const a=!!(n.mask&(Fs|ji)),o=n.type===Ge&&n._outerConeAngle===0;if(n.enabled&&n.type!==fe&&n.visibleThisFrame&&n.intensity>0&&a&&!o&&i<t){let l;i<s.length?l=s[i]:(l=new cS,s.push(l)),l.light=n,n.getBoundingBox(Dm),l.min.copy(Dm.getMin()),l.max.copy(Dm.getMax()),i++}}),s.length=i}evaluateBounds(){const e=this._usedLights,t=this.boundsMin,s=this.boundsMax;if(e.length>1){t.copy(e[1].min),s.copy(e[1].max);for(let i=2;i<e.length;i++)t.min(e[i].min),s.max(e[i].max)}else t.set(0,0,0),s.set(1,1,1);this.boundsDelta.sub2(s,t),this.lightsBuffer.setBounds(t,this.boundsDelta)}evaluateCompressionLimits(e){let t=0,s=0;const i=this._usedLights;for(let n=1;n<i.length;n++){const a=i[n].light;t=Math.max(a.attenuationEnd,t);const o=e?a._linearFinalColor:a._finalColor;s=Math.max(o[0],s),s=Math.max(o[1],s),s=Math.max(o[2],s)}this._maxAttenuation=t+hS,this._maxColorValue=s+hS,this.lightsBuffer.setCompressionRanges(this._maxAttenuation,this._maxColorValue)}updateClusters(e){this.counts.fill(0),this.clusters.fill(0);const t=this._cells.x,s=this._cells.z,i=this.counts,n=this._maxCellLightCount,a=this.clusters,o=this.maxCellLightCount,l=this._usedLights;for(let c=1;c<l.length;c++){const d=l[c],h=d.light;this.lightsBuffer.addLightData(h,c,e),this.evalLightCellMinMax(d,Yd,Zd);const u=Yd.x,f=Zd.x,p=Yd.y,_=Zd.y,m=Yd.z,g=Zd.z;for(let v=u;v<=f;v++)for(let x=m;x<=g;x++)for(let S=p;S<=_;S++){const w=v+t*(x+S*s),T=i[w];T<n&&(a[o*w+T]=c,i[w]=T+1)}}}update(e,t,s){this.updateParams(s),this.updateCells(),this.collectLights(e),this.evaluateBounds(),this.evaluateCompressionLimits(t),this.updateClusters(t),this.uploadTextures()}activate(){this.updateUniforms()}}const dS=2.399963229728653,Cd={circlePoint(r){const e=Math.sqrt(Math.random()),t=Math.random()*2*Math.PI;r.x=e*Math.cos(t),r.y=e*Math.sin(t)},circlePointDeterministic(r,e,t){const s=e*dS,i=Math.sqrt(e)/Math.sqrt(t);r.x=i*Math.cos(s),r.y=i*Math.sin(s)},spherePointDeterministic(r,e,t,s=0,i=1){s=1-2*s,i=1-2*i;const n=H.lerp(s,i,e/t),a=Math.sqrt(1-n*n),o=dS*e;r.x=Math.cos(o)*a,r.y=n,r.z=Math.sin(o)*a},radicalInverse(r){let e=(r<<16|r>>>16)>>>0;return e=((e&1431655765)<<1|(e&2863311530)>>>1)>>>0,e=((e&858993459)<<2|(e&3435973836)>>>2)>>>0,e=((e&252645135)<<4|(e&4042322160)>>>4)>>>0,e=((e&16711935)<<8|(e&4278255360)>>>8)>>>0,e*23283064365386963e-26}},uS=r=>{switch(r){case q_:return"Cubemap";case r1:return"Octahedral";default:return"Equirect"}},Jd=(r,e,t)=>{if(r<=0)e[t+0]=0,e[t+1]=0,e[t+2]=0,e[t+3]=0;else if(r>=1)e[t+0]=255,e[t+1]=0,e[t+2]=0,e[t+3]=0;else{let s=1*r%1,i=255*r%1,n=65025*r%1;const a=16581375*r%1;s-=i/255,i-=n/255,n-=a/255,e[t+0]=Math.min(255,Math.floor(s*256)),e[t+1]=Math.min(255,Math.floor(i*256)),e[t+2]=Math.min(255,Math.floor(n*256)),e[t+3]=Math.min(255,Math.floor(a*256))}},sO=r=>{const e=r.length,t=Math.min(e,512),s=Math.ceil(e/t),i=new Uint8Array(t*s*4);let n=0;for(let a=0;a<e;a+=4)Jd(r[a+0]*.5+.5,i,n+0),Jd(r[a+1]*.5+.5,i,n+4),Jd(r[a+2]*.5+.5,i,n+8),Jd(r[a+3]/8,i,n+12),n+=16;return{width:t,height:s,data:i}},iO=(r,e,t,s)=>{const i=t*2*Math.PI,n=Math.pow(1-e,1/(s+1)),a=Math.sqrt(1-n*n);r.set(Math.cos(i)*a,Math.sin(i)*a,n).normalize()},nO=(r,e,t)=>{const s=t*2*Math.PI,i=Math.sqrt(1-e),n=Math.sqrt(e);r.set(Math.cos(s)*n,Math.sin(s)*n,i).normalize()},rO=(r,e,t,s)=>{const i=t*2*Math.PI,n=Math.sqrt((1-e)/(1+(s*s-1)*e)),a=Math.sqrt(1-n*n);r.set(Math.cos(i)*a,Math.sin(i)*a,n).normalize()},aO=(r,e)=>{const t=r*e,s=e/(1-r*r+t*t);return s*s*(1/Math.PI)},oO=(r,e)=>{const t=new y,s=[];for(let i=0;i<r;++i)iO(t,i/r,Cd.radicalInverse(i),e),s.push(t.x,t.y,t.z,0);return s},lO=(r,e)=>{const t=e/r,s=new y,i=[];for(let n=0;n<r;++n){nO(s,n/r,Cd.radicalInverse(n));const a=s.z/Math.PI,o=.5*Math.log2(t/a);i.push(s.x,s.y,s.z,o)}return i},hO={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},cO=(r,e)=>{const t=hO[r];return t&&t[e]||r},dO=(r,e,t)=>{const s=t/r,i=1-Math.log2(e)/11,n=i*i,a=new y,o=new y,l=new y(0,0,1),c=[],d=cO(r,e);for(let h=0;h<d;++h){rO(a,h/d,Cd.radicalInverse(h),n);const u=a.z;if(o.set(a.x,a.y,a.z).mulScalar(2*u).sub(l),o.z>0){const f=aO(Math.min(1,u),n)/4+.001,p=.5*Math.log2(s/f);c.push(o.x,o.y,o.z,p)}}for(;c.length<r*4;)c.push(0,0,0,0);return c},uO=(r,e,t)=>{const s=sO(t);return new _e(r,{name:e,width:s.width,height:s.height,mipmaps:!1,minFilter:Ee,magFilter:Ee,levels:[s.data]})};class $b{constructor(e=!0){this.map=new Map,this.destroyContent=e}destroy(){this.destroyContent&&this.map.forEach((e,t)=>{e.destroy()})}get(e,t){if(!this.map.has(e)){const s=t();return this.map.set(e,s),s}return this.map.get(e)}}const fO=new $b(!1),pO=new di,Jy=(r,e,t)=>pO.get(r,()=>new $b).get(e,()=>uO(r,e,fO.get(e,t))),mO=(r,e,t)=>{const s=`lambert-samples-${e}-${t}`;return Jy(r,s,()=>lO(e,t))},_O=(r,e,t)=>{const s=`phong-samples-${e}-${t}`;return Jy(r,s,()=>oO(e,t))},gO=(r,e,t,s)=>{const i=`ggx-samples-${e}-${t}-${s}`;return Jy(r,i,()=>dO(e,t,s))},yO=`
attribute vec2 vertex_position;

uniform vec4 uvMod;

varying vec2 vUv0;

void main(void) {
		gl_Position = vec4(vertex_position, 0.5, 1.0);
		vUv0 = getImageEffectUV((vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw);
}
`;function dn(r,e,t={}){var s,i,n,a,o;r instanceof ct&&(r=arguments[1],e=arguments[2],t={},arguments[3]!==void 0&&(t.specularPower=arguments[3]),arguments[4]!==void 0&&(t.numSamples=arguments[4]));const l=(s=t.seamPixels)!=null?s:0,c=((i=(n=t.rect)==null?void 0:n.z)!=null?i:e.width)-l*2,d=((a=(o=t.rect)==null?void 0:o.w)!=null?a:e.height)-l*2;if(c<1||d<1)return!1;const h={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"},u=t.hasOwnProperty("specularPower")?t.specularPower:1,f=t.hasOwnProperty("face")?t.face:null,p=t.hasOwnProperty("distribution")?t.distribution:u===1?"none":"phong",_=h[p]||"reproject",m=_.startsWith("prefilterSamples"),g=xi.decodeFunc(r.encoding),v=xi.encodeFunc(e.encoding),x=`sample${uS(r.projection)}`,S=`getDirection${uS(e.projection)}`,w=t.hasOwnProperty("numSamples")?t.numSamples:1024,T=`${_}_${g}_${v}_${x}_${S}_${w}`,b=r.device;let C=cn(b).getCachedShader(T);if(!C){const D=`#define PROCESS_FUNC ${_}
`+(m?`#define USE_SAMPLES_TEX
`:"")+(r.cubemap?`#define CUBEMAP_SOURCE
`:"")+`#define DECODE_FUNC ${g}
#define ENCODE_FUNC ${v}
#define SOURCE_FUNC ${x}
#define TARGET_FUNC ${S}
#define NUM_SAMPLES ${w}
#define NUM_SAMPLES_SQRT ${Math.round(Math.sqrt(w)).toFixed(1)}
`;C=ks(b,yO,`${D}
${W.reprojectPS}`,T)}b.setBlendState(Xe.NOBLEND),b.scope.resolve(r.cubemap?"sourceCube":"sourceTex").setValue(r);const R=b.scope.resolve("params"),B=b.scope.resolve("params2"),L=b.scope.resolve("uvMod");l>0?L.setValue([(c+l*2)/c,(d+l*2)/d,-l/c,-l/d]):L.setValue([1,1,0,0]);const V=[0,u,r.fixCubemapSeams?1/r.width:0,e.fixCubemapSeams?1/e.width:0],I=[e.width*e.height*(e.cubemap?6:1),r.width*r.height*(r.cubemap?6:1)];if(m){const D=r.width*r.height*(r.cubemap?6:1),A=p==="ggx"?gO(b,w,u,D):p==="lambert"?mO(b,w,D):_O(b,w,u);b.scope.resolve("samplesTex").setValue(A),b.scope.resolve("samplesTexInverseSize").setValue([1/A.width,1/A.height])}for(let D=0;D<(e.cubemap?6:1);D++)if(f===null||D===f){var F;const A=new Ct({colorBuffer:e,face:D,depth:!1,flipY:b.isWebGPU});V[0]=D,R.setValue(V),B.setValue(I),Ya(b,A,C,(F=t)==null?void 0:F.rect),A.destroy()}return!0}const vO=!0,Om=(r,e=0)=>1+Math.floor(Math.log2(Math.max(r,e))),SO=r=>r.extTextureHalfFloat&&r.textureHalfFloatRenderable,xO=r=>r.extTextureFloat&&r.textureFloatRenderable,wO=r=>SO(r)?yt:xO(r)?rt:xe,bO=r=>xe,TO=(r,e,t,s)=>new _e(r,{name:`lighting-${e}`,cubemap:!0,width:e,height:e,format:t,type:t===xe?Rl:ps,addressU:ae,addressV:ae,fixCubemapSeams:vO,mipmaps:!!s});class Xb{static generateSkyboxCubemap(e,t){const s=e.device,i=TO(s,t||(e.cubemap?e.width:e.width/4),xe,!1);return dn(e,i,{numSamples:1024}),i}static generateLightingSource(e,t){const s=e.device,i=wO(s),n=(t==null?void 0:t.target)||new _e(s,{name:"lighting-source",cubemap:!0,width:(t==null?void 0:t.size)||128,height:(t==null?void 0:t.size)||128,format:i,type:i===xe?Rl:ps,addressU:ae,addressV:ae,fixCubemapSeams:!1,mipmaps:!0});return dn(e,n,{numSamples:e.mipmaps?1:1024}),n}static generateAtlas(e,t){const s=e.device,i=bO(),n=(t==null?void 0:t.target)||new _e(s,{name:"envAtlas",width:(t==null?void 0:t.size)||512,height:(t==null?void 0:t.size)||512,format:i,type:Rl,projection:cv,addressU:ae,addressV:ae,mipmaps:!1}),a=n.width/512,o=new P(0,0,512*a,256*a),l=Om(256)-Om(4);for(let c=0;c<l;++c)dn(e,n,{numSamples:1,rect:o,seamPixels:a}),o.x+=o.w,o.y+=o.w,o.z=Math.max(1,Math.floor(o.z*.5)),o.w=Math.max(1,Math.floor(o.w*.5));o.set(0,256*a,256*a,128*a);for(let c=1;c<7;++c)dn(e,n,{numSamples:(t==null?void 0:t.numReflectionSamples)||1024,distribution:(t==null?void 0:t.distribution)||"ggx",specularPower:Math.max(1,2048>>c*2),rect:o,seamPixels:a}),o.y+=o.w,o.z=Math.max(1,Math.floor(o.z*.5)),o.w=Math.max(1,Math.floor(o.w*.5));return o.set(128*a,384*a,64*a,32*a),dn(e,n,{numSamples:(t==null?void 0:t.numAmbientSamples)||2048,distribution:"lambert",rect:o,seamPixels:a}),n}static generatePrefilteredAtlas(e,t){const s=e[0].device,i=e[0].format,n=e[0].type,a=(t==null?void 0:t.target)||new _e(s,{name:"envPrefilteredAtlas",width:(t==null?void 0:t.size)||512,height:(t==null?void 0:t.size)||512,format:i,type:n,projection:cv,addressU:ae,addressV:ae,mipmaps:!1}),o=a.width/512,l=new P(0,0,512*o,256*o),c=Om(512);for(let d=0;d<c;++d)dn(e[0],a,{numSamples:1,rect:l,seamPixels:o}),l.x+=l.w,l.y+=l.w,l.z=Math.max(1,Math.floor(l.z*.5)),l.w=Math.max(1,Math.floor(l.w*.5));l.set(0,256*o,256*o,128*o);for(let d=1;d<e.length;++d)dn(e[d],a,{numSamples:1,rect:l,seamPixels:o}),l.y+=l.w,l.z=Math.max(1,Math.floor(l.z*.5)),l.w=Math.max(1,Math.floor(l.w*.5));return l.set(128*o,384*o,64*o,32*o),t!=null&&t.legacyAmbient?dn(e[5],a,{numSamples:1,rect:l,seamPixels:o}):dn(e[0],a,{numSamples:(t==null?void 0:t.numSamples)||2048,distribution:"lambert",rect:l,seamPixels:o}),a}}class Oc{constructor(){this.forceUv1=!1,this.ambientTint=!1,this.diffuseTint=!1,this.specularTint=!1,this.metalnessTint=!1,this.glossTint=!1,this.emissiveTint=!1,this.opacityTint=!1,this.emissiveEncoding="linear",this.lightMapEncoding="linear",this.packedNormal=!1,this.glossInvert=!1,this.sheenGlossInvert=!1,this.clearCoatGlossInvert=!1,this.litOptions=new Zy}get pass(){return this.litOptions.pass}}const bl=[],Fm=r=>Object.keys(r).filter(e=>e!=="litOptions").sort();class EO extends Be{constructor(...e){super(...e),this.optionsContext=new Oc,this.optionsContextMin=new Oc}generateKey(e){let t;return e===this.optionsContextMin?(this.propsMin||(this.propsMin=Fm(e)),t=this.propsMin):e===this.optionsContext?(this.props||(this.props=Fm(e)),t=this.props):t=Fm(e),`standard:
`+t.map(i=>i+e[i]).join(`
`)+hg.generateKey(e.litOptions)}_getUvSourceExpression(e,t,s){const i=s[e],n=s[t],a=s.litOptions.pass===wd||s.litOptions.pass===sn;let o;return a&&s.litOptions.nineSlicedMode===wt||a&&s.litOptions.nineSlicedMode===mt?o="nineSlicedUv":(i===0?o="vUv"+n:o="vUV"+n+"_"+i,s.heightMap&&e!=="heightMapTransform"&&(o+=" + dUvOffset")),o}_addMapDef(e,t){return t?`#define ${e}
`:`#undef ${e}
`}_addMapDefs(e,t,s,i,n){return this._addMapDef("MAPFLOAT",e)+this._addMapDef("MAPCOLOR",t)+this._addMapDef("MAPVERTEX",s)+this._addMapDef("MAPTEXTURE",i)+this._addMapDef("MAPINVERT",n)}_addMap(e,t,s,i,n,a=null){const o=e+"Map",l=o+"Uv",c=o+"Identifier",d=o+"Transform",h=o+"Channel",u=e+"VertexColorChannel",f=e+"Tint",p=e+"VertexColor",_=e+"Mode",m=e+"Invert",g=s[f],v=s[p],x=s[o],S=s[c],w=s[_];let T=i[t];if(x){const R=this._getUvSourceExpression(d,l,s);if(T=T.replace(/\$UV/g,R).replace(/\$CH/g,s[h]),n&&T.search(/\$SAMPLER/g)!==-1){let B="texture_"+o;const L=n[S];L?B=L:n[S]=B,T=T.replace(/\$SAMPLER/g,B)}if(a&&(s[h]==="aaa"?T=T.replace(/\$DECODE/g,"passThrough"):T=T.replace(/\$DECODE/g,xi.decodeFunc(!s.litOptions.gamma&&a==="srgb"?"linear":a)),T.indexOf("$texture2DSAMPLE"))){const B={linear:"texture2D",srgb:"texture2DSRGB",rgbm:"texture2DRGBM",rgbe:"texture2DRGBE"};T=T.replace(/\$texture2DSAMPLE/g,B[a]||"texture2D")}}v&&(T=T.replace(/\$VC/g,s[u])),w&&(T=T.replace(/\$DETAILMODE/g,w));const b=!!(g&1),C=!!(g&2),E=!!s[m];return T=this._addMapDefs(b,C,v,x,E)+T,T.replace(/\$/g,"")}_correctChannel(e,t,s){if(s[e]>0){if(s[e]<t.length)return t.substring(0,s[e]);if(s[e]>t.length){let i=t;const n=i.charAt(i.length-1),a=s[e]-i.length;for(let o=0;o<a;o++)i+=n;return i}return t}}createShaderDefinition(e,t){const i=Ii.get(e).getByIndex(t.litOptions.pass).isForward,n=new tO(e,t.litOptions),a=[],o=[],l=[],c=2,d={};for(const m in bl){const g=m+"Map";if(t[m+"VertexColor"]){const v=m+"VertexColorChannel";t[v]=this._correctChannel(m,t[v],bl)}if(t[g]){const v=g+"Channel",x=g+"Transform",S=g+"Uv";t[S]=Math.min(t[S],c-1),t[v]=this._correctChannel(m,t[v],bl);const w=t[S];a[w]=!0,o[w]=o[w]||t[g]&&!t[x],t[x]&&l.push({name:m,id:t[x],uv:t[S]})}}t.forceUv1&&(a[1]=!0,o[1]=o[1]!==void 0?o[1]:!0),n.generateVertexShader(a,o,l),t.litOptions.shadingModel===tn?(t.litOptions.fresnelModel=0,t.litOptions.ambientSH=!1):t.litOptions.fresnelModel=t.litOptions.fresnelModel===0?Uy:t.litOptions.fresnelModel;const h=new Er,u=new Er,f=new Er,p=new Er;let _="";if(t.litOptions.nineSlicedMode===mt?h.append("const float textureBias = -1000.0;"):h.append("uniform float textureBias;"),i){if(t.heightMap&&(h.append("vec2 dUvOffset;"),u.append(this._addMap("height","parallaxPS",t,n.chunks,d)),f.append("getParallax();")),t.litOptions.blendType!==ms||t.litOptions.alphaTest||t.litOptions.alphaToCoverage||t.litOptions.opacityDither!==gs){h.append("float dAlpha;"),u.append(this._addMap("opacity","opacityPS",t,n.chunks,d)),f.append("getOpacity();"),p.append("litArgs_opacity = dAlpha;"),t.litOptions.alphaTest&&(u.append(n.chunks.alphaTestPS),f.append("alphaTest(dAlpha);"));const m=t.litOptions.opacityDither;m!==gs&&(m===Hv&&h.append(n.chunks.bayerPS),h.append(`#define DITHER_${m.toUpperCase()}
`),h.append(n.chunks.opacityDitherPS),f.append("opacityDither(dAlpha, 0.0);"))}else h.append("float dAlpha = 1.0;");if(n.needsNormal){if((t.normalMap||t.clearCoatNormalMap)&&(u.append(t.packedNormal?n.chunks.normalXYPS:n.chunks.normalXYZPS),!t.litOptions.hasTangents)){const m=t.normalMap?"normalMap":"clearCoatNormalMap";_=this._getUvSourceExpression(`${m}Transform`,`${m}Uv`,t)}h.append("vec3 dNormalW;"),u.append(this._addMap("normalDetail","normalDetailMapPS",t,n.chunks,d)),u.append(this._addMap("normal","normalMapPS",t,n.chunks,d)),f.append("getNormal();"),p.append("litArgs_worldNormal = dNormalW;")}if(n.needsSceneColor&&h.append("uniform sampler2D uSceneColorMap;"),n.needsScreenSize&&h.append("uniform vec4 uScreenSize;"),n.needsTransforms&&(h.append("uniform mat4 matrix_viewProjection;"),h.append("uniform mat4 matrix_model;")),(t.diffuseDetail||t.aoDetail)&&u.append(n.chunks.detailModesPS),h.append("vec3 dAlbedo;"),t.diffuseDetail&&u.append(this._addMap("diffuseDetail","diffuseDetailMapPS",t,n.chunks,d,t.diffuseDetailEncoding)),u.append(this._addMap("diffuse","diffusePS",t,n.chunks,d,t.diffuseEncoding)),f.append("getAlbedo();"),p.append("litArgs_albedo = dAlbedo;"),t.litOptions.useRefraction&&(h.append("float dTransmission;"),u.append(this._addMap("refraction","transmissionPS",t,n.chunks,d)),f.append("getRefraction();"),p.append("litArgs_transmission = dTransmission;"),h.append("float dThickness;"),u.append(this._addMap("thickness","thicknessPS",t,n.chunks,d)),f.append("getThickness();"),p.append("litArgs_thickness = dThickness;")),t.litOptions.useIridescence&&(h.append("float dIridescence;"),u.append(this._addMap("iridescence","iridescencePS",t,n.chunks,d)),f.append("getIridescence();"),p.append("litArgs_iridescence_intensity = dIridescence;"),h.append("float dIridescenceThickness;"),u.append(this._addMap("iridescenceThickness","iridescenceThicknessPS",t,n.chunks,d)),f.append("getIridescenceThickness();"),p.append("litArgs_iridescence_thickness = dIridescenceThickness;")),n.lighting&&t.litOptions.useSpecular||n.reflections?(h.append("vec3 dSpecularity;"),h.append("float dGlossiness;"),t.litOptions.useSheen&&(h.append("vec3 sSpecularity;"),u.append(this._addMap("sheen","sheenPS",t,n.chunks,d,t.sheenEncoding)),f.append("getSheen();"),p.append("litArgs_sheen_specularity = sSpecularity;"),h.append("float sGlossiness;"),u.append(this._addMap("sheenGloss","sheenGlossPS",t,n.chunks,d)),f.append("getSheenGlossiness();"),p.append("litArgs_sheen_gloss = sGlossiness;")),t.litOptions.useMetalness&&(h.append("float dMetalness;"),u.append(this._addMap("metalness","metalnessPS",t,n.chunks,d)),f.append("getMetalness();"),p.append("litArgs_metalness = dMetalness;"),h.append("float dIor;"),u.append(this._addMap("ior","iorPS",t,n.chunks,d)),f.append("getIor();"),p.append("litArgs_ior = dIor;")),t.litOptions.useSpecularityFactor&&(h.append("float dSpecularityFactor;"),u.append(this._addMap("specularityFactor","specularityFactorPS",t,n.chunks,d)),f.append("getSpecularityFactor();"),p.append("litArgs_specularityFactor = dSpecularityFactor;")),t.useSpecularColor?u.append(this._addMap("specular","specularPS",t,n.chunks,d,t.specularEncoding)):u.append("void getSpecularity() { dSpecularity = vec3(1); }"),u.append(this._addMap("gloss","glossPS",t,n.chunks,d)),f.append("getGlossiness();"),f.append("getSpecularity();"),p.append("litArgs_specularity = dSpecularity;"),p.append("litArgs_gloss = dGlossiness;")):(h.append("vec3 dSpecularity = vec3(0.0);"),h.append("float dGlossiness = 0.0;")),t.aoDetail&&u.append(this._addMap("aoDetail","aoDetailMapPS",t,n.chunks,d)),(t.aoMap||t.aoVertexColor)&&(h.append("float dAo;"),u.append(this._addMap("ao","aoPS",t,n.chunks,d)),f.append("getAO();"),p.append("litArgs_ao = dAo;")),h.append("vec3 dEmission;"),u.append(this._addMap("emissive","emissivePS",t,n.chunks,d,t.emissiveEncoding)),f.append("getEmission();"),p.append("litArgs_emission = dEmission;"),t.litOptions.useClearCoat&&(h.append("float ccSpecularity;"),h.append("float ccGlossiness;"),h.append("vec3 ccNormalW;"),u.append(this._addMap("clearCoat","clearCoatPS",t,n.chunks,d)),u.append(this._addMap("clearCoatGloss","clearCoatGlossPS",t,n.chunks,d)),u.append(this._addMap("clearCoatNormal","clearCoatNormalPS",t,n.chunks,d)),f.append("getClearCoat();"),f.append("getClearCoatGlossiness();"),f.append("getClearCoatNormal();"),p.append("litArgs_clearcoat_specularity = ccSpecularity;"),p.append("litArgs_clearcoat_gloss = ccGlossiness;"),p.append("litArgs_clearcoat_worldNormal = ccNormalW;")),t.lightMap||t.lightVertexColor){const m=t.dirLightMap&&t.litOptions.useSpecular,g=m?"lightmapDirPS":"lightmapSinglePS";h.append("vec3 dLightmap;"),m&&h.append("vec3 dLightmapDir;"),u.append(this._addMap("light",g,t,n.chunks,d,t.lightMapEncoding)),f.append("getLightMap();"),p.append("litArgs_lightmap = dLightmap;"),m&&p.append("litArgs_lightmapDir = dLightmapDir;")}(u.code.indexOf("texture2DSRGB")!==-1||u.code.indexOf("texture2DRGBM")!==-1||u.code.indexOf("texture2DRGBE")!==-1)&&u.prepend(n.chunks.textureSamplePS)}else{const m=t.litOptions.opacityShadowDither;(t.litOptions.alphaTest||m)&&(h.append("float dAlpha;"),u.append(this._addMap("opacity","opacityPS",t,n.chunks,d)),f.append("getOpacity();"),p.append("litArgs_opacity = dAlpha;"),t.litOptions.alphaTest&&(u.append(n.chunks.alphaTestPS),f.append("alphaTest(dAlpha);")),m!==gs&&(m===Hv&&h.append(n.chunks.bayerPS),h.append(`#define DITHER_${m.toUpperCase()}
`),h.append(n.chunks.opacityDitherPS),f.append("opacityDither(dAlpha, 0.0);")))}h.append(n.chunks.litShaderArgsPS),u.append(`void evaluateFrontend() { 
${f.code}
${p.code}
 }
`),f.code="evaluateFrontend();";for(const m in d)h.append(`uniform sampler2D ${d[m]};`);return f.code=`
${f.code.split(`
`).map(m=>`    ${m}`).join(`
`)}

`,n.generateFragmentShader(h.code,u.code,f.code,_),n.getDefinition()}}const km=new EO,fS=(r,e)=>{if(r.length!==e.length)return!1;for(let t=0;t<r.length;++t)if(r[t]!==e[t])return!1;return!0},Qd=r=>r.r!==1||r.g!==1||r.b!==1,CO=r=>r.r!==0||r.g!==0||r.b!==0;class AO{constructor(){this._mapXForms=null}updateMinRef(e,t,s,i,n,a){this._updateSharedOptions(e,t,s,i,n),this._updateMinOptions(e,s),this._updateUVOptions(e,s,i,!0)}updateRef(e,t,s,i,n,a){this._updateSharedOptions(e,t,s,i,n),this._updateEnvOptions(e,s,t),this._updateMaterialOptions(e,s),n===sn&&(e.litOptions.gamma&&(e.litOptions.gamma=Sd),e.litOptions.toneMap=xd),e.litOptions.hasTangents=i&&(i&jy)!==0,this._updateLightOptions(e,t,s,i,a),this._updateUVOptions(e,s,i,!1)}_updateSharedOptions(e,t,s,i,n){e.forceUv1=s.forceUv1,s.userAttributes&&(e.litOptions.userAttributes=Object.fromEntries(s.userAttributes.entries())),e.litOptions.chunks=s.chunks||{},e.litOptions.pass=n,e.litOptions.alphaTest=s.alphaTest>0,e.litOptions.blendType=s.blendType,e.litOptions.screenSpace=i&&(i&Mc)!==0,e.litOptions.skin=i&&(i&Ac)!==0,e.litOptions.useInstancing=i&&(i&Pc)!==0,e.litOptions.useMorphPosition=i&&(i&Ic)!==0,e.litOptions.useMorphNormal=i&&(i&Rc)!==0,e.litOptions.useMorphTextureBased=i&&(i&Lc)!==0,e.litOptions.nineSlicedMode=s.nineSlicedMode||0,t.clusteredLightingEnabled&&s.useLighting?(e.litOptions.clusteredLightingEnabled=!0,e.litOptions.clusteredLightingCookiesEnabled=t.lighting.cookiesEnabled,e.litOptions.clusteredLightingShadowsEnabled=t.lighting.shadowsEnabled,e.litOptions.clusteredLightingShadowType=t.lighting.shadowType,e.litOptions.clusteredLightingAreaLightsEnabled=t.lighting.areaLightsEnabled):(e.litOptions.clusteredLightingEnabled=!1,e.litOptions.clusteredLightingCookiesEnabled=!1,e.litOptions.clusteredLightingShadowsEnabled=!1,e.litOptions.clusteredLightingAreaLightsEnabled=!1)}_updateUVOptions(e,t,s,i){let n=!1,a=!1,o=!1;s&&(n=(s&Ob)!==0,a=(s&Fb)!==0,o=(s&kb)!==0),e.litOptions.vertexColors=!1,this._mapXForms=[];const l={};for(const c in bl)this._updateTexOptions(e,t,c,n,a,o,i,l);this._mapXForms=null,e.litOptions.lightMapEnabled=e.lightMap,e.litOptions.dirLightMapEnabled=e.dirLightMap,e.litOptions.useHeights=e.heightMap,e.litOptions.useNormals=e.normalMap,e.litOptions.useClearCoatNormals=e.clearCoatNormalMap,e.litOptions.useAo=e.aoMap||e.aoVertexColor,e.litOptions.diffuseMapEnabled=e.diffuseMap}_updateTexOptions(e,t,s,i,n,a,o,l){const c=s==="opacity";if(!o||c){const d=s+"Map",h=s+"VertexColor",u=s+"VertexColorChannel",f=d+"Channel",p=d+"Transform",_=d+"Uv",m=d+"Identifier";if(s!=="light"&&(e[d]=!1,e[m]=void 0,e[f]="",e[p]=0,e[_]=0),e[h]=!1,e[u]="",c&&t.blendType===ms&&t.alphaTest===0&&!t.alphaToCoverage&&t.opacityDither===gs)return;if(s!=="height"&&t[h]&&a&&(e[h]=t[h],e[u]=t[u],e.litOptions.vertexColors=!0),t[d]){let g=!0;if(t[_]===0&&!i&&(g=!1),t[_]===1&&!n&&(g=!1),g){const v=t[d].id;let x=l[v];x===void 0&&(l[v]=s,x=s),e[d]=!!t[d],e[m]=x,e[p]=this._getMapTransformID(t.getUniform(p),t[_]),e[f]=t[f],e[_]=t[_]}}}}_updateMinOptions(e,t){e.opacityTint=t.opacity!==1&&(t.blendType!==ms||t.opacityShadowDither!==gs),e.litOptions.opacityShadowDither=t.opacityShadowDither,e.litOptions.lights=[]}_updateMaterialOptions(e,t){var s,i,n,a;const o=(t.diffuseTint||!t.diffuseMap&&!t.diffuseVertexColor)&&Qd(t.diffuse),l=!!(t.useMetalness||t.specularMap||t.sphereMap||t.cubeMap||CO(t.specular)||t.specularityFactor>0&&t.useMetalness||t.enableGGXSpecular||t.clearCoat>0),c=!t.useMetalness||t.useMetalnessSpecularColor,d=l&&(t.specularTint||!t.specularMap&&!t.specularVertexColor)&&Qd(t.specular),h=l&&t.useMetalnessSpecularColor&&(t.specularityFactorTint||t.specularityFactor<1&&!t.specularityFactorMap),u=!t.emissiveMap||Qd(t.emissive)&&t.emissiveTint,f=t.emissiveIntensity!==1,p=t.normalMap?t.normalMap.format===ql||t.normalMap.type===Ll:!1;e.opacityTint=t.opacity!==1&&(t.blendType!==ms||t.alphaTest>0||t.opacityDither!==gs)?1:0,e.ambientTint=t.ambientTint,e.diffuseTint=o?2:0,e.specularTint=d?2:0,e.specularityFactorTint=h?1:0,e.metalnessTint=t.useMetalness&&t.metalness<1?1:0,e.glossTint=1,e.emissiveTint=(u?2:0)+(f?1:0),e.diffuseEncoding=(s=t.diffuseMap)==null?void 0:s.encoding,e.diffuseDetailEncoding=(i=t.diffuseDetailMap)==null?void 0:i.encoding,e.emissiveEncoding=(n=t.emissiveMap)==null?void 0:n.encoding,e.lightMapEncoding=(a=t.lightMap)==null?void 0:a.encoding,e.packedNormal=p,e.refractionTint=t.refraction!==1?1:0,e.refractionIndexTint=t.refractionIndex!==1/1.5?1:0,e.thicknessTint=t.useDynamicRefraction&&t.thickness!==1?1:0,e.specularEncoding=t.specularEncoding||"linear",e.sheenEncoding=t.sheenEncoding||"linear",e.aoMapUv=t.aoUvSet,e.aoDetail=!!t.aoMap,e.diffuseDetail=!!t.diffuseMap,e.normalDetail=!!t.normalMap,e.diffuseDetailMode=t.diffuseDetailMode,e.aoDetailMode=t.aoDetailMode,e.clearCoatTint=t.clearCoat!==1?1:0,e.clearCoatGloss=!!t.clearCoatGloss,e.clearCoatGlossTint=t.clearCoatGloss!==1?1:0,e.iorTint=t.refractionIndex!==1/1.5?1:0,e.iridescenceTint=t.iridescence!==1?1:0,e.sheenTint=t.useSheen&&Qd(t.sheen)?2:0,e.sheenGlossTint=1,e.glossInvert=t.glossInvert,e.sheenGlossInvert=t.sheenGlossInvert,e.clearCoatGlossInvert=t.clearCoatGlossInvert,e.useSpecularColor=c,e.litOptions.separateAmbient=!1,e.litOptions.useAmbientTint=t.ambientTint,e.litOptions.customFragmentShader=t.customFragmentShader,e.litOptions.pixelSnap=t.pixelSnap,e.litOptions.shadingModel=t.shadingModel,e.litOptions.ambientSH=!!t.ambientSH,e.litOptions.fastTbn=t.fastTbn,e.litOptions.twoSidedLighting=t.twoSidedLighting,e.litOptions.occludeSpecular=t.occludeSpecular,e.litOptions.occludeSpecularFloat=t.occludeSpecularIntensity!==1,e.litOptions.useMsdf=!!t.msdfMap,e.litOptions.msdfTextAttribute=!!t.msdfTextAttribute,e.litOptions.alphaToCoverage=t.alphaToCoverage,e.litOptions.opacityFadesSpecular=t.opacityFadesSpecular,e.litOptions.opacityDither=t.opacityDither,e.litOptions.cubeMapProjection=t.cubeMapProjection,e.litOptions.occludeDirect=t.occludeDirect,e.litOptions.conserveEnergy=t.conserveEnergy&&t.shadingModel!==tn,e.litOptions.useSpecular=l,e.litOptions.useSpecularityFactor=(h||!!t.specularityFactorMap)&&t.useMetalnessSpecularColor,e.litOptions.enableGGXSpecular=t.enableGGXSpecular,e.litOptions.fresnelModel=t.fresnelModel,e.litOptions.useRefraction=(t.refraction||!!t.refractionMap)&&(t.useDynamicRefraction||!!e.litOptions.reflectionSource),e.litOptions.useClearCoat=!!t.clearCoat,e.litOptions.useSheen=t.useSheen,e.litOptions.useIridescence=t.useIridescence&&t.iridescence!==0,e.litOptions.useMetalness=t.useMetalness,e.litOptions.useDynamicRefraction=t.useDynamicRefraction}_updateEnvOptions(e,t,s){e.litOptions.fog=t.useFog?s.fog:"none",e.litOptions.gamma=t.useGammaTonemap?s.gammaCorrection:vd,e.litOptions.toneMap=t.useGammaTonemap?s.toneMapping:-1,e.litOptions.fixSeams=t.cubeMap?t.cubeMap.fixCubemapSeams:!1;const i=t.shadingModel===tn;let n=!1;if(t.envAtlas&&t.cubeMap&&!i?(e.litOptions.reflectionSource="envAtlasHQ",e.litOptions.reflectionEncoding=t.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=t.cubeMap.encoding):t.envAtlas&&!i?(e.litOptions.reflectionSource="envAtlas",e.litOptions.reflectionEncoding=t.envAtlas.encoding):t.cubeMap?(e.litOptions.reflectionSource="cubeMap",e.litOptions.reflectionEncoding=t.cubeMap.encoding):t.sphereMap?(e.litOptions.reflectionSource="sphereMap",e.litOptions.reflectionEncoding=t.sphereMap.encoding):t.useSkybox&&s.envAtlas&&s.skybox&&!i?(e.litOptions.reflectionSource="envAtlasHQ",e.litOptions.reflectionEncoding=s.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=s.skybox.encoding,n=!0):t.useSkybox&&s.envAtlas&&!i?(e.litOptions.reflectionSource="envAtlas",e.litOptions.reflectionEncoding=s.envAtlas.encoding,n=!0):t.useSkybox&&s.skybox?(e.litOptions.reflectionSource="cubeMap",e.litOptions.reflectionEncoding=s.skybox.encoding,n=!0):(e.litOptions.reflectionSource=null,e.litOptions.reflectionEncoding=null),t.ambientSH&&!i)e.litOptions.ambientSource="ambientSH",e.litOptions.ambientEncoding=null;else{const a=t.envAtlas||(t.useSkybox&&s.envAtlas?s.envAtlas:null);a&&!i?(e.litOptions.ambientSource="envAtlas",e.litOptions.ambientEncoding=a.encoding):(e.litOptions.ambientSource="constant",e.litOptions.ambientEncoding=null)}e.litOptions.skyboxIntensity=n&&(s.skyboxIntensity!==1||s.physicalUnits),e.litOptions.useCubeMapRotation=n&&s._skyboxRotationShaderInclude}_updateLightOptions(e,t,s,i,n){if(e.lightMap=!1,e.lightMapChannel="",e.lightMapUv=0,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!1,e.dirLightMap=!1,i&&(e.litOptions.noShadow=(i&of)!==0,i&lf&&(e.lightMapEncoding=t.lightmapPixelFormat===xe?"rgbm":"linear",e.lightMap=!0,e.lightMapChannel="rgb",e.lightMapUv=1,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!s.lightMap,i&Wy&&(e.dirLightMap=!0),i&$y&&(e.litOptions.lightMapWithoutAmbient=!1))),s.useLighting){const a=[],o=i?i>>16:Fs;e.litOptions.lightMaskDynamic=!!(o&Fs),n&&(vi.collectLights(fe,n[fe],a,o),vi.collectLights(Oe,n[Oe],a,o),vi.collectLights(Ge,n[Ge],a,o)),e.litOptions.lights=a}else e.litOptions.lights=[];e.litOptions.lights.length===0&&(e.litOptions.noShadow=!0)}_getMapTransformID(e,t){if(!e)return 0;let s=this._mapXForms[t];s||(s=[],this._mapXForms[t]=s);for(let i=0;i<s.length;i++)if(fS(s[i][0].value,e[0].value)&&fS(s[i][1].value,e[1].value))return i+1;return s.push(e)}}function ot(r,e=!0,t=!0){const s={};return s[`${r}Map`]="texture",s[`${r}MapTiling`]="vec2",s[`${r}MapOffset`]="vec2",s[`${r}MapRotation`]="number",s[`${r}MapUv`]="number",e&&(s[`${r}MapChannel`]="string",t&&(s[`${r}VertexColor`]="boolean",s[`${r}VertexColorChannel`]="string")),s}const Hl=Ft({name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean"},ot("ao"),ot("aoDetail",!0,!1),{aoDetailMode:"string",diffuse:"rgb",diffuseTint:"boolean"},ot("diffuse"),ot("diffuseDetail",!0,!1),{diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean"},ot("specular"),{occludeSpecular:"enum:occludeSpecular",specularityFactor:"number",specularityFactorTint:"boolean"},ot("specularityFactor"),{useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean"},ot("metalness"),{useMetalnessSpecularColor:"boolean",conserveEnergy:"boolean",shininess:"number",gloss:"number",glossInvert:"boolean"},ot("gloss"),{clearCoat:"number"},ot("clearCoat"),{clearCoatGloss:"number",clearCoatGlossInvert:"boolean"},ot("clearCoatGloss"),{clearCoatBumpiness:"number"},ot("clearCoatNormal",!1),{useSheen:"boolean",sheen:"rgb",sheenTint:"boolean"},ot("sheen"),{sheenGloss:"number",sheenGlossTint:"boolean",sheenGlossInvert:"boolean"},ot("sheenGloss"),{fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean"},ot("emissive"),{emissiveIntensity:"number"},ot("normal",!1),{bumpiness:"number"},ot("normalDetail",!1),{normalDetailMapBumpiness:"number"},ot("height",!0,!1),{heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number"},ot("opacity"),{opacityFadesSpecular:"boolean",opacityDither:"string",opacityShadowDither:"string",reflectivity:"number",refraction:"number",refractionTint:"boolean"},ot("refraction"),{refractionIndex:"number",thickness:"number",thicknessTint:"boolean"},ot("thickness"),{attenuation:"rgb",attenuationDistance:"number",useDynamicRefraction:"boolean",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",useIridescence:"boolean",iridescence:"number",iridescenceTint:"boolean"},ot("iridescence"),{iridescenceThicknessTint:"boolean",iridescenceThicknessMin:"number",iridescenceThicknessMax:"number",iridescenceRefractionIndex:"number"},ot("iridescenceThickness"),ot("light"),{depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",envAtlas:"texture",twoSidedLighting:"boolean"}),Yp=[];for(const r in Hl)Hl[r]==="texture"&&Yp.push(r);const Qy=[];for(const r in Hl)Hl[r]==="cubemap"&&Qy.push(r);const PO={aoMapVertexColor:"boolean",diffuseMapTint:"boolean",diffuseMapVertexColor:"boolean",emissiveMapTint:"boolean",emissiveMapVertexColor:"boolean",glossMapVertexColor:"boolean",metalnessMapVertexColor:"boolean",opacityMapVertexColor:"boolean",specularAntialias:"boolean",specularMapTint:"boolean",specularMapVertexColor:"boolean"},Hu={},qb={};let gh=new Set;class Gs extends Jt{constructor(){super(),this.userAttributes=new Map,this._dirtyShader=!0,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new AO,this.reset()}reset(){Object.keys(Hu).forEach(e=>{this[`_${e}`]=Hu[e].value()}),this._chunks={},this._uniformCache={}}set shader(e){}get shader(){return null}set chunks(e){this._dirtyShader=!0,this._chunks=e}get chunks(){return this._dirtyShader=!0,this._chunks}copy(e){super.copy(e),Object.keys(Hu).forEach(t=>{this[t]=e[t]});for(const t in e._chunks)e._chunks.hasOwnProperty(t)&&(this._chunks[t]=e._chunks[t]);return this}setAttribute(e,t){this.userAttributes.set(t,e)}_setParameter(e,t){gh.add(e),this.setParameter(e,t)}_setParameters(e){e.forEach(t=>{this._setParameter(t.name,t.value)})}_processParameters(e){const t=this[e];t.forEach(s=>{gh.has(s)||delete this.parameters[s]}),this[e]=gh,gh=t,gh.clear()}_updateMap(e){const t=e+"Map",s=this[t];if(s){this._setParameter("texture_"+t,s);const i=t+"Transform",n=this.getUniform(i);n&&this._setParameters(n)}}_allocUniform(e,t){let s=this._uniformCache[e];return s||(s=t(),this._uniformCache[e]=s),s}getUniform(e,t,s){return qb[e](this,t,s)}updateUniforms(e,t){const s=n=>this.getUniform(n,e,t);this._setParameter("material_ambient",s("ambient")),(!this.diffuseMap||this.diffuseTint)&&this._setParameter("material_diffuse",s("diffuse")),this.useMetalness?((!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),(!this.specularMap||this.specularTint)&&this._setParameter("material_specular",s("specular")),(!this.specularityFactorMap||this.specularityFactorTint)&&this._setParameter("material_specularityFactor",this.specularityFactor),(!this.sheenMap||this.sheenTint)&&this._setParameter("material_sheen",s("sheen")),(!this.sheenGlossMap||this.sheenGlossTint)&&this._setParameter("material_sheenGloss",this.sheenGloss),this._setParameter("material_refractionIndex",this.refractionIndex)):(!this.specularMap||this.specularTint)&&this._setParameter("material_specular",s("specular")),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGloss",this.clearCoatGloss),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_gloss",s("gloss")),(!this.emissiveMap||this.emissiveTint)&&this._setParameter("material_emissive",s("emissive")),this.emissiveIntensity!==1&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&this._setParameter("material_refraction",this.refraction),this.useDynamicRefraction&&(this._setParameter("material_thickness",this.thickness),this._setParameter("material_attenuation",s("attenuation")),this._setParameter("material_invAttenuationDistance",this.attenuationDistance===0?0:1/this.attenuationDistance)),this.useIridescence&&(this._setParameter("material_iridescence",this.iridescence),this._setParameter("material_iridescenceRefractionIndex",this.iridescenceRefractionIndex),this._setParameter("material_iridescenceThicknessMin",this.iridescenceThicknessMin),this._setParameter("material_iridescenceThicknessMax",this.iridescenceThicknessMax)),this._setParameter("material_opacity",this.opacity),this.opacityFadesSpecular===!1&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),this.cubeMapProjection===mI&&this._setParameter(s("cubeMapProjectionBox"));for(const n in bl)this._updateMap(n);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",s("heightMapFactor"));const i=this.shadingModel===tn;this.envAtlas&&this.cubeMap&&!i?(this._setParameter("texture_envAtlas",this.envAtlas),this._setParameter("texture_cubeMap",this.cubeMap)):this.envAtlas&&!i?this._setParameter("texture_envAtlas",this.envAtlas):this.cubeMap?this._setParameter("texture_cubeMap",this.cubeMap):this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),this._dirtyShader&&this.clearVariants()}updateEnvUniforms(e,t){const s=this.shadingModel===tn;!(this.envAtlas&&!s||this.cubeMap||this.sphereMap)&&this.useSkybox&&(t.envAtlas&&t.skybox&&!s?(this._setParameter("texture_envAtlas",t.envAtlas),this._setParameter("texture_cubeMap",t.skybox)):t.envAtlas&&!s?this._setParameter("texture_envAtlas",t.envAtlas):t.skybox&&this._setParameter("texture_cubeMap",t.skybox)),this._processParameters("_activeLightingParams")}getShaderVariant(e,t,s,i,n,a,o,l,c){this.updateEnvUniforms(e,t);const d=Ii.get(e).getByIndex(n),h=n===Xi||n===bd||n===hf||d.isShadow;let u=h?km.optionsContextMin:km.optionsContext;h?this.shaderOptBuilder.updateMinRef(u,t,this,s,n,a):this.shaderOptBuilder.updateRef(u,t,this,s,n,a),this.onUpdateShader&&(u=this.onUpdateShader(u));const f=new lo(o,l,c),p=cn(e);p.register("standard",km);const _=p.getProgram("standard",u,f,this.userId);return this._dirtyShader=!1,_}destroy(){for(const e in this._assetReferences)this._assetReferences[e]._unbind();this._assetReferences=null,super.destroy()}}Gs.TEXTURE_PARAMETERS=Yp;Gs.CUBEMAP_PARAMETERS=Qy;const Zp=(r,e)=>{qb[r]=e},e0=(r,e,t,s)=>{Object.defineProperty(Gs.prototype,r,{get:s||function(){return this[`_${r}`]},set:t}),Hu[r]={value:e}},MO=r=>{const e=`_${r.name}`,t=r.dirtyShaderFunc||(()=>!0),s=function(n){const a=this[e];a!==n&&(this._dirtyShader=this._dirtyShader||t(a,n),this[e]=n)};e0(r.name,()=>r.defaultValue,s,r.getterFunc)},IO=r=>{const e=`_${r.name}`,t=r.dirtyShaderFunc||(()=>!0),s=function(n){const a=this[e];a.equals(n)||(this._dirtyShader=this._dirtyShader||t(a,n),this[e]=a.copy(n))};e0(r.name,()=>r.defaultValue.clone(),s,r.getterFunc)},Qs=r=>r.defaultValue&&r.defaultValue.clone?IO(r):MO(r);function it(r,e="rgb",t=!0,s=0){bl[r]=e.length||-1,Qs({name:`${r}Map`,defaultValue:null,dirtyShaderFunc:(l,c)=>!!l!=!!c||l&&(l.type!==c.type||l.fixCubemapSeams!==c.fixCubemapSeams||l.format!==c.format)}),Qs({name:`${r}MapTiling`,defaultValue:new M(1,1)}),Qs({name:`${r}MapOffset`,defaultValue:new M(0,0)}),Qs({name:`${r}MapRotation`,defaultValue:0}),Qs({name:`${r}MapUv`,defaultValue:s}),e&&(Qs({name:`${r}MapChannel`,defaultValue:e}),t&&(Qs({name:`${r}VertexColor`,defaultValue:!1}),Qs({name:`${r}VertexColorChannel`,defaultValue:e})));const i=`${r}MapTiling`,n=`${r}MapOffset`,a=`${r}MapRotation`,o=`${r}MapTransform`;Zp(o,(l,c,d)=>{const h=l[i],u=l[n],f=l[a];if(h.x===1&&h.y===1&&u.x===0&&u.y===0&&f===0)return null;const p=l._allocUniform(o,()=>[{name:`texture_${o}0`,value:new Float32Array(3)},{name:`texture_${o}1`,value:new Float32Array(3)}]),_=Math.cos(f*H.DEG_TO_RAD),m=Math.sin(f*H.DEG_TO_RAD),g=p[0].value;g[0]=_*h.x,g[1]=-m*h.y,g[2]=u.x;const v=p[1].value;return v[0]=m*h.x,v[1]=_*h.y,v[2]=1-h.y-u.y,p})}function bo(r,e){Qs({name:r,defaultValue:e,getterFunc:function(){return this._dirtyShader=!0,this[`_${r}`]}}),Zp(r,(t,s,i)=>{const n=t._allocUniform(r,()=>new Float32Array(3)),a=t[r];return t.useGammaTonemap&&i.gammaCorrection?(n[0]=Math.pow(a.r,2.2),n[1]=Math.pow(a.g,2.2),n[2]=Math.pow(a.b,2.2)):(n[0]=a.r,n[1]=a.g,n[2]=a.b),n})}function qe(r,e,t){Qs({name:r,defaultValue:e,dirtyShaderFunc:(s,i)=>(s===0||s===1)!=(i===0||i===1)}),Zp(r,t)}function yh(r,e){Qs({name:r,defaultValue:null,dirtyShaderFunc:(t,s)=>!!t==!!s}),Zp(r,e)}function Ae(r,e){Qs({name:r,defaultValue:e})}function RO(){bo("ambient",new k(.7,.7,.7)),bo("diffuse",new k(1,1,1)),bo("specular",new k(0,0,0)),bo("emissive",new k(0,0,0)),bo("sheen",new k(1,1,1)),bo("attenuation",new k(1,1,1)),qe("emissiveIntensity",1),qe("specularityFactor",1),qe("sheenGloss",0),qe("gloss",.25,(s,i,n)=>s.shadingModel===tn?Math.pow(2,s.gloss*11):s.gloss),qe("heightMapFactor",1,(s,i,n)=>s.heightMapFactor*.025),qe("opacity",1),qe("alphaFade",1),qe("alphaTest",0),qe("bumpiness",1),qe("normalDetailMapBumpiness",1),qe("reflectivity",1),qe("occludeSpecularIntensity",1),qe("refraction",0),qe("refractionIndex",1/1.5),qe("thickness",0),qe("attenuationDistance",0),qe("metalness",1),qe("anisotropy",0),qe("clearCoat",0),qe("clearCoatGloss",1),qe("clearCoatBumpiness",1),qe("aoUvSet",0,null),qe("iridescence",0),qe("iridescenceRefractionIndex",1/1.5),qe("iridescenceThicknessMin",0),qe("iridescenceThicknessMax",0),yh("ambientSH"),yh("cubeMapProjectionBox",(s,i,n)=>{const a=s._allocUniform("cubeMapProjectionBox",()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}]),o=s.cubeMapProjectionBox.getMin(),l=a[0].value;l[0]=o.x,l[1]=o.y,l[2]=o.z;const c=s.cubeMapProjectionBox.getMax(),d=a[1].value;return d[0]=c.x,d[1]=c.y,d[2]=c.z,a}),Ae("ambientTint",!1),Ae("diffuseTint",!1),Ae("specularTint",!1),Ae("specularityFactorTint",!1),Ae("emissiveTint",!1),Ae("fastTbn",!1),Ae("useMetalness",!1),Ae("useMetalnessSpecularColor",!1),Ae("useSheen",!1),Ae("enableGGXSpecular",!1),Ae("occludeDirect",!1),Ae("normalizeNormalMap",!0),Ae("conserveEnergy",!0),Ae("opacityFadesSpecular",!0),Ae("occludeSpecular",Cc),Ae("shadingModel",yd),Ae("fresnelModel",Uy),Ae("useDynamicRefraction",!1),Ae("cubeMapProjection",Db),Ae("customFragmentShader",null),Ae("useFog",!0),Ae("useLighting",!0),Ae("useGammaTonemap",!0),Ae("useSkybox",!0),Ae("forceUv1",!1),Ae("pixelSnap",!1),Ae("twoSidedLighting",!1),Ae("nineSlicedMode",void 0),Ae("msdfTextAttribute",!1),Ae("useIridescence",!1),Ae("glossInvert",!1),Ae("sheenGlossInvert",!1),Ae("clearCoatGlossInvert",!1),Ae("opacityDither",gs),Ae("opacityShadowDither",gs),it("diffuse"),it("specular"),it("emissive"),it("thickness","g"),it("specularityFactor","g"),it("normal",""),it("metalness","g"),it("gloss","g"),it("opacity","a"),it("refraction","g"),it("height","g",!1),it("ao","g"),it("light","rgb",!0,1),it("msdf",""),it("diffuseDetail","rgb",!1),it("normalDetail",""),it("aoDetail","g",!1),it("clearCoat","g"),it("clearCoatGloss","g"),it("clearCoatNormal",""),it("sheen","rgb"),it("sheenGloss","g"),it("iridescence","g"),it("iridescenceThickness","g"),Ae("diffuseDetailMode",Vv),Ae("aoDetailMode",Vv),yh("cubeMap"),yh("sphereMap"),yh("envAtlas");const r=function(){return this._prefilteredCubemaps},e=function(i){const n=this._prefilteredCubemaps;i=i||[];let a=!1,o=!0;for(let l=0;l<6;++l){const c=i[l]||null;n[l]!==c&&(n[l]=c,a=!0),o=o&&!!n[l]}a&&(o?this.envAtlas=Xb.generatePrefilteredAtlas(n,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)},t=[null,null,null,null,null,null];e0("prefilteredCubemaps",()=>t.slice(),e,r)}RO();new y(1,1,1);new y(40,0,0);class Za{constructor(e,t){this.texture=e,this.cached=!1,this.renderTargets=t}destroy(){this.texture&&(this.texture.destroy(),this.texture=null);const e=this.renderTargets;for(let t=0;t<e.length;t++)e[t].destroy();this.renderTargets.length=0}static getShadowFormat(e,t){return t===si?rt:t===Si?yt:t===wi||(t===Wi||t===xt)&&e.supportsDepthShadow?Ha:t===ss&&!e.isWebGL1?Bn:xe}static getShadowFiltering(e,t){return(t===Wi||t===xt||t===ss)&&!e.supportsDepthShadow?Ee:t===si?e.extTextureFloatLinear?nt:Ee:t===Si?e.extTextureHalfFloatLinear?nt:Ee:nt}static create(e,t){let s=null;return t._type===Oe?s=this.createCubemap(e,t._shadowResolution,t._shadowType):s=this.create2dMap(e,t._shadowResolution,t._shadowType),s}static createAtlas(e,t,s){const i=this.create2dMap(e,t,s),n=i.renderTargets,a=n[0];for(let o=0;o<5;o++)n.push(a);return i}static create2dMap(e,t,s){const i=this.getShadowFormat(e,s),n=this.getShadowFiltering(e,s),a=new _e(e,{format:i,width:t,height:t,mipmaps:!1,minFilter:n,magFilter:n,addressU:ae,addressV:ae,name:"ShadowMap2D"});let o=null;return s===wi||(s===Wi||s===xt)&&e.supportsDepthShadow?(a.compareOnRead=!0,a.compareFunc=_y,o=new Ct({depthBuffer:a})):o=new Ct({colorBuffer:a,depth:!0}),e.isWebGPU&&(o.flipY=!0),new Za(a,[o])}static createCubemap(e,t,s){const i=s===ss&&!e.isWebGL1?Bn:xe,n=new _e(e,{format:i,width:t,height:t,cubemap:!0,mipmaps:!1,minFilter:Ee,magFilter:Ee,addressU:ae,addressV:ae,name:"ShadowMapCube"}),a=[];for(let o=0;o<6;o++){const l=new Ct({colorBuffer:n,face:o,depth:!0});a.push(l)}return new Za(n,a)}}const LO=[],DO=[],un=new P,Bm=new P;class Nm{constructor(e){this.size=Math.floor(e.w*1024),this.used=!1,this.lightId=-1,this.rect=e}}class OO{constructor(e){this.device=e,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=4,this.cookieAtlas=new _e(this.device,{name:"CookieAtlas",width:this.cookieAtlasResolution,height:this.cookieAtlasResolution,format:xe,cubemap:!1,mipmaps:!1,minFilter:Ee,magFilter:Ee,addressU:ae,addressV:ae}),this.cookieRenderTarget=new Ct({colorBuffer:this.cookieAtlas,depth:!1,flipY:!0}),this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new M(0,0),new M(0,1),new M(1,0),new M(1,1),new M(2,0),new M(2,1)],this.scissorVec=new P,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms()}destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas()}destroyShadowAtlas(){var e;(e=this.shadowAtlas)==null||e.destroy(),this.shadowAtlas=null}destroyCookieAtlas(){var e,t;(e=this.cookieAtlas)==null||e.destroy(),this.cookieAtlas=null,(t=this.cookieRenderTarget)==null||t.destroy(),this.cookieRenderTarget=null}allocateShadowAtlas(e){if(!this.shadowAtlas||this.shadowAtlas.texture.width!==e){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=Za.createAtlas(this.device,e,xt),this.shadowAtlas.cached=!0;const t=4/this.shadowAtlasResolution;this.scissorVec.set(t,t,-2*t,-2*t)}}allocateCookieAtlas(e){this.cookieAtlas.width!==e&&(this.cookieRenderTarget.resize(e,e),this.version++)}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture")}updateUniforms(){const t=this.shadowAtlas.renderTargets[0],i=!this.device.isWebGL1&&!0?t.depthBuffer:t.colorBuffer;this._shadowAtlasTextureId.setValue(i),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas)}subdivide(e,t){let s=t.atlasSplit;if(!s){const n=Math.ceil(Math.sqrt(e));s=DO,s[0]=n,s.length=1}if(!((n,a)=>n.length===a.length&&n.every((o,l)=>o===a[l]))(s,this.atlasSplit)){this.version++,this.slots.length=0,this.atlasSplit.length=0,this.atlasSplit.push(...s);const n=this.atlasSplit[0];if(n>1){const a=1/n;for(let o=0;o<n;o++)for(let l=0;l<n;l++){const c=new P(o*a,l*a,a,a),d=this.atlasSplit[1+o*n+l];if(d>1)for(let h=0;h<d;h++)for(let u=0;u<d;u++){const f=a/d,p=new P(c.x+h*f,c.y+u*f,f,f);this.slots.push(new Nm(p))}else this.slots.push(new Nm(c))}}else this.slots.push(new Nm(new P(0,0,1,1)));this.slots.sort((a,o)=>o.size-a.size)}}collectLights(e,t){const s=t.cookiesEnabled,i=t.shadowsEnabled;let n=!1,a=!1;const o=LO;return o.length=0,(s||i)&&(c=>{for(let d=0;d<c.length;d++){const h=c[d];if(h.visibleThisFrame){const u=i&&h.castShadows,f=s&&!!h.cookie;n||(n=u),a||(a=f),(u||f)&&o.push(h)}}})(e),o.sort((c,d)=>d.maxScreenSize-c.maxScreenSize),n&&this.allocateShadowAtlas(this.shadowAtlasResolution),a&&this.allocateCookieAtlas(this.cookieAtlasResolution),(n||a)&&this.subdivide(o.length,t),o}setupSlot(e,t){e.atlasViewport.copy(t);const s=e.numShadowFaces;for(let i=0;i<s;i++)if(e.castShadows||e._cookie){if(un.copy(t),Bm.copy(t),e._type===Ge&&un.add(this.scissorVec),e._type===Oe){const n=un.z/3,a=this.cubeSlotsOffsets[i];un.x+=n*a.x,un.y+=n*a.y,un.z=n,un.w=n,Bm.copy(un)}if(e.castShadows){const n=e.getRenderData(null,i);n.shadowViewport.copy(un),n.shadowScissor.copy(Bm)}}}assignSlot(e,t,s){e.atlasViewportAllocated=!0;const i=this.slots[t];i.lightId=e.id,i.used=!0,s&&(e.atlasSlotUpdated=!0,e.atlasVersion=this.version,e.atlasSlotIndex=t)}update(e,t){this.shadowAtlasResolution=t.shadowAtlasResolution,this.cookieAtlasResolution=t.cookieAtlasResolution;const s=this.collectLights(e,t);if(s.length>0){const i=this.slots;for(let o=0;o<i.length;o++)i[o].used=!1;const n=Math.min(s.length,i.length);for(let o=0;o<n;o++){const l=s[o];l.castShadows&&(l._shadowMap=this.shadowAtlas);const c=i[l.atlasSlotIndex];if(l.atlasVersion===this.version&&l.id===(c==null?void 0:c.lightId)){const d=i[l.atlasSlotIndex];d.size===i[o].size&&!d.used&&this.assignSlot(l,l.atlasSlotIndex,!1)}}let a=0;for(let o=0;o<n;o++){for(;a<i.length&&i[a].used;)a++;const l=s[o];l.atlasViewportAllocated||this.assignSlot(l,a,!0);const c=i[l.atlasSlotIndex];this.setupSlot(l,c.rect)}}this.updateUniforms()}}const FO=[new y(-1,0,0),new y(1,0,0),new y(0,-1,0),new y(0,1,0),new y(0,0,-1),new y(0,0,1)];class kO{constructor(){this.colors=new Float32Array(6*3)}update(e,t){const s=this.colors,{r:i,g:n,b:a}=e;for(let o=0;o<6;o++)s[o*3]=i,s[o*3+1]=n,s[o*3+2]=a;for(let o=0;o<t.length;o++){const l=t[o];if(l._type===fe)for(let c=0;c<6;c++){const d=Math.max(FO[c].dot(l._direction),0)*l._intensity,h=l._color;s[c*3]+=h.r*d,s[c*3+1]+=h.g*d,s[c*3+2]+=h.b*d}}}}class BO{constructor(){this.cache=new Map}destroy(){this.clear(),this.cache=null}clear(){this.cache.forEach(e=>{e.forEach(t=>{t.destroy()})}),this.cache.clear()}getKey(e){const t=e._type===Oe,s=e._shadowType,i=e._shadowResolution;return`${t}-${s}-${i}`}get(e,t){const s=this.getKey(t),i=this.cache.get(s);if(i&&i.length)return i.pop();const n=Za.create(e,t);return n.cached=!0,n}add(e,t){const s=this.getKey(e),i=this.cache.get(s);i?i.push(t):this.cache.set(s,[t])}}class NO extends Hs{constructor(e,t,s,i,n){super(e),this.requiresCubemaps=!1,this.shadowRenderer=t,this.light=s,this.face=i,this.applyVsm=n,this.shadowCamera=t.prepareFace(s,null,i),t.setupRenderPass(this,this.shadowCamera,!0)}execute(){this.shadowRenderer.renderFace(this.light,null,this.face,!1)}after(){this.applyVsm&&this.shadowRenderer.renderVsm(this.light,this.shadowCamera)}}class UO{constructor(e,t){this.shadowLights=[],this.renderer=void 0,this.shadowRenderer=void 0,this.device=void 0,this.renderer=e,this.shadowRenderer=t,this.device=e.device}cull(e,t,s=null){const i=this.renderer.scene.clusteredLightingEnabled;e.visibleThisFrame=!0,i||e._shadowMap||(e._shadowMap=Za.create(this.device,e));const n=e._type,a=n===Ge?1:6;for(let o=0;o<a;o++){const l=e.getRenderData(null,o),c=l.shadowCamera;c.nearClip=e.attenuationEnd/1e3,c.farClip=e.attenuationEnd,l.depthRangeCompensation=c.farClip-c.nearClip;const d=c._node,h=e._node;if(d.setPosition(h.getPosition()),n===Ge)c.fov=e._outerConeAngle*2,d.setRotation(h.getRotation()),d.rotateLocal(-90,0,0);else if(n===Oe)if(i){const p=2/(this.shadowRenderer.lightTextureAtlas.shadowAtlasResolution*e.atlasViewport.z/3)*this.shadowRenderer.lightTextureAtlas.shadowEdgePixels;c.fov=Math.atan(1+p)*H.RAD_TO_DEG*2}else c.fov=90;this.renderer.updateCameraFrustum(c),this.shadowRenderer.cullShadowCasters(t,e,l.visibleCasters,c,s)}}prepareLights(e,t){let s;for(let i=0;i<t.length;i++){const n=t[i];if(this.shadowRenderer.needsShadowRendering(n)&&n.atlasViewportAllocated){e.push(n);for(let a=0;a<n.numShadowFaces;a++)s=this.shadowRenderer.prepareFace(n,null,a)}}return s}buildNonClusteredRenderPasses(e,t){for(let s=0;s<t.length;s++){const i=t[s];if(this.shadowRenderer.needsShadowRendering(i)){const n=i._type===Ge,a=i.numShadowFaces;for(let o=0;o<a;o++){const l=new NO(this.device,this.shadowRenderer,i,o,n);e.addRenderPass(l)}}}}}class zO extends Hs{constructor(e,t,s,i,n){super(e),this.shadowRenderer=t,this.light=s,this.camera=i,this.allCascadesRendering=n}execute(){const{light:e,camera:t,shadowRenderer:s,allCascadesRendering:i}=this,n=e.numShadowFaces,a=e.shadowUpdateOverrides;for(let o=0;o<n;o++)(a==null?void 0:a[o])!==Ci&&s.renderFace(e,t,o,!i),(a==null?void 0:a[o])===Ka&&(a[o]=Ci)}after(){this.shadowRenderer.renderVsm(this.light,this.camera)}}const eu=new Re,fn=new y,pS=new q,We=[new y,new y,new y,new y,new y,new y,new y,new y],Um={min:0,max:0};function VO(r,e,t){We[0].x=We[1].x=We[2].x=We[3].x=e.x,We[1].y=We[3].y=We[7].y=We[5].y=e.y,We[2].z=We[3].z=We[6].z=We[7].z=e.z,We[4].x=We[5].x=We[6].x=We[7].x=t.x,We[0].y=We[2].y=We[4].y=We[6].y=t.y,We[0].z=We[1].z=We[4].z=We[5].z=t.z;let s=9999999999,i=-9999999999;for(let n=0;n<8;++n){r.transformPoint(We[n],We[n]);const a=We[n].z;a<s&&(s=a),a>i&&(i=a)}return Um.min=s,Um.max=i,Um}class GO{constructor(e,t){this.renderer=void 0,this.shadowRenderer=void 0,this.device=void 0,this.renderer=e,this.shadowRenderer=t,this.device=e.device}cull(e,t,s,i=null){e.visibleThisFrame=!0,e._shadowMap||(e._shadowMap=Za.create(this.device,e));const n=s._nearClip;this.generateSplitDistances(e,n,Math.min(s._farClip,e.shadowDistance));const a=e.shadowUpdateOverrides;for(let o=0;o<e.numCascades&&(a==null?void 0:a[o])!==Ci;o++){const l=e.getRenderData(s,o),c=l.shadowCamera;c.renderTarget=e._shadowMap.renderTargets[0],l.shadowViewport.copy(e.cascades[o]),l.shadowScissor.copy(e.cascades[o]);const d=c._node,h=e._node;d.setPosition(h.getPosition()),d.setRotation(h.getRotation()),d.rotateLocal(-90,0,0);const u=o===0?n:e._shadowCascadeDistances[o-1],f=e._shadowCascadeDistances[o],p=s.getFrustumCorners(u,f);fn.set(0,0,0);const _=s.node.getWorldTransform();for(let I=0;I<8;I++)_.transformPoint(p[I],p[I]),fn.add(p[I]);fn.mulScalar(1/8);let m=0;for(let I=0;I<8;I++){const F=p[I].sub(fn).length();F>m&&(m=F)}const g=d.right,v=d.up,x=d.forward,S=.25*e._shadowResolution/m,w=Math.ceil(fn.dot(v)*S)/S,T=Math.ceil(fn.dot(g)*S)/S,b=v.mulScalar(w),C=g.mulScalar(T),E=fn.dot(x),R=x.mulScalar(E);fn.add2(b,C).add(R),d.setPosition(fn),d.translateLocal(0,0,1e6),c.nearClip=.01,c.farClip=2e6,c.orthoHeight=m,this.renderer.updateCameraFrustum(c),this.shadowRenderer.cullShadowCasters(t,e,l.visibleCasters,c,i);let B=!0;const L=l.visibleCasters;for(let I=0;I<L.length;I++){const F=L[I];B?(B=!1,eu.copy(F.aabb)):eu.add(F.aabb)}pS.copy(d.getWorldTransform()).invert();const V=VO(pS,eu.getMin(),eu.getMax());d.translateLocal(0,0,V.max+.1),c.farClip=V.max-V.min+.2,l.depthRangeCompensation=c.farClip,l.projectionCompensation=m}}generateSplitDistances(e,t,s){e._shadowCascadeDistances.fill(s);for(let i=1;i<e.numCascades;i++){const n=i/e.numCascades,a=t+(s-t)*n,o=t*(s/t)**n,l=H.lerp(a,o,e.cascadeDistribution);e._shadowCascadeDistances[i-1]=l}}getLightRenderPass(e,t){let s=null;if(this.shadowRenderer.needsShadowRendering(e)){const i=e.numShadowFaces,n=e.shadowUpdateOverrides;let a=!0,o;for(let l=0;l<i;l++)(n==null?void 0:n[l])===Ci&&(a=!1),o=this.shadowRenderer.prepareFace(e,t,l);s=new zO(this.device,this.shadowRenderer,e,t,a),this.shadowRenderer.setupRenderPass(s,o,a)}return s}}function HO(r,e){return Math.exp(-(r*r)/(2*e*e))}function WO(r){const e=(r-1)/6,t=(r-1)*.5,s=new Array(r);let i=0;for(let n=0;n<r;++n)s[n]=HO(n-t,e),i+=s[n];for(let n=0;n<r;++n)s[n]/=i;return s}const zm=new Set,mS=new q,_S=new q,Yr=new Float32Array(2),vh=new P(1,1,0,0),gS=new q;class Jp{constructor(e,t){this.shadowPassCache=[],this.device=e.device,this.renderer=e,this.lightTextureAtlas=t;const s=this.device.scope;this.polygonOffsetId=s.resolve("polygonOffset"),this.polygonOffset=new Float32Array(2),this.sourceId=s.resolve("source"),this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]"),this.blurVsmShaderCode=[W.blurVSMPS,`#define GAUSS
`+W.blurVSMPS];const i=`#define PACKED
`;this.blurPackedVsmShaderCode=[i+this.blurVsmShaderCode[0],i+this.blurVsmShaderCode[1]],this.blurVsmShader=[{},{}],this.blurPackedVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=s.resolve("light_radius"),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this.blendStateWrite=new Xe,this.blendStateNoWrite=new Xe,this.blendStateNoWrite.setColorWrite(!1,!1,!1,!1)}static createShadowCamera(e,t,s,i){const n=Ei.create("ShadowCamera",s,i);return t>=ei&&t<=si?n.clearColor=new k(0,0,0,0):n.clearColor=new k(1,1,1,1),n.clearDepthBuffer=!0,n.clearStencilBuffer=!1,n}static setShadowCameraSettings(e,t,s,i,n){let a=s===wi||(s===Wi||s===xt)&&t.supportsDepthShadow;i===Oe&&!n&&(a=!1),e.clearColorBuffer=!a}_cullShadowCastersInternal(e,t,s){const i=e.length;for(let n=0;n<i;n++){const a=e[n];a.castShadow&&(!a.cull||a._isVisible(s))&&(a.visibleThisFrame=!0,t.push(a))}}cullShadowCasters(e,t,s,i,n){if(s.length=0,n)this._cullShadowCastersInternal(n,s,i);else{const a=e.layerList,o=a.length;for(let l=0;l<o;l++){const c=a[l];c._lightsSet.has(t)&&(zm.has(c)||(zm.add(c),this._cullShadowCastersInternal(c.shadowCasters,s,i)))}zm.clear()}s.sort(this.renderer.sortCompareDepth)}setupRenderState(e,t){e.isWebGL1&&e.extStandardDerivatives&&(t._type===Oe?(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset)):(this.polygonOffset[0]=t.shadowBias*-1e3,this.polygonOffset[1]=t.shadowBias*-1e3,this.polygonOffsetId.setValue(this.polygonOffset)));const s=this.renderer.scene.clusteredLightingEnabled,i=e.isWebGL2||e.isWebGPU,n=s?t._isPcf&&i:t._isPcf&&i&&t._type!==Oe;e.setBlendState(n?this.blendStateNoWrite:this.blendStateWrite),e.setDepthState(t.shadowDepthState),e.setStencilState(null,null)}dispatchUniforms(e,t,s,i){const n=t._node;e._type!==fe&&(this.renderer.dispatchViewPos(n.getPosition()),this.shadowMapLightRadiusId.setValue(e.attenuationEnd)),mS.setTRS(n.getPosition(),n.getRotation(),y.ONE).invert(),_S.mul2(t.projectionMatrix,mS);const a=s.shadowViewport;t.rect=a,t.scissorRect=s.shadowScissor,gS.setViewport(a.x,a.y,a.z,a.w),s.shadowMatrix.mul2(gS,_S),e._type===fe&&e._shadowMatrixPalette.set(s.shadowMatrix.data,i*16)}getShadowPass(e){var t;const s=e._type,i=e._shadowType;let n=(t=this.shadowPassCache[s])==null?void 0:t[i];if(!n){const a=`ShadowPass_${s}_${i}`;n=Ii.get(this.device).allocate(a,{isShadow:!0,lightType:s,shadowType:i}),this.shadowPassCache[s]||(this.shadowPassCache[s]=[]),this.shadowPassCache[s][i]=n}return n.index}submitCasters(e,t){const s=this.device,i=this.renderer,n=i.scene,a=1<<Bb,o=this.getShadowPass(t),l=e.length;for(let c=0;c<l;c++){const d=e[c],h=d.mesh;d.ensureMaterial(s);const u=d.material;i.setBaseConstants(s,u),i.setSkinning(s,d),u.dirty&&(u.updateUniforms(s,n),u.dirty=!1),u.chunks&&(i.setupCullMode(!0,1,d),u.setParameters(s),d.setParameters(s,a));const f=d.getShaderInstance(o,0,n,this.viewUniformFormat,this.viewBindGroupFormat),p=f.shader;d._key[ag]=p.id,s.setShader(p),i.setVertexBuffers(s,h),i.setMorphing(s,d.morphInstance),this.renderer.setupMeshUniformBuffers(f,d);const _=d.renderStyle;s.setIndexBuffer(h.indexBuffer[_]),i.drawInstance(s,d,h,_),i._shadowDrawCalls++}}needsShadowRendering(e){const t=e.enabled&&e.castShadows&&e.shadowUpdateMode!==Ci&&e.visibleThisFrame;return e.shadowUpdateMode===Ka&&(e.shadowUpdateMode=Ci),t&&(this.renderer._shadowMapUpdates+=e.numShadowFaces),t}getLightRenderData(e,t,s){return e.getRenderData(e._type===fe?t:null,s)}setupRenderPass(e,t,s){const i=t.renderTarget;e.init(i),e.depthStencilOps.clearDepthValue=1,e.depthStencilOps.clearDepth=s,i.depthBuffer?e.depthStencilOps.storeDepth=!0:(e.colorOps.clearValue.copy(t.clearColor),e.colorOps.clear=s,e.depthStencilOps.storeDepth=!1),e.requiresCubemaps=!1}prepareFace(e,t,s){const i=e._type,n=e._shadowType,a=this.renderer.scene.clusteredLightingEnabled,l=this.getLightRenderData(e,t,s).shadowCamera;Jp.setShadowCameraSettings(l,this.device,n,i,a);const c=i===fe?0:s;return l.renderTarget=e._shadowMap.renderTargets[c],l}renderFace(e,t,s,i,n=!0){const a=this.device,o=this.getLightRenderData(e,t,s),l=o.shadowCamera;this.dispatchUniforms(e,l,o,s);const c=l.renderTarget,d=this.renderer;d.setCameraUniforms(l,c),a.supportsUniformBuffers&&d.setupViewUniformBuffers(o.viewBindGroups,this.viewUniformFormat,this.viewBindGroupFormat,1),n?(d.setupViewport(l,c),i&&d.clear(l)):d.clearView(l,c,!0,!1),this.setupRenderState(a,e),this.submitCasters(o.visibleCasters,e)}render(e,t,s=!0){if(this.needsShadowRendering(e)){const i=e.numShadowFaces;for(let n=0;n<i;n++)this.prepareFace(e,t,n),this.renderFace(e,t,n,!0,s);this.renderVsm(e,t)}}renderVsm(e,t){e._isVsm&&e._vsmBlurSize>1&&(!this.renderer.scene.clusteredLightingEnabled||e._type===fe)&&this.applyVsmBlur(e,t)}getVsmBlurShader(e,t,s){let i=(e?this.blurPackedVsmShader:this.blurVsmShader)[t][s];if(!i){this.blurVsmWeights[s]=WO(s);const n=W.fullscreenQuadVS;let a="#define SAMPLES "+s+`
`;e?a+=this.blurPackedVsmShaderCode[t]:a+=this.blurVsmShaderCode[t];const o="blurVsm"+t+s+e;i=ks(this.device,n,a,o),e?this.blurPackedVsmShader[t][s]=i:this.blurVsmShader[t][s]=i}return i}applyVsmBlur(e,t){const s=this.device;s.setBlendState(Xe.NOBLEND);const a=e.getRenderData(e._type===fe?t:null,0).shadowCamera.renderTarget,o=this.renderer.shadowMapCache.get(s,e),l=o.renderTargets[0],c=e._shadowType===ei,d=e.vsmBlurMode,h=e._vsmBlurSize,u=this.getVsmBlurShader(c,d,h);vh.z=e._shadowResolution-2,vh.w=vh.z,this.sourceId.setValue(a.colorBuffer),Yr[0]=1/e._shadowResolution,Yr[1]=0,this.pixelOffsetId.setValue(Yr),d===Gy&&this.weightId.setValue(this.blurVsmWeights[h]),Ya(s,l,u,null,vh),this.sourceId.setValue(l.colorBuffer),Yr[1]=Yr[0],Yr[0]=0,this.pixelOffsetId.setValue(Yr),Ya(s,a,u,null,vh),this.renderer.shadowMapCache.add(e,o)}initViewBindGroupFormat(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new Hp(this.device,[new vt("matrix_viewProjection",Ol)]),this.viewBindGroupFormat=new jp(this.device,[new Wp(pd,Gl|Ms)],[]))}frameUpdate(){this.initViewBindGroupFormat()}}const tu=[];class jO{constructor(e){this._empty=null,this._allocated=[],this._clusters=new Map,this.device=e}destroy(){this._empty&&(this._empty.destroy(),this._empty=null),this._allocated.forEach(e=>{e.destroy()}),this._allocated.length=0}get count(){return this._allocated.length}get empty(){if(!this._empty){const e=new cg(this.device);e.name="ClusterEmpty",e.update([],!1,null),this._empty=e}return this._empty}assign(e){const t=this.empty;tu.push(...this._allocated),this._allocated.length=0,this._clusters.clear();const s=e.length;for(let n=0;n<s;n++){const o=e[n].renderActions;if(o){const l=o.length;for(let c=0;c<l;c++){const d=o[c];d.lightClusters=null;const h=d.layer;if(h.hasClusteredLights&&h.meshInstances.length){const u=h.getLightIdHash(),f=this._clusters.get(u);let p=f==null?void 0:f.lightClusters;if(!p){var i;p=(i=tu.pop())!=null?i:new cg(this.device),this._allocated.push(p),this._clusters.set(u,d)}d.lightClusters=p}d.lightClusters||(d.lightClusters=t)}}}tu.forEach(n=>n.destroy()),tu.length=0}update(e,t,s){this.assign(e),this._clusters.forEach(i=>{const n=i.layer;i.lightClusters.update(n.clusteredLightsSet,t,s)})}}const yS=`
	attribute vec2 vertex_position;
	varying vec2 uv0;
	void main(void) {
		gl_Position = vec4(vertex_position, 0.5, 1.0);
		uv0 = vertex_position.xy * 0.5 + 0.5;
		#ifndef WEBGPU
			uv0.y = 1.0 - uv0.y;
		#endif
	}`,$O=`
	varying vec2 uv0;
	uniform sampler2D blitTexture;
	void main(void) {
		gl_FragColor = texture2D(blitTexture, uv0);
	}`,XO=`
	varying vec2 uv0;
	uniform samplerCube blitTexture;
	uniform mat4 invViewProj;
	void main(void) {
		vec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);
		vec4 worldPos = invViewProj * projPos;
		gl_FragColor = textureCube(blitTexture, worldPos.xyz);
	}`,sr=new P,Vm=[];class t0 extends Hs{constructor(e,t){super(e),this._quadRenderer2D=null,this._quadRendererCube=null,this._filteredLights=[],this._cubeSlotsOffsets=t,this.requiresCubemaps=!1,this.blitTextureId=e.scope.resolve("blitTexture"),this.invViewProjId=e.scope.resolve("invViewProj")}destroy(){var e,t;(e=this._quadRenderer2D)==null||e.destroy(),this._quadRenderer2D=null,(t=this._quadRendererCube)==null||t.destroy(),this._quadRendererCube=null}static create(e,t){const s=new t0(e.device,t);return s.init(e),s.colorOps.clear=!1,s.depthStencilOps.clearDepth=!1,s}update(e){const t=this._filteredLights;this.filter(e,t),this.executeEnabled=t.length>0}filter(e,t){for(let s=0;s<e.length;s++){const i=e[s];i._type!==fe&&i.atlasViewportAllocated&&i.atlasSlotUpdated&&i.enabled&&i.cookie&&i.visibleThisFrame&&t.push(i)}}initInvViewProjMatrices(){if(!Vm.length)for(let e=0;e<6;e++){const t=Ei.create(null,Oe,e),s=t.projectionMatrix,i=t.node.getLocalTransform().clone().invert();Vm[e]=new q().mul2(s,i).invert()}}get quadRenderer2D(){if(!this._quadRenderer2D){const e=ks(this.device,yS,$O,"cookieRenderer2d");this._quadRenderer2D=new df(e)}return this._quadRenderer2D}get quadRendererCube(){if(!this._quadRendererCube){const e=ks(this.device,yS,XO,"cookieRendererCube");this._quadRendererCube=new df(e)}return this._quadRendererCube}execute(){const e=this.device;e.setBlendState(Xe.NOBLEND),e.setCullMode(Et),e.setDepthState(kt.NODEPTH),e.setStencilState();const t=this.renderTarget.colorBuffer.width,s=this._cubeSlotsOffsets,i=this._filteredLights;for(let n=0;n<i.length;n++){const a=i[n],o=a.numShadowFaces,l=o>1?this.quadRendererCube:this.quadRenderer2D;o>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(a.cookie);for(let c=0;c<o;c++){if(sr.copy(a.atlasViewport),o>1){const d=sr.z/3,h=s[c];sr.x+=d*h.x,sr.y+=d*h.y,sr.z=d,sr.w=d,this.invViewProjId.setValue(Vm[c].data)}sr.mulScalar(t),l.render(sr)}}i.length=0}}class qO extends Hs{constructor(e,t,s){super(e),this.requiresCubemaps=!1,this.shadowRenderer=t,this.shadowRendererLocal=s}update(e){const t=this.shadowRendererLocal.shadowLights,s=this.shadowRendererLocal.prepareLights(t,e),i=t.length;this.enabled=i>0,i&&this.shadowRenderer.setupRenderPass(this,s,!1)}execute(){const e=this.shadowRendererLocal.shadowLights,t=e.length;for(let s=0;s<t;s++){const i=e[s];for(let n=0;n<i.numShadowFaces;n++)this.shadowRenderer.renderFace(i,null,n,!0)}e.length=0}}class KO extends Hs{constructor(e,t,s,i,n){super(e),this.renderer=t,this.frameGraph=null,this.cookiesRenderPass=t0.create(n.cookieRenderTarget,n.cubeSlotsOffsets),this.beforePasses.push(this.cookiesRenderPass),this.shadowRenderPass=new qO(e,s,i),this.beforePasses.push(this.shadowRenderPass)}update(e,t,s,i,n){this.frameGraph=e,this.cookiesRenderPass.enabled=s,s&&this.cookiesRenderPass.update(i),this.shadowRenderPass.enabled=t,t&&this.shadowRenderPass.update(n)}destroy(){this.cookiesRenderPass.destroy(),this.cookiesRenderPass=null}execute(){const{renderer:e}=this,{scene:t}=e;e.worldClustersAllocator.update(this.frameGraph.renderPasses,t.gammaCorrection,t.lighting)}}const YO="muPIHORMLNDCz4DxVR/ZvYfAUVEFR47KRIC4nwAAAAAP7WxlhD6Ci+2HCe7BF8jRAPZwdH2UPpI5PdLCJdkvG4UTaNDJ/0crAzne71GCrb4kbdMjjCEGzdX6fNxDMLJq5xkeoIVTdfiZkodEeArmZmp/FQzFjD4x8iOW7Dg64n+3mWqyEwLxXT8zoJXfbw8QJKDCaarUYyTlMzNFHbgUe9IQV7g4YOgtSKpIFZJ0qERm7u4PpmiF89ktHWCywaGmD6h+hfh2/Zd8KYlKqqo4Cem4T42bT/Z9FpCQF1hhSjfBzZ5XFn/y3jegWC6u86KuELRundQS/1Rp+XuKKGIgRv3CvP5y749yqLlFO495JOT3+f2CXgd71npU0/KjjpkZucbJ5m78IVyuSrSozc9jgBUhDrz0hFsyb7LFUH9//wJbBgLdNWJZObfKxrNt8TliLA9w9sXFv6g26iXpf6r/BqcAusj/QzGBZuoUGeEtw8BCXCZ3jUiw4hvM18ZVqlUD3C40LAFXW6FRjuAZGRNstb0/qVk4skwyT+MHrvRorI4rKHVMWZmKyAkzL/78u/9pMQuX14pZN50b2PHn6fRxeaCQLsfT4dpvIkWWFuFVENZIh+8xgR6lU+85W0PPdAu1j99kcCG40JBQa4JMyRzq6qriOBLtqF87vpCJan0WEduVr/mOYkS00urVA0mA6M3031+GmGmW48PaJDYOEIb3bIXWPaLoAOEinX1TN3+/vwhG6nqJu0TdHpedS7QsGZIoxH3nQYYjQP1jmbahlbNngw5ogsGk1y50XZyUmQBY+/JBJ3Unu4dApm+WmPwHPU9gLb+4mHh4BiY6M86pq+WeTyWdI3s0CXPEtHGXZ8zMZgUoyRomBi1VdazzuN+WOmQ9Pa0Z0tlNopUi8AJ4x2Xn4mmOKEbXLxlbVsWu8XhuDGYFOGCRVdSqDPXrHU5SDdUlti3k5///SBwzTMwK3L4a1H7w4lnpEas6////AfX8asyIBfeFXVJ3tgvxQ/blZuUKyIODIfr/UzdWNu7pciLBpdZRZ4pIfZ1R6szq+XNxkGG///8EZFpu7VHAhFWqHEOrB9unw+YQa5o8/9IR/V5/zq+986rJSyfgJKt2u9hxU1wzyQWPjJGvzG9+eWWxGFOHVKqI4jBQALwZZswesnvZ2UmmkEXdiRpz8B+oWE7PY70ZTMndisYSXg2TqoI+3y9BxbnY2Y4EfbdcRhAvG59NqDENNYbxKvK5HJfPG5M+Wi2AcpLVJrD6caiEOzgSoVNSgQK8fm2M3zGcF4xtClv/8Hs9oD7C3jitTATYNQxmKqKf1LhIxzf1bmfiNn7UKFmcJu4sLqVLwxGSue3taBEyknkw5hXTsUCvqmmL/f8n/w0giR7Hu/9EHvpkz3yuu64TioMkzdTJ30i0+hFnQqW1+v9mMwq+z9qGX0UFu9MomvVG2xod6vc12AAAAACq7sGa5qptFR0jF3nQt/D+7PibKYahaxP3hEixPbGi9nwNf2LAa7LkEZRKxzXeCD64Xpii5n+8Kpg8eHIv7AWXZltgMoGltmoJ0XGdOCL8WkzphvR9N2o3ARSZ42l5e5Pe4B58MCRlP3EKv+mcloknH+fto5BWsmEutW6KvjOVsznFCktkSczVk4aGvj9VXlRcLeDoKG8RkBgdcNG2bf8HUL4MT2DM+ar7NImJhKpxakX4Vk0CnP+/XNhl5UsP0lXgeZXPoDBMSW5An+DXlTCO5FQGwSPYwHLKYVIimEdAoVe49rQLaaNcye5LxU2/c5TijTgJtD5eQQIe1snxauj5jZsxJBUJdoP/zqpjqv8qBruoPsVsP8N44PCUW5Dd0DzqjSS/Dl5mI9cn1w2ndN/0KAEm1QAAAACwu6KM/083IBbH5bPa/9oHUwcU8I9v3j6/v18QYammrf+P6VL///8BrpuM3fOLCxaLNOFNF1zPbPYTP65ni6njft4eVcyrVXRQFrs52tr35StiSp55edVDCBC0H5rIfac6nzUwxQSt7y15QoKb+5zebEQUmVbrPjXuUa19Ey7sqXMiSUKHaw72PJKDdrutJoQr3u6lEYJ8K0MakWKj9zjTFi4X94TsKYco0GrLeB60M6D8M/80rhXUW8iMequg8y5F838WI0+gp3GBN5Kj/xIOxTWQuUaPV/LwvARr1VH93BFgGZR1MFW0Ua30GbYmdnAgo9VWy8SQtpDUgGE2r2zq2eTEMCL7sMKmE1hchVhuF/TCq9iXKEm86kzOf3Rp9ZnCxbpDUj+FKNxVyXe6pVZkRXv/m95SnB/EB8aME29N85MtAcDoXWlor8De2Q5Dg1tar+8wgiZufbMam81j//ASUohoR/zSh2KG4bvT6mkIPz6C5/98DC3LaWlaEZ1zA5JORZRu6J/a0GY285sEYzw71YqOT1ihAG0z5SDt1xNiDQWZdFpndArp6xWhqSDkRb4kSJEHb9liPvw7uLV/6i5MVf//A9Qjr8xkAEUh+KDI+zdtJ68d6MBOktg1iyp/SCq8O9f5pbamn1VVVQPRTWqNBvhQKa07s6P0lc9Luu/3gw4HeyOUfz8MxMwV4UQhua+t9cr4bz/nIB2wnDSK1K7I94M+s6C84htaX/CNlMQUSs2KJO+yaebfTbkNX5yWcqEJevo0vbKUiETuFXiL019A3E+lmsyZMwXrXLLiQAZ5t9+jI3JobhJTMiDH5ZOQ+8Jau5555NMjHSscP9qCVaa40doh+1a3Ukf6jqBmLddgh79/fwTfCyqiuldNkUoy+nUp+4nerwg0OjtGv2x485PJOJvUEokNhYIdWjpx7BWk0VZGWOp3jSFTJ2bnu6KCduZtG/UcBC9RZ3W/jMSfSMw4Etr/DoD/XYP2V5Ovw+YoM3F5g2dGLdvuG6ZkVGLE6Dk5Zr+sdSyGliJP1y2OFf/KFO0RWO+3gsGhesTnfZVpTd8/HwgO216gwaqo+vY3TljfJWowY+i0p0Os4SLn/1wLqDHMlszggmT/D8MRFzs+pLv6LNJSsNZ/r41mWi/rF6ZcKp/yzJdK0VU44hskq3RGpgO6mIpJDsf/mZkFrz0yYOMLbuaj/wp1v7JMFM5eqvBhmTd7U8frQAtHtys4zgpjZmzUhOVTfNNLifElGXADlqHGKrkBT/nYwX8ZRm3RjvyPvjKyEqEGKUpVnvOGx+NKPHiWM//ZDpDVGvvrjmk8RPF/wiYZD3+Us8YCXjrVOfjdd1UPAfjLp8jgSn4me7DPTpz1Ggy9XL80guFO7ECT10AvILKfD18Qx+KY/f8aRqu0oOO8hfKRFZa9PUJwCsp6VdZz6LFkm2b9Pl2LIifCwzRy7TpdG2uAtOxP2OemY26bJMa9ZGSLIRlMsgpDpnDJwd0oa5pQ13x1hrHf52HpulUWonGWsfXZbSQYKu9bnEN76ciQih0opN3deDVrbrxorfVlnCmL1R9zq3ePGWIv21c7pW8kEiFTM5JX8dAw867s/60cf79/BH+MDFCZBHlz1L+qGOJf/1txhhmrf3//As+RIJwevDb+fgNXVeHw67QptZegayhrEwr5Gy+EPo1RLaMtPbqOZYoVzXzwzjMFWZxyUG9YUIf6////AQWy84iAygLk9COtXt92+0mT/xg0zMzMBeLkb8y9SL2TDXgSX422hDgpGNLJyuPioA+YJ91G8znrpNqHkwYyscaJDEc9Vc+j4cXle3hvcd2JqDQH2lBZxDn6mUTs0b75raMvbs727codX01Anj8f3wir9P2xQaQ22v/TxCMglKDFoTjaP01XTLgxnTvPv02JgEUrW6UDgOnobFpLdvKdlypgIzPcq14fgXU5tvVW0FEs7VRlsG1IyA69fN4n+awHhT34cE+xUvdj86C8LgAsFheTjI9Ht9EyYAAAAAAVBVKRx2wLgUTI0/2QfyJo2riRw3JDqzEShmx/Lifo6mRkQVbS7X53t+EvKxcXogtdts31e9MRHdcHgsA8rt4/mt2unlzQ/wsU8Gu7+W6Oj7eD8EQdDp5XlCsVaS/AV/t5ZpPOHR3rGpyAJe9IPV+xMrBL1Oz/8MQhFs31h0N1cVnq371uqIJYHyafKH1jteAK3VpMXBcuC+yt0ZeKyRUY4QhdrJJ4tJ1wg3Hu6kDsbovxupTMkGdRrm8oZSoYPbJ+PwH/xotgTdkA1205vUEfnqkI04T/fnnd1fiZW5AwNcggd7fi4j5zasmcntZexIxqFZQMzMJpfndmI5jn17cgn5EV5t9XN0C///8Q9wlJpMGXdoiaMTG2sVyHQsn8mWRISCLNG777S0OuDRP2GlLcJ2UeOg7Fo8hTNPeJ//iTJhyqxhKRUntdXOihq2wfKfH///8B0GGrwT+fSOQRdctKxjjGCSS11d6BlQ9BDfE0J6Z25FaNTKGpFKNCMr2G/041KpWwBLVe1k08vncseQbKZdXi8x1t9XA45U/Wd43D9wAh3Tal0aiLVzGPusOZ1F+W3TWoqlX/A95+dNef11TsuGful+ctGssldk3fqpfqh+43XTxL42+leSHoF/dWHYGX6maqUEuLX7UB+r/6Llr4LKocbVIeu+hB9QTPfz9fCP8RyWmX4SmbhMFsNtCijV7lVcwejLKlvl0GfCndnWV7/39VBrtTRuUx92oke3GBgKkC5fdGK0YvNK+xenKaDmsHDjNFUM3NMz3ZiXXFuLgojosPVCDEl2W5BjX3Ms+j0GSqACHmh0+RPWyuNm/Qe8vFf9AW7N1uRaxWirrUytqEJnJ4/Flm8hSoiZ2NQBsS6w/yQlC4gCaFo8q4nyY6AFdo4hiwhBXzbNKKvZvktCjSCukRR/BbYVbNwZi2Yh3hGodEacLW8qijiWJODf0P2bhfaiPspPT4lYJBgi/KfcFwCfvyUIgkJOv///8CG/JEepRBLaMFE+2TgrqsJXOVOWHt6g/bFwVLLMVBsMR50dis/39/AlBX+/rMTJkUQrnlxpR2iu0Tp8tATkRYGmDIrcAiRP8PjoWIlb7/0ecTdSCE9Y58+a+n/FovJQTVF4F2jAxMZhTgrM/KVS5BQu6bVbkWY5HXnxRshks3urDdW4RkWp4M4TeLmFK5KF/uHkkiO5Kv96RioH984v/CSDBnG+BwlnU9B+o7Y+0X0Nob+0pLsStxjvPXMy2eCpzhOWV4XbObBHN4UE2sLQ/DIqXhOzxVf38GlTi6aG7EnePO7TRJm9yOfUUcqq1I2iQHrVDqn3TUNRi/lMw8KbMW/3/nqCz/Ef8PoW5Qxcz2yHR/f78EPB2Stbd+ZFmfNTUYILzsb9YNhpaHcaymYrBiNHmFE3Y4ccYJ25Prqm7zHobGHED8/93ZNlWro9vcKivGZs31UiK1k5zjUhexUgbqJb+fUTjxce/7Zly8a5KMC1fX5nfjPgibdvzbXV1jRT2asXvmSAusaLdq1TSIJ8fXINk5AtT34EWPAsfP9IFQqM5K11O6saoHJA==";let Cn=null;const Kb=()=>{if(!Cn){const r=atob(YO);Cn=Uint8Array.from(r,e=>e.charCodeAt(0))}},ZO=()=>(Kb(),Cn);class JO{constructor(e=0){this.seed=0,this.seed=e*4,Kb()}_next(){this.seed=(this.seed+4)%Cn.length}value(){return this._next(),Cn[this.seed]/255}vec4(e=new P){return this._next(),e.set(Cn[this.seed],Cn[this.seed+1],Cn[this.seed+2],Cn[this.seed+3]).mulScalar(1/255)}}const QO=new di;function eF(r){return QO.get(r,()=>{const e=ZO(),t=Math.sqrt(e.length/4),s=new _e(r,{name:`BlueNoise${t}`,width:t,height:t,format:xe,addressU:Tt,addressV:Tt,type:ps,magFilter:Ee,minFilter:Ee,anisotropy:1,mipmaps:!1});return s.lock().set(e),s.unlock(),s})}let Gm=0;const ir=new q,nr=new q,To=new q,vS=new hi,Hm=new Al,SS=new q().setScale(1,-1,1),Wm=new Set,jm=new Set,tF=new P,xS=new q().set([1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1]),wS=[new M(.5,.333333),new M(.25,.666667),new M(.75,.111111),new M(.125,.444444),new M(.625,.777778),new M(.375,.222222),new M(.875,.555556),new M(.0625,.888889),new M(.5625,.037037),new M(.3125,.37037),new M(.8125,.703704),new M(.1875,.148148),new M(.6875,.481481),new M(.4375,.814815),new M(.9375,.259259),new M(.03125,.592593)],sF=new q,iF=new q,nF=new q,rF=new q,aF=new q,oF=new q,Eo=new Set,$m=[],Xm=[];class lF{constructor(e){this.clustersDebugRendered=!1,this.processingMeshInstances=new Set,this.worldClustersAllocator=void 0,this.lights=[],this.localLights=[],this.cameraDirShadowLights=new Map,this.dirLightShadows=new Map,this.blueNoise=new JO(123),this.device=e,this.scene=null,this.worldClustersAllocator=new jO(e),this.lightTextureAtlas=new OO(e),this.shadowMapCache=new BO,this.shadowRenderer=new Jp(this,this.lightTextureAtlas),this._shadowRendererLocal=new UO(this,this.shadowRenderer),this._shadowRendererDirectional=new GO(this,this.shadowRenderer),this._renderPassUpdateClustered=new KO(this.device,this,this.shadowRenderer,this._shadowRendererLocal,this.lightTextureAtlas),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this._skinTime=0,this._morphTime=0,this._cullTime=0,this._shadowMapTime=0,this._lightClustersTime=0,this._layerCompositionUpdateTime=0,this._shadowDrawCalls=0,this._skinDrawCalls=0,this._instancedDrawCalls=0,this._shadowMapUpdates=0,this._numDrawCallsCulled=0,this._camerasRendered=0,this._lightClusters=0;const t=e.scope;this.boneTextureId=t.resolve("texture_poseMap"),this.boneTextureSizeId=t.resolve("texture_poseMapSize"),this.poseMatrixId=t.resolve("matrix_pose[0]"),this.modelMatrixId=t.resolve("matrix_model"),this.normalMatrixId=t.resolve("matrix_normal"),this.viewInvId=t.resolve("matrix_viewInverse"),this.viewPos=new Float32Array(3),this.viewPosId=t.resolve("view_position"),this.projId=t.resolve("matrix_projection"),this.projSkyboxId=t.resolve("matrix_projectionSkybox"),this.viewId=t.resolve("matrix_view"),this.viewId3=t.resolve("matrix_view3"),this.viewProjId=t.resolve("matrix_viewProjection"),this.flipYId=t.resolve("projectionFlipY"),this.tbnBasis=t.resolve("tbnBasis"),this.nearClipId=t.resolve("camera_near"),this.farClipId=t.resolve("camera_far"),this.cameraParams=new Float32Array(4),this.cameraParamsId=t.resolve("camera_params"),this.viewIndexId=t.resolve("view_index"),this.blueNoiseJitterId=t.resolve("blueNoiseJitter"),this.blueNoiseTextureId=t.resolve("blueNoiseTex32"),this.alphaTestId=t.resolve("alpha_ref"),this.opacityMapId=t.resolve("texture_opacityMap"),this.exposureId=t.resolve("exposure"),this.twoSidedLightingNegScaleFactorId=t.resolve("twoSidedLightingNegScaleFactor"),this.twoSidedLightingNegScaleFactorId.setValue(0),this.morphWeightsA=t.resolve("morph_weights_a"),this.morphWeightsB=t.resolve("morph_weights_b"),this.morphPositionTex=t.resolve("morphPositionTex"),this.morphNormalTex=t.resolve("morphNormalTex"),this.morphTexParams=t.resolve("morph_tex_params"),this.lightCube=new kO,this.constantLightCube=t.resolve("lightCube[0]")}destroy(){this.shadowRenderer=null,this._shadowRendererLocal=null,this._shadowRendererDirectional=null,this.shadowMapCache.destroy(),this.shadowMapCache=null,this._renderPassUpdateClustered.destroy(),this._renderPassUpdateClustered=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null}sortCompare(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist;if(e.zdist2&&t.zdist2)return e.zdist2-t.zdist2}return t._key[Rn]-e._key[Rn]}sortCompareMesh(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist}const s=e._key[Rn],i=t._key[Rn];return s===i&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:i-s}sortCompareDepth(e,t){const s=e._key[ag],i=t._key[ag];return s===i&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:i-s}setupViewport(e,t){const s=this.device,i=t?t.width:s.width,n=t?t.height:s.height,a=e.rect;let o=Math.floor(a.x*i),l=Math.floor(a.y*n),c=Math.floor(a.z*i),d=Math.floor(a.w*n);if(s.setViewport(o,l,c,d),e._scissorRectClear){const h=e.scissorRect;o=Math.floor(h.x*i),l=Math.floor(h.y*n),c=Math.floor(h.z*i),d=Math.floor(h.w*n)}s.setScissor(o,l,c,d)}setCameraUniforms(e,t){const s=t==null?void 0:t.flipY;let i=1;if(e.xr&&e.xr.session){var n;const l=((n=e._node)==null||(n=n.parent)==null?void 0:n.getWorldTransform())||null,c=e.xr.views;i=c.list.length;for(let d=0;d<i;d++){const h=c.list[d];h.updateTransforms(l),e.frustum.setFromMat4(h.projViewOffMat)}}else{let l=e.projectionMatrix;e.calculateProjection&&e.calculateProjection(l,$d);let c=e.getProjectionMatrixSkybox();s&&(l=sF.mul2(SS,l),c=iF.mul2(SS,c)),this.device.isWebGPU&&(l=nF.mul2(xS,l),c=rF.mul2(xS,c));const{jitter:d}=e;let h=P.ZERO,u=0,f=0;if(d>0){const p=t?t.width:this.device.width,_=t?t.height:this.device.height,m=wS[this.device.renderVersion%wS.length];u=d*(m.x*2-1)/p,f=d*(m.y*2-1)/_,l=aF.copy(l),l.data[8]=u,l.data[9]=f,c=oF.copy(c),c.data[8]=u,c.data[9]=f,h=this.blueNoise.vec4(tF)}if(this.blueNoiseJitterId.setValue([h.x,h.y,h.z,h.w]),this.projId.setValue(l.data),this.projSkyboxId.setValue(c.data),e.calculateTransform)e.calculateTransform(nr,$d);else{const p=e._node.getPosition(),_=e._node.getRotation();nr.setTRS(p,_,y.ONE)}this.viewInvId.setValue(nr.data),To.copy(nr).invert(),this.viewId.setValue(To.data),vS.setFromMat4(To),this.viewId3.setValue(vS.data),ir.mul2(l,To),this.viewProjId.setValue(ir.data),e._storeShaderMatrices(ir,u,f,this.device.renderVersion),this.flipYId.setValue(s?-1:1),this.dispatchViewPos(e._node.getPosition()),e.frustum.setFromMat4(ir)}this.tbnBasis.setValue(s?-1:1);const a=e._nearClip,o=e._farClip;return this.nearClipId.setValue(a),this.farClipId.setValue(o),this.cameraParams[0]=1/o,this.cameraParams[1]=o,this.cameraParams[2]=a,this.cameraParams[3]=e.projection===Ua?1:0,this.cameraParamsId.setValue(this.cameraParams),this.exposureId.setValue(this.scene.physicalUnits?e.getExposure():this.scene.exposure),i}clear(e,t,s,i){const n=(t??e._clearColorBuffer?Ml:0)|(s??e._clearDepthBuffer?Il:0)|(i??e._clearStencilBuffer?yc:0);n&&this.device.clear({color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,stencil:e._clearStencil,flags:n})}setCamera(e,t,s,i=null){this.setCameraUniforms(e,t),this.clearView(e,t,s,!1)}clearView(e,t,s,i){const n=this.device;if(n.setRenderTarget(t),n.updateBegin(),i&&(n.setColorWrite(!0,!0,!0,!0),n.setDepthWrite(!0)),this.setupViewport(e,t),s){const a=e._clearOptions;n.clear(a||{color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,flags:(e._clearColorBuffer?Ml:0)|(e._clearDepthBuffer?Il:0)|(e._clearStencilBuffer?yc:0),stencil:e._clearStencil})}}setupCullMode(e,t,s){const i=s.material;let n=Et;if(e){let a=1;(i.cull===Xh||i.cull===Dr)&&(a=t*s.flipFacesFactor*s.node.worldScaleSign),a<0?n=i.cull===Xh?Dr:Xh:n=i.cull}this.device.setCullMode(n),n===Et&&i.cull===Et&&this.twoSidedLightingNegScaleFactorId.setValue(s.node.worldScaleSign)}updateCameraFrustum(e){if(e.xr&&e.xr.views.list.length){const s=e.xr.views.list[0];ir.mul2(s.projMat,s.viewOffMat),e.frustum.setFromMat4(ir);return}const t=e.projectionMatrix;if(e.calculateProjection&&e.calculateProjection(t,$d),e.calculateTransform)e.calculateTransform(nr,$d);else{const s=e._node.getPosition(),i=e._node.getRotation();nr.setTRS(s,i,y.ONE),this.viewInvId.setValue(nr.data)}To.copy(nr).invert(),ir.mul2(t,To),e.frustum.setFromMat4(ir)}setBaseConstants(e,t){e.setCullMode(t.cull),t.opacityMap&&this.opacityMapId.setValue(t.opacityMap),(t.opacityMap||t.alphaTest>0)&&this.alphaTestId.setValue(t.alphaTest)}updateCpuSkinMatrices(e){Gm++;const t=e.length;if(t!==0)for(let s=0;s<t;s++){const i=e[s].skinInstance;i&&(i.updateMatrices(e[s].node,Gm),i._dirty=!0)}}updateGpuSkinMatrices(e){for(const t of e){const s=t.skinInstance;s&&s._dirty&&(s.updateMatrixPalette(t.node,Gm),s._dirty=!1)}}updateMorphing(e){for(const t of e){const s=t.morphInstance;s&&s._dirty&&s.update()}}updateGSplats(e){for(const s of e){var t;(t=s.gsplatInstance)==null||t.update()}}gpuUpdate(e){this.updateGpuSkinMatrices(e),this.updateMorphing(e),this.updateGSplats(e)}setVertexBuffers(e,t){e.setVertexBuffer(t.vertexBuffer)}setMorphing(e,t){if(t)if(t.morph.useTextureMorph)e.setVertexBuffer(t.morph.vertexBufferIds),this.morphPositionTex.setValue(t.texturePositions),this.morphNormalTex.setValue(t.textureNormals),this.morphTexParams.setValue(t._textureParams);else{for(let s=0;s<t._activeVertexBuffers.length;s++){const i=t._activeVertexBuffers[s];if(i){const n=KA+(s+8);i.format.elements[0].name=n,i.format.elements[0].scopeId=e.scope.resolve(n),i.format.update(),e.setVertexBuffer(i)}}this.morphWeightsA.setValue(t._shaderMorphWeightsA),this.morphWeightsB.setValue(t._shaderMorphWeightsB)}}setSkinning(e,t){const s=t.skinInstance;if(s)if(this._skinDrawCalls++,e.supportsBoneTextures){const i=s.boneTexture;this.boneTextureId.setValue(i),this.boneTextureSizeId.setValue(s.boneTextureSize)}else this.poseMatrixId.setValue(s.matrixPalette)}dispatchViewPos(e){const t=this.viewPos;t[0]=e.x,t[1]=e.y,t[2]=e.z,this.viewPosId.setValue(t)}initViewBindGroupFormat(e){if(this.device.supportsUniformBuffers&&!this.viewUniformFormat){const t=[new vt("matrix_viewProjection",Ol),new vt("cubeMapRotationMatrix",bc),new vt("view_position",Rs),new vt("skyboxIntensity",bi),new vt("exposure",bi),new vt("textureBias",bi)];e&&t.push(new vt("clusterCellsCountByBoundsSize",Rs),new vt("clusterTextureSize",Rs),new vt("clusterBoundsMin",Rs),new vt("clusterBoundsDelta",Rs),new vt("clusterCellsDot",Rs),new vt("clusterCellsMax",Rs),new vt("clusterCompressionLimit0",kr),new vt("shadowAtlasParams",kr),new vt("clusterMaxCells",$a),new vt("clusterSkip",bi)),this.viewUniformFormat=new Hp(this.device,t);const s=[new Wp(pd,Gl|Ms)],i=[new ur("lightsTextureFloat",Ms,Is,Fa),new ur("lightsTexture8",Ms,Is,Fa),new ur("shadowAtlasTexture",Ms,Is,Dl),new ur("cookieAtlasTexture",Ms,Is,Oa),new ur("areaLightsLutTex1",Ms,Is,Oa),new ur("areaLightsLutTex2",Ms,Is,Oa)];e&&i.push(new ur("clusterWorldTexture",Ms,Is,Fa)),this.viewBindGroupFormat=new jp(this.device,s,i)}}setupViewUniformBuffers(e,t,s,i){const n=this.device;for(;e.length<i;){const o=new $p(n,t,!1),l=new gd(n,s,o);e.push(l)}const a=e[0];a.defaultUniformBuffer.update(),a.update(),n.setBindGroup(K_,a)}setupMeshUniformBuffers(e,t){const s=this.device;if(s.supportsUniformBuffers){this.modelMatrixId.setValue(t.node.worldTransform.data),this.normalMatrixId.setValue(t.node.normalMatrix.data);const i=e.getBindGroup(s);i.defaultUniformBuffer.update(),i.update(),s.setBindGroup(Tc,i)}}drawInstance(e,t,s,i,n){const a=t.node.worldTransform;this.modelMatrixId.setValue(a.data),n&&this.normalMatrixId.setValue(t.node.normalMatrix.data);const o=t.instancingData;o?o.count>0&&(this._instancedDrawCalls++,e.setVertexBuffer(o.vertexBuffer),e.draw(s.primitive[i],o.count)):e.draw(s.primitive[i])}drawInstance2(e,t,s,i){const n=t.instancingData;n?n.count>0&&(this._instancedDrawCalls++,e.draw(s.primitive[i],n.count,!0)):e.draw(s.primitive[i],void 0,!0)}cull(e,t,s){const i=s.opaque;i.length=0;const n=s.transparent;n.length=0;const a=e.frustumCulling,o=t.length;for(let l=0;l<o;l++){const c=t[l];c.visible&&(!a||!c.cull||c._isVisible(e))&&(c.visibleThisFrame=!0,(c.transparent?n:i).push(c),(c.skinInstance||c.morphInstance||c.gsplatInstance)&&(this.processingMeshInstances.add(c),c.gsplatInstance&&c.gsplatInstance.cameras.push(e)))}}collectLights(e){this.lights.length=0,this.localLights.length=0;const t=this.scene._stats,s=e.layerList.length;for(let i=0;i<s;i++){const n=e.layerList[i];if(!jm.has(n)){jm.add(n);const a=n._lights;for(let o=0;o<a.length;o++){const l=a[o];Wm.has(l)||(Wm.add(l),this.lights.push(l),l._type!==fe&&this.localLights.push(l))}}}t.lights=this.lights.length,Wm.clear(),jm.clear()}cullLights(e,t){const s=this.scene.clusteredLightingEnabled,i=this.scene.physicalUnits;for(let n=0;n<t.length;n++){const a=t[n];if(a.enabled)if(a._type!==fe)if(a.getBoundingSphere(Hm),e.frustum.containsSphere(Hm)){a.visibleThisFrame=!0,a.usePhysicalUnits=i;const o=e.getScreenSize(Hm);a.maxScreenSize=Math.max(a.maxScreenSize,o)}else s||a.castShadows&&!a.shadowMap&&(a.visibleThisFrame=!0);else a.usePhysicalUnits=this.scene.physicalUnits}}cullShadowmaps(e){const t=this.scene.clusteredLightingEnabled;for(let n=0;n<this.localLights.length;n++){const a=this.localLights[n];a._type!==fe&&(t?a.atlasSlotUpdated&&a.shadowUpdateMode===Ci&&(a.shadowUpdateMode=Ka):a.shadowUpdateMode===Ci&&a.castShadows&&(a.getRenderData(null,0).shadowCamera.renderTarget||(a.shadowUpdateMode=Ka)),a.visibleThisFrame&&a.castShadows&&a.shadowUpdateMode!==Ci&&this._shadowRendererLocal.cull(a,e))}this.cameraDirShadowLights.clear();const s=e.cameras;for(let n=0;n<s.length;n++){const a=s[n];if(a.enabled){const o=a.camera;let l;const c=o.layers;for(let d=0;d<c.length;d++){const h=e.getLayerById(c[d]);if(h){const u=h.splitLights[fe];for(let f=0;f<u.length;f++){const p=u[f];if(p.castShadows&&!Eo.has(p)){var i;Eo.add(p),l=(i=l)!=null?i:[],l.push(p),this._shadowRendererDirectional.cull(p,e,o)}}}}l&&this.cameraDirShadowLights.set(o,l),Eo.clear()}}}cullComposition(e){this.processingMeshInstances.clear();const t=e.cameras.length;for(let i=0;i<t;i++){const n=e.cameras[i];let a,o=!0;this._camerasRendered++;const l=n.layers;for(let c=0;c<l.length;c++){const d=e.getLayerById(l[c]);if(d&&d.enabled){var s;const h=(s=n.renderTarget)!=null?s:d.renderTarget;(o||h!==a)&&(o=!1,a=h,n.frameUpdate(h),this.updateCameraFrustum(n.camera)),this.cullLights(n.camera,d._lights),d.onPreCull==null||d.onPreCull(e.camerasMap.get(n));const u=d.getCulledInstances(n.camera);this.cull(n.camera,d.meshInstances,u),d.onPostCull==null||d.onPostCull(e.camerasMap.get(n))}}}this.scene.clusteredLightingEnabled&&this.updateLightTextureAtlas(),this.cullShadowmaps(e)}updateShaders(e,t){const s=e.length;for(let i=0;i<s;i++){const n=e[i].material;if(n&&!Eo.has(n)&&(Eo.add(n),n.getShaderVariant!==Jt.prototype.getShaderVariant)){if(t&&(!n.useLighting||n.emitter&&!n.emitter.lighting))continue;n.clearVariants()}}Eo.clear()}updateFrameUniforms(){this.blueNoiseTextureId.setValue(eF(this.device))}beginFrame(e){const t=this.scene,s=t.updateShaders,i=e.layerList,n=i.length;for(let l=0;l<n;l++){const d=i[l].meshInstances,h=d.length;for(let u=0;u<h;u++){const f=d[u];f.visibleThisFrame=!1,s&&$m.push(f),f.skinInstance&&Xm.push(f)}}if(s){const l=!t.updateShaders;this.updateShaders($m,l),t.updateShaders=!1,t._shaderVersion++}this.updateFrameUniforms(),this.updateCpuSkinMatrices(Xm),$m.length=0,Xm.length=0;const a=this.lights,o=a.length;for(let l=0;l<o;l++)a[l].beginFrame()}updateLightTextureAtlas(){this.lightTextureAtlas.update(this.localLights,this.scene.lighting)}updateLayerComposition(e){const t=e.layerList.length;for(let n=0;n<t;n++)e.layerList[n]._postRenderCounter=0;const i=this.scene._shaderVersion;for(let n=0;n<t;n++){const a=e.layerList[n];a._shaderVersion=i,a._preRenderCalledForCameras=0,a._postRenderCalledForCameras=0,e.subLayerList[n]?a._postRenderCounter|=2:a._postRenderCounter|=1,a._postRenderCounterMax=a._postRenderCounter}e._update()}frameUpdate(){this.clustersDebugRendered=!1,this.initViewBindGroupFormat(this.scene.clusteredLightingEnabled),this.dirLightShadows.clear()}}class Yb{constructor(){this.layer=null,this.transparent=!1,this.camera=null,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.lastCameraUse=!1,this.viewBindGroups=[],this.useCameraPasses=!1}destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy()}),this.viewBindGroups.length=0}setupClears(e,t){this.clearColor=(e==null?void 0:e.clearColorBuffer)||t.clearColorBuffer,this.clearDepth=(e==null?void 0:e.clearDepthBuffer)||t.clearDepthBuffer,this.clearStencil=(e==null?void 0:e.clearStencilBuffer)||t.clearStencilBuffer}}class hF extends Hs{constructor(e,t,s,i){super(e),this.layerComposition=void 0,this.scene=void 0,this.renderer=void 0,this.renderActions=[],this.noDepthClear=!1,this.layerComposition=t,this.scene=s,this.renderer=i}addRenderAction(e){this.renderActions.push(e)}addLayer(e,t,s,i=!0){const n=new Yb;if(n.renderTarget=this.renderTarget,n.camera=e,n.layer=t,n.transparent=s,i){const a=this.renderActions.length===0;n.setupClears(a?e:void 0,t)}this.addRenderAction(n)}addLayers(e,t,s,i,n,a=!0){const{layerList:o,subLayerEnabled:l,subLayerList:c}=e;let d=i,h=s;for(;h<o.length;){const u=o[h],f=c[h],p=u.enabled&&l[h],_=t.camera.layersSet.has(u.id);if(p&&_&&(this.addLayer(t,u,f,d),d=!1),h++,u.id===n&&f===a)break}return h}updateDirectionalShadows(){const{renderer:e,renderActions:t}=this;for(let s=0;s<t.length;s++){const a=t[s].camera.camera,o=this.renderer.cameraDirShadowLights.get(a);if(o)for(let l=0;l<o.length;l++){const c=o[l];if(e.dirLightShadows.get(c)!==a){e.dirLightShadows.set(c,a);const d=e._shadowRendererDirectional.getLightRenderPass(c,a);d&&this.beforePasses.push(d)}}}}updateClears(){const e=this.renderActions[0];if(e){const s=e.camera.camera,i=s.fullSizeClearRect;this.setClearColor(i&&e.clearColor?s.clearColor:void 0),this.setClearDepth(i&&e.clearDepth&&!this.noDepthClear?s.clearDepth:void 0),this.setClearStencil(i&&e.clearStencil?s.clearStencil:void 0)}}frameUpdate(){super.frameUpdate(),this.updateDirectionalShadows(),this.updateClears()}before(){const{renderActions:e}=this;if(e.length){const t=e[0];t.camera.onPreRender&&t.firstCameraUse&&t.camera.onPreRender()}}execute(){const{layerComposition:e,renderActions:t}=this;for(let s=0;s<t.length;s++){const i=t[s];e.isEnabled(i.layer,i.transparent)&&this.renderRenderAction(i,s===0)}}after(){const{renderActions:e}=this;if(e.length){const t=e[e.length-1];t.camera.onPostRender&&t.lastCameraUse&&t.camera.onPostRender()}this.beforePasses.length=0}renderRenderAction(e,t){const{renderer:s,layerComposition:i}=this,n=s.device,{layer:a,transparent:o,camera:l}=e,c=i.camerasMap.get(l);if(!o&&a.onPreRenderOpaque?a.onPreRenderOpaque(c):o&&a.onPreRenderTransparent&&a.onPreRenderTransparent(c),a._preRenderCalledForCameras&1<<c||(a.onPreRender&&a.onPreRender(c),a._preRenderCalledForCameras|=1<<c),l){var d,h;const u={lightClusters:e.lightClusters},f=(d=(h=l.camera.shaderPassInfo)==null?void 0:h.index)!=null?d:a.shaderPass;(!t||!l.camera.fullSizeClearRect)&&(u.clearColor=e.clearColor,u.clearDepth=e.clearDepth,u.clearStencil=e.clearStencil),s.renderForwardLayer(l.camera,e.renderTarget,a,o,f,e.viewBindGroups,u),n.setBlendState(Xe.NOBLEND),n.setStencilState(null,null),n.setAlphaToCoverage(!1)}!o&&a.onPostRenderOpaque?a.onPostRenderOpaque(c):o&&a.onPostRenderTransparent&&a.onPostRenderTransparent(c),a.onPostRender&&!(a._postRenderCalledForCameras&1<<c)&&(a._postRenderCounter&=~(o?2:1),a._postRenderCounter===0&&(a.onPostRender(c),a._postRenderCalledForCameras|=1<<c,a._postRenderCounter=a._postRenderCounterMax))}}class cF extends Hs{constructor(e,t,s){super(e),this.renderer=t,this.renderAction=s,this.requiresCubemaps=!1}execute(){this.renderAction.camera.onPostprocessing()}}const dF=[[],[],[]],Zr={drawCalls:[],shaderInstances:[],isNewMaterial:[],lightMaskChanged:[],clear:function(){this.drawCalls.length=0,this.shaderInstances.length=0,this.isNewMaterial.length=0,this.lightMaskChanged.length=0}};function uF(r){const e=[];for(let t=0;t<r;++t){const s=Math.sqrt(t+.5)/Math.sqrt(r);e.push(s)}return e}function fF(r){const e=[];for(let t=0;t<r;t++){const s=t/r,i=Math.sqrt(1-s*s);e.push(i)}return e}class Zb extends lF{constructor(e){super(e);const t=this.device;this._forwardDrawCalls=0,this._materialSwitches=0,this._depthMapTime=0,this._forwardTime=0,this._sortTime=0;const s=t.scope;this.fogColorId=s.resolve("fog_color"),this.fogStartId=s.resolve("fog_start"),this.fogEndId=s.resolve("fog_end"),this.fogDensityId=s.resolve("fog_density"),this.ambientId=s.resolve("light_globalAmbient"),this.skyboxIntensityId=s.resolve("skyboxIntensity"),this.cubeMapRotationMatrixId=s.resolve("cubeMapRotationMatrix"),this.pcssDiskSamplesId=s.resolve("pcssDiskSamples[0]"),this.pcssSphereSamplesId=s.resolve("pcssSphereSamples[0]"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowIntensity=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.lightShadowSearchAreaId=[],this.lightCameraParamsId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.screenSizeId=s.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.pcssDiskSamples=uF(16),this.pcssSphereSamples=fF(16)}destroy(){super.destroy()}dispatchGlobalLights(e){if(this.ambientColor[0]=e.ambientLight.r,this.ambientColor[1]=e.ambientLight.g,this.ambientColor[2]=e.ambientLight.b,e.gammaCorrection)for(let t=0;t<3;t++)this.ambientColor[t]=Math.pow(this.ambientColor[t],2.2);if(e.physicalUnits)for(let t=0;t<3;t++)this.ambientColor[t]*=e.ambientLuminance;this.ambientId.setValue(this.ambientColor),this.skyboxIntensityId.setValue(e.physicalUnits?e.skyboxLuminance:e.skyboxIntensity),this.cubeMapRotationMatrixId.setValue(e._skyboxRotationMat3.data)}_resolveLight(e,t){const s="light"+t;this.lightColorId[t]=e.resolve(s+"_color"),this.lightDir[t]=new Float32Array(3),this.lightDirId[t]=e.resolve(s+"_direction"),this.lightShadowMapId[t]=e.resolve(s+"_shadowMap"),this.lightShadowMatrixId[t]=e.resolve(s+"_shadowMatrix"),this.lightShadowParamsId[t]=e.resolve(s+"_shadowParams"),this.lightShadowIntensity[t]=e.resolve(s+"_shadowIntensity"),this.lightShadowSearchAreaId[t]=e.resolve(s+"_shadowSearchArea"),this.lightRadiusId[t]=e.resolve(s+"_radius"),this.lightPos[t]=new Float32Array(3),this.lightPosId[t]=e.resolve(s+"_position"),this.lightWidth[t]=new Float32Array(3),this.lightWidthId[t]=e.resolve(s+"_halfWidth"),this.lightHeight[t]=new Float32Array(3),this.lightHeightId[t]=e.resolve(s+"_halfHeight"),this.lightInAngleId[t]=e.resolve(s+"_innerConeAngle"),this.lightOutAngleId[t]=e.resolve(s+"_outerConeAngle"),this.lightCookieId[t]=e.resolve(s+"_cookie"),this.lightCookieIntId[t]=e.resolve(s+"_cookieIntensity"),this.lightCookieMatrixId[t]=e.resolve(s+"_cookieMatrix"),this.lightCookieOffsetId[t]=e.resolve(s+"_cookieOffset"),this.lightCameraParamsId[t]=e.resolve(s+"_cameraParams"),this.shadowMatrixPaletteId[t]=e.resolve(s+"_shadowMatrixPalette[0]"),this.shadowCascadeDistancesId[t]=e.resolve(s+"_shadowCascadeDistances[0]"),this.shadowCascadeCountId[t]=e.resolve(s+"_shadowCascadeCount")}setLTCDirectionalLight(e,t,s,i,n){this.lightPos[t][0]=i.x-s.x*n,this.lightPos[t][1]=i.y-s.y*n,this.lightPos[t][2]=i.z-s.z*n,this.lightPosId[t].setValue(this.lightPos[t]);const a=e.transformVector(new y(-.5,0,0));this.lightWidth[t][0]=a.x*n,this.lightWidth[t][1]=a.y*n,this.lightWidth[t][2]=a.z*n,this.lightWidthId[t].setValue(this.lightWidth[t]);const o=e.transformVector(new y(0,0,.5));this.lightHeight[t][0]=o.x*n,this.lightHeight[t][1]=o.y*n,this.lightHeight[t][2]=o.z*n,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchDirectLights(e,t,s,i){let n=0;const a=this.device.scope;for(let o=0;o<e.length;o++){if(!(e[o].mask&s))continue;const l=e[o],c=l._node.getWorldTransform();if(this.lightColorId[n]||this._resolveLight(a,n),this.lightColorId[n].setValue(t.gammaCorrection?l._linearFinalColor:l._finalColor),c.getY(l._direction).mulScalar(-1),l._direction.normalize(),this.lightDir[n][0]=l._direction.x,this.lightDir[n][1]=l._direction.y,this.lightDir[n][2]=l._direction.z,this.lightDirId[n].setValue(this.lightDir[n]),l.shape!==Ut&&this.setLTCDirectionalLight(c,n,l._direction,i._node.getPosition(),i.farClip),l.castShadows){const d=l.getRenderData(i,0),h=l._getUniformBiasValues(d);this.lightShadowMapId[n].setValue(d.shadowBuffer),this.lightShadowMatrixId[n].setValue(d.shadowMatrix.data),this.shadowMatrixPaletteId[n].setValue(l._shadowMatrixPalette),this.shadowCascadeDistancesId[n].setValue(l._shadowCascadeDistances),this.shadowCascadeCountId[n].setValue(l.numCascades),this.lightShadowIntensity[n].setValue(l.shadowIntensity);const u=50/d.projectionCompensation,f=l.penumbraSize/d.shadowCamera.renderTarget.width;this.lightShadowSearchAreaId[n].setValue(f*u);const p=l._shadowCameraParams;p.length=4,p[0]=d.depthRangeCompensation,p[1]=d.shadowCamera._farClip,p[2]=d.shadowCamera._nearClip,p[3]=1,this.lightCameraParamsId[n].setValue(p);const _=l._shadowRenderParams;_.length=4,_[0]=l._shadowResolution,_[1]=h.normalBias,_[2]=h.bias,_[3]=0,this.lightShadowParamsId[n].setValue(_)}n++}return n}setLTCPositionalLight(e,t){const s=e.transformVector(new y(-.5,0,0));this.lightWidth[t][0]=s.x,this.lightWidth[t][1]=s.y,this.lightWidth[t][2]=s.z,this.lightWidthId[t].setValue(this.lightWidth[t]);const i=e.transformVector(new y(0,0,.5));this.lightHeight[t][0]=i.x,this.lightHeight[t][1]=i.y,this.lightHeight[t][2]=i.z,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchOmniLight(e,t,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(t,i),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(e.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),s.shape!==Ut&&this.setLTCPositionalLight(n,i),s.castShadows){const a=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(a.shadowBuffer);const o=s._getUniformBiasValues(a),l=s._shadowRenderParams;l.length=4,l[0]=s._shadowResolution,l[1]=o.normalBias,l[2]=o.bias,l[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(l),this.lightShadowIntensity[i].setValue(s.shadowIntensity);const c=s.penumbraSize/a.shadowCamera.renderTarget.width;this.lightShadowSearchAreaId[i].setValue(c);const d=s._shadowCameraParams;d.length=4,d[0]=a.depthRangeCompensation,d[1]=a.shadowCamera._farClip,d[2]=a.shadowCamera._nearClip,d[3]=0,this.lightCameraParamsId[i].setValue(d)}s._cookie&&(this.lightCookieId[i].setValue(s._cookie),this.lightShadowMatrixId[i].setValue(n.data),this.lightCookieIntId[i].setValue(s.cookieIntensity))}dispatchSpotLight(e,t,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(t,i),this.lightInAngleId[i].setValue(s._innerConeAngleCos),this.lightOutAngleId[i].setValue(s._outerConeAngleCos),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(e.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),s.shape!==Ut&&this.setLTCPositionalLight(n,i),n.getY(s._direction).mulScalar(-1),s._direction.normalize(),this.lightDir[i][0]=s._direction.x,this.lightDir[i][1]=s._direction.y,this.lightDir[i][2]=s._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),s.castShadows){const a=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(a.shadowBuffer),this.lightShadowMatrixId[i].setValue(a.shadowMatrix.data);const o=s._getUniformBiasValues(a),l=s._shadowRenderParams;l.length=4,l[0]=s._shadowResolution,l[1]=o.normalBias,l[2]=o.bias,l[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(l),this.lightShadowIntensity[i].setValue(s.shadowIntensity);const c=s.penumbraSize/a.shadowCamera.renderTarget.width,d=a.shadowCamera._fov*Math.PI/180,h=1/Math.tan(d/2);this.lightShadowSearchAreaId[i].setValue(c*h);const u=s._shadowCameraParams;u.length=4,u[0]=a.depthRangeCompensation,u[1]=a.shadowCamera._farClip,u[2]=a.shadowCamera._nearClip,u[3]=0,this.lightCameraParamsId[i].setValue(u)}if(s._cookie){if(!s.castShadows){const a=Ei.evalSpotCookieMatrix(s);this.lightShadowMatrixId[i].setValue(a.data)}this.lightCookieId[i].setValue(s._cookie),this.lightCookieIntId[i].setValue(s.cookieIntensity),s._cookieTransform&&(s._cookieTransformUniform[0]=s._cookieTransform.x,s._cookieTransformUniform[1]=s._cookieTransform.y,s._cookieTransformUniform[2]=s._cookieTransform.z,s._cookieTransformUniform[3]=s._cookieTransform.w,this.lightCookieMatrixId[i].setValue(s._cookieTransformUniform),s._cookieOffsetUniform[0]=s._cookieOffset.x,s._cookieOffsetUniform[1]=s._cookieOffset.y,this.lightCookieOffsetId[i].setValue(s._cookieOffsetUniform))}}dispatchLocalLights(e,t,s,i){let n=i;const a=this.device.scope,o=e[Oe],l=o.length;for(let h=0;h<l;h++){const u=o[h];u.mask&s&&(this.dispatchOmniLight(t,a,u,n),n++)}const c=e[Ge],d=c.length;for(let h=0;h<d;h++){const u=c[h];u.mask&s&&(this.dispatchSpotLight(t,a,u,n),n++)}}renderForwardPrepareMaterials(e,t,s,i,n){var a;const o=(m,g,v,x)=>{Zr.drawCalls.push(m),Zr.shaderInstances.push(g),Zr.isNewMaterial.push(v),Zr.lightMaskChanged.push(x)};Zr.clear();const l=this.device,c=this.scene,d=c.clusteredLightingEnabled,h=(a=i==null?void 0:i.getLightHash(d))!=null?a:0;let u=null,f,p;const _=t.length;for(let m=0;m<_;m++){const g=t[m];g.ensureMaterial(l);const v=g.material,x=g._shaderDefs,S=g.mask;v&&v===u&&x!==f&&(u=null),v!==u&&(this._materialSwitches++,v._scene=c,v.dirty&&(v.updateUniforms(l,c),v.dirty=!1));const w=g.getShaderInstance(n,h,c,this.viewUniformFormat,this.viewBindGroupFormat,s);o(g,w,v!==u,!u||S!==p),u=v,f=x,p=S}return Zr}renderForwardInternal(e,t,s,i,n,a){const o=this.device,l=this.scene,c=1<<i,d=a?-1:1,h=this.scene.clusteredLightingEnabled,u=t.drawCalls.length;for(let _=0;_<u;_++){var f,p;const m=t.drawCalls[_],g=t.isNewMaterial[_],v=t.lightMaskChanged[_],x=t.shaderInstances[_],S=m.material,w=m.mask;if(g){if(o.setShader(x.shader,!1),S.setParameters(o),v){const B=this.dispatchDirectLights(s[fe],l,w,e);h||this.dispatchLocalLights(s,l,w,B)}this.alphaTestId.setValue(S.alphaTest),o.setBlendState(S.blendState),o.setDepthState(S.depthState),o.setAlphaToCoverage(S.alphaToCoverage)}this.setupCullMode(e._cullFaces,d,m);const T=(f=m.stencilFront)!=null?f:S.stencilFront,b=(p=m.stencilBack)!=null?p:S.stencilBack;o.setStencilState(T,b);const C=m.mesh;m.setParameters(o,c),this.setVertexBuffers(o,C),this.setMorphing(o,m.morphInstance),this.setSkinning(o,m),this.setupMeshUniformBuffers(x,m);const E=m.renderStyle;if(o.setIndexBuffer(C.indexBuffer[E]),n==null||n(m,_),e.xr&&e.xr.session&&e.xr.views.list.length){const R=e.xr.views;for(let B=0;B<R.list.length;B++){const L=R.list[B];o.setViewport(L.viewport.x,L.viewport.y,L.viewport.z,L.viewport.w),this.projId.setValue(L.projMat.data),this.projSkyboxId.setValue(L.projMat.data),this.viewId.setValue(L.viewOffMat.data),this.viewInvId.setValue(L.viewInvOffMat.data),this.viewId3.setValue(L.viewMat3.data),this.viewProjId.setValue(L.projViewOffMat.data),this.viewPosId.setValue(L.positionData),this.viewIndexId.setValue(B),B===0?this.drawInstance(o,m,C,E,!0):this.drawInstance2(o,m,C,E),this._forwardDrawCalls++}}else this.drawInstance(o,m,C,E,!0),this._forwardDrawCalls++;_<u-1&&!t.isNewMaterial[_+1]&&S.setParameters(o,m.parameters)}}renderForward(e,t,s,i,n,a,o){const l=this.renderForwardPrepareMaterials(e,t,s,a,i);this.renderForwardInternal(e,l,s,i,n,o),Zr.clear()}renderForwardLayer(e,t,s,i,n,a,o={}){var l,c,d;const{scene:h,device:u}=this,f=h.clusteredLightingEnabled;this.setupViewport(e,t);const p=(l=o.clearColors)!=null?l:!1,_=(c=o.clearDepth)!=null?c:!1,m=(d=o.clearStencil)!=null?d:!1;(p||_||m)&&this.clear(e,p,_,m);let g,v;if(s){s.sortVisible(e,i);const C=s.getCulledInstances(e);g=i?C.transparent:C.opaque,h.immediate.onPreRenderLayer(s,g,i),s.requiresLightCube&&(this.lightCube.update(h.ambientLight,s._lights),this.constantLightCube.setValue(this.lightCube.colors)),v=s.splitLights}else{var x;g=o.meshInstances,v=(x=o.splitLights)!=null?x:dF}if(f){var S;((S=o.lightClusters)!=null?S:this.worldClustersAllocator.empty).activate(),s&&!this.clustersDebugRendered&&h.lighting.debugLayer===s.id&&(this.clustersDebugRendered=!0)}h._activeCamera=e;const w=this.setCameraUniforms(e,t);u.supportsUniformBuffers&&this.setupViewUniformBuffers(a,this.viewUniformFormat,this.viewBindGroupFormat,w);const T=!!(e._flipFaces^(t==null?void 0:t.flipY)),b=this._forwardDrawCalls;this.renderForward(e,g,v,n,s==null?void 0:s.onDrawCall,s,T),s&&(s._forwardDrawCalls+=this._forwardDrawCalls-b)}setSceneConstants(){const e=this.scene;if(this.dispatchGlobalLights(e),e.fog!==qp){if(this.fogColor[0]=e.fogColor.r,this.fogColor[1]=e.fogColor.g,this.fogColor[2]=e.fogColor.b,e.gammaCorrection)for(let s=0;s<3;s++)this.fogColor[s]=Math.pow(this.fogColor[s],2.2);this.fogColorId.setValue(this.fogColor),e.fog===oI?(this.fogStartId.setValue(e.fogStart),this.fogEndId.setValue(e.fogEnd)):this.fogDensityId.setValue(e.fogDensity)}const t=this.device;this._screenSize[0]=t.width,this._screenSize[1]=t.height,this._screenSize[2]=1/t.width,this._screenSize[3]=1/t.height,this.screenSizeId.setValue(this._screenSize),this.pcssDiskSamplesId.setValue(this.pcssDiskSamples),this.pcssSphereSamplesId.setValue(this.pcssSphereSamples)}buildFrameGraph(e,t){const s=this.scene,i=this.device.isWebGL1;if(e.reset(),this.update(t),s.clusteredLightingEnabled){const{shadowsEnabled:c,cookiesEnabled:d}=s.lighting;this._renderPassUpdateClustered.update(e,c,d,this.lights,this.localLights),e.addRenderPass(this._renderPassUpdateClustered)}else this._shadowRendererLocal.buildNonClusteredRenderPasses(e,this.localLights);let n=0,a=!0,o=null;const l=t._renderActions;for(let c=n;c<l.length;c++){const d=l[c],{layer:h,camera:u}=d;if(d.useCameraPasses)u.camera.renderPasses.forEach(f=>{e.addRenderPass(f)});else{const f=u.camera.renderPassDepthGrab;f&&i&&d.firstCameraUse&&(f.options.resizeSource=u.camera.renderTarget,f.update(this.scene),e.addRenderPass(f));const p=h.id===_s;if(i&&p&&!u.renderSceneColorMap)continue;const _=p&&(u.renderSceneColorMap||u.renderSceneDepthMap);a&&(a=!1,n=c,o=d.renderTarget);const m=l[c+1],v=(m?m.layer.id===_s:!1)&&(u.renderSceneColorMap||u.renderSceneDepthMap)&&!i,x=m?m.firstCameraUse&&this.cameraDirShadowLights.has(m.camera.camera):!1;if(!m||m.renderTarget!==o||x||v||_){if(p&&n===c||this.addMainRenderPass(e,t,o,n,c),p){if(u.renderSceneColorMap){const w=u.camera.renderPassColorGrab;w.source=u.renderTarget,e.addRenderPass(w)}u.renderSceneDepthMap&&!i&&e.addRenderPass(u.camera.renderPassDepthGrab)}if(d.triggerPostprocess&&u!=null&&u.onPostprocessing){const w=new cF(this.device,this,d);e.addRenderPass(w)}a=!0}}}}addMainRenderPass(e,t,s,i,n){const a=new hF(this.device,t,this.scene,this);a.init(s);const o=t._renderActions;for(let l=i;l<=n;l++)a.addRenderAction(o[l]);e.addRenderPass(a)}update(e){this.frameUpdate(),this.shadowRenderer.frameUpdate(),this.scene._updateSkyMesh(),this.updateLayerComposition(e),this.collectLights(e),this.beginFrame(e),this.setSceneConstants(),this.cullComposition(e),this.gpuUpdate(this.processingMeshInstances)}}function pF(r,e){return r.drawOrder-e.drawOrder}function mF(r,e){const t=r._key[Rn],s=e._key[Rn];return t===s&&r.mesh&&e.mesh?e.mesh.id-r.mesh.id:s-t}function _F(r,e){return e.zdist-r.zdist}function gF(r,e){return r.zdist-e.zdist}const yF=[null,pF,mF,_F,gF];let qm=0;const Sh=[],su=new Set;class vF{constructor(){this.opaque=[],this.transparent=[]}}class mr{constructor(e={}){var t,s,i,n;this.meshInstances=[],this.meshInstancesSet=new Set,this.shadowCasters=[],this.shadowCastersSet=new Set,this._visibleInstances=new WeakMap,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this._splitLightsDirty=!0,this.requiresLightCube=!1,this.cameras=[],this.camerasSet=new Set,this._dirtyComposition=!1,e.id!==void 0?(this.id=e.id,qm=Math.max(this.id+1,qm)):this.id=qm++,this.name=e.name,this._enabled=(t=e.enabled)!=null?t:!0,this._refCounter=this._enabled?1:0,this.opaqueSortMode=(s=e.opaqueSortMode)!=null?s:bI,this.transparentSortMode=(i=e.transparentSortMode)!=null?i:Gv,e.renderTarget&&(this.renderTarget=e.renderTarget),this.shaderPass=(n=e.shaderPass)!=null?n:wd,this._clearColorBuffer=!!e.clearColorBuffer,this._clearDepthBuffer=!!e.clearDepthBuffer,this._clearStencilBuffer=!!e.clearStencilBuffer,this.onPreCull=e.onPreCull,this.onPreRender=e.onPreRender,this.onPreRenderOpaque=e.onPreRenderOpaque,this.onPreRenderTransparent=e.onPreRenderTransparent,this.onPostCull=e.onPostCull,this.onPostRender=e.onPostRender,this.onPostRenderOpaque=e.onPostRenderOpaque,this.onPostRenderTransparent=e.onPostRenderTransparent,this.onDrawCall=e.onDrawCall,this.onEnable=e.onEnable,this.onDisable=e.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.layerReference=e.layerReference,this.customSortCallback=null,this.customCalculateSortValues=null,this._lightHash=0,this._lightHashDirty=!1,this._lightIdHash=0,this._lightIdHashDirty=!1,this._shaderVersion=-1}set enabled(e){e!==this._enabled&&(this._dirtyComposition=!0,this._enabled=e,e?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}get enabled(){return this._enabled}set clearColorBuffer(e){this._clearColorBuffer=e,this._dirtyComposition=!0}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(e){this._clearDepthBuffer=e,this._dirtyComposition=!0}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(e){this._clearStencilBuffer=e,this._dirtyComposition=!0}get clearStencilBuffer(){return this._clearStencilBuffer}get hasClusteredLights(){return this._clusteredLightsSet.size>0}get clusteredLightsSet(){return this._clusteredLightsSet}incrementCounter(){this._refCounter===0&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++}decrementCounter(){if(this._refCounter===1)this._enabled=!1,this.onDisable&&this.onDisable();else if(this._refCounter===0)return;this._refCounter--}addMeshInstances(e,t){const s=this.meshInstances,i=this.meshInstancesSet;for(let n=0;n<e.length;n++){const a=e[n];i.has(a)||(s.push(a),i.add(a),su.add(a.material))}if(t||this.addShadowCasters(e),su.size>0){const n=this._shaderVersion;su.forEach(a=>{n>=0&&a._shaderVersion!==n&&(a.getShaderVariant!==Jt.prototype.getShaderVariant&&a.clearVariants(),a._shaderVersion=n)}),su.clear()}}removeMeshInstances(e,t){const s=this.meshInstances,i=this.meshInstancesSet;for(let n=0;n<e.length;n++){const a=e[n];if(i.has(a)){i.delete(a);const o=s.indexOf(a);o>=0&&s.splice(o,1)}}t||this.removeShadowCasters(e)}addShadowCasters(e){const t=this.shadowCasters,s=this.shadowCastersSet;for(let i=0;i<e.length;i++){const n=e[i];n.castShadow&&!s.has(n)&&(s.add(n),t.push(n))}}removeShadowCasters(e){const t=this.shadowCasters,s=this.shadowCastersSet;for(let i=0;i<e.length;i++){const n=e[i];if(s.has(n)){s.delete(n);const a=t.indexOf(n);a>=0&&t.splice(a,1)}}}clearMeshInstances(e=!1){this.meshInstances.length=0,this.meshInstancesSet.clear(),e||(this.shadowCasters.length=0,this.shadowCastersSet.clear())}markLightsDirty(){this._lightHashDirty=!0,this._lightIdHashDirty=!0,this._splitLightsDirty=!0}addLight(e){const t=e.light;this._lightsSet.has(t)||(this._lightsSet.add(t),this._lights.push(t),this.markLightsDirty()),t.type!==fe&&this._clusteredLightsSet.add(t)}removeLight(e){const t=e.light;this._lightsSet.has(t)&&(this._lightsSet.delete(t),this._lights.splice(this._lights.indexOf(t),1),this.markLightsDirty()),t.type!==fe&&this._clusteredLightsSet.delete(t)}clearLights(){this._lightsSet.forEach(e=>e.removeLayer(this)),this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this.markLightsDirty()}get splitLights(){if(this._splitLightsDirty){this._splitLightsDirty=!1;const e=this._splitLights;for(let s=0;s<e.length;s++)e[s].length=0;const t=this._lights;for(let s=0;s<t.length;s++){const i=t[s];i.enabled&&e[i._type].push(i)}for(let s=0;s<e.length;s++)e[s].sort((i,n)=>i.key-n.key)}return this._splitLights}evaluateLightHash(e,t,s){let i=0;const n=this._lights;for(let a=0;a<n.length;a++){const o=n[a].type!==fe;(e&&o||t&&!o)&&Sh.push(s?n[a].id:n[a].key)}return Sh.length>0&&(Sh.sort(),i=cb(Sh),Sh.length=0),i}getLightHash(e){return this._lightHashDirty&&(this._lightHashDirty=!1,this._lightHash=this.evaluateLightHash(!e,!0,!1)),this._lightHash}getLightIdHash(){return this._lightIdHashDirty&&(this._lightIdHashDirty=!1,this._lightIdHash=this.evaluateLightHash(!0,!1,!0)),this._lightIdHash}addCamera(e){this.camerasSet.has(e.camera)||(this.camerasSet.add(e.camera),this.cameras.push(e),this._dirtyComposition=!0)}removeCamera(e){if(this.camerasSet.has(e.camera)){this.camerasSet.delete(e.camera);const t=this.cameras.indexOf(e);this.cameras.splice(t,1),this._dirtyComposition=!0}}clearCameras(){this.cameras.length=0,this.camerasSet.clear(),this._dirtyComposition=!0}_calculateSortDistances(e,t,s,i){for(let n=0;n<t;n++){const a=e[n];if(a.layer<=hI)continue;if(a.calculateSortDistance){a.zdist=a.calculateSortDistance(a,s,i);continue}const o=a.aabb.center,l=o.x-s.x,c=o.y-s.y,d=o.z-s.z;a.zdist=l*i.x+c*i.y+d*i.z}}getCulledInstances(e){let t=this._visibleInstances.get(e);return t||(t=new vF,this._visibleInstances.set(e,t)),t}sortVisible(e,t){const s=t?this.transparentSortMode:this.opaqueSortMode;if(s===Vu)return;const i=this.getCulledInstances(e),n=t?i.transparent:i.opaque,a=e.node;if(s===EI){const o=a.getPosition(),l=a.forward;this.customCalculateSortValues&&this.customCalculateSortValues(n,n.length,o,l),this.customSortCallback&&n.sort(this.customSortCallback)}else{if(s===Gv||s===TI){const o=a.getPosition(),l=a.forward;this._calculateSortDistances(n,n.length,o,l)}n.sort(yF[s])}}}const SF=(r,e)=>r.priority-e.priority,Fc=r=>r.sort(SF);class dg extends ie{constructor(e="Untitled"){super(),this.layerList=[],this.layerIdMap=new Map,this.layerNameMap=new Map,this.layerOpaqueIndexMap=new Map,this.layerTransparentIndexMap=new Map,this.subLayerList=[],this.subLayerEnabled=[],this.cameras=[],this.camerasMap=new Map,this._renderActions=[],this._dirty=!1,this.name=e,this._opaqueOrder={},this._transparentOrder={}}destroy(){this.destroyRenderActions()}destroyRenderActions(){this._renderActions.forEach(e=>e.destroy()),this._renderActions.length=0}_update(){const e=this.layerList.length;if(!this._dirty){for(let t=0;t<e;t++)if(this.layerList[t]._dirtyComposition){this._dirty=!0;break}}if(this._dirty){this._dirty=!1,this.cameras.length=0;for(let s=0;s<e;s++){const i=this.layerList[s];i._dirtyComposition=!1;for(let n=0;n<i.cameras.length;n++){const a=i.cameras[n];this.cameras.indexOf(a)<0&&this.cameras.push(a)}}this.cameras.length>1&&Fc(this.cameras),this.camerasMap.clear();for(let s=0;s<this.cameras.length;s++)this.camerasMap.set(this.cameras[s],s);let t=0;this.destroyRenderActions();for(let s=0;s<this.cameras.length;s++){const i=this.cameras[s];if(i.camera.renderPasses.length>0){this.addDummyRenderAction(t,i),t++;continue}let n=!0;const a=t;let o=null,l=!1;for(let c=0;c<e;c++){const d=this.layerList[c];if(d.enabled&&this.subLayerEnabled[c]&&d.cameras.length>0&&i.layers.indexOf(d.id)>=0){!l&&d.id===i.disablePostEffectsLayer&&(l=!0,o&&(o.triggerPostprocess=!0));const u=this.subLayerList[c];o=this.addRenderAction(t,d,u,i,n,l),t++,n=!1}}a<t&&(o.lastCameraUse=!0),!l&&o&&(o.triggerPostprocess=!0),i.renderTarget&&i.postEffectsEnabled&&this.propagateRenderTarget(a-1,i)}this._logRenderActions()}}getNextRenderAction(e){const t=new Yb;return this._renderActions.push(t),t}addDummyRenderAction(e,t){const s=this.getNextRenderAction(e);s.camera=t,s.useCameraPasses=!0}addRenderAction(e,t,s,i,n,a){let o=t.renderTarget;i&&i.renderTarget&&t.id!==_s&&(o=i.renderTarget);let l=!1;const c=this._renderActions;for(let f=e-1;f>=0;f--)if(c[f].camera===i&&c[f].renderTarget===o){l=!0;break}a&&i.postEffectsEnabled&&(o=null);const d=this.getNextRenderAction(e);d.triggerPostprocess=!1,d.layer=t,d.transparent=s,d.camera=i,d.renderTarget=o,d.firstCameraUse=n,d.lastCameraUse=!1;const h=n||!l,u=t.clearColorBuffer||t.clearDepthBuffer||t.clearStencilBuffer;return(h||u)&&d.setupClears(h?i:void 0,t),d}propagateRenderTarget(e,t){for(let s=e;s>=0;s--){const i=this._renderActions[s],n=i.layer;if(i.renderTarget&&n.id!==_s)break;if(n.id===_s)continue;if(i.useCameraPasses)break;const a=i==null?void 0:i.camera.camera;if(a&&(!t.camera.rect.equals(a.rect)||!t.camera.scissorRect.equals(a.scissorRect)))break;i.renderTarget=t.renderTarget}}_logRenderActions(){}_isLayerAdded(e){return this.layerIdMap.get(e.id)===e}_isSublayerAdded(e,t){return(t?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).get(e)!==void 0}push(e){this._isLayerAdded(e)||(this.layerList.push(e),this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insert(e,t){if(this._isLayerAdded(e))return;this.layerList.splice(t,0,e,e),this.subLayerList.splice(t,0,!1,!0);const s=this.layerList.length;this._updateOpaqueOrder(t,s-1),this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}remove(e){let t=this.layerList.indexOf(e);for(delete this._opaqueOrder[t],delete this._transparentOrder[t];t>=0;)this.layerList.splice(t,1),this.subLayerList.splice(t,1),this.subLayerEnabled.splice(t,1),t=this.layerList.indexOf(e),this._dirty=!0,this.fire("remove",e);const s=this.layerList.length;this._updateOpaqueOrder(0,s-1),this._updateTransparentOrder(0,s-1),this._updateLayerMaps()}pushOpaque(e){this._isSublayerAdded(e,!1)||(this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insertOpaque(e,t){if(this._isSublayerAdded(e,!1))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!1);const s=this.subLayerList.length;this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}removeOpaque(e){for(let t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&!this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}this._updateLayerMaps()}pushTransparent(e){this._isSublayerAdded(e,!0)||(this.layerList.push(e),this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insertTransparent(e,t){if(this._isSublayerAdded(e,!0))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!0);const s=this.subLayerList.length;this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}removeTransparent(e){for(let t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}this._updateLayerMaps()}getOpaqueIndex(e){var t;return(t=this.layerOpaqueIndexMap.get(e))!=null?t:-1}getTransparentIndex(e){var t;return(t=this.layerTransparentIndexMap.get(e))!=null?t:-1}isEnabled(e,t){const s=t?this.getTransparentIndex(e):this.getOpaqueIndex(e);return this.subLayerEnabled[s]}_updateLayerMaps(){this.layerIdMap.clear(),this.layerNameMap.clear(),this.layerOpaqueIndexMap.clear(),this.layerTransparentIndexMap.clear();for(let e=0;e<this.layerList.length;e++){const t=this.layerList[e];this.layerIdMap.set(t.id,t),this.layerNameMap.set(t.name,t),(this.subLayerList[e]?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).set(t,e)}}getLayerById(e){var t;return(t=this.layerIdMap.get(e))!=null?t:null}getLayerByName(e){var t;return(t=this.layerNameMap.get(e))!=null?t:null}_updateOpaqueOrder(e,t){for(let s=e;s<=t;s++)this.subLayerList[s]===!1&&(this._opaqueOrder[this.layerList[s].id]=s)}_updateTransparentOrder(e,t){for(let s=e;s<=t;s++)this.subLayerList[s]===!0&&(this._transparentOrder[this.layerList[s].id]=s)}_sortLayersDescending(e,t,s){let i=-1,n=-1;for(let a=0,o=e.length;a<o;a++){const l=e[a];s.hasOwnProperty(l)&&(i=Math.max(i,s[l]))}for(let a=0,o=t.length;a<o;a++){const l=t[a];s.hasOwnProperty(l)&&(n=Math.max(n,s[l]))}return i===-1&&n!==-1?1:n===-1&&i!==-1?-1:n-i}sortTransparentLayers(e,t){return this._sortLayersDescending(e,t,this._transparentOrder)}sortOpaqueLayers(e,t){return this._sortLayersDescending(e,t,this._opaqueOrder)}}const iu=new y,fi={bias:0,normalBias:0},Km={r:0,g:1,b:2,a:3},ug={directional:fe,omni:Oe,point:Oe,spot:Ge},xF=[[new P(0,0,1,1)],[new P(0,0,.5,.5),new P(0,.5,.5,.5)],[new P(0,0,.5,.5),new P(0,.5,.5,.5),new P(.5,0,.5,.5)],[new P(0,0,.5,.5),new P(0,.5,.5,.5),new P(.5,0,.5,.5),new P(.5,.5,.5,.5)]];let wF=0;class bF{constructor(e,t,s,i){this.light=i,this.camera=t,this.shadowCamera=Jp.createShadowCamera(e,i._shadowType,i._type,s),this.shadowMatrix=new q,this.shadowViewport=new P(0,0,1,1),this.shadowScissor=new P(0,0,1,1),this.depthRangeCompensation=0,this.projectionCompensation=0,this.face=s,this.visibleCasters=[],this.viewBindGroups=[]}destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy()}),this.viewBindGroups.length=0}get shadowBuffer(){const e=this.shadowCamera.renderTarget;if(e){const t=this.light;return t._type===Oe?e.colorBuffer:t._isPcf&&t.device.supportsDepthShadow?e.depthBuffer:e.colorBuffer}return null}}class kc{constructor(e,t){this.layers=new Set,this.clusteredLighting=void 0,this.shadowDepthState=kt.DEFAULT.clone(),this.device=e,this.clusteredLighting=t,this.id=wF++,this._type=fe,this._color=new k(.8,.8,.8),this._intensity=1,this._affectSpecularity=!0,this._luminance=0,this._castShadows=!1,this._enabled=!1,this._mask=Fs,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=Vy,this._shadowType=xt,this._vsmBlurSize=11,this.vsmBlurMode=Gy,this.vsmBias=.01*.25,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this.cascadeDistribution=.5,this._shape=Ut,this._finalColor=new Float32Array([.8,.8,.8]);const s=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([s,s,s]),this._position=new y(0,0,0),this._direction=new y(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._updateOuterAngle(this._outerConeAngle),this._usePhysicalUnits=void 0,this._shadowMap=null,this._shadowRenderParams=[],this._shadowCameraParams=[],this.shadowDistance=40,this._shadowResolution=1024,this._shadowBias=-5e-4,this.shadowIntensity=1,this._normalOffsetBias=0,this.shadowUpdateMode=Xy,this.shadowUpdateOverrides=null,this._penumbraSize=1,this._isVsm=!1,this._isPcf=!0,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=!1,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=!1,this._node=null,this._renderData=[],this.visibleThisFrame=!1,this.maxScreenSize=0,this._updateShadowBias()}destroy(){this._destroyShadowMap(),this.releaseRenderData(),this._renderData=null}releaseRenderData(){if(this._renderData){for(let e=0;e<this._renderData.length;e++)this._renderData[e].destroy();this._renderData.length=0}}addLayer(e){this.layers.add(e)}removeLayer(e){this.layers.delete(e)}set shadowBias(e){this._shadowBias!==e&&(this._shadowBias=e,this._updateShadowBias())}get shadowBias(){return this._shadowBias}set numCascades(e){(!this.cascades||this.numCascades!==e)&&(this.cascades=xF[e-1],this._shadowMatrixPalette=new Float32Array(4*16),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}get numCascades(){return this.cascades.length}set shadowMap(e){this._shadowMap!==e&&(this._destroyShadowMap(),this._shadowMap=e)}get shadowMap(){return this._shadowMap}set mask(e){this._mask!==e&&(this._mask=e,this.updateKey())}get mask(){return this._mask}get numShadowFaces(){const e=this._type;return e===fe?this.numCascades:e===Oe?6:1}set type(e){if(this._type===e)return;this._type=e,this._destroyShadowMap(),this._updateShadowBias(),this.updateKey();const t=this._shadowType;this._shadowType=null,this.shadowUpdateOverrides=null,this.shadowType=t}get type(){return this._type}set shape(e){if(this._shape===e)return;this._shape=e,this._destroyShadowMap(),this.updateKey();const t=this._shadowType;this._shadowType=null,this.shadowType=t}get shape(){return this._shape}set usePhysicalUnits(e){this._usePhysicalUnits!==e&&(this._usePhysicalUnits=e,this._updateFinalColor())}get usePhysicalUnits(){return this._usePhysicalUnits}set shadowType(e){if(this._shadowType===e)return;const t=this.device;this._type===Oe&&e!==xt&&e!==ss&&(e=xt);const s=t.supportsDepthShadow;e===wi&&!s&&(e=xt),e===si&&(!t.textureFloatRenderable||!t.textureFloatFilterable)&&(e=Si),e===Si&&!t.textureHalfFloatRenderable&&(e=ei),this._isVsm=e>=ei&&e<=si,this._isPcf=e===Wi||e===xt||e===wi,this._shadowType=e,this._destroyShadowMap(),this.updateKey()}get shadowType(){return this._shadowType}set enabled(e){this._enabled!==e&&(this._enabled=e,this.layersDirty())}get enabled(){return this._enabled}set castShadows(e){this._castShadows!==e&&(this._castShadows=e,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}get castShadows(){return this._castShadows&&this._mask!==$i&&this._mask!==0}set shadowResolution(e){this._shadowResolution!==e&&(this._type===Oe?e=Math.min(e,this.device.maxCubeMapSize):e=Math.min(e,this.device.maxTextureSize),this._shadowResolution=e,this._destroyShadowMap())}get shadowResolution(){return this._shadowResolution}set vsmBlurSize(e){this._vsmBlurSize!==e&&(e%2===0&&e++,this._vsmBlurSize=e)}get vsmBlurSize(){return this._vsmBlurSize}set normalOffsetBias(e){this._normalOffsetBias!==e&&((!this._normalOffsetBias&&e||this._normalOffsetBias&&!e)&&this.updateKey(),this._normalOffsetBias=e)}get normalOffsetBias(){return this._normalOffsetBias}set falloffMode(e){this._falloffMode!==e&&(this._falloffMode=e,this.updateKey())}get falloffMode(){return this._falloffMode}set innerConeAngle(e){this._innerConeAngle!==e&&(this._innerConeAngle=e,this._innerConeAngleCos=Math.cos(e*Math.PI/180),this._usePhysicalUnits&&this._updateFinalColor())}get innerConeAngle(){return this._innerConeAngle}set outerConeAngle(e){this._outerConeAngle!==e&&(this._outerConeAngle=e,this._updateOuterAngle(e),this._usePhysicalUnits&&this._updateFinalColor())}get outerConeAngle(){return this._outerConeAngle}set penumbraSize(e){this._penumbraSize=e}get penumbraSize(){return this._penumbraSize}_updateOuterAngle(e){const t=e*Math.PI/180;this._outerConeAngleCos=Math.cos(t),this._outerConeAngleSin=Math.sin(t)}set intensity(e){this._intensity!==e&&(this._intensity=e,this._updateFinalColor())}get intensity(){return this._intensity}set affectSpecularity(e){this._type===fe&&(this._affectSpecularity=e,this.updateKey())}get affectSpecularity(){return this._affectSpecularity}set luminance(e){this._luminance!==e&&(this._luminance=e,this._updateFinalColor())}get luminance(){return this._luminance}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new q),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new P(0,0,1,1)),this._atlasViewport}set cookie(e){this._cookie!==e&&(this._cookie=e,this.updateKey())}get cookie(){return this._cookie}set cookieFalloff(e){this._cookieFalloff!==e&&(this._cookieFalloff=e,this.updateKey())}get cookieFalloff(){return this._cookieFalloff}set cookieChannel(e){if(this._cookieChannel!==e){if(e.length<3){const t=e.charAt(e.length-1),s=3-e.length;for(let i=0;i<s;i++)e+=t}this._cookieChannel=e,this.updateKey()}}get cookieChannel(){return this._cookieChannel}set cookieTransform(e){this._cookieTransform!==e&&(this._cookieTransform=e,this._cookieTransformSet=!!e,e&&!this._cookieOffset&&(this.cookieOffset=new M,this._cookieOffsetSet=!1),this.updateKey())}get cookieTransform(){return this._cookieTransform}set cookieOffset(e){if(this._cookieOffset===e)return;!!(this._cookieTransformSet||e)&&!e&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=e,this._cookieOffsetSet=!!e,e&&!this._cookieTransform&&(this.cookieTransform=new P(1,1,0,0),this._cookieTransformSet=!1),this.updateKey()}get cookieOffset(){return this._cookieOffset}beginFrame(){this.visibleThisFrame=this._type===fe&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=!1,this.atlasSlotUpdated=!1}_destroyShadowMap(){if(this.releaseRenderData(),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),this.shadowUpdateMode===Ci&&(this.shadowUpdateMode=Ka),this.shadowUpdateOverrides)for(let e=0;e<this.shadowUpdateOverrides.length;e++)this.shadowUpdateOverrides[e]===Ci&&(this.shadowUpdateOverrides[e]=Ka)}getRenderData(e,t){for(let i=0;i<this._renderData.length;i++){const n=this._renderData[i];if(n.camera===e&&n.face===t)return n}const s=new bF(this.device,e,t,this);return this._renderData.push(s),s}clone(){const e=new kc(this.device,this.clusteredLighting);return e.type=this._type,e.setColor(this._color),e.intensity=this._intensity,e.affectSpecularity=this._affectSpecularity,e.luminance=this._luminance,e.castShadows=this.castShadows,e._enabled=this._enabled,e.attenuationStart=this.attenuationStart,e.attenuationEnd=this.attenuationEnd,e.falloffMode=this._falloffMode,e.shadowType=this._shadowType,e.vsmBlurSize=this._vsmBlurSize,e.vsmBlurMode=this.vsmBlurMode,e.vsmBias=this.vsmBias,e.penumbraSize=this.penumbraSize,e.shadowUpdateMode=this.shadowUpdateMode,e.mask=this.mask,this.shadowUpdateOverrides&&(e.shadowUpdateOverrides=this.shadowUpdateOverrides.slice()),e.innerConeAngle=this._innerConeAngle,e.outerConeAngle=this._outerConeAngle,e.numCascades=this.numCascades,e.cascadeDistribution=this.cascadeDistribution,e.shape=this._shape,e.shadowDepthState.copy(this.shadowDepthState),e.shadowBias=this.shadowBias,e.normalOffsetBias=this._normalOffsetBias,e.shadowResolution=this._shadowResolution,e.shadowDistance=this.shadowDistance,e.shadowIntensity=this.shadowIntensity,e}static getLightUnitConversion(e,t=Math.PI/4,s=0){switch(e){case Ge:{const i=Math.cos(t),n=Math.cos(s);return 2*Math.PI*(1-n+(n-i)/2)}case Oe:return 4*Math.PI;case fe:return 1}}_getUniformBiasValues(e){const t=e.shadowCamera._farClip;switch(this._type){case Oe:fi.bias=this.shadowBias,fi.normalBias=this._normalOffsetBias;break;case Ge:this._isVsm?fi.bias=-1e-5*20:(fi.bias=this.shadowBias*20,this.device.isWebGL1&&this.device.extStandardDerivatives&&(fi.bias*=-100)),fi.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case fe:this._isVsm?fi.bias=-1e-5*20:(fi.bias=this.shadowBias/t*100,this.device.isWebGL1&&this.device.extStandardDerivatives&&(fi.bias*=-100)),fi.normalBias=this._isVsm?this.vsmBias/(t/7):this._normalOffsetBias;break}return fi}getColor(){return this._color}getBoundingSphere(e){if(this._type===Ge){const t=this.attenuationEnd,s=this._outerConeAngle,i=this._outerConeAngleCos,n=this._node;iu.copy(n.up),s>45?(e.radius=t*this._outerConeAngleSin,iu.mulScalar(-t*i)):(e.radius=t/(2*i),iu.mulScalar(-e.radius)),e.center.add2(n.getPosition(),iu)}else this._type===Oe&&(e.center=this._node.getPosition(),e.radius=this.attenuationEnd)}getBoundingBox(e){if(this._type===Ge){const t=this.attenuationEnd,s=this._outerConeAngle,i=this._node,n=Math.abs(Math.sin(s*H.DEG_TO_RAD)*t);e.center.set(0,-t*.5,0),e.halfExtents.set(n,t*.5,n),e.setFromTransformedAabb(e,i.getWorldTransform(),!0)}else this._type===Oe&&(e.center.copy(this._node.getPosition()),e.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))}_updateShadowBias(){const e=this.device;if(e.isWebGL2||e.isWebGPU)if(this._type===Oe&&!this.clusteredLighting)this.shadowDepthState.depthBias=0,this.shadowDepthState.depthBiasSlope=0;else{const t=this.shadowBias*-1e3;this.shadowDepthState.depthBias=t,this.shadowDepthState.depthBiasSlope=t}}_updateFinalColor(){const e=this._color,t=e.r,s=e.g,i=e.b;let n=this._intensity;this._usePhysicalUnits&&(n=this._luminance/kc.getLightUnitConversion(this._type,this._outerConeAngle*H.DEG_TO_RAD,this._innerConeAngle*H.DEG_TO_RAD));const a=this._finalColor,o=this._linearFinalColor;a[0]=t*n,a[1]=s*n,a[2]=i*n,n>=1?(o[0]=Math.pow(t,2.2)*n,o[1]=Math.pow(s,2.2)*n,o[2]=Math.pow(i,2.2)*n):(o[0]=Math.pow(a[0],2.2),o[1]=Math.pow(a[1],2.2),o[2]=Math.pow(a[2],2.2))}setColor(){arguments.length===1?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):arguments.length===3&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateFinalColor()}layersDirty(){this.layers.forEach(e=>{e.markLightsDirty()})}updateKey(){let e=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(this._normalOffsetBias!==0?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|Km[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|this.numCascades-1<<8|(this.affectSpecularity?1:0)<<7|this.mask<<6;this._cookieChannel.length===3&&(e|=Km[this._cookieChannel.charAt(1)]<<16,e|=Km[this._cookieChannel.charAt(2)]<<14),e!==this.key&&this.layersDirty(),this.key=e}}class Jb{constructor(e,t,s){this._areaLightsEnabled=!1,this._cells=new y(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=!0,this._shadowType=xt,this._shadowAtlasResolution=2048,this._cookiesEnabled=!1,this._cookieAtlasResolution=2048,this.debugLayer=void 0,this.atlasSplit=null,this._supportsAreaLights=e,this._maxTextureSize=t,this._dirtyLightsFnc=s}applySettings(e){var t,s,i,n,a,o,l;this.shadowsEnabled=(t=e.lightingShadowsEnabled)!=null?t:this.shadowsEnabled,this.cookiesEnabled=(s=e.lightingCookiesEnabled)!=null?s:this.cookiesEnabled,this.areaLightsEnabled=(i=e.lightingAreaLightsEnabled)!=null?i:this.areaLightsEnabled,this.shadowAtlasResolution=(n=e.lightingShadowAtlasResolution)!=null?n:this.shadowAtlasResolution,this.cookieAtlasResolution=(a=e.lightingCookieAtlasResolution)!=null?a:this.cookieAtlasResolution,this.maxLightsPerCell=(o=e.lightingMaxLightsPerCell)!=null?o:this.maxLightsPerCell,this.shadowType=(l=e.lightingShadowType)!=null?l:this.shadowType,e.lightingCells&&(this.cell=new y(e.lightingCells))}set cells(e){this._cells.copy(e)}get cells(){return this._cells}set maxLightsPerCell(e){this._maxLightsPerCell=H.clamp(e,1,255)}get maxLightsPerCell(){return this._maxLightsPerCell}set cookieAtlasResolution(e){this._cookieAtlasResolution=H.clamp(e,32,this._maxTextureSize)}get cookieAtlasResolution(){return this._cookieAtlasResolution}set shadowAtlasResolution(e){this._shadowAtlasResolution=H.clamp(e,32,this._maxTextureSize)}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowType(e){this._shadowType!==e&&(this._shadowType=e,this._dirtyLightsFnc())}get shadowType(){return this._shadowType}set cookiesEnabled(e){this._cookiesEnabled!==e&&(this._cookiesEnabled=e,this._dirtyLightsFnc())}get cookiesEnabled(){return this._cookiesEnabled}set areaLightsEnabled(e){this._supportsAreaLights&&this._areaLightsEnabled!==e&&(this._areaLightsEnabled=e,this._dirtyLightsFnc())}get areaLightsEnabled(){return this._areaLightsEnabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this._dirtyLightsFnc())}get shadowsEnabled(){return this._shadowsEnabled}}const TF=`
	attribute vec2 vertex_position;
	varying vec2 uv0;
	void main(void) {
		gl_Position = vec4(vertex_position, 0.5, 1.0);
		uv0 = vertex_position.xy * 0.5 + 0.5;
	}
	`,EF=new Xe(!0,ci,$t,$t);class Ja{constructor(e){this.morph=e,e.incRefCount(),this.device=e.device,this._weights=[],this._weightMap=new Map;for(let t=0;t<e._targets.length;t++){const s=e._targets[t];s.name&&this._weightMap.set(s.name,t),this.setWeight(t,s.defaultWeight)}if(this._activeTargets=[],e.useTextureMorph){this.shaderCache={},this.maxSubmitCount=this.device.maxTextures,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);const t=(s,i)=>(this[i]=e._createTexture(s,e._renderTextureFormat),new Ct({colorBuffer:this[i],depth:!1}));e.morphPositions&&(this.rtPositions=t("MorphRTPos","texturePositions")),e.morphNormals&&(this.rtNormals=t("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([e.morphTextureWidth,e.morphTextureHeight,1/e.morphTextureWidth,1/e.morphTextureHeight]);for(let s=0;s<this.maxSubmitCount;s++)this["morphBlendTex"+s]=this.device.scope.resolve("morphBlendTex"+s);this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.zeroTextures=!1}else this.maxSubmitCount=8,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount),this._shaderMorphWeightsA=new Float32Array(this._shaderMorphWeights.buffer,0,4),this._shaderMorphWeightsB=new Float32Array(this._shaderMorphWeights.buffer,4*4,4),this._activeVertexBuffers=new Array(this.maxSubmitCount)}destroy(){this.shader=null;const e=this.morph;e&&(this.morph=null,e.decRefCount(),e.refCount<1&&e.destroy()),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}clone(){return new Ja(this.morph)}_getWeightIndex(e){return typeof e=="string"?this._weightMap.get(e):e}getWeight(e){const t=this._getWeightIndex(e);return this._weights[t]}setWeight(e,t){const s=this._getWeightIndex(e);this._weights[s]=t,this._dirty=!0}_getFragmentShader(e){let t="";e>0&&(t+=`varying vec2 uv0;
uniform highp float morphFactor[`+e+`];
`);for(let s=0;s<e;s++)t+="uniform highp sampler2D morphBlendTex"+s+`;
`;t+=`void main (void) {
    highp vec4 color = vec4(0, 0, 0, 1);
`;for(let s=0;s<e;s++)t+="    color.xyz += morphFactor["+s+"] * texture2D(morphBlendTex"+s+`, uv0).xyz;
`;return t+=`    gl_FragColor = color;
}
`,t}_getShader(e){let t=this.shaderCache[e];if(!t){const s=this._getFragmentShader(e);t=ks(this.device,TF,s,"textureMorph"+e),this.shaderCache[e]=t}return t}_updateTextureRenderTarget(e,t){const s=this.device,i=(l,c)=>{this.morphFactor.setValue(this._shaderMorphWeights),s.setBlendState(c?EF:Xe.NOBLEND);const d=this._getShader(l);Ya(s,e,d)};let n=0,a=!1;const o=this._activeTargets.length;for(let l=0;l<o;l++){const c=this._activeTargets[l],d=c.target[t];d&&(this["morphBlendTex"+n].setValue(d),this._shaderMorphWeights[n]=c.weight,n++,n>=this.maxSubmitCount&&(i(n,a),n=0,a=!0))}(n>0||o===0&&!this.zeroTextures)&&i(n,a)}_updateTextureMorph(){this.device,(this._activeTargets.length>0||!this.zeroTextures)&&(this.rtPositions&&this._updateTextureRenderTarget(this.rtPositions,"texturePositions"),this.rtNormals&&this._updateTextureRenderTarget(this.rtNormals,"textureNormals"),this.zeroTextures=this._activeTargets.length===0)}_updateVertexMorph(){const e=this.maxSubmitCount;for(let i=0;i<e;i++)this._shaderMorphWeights[i]=0,this._activeVertexBuffers[i]=null;let t=0,s=this.morph.morphPositions?4:0;for(let i=0;i<this._activeTargets.length;i++){const n=this._activeTargets[i].target;n._vertexBufferPositions&&(this._activeVertexBuffers[t]=n._vertexBufferPositions,this._shaderMorphWeights[t]=this._activeTargets[i].weight,t++),n._vertexBufferNormals&&(this._activeVertexBuffers[s]=n._vertexBufferNormals,this._shaderMorphWeights[s]=this._activeTargets[i].weight,s++)}}update(){this._dirty=!1;const e=this.morph._targets;let t=0;const s=1e-5;for(let n=0;n<e.length;n++){const a=Math.abs(this.getWeight(n));if(a>s){this._activeTargets.length<=t&&(this._activeTargets[t]={});const o=this._activeTargets[t++];o.absWeight=a,o.weight=this.getWeight(n),o.target=e[n]}}this._activeTargets.length=t;const i=this.morph.maxActiveTargets;this._activeTargets.length>i&&(this._activeTargets.sort(function(n,a){return n.absWeight<a.absWeight?1:a.absWeight<n.absWeight?-1:0}),this._activeTargets.length=i),this.morph.useTextureMorph?this._updateTextureMorph():this._updateVertexMorph()}}class $n{constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}getGraph(){return this.graph}setGraph(e){this.graph=e}getCameras(){return this.cameras}setCameras(e){this.cameras=e}getLights(){return this.lights}setLights(e){this.lights=e}getMaterials(){const e=[];for(let t=0;t<this.meshInstances.length;t++){const s=this.meshInstances[t];e.indexOf(s.material)===-1&&e.push(s.material)}return e}clone(){const e=[],t=[],i=function c(d){const h=d.clone();e.push(d),t.push(h);for(let u=0;u<d._children.length;u++)h.addChild(c(d._children[u]));return h}(this.graph),n=[],a=[],o=[];for(let c=0;c<this.skinInstances.length;c++){const d=this.skinInstances[c].skin,h=new Td(d),u=[];for(let f=0;f<d.boneNames.length;f++){const p=d.boneNames[f],_=i.findByName(p);u.push(_)}h.bones=u,a.push(h)}for(let c=0;c<this.morphInstances.length;c++){const d=this.morphInstances[c].morph,h=new Ja(d);o.push(h)}for(let c=0;c<this.meshInstances.length;c++){const d=this.meshInstances[c],h=e.indexOf(d.node),u=new Fe(d.mesh,d.material,t[h]);if(d.skinInstance){const f=this.skinInstances.indexOf(d.skinInstance);u.skinInstance=a[f]}if(d.morphInstance){const f=this.morphInstances.indexOf(d.morphInstance);u.morphInstance=o[f]}n.push(u)}const l=new $n;return l.graph=i,l.meshInstances=n,l.skinInstances=a,l.morphInstances=o,l.getGraph().syncHierarchy(),l}destroy(){const e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].destroy();this.meshInstances.length=0}generateWireframe(){Fe._prepareRenderStyleForArray(this.meshInstances,ua)}}class s0 extends Ky{constructor(e,t,{preferHighPrecision:s=!1}={}){super(),this._aabb=void 0,this.preferHighPrecision=void 0,this.device=t,this.preferHighPrecision=s,this._targets=e.slice();const i=this.device;if(i.supportsMorphTargetTexturesCore){const n=i.extTextureHalfFloat&&i.textureHalfFloatRenderable?yt:void 0,a=i.extTextureFloat&&i.textureFloatRenderable?rt:void 0;this._renderTextureFormat=this.preferHighPrecision?a??n:n??a;const o=i.extTextureHalfFloat&&i.textureHalfFloatUpdatable?yt:void 0,l=i.extTextureFloat?Yl:void 0;this._textureFormat=this.preferHighPrecision?l??o:o??l,this._renderTextureFormat!==void 0&&this._textureFormat!==void 0&&(this._useTextureMorph=!0)}this._init(),this._updateMorphFlags()}get aabb(){if(!this._aabb){const e=new y,t=new y;for(let s=0;s<this._targets.length;s++){const i=this._targets[s].aabb;e.min(i.getMin()),t.max(i.getMax())}this._aabb=new Re,this._aabb.setMinMax(e,t)}return this._aabb}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}get maxActiveTargets(){return this._useTextureMorph?this._targets.length:this._morphPositions&&this._morphNormals?4:8}get useTextureMorph(){return this._useTextureMorph}_init(){if(this._useTextureMorph&&(this._useTextureMorph=this._initTextureBased()),!this._useTextureMorph)for(let e=0;e<this._targets.length;e++)this._targets[e]._initVertexBuffers(this.device);for(let e=0;e<this._targets.length;e++)this._targets[e]._postInit()}_findSparseSet(e,t,s,i){let n=1;const a=e[0].length;for(let o=0;o<a;o+=3){let l=!1;for(let c=0;c<e.length;c++){const d=e[c];if(d[o]!==0||d[o+1]!==0||d[o+2]!==0){l=!0;break}}l?(t.push(n+i),s.push(o/3),n++):t.push(0+i)}return n}_initTextureBased(){const e=this.device.isWebGPU,t=e?0:.2,s=[],i=[];for(let m=0;m<this._targets.length;m++){const g=this._targets[m];g.options.deltaPositions&&(s.push(g.options.deltaPositions),i.push({target:g,name:"texturePositions"})),g.options.deltaNormals&&(s.push(g.options.deltaNormals),i.push({target:g,name:"textureNormals"}))}const n=[],a=[],o=this._findSparseSet(s,n,a,t),l=Math.min(this.device.maxTextureSize,4096);let c=Math.ceil(Math.sqrt(o));c=Math.min(c,l);const d=Math.ceil(o/c);if(d>l)return!1;this.morphTextureWidth=c,this.morphTextureHeight=d;let h=!1,u=3;const f=Ke.float2Half;this._textureFormat===yt&&(h=!0,u=4);const p=[];for(let m=0;m<s.length;m++)p.push(this._createTexture("MorphTarget",this._textureFormat));for(let m=0;m<s.length;m++){const g=s[m],v=p[m],x=v.lock();if(h)for(let w=0;w<a.length;w++){const T=a[w]*3,b=w*u+u;x[b]=f(g[T]),x[b+1]=f(g[T+1]),x[b+2]=f(g[T+2])}else for(let w=0;w<a.length;w++){const T=a[w]*3,b=w*u+u;x[b]=g[T],x[b+1]=g[T+1],x[b+2]=g[T+2]}v.unlock(),i[m].target._setTexture(i[m].name,v)}const _=[{semantic:Ea,components:1,type:e?Ql:Me}];return this.vertexBufferIds=new Mi(this.device,new os(this.device,_,n.length),n.length,as,e?new Uint32Array(n):new Float32Array(n)),!0}destroy(){var e;(e=this.vertexBufferIds)==null||e.destroy(),this.vertexBufferIds=null;for(let t=0;t<this._targets.length;t++)this._targets[t].destroy();this._targets.length=0}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=!1,this._morphNormals=!1;for(let e=0;e<this._targets.length;e++){const t=this._targets[e];t.morphPositions&&(this._morphPositions=!0),t.morphNormals&&(this._morphNormals=!0)}}_createTexture(e,t){return new _e(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:t,cubemap:!1,mipmaps:!1,minFilter:Ee,magFilter:Ee,addressU:ae,addressV:ae,name:e})}}class Qp{constructor(e){this.used=!1,arguments.length===2&&(e=arguments[1]),this.options=e,this._name=e.name,this._defaultWeight=e.defaultWeight||0,this._aabb=e.aabb,this.deltaPositions=e.deltaPositions}destroy(){var e,t,s,i;(e=this._vertexBufferPositions)==null||e.destroy(),this._vertexBufferPositions=null,(t=this._vertexBufferNormals)==null||t.destroy(),this._vertexBufferNormals=null,(s=this.texturePositions)==null||s.destroy(),this.texturePositions=null,(i=this.textureNormals)==null||i.destroy(),this.textureNormals=null}get name(){return this._name}get defaultWeight(){return this._defaultWeight}get aabb(){return this._aabb||(this._aabb=new Re,this.deltaPositions&&this._aabb.compute(this.deltaPositions)),this._aabb}get morphPositions(){return!!this._vertexBufferPositions||!!this.texturePositions}get morphNormals(){return!!this._vertexBufferNormals||!!this.textureNormals}clone(){return new Qp(this.options)}_postInit(){this.options.preserveData||(this.options=null),this.used=!0}_initVertexBuffers(e){const t=this.options;this._vertexBufferPositions=this._createVertexBuffer(e,t.deltaPositions,t.deltaPositionsType),this._vertexBufferNormals=this._createVertexBuffer(e,t.deltaNormals,t.deltaNormalsType),this._vertexBufferPositions&&(this.deltaPositions=this._vertexBufferPositions.lock())}_createVertexBuffer(e,t,s=Me){if(t){const i=[{semantic:sf,components:3,type:s}];return new Mi(e,new os(e,i),t.length/3,as,t)}return null}_setTexture(e,t){this[e]=t}}class CF extends Be{generateKey(e){let t="particle";for(const s in e)e.hasOwnProperty(s)&&(t+=e[s]);return t}_animTex(e){let t="";return t+=e.animTexLoop?W.particleAnimFrameLoopVS:W.particleAnimFrameClampVS,t+=W.particleAnimTexVS,t}createShaderDefinition(e,t){const s=`#define PARTICLE_${t.useCpu?"CPU":"GPU"}
`;let i=`#define PARTICLE
`+s,n=`#define VERTEXSHADER
`+s;t.mesh&&(n+=`#define USE_MESH
`),t.localSpace&&(n+=`#define LOCAL_SPACE
`),t.screenSpace&&(n+=`#define SCREEN_SPACE
`),t.animTex&&(n+=`
uniform vec2 animTexTilesParams;
`),t.animTex&&(n+=`
uniform vec4 animTexParams;
`),t.animTex&&(n+=`
uniform vec2 animTexIndexParams;
`),t.normal===2&&(n+=`
varying mat3 ParticleMat;
`),t.normal===1&&(n+=`
varying vec3 Normal;
`),t.soft&&(n+=`
varying float vDepth;
`);const a=t.customFace?W.particle_customFaceVS:W.particle_billboardVS;return t.useCpu?(t.soft>0&&(n+=W.screenDepthPS),n+=W.particle_cpuVS,t.localSpace&&(n+=W.particle_localShiftVS),t.animTex&&(n+=this._animTex(t)),t.alignToMotion&&(n+=W.particle_pointAlongVS),n+=t.mesh?W.particle_meshVS:a,t.normal===1&&(n+=W.particle_normalVS),t.normal===2&&(n+=W.particle_TBNVS),t.stretch>0&&(n+=W.particle_stretchVS),n+=W.particle_cpu_endVS,t.soft>0&&(n+=W.particle_softVS)):(n+=W.particle_initVS,n+=t.pack8?W.particleInputRgba8PS:W.particleInputFloatPS,t.soft>0&&(n+=W.screenDepthPS),n+=W.particleVS,t.localSpace&&(n+=W.particle_localShiftVS),t.animTex&&(n+=this._animTex(t)),t.wrap&&(n+=W.particle_wrapVS),t.alignToMotion&&(n+=W.particle_pointAlongVS),n+=t.mesh?W.particle_meshVS:a,t.normal===1&&(n+=W.particle_normalVS),t.normal===2&&(n+=W.particle_TBNVS),t.stretch>0&&(n+=W.particle_stretchVS),n+=W.particle_endVS,t.soft>0&&(n+=W.particle_softVS)),n+=`}
`,t.normal>0&&(t.normal===1?i+=`
varying vec3 Normal;
`:t.normal===2&&(i+=`
varying mat3 ParticleMat;
`),i+=`
uniform vec3 lightCube[6];
`),t.soft&&(i+=`
varying float vDepth;
`),t.normal===0&&t.fog==="none"&&(t.srgb=!1),i+=W.decodePS,i+=Be.gammaCode(t.gamma),i+=Be.tonemapCode(t.toneMap),t.fog==="linear"?i+=W.fogLinearPS:t.fog==="exp"?i+=W.fogExpPS:t.fog==="exp2"?i+=W.fogExp2PS:i+=W.fogNonePS,t.normal===2&&(i+=`
uniform sampler2D normalMap;
`),t.soft>0&&(i+=W.screenDepthPS),i+=W.particlePS,t.soft>0&&(i+=W.particle_softPS),t.normal===1&&(i+=`
vec3 normal = Normal;
`),t.normal===2&&(i+=W.particle_normalMapPS),t.normal>0&&(i+=t.halflambert?W.particle_halflambertPS:W.particle_lambertPS),t.normal>0&&(i+=W.particle_lightingPS),t.blend===Bt?i+=W.particle_blendNormalPS:t.blend===ky?i+=W.particle_blendAddPS:t.blend===By&&(i+=W.particle_blendMultiplyPS),i+=W.particle_endPS,Mt.createDefinition(e,{name:"ParticleShader",vertexCode:n,fragmentCode:i})}}const AF=new CF;let pn,bS=1;const le=4,Ym=new q,Zm=new q,Di=new y,Je=new y,pi=new y,Co=new y,bs=new y,ut=new y,Ao=new y,Po=new y,xh=new y,TS=new y,qt=new y,nu=new y,Jr=new y;function Qo(r){return r-Math.floor(r)}function PF(r){return Math.max(Math.min(r,1),0)}function Jm(r,e){return r-e*Math.floor(r/e)}function MF(r){let e=Qo(r),t=Qo(255*r),s=Qo(65025*r),i=Qo(160581375*r);return e-=t/255,t-=s/255,s-=i/255,i-=i/255,[e,t,s,i]}function ru(r){let e=Qo(r),t=Qo(255*r);return e-=t/255,t-=t/255,[e,t]}class IF{constructor(e){this._emitter=e}calcSpawnPosition(e,t,s,i,n){const a=this._emitter,o=Math.random(),l=Math.random(),c=Math.random(),d=Math.random();if(a.useCpu&&(e[n*le+0+a.numParticlesPot*2*le]=o,e[n*le+1+a.numParticlesPot*2*le]=l,e[n*le+2+a.numParticlesPot*2*le]=c),Je.x=o-.5,Je.y=l-.5,Je.z=c-.5,a.emitterShape===zi){const f=Math.max(Math.abs(Je.x),Math.max(Math.abs(Je.y),Math.abs(Je.z))),p=f+(.5-f)*s[0],_=f+(.5-f)*s[1],m=f+(.5-f)*s[2];Je.x=p*(f===Math.abs(Je.x)?Math.sign(Je.x):2*Je.x),Je.y=_*(f===Math.abs(Je.y)?Math.sign(Je.y):2*Je.y),Je.z=m*(f===Math.abs(Je.z)?Math.sign(Je.z):2*Je.z),a.localSpace?Di.copy(t.transformPoint(Je)):Di.copy(i).add(t.transformPoint(Je))}else{Je.normalize();const f=a.emitterRadius===0?0:a.emitterRadiusInner/a.emitterRadius,p=d*(1-f)+f;a.localSpace?Di.copy(Je.mulScalar(p*a.emitterRadius)):Di.copy(i).add(Je.mulScalar(p*a.emitterRadius))}let u=-H.lerp(a.rate,a.rate2,o)*n;if(a.pack8){const f=(Di.x-a.worldBounds.center.x)/a.worldBoundsSize.x+.5,p=(Di.y-a.worldBounds.center.y)/a.worldBoundsSize.y+.5,_=(Di.z-a.worldBounds.center.z)/a.worldBoundsSize.z+.5;let m=H.lerp(a.startAngle*H.DEG_TO_RAD,a.startAngle2*H.DEG_TO_RAD,o);m=m%(Math.PI*2)/(Math.PI*2);const g=ru(f);e[n*le]=g[0],e[n*le+1]=g[1];const v=ru(p);e[n*le+2]=v[0],e[n*le+3]=v[1];const x=ru(_);e[n*le+0+a.numParticlesPot*le]=x[0],e[n*le+1+a.numParticlesPot*le]=x[1];const S=ru(m);e[n*le+2+a.numParticlesPot*le]=S[0],e[n*le+3+a.numParticlesPot*le]=S[1];const w=1;e[n*le+3+a.numParticlesPot*le*2]=w;const T=Math.max(a.lifetime,(a.numParticles-1)*Math.max(a.rate,a.rate2)),b=a.lifetime+1;u=(u+T)/(T+b);const C=MF(u);e[n*le+0+a.numParticlesPot*le*3]=C[0],e[n*le+1+a.numParticlesPot*le*3]=C[1],e[n*le+2+a.numParticlesPot*le*3]=C[2],e[n*le+3+a.numParticlesPot*le*3]=C[3]}else e[n*le]=Di.x,e[n*le+1]=Di.y,e[n*le+2]=Di.z,e[n*le+3]=H.lerp(a.startAngle*H.DEG_TO_RAD,a.startAngle2*H.DEG_TO_RAD,o),e[n*le+3+a.numParticlesPot*le]=u}update(e,t,s,i,n,a,o,l){let c,d,h;const u=this._emitter;if(u.meshInstance.node){const E=u.meshInstance.node.worldTransform;for(let R=0;R<12;R++)Ym.data[R]=E.data[R];Zm.copy(Ym),Zm.invert(),pn=u.meshInstance.node.localScale,bS=Math.max(Math.max(pn.x,pn.y),pn.z)}a=u.meshInstance.node===null||u.localSpace?y.ZERO:u.meshInstance.node.getPosition();const f=u.camera?u.camera._node.getPosition():y.ZERO,p=u.useMesh?17:15;let _,m,g,v,x,S,w,T,b;const C=u.precision-1;for(let E=0;E<u.numParticles;E++){const R=Math.floor(u.vbCPU[E*u.numParticleVerts*(u.useMesh?6:4)+3]),B=s[R*le+0+u.numParticlesPot*2*le];pi.x=B,pi.y=s[R*le+1+u.numParticlesPot*2*le],pi.z=s[R*le+2+u.numParticlesPot*2*le];const L=u.rate+(u.rate2-u.rate)*B,V=u.lifetime;let I=s[R*le+3+u.numParticlesPot*le]+o;const F=PF(I/V);let D=0,A=0;const N=0;(I-o<=0||I>=V)&&this.calcSpawnPosition(s,i,n,a,R);let G=I>0&&I<V;G&&(h=F*C,_=Math.floor(h),m=Math.ceil(h),h%=1,c=u.qRotSpeed[_],d=u.qRotSpeed[m],g=c+(d-c)*h,c=u.qRotSpeed2[_],d=u.qRotSpeed2[m],v=c+(d-c)*h,c=u.qScale[_],d=u.qScale[m],D=c+(d-c)*h,c=u.qScale2[_],d=u.qScale2[m],x=c+(d-c)*h,c=u.qAlpha[_],d=u.qAlpha[m],S=c+(d-c)*h,c=u.qAlpha2[_],d=u.qAlpha2[m],w=c+(d-c)*h,c=u.qRadialSpeed[_],d=u.qRadialSpeed[m],T=c+(d-c)*h,c=u.qRadialSpeed2[_],d=u.qRadialSpeed2[m],b=c+(d-c)*h,T+=(b-T)*(B*100%1),Co.x=s[R*le],Co.y=s[R*le+1],Co.z=s[R*le+2],u.localSpace?xh.copy(Co):xh.copy(Co).sub(a),xh.normalize().mulScalar(T),_*=3,m*=3,c=u.qLocalVelocity[_],d=u.qLocalVelocity[m],ut.x=c+(d-c)*h,c=u.qLocalVelocity[_+1],d=u.qLocalVelocity[m+1],ut.y=c+(d-c)*h,c=u.qLocalVelocity[_+2],d=u.qLocalVelocity[m+2],ut.z=c+(d-c)*h,c=u.qLocalVelocity2[_],d=u.qLocalVelocity2[m],Po.x=c+(d-c)*h,c=u.qLocalVelocity2[_+1],d=u.qLocalVelocity2[m+1],Po.y=c+(d-c)*h,c=u.qLocalVelocity2[_+2],d=u.qLocalVelocity2[m+2],Po.z=c+(d-c)*h,c=u.qVelocity[_],d=u.qVelocity[m],bs.x=c+(d-c)*h,c=u.qVelocity[_+1],d=u.qVelocity[m+1],bs.y=c+(d-c)*h,c=u.qVelocity[_+2],d=u.qVelocity[m+2],bs.z=c+(d-c)*h,c=u.qVelocity2[_],d=u.qVelocity2[m],Ao.x=c+(d-c)*h,c=u.qVelocity2[_+1],d=u.qVelocity2[m+1],Ao.y=c+(d-c)*h,c=u.qVelocity2[_+2],d=u.qVelocity2[m+2],Ao.z=c+(d-c)*h,ut.x+=(Po.x-ut.x)*pi.x,ut.y+=(Po.y-ut.y)*pi.y,ut.z+=(Po.z-ut.z)*pi.z,u.initialVelocity>0&&(u.emitterShape===Lb?(Je.copy(pi).mulScalar(2).sub(y.ONE).normalize(),ut.add(Je.mulScalar(u.initialVelocity))):ut.add(y.FORWARD.mulScalar(u.initialVelocity))),bs.x+=(Ao.x-bs.x)*pi.x,bs.y+=(Ao.y-bs.y)*pi.y,bs.z+=(Ao.z-bs.z)*pi.z,g+=(v-g)*pi.y,D=(D+(x-D)*(B*1e4%1))*bS,A=(w-S)*(B*1e3%1),u.meshInstance.node&&(u.localSpace?(ut.x/=pn.x,ut.y/=pn.y,ut.z/=pn.z):Ym.transformPoint(ut,ut)),u.localSpace?(Zm.transformPoint(bs,bs),ut.add(bs).add(xh)):(ut.add(bs.mul(pn)),ut.add(xh.mul(pn))),nu.copy(ut),TS.copy(Co).add(ut.mulScalar(o)),qt.copy(TS),s[R*le]=qt.x,s[R*le+1]=qt.y,s[R*le+2]=qt.z,s[R*le+3]+=g*o,u.wrap&&u.wrapBounds&&(u.localSpace||qt.sub(a),qt.x=Jm(qt.x,u.wrapBounds.x)-u.wrapBounds.x*.5,qt.y=Jm(qt.y,u.wrapBounds.y)-u.wrapBounds.y*.5,qt.z=Jm(qt.z,u.wrapBounds.z)-u.wrapBounds.z*.5,u.localSpace||qt.add(a)),u.sort>0&&(u.sort===1?(Jr.copy(qt).sub(f),u.particleDistance[R]=-(Jr.x*Jr.x+Jr.y*Jr.y+Jr.z*Jr.z)):u.sort===2?u.particleDistance[R]=I:u.sort===3&&(u.particleDistance[R]=-I))),l?I<0&&(s[R*le+3+u.numParticlesPot*2*le]=-1):(I>=V&&(I-=Math.max(V,(u.numParticles-1)*L),s[R*le+3+u.numParticlesPot*2*le]=u.loop?1:-1),I<0&&u.loop&&(s[R*le+3+u.numParticlesPot*2*le]=1)),s[R*le+3+u.numParticlesPot*2*le]<0&&(G=!1),s[R*le+3+u.numParticlesPot*le]=I;for(let X=0;X<u.numParticleVerts;X++){const j=(E*u.numParticleVerts+X)*(u.useMesh?6:4);let J=u.vbCPU[j],ee=u.vbCPU[j+1],se=u.vbCPU[j+2];G||(J=ee=se=0);const oe=E*u.numParticleVerts*p+X*p;e[oe]=qt.x,e[oe+1]=qt.y,e[oe+2]=qt.z,e[oe+3]=F,e[oe+4]=u.alignToMotion?N:s[R*le+3],e[oe+5]=D,e[oe+6]=A,e[oe+7]=nu.x,e[oe+8]=J,e[oe+9]=ee,e[oe+10]=se,e[oe+11]=nu.y,e[oe+12]=R,e[oe+13]=nu.z,e[oe+14]=u.vbCPU[j+3],u.useMesh&&(e[oe+15]=u.vbCPU[j+4],e[oe+16]=u.vbCPU[j+5])}}if(u.sort>ng&&u.camera){const E=u.useMesh?6:4,R=u.particleDistance;for(let B=0;B<u.numParticles;B++)t[B][0]=B,t[B][1]=R[Math.floor(u.vbCPU[B*u.numParticleVerts*E+3])];u.vbOld.set(u.vbCPU),t.sort(function(B,L){return B[1]-L[1]});for(let B=0;B<u.numParticles;B++){const L=t[B][0]*u.numParticleVerts*E,V=B*u.numParticleVerts*E;for(let I=0;I<u.numParticleVerts*E;I++)u.vbCPU[V+I]=u.vbOld[L+I]}}}}const ES=new hi,CS=new hi,AS=new hi;class RF{constructor(e,t){this._emitter=e,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=t.scope.resolve("particleTexIN"),this.constantParticleTexOUT=t.scope.resolve("particleTexOUT"),this.constantEmitterPos=t.scope.resolve("emitterPos"),this.constantEmitterScale=t.scope.resolve("emitterScale"),this.constantSpawnBounds=t.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=t.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=t.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=t.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=t.scope.resolve("initialVelocity"),this.constantFrameRandom=t.scope.resolve("frameRandom"),this.constantDelta=t.scope.resolve("delta"),this.constantRate=t.scope.resolve("rate"),this.constantRateDiv=t.scope.resolve("rateDiv"),this.constantLifetime=t.scope.resolve("lifetime"),this.constantGraphSampleSize=t.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=t.scope.resolve("graphNumSamples"),this.constantInternalTex0=t.scope.resolve("internalTex0"),this.constantInternalTex1=t.scope.resolve("internalTex1"),this.constantInternalTex2=t.scope.resolve("internalTex2"),this.constantInternalTex3=t.scope.resolve("internalTex3"),this.constantEmitterMatrix=t.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=t.scope.resolve("emitterMatrixInv"),this.constantNumParticles=t.scope.resolve("numParticles"),this.constantNumParticlesPot=t.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=t.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=t.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=t.scope.resolve("rotSpeedDivMult"),this.constantSeed=t.scope.resolve("seed"),this.constantStartAngle=t.scope.resolve("startAngle"),this.constantStartAngle2=t.scope.resolve("startAngle2"),this.constantOutBoundsMul=t.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=t.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=t.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=t.scope.resolve("inBoundsCenter"),this.constantMaxVel=t.scope.resolve("maxVel"),this.constantFaceTangent=t.scope.resolve("faceTangent"),this.constantFaceBinorm=t.scope.resolve("faceBinorm")}_setInputBounds(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)}randomize(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random()}update(e,t,s,i,n){const a=this._emitter;e.setBlendState(Xe.NOBLEND),e.setDepthState(kt.NODEPTH),e.setCullMode(Et),this.randomize(),this.constantGraphSampleSize.setValue(1/a.precision),this.constantGraphNumSamples.setValue(a.precision),this.constantNumParticles.setValue(a.numParticles),this.constantNumParticlesPot.setValue(a.numParticlesPot),this.constantInternalTex0.setValue(a.internalTex0),this.constantInternalTex1.setValue(a.internalTex1),this.constantInternalTex2.setValue(a.internalTex2),this.constantInternalTex3.setValue(a.internalTex3);const o=a.meshInstance.node,l=o===null?y.ONE:o.localScale;if(a.pack8){this.worldBoundsMulUniform[0]=a.worldBoundsMul.x,this.worldBoundsMulUniform[1]=a.worldBoundsMul.y,this.worldBoundsMulUniform[2]=a.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=a.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=a.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=a.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();let f=a.maxVel*Math.max(Math.max(l.x,l.y),l.z);f=Math.max(f,1),this.constantMaxVel.setValue(f)}const c=o===null||a.localSpace?y.ZERO:o.getPosition(),d=o===null?q.IDENTITY:o.getWorldTransform();a.emitterShape===zi?(ES.setFromMat4(t),this.constantSpawnBounds.setValue(ES.data),this.constantSpawnPosInnerRatio.setValue(s)):(this.constantSpawnBoundsSphere.setValue(a.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(a.emitterRadius===0?0:a.emitterRadiusInner/a.emitterRadius)),this.constantInitialVelocity.setValue(a.initialVelocity),CS.setFromMat4(d),AS.invertMat4(d),this.emitterPosUniform[0]=c.x,this.emitterPosUniform[1]=c.y,this.emitterPosUniform[2]=c.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(i),this.constantRate.setValue(a.rate),this.constantRateDiv.setValue(a.rate2-a.rate),this.constantStartAngle.setValue(a.startAngle*H.DEG_TO_RAD),this.constantStartAngle2.setValue(a.startAngle2*H.DEG_TO_RAD),this.constantSeed.setValue(a.seed),this.constantLifetime.setValue(a.lifetime),this.emitterScaleUniform[0]=l.x,this.emitterScaleUniform[1]=l.y,this.emitterScaleUniform[2]=l.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(CS.data),this.constantEmitterMatrixInv.setValue(AS.data),this.constantLocalVelocityDivMult.setValue(a.localVelocityUMax),this.constantVelocityDivMult.setValue(a.velocityUMax),this.constantRotSpeedDivMult.setValue(a.rotSpeedUMax[0]);let h=a.swapTex?a.particleTexOUT:a.particleTexIN;h=a.beenReset?a.particleTexStart:h;const u=a.swapTex?a.particleTexIN:a.particleTexOUT;this.constantParticleTexIN.setValue(h),Ya(e,a.swapTex?a.rtParticleTexIN:a.rtParticleTexOUT,n?a.shaderParticleUpdateOnStop:a.loop?a.shaderParticleUpdateRespawn:a.shaderParticleUpdateNoRespawn),a.material.setParameter("particleTexOUT",h),a.material.setParameter("particleTexIN",u),a.beenReset=!1,a.swapTex=!a.swapTex,a.prevWorldBoundsSize.copy(a.worldBoundsSize),a.prevWorldBoundsCenter.copy(a.worldBounds.center),a.pack8&&this._setInputBounds()}}const PS=[[-1,-1],[1,-1],[1,1],[-1,1]];function Xs(r,e,t,s,i=rt,n,a){let o=Ee;a&&i===xe&&(o=nt);const l=new _e(r,{width:e,height:t,format:i,cubemap:!1,mipmaps:!1,minFilter:o,magFilter:o,addressU:ae,addressV:ae,name:"ParticleSystemTexture"}),c=l.lock();if(i===xe){const d=new Uint8Array(s.length);for(let h=0;h<s.length;h++)d[h]=s[h]*n*255;s=d}return c.set(s),l.unlock(),l}function MS(r){return Math.max(Math.min(r,1),0)}const IS=new dt([0,0,1,0]),RS=new dt([0,1,1,1]),LS=new St([0,0,1,0],[0,0,1,0],[0,0,1,0]),LF=new St([0,1,1,1],[0,1,1,1],[0,1,1,1]);let mn=2;const au=4,_n=new Float32Array(3),Qr=new q,DS=new y,ou=new y,lu=new y;let fg,Wu;function he(r,e){Wu[r]!==void 0&&Wu[r]!==null?fg[r]=Wu[r]:fg[r]=e}function Qb(r,e,t){return(r*255<<16|e*255<<8|t*255)/(1<<24)}function OS(r,e){const t=r.length/3,s=new Array(t*4);for(let i=0;i<t;i++)s[i*4]=r[i*3],s[i*4+1]=r[i*3+1],s[i*4+2]=r[i*3+2],s[i*4+3]=Qb(e[i*3],e[i*3+1],e[i*3+2]);return s}function DF(r,e){const t=new Array(e.length*4);for(let s=0;s<e.length;s++)t[s*4]=r[s*3],t[s*4+1]=r[s*3+1],t[s*4+2]=r[s*3+2],t[s*4+3]=e[s];return t}function OF(r,e,t,s,i){const n=new Array(r.length*4);for(let a=0;a<r.length;a++)n[a*4]=r[a],n[a*4+1]=e[a],n[a*4+2]=0,n[a*4+3]=Qb(t[a],s[a],i[a]);return n}function FF(r,e){const t=new Array(r.length*4);for(let s=0;s<r.length;s++)t[s*4]=r[s],t[s*4+1]=e[s],t[s*4+2]=0,t[s*4+3]=0;return t}function kF(r){const e=Math.max(r.rate,r.rate2)*r.numParticles+r.lifetime;return Date.now()+e*1e3}function BF(r,e){const t=new Float32Array(r.length);for(let s=0;s<r.length;s++)t[s]=r[s]-e[s];return t}function fa(r,e){const t=e.length,s=r.length/t;for(let i=0;i<s;i++)for(let n=0;n<t;n++){const a=Math.abs(r[i*t+n]);e[n]=Math.max(e[n],a)}}function NF(r,e){const t=e.length,s=r.length/t;for(let i=0;i<s;i++)for(let n=0;n<t;n++)r[i*t+n]/=e[n]===0?1:e[n],r[i*t+n]*=.5,r[i*t+n]+=.5}function ea(r,e,t){const s=BF(e,r);return fa(s,t),NF(s,t),s}const UF=new di;class zF{constructor(e,t){this.graphicsDevice=e;const s=e,i=32;this.precision=i,this._addTimeTime=0,fg=this,Wu=t,he("numParticles",1),this.numParticles>e.maxTextureSize&&(this.numParticles=e.maxTextureSize),he("rate",1),he("rate2",this.rate),he("lifetime",50),he("emitterExtents",new y(0,0,0)),he("emitterExtentsInner",new y(0,0,0)),he("emitterRadius",0),he("emitterRadiusInner",0),he("emitterShape",zi),he("initialVelocity",1),he("wrap",!1),he("localSpace",!1),he("screenSpace",!1),he("wrapBounds",null),he("colorMap",this.defaultParamTexture),he("normalMap",null),he("loop",!0),he("preWarm",!1),he("sort",ng),he("mode",Rb),he("scene",null),he("lighting",!1),he("halfLambert",!1),he("intensity",1),he("stretch",0),he("alignToMotion",!1),he("depthSoftening",0),he("mesh",null),he("particleNormal",new y(0,1,0)),he("orientation",Uu),he("depthWrite",!1),he("noFog",!1),he("blendType",Bt),he("node",null),he("startAngle",0),he("startAngle2",this.startAngle),he("animTilesX",1),he("animTilesY",1),he("animStartFrame",0),he("animNumFrames",1),he("animNumAnimations",1),he("animIndex",0),he("randomizeAnimIndex",!1),he("animSpeed",1),he("animLoop",!0),this._gpuUpdater=new RF(this,s),this._cpuUpdater=new IF(this),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),he("colorGraph",LF),he("colorGraph2",this.colorGraph),he("scaleGraph",RS),he("scaleGraph2",this.scaleGraph),he("alphaGraph",RS),he("alphaGraph2",this.alphaGraph),he("localVelocityGraph",LS),he("localVelocityGraph2",this.localVelocityGraph),he("velocityGraph",LS),he("velocityGraph2",this.velocityGraph),he("rotationSpeedGraph",IS),he("rotationSpeedGraph2",this.rotationSpeedGraph),he("radialSpeedGraph",IS),he("radialSpeedGraph2",this.radialSpeedGraph),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.internalTex0=null,this.internalTex1=null,this.internalTex2=null,this.colorParam=null,this.vbToSort=null,this.vbOld=null,this.particleDistance=null,this.camera=null,this.swapTex=!1,this.useMesh=!0,this.useCpu=!e.supportsGpuParticles,this.pack8=!0,this.localBounds=new Re,this.worldBoundsNoTrail=new Re,this.worldBoundsTrail=[new Re,new Re],this.worldBounds=new Re,this.worldBoundsSize=new y,this.prevWorldBoundsSize=new y,this.prevWorldBoundsCenter=new y,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new y,this.worldBoundsAdd=new y,this.timeToSwitchBounds=0,this.shaderParticleUpdateRespawn=null,this.shaderParticleUpdateNoRespawn=null,this.shaderParticleUpdateOnStop=null,this.numParticleVerts=0,this.numParticleIndices=0,this.material=null,this.meshInstance=null,this.drawOrder=0,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTime=0,this.simTimeTotal=0,this.beenReset=!1,this._layer=null,this.rebuild()}get defaultParamTexture(){return UF.get(this.graphicsDevice,()=>{const s=new Float32Array(1024);for(let n=0;n<16;n++)for(let a=0;a<16;a++){const o=a+1-8.5,l=n+1-8.5,c=MS(1-MS(Math.sqrt(o*o+l*l)/16)-.5),d=n*16+a;s[d*4]=1,s[d*4+1]=1,s[d*4+2]=1,s[d*4+3]=c}const i=Xs(this.graphicsDevice,16,16,s,xe,1,!0);return i.minFilter=nt,i.magFilter=nt,i})}onChangeCamera(){this.regenShader(),this.resetMaterial()}calculateBoundsMad(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).mulScalar(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5}calculateWorldBounds(){if(!this.node)return;if(this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),!this.useCpu){let s=!1;this.emitterShape===zi?s=!this.emitterExtents.equals(this.prevEmitterExtents):s=this.emitterRadius!==this.prevEmitterRadius,s&&this.calculateLocalBounds()}const e=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,e),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);const t=this.simTimeTotal;t>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=t+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,e),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,e)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad()}resetWorldBounds(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?q.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.simTimeTotal=0,this.timeToSwitchBounds=0)}calculateLocalBounds(){let e=Number.MAX_VALUE,t=Number.MAX_VALUE,s=Number.MAX_VALUE,i=-Number.MAX_VALUE,n=-Number.MAX_VALUE,a=-Number.MAX_VALUE,o=0,l=0;const c=this.lifetime/this.precision,d=[this.qVelocity,this.qVelocity2],h=[this.qLocalVelocity,this.qLocalVelocity2],u=[0,0],f=[0,0],p=[0,0],_=[0,0],m=[0,0];let g,v,x;for(let w=0;w<this.precision+1;w++){const T=Math.min(w,this.precision-1);for(let b=0;b<2;b++)g=h[b][T*3+0]*c+u[b],v=h[b][T*3+1]*c+f[b],x=h[b][T*3+2]*c+p[b],e=Math.min(g,e),t=Math.min(v,t),s=Math.min(x,s),i=Math.max(g,i),n=Math.max(v,n),a=Math.max(x,a),u[b]=g,f[b]=v,p[b]=x;for(let b=0;b<2;b++)m[b]+=c*Math.sqrt(d[b][T*3+0]*d[b][T*3+0]+d[b][T*3+1]*d[b][T*3+1]+d[b][T*3+2]*d[b][T*3+2]);_[0]+=this.qRadialSpeed[T]*c,_[1]+=this.qRadialSpeed2[T]*c,o=Math.max(o,Math.max(Math.abs(_[0]),Math.abs(_[1]))),l=Math.max(l,this.qScale[T])}this.emitterShape===zi?(g=this.emitterExtents.x*.5,v=this.emitterExtents.y*.5,x=this.emitterExtents.z*.5):(g=this.emitterRadius,v=this.emitterRadius,x=this.emitterRadius);const S=Math.max(m[0],m[1]);ou.x=e-l-g-o-S,ou.y=t-l-v-o-S,ou.z=s-l-x-o-S,lu.x=i+l+g+o+S,lu.y=n+l+v+o+S,lu.z=a+l+x+o+S,this.localBounds.setMinMax(ou,lu)}rebuild(){const e=this.graphicsDevice;this.colorMap===null&&(this.colorMap=this.defaultParamTexture),this.spawnBounds=this.emitterShape===zi?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||this.sort>ng||e.maxVertexTextures<=1||e.fragmentUniformsCount<64||e.forceCpuParticles||!e.extTextureFloat,this._destroyResources(),this.pack8=(this.pack8||!e.textureFloatRenderable)&&!this.useCpu,mn=this.useCpu||this.pack8?4:2,this.useMesh=!1,this.mesh&&(this.numParticles*this.mesh.vertexBuffer.numVertices>65535||(this.useMesh=!0)),this.numParticlesPot=H.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?q.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=new Array(this.numParticles);for(let d=0;d<this.numParticles;d++)this.vbToSort[d]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*mn*au);const t=this.node===null||this.localSpace?y.ZERO:this.node.getPosition();this.emitterShape===zi&&(this.node===null||this.localSpace?Qr.setTRS(y.ZERO,re.IDENTITY,this.spawnBounds):Qr.setTRS(y.ZERO,this.node.getRotation(),DS.copy(this.spawnBounds).mul(this.node.localScale)),_n[0]=this.emitterExtents.x!==0?this.emitterExtentsInner.x/this.emitterExtents.x:0,_n[1]=this.emitterExtents.y!==0?this.emitterExtentsInner.y/this.emitterExtents.y:0,_n[2]=this.emitterExtents.z!==0?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(let d=0;d<this.numParticles;d++)this._cpuUpdater.calcSpawnPosition(this.particleTex,Qr,_n,t,d),this.useCpu&&(this.particleTex[d*au+3+this.numParticlesPot*2*au]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*mn*au);for(let d=0;d<this.particleTexStart.length;d++)this.particleTexStart[d]=this.particleTex[d];this.useCpu||(this.pack8?(this.particleTexIN=Xs(e,this.numParticlesPot,mn,this.particleTex,xe,1,!1),this.particleTexOUT=Xs(e,this.numParticlesPot,mn,this.particleTex,xe,1,!1),this.particleTexStart=Xs(e,this.numParticlesPot,mn,this.particleTexStart,xe,1,!1)):(this.particleTexIN=Xs(e,this.numParticlesPot,mn,this.particleTex),this.particleTexOUT=Xs(e,this.numParticlesPot,mn,this.particleTex),this.particleTexStart=Xs(e,this.numParticlesPot,mn,this.particleTexStart)),this.rtParticleTexIN=new Ct({colorBuffer:this.particleTexIN,depth:!1}),this.rtParticleTexOUT=new Ct({colorBuffer:this.particleTexOUT,depth:!1}),this.swapTex=!1);const s=(this.localSpace?`#define LOCAL_SPACE
`:"")+W.particleUpdaterInitPS+(this.pack8?W.particleInputRgba8PS+W.particleOutputRgba8PS:W.particleInputFloatPS+W.particleOutputFloatPS)+(this.emitterShape===zi?W.particleUpdaterAABBPS:W.particleUpdaterSpherePS)+W.particleUpdaterStartPS,i=s+W.particleUpdaterRespawnPS+W.particleUpdaterEndPS,n=s+W.particleUpdaterNoRespawnPS+W.particleUpdaterEndPS,a=s+W.particleUpdaterOnStopPS+W.particleUpdaterEndPS,o=this.emitterShape+""+this.pack8+this.localSpace;this.shaderParticleUpdateRespawn=ks(e,W.fullscreenQuadVS,i,"fsQuad0"+o),this.shaderParticleUpdateNoRespawn=ks(e,W.fullscreenQuadVS,n,"fsQuad1"+o),this.shaderParticleUpdateOnStop=ks(e,W.fullscreenQuadVS,a,"fsQuad2"+o),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles);const l=new Vs(e);l.vertexBuffer=this.vertexBuffer,l.indexBuffer[0]=this.indexBuffer,l.primitive[0].type=Ln,l.primitive[0].base=0,l.primitive[0].count=this.numParticles*this.numParticleIndices,l.primitive[0].indexed=!0,this.material=new Jt,this.material.name=this.node.name,this.material.cull=Et,this.material.alphaWrite=!1,this.material.blendType=this.blendType,this.material.depthWrite=this.depthWrite,this.material.emitter=this,this.regenShader(),this.resetMaterial();const c=this.meshInstance?this.meshInstance.visible:!0;this.meshInstance=new Fe(l,this.material,this.node),this.meshInstance.pick=!1,this.meshInstance.updateKey(),this.meshInstance.cull=!0,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=!1,this.meshInstance.visible=c,this._initializeTextures(),this.resetTime(),this.addTime(0,!1),this.preWarm&&this.prewarm(this.lifetime)}_isAnimated(){return this.animNumFrames>=1&&(this.animTilesX>1||this.animTilesY>1)&&(this.colorMap&&this.colorMap!==this.defaultParamTexture||this.normalMap)}rebuildGraphs(){const e=this.precision,t=this.graphicsDevice;this.qLocalVelocity=this.localVelocityGraph.quantize(e),this.qVelocity=this.velocityGraph.quantize(e),this.qColor=this.colorGraph.quantizeClamped(e,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(e),this.qScale=this.scaleGraph.quantize(e),this.qAlpha=this.alphaGraph.quantize(e),this.qRadialSpeed=this.radialSpeedGraph.quantize(e),this.qLocalVelocity2=this.localVelocityGraph2.quantize(e),this.qVelocity2=this.velocityGraph2.quantize(e),this.qColor2=this.colorGraph2.quantizeClamped(e,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(e),this.qScale2=this.scaleGraph2.quantize(e),this.qAlpha2=this.alphaGraph2.quantize(e),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(e);for(let s=0;s<e;s++)this.qRotSpeed[s]*=H.DEG_TO_RAD,this.qRotSpeed2[s]*=H.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=ea(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=ea(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=ea(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=ea(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=ea(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=ea(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=ea(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){const s=[0,0,0];fa(this.qVelocity,s);const i=[0,0,0];fa(this.qVelocity2,i);const n=[0,0,0];fa(this.qLocalVelocity,n);const a=[0,0,0];fa(this.qLocalVelocity2,a);const o=[0];fa(this.qRadialSpeed,o);const l=[0];fa(this.qRadialSpeed2,l);let c=Math.max(s[0],i[0]);c=Math.max(c,s[1]),c=Math.max(c,i[1]),c=Math.max(c,s[2]),c=Math.max(c,i[2]);let d=Math.max(n[0],a[0]);d=Math.max(d,n[1]),d=Math.max(d,a[1]),d=Math.max(d,n[2]),d=Math.max(d,a[2]);const h=Math.max(o[0],l[0]);this.maxVel=c+d+h}this.useCpu||(this.internalTex0=Xs(t,e,1,OS(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=Xs(t,e,1,OS(this.qVelocity,this.qVelocityDiv)),this.internalTex2=Xs(t,e,1,OF(this.qRotSpeed,this.qScale,this.qScaleDiv,this.qRotSpeedDiv,this.qAlphaDiv)),this.internalTex3=Xs(t,e,1,FF(this.qRadialSpeed,this.qRadialSpeedDiv))),this.colorParam=Xs(t,e,1,DF(this.qColor,this.qAlpha),xe,1,!0)}_initializeTextures(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))}regenShader(){const e=cn(this.graphicsDevice);e.register("particle",AF);const t=this.normalMap!==null;this.normalOption=0,this.lighting&&(this.normalOption=t?2:1),this.material.getShaderVariant=function(s,i,n,a,o,l,c,d){this.emitter.scene&&this.emitter.camera!==this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera());const h=this.emitter.inTools,u=new lo(c,d);return e.getProgram("particle",{pass:wd,useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:h?!1:this.emitter.screenSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:this.emitter.orientation!==Uu},u)},this.material.shader=this.material.getShaderVariant()}resetMaterial(){const e=this.material;e.setParameter("stretch",this.stretch),this._isAnimated()&&(e.setParameter("animTexTilesParams",this.animTilesParams),e.setParameter("animTexParams",this.animParams),e.setParameter("animTexIndexParams",this.animIndexParams)),e.setParameter("colorMult",this.intensity),this.useCpu||(e.setParameter("internalTex0",this.internalTex0),e.setParameter("internalTex1",this.internalTex1),e.setParameter("internalTex2",this.internalTex2),e.setParameter("internalTex3",this.internalTex3)),e.setParameter("colorParam",this.colorParam),e.setParameter("numParticles",this.numParticles),e.setParameter("numParticlesPot",this.numParticlesPot),e.setParameter("lifetime",this.lifetime),e.setParameter("rate",this.rate),e.setParameter("rateDiv",this.rate2-this.rate),e.setParameter("seed",this.seed),e.setParameter("scaleDivMult",this.scaleUMax[0]),e.setParameter("alphaDivMult",this.alphaUMax[0]),e.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),e.setParameter("graphNumSamples",this.precision),e.setParameter("graphSampleSize",1/this.precision),e.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),e.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),e.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),e.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,e.setParameter("wrapBounds",this.wrapBoundsUniform)),this.colorMap&&e.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&e.setParameter("normalMap",this.normalMap),this.depthSoftening>0&&e.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),this.stretch>0&&(e.cull=Et),this._compParticleFaceParams()}_compParticleFaceParams(){let e,t;if(this.orientation===Uu)e=new Float32Array([1,0,0]),t=new Float32Array([0,0,1]);else{let s;this.orientation===pI?s=this.particleNormal.normalize():s=(this.node===null?q.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize();const i=new y(1,0,0);Math.abs(i.dot(s))===1&&i.set(0,0,1);const n=new y().cross(s,i).normalize();i.cross(n,s).normalize(),e=new Float32Array([i.x,i.y,i.z]),t=new Float32Array([n.x,n.y,n.z])}this.material.setParameter("faceTangent",e),this.material.setParameter("faceBinorm",t)}_allocate(e){const t=e*this.numParticleVerts,s=e*this.numParticleIndices;if(this.vertexBuffer===void 0||this.vertexBuffer.getNumVertices()!==t){if(this.useCpu){const d=[{semantic:sf,components:4,type:Me},{semantic:j_,components:4,type:Me},{semantic:ib,components:4,type:Me},{semantic:nb,components:1,type:Me},{semantic:rb,components:this.useMesh?4:2,type:Me}],h=new os(this.graphicsDevice,d);this.vertexBuffer=new Mi(this.graphicsDevice,h,t,Pl),this.indexBuffer=new Br(this.graphicsDevice,ai,s)}else{const d=[{semantic:sf,components:4,type:Me}];this.useMesh&&d.push({semantic:j_,components:2,type:Me});const h=new os(this.graphicsDevice,d);this.vertexBuffer=new Mi(this.graphicsDevice,h,t,Pl),this.indexBuffer=new Br(this.graphicsDevice,ai,s)}const i=new Float32Array(this.vertexBuffer.lock());let n,a,o;if(this.useMesh){n=new Float32Array(this.mesh.vertexBuffer.lock()),a=n.length/this.mesh.vertexBuffer.numVertices;for(let d=0;d<this.mesh.vertexBuffer.format.elements.length;d++)if(this.mesh.vertexBuffer.format.elements[d].name===zs){o=this.mesh.vertexBuffer.format.elements[d].offset/4;break}}for(let d=0;d<t;d++){const h=Math.floor(d/this.numParticleVerts);if(this.useMesh){const u=d%this.numParticleVerts;i[d*6]=n[u*a],i[d*6+1]=n[u*a+1],i[d*6+2]=n[u*a+2],i[d*6+3]=h,i[d*6+4]=n[u*a+o+0],i[d*6+5]=1-n[u*a+o+1]}else{const u=d%4;i[d*4]=PS[u][0],i[d*4+1]=PS[u][1],i[d*4+2]=0,i[d*4+3]=h}}this.useCpu&&(this.vbCPU=new Float32Array(i),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock();let l=0;const c=new Uint16Array(this.indexBuffer.lock());this.useMesh&&(n=new Uint16Array(this.mesh.indexBuffer[0].lock()));for(let d=0;d<e;d++)if(this.useMesh)for(let h=0;h<this.numParticleIndices;h++)c[d*this.numParticleIndices+h]=n[h]+d*this.numParticleVerts;else{const h=d*4;c[l++]=h,c[l++]=h+1,c[l++]=h+2,c[l++]=h,c[l++]=h+2,c[l++]=h+3}this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock()}}reset(){if(this.beenReset=!0,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(let t=0;t<this.particleTexStart.length;t++)this.particleTex[t]=this.particleTexStart[t];else this._initializeTextures();this.resetWorldBounds(),this.resetTime();const e=this.loop;this.loop=!0,this.addTime(0,!1),this.loop=e,this.preWarm&&this.prewarm(this.lifetime)}prewarm(e){const t=e/this.lifetime,s=Math.min(Math.floor(t*this.precision),this.precision),i=e/s;for(let n=0;n<s;n++)this.addTime(i,!1)}resetTime(){this.endTime=kF(this)}finishFrame(){this.useCpu&&this.vertexBuffer.unlock()}addTime(e,t){const s=this.graphicsDevice;if(this.simTimeTotal+=e,this.calculateWorldBounds(),this._isAnimated()){const a=this.animTilesParams;a[0]=1/this.animTilesX,a[1]=1/this.animTilesY;const o=this.animParams;o[0]=this.animStartFrame,o[1]=this.animNumFrames*this.animSpeed,o[2]=this.animNumFrames-1,o[3]=this.animNumAnimations-1;const l=this.animIndexParams;l[0]=this.animIndex,l[1]=this.randomizeAnimIndex}this.scene&&this.camera!==this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),this.emitterShape===zi&&(_n[0]=this.emitterExtents.x!==0?this.emitterExtentsInner.x/this.emitterExtents.x:0,_n[1]=this.emitterExtents.y!==0?this.emitterExtentsInner.y/this.emitterExtents.y:0,_n[2]=this.emitterExtents.z!==0?this.emitterExtentsInner.z/this.emitterExtents.z:0,this.meshInstance.node===null?Qr.setTRS(y.ZERO,re.IDENTITY,this.emitterExtents):Qr.setTRS(y.ZERO,this.meshInstance.node.getRotation(),DS.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));let i;const n=this.meshInstance.node===null?y.ONE:this.meshInstance.node.localScale;if(this.emitterScaleUniform[0]=n.x,this.emitterScaleUniform[1]=n.y,this.emitterScaleUniform[2]=n.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node&&(i=this.meshInstance.node.getPosition(),this.emitterPosUniform[0]=i.x,this.emitterPosUniform[1]=i.y,this.emitterPosUniform[2]=i.z,this.material.setParameter("emitterPos",this.emitterPosUniform)),this._compParticleFaceParams(),!this.useCpu)this._gpuUpdater.update(s,Qr,_n,e,t);else{const a=new Float32Array(this.vertexBuffer.lock());this._cpuUpdater.update(a,this.vbToSort,this.particleTex,Qr,_n,i,e,t)}this.loop||Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=!1),this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder)}_destroyResources(){this.particleTexIN&&(this.particleTexIN.destroy(),this.particleTexIN=null),this.particleTexOUT&&(this.particleTexOUT.destroy(),this.particleTexOUT=null),this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),this.rtParticleTexIN&&(this.rtParticleTexIN.destroy(),this.rtParticleTexIN=null),this.rtParticleTexOUT&&(this.rtParticleTexOUT.destroy(),this.rtParticleTexOUT=null),this.internalTex0&&(this.internalTex0.destroy(),this.internalTex0=null),this.internalTex1&&(this.internalTex1.destroy(),this.internalTex1=null),this.internalTex2&&(this.internalTex2.destroy(),this.internalTex2=null),this.internalTex3&&(this.internalTex3.destroy(),this.internalTex3=null),this.colorParam&&(this.colorParam.destroy(),this.colorParam=null),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=void 0),this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0),this.material&&(this.material.destroy(),this.material=null)}destroy(){this.camera=null,this._destroyResources()}}class VF extends Be{generateKey(e){return`skybox-${e.type}-${e.encoding}-${e.useIntensity}-${e.gamma}-${e.toneMapping}-${e.skymesh}`+(e.type==="cubemap"?`-${e.fixSeams}-${e.mip}`:"")}createShaderDefinition(e,t){const s=t.skymesh===Gu?"":`#define SKYMESH
`,i=s+W.skyboxVS;let n=s;if(t.type==="cubemap"){const a=[128,64,16,8,4,2];n+=t.mip?W.fixCubemapSeamsStretchPS:W.fixCubemapSeamsNonePS,n+=t.useIntensity?W.envMultiplyPS:W.envConstPS,n+=W.decodePS,n+=Be.gammaCode(t.gamma),n+=Be.tonemapCode(t.toneMapping),n+=W.skyboxHDRPS.replace(/\$DECODE/g,xi.decodeFunc(t.encoding)).replace(/\$FIXCONST/g,1-1/a[t.mip]+"")}else n+=t.useIntensity?W.envMultiplyPS:W.envConstPS,n+=W.decodePS,n+=Be.gammaCode(t.gamma),n+=Be.tonemapCode(t.toneMapping),n+=W.sphericalPS,n+=W.envAtlasPS,n+=W.skyboxEnvPS.replace(/\$DECODE/g,xi.decodeFunc(t.encoding));return Mt.createDefinition(e,{name:"SkyboxShader",attributes:{aPosition:ht},vertexCode:i,fragmentCode:n})}}const GF=new VF;class ec{static create(e,t){switch(t){case CI:return ec.box(e);case AI:return ec.dome(e)}return ec.infinite(e)}static infinite(e){return cf(e)}static box(e){return cf(e,{yOffset:.5})}static dome(e){const l=[],c=[];for(let d=0;d<=50;d++){const h=d*Math.PI/50,u=Math.sin(h),f=Math.cos(h);for(let p=0;p<=50;p++){const _=p*2*Math.PI/50-Math.PI/2,m=Math.sin(_),v=Math.cos(_)*u;let x=f;const S=m*u;x<0&&(x*=.3,v*v+S*S<.9025&&(x=-.1)),x+=.1,l.push(v*.5,x*.5,S*.5)}}for(let d=0;d<50;++d)for(let h=0;h<50;++h){const u=d*51+h,f=u+50+1;c.push(u+1,f,u),c.push(u+1,f+1,f)}return nn(e,l,{indices:c})}}class HF{constructor(e,t,s,i,n){this.meshInstance=null;const a=new Jt;a.getShaderVariant=function(l,c,d,h,u,f,p,_){const m={pass:u,encoding:i.encoding,useIntensity:t.skyboxIntensity!==1||t.physicalUnits,gamma:u===sn?t.gammaCorrection?Sd:vd:t.gammaCorrection,toneMapping:u===sn?xd:t.toneMapping,skymesh:n};i.cubemap?(m.type="cubemap",m.mip=i.fixCubemapSeams?t.skyboxMip:0,m.fixSeams=i.fixCubemapSeams):m.type="envAtlas";const g=new lo(p,_),v=cn(e);return v.register("skybox",GF),v.getProgram("skybox",m,g)},i.cubemap?a.setParameter("texture_cubeMap",i):(a.setParameter("texture_envAtlas",i),a.setParameter("mipLevel",t._skyboxMip)),a.cull=Xh,a.depthWrite=!1;const o=t.layers.getLayerById(zy);if(o){const l=ec.create(e,n),c=new Fe(l,a,s);this.meshInstance=c,c.cull=!1,c.pick=!1,o.addMeshInstances([c]),this.skyLayer=o}}destroy(){this.meshInstance&&(this.skyLayer&&this.skyLayer.removeMeshInstances([this.meshInstance]),this.meshInstance.destroy(),this.meshInstance=null)}}class WF{constructor(e){this._type=Gu,this._center=new y(0,1,0),this.skyMesh=null,this.node=new ze("SkyMeshNode"),this.device=e.device,this.scene=e,this.center=new y(0,1,0),this.centerArray=new Float32Array(3),this.projectedSkydomeCenterId=this.device.scope.resolve("projectedSkydomeCenter")}applySettings(e){var t,s,i,n;this.type=(t=e.skyType)!=null?t:Gu,this.node.setLocalPosition(new y((s=e.skyMeshPosition)!=null?s:[0,0,0])),this.node.setLocalEulerAngles(new y((i=e.skyMeshRotation)!=null?i:[0,0,0])),this.node.setLocalScale(new y((n=e.skyMeshScale)!=null?n:[1,1,1])),e.skyCenter&&(this._center=new y(e.skyCenter))}set type(e){this._type!==e&&(this._type=e,this.scene.updateShaders=!0,this.updateSkyMesh())}get type(){return this._type}set center(e){this._center.copy(e)}get center(){return this._center}updateSkyMesh(){const e=this.scene._getSkyboxTex();e&&(this.resetSkyMesh(),this.skyMesh=new HF(this.device,this.scene,this.node,e,this.type),this.scene.fire("set:skybox",e))}resetSkyMesh(){var e;(e=this.skyMesh)==null||e.destroy(),this.skyMesh=null}update(){if(this.type!==Gu){const{center:e,centerArray:t}=this,s=new y;this.node.getWorldTransform().transformPoint(e,s),t[0]=s.x,t[1]=s.y,t[2]=s.z,this.projectedSkydomeCenterId.setValue(t)}}}const uf=new ze;uf.worldTransform=q.IDENTITY;uf._dirtyWorld=uf._dirtyNormal=!1;class jF{constructor(e,t,s){this.material=t,this.layer=s,this.positions=[],this.colors=[],this.mesh=new Vs(e),this.meshInstance=null}addLines(e,t){const s=this.positions,i=e.length;for(let a=0;a<i;a++){const o=e[a];s.push(o.x,o.y,o.z)}const n=this.colors;if(t.length)for(let a=0;a<i;a++){const o=t[a];n.push(o.r,o.g,o.b,o.a)}else for(let a=0;a<i;a++)n.push(t.r,t.g,t.b,t.a)}addLinesArrays(e,t){const s=this.positions;for(let n=0;n<e.length;n+=3)s.push(e[n],e[n+1],e[n+2]);const i=this.colors;if(t.length)for(let n=0;n<t.length;n+=4)i.push(t[n],t[n+1],t[n+2],t[n+3]);else{const n=e.length/3;for(let a=0;a<n;a++)i.push(t.r,t.g,t.b,t.a)}}onPreRender(e,t){this.positions.length>0&&this.material.transparent===t&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(Lp,!1),this.meshInstance||(this.meshInstance=new Fe(this.mesh,this.material,uf)),this.positions.length=0,this.colors.length=0,e.push(this.meshInstance))}}class $F{constructor(e){this.device=e,this.map=new Map}getBatch(e,t){let s=this.map.get(e);return s||(s=new jF(this.device,e,t),this.map.set(e,s)),s}onPreRender(e,t){this.map.forEach(s=>{s.onPreRender(e,t)})}}const qs=[],Mo=new y;class XF{constructor(e){this.device=e,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map}createMaterial(e){const t=new M2;return t.vertexColors=!0,t.blendType=Bt,t.depthTest=e,t.update(),t}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(!0)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(!1)),this._materialNoDepth}getBatch(e,t){let s=this.batchesMap.get(e);s||(s=new $F(this.device),this.batchesMap.set(e,s)),this.allBatches.add(s);const i=t?this.materialDepth:this.materialNoDepth;return s.getBatch(i,e)}getShader(e,t){if(!this[e]){const s=`
				attribute vec2 vertex_position;
				uniform mat4 matrix_model;
				varying vec2 uv0;
				void main(void) {
					gl_Position = matrix_model * vec4(vertex_position, 0, 1);
					uv0 = vertex_position.xy + 0.5;
				}
			`;this[e]=ks(this.device,s,t,`DebugShader:${e}`)}return this[e]}getTextureShader(){return this.getShader("textureShader",`
			varying vec2 uv0;
			uniform sampler2D colorMap;
			void main (void) {
				gl_FragColor = vec4(texture2D(colorMap, uv0).xyz, 1);
			}
		`)}getUnfilterableTextureShader(){return this.getShader("textureShaderUnfilterable",`
			varying vec2 uv0;
			uniform highp sampler2D colorMap;
			void main (void) {
				ivec2 uv = ivec2(uv0 * textureSize(colorMap, 0));
				gl_FragColor = vec4(texelFetch(colorMap, uv, 0).xyz, 1);
			}
		`)}getDepthTextureShader(){return this.getShader("depthTextureShader",`
			${W.screenDepthPS}
			varying vec2 uv0;
			void main() {
				float depth = getLinearScreenDepth(getImageEffectUV(uv0)) * camera_params.x;
				gl_FragColor = vec4(vec3(depth), 1.0);
			}
		`)}getQuadMesh(){return this.quadMesh||(this.quadMesh=new Vs(this.device),this.quadMesh.setPositions([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),this.quadMesh.update(Ji)),this.quadMesh}drawMesh(e,t,s,i,n){if(!i){const o=this.getGraphNode(t);i=new Fe(s,e,o)}let a=this.layerMeshInstances.get(n);a||(a=[],this.layerMeshInstances.set(n,a)),a.push(i)}drawWireAlignedBox(e,t,s,i,n,a){if(a){const l=(c,d,h)=>{Mo.set(c,d,h),a.transformPoint(Mo,Mo),qs.push(Mo.x,Mo.y,Mo.z)};l(e.x,e.y,e.z),l(e.x,t.y,e.z),l(e.x,t.y,e.z),l(t.x,t.y,e.z),l(t.x,t.y,e.z),l(t.x,e.y,e.z),l(t.x,e.y,e.z),l(e.x,e.y,e.z),l(e.x,e.y,t.z),l(e.x,t.y,t.z),l(e.x,t.y,t.z),l(t.x,t.y,t.z),l(t.x,t.y,t.z),l(t.x,e.y,t.z),l(t.x,e.y,t.z),l(e.x,e.y,t.z),l(e.x,e.y,e.z),l(e.x,e.y,t.z),l(e.x,t.y,e.z),l(e.x,t.y,t.z),l(t.x,t.y,e.z),l(t.x,t.y,t.z),l(t.x,e.y,e.z),l(t.x,e.y,t.z)}else qs.push(e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,e.z,e.x,t.y,t.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,e.y,e.z,t.x,e.y,t.z);this.getBatch(n,i).addLinesArrays(qs,s),qs.length=0}drawWireSphere(e,t,s,i,n,a){const o=2*Math.PI/i;let l=0;for(let d=0;d<i;d++){const h=Math.sin(l),u=Math.cos(l);l+=o;const f=Math.sin(l),p=Math.cos(l);qs.push(e.x+t*h,e.y,e.z+t*u),qs.push(e.x+t*f,e.y,e.z+t*p),qs.push(e.x+t*h,e.y+t*u,e.z),qs.push(e.x+t*f,e.y+t*p,e.z),qs.push(e.x,e.y+t*h,e.z+t*u),qs.push(e.x,e.y+t*f,e.z+t*p)}this.getBatch(a,n).addLinesArrays(qs,s),qs.length=0}getGraphNode(e){const t=new ze("ImmediateDebug");return t.worldTransform=e,t._dirtyWorld=t._dirtyNormal=!1,t}onPreRenderLayer(e,t,s){if(this.batchesMap.forEach((i,n)=>{n===e&&i.onPreRender(t,s)}),!this.updatedLayers.has(e)){this.updatedLayers.add(e);const i=this.layerMeshInstances.get(e);if(i){for(let n=0;n<i.length;n++)t.push(i[n]);i.length=0}}}onPostRender(){this.allBatches.clear(),this.updatedLayers.clear()}}let js=class extends ie{constructor(e){super(),this.ambientBake=!1,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new k(0,0,0),this.ambientLuminance=0,this.exposure=1,this.fogColor=new k(0,0,0),this.fogDensity=0,this.fogEnd=1e3,this.fogStart=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=zu,this.lightmapFilterEnabled=!1,this.lightmapHDR=!1,this.root=null,this.physicalUnits=!1,this._envAtlas=null,this._skyboxCubeMap=null,this.device=e,this._gravity=new y(0,-9.8,0),this._layers=null,this._fog=qp,this._gammaCorrection=Hy,this._toneMapping=0,this._prefilteredCubemaps=[],this._internalEnvAtlas=null,this._skyboxIntensity=1,this._skyboxLuminance=0,this._skyboxMip=0,this._skyboxRotationShaderInclude=!1,this._skyboxRotation=new re,this._skyboxRotationMat3=new hi,this._skyboxRotationMat4=new q,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=!0,this._lightingParams=new Jb(this.device.supportsAreaLights,this.device.maxTextureSize,()=>{this.updateShaders=!0}),this._sky=new WF(this),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,updateShadersTime:0},this.updateShaders=!0,this._shaderVersion=0,this.immediate=new XF(this.device)}get defaultDrawLayer(){return this.layers.getLayerById(Ti)}set ambientBakeNumSamples(e){this._ambientBakeNumSamples=H.clamp(Math.floor(e),1,255)}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(e){this._ambientBakeSpherePart=H.clamp(e,.001,1)}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(e){if(!(this.device.isWebGPU&&!e)){if(!this._clusteredLightingEnabled&&e){console.error("Turning on disabled clustered lighting is not currently supported");return}this._clusteredLightingEnabled=e}}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set envAtlas(e){e!==this._envAtlas&&(this._envAtlas=e,e&&(e.addressU=ae,e.addressV=ae,e.minFilter=nt,e.magFilter=nt,e.mipmaps=!1),this._prefilteredCubemaps=[],this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._resetSkyMesh())}get envAtlas(){return this._envAtlas}set fog(e){e!==this._fog&&(this._fog=e,this.updateShaders=!0)}get fog(){return this._fog}set gammaCorrection(e){e!==this._gammaCorrection&&(this._gammaCorrection=e,this.updateShaders=!0)}get gammaCorrection(){return this._gammaCorrection}set layers(e){const t=this._layers;this._layers=e,this.fire("set:layers",t,e)}get layers(){return this._layers}get sky(){return this._sky}get lighting(){return this._lightingParams}set lightmapFilterRange(e){this._lightmapFilterRange=Math.max(e,.001)}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(e){this._lightmapFilterSmoothness=Math.max(e,.001)}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(e){e=e||[];const t=this._prefilteredCubemaps;(t.length!==e.length||t.some((i,n)=>i!==e[n]))&&(e.length===6&&e.every(n=>!!n)?(this._internalEnvAtlas=Xb.generatePrefilteredAtlas(e,{target:this._internalEnvAtlas}),this._envAtlas=this._internalEnvAtlas):(this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._envAtlas=null),this._prefilteredCubemaps=e.slice(),this._resetSkyMesh())}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(e){e!==this._skyboxCubeMap&&(this._skyboxCubeMap=e,this._resetSkyMesh())}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(e){e!==this._skyboxIntensity&&(this._skyboxIntensity=e,this._resetSkyMesh())}get skyboxIntensity(){return this._skyboxIntensity}set skyboxLuminance(e){e!==this._skyboxLuminance&&(this._skyboxLuminance=e,this._resetSkyMesh())}get skyboxLuminance(){return this._skyboxLuminance}set skyboxMip(e){e!==this._skyboxMip&&(this._skyboxMip=e,this._resetSkyMesh())}get skyboxMip(){return this._skyboxMip}set skyboxRotation(e){if(!this._skyboxRotation.equals(e)){const t=e.equals(re.IDENTITY);this._skyboxRotation.copy(e),t?this._skyboxRotationMat3.setIdentity():(this._skyboxRotationMat4.setTRS(y.ZERO,e,y.ONE),this._skyboxRotationMat3.invertMat4(this._skyboxRotationMat4)),!this._skyboxRotationShaderInclude&&!t&&(this._skyboxRotationShaderInclude=!0,this._resetSkyMesh())}}get skyboxRotation(){return this._skyboxRotation}set toneMapping(e){e!==this._toneMapping&&(this._toneMapping=e,this.updateShaders=!0)}get toneMapping(){return this._toneMapping}destroy(){this._resetSkyMesh(),this.root=null,this.off()}drawLine(e,t,s=k.WHITE,i=!0,n=this.defaultDrawLayer){this.immediate.getBatch(n,i).addLines([e,t],[s,s])}drawLines(e,t,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLines(e,t)}drawLineArrays(e,t,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLinesArrays(e,t)}applySettings(e){var t,s,i,n;const a=e.physics,o=e.render;this._gravity.set(a.gravity[0],a.gravity[1],a.gravity[2]),this.ambientLight.set(o.global_ambient[0],o.global_ambient[1],o.global_ambient[2]),this.ambientLuminance=o.ambientLuminance,this._fog=o.fog,this.fogColor.set(o.fog_color[0],o.fog_color[1],o.fog_color[2]),this.fogStart=o.fog_start,this.fogEnd=o.fog_end,this.fogDensity=o.fog_density,this._gammaCorrection=o.gamma_correction,this._toneMapping=o.tonemapping,this.lightmapSizeMultiplier=o.lightmapSizeMultiplier,this.lightmapMaxResolution=o.lightmapMaxResolution,this.lightmapMode=o.lightmapMode,this.exposure=o.exposure,this._skyboxIntensity=(t=o.skyboxIntensity)!=null?t:1,this._skyboxLuminance=(s=o.skyboxLuminance)!=null?s:2e4,this._skyboxMip=(i=o.skyboxMip)!=null?i:0,o.skyboxRotation&&(this.skyboxRotation=new re().setFromEulerAngles(o.skyboxRotation[0],o.skyboxRotation[1],o.skyboxRotation[2])),this.sky.applySettings(o),this.clusteredLightingEnabled=(n=o.clusteredLightingEnabled)!=null?n:!1,this.lighting.applySettings(o),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach(l=>{o.hasOwnProperty(l)&&(this[l]=o[l])}),this._resetSkyMesh()}_getSkyboxTex(){const e=this._prefilteredCubemaps;return this._skyboxMip?e[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||e[0]||this._skyboxCubeMap:this._skyboxCubeMap||e[0]||this._envAtlas}_updateSkyMesh(){this.sky.skyMesh||this.sky.updateSkyMesh(),this.sky.update()}_resetSkyMesh(){this.sky.resetSkyMesh(),this.updateShaders=!0}setSkybox(e){e?(this.skybox=e[0]||null,e[1]&&!e[1].cubemap?this.envAtlas=e[1]:this.prefilteredCubemaps=e.slice(1)):(this.skybox=null,this.envAtlas=null)}get lightmapPixelFormat(){return this.lightmapHDR&&this.device.getRenderableHdrFormat()||xe}};js.EVENT_SETLAYERS="set:layers";js.EVENT_SETSKYBOX="set:skybox";class eT{constructor(e,t,s){this.device=e,this.inverseBindPose=t,this.boneNames=s}}const qF=[0,0,1,0,0,1,0,0,1,0,0,1],KF=[0,1,3,2,3,1];class tc extends ie{constructor(e,t){super(),this._device=e,this._pixelsPerUnit=t&&t.pixelsPerUnit!==void 0?t.pixelsPerUnit:1,this._renderMode=t&&t.renderMode!==void 0?t.renderMode:Pn,this._atlas=t&&t.atlas!==void 0?t.atlas:null,this._frameKeys=t&&t.frameKeys!==void 0?t.frameKeys:null,this._meshes=[],this._updatingProperties=!1,this._meshesDirty=!1,this._atlas&&this._frameKeys&&this._createMeshes()}set frameKeys(e){this._frameKeys=e,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:frameKeys",e)}get frameKeys(){return this._frameKeys}set atlas(e){e!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),this._atlas=e,this._atlas&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",e))}get atlas(){return this._atlas}set pixelsPerUnit(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this.fire("set:pixelsPerUnit",e),this._atlas&&this._frameKeys&&this.renderMode===Pn&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}get pixelsPerUnit(){return this._pixelsPerUnit}set renderMode(e){if(this._renderMode===e)return;const t=this._renderMode;this._renderMode=e,this.fire("set:renderMode",e),(t===Pn||e===Pn)&&this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}get renderMode(){return this._renderMode}get meshes(){return this._meshes}_createMeshes(){const e=this._meshes.length;for(let i=0;i<e;i++){const n=this._meshes[i];n&&n.destroy()}const t=this._frameKeys.length;this._meshes=new Array(t);const s=this.renderMode===wt||this._renderMode===mt?this._create9SliceMesh:this._createSimpleMesh;for(let i=0;i<t;i++){const n=this._atlas.frames[this._frameKeys[i]];this._meshes[i]=n?s.call(this,n):null}this.fire("set:meshes")}_createSimpleMesh(e){const t=e.rect,s=this._atlas.texture.width,i=this._atlas.texture.height,n=t.z/this._pixelsPerUnit,a=t.w/this._pixelsPerUnit,o=e.pivot.x,l=e.pivot.y,c=[-o*n,-l*a,0,(1-o)*n,-l*a,0,(1-o)*n,(1-l)*a,0,-o*n,(1-l)*a,0],d=t.x/s,h=1-t.y/i,u=(t.x+t.z)/s,f=1-(t.y+t.w)/i,p=[d,h,u,h,u,f,d,f];return nn(this._device,c,{uvs:p,normals:qF,indices:KF})}_create9SliceMesh(){const e=M.ONE,t=3,s=3,i=[],n=[],a=[],o=[];let l=0;for(let d=0;d<=t;d++){const h=d===0||d===t?0:1;for(let u=0;u<=s;u++){const f=-e.x+2*e.x*(d<=1?0:3)/t,p=0,_=-(-e.y+2*e.y*(u<=1?0:3)/s),m=u===0||u===s?0:1;i.push(-f,p,_),n.push(0,1,0),a.push(h,m),d<t&&u<s&&(o.push(l+s+1,l+1,l),o.push(l+s+1,l+s+2,l+1)),l++}}const c={normals:n,uvs:a,indices:o};return nn(this._device,i,c)}_onSetFrames(e){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()}_onFrameChanged(e,t){const s=this._frameKeys.indexOf(e);s<0||(t?this.renderMode===Pn&&(this._meshes[s]=this._createSimpleMesh(t)):this._meshes[s]=null,this.fire("set:meshes"))}_onFrameRemoved(e){const t=this._frameKeys.indexOf(e);t<0||(this._meshes[t]=null,this.fire("set:meshes"))}startUpdate(){this._updatingProperties=!0,this._meshesDirty=!1}endUpdate(){this._updatingProperties=!1,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=!1}destroy(){for(const e of this._meshes)e&&e.destroy();this._meshes.length=0}}class sc extends ie{constructor(){super(),this._texture=null,this._frames=null}set texture(e){this._texture=e,this.fire("set:texture",e)}get texture(){return this._texture}set frames(e){this._frames=e,this.fire("set:frames",e)}get frames(){return this._frames}setFrame(e,t){let s=this._frames[e];s?(s.rect.copy(t.rect),s.pivot.copy(t.pivot),s.border.copy(t.border)):(s={rect:t.rect.clone(),pivot:t.pivot.clone(),border:t.border.clone()},this._frames[e]=s),this.fire("set:frame",e.toString(),s)}removeFrame(e){const t=this._frames[e];t&&(delete this._frames[e],this.fire("remove:frame",e.toString(),t))}destroy(){this._texture&&this._texture.destroy()}}class FS{constructor(e,t,s,i){this.time=e,this.position=t,this.rotation=s,this.scale=i}}class kS{constructor(){this._name="",this._keys=[]}}class Qa{constructor(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={}}getNode(e){return this._nodeDict[e]}addNode(e){this._nodes.push(e),this._nodeDict[e._name]=e}get nodes(){return this._nodes}}class YF{constructor(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new re,this._pos=new y,this._scale=new y,this._targetNode=null}getTarget(){return this._targetNode}setTarget(e){this._targetNode=e}}class Ki{constructor(e){this.looping=!0,this._animation=null,this._time=0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;const t=s=>{const i=new YF;i._name=s.name,this._interpolatedKeys.push(i),this._interpolatedKeyDict[s.name]=i,this._currKeyIndices[s.name]=0;for(let n=0;n<s._children.length;n++)t(s._children[n])};t(e)}set animation(e){this._animation=e,this.currentTime=0}get animation(){return this._animation}set currentTime(e){this._time=e;const t=this._interpolatedKeys.length;for(let s=0;s<t;s++){const n=this._interpolatedKeys[s]._name;this._currKeyIndices[n]=0}this.addTime(0),this.updateGraph()}get currentTime(){return this._time}get numNodes(){return this._interpolatedKeys.length}addTime(e){if(this._animation!==null){const t=this._animation._nodes,s=this._animation.duration;if(this._time===s&&!this.looping)return;if(this._time+=e,this._time>s){this._time=this.looping?0:s;for(let n=0;n<t.length;n++){const o=t[n]._name;this._currKeyIndices[o]=0}}else if(this._time<0){this._time=this.looping?s:0;for(let n=0;n<t.length;n++){const a=t[n],o=a._name;this._currKeyIndices[o]=a._keys.length-2}}const i=e>=0?1:-1;for(let n=0;n<t.length;n++){const a=t[n],o=a._name,l=a._keys,c=this._interpolatedKeyDict[o];if(c===void 0)continue;let d=!1;if(l.length!==1)for(let h=this._currKeyIndices[o];h<l.length-1&&h>=0;h+=i){const u=l[h],f=l[h+1];if(u.time<=this._time&&f.time>=this._time){const p=(this._time-u.time)/(f.time-u.time);c._pos.lerp(u.position,f.position,p),c._quat.slerp(u.rotation,f.rotation,p),c._scale.lerp(u.scale,f.scale,p),c._written=!0,this._currKeyIndices[o]=h,d=!0;break}}(l.length===1||!d&&this._time===0&&this.looping)&&(c._pos.copy(l[0].position),c._quat.copy(l[0].rotation),c._scale.copy(l[0].scale),c._written=!0)}}}blend(e,t,s){const i=this._interpolatedKeys.length;for(let n=0;n<i;n++){const a=e._interpolatedKeys[n],o=t._interpolatedKeys[n],l=this._interpolatedKeys[n];a._written&&o._written?(l._quat.slerp(a._quat,t._interpolatedKeys[n]._quat,s),l._pos.lerp(a._pos,t._interpolatedKeys[n]._pos,s),l._scale.lerp(a._scale,o._scale,s),l._written=!0):a._written?(l._quat.copy(a._quat),l._pos.copy(a._pos),l._scale.copy(a._scale),l._written=!0):o._written&&(l._quat.copy(o._quat),l._pos.copy(o._pos),l._scale.copy(o._scale),l._written=!0)}}setGraph(e){if(this.graph=e,e)for(let t=0;t<this._interpolatedKeys.length;t++){const s=this._interpolatedKeys[t],i=e.findByName(s._name);this._interpolatedKeys[t].setTarget(i)}else for(let t=0;t<this._interpolatedKeys.length;t++)this._interpolatedKeys[t].setTarget(null)}updateGraph(){if(this.graph)for(let e=0;e<this._interpolatedKeys.length;e++){const t=this._interpolatedKeys[e];if(t._written){const s=t.getTarget();s.localPosition.copy(t._pos),s.localRotation.copy(t._quat),s.localScale.copy(t._scale),s._dirtyLocal||s._dirtifyLocal(),t._written=!1}}}}new P;class i0 extends Hs{constructor(...e){super(...e),this._shader=null,this.quadRender=null,this.cullMode=Et,this.blendState=Xe.NOBLEND,this.depthState=kt.NODEPTH,this.stencilFront=null,this.stencilBack=null}set shader(e){var t,s;(t=this.quadRender)==null||t.destroy(),this.quadRender=null,(s=this._shader)==null||s.destroy(),this._shader=e,e&&(this.quadRender=new df(e))}get shader(){return this._shader}createQuadShader(e,t,s={}){return ks(this.device,i0.quadVertexShader,t,e,{aPosition:ht},s)}destroy(){var e;(e=this.shader)==null||e.destroy(),this.shader=null}execute(){const e=this.device;e.setBlendState(this.blendState),e.setCullMode(this.cullMode),e.setDepthState(this.depthState),e.setStencilState(this.stencilFront,this.stencilBack),this.quadRender.render()}}i0.quadVertexShader=`
				attribute vec2 aPosition;
				varying vec2 uv0;
				void main(void)
				{
						gl_Position = vec4(aPosition, 0.0, 1.0);
						uv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);
				}
		`;class ZF{constructor(e,t){this.processedCache=new Map,this.definitionsCache=new Map,this._generators=new Map,this._device=e,this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption=new Oc,this._defaultStdMatOptionMin=new Oc,t.shaderOptBuilder.updateRef(this._defaultStdMatOption,{},t,null,[],wd,null),t.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,{},t,null,Bb,null),e.on("destroy:shader",s=>{this.removeFromCache(s)})}destroy(){this.clearCache()}register(e,t){this._generators.has(e)||this._generators.set(e,t)}unregister(e){this._generators.has(e)&&this._generators.delete(e)}isRegistered(e){return this._generators.has(e)}generateShaderDefinition(e,t,s,i){let n=this.definitionsCache.get(s);if(!n){var a,o,l;let c;(a=i.litOptions)!=null&&a.lights&&(c=i.litOptions.lights,i.litOptions.lights=c.map(function(h){const u=h.clone?h.clone():h;return u.key=h.key,u})),this.storeNewProgram(t,i),(o=i.litOptions)!=null&&o.lights&&(i.litOptions.lights=c),this._precached;const d=this._device;n=e.createShaderDefinition(d,i),n.name=(l=n.name)!=null?l:i.pass?`${t}-pass:${i.pass}`:t,this.definitionsCache.set(s,n)}return n}getCachedShader(e){return this.processedCache.get(e)}setCachedShader(e,t){this.processedCache.set(e,t)}getProgram(e,t,s,i){const n=this._generators.get(e);if(!n)return null;const a=n.generateKey(t),o=Ec(a),l=s.generateKey(this._device),c=Ec(l),d=`${o}#${c}`;let h=this.getCachedShader(d);if(!h){const u=this.generateShaderDefinition(n,e,o,t);let f="",p;t.pass!==void 0&&(p=Ii.get(this._device).getByIndex(t.pass),f=`-${p.name}`),this._device.fire("shader:generate",{userMaterialId:i,shaderPassInfo:p,definition:u});const _={name:`${u.name}${f}-proc`,attributes:u.attributes,vshader:u.vshader,fshader:u.fshader,processingOptions:s,shaderLanguage:u.shaderLanguage};h=new Nn(this._device,_),this.setCachedShader(d,h)}return h}storeNewProgram(e,t){let s={};if(e==="standard"){const i=this._getDefaultStdMatOptions(t.pass);for(const n in t)(t.hasOwnProperty(n)&&i[n]!==t[n]||n==="pass")&&(s[n]=t[n]);for(const n in t.litOptions)s[n]=t.litOptions[n]}else s=t;this._programsCollection.push(JSON.stringify({name:e,options:s}))}dumpPrograms(){let e=`let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;
`;e+="let shaders = [",this._programsCollection[0]&&(e+=`
	`+this._programsCollection[0]);for(let s=1;s<this._programsCollection.length;++s)e+=`,
	`+this._programsCollection[s];e+=`
];
`,e+=`device.getProgramLibrary().precompile(shaders);
`,e+='if (pc.version != "'+rA+'" || pc.revision != "'+aA+`")
`,e+='	console.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';const t=document.createElement("a");t.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),t.setAttribute("download","precompile-shaders.js"),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}clearCache(){this._isClearingCache=!0,this.processedCache.forEach(e=>{e.destroy()}),this.processedCache.clear(),this._isClearingCache=!1}removeFromCache(e){this._isClearingCache||this.processedCache.forEach((t,s)=>{e===t&&this.processedCache.delete(s)})}_getDefaultStdMatOptions(e){const t=Ii.get(this._device).getByIndex(e);return e===Xi||e===bd||e===hf||t.isShadow?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(e){if(e){const t=new Array(e.length);for(let s=0;s<e.length;s++){if(e[s].name==="standard"){const i=e[s].options,n=this._getDefaultStdMatOptions(i.pass);for(const a in n)n.hasOwnProperty(a)&&i[a]===void 0&&(i[a]=n[a])}t[s]=this.getProgram(e[s].name,e[s].options)}}this._precached=!0}}var JF=`
	vec4 dirLm = texture2D(texture_dirLightMap, vUv1);
	if (bakeDir > 0.5) {
		if (dAtten > 0.00001) {
			dirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);
			dAtten = saturate(dAtten);
			gl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);
			gl_FragColor.a = dirLm.w + dAtten;
			gl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);
		} else {
			gl_FragColor = dirLm;
		}
	} else {
		gl_FragColor.rgb = dirLm.xyz;
		gl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);
	}
`,QF=`
#ifdef LIGHTMAP_RGBM
	gl_FragColor.rgb = dDiffuseLight;
	gl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));
	gl_FragColor.rgb /= 8.0;
	gl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );
	gl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;
	gl_FragColor.rgb /= gl_FragColor.a;
#else
	gl_FragColor = vec4(dDiffuseLight, 1.0);
#endif
`,ek=`
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
void main(void) {
	vec4 c = texture2DLodEXT(source, vUv0, 0.0);
	c = c.a>0.0? c : texture2DLodEXT(source, vUv0 - pixelOffset, 0.0);
	c = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(0, -pixelOffset.y), 0.0);
	c = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y), 0.0);
	c = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(-pixelOffset.x, 0), 0.0);
	c = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(pixelOffset.x, 0), 0.0);
	c = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y), 0.0);
	c = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(0, pixelOffset.y), 0.0);
	c = c.a>0.0? c : texture2DLodEXT(source, vUv0 + pixelOffset, 0.0);
	gl_FragColor = c;
}
`,tk=`
float normpdf3(in vec3 v, in float sigma) {
	return 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;
}
vec3 decodeRGBM(vec4 rgbm) {
	vec3 color = (8.0 * rgbm.a) * rgbm.rgb;
	return color * color;
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec4 encodeRGBM(vec3 color) {
	vec4 encoded;
	encoded.rgb = pow(color.rgb, vec3(0.5));
	encoded.rgb *= 1.0 / 8.0;
	encoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );
	encoded.a = ceil(encoded.a * 255.0) / 255.0;
	encoded.rgb /= encoded.a;
	return encoded;
}
#define MSIZE 15
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
uniform vec2 sigmas;
uniform float bZnorm;
uniform float kernel[MSIZE];
void main(void) {
	
	vec4 pixelRgbm = texture2DLodEXT(source, vUv0, 0.0);
	if (pixelRgbm.a <= 0.0) {
		gl_FragColor = pixelRgbm;
		return ;
	}
	float sigma = sigmas.x;
	float bSigma = sigmas.y;
	vec3 pixelHdr = decodeRGBM(pixelRgbm);
	vec3 accumulatedHdr = vec3(0.0);
	float accumulatedFactor = 0.0;
	const int kSize = (MSIZE-1)/2;
	for (int i = -kSize; i <= kSize; ++i) {
		for (int j = -kSize; j <= kSize; ++j) {
			
			vec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;
			vec4 rgbm = texture2DLodEXT(source, coord, 0.0);
			if (rgbm.a > 0.0) {
				vec3 hdr = decodeRGBM(rgbm);
				float factor = kernel[kSize + j] * kernel[kSize + i];
				factor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;
				accumulatedHdr += factor * hdr;
				accumulatedFactor += factor;
			}
		}
	}
	gl_FragColor = encodeRGBM(accumulatedHdr / accumulatedFactor);
}
`;const ff={bakeDirLmEndPS:JF,bakeLmEndPS:QF,dilatePS:ek,bilateralDeNoisePS:tk},rr=new y,ar=new q,Io=new re,BS=new re,Qm=new Re,NS=new Re,Qe=[new y,new y,new y,new y,new y,new y,new y,new y],sk=[Qe[0],Qe[1],Qe[1],Qe[3],Qe[3],Qe[2],Qe[2],Qe[0],Qe[4],Qe[5],Qe[5],Qe[7],Qe[7],Qe[6],Qe[6],Qe[4],Qe[0],Qe[4],Qe[1],Qe[5],Qe[2],Qe[6],Qe[3],Qe[7]],ik=new k(1,1,0,.4),US=(r,e)=>{const t=e.x,s=e.y,i=e.z,n=Math.sqrt(e.rx*e.rx+e.ry*e.ry+e.rz*e.rz+e.rw*e.rw),a=e.rx/n,o=e.ry/n,l=e.rz/n,c=e.rw/n;r.data.set([1-2*(l*l+c*c),2*(o*l+a*c),2*(o*c-a*l),0,2*(o*l-a*c),1-2*(o*o+c*c),2*(l*c+a*o),0,2*(o*c+a*l),2*(l*c-a*o),1-2*(o*o+l*l),0,t,s,i,1])};class ic{constructor(e,t=!0){this.elements=void 0,this.vertexElement=void 0,this.elements=e,this.vertexElement=e.find(s=>s.name==="vertex"),!this.isCompressed&&t&&(ar.setScale(-1,-1,1),this.transform(ar))}get numSplats(){return this.vertexElement.count}static calcSplatAabb(e,t){US(ar,t),Qm.center.set(0,0,0),Qm.halfExtents.set(t.sx*2,t.sy*2,t.sz*2),e.setFromTransformedAabb(Qm,ar)}transform(e){const t=this.getProp("x"),s=this.getProp("y"),i=this.getProp("z"),n=this.getProp("rot_0"),a=this.getProp("rot_1"),o=this.getProp("rot_2"),l=this.getProp("rot_3");BS.setFromMat4(e);for(let c=0;c<this.numSplats;++c)rr.set(t[c],s[c],i[c]),e.transformPoint(rr,rr),t[c]=rr.x,s[c]=rr.y,i[c]=rr.z,Io.set(a[c],o[c],l[c],n[c]).mul2(BS,Io),n[c]=Io.w,a[c]=Io.x,o[c]=Io.y,l[c]=Io.z}getProp(e){var t;return(t=this.vertexElement.properties.find(s=>s.name===e&&s.storage))==null?void 0:t.storage}addProp(e,t){this.vertexElement.properties.push({type:"float",name:e,storage:t,byteSize:4})}calcAabb(e,t){const s=this.getProp("x"),i=this.getProp("y"),n=this.getProp("z"),a=this.getProp("rot_0"),o=this.getProp("rot_1"),l=this.getProp("rot_2"),c=this.getProp("rot_3"),d=this.getProp("scale_0"),h=this.getProp("scale_1"),u=this.getProp("scale_2"),f={x:0,y:0,z:0,rx:0,ry:0,rz:0,rw:0,sx:0,sy:0,sz:0};let p=!0;for(let _=0;_<this.numSplats;++_)t&&!t(_)||(f.x=s[_],f.y=i[_],f.z=n[_],f.rx=a[_],f.ry=o[_],f.rz=l[_],f.rw=c[_],f.sx=Math.exp(d[_]),f.sy=Math.exp(h[_]),f.sz=Math.exp(u[_]),p?(p=!1,ic.calcSplatAabb(e,f)):(ic.calcSplatAabb(NS,f),e.add(NS)));return!p}calcFocalPoint(e,t){const s=this.getProp("x"),i=this.getProp("y"),n=this.getProp("z"),a=this.getProp("scale_0"),o=this.getProp("scale_1"),l=this.getProp("scale_2");e.x=0,e.y=0,e.z=0;let c=0;for(let d=0;d<this.numSplats;++d){if(t&&!t(d))continue;const h=1/(1+Math.exp(Math.max(a[d],o[d],l[d])));e.x+=s[d]*h,e.y+=i[d]*h,e.z+=n[d]*h,c+=h}e.mulScalar(1/c)}renderWireframeBounds(e,t){const s=this.getProp("x"),i=this.getProp("y"),n=this.getProp("z"),a=this.getProp("rot_0"),o=this.getProp("rot_1"),l=this.getProp("rot_2"),c=this.getProp("rot_3"),d=this.getProp("scale_0"),h=this.getProp("scale_1"),u=this.getProp("scale_2"),f={x:0,y:0,z:0,rx:0,ry:0,rz:0,rw:0,sx:0,sy:0,sz:0};for(let p=0;p<this.numSplats;++p){f.x=s[p],f.y=i[p],f.z=n[p],f.rx=a[p],f.ry=o[p],f.rz=l[p],f.rw=c[p],f.sx=Math.exp(d[p]),f.sy=Math.exp(h[p]),f.sz=Math.exp(u[p]),US(ar,f),ar.mul2(t,ar);for(let _=0;_<8;++_)rr.set(f.sx*2*(_&1?1:-1),f.sy*2*(_&2?1:-1),f.sz*2*(_&4?1:-1)),ar.transformPoint(rr,Qe[_]);e.drawLineArrays(sk,ik)}}get isCompressed(){return this.elements.some(e=>e.name==="chunk")&&["packed_position","packed_rotation","packed_scale","packed_color"].every(e=>this.getProp(e))}decompress(){const e=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","rot_0","rot_1","rot_2","rot_3","scale_0","scale_1","scale_2"],t=this.elements.find(F=>F.name==="chunk"),s=this.vertexElement,i={};e.forEach(F=>{i[F]=new Float32Array(s.count)});const n=F=>{var D;return(D=t.properties.find(A=>A.name===F&&A.storage))==null?void 0:D.storage},a=n("min_x"),o=n("min_y"),l=n("min_z"),c=n("max_x"),d=n("max_y"),h=n("max_z"),u=n("min_scale_x"),f=n("min_scale_y"),p=n("min_scale_z"),_=n("max_scale_x"),m=n("max_scale_y"),g=n("max_scale_z"),v=this.getProp("packed_position"),x=this.getProp("packed_rotation"),S=this.getProp("packed_scale"),w=this.getProp("packed_color"),T=(F,D)=>{const A=(1<<D)-1;return(F&A)/A},b=(F,D)=>{F.x=T(D>>>21,11),F.y=T(D>>>11,10),F.z=T(D,11)},C=(F,D)=>{F.x=T(D>>>24,8),F.y=T(D>>>16,8),F.z=T(D>>>8,8),F.w=T(D,8)},E=(F,D)=>{const A=1/(Math.sqrt(2)*.5),N=(T(D>>>20,10)-.5)*A,U=(T(D>>>10,10)-.5)*A,G=(T(D,10)-.5)*A,X=Math.sqrt(1-(N*N+U*U+G*G));switch(D>>>30){case 0:F.set(X,N,U,G);break;case 1:F.set(N,X,U,G);break;case 2:F.set(N,U,X,G);break;case 3:F.set(N,U,G,X);break}},R=(F,D,A)=>F*(1-A)+D*A,B=new y,L=new re,V=new y,I=new P;for(let F=0;F<s.count;++F){const D=Math.floor(F/256);b(B,v[F]),E(L,x[F]),b(V,S[F]),C(I,w[F]),i.x[F]=R(a[D],c[D],B.x),i.y[F]=R(o[D],d[D],B.y),i.z[F]=R(l[D],h[D],B.z),i.rot_0[F]=L.x,i.rot_1[F]=L.y,i.rot_2[F]=L.z,i.rot_3[F]=L.w,i.scale_0[F]=R(u[D],_[D],V.x),i.scale_1[F]=R(f[D],m[D],V.y),i.scale_2[F]=R(p[D],g[D],V.z);const A=.28209479177387814;i.f_dc_0[F]=(I.x-.5)/A,i.f_dc_1[F]=(I.y-.5)/A,i.f_dc_2[F]=(I.z-.5)/A,i.opacity[F]=-Math.log(1/I.w-1)}return new ic([{name:"vertex",count:s.count,properties:e.map(F=>({name:F,type:"float",byteSize:4,storage:i[F]}))}],!1)}}const nk=new y,rk=new y,ak=new y,wh=new y,bh=new y,Th=new y,zS=new y,VS=new y;class ok{constructor(e,t,s){if(this.device=void 0,this.numSplats=void 0,this.vertexFormat=void 0,this.halfFormat=void 0,this.colorTexture=void 0,this.transformATexture=void 0,this.transformBTexture=void 0,this.transformCTexture=void 0,this.centers=void 0,this.aabb=void 0,this.device=e,this.numSplats=t,this.aabb=s,this.vertexFormat=new os(e,[{semantic:Da,components:1,type:e.isWebGL1?Me:Ql,asInt:!e.isWebGL1}]),this.halfFormat=this.getTextureFormat(e,!0),this.halfFormat!==void 0){const i=this.evalTextureSize(t);this.colorTexture=this.createTexture(e,"splatColor",xe,i),this.transformATexture=this.createTexture(e,"transformA",this.halfFormat?yt:rt,i),this.transformBTexture=this.createTexture(e,"transformB",this.halfFormat?yt:rt,i),this.transformCTexture=this.createTexture(e,"transformC",this.halfFormat?id:Bn,i)}}destroy(){var e,t,s,i;(e=this.colorTexture)==null||e.destroy(),(t=this.transformATexture)==null||t.destroy(),(s=this.transformBTexture)==null||s.destroy(),(i=this.transformCTexture)==null||i.destroy()}setupMaterial(e){if(this.colorTexture){e.setParameter("splatColor",this.colorTexture),e.setParameter("transformA",this.transformATexture),e.setParameter("transformB",this.transformBTexture),e.setParameter("transformC",this.transformCTexture);const{width:t,height:s}=this.colorTexture;e.setParameter("tex_params",new Float32Array([t,s,1/t,1/s]))}}evalTextureSize(e){const t=Math.ceil(Math.sqrt(e)),s=Math.ceil(e/t);return new M(t,s)}createTexture(e,t,s,i){return new _e(e,{name:t,width:i.x,height:i.y,format:s,cubemap:!1,mipmaps:!1,minFilter:Ee,magFilter:Ee,addressU:ae,addressV:ae})}getTextureFormat(e,t){e.isWebGL1&&(t=!1);const s=e.extTextureHalfFloat&&e.textureHalfFloatUpdatable,i=e.extTextureFloat;let n;return t?i?n=!1:s&&(n=!0):s?n=!0:i&&(n=!1),n}updateColorData(e,t,s,i){const n=.28209479177387814,a=this.colorTexture;if(!a)return;const o=a.lock(),l=c=>{if(c>0)return 1/(1+Math.exp(-c));const d=Math.exp(c);return d/(1+d)};for(let c=0;c<this.numSplats;++c)e&&t&&s&&(o[c*4+0]=H.clamp((.5+n*e[c])*255,0,255),o[c*4+1]=H.clamp((.5+n*t[c])*255,0,255),o[c*4+2]=H.clamp((.5+n*s[c])*255,0,255)),o[c*4+3]=i?H.clamp(l(i[c])*255,0,255):255;a.unlock()}updateTransformData(e,t,s,i,n,a,o,l,c,d){const{halfFormat:h}=this,u=Ke.float2Half;if(!this.transformATexture)return;const f=this.transformATexture.lock(),p=this.transformBTexture.lock(),_=this.transformCTexture.lock(),m=new re,g=new hi,v=new y,x=new y;for(let S=0;S<this.numSplats;S++)m.set(i[S],n[S],a[S],o[S]).normalize(),m.w<0&&m.conjugate(),VS.set(m.x,m.y,m.z),this.quatToMat3(VS,g),zS.set(Math.exp(l[S]),Math.exp(c[S]),Math.exp(d[S])),this.computeCov3d(g,zS,v,x),h?(f[S*4+0]=u(e[S]),f[S*4+1]=u(t[S]),f[S*4+2]=u(s[S]),f[S*4+3]=u(x.x),p[S*4+0]=u(v.x),p[S*4+1]=u(v.y),p[S*4+2]=u(v.z),p[S*4+3]=u(x.y),_[S]=u(x.z)):(f[S*4+0]=e[S],f[S*4+1]=t[S],f[S*4+2]=s[S],f[S*4+3]=x.x,p[S*4+0]=v.x,p[S*4+1]=v.y,p[S*4+2]=v.z,p[S*4+3]=x.y,_[S]=x.z);this.transformATexture.unlock(),this.transformBTexture.unlock(),this.transformCTexture.unlock()}quatToMat3(e,t){const s=e.x,i=e.y,n=e.z,a=Math.sqrt(1-e.dot(e)),o=t.data;o[0]=1-2*(n*n+a*a),o[1]=2*(i*n+s*a),o[2]=2*(i*a-s*n),o[3]=2*(i*n-s*a),o[4]=1-2*(i*i+a*a),o[5]=2*(n*a+s*i),o[6]=2*(i*a+s*n),o[7]=2*(n*a-s*i),o[8]=1-2*(i*i+n*n)}computeCov3d(e,t,s,i){const n=e.getX(nk).mulScalar(t.x),a=e.getY(rk).mulScalar(t.y),o=e.getZ(ak).mulScalar(t.z);wh.set(n.x,a.x,o.x),bh.set(n.y,a.y,o.y),Th.set(n.z,a.z,o.z),s.set(wh.dot(wh),wh.dot(bh),wh.dot(Th)),i.set(bh.dot(bh),bh.dot(Th),Th.dot(Th))}}const lk=`
		attribute vec3 vertex_position;

		uniform mat4 matrix_model;
		uniform mat4 matrix_view;
		uniform mat4 matrix_projection;
		uniform mat4 matrix_viewProjection;

		uniform vec2 viewport;

		varying vec2 texCoord;
		varying vec4 color;
		varying float id;

		#ifndef GL2
		#ifndef WEBGPU
		mat3 transpose(in mat3 m) {
				return mat3(
						m[0].x, m[1].x, m[2].x,
						m[0].y, m[1].y, m[2].y,
						m[0].z, m[1].z, m[2].z
				);
		}
		#endif
		#endif

		uniform vec4 tex_params;
		uniform sampler2D splatColor;

		uniform highp sampler2D transformA;
		uniform highp sampler2D transformB;
		uniform highp sampler2D transformC;

		vec3 center;
		vec3 covA;
		vec3 covB;

		#ifdef INT_INDICES

				attribute uint vertex_id;
				ivec2 dataUV;
				void evalDataUV() {

						// turn vertex_id into int grid coordinates
						ivec2 textureSize = ivec2(tex_params.xy);
						vec2 invTextureSize = tex_params.zw;

						int gridV = int(float(vertex_id) * invTextureSize.x);
						int gridU = int(vertex_id) - gridV * textureSize.x;
						dataUV = ivec2(gridU, gridV);
				}

				vec4 getColor() {
						return texelFetch(splatColor, dataUV, 0);
				}

				void getTransform() {
						vec4 tA = texelFetch(transformA, dataUV, 0);
						vec4 tB = texelFetch(transformB, dataUV, 0);
						vec4 tC = texelFetch(transformC, dataUV, 0);

						center = tA.xyz;
						covA = tB.xyz;
						covB = vec3(tA.w, tB.w, tC.x);
				}

		#else

				// TODO: use texture2DLodEXT on WebGL

				attribute float vertex_id;
				vec2 dataUV;
				void evalDataUV() {
						vec2 textureSize = tex_params.xy;
						vec2 invTextureSize = tex_params.zw;

						// turn vertex_id into int grid coordinates
						float gridV = floor(vertex_id * invTextureSize.x);
						float gridU = vertex_id - (gridV * textureSize.x);

						// convert grid coordinates to uv coordinates with half pixel offset
						dataUV = vec2(gridU, gridV) * invTextureSize + (0.5 * invTextureSize);
				}

				vec4 getColor() {
						return texture2D(splatColor, dataUV);
				}

				void getTransform() {
						vec4 tA = texture2D(transformA, dataUV);
						vec4 tB = texture2D(transformB, dataUV);
						vec4 tC = texture2D(transformC, dataUV);

						center = tA.xyz;
						covA = tB.xyz;
						covB = vec3(tA.w, tB.w, tC.x);
				}

		#endif

		vec3 evalCenter() {
				evalDataUV();

				// get data
				getTransform();

				return center;
		}

		vec4 evalSplat(vec4 centerWorld)
		{
				vec4 splat_cam = matrix_view * centerWorld;
				vec4 splat_proj = matrix_projection * splat_cam;

				// cull behind camera
				if (splat_proj.z < -splat_proj.w) {
						return vec4(0.0, 0.0, 2.0, 1.0);
				}

				color = getColor();

				mat3 Vrk = mat3(
						covA.x, covA.y, covA.z, 
						covA.y, covB.x, covB.y,
						covA.z, covB.y, covB.z
				);

				float focal = viewport.x * matrix_projection[0][0];

				float J1 = focal / splat_cam.z;
				vec2 J2 = -J1 / splat_cam.z * splat_cam.xy;
				mat3 J = mat3(
						J1, 0., J2.x, 
						0., J1, J2.y, 
						0., 0., 0.
				);

				mat3 W = transpose(mat3(matrix_view) * mat3(matrix_model));

				mat3 T = W * J;
				mat3 cov = transpose(T) * Vrk * T;

				float diagonal1 = cov[0][0] + 0.3;
				float offDiagonal = cov[0][1];
				float diagonal2 = cov[1][1] + 0.3;

				float mid = 0.5 * (diagonal1 + diagonal2);
				float radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));
				float lambda1 = mid + radius;
				float lambda2 = max(mid - radius, 0.1);
				vec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));
				vec2 v1 = min(sqrt(2.0 * lambda1), 1024.0) * diagonalVector;
				vec2 v2 = min(sqrt(2.0 * lambda2), 1024.0) * vec2(diagonalVector.y, -diagonalVector.x);

				// early out tiny splats
				// TODO: figure out length units and expose as uniform parameter
				// TODO: perhaps make this a shader compile-time option
				if (dot(v1, v1) < 4.0 && dot(v2, v2) < 4.0) {
						return vec4(0.0, 0.0, 2.0, 1.0);
				}

				texCoord = vertex_position.xy * 2.0;

				splat_proj.xy += (texCoord.x * v1 + texCoord.y * v2) / viewport * splat_proj.w;
				return splat_proj;

				id = float(vertex_id);
		}
`,hk=`
		varying vec2 texCoord;
		varying vec4 color;
		varying float id;

		#ifdef PICK_PASS
				uniform vec4 uColor;
		#endif

		vec4 evalSplat() {

				#ifdef DEBUG_RENDER

						if (color.a < 0.2) discard;
						return color;

				#else

						float A = -dot(texCoord, texCoord);
						if (A < -4.0) discard;
						float B = exp(A) * color.a;

						#ifdef PICK_PASS
								if (B < 0.3) discard;
								return(uColor);
						#endif

						#ifndef DITHER_NONE
								opacityDither(B, id * 0.013);
						#endif

						// the color here is in gamma space, so bring it to linear
						vec3 diffuse = decodeGamma(color.rgb);

						// apply tone-mapping and gamma correction as needed
						diffuse = toneMap(diffuse);
						diffuse = gammaCorrectOutput(diffuse);

						return vec4(diffuse, B);

				#endif
		}
`;class ck{generateKey(e){const t=Ec(e.vertex),s=Ec(e.fragment);return`splat-${e.pass}-${e.gamma}-${e.toneMapping}-${t}-${s}-${e.debugRender}-${e.dither}}`}createShaderDefinition(e,t){const n=Ii.get(e).getByIndex(t.pass).shaderDefines+(t.debugRender?`#define DEBUG_RENDER
`:"")+(e.isWebGL1?"":`#define INT_INDICES
`)+`#define DITHER_${t.dither.toUpperCase()}
`,a=n+lk+t.vertex,o=n+W.decodePS+(t.dither===gs?"":W.bayerPS+W.opacityDitherPS)+Be.tonemapCode(t.toneMapping)+Be.gammaCode(t.gamma)+hk+t.fragment;return Mt.createDefinition(e,{name:"SplatShader",attributes:{vertex_position:ht,vertex_id:Da},vertexCode:a,fragmentCode:o})}}const dk=new ck,uk=`
		void main(void)
		{
				vec3 centerLocal = evalCenter();
				vec4 centerWorld = matrix_model * vec4(centerLocal, 1.0);

				gl_Position = evalSplat(centerWorld);
		}
`,fk=`
		void main(void)
		{
				gl_FragColor = evalSplat();
		}
`,pk=(r={})=>{var e;const{debugRender:t}=r,s=(e=r.dither)!=null?e:gs,i=s!==gs,n=new Jt;return n.name="splatMaterial",n.cull=t?Dr:Et,n.blendType=i?ms:Bt,n.depthWrite=i,n.getShaderVariant=function(a,o,l,c,d,h,u,f){var p,_;const m={pass:d,gamma:d===sn?o.gammaCorrection?Sd:vd:o.gammaCorrection,toneMapping:d===sn?xd:o.toneMapping,vertex:(p=r.vertex)!=null?p:uk,fragment:(_=r.fragment)!=null?_:fk,debugRender:t,dither:s},g=new lo(u,f),v=cn(a);return v.register("splat",dk),v.getProgram("splat",m,g)},n.update(),n};function mk(){let t,s,i,n,a;const o={x:0,y:0,z:0},l={x:0,y:0,z:0},c={x:0,y:0,z:0},d={x:0,y:0,z:0};let h,u,f,p;const _=()=>{var m;if(!s||!t||!i||!n)return;const g=i.x,v=i.y,x=i.z,S=n.x,w=n.y,T=n.z,b=.001;if(Math.abs(g-o.x)<b&&Math.abs(v-o.y)<b&&Math.abs(x-o.z)<b&&Math.abs(S-l.x)<b&&Math.abs(w-l.y)<b&&Math.abs(T-l.z)<b)return;o.x=g,o.y=v,o.z=x,l.x=S,l.y=w,l.z=T;const C=s.length/3;((m=h)==null?void 0:m.length)!==C&&(h=new Uint32Array(C),u=new Uint32Array(C),f=new Float32Array(C));let E,R;for(let D=0;D<8;++D){const A=D&1?c.x:d.x,N=D&2?c.y:d.y,U=D&4?c.z:d.z,G=(A-g)*S+(N-v)*w+(U-x)*T;D===0?E=R=G:(E=Math.min(E,G),R=Math.max(R,G))}p||(p=new Uint32Array(65537));for(let D=0;D<65537;D++)p[D]=0;const L=1/(R-E)*2**16;for(let D=0;D<C;++D){const A=D*3,N=(s[A+0]-g)*S+(s[A+1]-v)*w+(s[A+2]-x)*T,U=Math.floor((N-E)*L);h[D]=U,u[D]=D,p[U]++}for(let D=1;D<65537;D++)p[D]+=p[D-1];const V=a?new Uint32Array(f.buffer):f,I=a?0:.2;for(let D=C-1;D>=0;D--){const A=h[D],N=u[D];V[p[A]-1]=N+I,p[A]--}const F=t;t=f,f=F,self.postMessage({data:t.buffer},[t.buffer]),t=null};self.onmessage=m=>{if(m.data.data&&(t=new Float32Array(m.data.data)),m.data.centers){s=new Float32Array(m.data.centers),c.x=d.x=s[0],c.y=d.y=s[1],c.z=d.z=s[2];const g=s.length/3;for(let v=1;v<g;++v){const x=s[v*3+0],S=s[v*3+1],w=s[v*3+2];c.x=Math.min(c.x,x),c.y=Math.min(c.y,S),c.z=Math.min(c.z,w),d.x=Math.max(d.x,x),d.y=Math.max(d.y,S),d.z=Math.max(d.z,w)}}m.data.intIndices&&(a=m.data.intIndices),m.data.cameraPosition&&(i=m.data.cameraPosition),m.data.cameraDirection&&(n=m.data.cameraDirection),_()}}class _k extends ie{constructor(){super(),this.worker=void 0,this.vertexBuffer=void 0,this.worker=new Worker(URL.createObjectURL(new Blob([`(${mk.toString()})()`],{type:"application/javascript"}))),this.worker.onmessage=e=>{const t=e.data.data,s=this.vertexBuffer.storage;this.worker.postMessage({data:s},[s]),setTimeout(()=>{this.vertexBuffer.setData(t),this.fire("updated")})}}destroy(){this.worker.terminate(),this.worker=null}init(e,t,s){this.vertexBuffer=e;const i=e.storage.slice(0);this.worker.postMessage({data:i,centers:t.buffer,intIndices:s},[i,t.buffer])}setCamera(e,t){this.worker.postMessage({cameraPosition:{x:e.x,y:e.y,z:e.z},cameraDirection:{x:t.x,y:t.y,z:t.z}})}}const gk=new q,Ro=new y,Lo=new y,e_=[0,0];class n0{constructor(e,t){this.splat=void 0,this.mesh=void 0,this.meshInstance=void 0,this.material=void 0,this.vb=void 0,this.options={},this.sorter=null,this.lastCameraPosition=new y,this.lastCameraDirection=new y,this.cameras=[],this.splat=e,t=Object.assign(this.options,t);const s=t.debugRender;this.createMaterial(t);const i=e.device;s?this.mesh=cf(i,{halfExtents:new y(1,1,1)}):(this.mesh=new Vs(i),this.mesh.setPositions(new Float32Array([-1,-1,1,-1,1,1,-1,-1,1,1,-1,1]),2),this.mesh.update()),this.mesh.aabb.copy(e.aabb);const n=e.numSplats;let a;if(i.isWebGL1){a=new Float32Array(n);for(let l=0;l<n;++l)a[l]=l+.2}else{a=new Uint32Array(n);for(let l=0;l<n;++l)a[l]=l}const o=new Mi(i,e.vertexFormat,n,Pl,a.buffer);this.vb=o,this.meshInstance=new Fe(this.mesh,this.material),this.meshInstance.setInstancing(o,!0),this.meshInstance.gsplatInstance=this,this.centers=new Float32Array(e.centers),(!t.dither||t.dither===gs)&&(this.sorter=new _k,this.sorter.init(this.vb,this.centers,!this.splat.device.isWebGL1))}destroy(){var e;this.material.destroy(),this.vb.destroy(),this.meshInstance.destroy(),(e=this.sorter)==null||e.destroy()}clone(){return new n0(this.splat,this.options)}createMaterial(e){this.material=pk(e),this.splat.setupMaterial(this.material),this.meshInstance&&(this.meshInstance.material=this.material)}updateViewport(){const e=this.splat.device;e_[0]=e.width,e_[1]=e.height,this.material.setParameter("viewport",e_)}sort(e){if(this.sorter){const t=e.getWorldTransform();t.getTranslation(Ro),t.getZ(Lo);const s=this.meshInstance.node.getWorldTransform(),i=gk.invert(s);i.transformPoint(Ro,Ro),i.transformVector(Lo,Lo),(!Ro.equalsApprox(this.lastCameraPosition)||!Lo.equalsApprox(this.lastCameraDirection))&&(this.lastCameraPosition.copy(Ro),this.lastCameraDirection.copy(Lo),this.sorter.setCamera(Ro,Lo))}this.updateViewport()}update(){if(this.cameras.length>0){const e=this.cameras[0];this.sort(e._node),this.cameras.length=0}}}const yk="NONE",vk="FILL_WINDOW",GS="KEEP_ASPECT",pg="AUTO",Sk="FIXED";let tT;function Ai(){return tT}function mg(r){tT=r}class ii{static push(e,t){t&&ii._types.length>0?console.assert("Script Ordering Error. Contact support@playcanvas.com"):ii._types.push(e)}}ii._types=[];let pf=!1,HS=!1;const ns={app:null,create(r,e){if(!pf)return;const t=e(ns.app);t._pcScriptName=r,ii.push(t,pf),this.fire("created",r,e)},attribute(r,e,t,s){},createLoadingScreen(r){if(HS)return;HS=!0;const e=Ai();r(e)}};Object.defineProperty(ns,"legacy",{get:function(){return pf},set:function(r){pf=r}});oy.attach(ns);class xk{constructor(){this.renderPasses=[],this.renderTargetMap=new Map}addRenderPass(e){e.frameUpdate();const t=e.beforePasses;for(let i=0;i<t.length;i++){const n=t[i];n.enabled&&this.addRenderPass(n)}e.enabled&&this.renderPasses.push(e);const s=e.afterPasses;for(let i=0;i<s.length;i++){const n=s[i];n.enabled&&this.addRenderPass(n)}}reset(){this.renderPasses.length=0}compile(){const e=this.renderTargetMap,t=this.renderPasses;for(let n=0;n<t.length;n++){const a=t[n],o=a.renderTarget;if(o!==void 0){const l=e.get(o);if(l){const c=a.colorArrayOps.length;for(let d=0;d<c;d++)a.colorArrayOps[d].clear||(l.colorArrayOps[d].store=!0);a.depthStencilOps.clearDepth||(l.depthStencilOps.storeDepth=!0),a.depthStencilOps.clearStencil||(l.depthStencilOps.storeStencil=!0)}e.set(o,a)}}let s=null,i=null;for(let n=0;n<t.length;n++){const a=t[n],o=a.renderTarget,l=o==null?void 0:o.colorBuffer;if(l!=null&&l.cubemap){if(s===l){const c=i.colorArrayOps.length;for(let d=0;d<c;d++)i.colorArrayOps[d].mipmaps=!1}s=o.colorBuffer,i=a}else a.requiresCubemaps&&(s=null,i=null)}e.clear()}render(e){this.compile();const t=this.renderPasses;for(let s=0;s<t.length;s++)t[s].render()}}class wk{constructor(e,t){this.texture0=e,this.texture1=t}destroy(){var e,t;(e=this.texture0)==null||e.destroy(),(t=this.texture1)==null||t.destroy()}}const WS=new di;class Ca{static createTexture(e,t,s,i=""){return new _e(e,{name:`AreaLightLUT${i}`,width:s,height:s,format:t,addressU:ae,addressV:ae,type:ps,magFilter:nt,minFilter:Ee,anisotropy:1,mipmaps:!1})}static applyTextures(e,t,s){WS.remove(e),WS.get(e,()=>new wk(t,t===s?null:s)),e.scope.resolve("areaLightsLutTex1").setValue(t),e.scope.resolve("areaLightsLutTex2").setValue(s)}static createPlaceholder(e){const t=Ca.createTexture(e,e.areaLightLutFormat,2,"placeholder");t.lock().fill(0),t.unlock(),Ca.applyTextures(e,t,t)}static set(e,t,s){function i(_,m,g){const v=Ca.createTexture(_,g,64);return v.lock().set(m),v.unlock(),v}function n(_,m,g){const v=_.length,x=new Float32Array(v);for(let S=0;S<v;S++){const w=S%4;x[S]=(_[S]+m[w])*g[w]}return x}function a(_){const m=_.length,g=new Uint16Array(m),v=Ke.float2Half;for(let x=0;x<m;x++)g[x]=v(_[x]);return g}function o(_){const m=_.length,g=new Uint8ClampedArray(m);for(let v=0;v<m;v++)g[v]=_[v]*255;return g}const l=t,c=s;let d,h;const u=e.areaLightLutFormat;if(u===rt)d=l,h=c;else if(u===yt)d=a(l),h=a(c);else{const _=[0,.2976,.01381,0],m=[.999,3.08737,1.6546,.603249],g=[-.306897,0,0,0],v=[1.442787,1,1,1];d=o(n(l,_,m)),h=o(n(c,g,v))}const f=i(e,d,u),p=i(e,h,u);Ca.applyTextures(e,f,p)}}const mf="en-US",_f={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},r0={};function $r(r,e){for(let t=0,s=r.length;t<s;t++)r0[r[t]]=e}function xn(r){const e=r.indexOf("-");return e!==-1?r.substring(0,e):r}function bk(r,e){const t=r.indexOf("-");return t!==-1?e+r.substring(t):e}function sT(r,e){if(e[r])return r;let t=_f[r];if(t&&e[t])return t;const s=xn(r);return t=_f[s],e[t]?t:e[s]?s:mf}$r(["ja","ko","th","vi","zh","id"],function(r){return 0});$r(["fa","hi"],function(r){return r>=0&&r<=1?0:1});$r(["fr","pt"],function(r){return r>=0&&r<2?0:1});$r(["da"],function(r){return r===1||!Number.isInteger(r)&&r>=0&&r<=1?0:1});$r(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],function(r){return r===1?0:1});$r(["ru","uk"],function(r){if(Number.isInteger(r)){const e=r%10,t=r%100;if(e===1&&t!==11)return 0;if(e>=2&&e<=4&&(t<12||t>14))return 1;if(e===0||e>=5&&e<=9||t>=11&&t<=14)return 2}return 3});$r(["pl"],function(r){if(Number.isInteger(r)){if(r===1)return 0;const e=r%10,t=r%100;if(e>=2&&e<=4&&(t<12||t>14))return 1;if(e>=0&&e<=1||e>=5&&e<=9||t>=12&&t<=14)return 2}return 3});$r(["ar"],function(r){if(r===0)return 0;if(r===1)return 1;if(r===2)return 2;if(Number.isInteger(r)){const e=r%100;if(e>=3&&e<=10)return 3;if(e>=11&&e<=99)return 4}return 5});const Tk=r0[xn(mf)];function t_(r){return r0[r]||Tk}const Wl=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-\\+\\.]*:)?//|data:|blob:)","i");class Ek{constructor(e="",t="",s=null,i=null,n=null,a=null){this.url=e,this.filename=t,this.hash=s,this.size=i,this.opt=n,this.contents=a}equals(e){return this.url===e.url&&this.filename===e.filename&&this.hash===e.hash&&this.size===e.size&&this.opt===e.opt&&this.contents===e.contents}}let Ck=-1;const Ak={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},jS=["pvr","dxt","etc2","etc1","basis"];class ne extends ie{constructor(e,t,s,i,n){super(),this._id=Ck--,this._name=e||"",this.type=t,this.tags=new Xc(this),this._preload=!1,this._file=null,this._data=i||{},this.options=n||{},this._resources=[],this.urlObject=null,this._i18n={},this.loaded=!1,this.loading=!1,this.registry=null,s&&(this.file=s)}set id(e){this._id=e}get id(){return this._id}set name(e){if(this._name===e)return;const t=this._name;this._name=e,this.fire("name",this,this._name,t)}get name(){return this._name}set file(e){if(e&&e.variants&&["texture","textureatlas","bundle"].indexOf(this.type)!==-1){var t;const n=((t=this.registry)==null||(t=t._loader)==null?void 0:t._app)||Ai(),a=n==null?void 0:n.graphicsDevice;if(a)for(let o=0,l=jS.length;o<l;o++){const c=jS[o];if(e.variants[c]&&a[Ak[c]]){e=e.variants[c];break}if(n.enableBundles){const d=n.bundles.listBundlesForAsset(this);if(d&&d.find(h=>{var u;return h==null||(u=h.file)==null?void 0:u.variants[c]}))break}}}const s=this._file,i=e?new Ek(e.url,e.filename,e.hash,e.size,e.opt,e.contents):null;(!!i!=!!s||i&&!i.equals(s))&&(this._file=i,this.fire("change",this,"file",i,s),this.reload())}get file(){return this._file}set data(e){const t=this._data;this._data=e,e!==t&&(this.fire("change",this,"data",e,t),this.loaded&&this.registry._loader.patch(this,this.registry))}get data(){return this._data}set resource(e){const t=this._resources[0];this._resources[0]=e,this.fire("change",this,"resource",e,t)}get resource(){return this._resources[0]}set resources(e){const t=this._resources;this._resources=e,this.fire("change",this,"resources",e,t)}get resources(){return this._resources}set preload(e){e=!!e,this._preload!==e&&(this._preload=e,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}get preload(){return this._preload}set loadFaces(e){e=!!e,(!this.hasOwnProperty("_loadFaces")||e!==this._loadFaces)&&(this._loadFaces=e,this.loaded&&this.registry._loader.patch(this,this.registry))}get loadFaces(){return this._loadFaces}getFileUrl(){const e=this.file;if(!e||!e.url)return null;let t=e.url;if(this.registry&&this.registry.prefix&&!Wl.test(t)&&(t=this.registry.prefix+t),this.type!=="script"&&e.hash){const s=t.indexOf("?")!==-1?"&":"?";t+=s+"t="+e.hash}return t}getAbsoluteUrl(e){if(e.startsWith("blob:")||e.startsWith("data:"))return e;const t=me.getDirectory(this.file.url);return me.join(t,e)}getLocalizedAssetId(e){return e=sT(e,this._i18n),this._i18n[e]||null}addLocalizedAssetId(e,t){this._i18n[e]=t,this.fire("add:localized",e,t)}removeLocalizedAssetId(e){const t=this._i18n[e];t&&(delete this._i18n[e],this.fire("remove:localized",e,t))}ready(e,t){t=t||this,this.loaded?e.call(t,this):this.once("load",function(s){e.call(t,s)})}reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))}unload(){if(!this.loaded&&this._resources.length===0)return;this.fire("unload",this),this.registry.fire("unload:"+this.id,this);const e=this._resources;this.urlObject&&(URL.revokeObjectURL(this.urlObject),this.urlObject=null),this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(let t=0;t<e.length;++t){const s=e[t];s&&s.destroy&&s.destroy()}}static fetchArrayBuffer(e,t,s,i=0){var n;s!=null&&(n=s.file)!=null&&n.contents?setTimeout(()=>{t(null,s.file.contents)}):at.get(e,{cache:!0,responseType:"arraybuffer",retry:i>0,maxRetries:i},t)}}ne.EVENT_LOAD="load";ne.EVENT_UNLOAD="unload";ne.EVENT_REMOVE="remove";ne.EVENT_ERROR="error";ne.EVENT_CHANGE="change";ne.EVENT_ADDLOCALIZED="add:localized";ne.EVENT_REMOVELOCALIZED="remove:localized";class Pk{constructor(e=null){this._index={},this._key=void 0,this._key=e}addItem(e){const t=e.tags._list;for(const s of t)this.add(s,e)}removeItem(e){const t=e.tags._list;for(const s of t)this.remove(s,e)}add(e,t){this._index[e]&&this._index[e].list.indexOf(t)!==-1||(this._index[e]||(this._index[e]={list:[]},this._key&&(this._index[e].keys={})),this._index[e].list.push(t),this._key&&(this._index[e].keys[t[this._key]]=t))}remove(e,t){if(!this._index[e]||this._key&&!this._index[e].keys[t[this._key]])return;const s=this._index[e].list.indexOf(t);s!==-1&&(this._index[e].list.splice(s,1),this._key&&delete this._index[e].keys[t[this._key]],this._index[e].list.length===0&&delete this._index[e])}find(e){const t={},s=[];let i,n,a,o,l;const c=(d,h)=>this._index[d].list.length-this._index[h].list.length;for(let d=0;d<e.length;d++){if(n=e[d],n instanceof Array){if(n.length===0)continue;if(n.length===1)n=n[0];else{l=!1;for(let h=0;h<n.length;h++)if(!this._index[n[h]]){l=!0;break}if(l)continue;a=n.slice(0).sort(c),o=a.slice(1),o.length===1&&(o=o[0]);for(let h=0;h<this._index[a[0]].list.length;h++)i=this._index[a[0]].list[h],(this._key?!t[i[this._key]]:s.indexOf(i)===-1)&&i.tags.has(o)&&(this._key&&(t[i[this._key]]=!0),s.push(i));continue}}if(n&&typeof n=="string"&&this._index[n])for(let h=0;h<this._index[n].list.length;h++)i=this._index[n].list[h],this._key?t[i[this._key]]||(t[i[this._key]]=!0,s.push(i)):s.indexOf(i)===-1&&s.push(i)}return s}}class Xn extends ie{constructor(e){super(),this._assets=new Set,this._idToAsset=new Map,this._urlToAsset=new Map,this._nameToAsset=new Map,this._tags=new Pk("_id"),this.prefix=null,this.bundles=null,this._loader=e}list(e={}){const t=Array.from(this._assets);return e.preload!==void 0?t.filter(s=>s.preload===e.preload):t}add(e){var t,s;this._assets.has(e)||(this._assets.add(e),this._idToAsset.set(e.id,e),(t=e.file)!=null&&t.url&&this._urlToAsset.set(e.file.url,e),this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e),e.on("name",this._onNameChange,this),e.registry=this,this._tags.addItem(e),e.tags.on("add",this._onTagAdd,this),e.tags.on("remove",this._onTagRemove,this),this.fire("add",e),this.fire("add:"+e.id,e),(s=e.file)!=null&&s.url&&this.fire("add:url:"+e.file.url,e),e.preload&&this.load(e))}remove(e){var t,s;if(!this._assets.has(e))return!1;if(this._assets.delete(e),this._idToAsset.delete(e.id),(t=e.file)!=null&&t.url&&this._urlToAsset.delete(e.file.url),e.off("name",this._onNameChange,this),this._nameToAsset.has(e.name)){const i=this._nameToAsset.get(e.name);i.delete(e),i.size===0&&this._nameToAsset.delete(e.name)}return this._tags.removeItem(e),e.tags.off("add",this._onTagAdd,this),e.tags.off("remove",this._onTagRemove,this),e.fire("remove",e),this.fire("remove",e),this.fire("remove:"+e.id,e),(s=e.file)!=null&&s.url&&this.fire("remove:url:"+e.file.url,e),!0}get(e){return this._idToAsset.get(Number(e))}getByUrl(e){return this._urlToAsset.get(e)}load(e,t){if((e.loading||e.loaded)&&!(t!=null&&t.force))return;const s=e.file,i=()=>{this.fire("load",e),this.fire("load:"+e.id,e),s&&s.url&&this.fire("load:url:"+s.url,e),e.fire("load",e)},n=o=>{if(o instanceof Array?e.resources=o:e.resource=o,this._loader.patch(e,this),e.type==="bundle"){const l=e.data.assets;for(let c=0;c<l.length;c++){const d=this._idToAsset.get(l[c]);d&&!d.loaded&&this.load(d,{force:!0})}e.resource.loaded?i():(this.fire("load:start",e),this.fire("load:start:"+e.id,e),s&&s.url&&this.fire("load:start:url:"+s.url,e),e.fire("load:start",e),e.resource.on("load",i))}else i()},a=(o,l,c)=>{if(e.loaded=!0,e.loading=!1,o)this.fire("error",o,e),this.fire("error:"+e.id,o,e),e.fire("error",o,e);else{if(!ns.legacy&&e.type==="script"){const d=this._loader.getHandler("script");d._cache[e.id]&&d._cache[e.id].parentNode===document.head&&document.head.removeChild(d._cache[e.id]),d._cache[e.id]=c}n(l)}};if(s||e.type==="cubemap"){this.fire("load:start",e),this.fire("load:"+e.id+":start",e),e.loading=!0;const o=e.getFileUrl();if(e.type==="bundle"){const l=e.data.assets;for(let c=0;c<l.length;c++){const d=this._idToAsset.get(l[c]);d&&(d.loaded||d.resource||d.loading||(d.loading=!0))}}this._loader.load(o,e.type,a,e,t)}else{const o=this._loader.open(e.type,e.data);e.loaded=!0,n(o)}}loadFromUrl(e,t,s){this.loadFromUrlAndFilename(e,null,t,s)}loadFromUrlAndFilename(e,t,s,i){const n=me.getBasename(t||e),a={filename:t||n,url:e};let o=this.getByUrl(e);if(!o)o=new ne(n,s,a),this.add(o);else if(o.loaded){i(o.loadFromUrlError||null,o);return}const l=c=>{c.once("load",d=>{s==="material"?this._loadTextures(d,(h,u)=>{i(h,d)}):i(null,d)}),c.once("error",d=>{d&&(this.loadFromUrlError=d),i(d,c)}),this.load(c)};o.resource?i(null,o):s==="model"?this._loadModel(o,l):l(o)}_loadModel(e,t){const s=e.getFileUrl(),i=me.getExtension(s);if(i===".json"||i===".glb"){const n=me.getDirectory(s),a=me.getBasename(s),o=me.join(n,a.replace(i,".mapping.json"));this._loader.load(o,"json",(l,c)=>{l?(e.data={mapping:[]},t(e)):this._loadMaterials(e,c,(d,h)=>{e.data=c,t(e)})})}else t(e)}_loadMaterials(e,t,s){const i=[];let n=0;const a=(o,l)=>{this._loadTextures(l,(c,d)=>{i.push(l),i.length===n&&s(null,i)})};for(let o=0;o<t.mapping.length;o++){const l=t.mapping[o].path;if(l){n++;const c=e.getAbsoluteUrl(l);this.loadFromUrl(c,"material",a)}}n===0&&s(null,i)}_loadTextures(e,t){const s=[];let i=0;const n=e.data;if(n.mappingFormat!=="path"){t(null,s);return}const a=(l,c)=>{l&&console.error(l),s.push(c),s.length===i&&t(null,s)},o=Yp;for(let l=0;l<o.length;l++){const c=n[o[l]];if(c&&typeof c=="string"){i++;const d=e.getAbsoluteUrl(c);this.loadFromUrl(d,"texture",a)}}i===0&&t(null,s)}_onTagAdd(e,t){this._tags.add(e,t)}_onTagRemove(e,t){this._tags.remove(e,t)}_onNameChange(e,t,s){if(this._nameToAsset.has(s)){const i=this._nameToAsset.get(s);i.delete(e),i.size===0&&this._nameToAsset.delete(s)}this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e)}findByTag(){return this._tags.find(arguments)}filter(e){return Array.from(this._assets).filter(t=>e(t))}find(e,t){const s=this._nameToAsset.get(e);if(!s)return null;for(const i of s)if(!t||i.type===t)return i;return null}findAll(e,t){const s=this._nameToAsset.get(e);if(!s)return[];const i=Array.from(s);return t?i.filter(n=>n.type===t):i}}Xn.EVENT_LOAD="load";Xn.EVENT_ADD="add";Xn.EVENT_REMOVE="remove";Xn.EVENT_ERROR="error";class Mk{constructor(e){this._idToBundle=new Map,this._assetToBundles=new Map,this._urlsToBundles=new Map,this._fileRequests=new Map,this._assets=e,this._assets.bundles=this,this._assets.on("add",this._onAssetAdd,this),this._assets.on("remove",this._onAssetRemove,this)}_onAssetAdd(e){if(e.type==="bundle"){this._idToBundle.set(e.id,e),this._assets.on(`load:start:${e.id}`,this._onBundleLoadStart,this),this._assets.on(`load:${e.id}`,this._onBundleLoad,this),this._assets.on(`error:${e.id}`,this._onBundleError,this);const t=e.data.assets;for(let s=0;s<t.length;s++)this._indexAssetInBundle(t[s],e)}else this._assetToBundles.has(e.id)&&this._indexAssetFileUrls(e)}_unbindAssetEvents(e){this._assets.off("load:start:"+e,this._onBundleLoadStart,this),this._assets.off("load:"+e,this._onBundleLoad,this),this._assets.off("error:"+e,this._onBundleError,this)}_indexAssetInBundle(e,t){let s=this._assetToBundles.get(e);s||(s=new Set,this._assetToBundles.set(e,s)),s.add(t);const i=this._assets.get(e);i&&this._indexAssetFileUrls(i)}_indexAssetFileUrls(e){const t=this._getAssetFileUrls(e);if(t)for(let s=0;s<t.length;s++){const i=this._assetToBundles.get(e.id);i&&this._urlsToBundles.set(t[s],i)}}_getAssetFileUrls(e){let t=e.getFileUrl();if(!t)return null;t=t.split("?")[0];const s=[t];if(e.type==="font"){const i=e.data.info.maps.length;for(let n=1;n<i;n++)s.push(t.replace(".png",n+".png"))}return s}_onAssetRemove(e){if(e.type==="bundle"){this._idToBundle.delete(e.id),this._unbindAssetEvents(e.id);const t=e.data.assets;for(let s=0;s<t.length;s++){const i=this._assetToBundles.get(t[s]);if(i&&(i.delete(e),i.size===0)){this._assetToBundles.delete(t[s]);for(const[n,a]of this._urlsToBundles)a===i&&this._urlsToBundles.delete(n)}}this._onBundleError(`Bundle ${e.id} was removed`)}else{if(!this._assetToBundles.get(e.id))return;this._assetToBundles.delete(e.id);const s=this._getAssetFileUrls(e);if(!s)return;for(let i=0;i<s.length;i++)this._urlsToBundles.delete(s[i])}}_onBundleLoadStart(e){e.resource.on("add",(t,s)=>{const i=this._fileRequests.get(t);if(i){for(let n=0;n<i.length;n++)i[n](null,s);this._fileRequests.delete(t)}})}_onBundleLoad(e){if(!e.resource){this._onBundleError(`Bundle ${e.id} failed to load`);return}if(this._fileRequests)for(const[t,s]of this._fileRequests){const i=this._urlsToBundles.get(t);if(!i||!i.has(e))continue;const n=decodeURIComponent(t);let a,o;if(e.resource.has(n))o=e.resource.get(n);else if(e.resource.loaded)a=`Bundle ${e.id} does not contain URL ${t}`;else continue;for(let l=0;l<s.length;l++)s[l](a,a||o);this._fileRequests.delete(t)}}_onBundleError(e){for(const[t,s]of this._fileRequests)if(!this._findLoadedOrLoadingBundleForUrl(t)){for(let n=0;n<s.length;n++)s[n](e);this._fileRequests.delete(t)}}_findLoadedOrLoadingBundleForUrl(e){const t=this._urlsToBundles.get(e);if(!t)return null;let s=null;for(const i of t){if(i.loaded&&i.resource)return i;i.loading&&(s=i)}return s}listBundlesForAsset(e){const t=this._assetToBundles.get(e.id);return t?Array.from(t):null}list(){return Array.from(this._idToBundle.values())}hasUrl(e){return this._urlsToBundles.has(e)}urlIsLoadedOrLoading(e){return!!this._findLoadedOrLoadingBundleForUrl(e)}loadUrl(e,t){const s=this._findLoadedOrLoadingBundleForUrl(e);if(!s){t(`URL ${e} not found in any bundles`);return}if(s.loaded){const n=decodeURIComponent(e);if(s.resource.has(n)){t(null,s.resource.get(n));return}else if(s.resource.loaded){t(`Bundle ${s.id} does not contain URL ${e}`);return}}let i=this._fileRequests.get(e);i||(i=[],this._fileRequests.set(e,i)),i.push(t)}destroy(){this._assets.off("add",this._onAssetAdd,this),this._assets.off("remove",this._onAssetRemove,this);for(const e of this._idToBundle.keys())this._unbindAssetEvents(e);this._assets=null,this._idToBundle.clear(),this._idToBundle=null,this._assetToBundles.clear(),this._assetToBundles=null,this._urlsToBundles.clear(),this._urlsToBundles=null,this._fileRequests.clear(),this._fileRequests=null}}class Ik extends ie{constructor(){super(),this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.audiosource=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.joint=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.zone=void 0,this.list=[]}add(e){const t=e.id;if(this[t])throw new Error(`ComponentSystem name '${t}' already registered or not allowed`);this[t]=e,this.list.push(e)}remove(e){const t=e.id;if(!this[t])throw new Error(`No ComponentSystem named '${t}' registered`);delete this[t];const s=this.list.indexOf(this[t]);s!==-1&&this.list.splice(s,1)}destroy(){this.off();for(let e=0;e<this.list.length;e++)this.list[e].destroy()}}class a0 extends ie{constructor(...e){super(...e),this._index=new Map,this._loaded=!1}addFile(e,t){this._index.has(e)||(this._index.set(e,t),this.fire("add",e,t))}has(e){return this._index.has(e)}get(e){return this._index.get(e)||null}destroy(){this._index.clear()}set loaded(e){!e||this._loaded||(this._loaded=!0,this.fire("load"))}get loaded(){return this._loaded}}a0.EVENT_ADD="add";a0.EVENT_LOAD="load";class Rk extends ie{constructor(e,t=""){super(),this.headerSize=512,this.paddingSize=512,this.bytesRead=0,this.bytesReceived=0,this.headerRead=!1,this.reader=null,this.data=new Uint8Array(0),this.decoder=null,this.prefix="",this.fileName="",this.fileSize=0,this.fileType="",this.ustarFormat="",this.prefix=t||"",this.reader=e.body.getReader(),this.reader.read().then(s=>{this.pump(s.done,s.value)}).catch(s=>{this.fire("error",s)})}pump(e,t){if(e)return this.fire("done"),null;this.bytesReceived+=t.byteLength;const s=new Uint8Array(this.data.length+t.length);for(s.set(this.data),s.set(t,this.data.length),this.data=s;this.readFile(););return this.reader.read().then(i=>{this.pump(i.done,i.value)}).catch(i=>{this.fire("error",i)})}readFile(){if(!this.headerRead&&this.bytesReceived>this.bytesRead+this.headerSize){var e;this.headerRead=!0;const t=new DataView(this.data.buffer,this.bytesRead,this.headerSize);(e=this.decoder)!=null||(this.decoder=new TextDecoder("windows-1252"));const s=this.decoder.decode(t);if(this.fileName=s.substring(0,100).replace(/\0/g,""),this.fileSize=parseInt(s.substring(124,136),8),this.fileType=s.substring(156,157),this.ustarFormat=s.substring(257,263),this.ustarFormat.indexOf("ustar")!==-1){const i=s.substring(345,500).replace(/\0/g,"");i.length>0&&(this.fileName=i.trim()+this.fileName.trim())}this.bytesRead+=512}if(this.headerRead){if(this.bytesReceived<this.bytesRead+this.fileSize)return!1;if(this.fileType===""||this.fileType==="0"){const s=new DataView(this.data.buffer,this.bytesRead,this.fileSize),i={name:this.prefix+this.fileName,size:this.fileSize,data:s};this.fire("file",i)}this.bytesRead+=this.fileSize,this.headerRead=!1;const t=this.bytesRead%this.paddingSize;return t!==0&&(this.bytesRead+=this.paddingSize-t),!0}return!1}}class Ze{constructor(e,t){this.handlerType="",this._app=void 0,this._maxRetries=0,this._app=e,this.handlerType=t}set maxRetries(e){this._maxRetries=e}get maxRetries(){return this._maxRetries}load(e,t,s){}open(e,t,s){return t}patch(e,t){}}class Lk extends Ze{constructor(e){super(e,"bundle"),this._assets=e.assets}_fetchRetries(e,t,s=0){return new Promise((i,n)=>{const a=()=>{fetch(e,t).then(i).catch(o=>{s++,s<this.maxRetries?a():n(o)})};a()})}load(e,t){typeof e=="string"&&(e={load:e,original:e}),this._fetchRetries(e.load,{mode:"cors",credentials:"include"},this.maxRetries).then(s=>{const i=new a0;t(null,i);const n=new Rk(s,this._assets.prefix);n.on("file",a=>{i.addFile(a.name,a.data)}),n.on("done",()=>{i.loaded=!0}),n.on("error",a=>{t(a)})}).catch(s=>{t(s)})}open(e,t){return t}}class Tl{constructor(e){this._handlers={},this._requests={},this._cache={},this._app=e}addHandler(e,t){this._handlers[e]=t,t._loader=this}removeHandler(e){delete this._handlers[e]}getHandler(e){return this._handlers[e]}static makeKey(e,t){return`${e}-${t}`}load(e,t,s,i,n){const a=this._handlers[t];if(!a){const c=`No resource handler for asset type: '${t}' when loading [${e}]`;s(c);return}if(!e){this._loadNull(a,s,i);return}const o=Tl.makeKey(e,t);if(this._cache[o]!==void 0)s(null,this._cache[o]);else if(this._requests[o])this._requests[o].push(s);else{this._requests[o]=[s];const c=this,d=function(f,p){if(f){c._onFailure(o,f);return}if(p.load instanceof DataView){if(a.openBinary){if(!c._requests[o])return;try{const _=a.openBinary(p.load);c._onSuccess(o,_)}catch(_){c._onFailure(o,_)}return}p.load=URL.createObjectURL(new Blob([p.load])),i&&(i.urlObject&&URL.revokeObjectURL(i.urlObject),i.urlObject=p.load)}a.load(p,function(_,m,g){if(c._requests[o]){if(_){c._onFailure(o,_);return}try{c._onSuccess(o,a.open(p.original,m,i),g)}catch(v){c._onFailure(o,v)}}},i)},h=e.split("?")[0];if(this._app.enableBundles&&this._app.bundles.hasUrl(h)&&!(n&&n.bundlesIgnore)){if(!this._app.bundles.urlIsLoadedOrLoading(h)){var l;const u=this._app.bundles.listBundlesForAsset(i);let f;n&&n.bundlesFilter&&(f=n.bundlesFilter(u)),f||(u==null||u.sort((p,_)=>p.file.size-_.file.size),f=u==null?void 0:u[0]),f&&((l=this._app.assets)==null||l.load(f))}this._app.bundles.loadUrl(h,function(u,f){d(u,{load:f,original:h})})}else d(null,{load:e,original:i&&i.file.filename||e})}}_loadNull(e,t,s){const i=function(a,o,l){if(a)t(a);else try{t(null,e.open(null,o,s),l)}catch(c){t(c)}};e.load(null,i,s)}_onSuccess(e,t,s){t!==null?this._cache[e]=t:delete this._cache[e];for(let i=0;i<this._requests[e].length;i++)this._requests[e][i](null,t,s);delete this._requests[e]}_onFailure(e,t){if(console.error(t),this._requests[e]){for(let s=0;s<this._requests[e].length;s++)this._requests[e][s](t);delete this._requests[e]}}open(e,t){const s=this._handlers[e];return s?s.open(null,t):(console.warn("No resource handler found for: "+e),t)}patch(e,t){const s=this._handlers[e.type];if(!s){console.warn("No resource handler found for: "+e.type);return}s.patch&&s.patch(e,t)}clearCache(e,t){const s=Tl.makeKey(e,t);delete this._cache[s]}getFromCache(e,t){const s=Tl.makeKey(e,t);if(this._cache[s])return this._cache[s]}enableRetry(e=5){e=Math.max(0,e)||0;for(const t in this._handlers)this._handlers[t].maxRetries=e}disableRetry(){for(const e in this._handlers)this._handlers[e].maxRetries=0}destroy(){this._handlers={},this._requests={},this._cache={}}}class Dk{_validate(e){if(!e.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!e.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(e.header.version!==1)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(e.data){if(!Array.isArray(e.data))throw new Error('pc.I18n#addData: "data" field must be an array')}else throw new Error('pc.I18n#addData: Missing "data" field');for(let t=0,s=e.data.length;t<s;t++){const i=e.data[t];if(!i.info)throw new Error(`pc.I18n#addData: missing "data[${t}].info" field`);if(!i.info.locale)throw new Error(`pc.I18n#addData: missing "data[${t}].info.locale" field`);if(typeof i.info.locale!="string")throw new Error(`pc.I18n#addData: "data[${t}].info.locale" must be a string`);if(!i.messages)throw new Error(`pc.I18n#addData: missing "data[${t}].messages" field`)}}parse(e){return e.data}}class Ok extends ie{constructor(e){super(),this.locale=mf,this._translations={},this._availableLangs={},this._app=e,this._assets=[],this._parser=new Dk}set assets(e){const t={};for(let i=0,n=e.length;i<n;i++){const a=e[i]instanceof ne?e[i].id:e[i];t[a]=!0}let s=this._assets.length;for(;s--;){const i=this._assets[s];if(!t[i]){this._app.assets.off("add:"+i,this._onAssetAdd,this);const n=this._app.assets.get(i);n&&this._onAssetRemove(n),this._assets.splice(s,1)}}for(const i in t){const n=parseInt(i,10);if(this._assets.indexOf(n)!==-1)continue;this._assets.push(n);const a=this._app.assets.get(n);a?this._onAssetAdd(a):this._app.assets.once("add:"+n,this._onAssetAdd,this)}}get assets(){return this._assets}set locale(e){if(this._locale===e)return;let t=xn(e);if(t==="in"&&(t="id",e=bk(e,t),this._locale===e))return;const s=this._locale;this._locale=e,this._lang=t,this._pluralFn=t_(this._lang),this.fire("set:locale",e,s)}get locale(){return this._locale}static findAvailableLocale(e,t){return sT(e,t)}findAvailableLocale(e){if(this._translations[e])return e;const t=xn(e);return this._findFallbackLocale(e,t)}getText(e,t){let s=e,i;t||(t=this._locale,i=this._lang);let n=this._translations[t];return n||(i||(i=xn(t)),t=this._findFallbackLocale(t,i),n=this._translations[t]),n&&n.hasOwnProperty(e)&&(s=n[e],Array.isArray(s)&&(s=s[0]),s==null&&(s=e)),s}getPluralText(e,t,s){let i=e,n,a;s?(n=xn(s),a=t_(n)):(s=this._locale,n=this._lang,a=this._pluralFn);let o=this._translations[s];if(o||(s=this._findFallbackLocale(s,n),n=xn(s),a=t_(n),o=this._translations[s]),o&&o[e]&&a){const l=a(t);i=o[e][l],i==null&&(i=e)}return i}addData(e){let t;try{t=this._parser.parse(e)}catch(s){console.error(s);return}for(let s=0,i=t.length;s<i;s++){const n=t[s],a=n.info.locale,o=n.messages;if(!this._translations[a]){this._translations[a]={};const l=xn(a);this._availableLangs[l]||(this._availableLangs[l]=a)}Object.assign(this._translations[a],o),this.fire("data:add",a,o)}}removeData(e){let t;try{t=this._parser.parse(e)}catch(s){console.error(s);return}for(let s=0,i=t.length;s<i;s++){const n=t[s],a=n.info.locale,o=this._translations[a];if(!o)continue;const l=n.messages;for(const c in l)delete o[c];Object.keys(o).length===0&&(delete this._translations[a],delete this._availableLangs[xn(a)]),this.fire("data:remove",a,l)}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()}_findFallbackLocale(e,t){let s=_f[e];return s&&this._translations[s]||(s=_f[t],s&&this._translations[s])||(s=this._availableLangs[t],s&&this._translations[s])?s:mf}_onAssetAdd(e){e.on("load",this._onAssetLoad,this),e.on("change",this._onAssetChange,this),e.on("remove",this._onAssetRemove,this),e.on("unload",this._onAssetUnload,this),e.resource&&this._onAssetLoad(e)}_onAssetLoad(e){this.addData(e.resource)}_onAssetChange(e){e.resource&&this.addData(e.resource)}_onAssetRemove(e){e.off("load",this._onAssetLoad,this),e.off("change",this._onAssetChange,this),e.off("remove",this._onAssetRemove,this),e.off("unload",this._onAssetUnload,this),e.resource&&this.removeData(e.resource),this._app.assets.once("add:"+e.id,this._onAssetAdd,this)}_onAssetUnload(e){e.resource&&this.removeData(e.resource)}}class Fk extends ie{constructor(e){super(),this.app=e,this._scripts={},this._list=[]}destroy(){this.app=null,this.off()}add(e){const t=e.__name;return this._scripts.hasOwnProperty(t)?(setTimeout(()=>{if(e.prototype.swap){const s=this._scripts[t],i=this._list.indexOf(s);this._list[i]=e,this._scripts[t]=e,this.fire("swap",t,e),this.fire("swap:"+t,e)}else console.warn(`script registry already has '${t}' script, define 'swap' method for new script type to enable code hot swapping`)}),!1):(this._scripts[t]=e,this._list.push(e),this.fire("add",t,e),this.fire("add:"+t,e),setTimeout(()=>{if(!this._scripts.hasOwnProperty(t)||!this.app||!this.app.systems||!this.app.systems.script)return;const s=this.app.systems.script._components;let i;const n=[],a=[];for(s.loopIndex=0;s.loopIndex<s.length;s.loopIndex++){const o=s.items[s.loopIndex];if(o._scriptsIndex[t]&&o._scriptsIndex[t].awaiting){o._scriptsData&&o._scriptsData[t]&&(i=o._scriptsData[t].attributes);const l=o.create(t,{preloading:!0,ind:o._scriptsIndex[t].ind,attributes:i});l&&n.push(l)}}for(let o=0;o<n.length;o++)n[o].__initializeAttributes();for(let o=0;o<n.length;o++)n[o].enabled&&(n[o]._initialized=!0,a.push(n[o]),n[o].initialize&&n[o].initialize());for(let o=0;o<a.length;o++)!a[o].enabled||a[o]._postInitialized||(a[o]._postInitialized=!0,a[o].postInitialize&&a[o].postInitialize())}),!0)}remove(e){let t=e,s=e;if(typeof s!="string"?s=t.__name:t=this.get(s),this.get(s)!==t)return!1;delete this._scripts[s];const i=this._list.indexOf(t);return this._list.splice(i,1),this.fire("remove",s,t),this.fire("remove:"+s,t),!0}get(e){return this._scripts[e]||null}has(e){if(typeof e=="string")return this._scripts.hasOwnProperty(e);if(!e)return!1;const t=e.__name;return this._scripts[t]===e}list(){return this._list}}const Eh=[];class $ extends ze{constructor(e,t=Ai()){super(e),this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.gsplat=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.c={},this._app=void 0,this._destroying=!1,this._guid=null,this._template=!1,this._app=t}addComponent(e,t){const s=this._app.systems[e];return!s||this.c[e]?null:s.addComponent(this,t)}removeComponent(e){const t=this._app.systems[e];t&&this.c[e]&&t.removeComponent(this)}findComponent(e){const t=this.findOne(function(s){return s.c&&s.c[e]});return t&&t.c[e]}findComponents(e){return this.find(function(s){return s.c&&s.c[e]}).map(function(s){return s.c[e]})}findScript(e){const t=this.findOne(s=>{var i;return(i=s.c)==null||(i=i.script)==null?void 0:i.has(e)});return t==null?void 0:t.c.script.get(e)}findScripts(e){return this.find(s=>{var i;return(i=s.c)==null||(i=i.script)==null?void 0:i.has(e)}).map(s=>s.c.script.get(e))}getGuid(){return this._guid||this.setGuid(cA.create()),this._guid}setGuid(e){const t=this._app._entityIndex;this._guid&&delete t[this._guid],this._guid=e,t[this._guid]=this}_notifyHierarchyStateChanged(e,t){let s=!1;e===this&&Eh.length===0&&(s=!0),e._beingEnabled=!0,e._onHierarchyStateChanged(t),e._onHierarchyStatePostChanged&&Eh.push(e);const i=e._children;for(let n=0,a=i.length;n<a;n++)i[n]._enabled&&this._notifyHierarchyStateChanged(i[n],t);if(e._beingEnabled=!1,s){for(let n=0;n<Eh.length;n++)Eh[n]._onHierarchyStatePostChanged();Eh.length=0}}_onHierarchyStateChanged(e){super._onHierarchyStateChanged(e);const t=this.c;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s];i.enabled&&(e?i.onEnable():i.onDisable())}}_onHierarchyStatePostChanged(){const e=this.c;for(const t in e)e.hasOwnProperty(t)&&e[t].onPostStateChange()}findByGuid(e){if(this._guid===e)return this;const t=this._app._entityIndex[e];return t&&(t===this||t.isDescendantOf(this))?t:null}destroy(){this._destroying=!0;for(const e in this.c)this.c[e].enabled=!1;for(const e in this.c)this.c[e].system.removeComponent(this);super.destroy(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1}clone(){const e={},t=this._cloneRecursively(e);return e[this.getGuid()]=t,iT(this,this,t,e),t}_cloneRecursively(e){const t=new this.constructor(void 0,this._app);super._cloneInternal(t);for(const s in this.c)this.c[s].system.cloneComponent(this,t);for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i instanceof $){const n=i._cloneRecursively(e);t.addChild(n),e[i.getGuid()]=n}}return t}}$.EVENT_DESTROY="destroy";function iT(r,e,t,s){if(e instanceof $){const i=e.c;for(const o in i){const l=i[o],c=l.system.getPropertiesOfType("entity");for(let d=0,h=c.length;d<h;d++){const f=c[d].name,p=l[f];if(!!r.findByGuid(p)){const m=s[p].getGuid();m&&(t.c[o][f]=m)}}}i.script&&!t._app.useLegacyScriptAttributeCloning&&t.script.resolveDuplicatedEntityReferenceProperties(i.script,s),i.render&&t.render.resolveDuplicatedEntityReferenceProperties(i.render,s),i.anim&&t.anim.resolveDuplicatedEntityReferenceProperties(i.anim,s);const n=e.children.filter(function(o){return o instanceof $}),a=t.children.filter(function(o){return o instanceof $});for(let o=0,l=n.length;o<l;o++)iT(r,n[o],a[o],s)}}class $S{constructor(e,t){this.name=void 0,this.url=void 0,this.data=null,this._loading=!1,this._onLoadedCallbacks=[],this.name=e,this.url=t}get loaded(){return!!this.data}get loading(){return this._loading}}class kk{constructor(e){this._app=void 0,this._list=[],this._index={},this._urlIndex={},this._app=e}destroy(){this._app=null}list(){return this._list}add(e,t){if(this._index.hasOwnProperty(e))return!1;const s=new $S(e,t),i=this._list.push(s);return this._index[s.name]=i-1,this._urlIndex[s.url]=i-1,!0}find(e){return this._index.hasOwnProperty(e)?this._list[this._index[e]]:null}findByUrl(e){return this._urlIndex.hasOwnProperty(e)?this._list[this._urlIndex[e]]:null}remove(e){if(this._index.hasOwnProperty(e)){const t=this._index[e];let s=this._list[t];delete this._urlIndex[s.url],delete this._index[e],this._list.splice(t,1);for(let i=0;i<this._list.length;i++)s=this._list[i],this._index[s.name]=i,this._urlIndex[s.url]=i}}_loadSceneData(e,t,s){const i=this._app;let n=e;if(typeof e=="string"&&(e=this.findByUrl(n)||this.find(n)||new $S("Untitled",n)),n=e.url,!n){s("Cannot find scene to load");return}if(e.loaded){s(null,e);return}i.assets&&i.assets.prefix&&!Wl.test(n)&&(n=me.join(i.assets.prefix,n)),e._onLoadedCallbacks.push(s),e._loading||i.loader.getHandler("hierarchy").load(n,(o,l)=>{e.data=l,e._loading=!1;for(let c=0;c<e._onLoadedCallbacks.length;c++)e._onLoadedCallbacks[c](o,e);t||(e.data=null),e._onLoadedCallbacks.length=0}),e._loading=!0}loadSceneData(e,t){this._loadSceneData(e,!0,t)}unloadSceneData(e){typeof e=="string"&&(e=this.findByUrl(e)),e&&(e.data=null)}_loadSceneHierarchy(e,t,s){this._loadSceneData(e,!1,(i,n)=>{if(i){s&&s(i);return}t&&t(n);const a=this._app,o=()=>{const l=a.loader.getHandler("hierarchy");a.systems.script.preloading=!0;const c=l.open(n.url,n.data);a.systems.script.preloading=!1,a.loader.clearCache(n.url,"hierarchy"),a.root.addChild(c),a.systems.fire("initialize",c),a.systems.fire("postInitialize",c),a.systems.fire("postPostInitialize",c),s&&s(null,c)};a._preloadScripts(n.data,o)})}loadSceneHierarchy(e,t){this._loadSceneHierarchy(e,null,t)}loadSceneSettings(e,t){this._loadSceneData(e,!1,(s,i)=>{s?t&&t(s):(this._app.applySceneSettings(i.data.settings),t&&t(null))})}changeScene(e,t){const s=this._app,i=n=>{const{children:a}=s.root;for(;a.length;)a[0].destroy();s.applySceneSettings(n.data.settings)};this._loadSceneHierarchy(e,i,t)}loadScene(e,t){const s=this._app,i=s.loader.getHandler("scene");s.assets&&s.assets.prefix&&!Wl.test(e)&&(e=me.join(s.assets.prefix,e)),i.load(e,(n,a)=>{if(n)t&&t(n);else{const o=()=>{s.systems.script.preloading=!0;const l=i.open(e,a),c=this.findByUrl(e);c&&!c.loaded&&(c.data=a),s.systems.script.preloading=!1,s.loader.clearCache(e,"scene"),s.loader.patch({resource:l,type:"scene"},s.assets),s.root.addChild(l.root),s.systems.rigidbody&&typeof Ammo<"u"&&s.systems.rigidbody.gravity.set(l._gravity.x,l._gravity.y,l._gravity.z),t&&t(null,l)};s._preloadScripts(a,o)}})}}class Bk{constructor(e){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=e._shaderStats,this.vram=e._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}get scene(){return Ai().scene._stats}get lightmapper(){var e;return(e=Ai().lightmapper)==null?void 0:e.stats}get batcher(){const e=Ai()._batcher;return e?e._stats:null}}class XS{constructor(e){this.length=e,this.count=0}inc(){this.count++}done(){return this.count===this.length}}class gt extends ie{constructor(e){super(),this.frameRequestId=void 0,gt._applications[e.id]=this,mg(this),this._destroyRequested=!1,this._inFrameUpdate=!1,this._time=0,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.autoRender=!0,this.renderNextFrame=!1,this.useLegacyScriptAttributeCloning=ns.legacy,this._librariesLoaded=!1,this._fillMode=GS,this._resolutionMode=Sk,this._allowResize=!0,this.context=this}init(e){const t=e.graphicsDevice;this.graphicsDevice=t,this._initDefaultMaterial(),this._initProgramLibrary(),this.stats=new Bk(t),this._soundManager=e.soundManager,this.loader=new Tl(this),this._entityIndex={},this.scene=new js(t),this._registerSceneImmediate(this.scene),this.root=new $,this.root._enabledInHierarchy=!0,this.assets=new Xn(this.loader),e.assetPrefix&&(this.assets.prefix=e.assetPrefix),this.bundles=new Mk(this.assets),this.enableBundles=typeof TextDecoder<"u",this.scriptsOrder=e.scriptsOrder||[],this.scripts=new Fk(this),this.i18n=new Ok(this),this.scenes=new kk(this),this.defaultLayerWorld=new mr({name:"World",id:Ws}),this.defaultLayerDepth=new mr({name:"Depth",id:_s,enabled:!1,opaqueSortMode:Vu}),this.defaultLayerSkybox=new mr({name:"Skybox",id:zy,opaqueSortMode:Vu}),this.defaultLayerUi=new mr({name:"UI",id:Kp,transparentSortMode:wI}),this.defaultLayerImmediate=new mr({name:"Immediate",id:Ti,opaqueSortMode:Vu});const s=new dg("default");s.pushOpaque(this.defaultLayerWorld),s.pushOpaque(this.defaultLayerDepth),s.pushOpaque(this.defaultLayerSkybox),s.pushTransparent(this.defaultLayerWorld),s.pushOpaque(this.defaultLayerImmediate),s.pushTransparent(this.defaultLayerImmediate),s.pushTransparent(this.defaultLayerUi),this.scene.layers=s,Ca.createPlaceholder(t),this.renderer=new Zb(t),this.renderer.scene=this.scene,this.frameGraph=new xk,this.lightmapper=null,e.lightmapper&&(this.lightmapper=new e.lightmapper(t,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),this._batcher=null,e.batchManager&&(this._batcher=new e.batchManager(t,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=e.keyboard||null,this.mouse=e.mouse||null,this.touch=e.touch||null,this.gamepads=e.gamepads||null,this.elementInput=e.elementInput||null,this.elementInput&&(this.elementInput.app=this),this.xr=e.xr?new e.xr(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._inTools=!1,this._skyboxAsset=null,this._scriptPrefix=e.scriptPrefix||"",this.enableBundles&&this.loader.addHandler("bundle",new Lk(this)),e.resourceHandlers.forEach(i=>{const n=new i(this);this.loader.addHandler(n.handlerType,n)}),this.systems=new Ik,e.componentSystems.forEach(i=>{this.systems.add(new i(this))}),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),typeof document<"u"&&(document.hidden!==void 0?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):document.mozHidden!==void 0?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):document.msHidden!==void 0?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):document.webkitHidden!==void 0&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.tick=Nk(this)}static getApplication(e){return e?gt._applications[e]:Ai()}_initDefaultMaterial(){const e=new Gs;e.name="Default Material",e.shadingModel=yd,A2(this.graphicsDevice,e)}_initProgramLibrary(){const e=new ZF(this.graphicsDevice,new Gs);Gb(this.graphicsDevice,e)}get soundManager(){return this._soundManager}get batcher(){return this._batcher}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(e,t){at.get(e,(s,i)=>{if(s){t(s);return}const n=i.application_properties,a=i.scenes,o=i.assets;this._parseApplicationProperties(n,l=>{this._parseScenes(a),this._parseAssets(o),t(l||null)})})}preload(e){this.fire("preload:start");const t=this.assets.list({preload:!0}),s=new XS(t.length);let i=!1;const n=()=>{this.graphicsDevice&&!i&&s.done()&&(i=!0,this.fire("preload:end"),e())},a=t.length;if(s.length){const o=c=>{s.inc(),this.fire("preload:progress",s.count/a),s.done()&&n()},l=(c,d)=>{s.inc(),this.fire("preload:progress",s.count/a),s.done()&&n()};for(let c=0;c<t.length;c++)t[c].loaded?(s.inc(),this.fire("preload:progress",s.count/a),s.done()&&n()):(t[c].once("load",o),t[c].once("error",l),this.assets.load(t[c]))}else n()}_preloadScripts(e,t){if(!ns.legacy){t();return}this.systems.script.preloading=!0;const s=this._getScriptReferences(e),i=s.length,n=new XS(i),a=/^http(s)?:\/\//;if(i){const o=(l,c)=>{l&&console.error(l),n.inc(),n.done()&&(this.systems.script.preloading=!1,t())};for(let l=0;l<i;l++){let c=s[l];!a.test(c.toLowerCase())&&this._scriptPrefix&&(c=me.join(this._scriptPrefix,s[l])),this.loader.load(c,"script",o)}}else this.systems.script.preloading=!1,t()}_parseApplicationProperties(e,t){if(typeof e.maxAssetRetries=="number"&&e.maxAssetRetries>0&&this.loader.enableRetry(e.maxAssetRetries),e.useDevicePixelRatio||(e.useDevicePixelRatio=e.use_device_pixel_ratio),e.resolutionMode||(e.resolutionMode=e.resolution_mode),e.fillMode||(e.fillMode=e.fill_mode),this._width=e.width,this._height=e.height,e.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(e.resolutionMode,this._width,this._height),this.setCanvasFillMode(e.fillMode,this._width,this._height),e.layers&&e.layerOrder){const s=new dg("application"),i={};for(const n in e.layers){const a=e.layers[n];a.id=parseInt(n,10),a.enabled=a.id!==_s,i[n]=new mr(a)}for(let n=0,a=e.layerOrder.length;n<a;n++){const o=e.layerOrder[n],l=i[o.layer];l&&(o.transparent?s.pushTransparent(l):s.pushOpaque(l),s.subLayerEnabled[n]=o.enabled)}this.scene.layers=s}if(e.batchGroups){const s=this.batcher;if(s)for(let i=0,n=e.batchGroups.length;i<n;i++){const a=e.batchGroups[i];s.addGroup(a.name,a.dynamic,a.maxAabbSize,a.id,a.layers)}}e.i18nAssets&&(this.i18n.assets=e.i18nAssets),this._loadLibraries(e.libraries,t)}_loadLibraries(e,t){const s=e.length;let i=s;const n=/^http(s)?:\/\//;if(s){const a=(o,l)=>{i--,o?t(o):i===0&&(this.onLibrariesLoaded(),t(null))};for(let o=0;o<s;++o){let l=e[o];!n.test(l.toLowerCase())&&this._scriptPrefix&&(l=me.join(this._scriptPrefix,l)),this.loader.load(l,"script",a)}}else this.onLibrariesLoaded(),t(null)}_parseScenes(e){if(e)for(let t=0;t<e.length;t++)this.scenes.add(e[t].name,e[t].url)}_parseAssets(e){const t=[],s={},i={};if(ns.legacy){if(this.enableBundles)for(const n in e)e[n].type==="bundle"&&(i[n]=!0,t.push(e[n]));for(const n in e)i[n]||t.push(e[n])}else{for(let n=0;n<this.scriptsOrder.length;n++){const a=this.scriptsOrder[n];e[a]&&(s[a]=!0,t.push(e[a]))}if(this.enableBundles)for(const n in e)e[n].type==="bundle"&&(i[n]=!0,t.push(e[n]));for(const n in e)s[n]||i[n]||t.push(e[n])}for(let n=0;n<t.length;n++){const a=t[n],o=new ne(a.name,a.type,a.file,a.data);if(o.id=parseInt(a.id,10),o.preload=a.preload?a.preload:!1,o.loaded=a.type==="script"&&a.data&&a.data.loadingType>0,o.tags.add(a.tags),a.i18n)for(const l in a.i18n)o.addLocalizedAssetId(l,a.i18n[l]);this.assets.add(o)}}_getScriptReferences(e){let t=[];e.settings.priority_scripts&&(t=e.settings.priority_scripts);const s=[],i={};for(let a=0;a<t.length;a++)s.push(t[a]),i[t[a]]=!0;const n=e.entities;for(const a in n){if(!n[a].components.script)continue;const o=n[a].components.script.scripts;for(let l=0;l<o.length;l++)i[o[l].url]||(s.push(o[l].url),i[o[l].url]=!0)}return s}start(){this.frame=0,this.fire("start",{timestamp:Zi(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick()}inputUpdate(e){this.controller&&this.controller.update(e),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update()}update(e){this.frame++,this.graphicsDevice.updateClientRect(),ns.legacy&&this.systems.fire("fixedUpdate",1/60),this.systems.fire(this._inTools?"toolsUpdate":"update",e),this.systems.fire("animationUpdate",e),this.systems.fire("postUpdate",e),this.fire("update",e),this.inputUpdate(e)}frameStart(){this.graphicsDevice.frameStart()}frameEnd(){this.graphicsDevice.frameEnd()}render(){this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender")}renderComposition(e){this.renderer.buildFrameGraph(this.frameGraph,e),this.frameGraph.render(this.graphicsDevice)}_fillFrameStatsBasic(e,t,s){const i=this.stats.frame;i.dt=t,i.ms=s,e>i._timeToCountFrames?(i.fps=i._fpsAccum,i._fpsAccum=0,i._timeToCountFrames=e+1e3):i._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0}_fillFrameStats(){let e=this.stats.frame;e.cameras=this.renderer._camerasRendered,e.materials=this.renderer._materialSwitches,e.shaders=this.graphicsDevice._shaderSwitchesPerFrame,e.shadowMapUpdates=this.renderer._shadowMapUpdates,e.shadowMapTime=this.renderer._shadowMapTime,e.depthMapTime=this.renderer._depthMapTime,e.forwardTime=this.renderer._forwardTime;const t=this.graphicsDevice._primsPerFrame;e.triangles=t[Ln]/3+Math.max(t[Ji]-2,0)+Math.max(t[Ia]-2,0),e.cullTime=this.renderer._cullTime,e.sortTime=this.renderer._sortTime,e.skinTime=this.renderer._skinTime,e.morphTime=this.renderer._morphTime,e.lightClusters=this.renderer._lightClusters,e.lightClustersTime=this.renderer._lightClustersTime,e.otherPrimitives=0;for(let s=0;s<t.length;s++)s<Ln&&(e.otherPrimitives+=t[s]),t[s]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,e=this.stats.drawCalls,e.forward=this.renderer._forwardDrawCalls,e.culled=this.renderer._numDrawCallsCulled,e.depth=0,e.shadow=this.renderer._shadowDrawCalls,e.skinned=this.renderer._skinDrawCalls,e.immediate=0,e.instanced=0,e.removedByInstancing=0,e.misc=e.total-(e.forward+e.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,e=this.stats.particles,e.updatesPerFrame=e._updatesPerFrame,e.frameTime=e._frameTime,e._updatesPerFrame=0,e._frameTime=0}setCanvasFillMode(e,t,s){this._fillMode=e,this.resizeCanvas(t,s)}setCanvasResolution(e,t,s){this._resolutionMode=e,e===pg&&t===void 0&&(t=this.graphicsDevice.canvas.clientWidth,s=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(t,s)}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume()}resizeCanvas(e,t){if(!this._allowResize||this.xr&&this.xr.session)return;const s=window.innerWidth,i=window.innerHeight;if(this._fillMode===GS){const n=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height,a=s/i;n>a?(e=s,t=e/n):(t=i,e=t*n)}else this._fillMode===vk&&(e=s,t=i);return this.graphicsDevice.canvas.style.width=e+"px",this.graphicsDevice.canvas.style.height=t+"px",this.updateCanvasSize(),{width:e,height:t}}updateCanvasSize(){var e;if(!(!this._allowResize||(e=this.xr)!=null&&e.active)&&this._resolutionMode===pg){const t=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(t.clientWidth,t.clientHeight)}}onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded()}applySceneSettings(e){let t;if(this.systems.rigidbody&&typeof Ammo<"u"){const s=e.physics.gravity;this.systems.rigidbody.gravity.set(s[0],s[1],s[2])}this.scene.applySettings(e),e.render.hasOwnProperty("skybox")&&(e.render.skybox?(t=this.assets.get(e.render.skybox),t?this.setSkybox(t):this.assets.once("add:"+e.render.skybox,this.setSkybox,this)):this.setSkybox(null))}setAreaLightLuts(e,t){e&&t&&Ca.set(this.graphicsDevice,e,t)}setSkybox(e){if(e!==this._skyboxAsset){const t=()=>{this.setSkybox(null)},s=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null)};this._skyboxAsset&&(this.assets.off("load:"+this._skyboxAsset.id,s,this),this.assets.off("remove:"+this._skyboxAsset.id,t,this),this._skyboxAsset.off("change",s,this)),this._skyboxAsset=e,this._skyboxAsset&&(this.assets.on("load:"+this._skyboxAsset.id,s,this),this.assets.once("remove:"+this._skyboxAsset.id,t,this),this._skyboxAsset.on("change",s,this),this.scene.skyboxMip===0&&!this._skyboxAsset.loadFaces&&(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),s()}}_firstBake(){var e;(e=this.lightmapper)==null||e.bake(null,this.scene.lightmapMode)}_firstBatch(){var e;(e=this.batcher)==null||e.generate()}_processTimestamp(e){return e}drawLine(e,t,s,i,n){this.scene.drawLine(e,t,s,i,n)}drawLines(e,t,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLines(e,t,s,i)}drawLineArrays(e,t,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLineArrays(e,t,s,i)}drawWireSphere(e,t,s=k.WHITE,i=20,n=!0,a=this.scene.defaultDrawLayer){this.scene.immediate.drawWireSphere(e,t,s,i,n,a)}drawWireAlignedBox(e,t,s=k.WHITE,i=!0,n=this.scene.defaultDrawLayer,a){this.scene.immediate.drawWireAlignedBox(e,t,s,i,n,a)}drawMeshInstance(e,t=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(null,null,null,e,t)}drawMesh(e,t,s,i=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(t,s,e,null,i)}drawQuad(e,t,s=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(t,e,this.scene.immediate.getQuadMesh(),null,s)}drawTexture(e,t,s,i,n,a,o=this.scene.defaultDrawLayer,l=!0){if(l===!1&&!this.graphicsDevice.isWebGPU)return;const c=new q;c.setTRS(new y(e,t,0),re.IDENTITY,new y(s,-i,0)),a||(a=new Jt,a.cull=Et,a.setParameter("colorMap",n),a.shader=l?this.scene.immediate.getTextureShader():this.scene.immediate.getUnfilterableTextureShader(),a.update()),this.drawQuad(c,a,o)}drawDepthTexture(e,t,s,i,n=this.scene.defaultDrawLayer){const a=new Jt;a.cull=Et,a.shader=this.scene.immediate.getDepthTextureShader(),a.update(),this.drawTexture(e,t,s,i,null,a,n)}destroy(){var e,t,s,i;if(this._inFrameUpdate){this._destroyRequested=!0;return}const n=this.graphicsDevice.canvas.id;this.fire("destroy",this),this.off("librariesloaded"),typeof document<"u"&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.gamepads&&(this.gamepads.destroy(),this.gamepads=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();const a=this.assets.list();for(let l=0;l<a.length;l++)a[l].unload(),a[l].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;const o=this.loader.getHandler("script");o==null||o.clearCache(),this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,(e=this.lightmapper)==null||e.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onPreRenderOpaque=null,this.defaultLayerDepth.onPostRenderOpaque=null,this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,(t=this.xr)==null||t.end(),(s=this.xr)==null||s.destroy(),this.renderer.destroy(),this.renderer=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),(i=this._soundManager)==null||i.destroy(),this._soundManager=null,ns.app=null,gt._applications[n]=null,Ai()===this&&mg(null),gt.cancelTick(this)}static cancelTick(e){e.frameRequestId&&(window.cancelAnimationFrame(e.frameRequestId),e.frameRequestId=void 0)}getEntityFromIndex(e){return this._entityIndex[e]}_registerSceneImmediate(e){this.on("postrender",e.immediate.onPostRender,e.immediate)}}gt._applications={};const s_={},Nk=function(e){const t=e;return function(s,i){var n;if(!t.graphicsDevice)return;t.frameRequestId=null,t._inFrameUpdate=!0,mg(t);const a=t._processTimestamp(s)||Zi(),o=a-(t._time||a);let l=o/1e3;if(l=H.clamp(l,0,t.maxDeltaTime),l*=t.timeScale,t._time=a,(n=t.xr)!=null&&n.session?t.frameRequestId=t.xr.session.requestAnimationFrame(t.tick):t.frameRequestId=Te.browser?window.requestAnimationFrame(t.tick):null,t.graphicsDevice.contextLost)return;t._fillFrameStatsBasic(a,l,o),t.fire("frameupdate",o);let c=!0;if(i){var d;c=(d=t.xr)==null?void 0:d.update(i),t.graphicsDevice.defaultFramebuffer=i.session.renderState.baseLayer.framebuffer}else t.graphicsDevice.defaultFramebuffer=null;c&&(t.update(l),t.fire("framerender"),(t.autoRender||t.renderNextFrame)&&(t.updateCanvasSize(),t.frameStart(),t.render(),t.frameEnd(),t.renderNextFrame=!1),s_.timestamp=Zi(),s_.target=t,t.fire("frameend",s_)),t._inFrameUpdate=!1,t._destroyRequested&&t.destroy()}};class Uk{constructor(){this.elementInput=void 0,this.keyboard=void 0,this.mouse=void 0,this.touch=void 0,this.gamepads=void 0,this.scriptPrefix=void 0,this.assetPrefix=void 0,this.scriptsOrder=void 0,this.soundManager=void 0,this.graphicsDevice=void 0,this.lightmapper=void 0,this.batchManager=void 0,this.xr=void 0,this.componentSystems=[],this.resourceHandlers=[]}}const Ch=new Al;class nT{constructor(e,t){this.scene=e,this.light=t,this.store(),t.numCascades=1,t.type!==fe&&(t._node.getWorldTransform(),t.getBoundingSphere(Ch),this.lightBounds=new Re,this.lightBounds.center.copy(Ch.center),this.lightBounds.halfExtents.set(Ch.radius,Ch.radius,Ch.radius))}store(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades}restore(){const e=this.light;e.mask=this.mask,e.shadowUpdateMode=this.shadowUpdateMode,e.enabled=this.enabled,e.intensity=this.intensity,e._node.setLocalRotation(this.rotation),e.numCascades=this.numCascades}startBake(){this.light.enabled=!0,this.light._destroyShadowMap(),this.light.beginFrame()}endBake(e){const t=this.light;t.enabled=!1,t.shadowMap&&(t.shadowMap.cached&&e.add(t,t.shadowMap),t.shadowMap=null)}}const hu=new M;class zk extends nT{get numVirtualLights(){return this.light.type===fe?this.light.bakeNumSamples:1}prepareVirtualLight(e,t){const s=this.light;if(s._node.setLocalRotation(this.rotation),e>0){const a=s.bakeArea;Cd.circlePointDeterministic(hu,e,t),hu.mulScalar(a*.5),s._node.rotateLocal(hu.x,0,hu.y)}s._node.getWorldTransform();const i=this.scene.gammaCorrection?2.2:1,n=Math.pow(this.intensity,i);s.intensity=Math.pow(n/t,1/i)}}const qS=new y;class KS extends nT{constructor(e){const t=new $("AmbientLight");t.addComponent("light",{type:"directional",affectDynamic:!0,affectLightmapped:!1,bake:!0,bakeNumSamples:e.ambientBakeNumSamples,castShadows:!0,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:xt,color:k.WHITE,intensity:1,bakeDir:!1}),super(e,t.light.light)}get numVirtualLights(){return this.light.bakeNumSamples}prepareVirtualLight(e,t){Cd.spherePointDeterministic(qS,e,t,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt(qS.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);const s=this.scene.gammaCorrection?2.2:1,i=2*Math.PI*this.scene.ambientBakeSpherePart,n=Math.pow(i,s);this.light.intensity=Math.pow(n/t,1/s)}}class cu{constructor(e,t=null){this.node=e,this.component=e.render||e.model,t=t||this.component.meshInstances,this.store(),this.meshInstances=t,this.bounds=null,this.renderTargets=[]}store(){this.castShadows=this.component.castShadows}restore(){this.component.castShadows=this.castShadows}}const YS=15;class Vk{constructor(e){this.device=e,this.shaderDilate=ks(e,W.fullscreenQuadVS,ff.dilatePS,"lmDilate"),this.constantTexSource=e.scope.resolve("source"),this.constantPixelOffset=e.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.shaderDenoise=null,this.sigmas=null,this.constantSigmas=null,this.kernel=null}setSourceTexture(e){this.constantTexSource.setValue(e)}prepare(e,t){this.pixelOffset[0]=1/e,this.pixelOffset[1]=1/t,this.constantPixelOffset.setValue(this.pixelOffset)}prepareDenoise(e,t){this.shaderDenoise||(this.shaderDenoise=ks(this.device,W.fullscreenQuadVS,ff.bilateralDeNoisePS,"lmBilateralDeNoise"),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm")),this.sigmas[0]=e,this.sigmas[1]=t,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(e,t)}evaluateDenoiseUniforms(e,t){function s(o,l){return .39894*Math.exp(-.5*o*o/(l*l))/l}this.kernel=this.kernel||new Float32Array(YS);const i=this.kernel,n=Math.floor((YS-1)/2);for(let o=0;o<=n;++o){const l=s(o,e);i[n+o]=l,i[n-o]=l}this.constantKernel.setValue(this.kernel);const a=1/s(0,t);this.bZnorm.setValue(a)}}class Gk extends Hs{constructor(e,t,s,i,n,a){super(e),this.viewBindGroups=[],this.renderer=t,this.camera=s,this.worldClusters=i,this.receivers=n,this.lightArray=a}destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy()}),this.viewBindGroups.length=0}execute(){this.device;const{renderer:e,camera:t,receivers:s,renderTarget:i,worldClusters:n,lightArray:a}=this;e.renderForwardLayer(t,i,null,void 0,sn,this.viewBindGroups,{meshInstances:s,splitLights:a,lightClusters:n})}}const Hk=2048,Wk=0,jk=1,du=new y;class $k{constructor(e,t,s,i,n){this.device=e,this.root=t,this.scene=s,this.renderer=i,this.assets=n,this.shadowMapCache=i.shadowMapCache,this._tempSet=new Set,this._initCalled=!1,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new k,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}}destroy(){var e;En.decRef(this.blackTex),this.blackTex=null,En.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null,(e=this.camera)==null||e.destroy(),this.camera=null}initBake(e){if(!this._initCalled){this._initCalled=!0,this.lightmapFilters=new Vk(e),this.constantBakeDir=e.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new _e(this.device,{width:4,height:4,format:xe,type:Qi,name:"lightmapBlack"}),En.incRef(this.blackTex);const t=new Ed;t.clearColor.set(0,0,0,0),t.clearColorBuffer=!0,t.clearDepthBuffer=!1,t.clearStencilBuffer=!1,t.frustumCulling=!1,t.projection=Ua,t.aspectRatio=1,t.node=new ze,this.camera=t}if(this.scene.clusteredLightingEnabled){const t=new Jb(e.supportsAreaLights,e.maxTextureSize,()=>{});this.lightingParams=t;const s=this.scene.lighting;t.shadowsEnabled=s.shadowsEnabled,t.shadowAtlasResolution=s.shadowAtlasResolution,t.cookiesEnabled=s.cookiesEnabled,t.cookieAtlasResolution=s.cookieAtlasResolution,t.areaLightsEnabled=s.areaLightsEnabled,t.cells=new y(3,3,3),t.maxLightsPerCell=4,this.worldClusters=new cg(e),this.worldClusters.name="ClusterLightmapper"}}finishBake(e){this.materials=[];function t(s){En.decRef(s.colorBuffer),s.destroy()}this.renderTargets.forEach(s=>{t(s)}),this.renderTargets.clear(),e.forEach(s=>{s.renderTargets.forEach(i=>{t(i)}),s.renderTargets.length=0}),this.ambientAOMaterial=null,this.worldClusters&&(this.worldClusters.destroy(),this.worldClusters=null)}createMaterialForPass(e,t,s,i){const n=new Gs;n.name=`lmMaterial-pass:${s}-ambient:${i}`,n.chunks.APIVersion=b1;const a=`#define UV1LAYOUT
`;if(n.chunks.transformVS=a+W.transformVS,s===Wk){let o=ff.bakeLmEndPS;i?o=`
										dDiffuseLight = ((dDiffuseLight - 0.5) * max(${t.ambientBakeOcclusionContrast.toFixed(1)} + 1.0, 0.0)) + 0.5;
										dDiffuseLight += vec3(${t.ambientBakeOcclusionBrightness.toFixed(1)});
										dDiffuseLight = saturate(dDiffuseLight);
										dDiffuseLight *= dAmbientLight;
								`+o:(n.ambient=new k(0,0,0),n.ambientTint=!0),n.chunks.basePS=W.basePS+(t.lightmapPixelFormat===xe?`
#define LIGHTMAP_RGBM
`:""),n.chunks.endPS=o,n.lightMap=this.blackTex}else n.chunks.basePS=W.basePS+`
uniform sampler2D texture_dirLightMap;
uniform float bakeDir;
`,n.chunks.endPS=ff.bakeDirLmEndPS;return n.chunks.outputAlphaPS=`
`,n.chunks.outputAlphaOpaquePS=`
`,n.chunks.outputAlphaPremulPS=`
`,n.cull=Et,n.forceUv1=!0,n.update(),n}createMaterials(e,t,s){for(let i=0;i<s;i++)this.passMaterials[i]||(this.passMaterials[i]=this.createMaterialForPass(e,t,i,!1));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(e,t,0,!0),this.ambientAOMaterial.onUpdateShader=function(i){return i.litOptions.lightMapWithoutAmbient=!0,i.litOptions.separateAmbient=!0,i})}createTexture(e,t){return new _e(this.device,{width:e,height:e,format:this.scene.lightmapPixelFormat,mipmaps:!1,type:this.scene.lightmapPixelFormat===xe?Qi:ps,minFilter:Ee,magFilter:Ee,addressU:ae,addressV:ae,name:t})}collectModels(e,t,s){var i,n,a;if(!e.enabled)return;let o;if((i=e.model)!=null&&i.model&&(n=e.model)!=null&&n.enabled&&(s&&s.push(new cu(e)),e.model.lightmapped&&t&&(o=e.model.model.meshInstances)),(a=e.render)!=null&&a.enabled&&(s&&s.push(new cu(e)),e.render.lightmapped&&t&&(o=e.render.meshInstances)),o){let l=!0;for(let c=0;c<o.length;c++)if(!o[c].mesh.vertexBuffer.format.hasUv1){l=!1;break}if(l){const c=[];for(let d=0;d<o.length;d++){const h=o[d].mesh;this._tempSet.has(h)?t.push(new cu(e,[o[d]])):c.push(o[d]),this._tempSet.add(h)}this._tempSet.clear(),c.length>0&&t.push(new cu(e,c))}}for(let l=0;l<e._children.length;l++)this.collectModels(e._children[l],t,s)}prepareShadowCasters(e){const t=[];for(let s=0;s<e.length;s++){const i=e[s].component;if(i.castShadows=i.castShadowsLightmap,i.castShadowsLightmap){const n=e[s].meshInstances;for(let a=0;a<n.length;a++)n[a].visibleThisFrame=!0,t.push(n[a])}}return t}updateTransforms(e){for(let t=0;t<e.length;t++){const s=e[t].meshInstances;for(let i=0;i<s.length;i++)s[i].node.getWorldTransform()}}calculateLightmapSize(e){let t;const s=this.scene.lightmapSizeMultiplier||16,i=du;let n,a;e.model?(a=e.model.lightmapSizeMultiplier,e.model.asset?(t=this.assets.get(e.model.asset).data,t.area&&(n=t.area)):e.model._area&&(t=e.model,t._area&&(n=t._area))):e.render&&(a=e.render.lightmapSizeMultiplier,e.render.type!=="asset"&&e.render._area&&(t=e.render,t._area&&(n=t._area)));const o={x:1,y:1,z:1,uv:1};n&&(o.x=n.x,o.y=n.y,o.z=n.z,o.uv=n.uv);const l=a||1;o.x*=l,o.y*=l,o.z*=l;const c=e.render||e.model,d=this.computeNodeBounds(c.meshInstances);i.copy(d.halfExtents);let h=o.x*i.y*i.z+o.y*i.x*i.z+o.z*i.x*i.y;return h/=o.uv,h=Math.sqrt(h),Math.min(H.nextPowerOfTwo(h*s),this.scene.lightmapMaxResolution||Hk)}setLightmapping(e,t,s,i){for(let n=0;n<e.length;n++){const a=e[n],o=a.meshInstances;for(let l=0;l<o.length;l++){const c=o[l];if(c.setLightmapped(t),t){i&&(c._shaderDefs|=i),c.mask=ji;for(let d=0;d<s;d++){const h=a.renderTargets[d].colorBuffer;h.minFilter=nt,h.magFilter=nt,c.setRealtimeLightmap(Fe.lightmapParamNames[d],h)}}}}}bake(e,t=zu){const s=this.device,i=Zi();this.scene._updateSkyMesh(),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;const n=s._shaderStats.linked,a=s._renderTargetCreationTime,o=s._shaderStats.compileTime,l=[],c=[];if(e){for(let h=0;h<e.length;h++)this.collectModels(e[h],l,null);this.collectModels(this.root,null,c)}else this.collectModels(this.root,l,c);if(l.length>0){this.renderer.shadowRenderer.frameUpdate();const h=t===zu?2:1;this.setLightmapping(l,!1,h),this.initBake(s),this.bakeInternal(h,l,c);let u=lf;t===zu&&(u|=Wy),this.scene.ambientBake&&(u|=$y),this.setLightmapping(l,!0,h,u),this.finishBake(l)}const d=Zi();this.stats.totalRenderTime=d-i,this.stats.shadersLinked=s._shaderStats.linked-n,this.stats.compileTime=s._shaderStats.compileTime-o,this.stats.fboTime=s._renderTargetCreationTime-a,this.stats.lightmapCount=l.length}allocateTextures(e,t){for(let s=0;s<e.length;s++){const i=e[s],n=this.calculateLightmapSize(i.node);for(let a=0;a<t;a++){const o=this.createTexture(n,"lightmapper_lightmap_"+s);En.incRef(o),i.renderTargets[a]=new Ct({colorBuffer:o,depth:!1})}if(!this.renderTargets.has(n)){const a=this.createTexture(n,"lightmapper_temp_lightmap_"+n);En.incRef(a),this.renderTargets.set(n,new Ct({colorBuffer:a,depth:!1}))}}}prepareLightsToBake(e,t,s){if(this.scene.ambientBake){const n=new KS(this.scene);s.push(n)}const i=this.renderer.lights;for(let n=0;n<i.length;n++){const a=i[n],o=new zk(this.scene,a);t.push(o),a.enabled&&a.mask&$i&&(a.mask=$i|ji|Fs,a.shadowUpdateMode=a.type===fe?Xy:Ka,s.push(o))}s.sort()}restoreLights(e){for(let t=0;t<e.length;t++)e[t].restore()}setupScene(){this.fog=this.scene.fog,this.ambientLight.copy(this.scene.ambientLight),this.scene.fog=qp,this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants()}restoreScene(){this.scene.fog=this.fog,this.scene.ambientLight.copy(this.ambientLight)}computeNodeBounds(e){const t=new Re;if(e.length>0){t.copy(e[0].aabb);for(let s=1;s<e.length;s++)t.add(e[s].aabb)}return t}computeNodesBounds(e){for(let t=0;t<e.length;t++){const s=e[t].meshInstances;e[t].bounds=this.computeNodeBounds(s)}}computeBounds(e){const t=new Re;for(let s=0;s<e.length;s++){t.copy(e[0].aabb);for(let i=1;i<e.length;i++)t.add(e[i].aabb)}return t}backupMaterials(e){for(let t=0;t<e.length;t++)this.materials[t]=e[t].material}restoreMaterials(e){for(let t=0;t<e.length;t++)e[t].material=this.materials[t]}lightCameraPrepare(e,t){const s=t.light;let i;return s.type===Ge&&(i=s.getRenderData(null,0).shadowCamera,i._node.setPosition(s._node.getPosition()),i._node.setRotation(s._node.getRotation()),i._node.rotateLocal(-90,0,0),i.projection=Gi,i.nearClip=s.attenuationEnd/1e3,i.farClip=s.attenuationEnd,i.aspectRatio=1,i.fov=s._outerConeAngle*2,this.renderer.updateCameraFrustum(i)),i}lightCameraPrepareAndCull(e,t,s,i){const n=e.light;let a=!0;if(n.type===fe){du.copy(i.center),du.y+=i.halfExtents.y,this.camera.node.setPosition(du),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=i.halfExtents.y*2;const o=Math.max(i.halfExtents.x,i.halfExtents.z);this.camera.orthoHeight=o}else e.lightBounds.intersects(t.bounds)||(a=!1);if(n.type===Ge){let o=!1;const l=t.meshInstances;for(let c=0;c<l.length;c++)if(l[c]._isVisible(s)){o=!0;break}o||(a=!1)}return a}setupLightArray(e,t){e[fe].length=0,e[Oe].length=0,e[Ge].length=0,e[t.type][0]=t,t.visibleThisFrame=!0}renderShadowMap(e,t,s,i){const n=i.light,a=this.scene.clusteredLightingEnabled,o=n.castShadows&&(!a||this.scene.lighting.shadowsEnabled);if(!t&&o)if(!n.shadowMap&&!a&&(n.shadowMap=this.shadowMapCache.get(this.device,n)),n.type===fe){this.renderer._shadowRendererDirectional.cull(n,e,this.camera,s);const l=this.renderer._shadowRendererDirectional.getLightRenderPass(n,this.camera);l==null||l.render()}else{if(this.device.isWebGPU)return!0;this.renderer._shadowRendererLocal.cull(n,e,s),this.renderer.shadowRenderer.render(n,this.camera,!1)}return!0}postprocessTextures(e,t,s){const n=this.lightmapFilters.shaderDilate,a=this.scene.lightmapFilterEnabled;a&&this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness),e.setBlendState(Xe.NOBLEND),e.setDepthState(kt.NODEPTH),e.setStencilState(null,null);for(let o=0;o<t.length;o++){const l=t[o];for(let c=0;c<s;c++){const d=l.renderTargets[c],h=d.colorBuffer,u=this.renderTargets.get(h.width),f=u.colorBuffer;this.lightmapFilters.prepare(h.width,h.height);for(let p=0;p<1;p++)this.lightmapFilters.setSourceTexture(h),Ya(e,u,a&&c===0&&p===0?this.lightmapFilters.shaderDenoise:n),this.lightmapFilters.setSourceTexture(f),Ya(e,d,n)}}}bakeInternal(e,t,s){const i=this.scene,n=i.layers,a=this.device,o=i.clusteredLightingEnabled;this.createMaterials(a,i,e),this.setupScene(),n._update(),this.computeNodesBounds(t),this.allocateTextures(t,e),this.renderer.collectLights(n);const l=[],c=[];this.prepareLightsToBake(n,l,c),this.updateTransforms(s);const d=this.prepareShadowCasters(s);this.renderer.updateCpuSkinMatrices(d),this.renderer.gpuUpdate(d);const h=this.computeBounds(d);let u,f,p,_;for(u=0;u<t.length;u++)for(p=t[u].meshInstances,f=0;f<p.length;f++)_=p[f],_.setLightmapped(!1),_.mask=$i,_.setRealtimeLightmap(Fe.lightmapParamNames[0],_.material.lightMap?_.material.lightMap:this.blackTex),_.setRealtimeLightmap(Fe.lightmapParamNames[1],this.blackTex);for(f=0;f<c.length;f++)c[f].light.enabled=!1;const m=[[],[],[]];let g,v,x=!1;for(u=0;u<c.length;u++){const S=c[u],w=S instanceof KS,T=S.light.type===fe;let b=S.numVirtualLights;e>1&&b>1&&S.light.bakeDir&&(b=1);for(let C=0;C<b;C++){b>1&&S.prepareVirtualLight(C,b),S.startBake();let E=!1;const R=this.lightCameraPrepare(a,S);for(v=0;v<t.length;v++){const B=t[v];if(p=B.meshInstances,!this.lightCameraPrepareAndCull(S,B,R,h))continue;this.setupLightArray(m,S.light);const V=T?[]:[S.light];for(o&&this.renderer.lightTextureAtlas.update(V,this.lightingParams),E=this.renderShadowMap(n,E,d,S),o&&this.worldClusters.update(V,this.scene.gammaCorrection,this.lightingParams),this.backupMaterials(p),g=0;g<e&&!(g>0&&C>0||w&&g>0);g++){const I=B.renderTargets[g],F=B.renderTargets[g].colorBuffer.width,D=this.renderTargets.get(F),A=D.colorBuffer;g===0?x=i.updateShaders:x&&(i.updateShaders=!0);let N=this.passMaterials[g];for(w&&C+1===b&&g===0&&(N=this.ambientAOMaterial),f=0;f<p.length;f++)p[f].material=N;if(this.renderer.updateShaders(p),g===jk&&this.constantBakeDir.setValue(S.light.bakeDir?1:0),a.isWebGPU){const U=new Gk(a,this.renderer,this.camera,o?this.worldClusters:null,p,m);U.init(D),U.render(),U.destroy()}else this.renderer.setCamera(this.camera,D,!0),o&&this.worldClusters.activate(),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,p,m,sn),a.updateEnd();for(B.renderTargets[g]=D,this.renderTargets.set(F,I),f=0;f<p.length;f++)_=p[f],_.setRealtimeLightmap(Fe.lightmapParamNames[g],A),_._shaderDefs|=lf}this.restoreMaterials(p)}S.endBake(this.shadowMapCache)}}for(this.postprocessTextures(a,t,e),v=0;v<s.length;v++)s[v].restore();this.restoreLights(l),this.restoreScene(),o||this.shadowMapCache.clear()}}let ge=class rT extends ie{constructor(e,t){super(),this.system=void 0,this.entity=void 0,this.system=e,this.entity=t,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",function(s,i,n){this.fire("set_"+s,s,i,n)}),this.on("set_enabled",this.onSetEnabled,this)}static _buildAccessors(e,t){t.forEach(function(s){const i=typeof s=="object"?s.name:s;Object.defineProperty(e,i,{get:function(){return this.data[i]},set:function(n){const a=this.data,o=a[i];a[i]=n,this.fire("set",i,o,n)},configurable:!0})}),e._accessorsBuilt=!0}buildAccessors(e){rT._buildAccessors(this,e)}onSetEnabled(e,t,s){t!==s&&this.entity.enabled&&(s?this.onEnable():this.onDisable())}onEnable(){}onDisable(){}onPostStateChange(){}get data(){const e=this.system.store[this.entity.getGuid()];return e?e.data:null}};class tt extends ie{constructor(e){super(),this.app=e,this.store={},this.schema=[]}addComponent(e,t={}){const s=new this.ComponentType(this,e),i=new this.DataType;return this.store[e.getGuid()]={entity:e,data:i},e[this.id]=s,e.c[this.id]=s,this.initializeComponentData(s,t,[]),this.fire("add",e,s),s}removeComponent(e){const t=this.store[e.getGuid()],s=e.c[this.id];this.fire("beforeremove",e,s),delete this.store[e.getGuid()],e[this.id]=void 0,delete e.c[this.id],this.fire("remove",e,t.data)}cloneComponent(e,t){const s=this.store[e.getGuid()];return this.addComponent(t,s.data)}initializeComponentData(e,t={},s){for(let i=0,n=s.length;i<n;i++){const a=s[i];let o,l;typeof a=="object"?(o=a.name,l=a.type):(o=a,l=void 0);let c=t[o];c!==void 0?(l!==void 0&&(c=Xk(c,l)),e[o]=c):e[o]=e.data[o]}e.enabled&&e.entity.enabled&&e.onEnable()}getPropertiesOfType(e){const t=[];return(this.schema||[]).forEach(function(i){i&&typeof i=="object"&&i.type===e&&t.push(i)}),t}destroy(){this.off()}}function Xk(r,e){if(!r)return r;switch(e){case"rgb":return r instanceof k?r.clone():new k(r[0],r[1],r[2]);case"rgba":return r instanceof k?r.clone():new k(r[0],r[1],r[2],r[3]);case"vec2":return r instanceof M?r.clone():new M(r[0],r[1]);case"vec3":return r instanceof y?r.clone():new y(r[0],r[1],r[2]);case"vec4":return r instanceof P?r.clone():new P(r[0],r[1],r[2],r[3]);case"boolean":case"number":case"string":return r;case"entity":return r;default:throw new Error("Could not convert unhandled type: "+e)}}const aT=0,_g=1,gg=2;class qk{constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}update(e,t){if(e<this._left||e>=this._right){const s=t.length;if(!s)this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0;else if(e<t[0])this._left=-1/0,this._right=t[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(e>=t[s-1])this._left=t[s-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=s-1;else{const i=this._findKey(e,t);this._left=t[i],this._right=t[i+1],this._len=this._right-this._left;const n=1/this._len;this._recip=isFinite(n)?n:0,this._p0=i,this._p1=i+1}}this._t=this._recip===0?0:(e-this._left)*this._recip,this._hermite.valid=!1}_findKey(e,t){let s=0;for(;e>=t[s+1];)s++;return s}eval(e,t,s){const i=s._data,n=s._components,a=this._p0*n;if(t===aT)for(let o=0;o<n;++o)e[o]=i[a+o];else{const o=this._t,l=this._p1*n;switch(t){case _g:for(let c=0;c<n;++c)e[c]=H.lerp(i[a+c],i[l+c],o);break;case gg:{const c=this._hermite;if(!c.valid){const p=o*o,_=o+o,m=1-o,g=m*m;c.valid=!0,c.p0=(1+_)*g,c.m0=o*g,c.p1=p*(3-_),c.m1=p*(o-1)}const d=(this._p0*3+1)*n,h=(this._p0*3+2)*n,u=(this._p1*3+1)*n,f=(this._p1*3+0)*n;for(let p=0;p<n;++p)e[p]=c.p0*i[d+p]+c.m0*i[h+p]*this._len+c.p1*i[u+p]+c.m1*i[f+p]*this._len;break}}}}}class ZS{constructor(e){this._name=e.name+"Snapshot",this._time=-1,this._cache=[],this._results=[];for(let i=0;i<e._inputs.length;++i)this._cache[i]=new qk;const t=e._curves,s=e._outputs;for(let i=0;i<t.length;++i){const n=t[i],a=s[n._output],o=[];for(let l=0;l<a._components;++l)o[l]=0;this._results[i]=o}}}class jl{constructor(e,t,s,i,n,a){this._name=e.name,this._track=e,this._snapshot=new ZS(e),this._playing=i,this._time=t,this._speed=s,this._loop=n,this._blendWeight=1,this._blendOrder=0,this._eventHandler=a,this.alignCursorToCurrentTime()}set name(e){this._name=e}get name(){return this._name}set track(e){this._track=e,this._snapshot=new ZS(e)}get track(){return this._track}get snapshot(){return this._snapshot}set time(e){this._time=e,this.alignCursorToCurrentTime()}get time(){return this._time}set speed(e){const t=Math.sign(e)!==Math.sign(this._speed);this._speed=e,t&&this.alignCursorToCurrentTime()}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}set blendWeight(e){this._blendWeight=e}get blendWeight(){return this._blendWeight}set blendOrder(e){this._blendOrder=e}get blendOrder(){return this._blendOrder}set eventCursor(e){this._eventCursor=e}get eventCursor(){return this._eventCursor}get eventCursorEnd(){return this.isReverse?0:this._track.events.length-1}get nextEvent(){return this._track.events[this._eventCursor]}get isReverse(){return this._speed<0}nextEventAheadOfTime(e){return this.nextEvent?this.isReverse?this.nextEvent.time<=e:this.nextEvent.time>=e:!1}nextEventBehindTime(e){return this.nextEvent?e===this.track.duration?this.isReverse?this.nextEvent.time>=e:this.nextEvent.time<=e:this.isReverse?this.nextEvent.time>e:this.nextEvent.time<e:!1}resetEventCursor(){this._eventCursor=this.isReverse?this._track.events.length-1:0}moveEventCursor(){this._eventCursor+=this.isReverse?-1:1,this._eventCursor>=this.track.events.length?this._eventCursor=0:this._eventCursor<0&&(this._eventCursor=this.track.events.length-1)}clipFrameTime(e){const t=jl.eventFrame;t.start=0,t.end=e,t.residual=0,this.isReverse?e<0&&(t.start=this.track.duration,t.end=0,t.residual=e+this.track.duration):e>this.track.duration&&(t.start=0,t.end=this.track.duration,t.residual=e-this.track.duration)}alignCursorToCurrentTime(){for(this.resetEventCursor();this.nextEventBehindTime(this._time)&&this._eventCursor!==this.eventCursorEnd;)this.moveEventCursor()}fireNextEvent(){this._eventHandler.fire(this.nextEvent.name,Ft({track:this.track},this.nextEvent)),this.moveEventCursor()}fireNextEventInFrame(e,t){return this.nextEventAheadOfTime(e)&&this.nextEventBehindTime(t)?(this.fireNextEvent(),!0):!1}activeEventsForFrame(e,t){const s=jl.eventFrame;this.clipFrameTime(t);const i=this.eventCursor;for(;this.fireNextEventInFrame(e,s.end)&&i!==this.eventCursor;);this.loop&&Math.abs(s.residual)>0&&this.activeEventsForFrame(s.start,s.residual)}progressForTime(e){return e*this._speed/this._track.duration}_update(e){if(this._playing){let t=this._time;const s=this._track.duration,i=this._speed,n=this._loop;this._track.events.length>0&&s>0&&this.activeEventsForFrame(t,t+i*e),t+=i*e,i>=0?t>s&&(n?t=t%s||0:(t=this._track.duration,this.pause())):t<0&&(n?t=s+(t%s||0):(t=0,this.pause())),this._time=t}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)}play(){this._playing=!0,this._time=0}stop(){this._playing=!1,this._time=0}pause(){this._playing=!1}resume(){this._playing=!0}reset(){this._time=0}}jl.eventFrame={start:0,end:0,residual:0};const oT="NONE",Kk="PREV_STATE",Yk="NEXT_STATE",Zk="PREV_STATE_NEXT_STATE",Jk="NEXT_STATE_PREV_STATE",Qk="GREATER_THAN",eB="LESS_THAN",tB="GREATER_THAN_EQUAL_TO",sB="LESS_THAN_EQUAL_TO",iB="EQUAL_TO",nB="NOT_EQUAL_TO",JS="INTEGER",QS="FLOAT",ex="BOOLEAN",ju="TRIGGER",rB="1D",aB="2D_DIRECTIONAL",oB="2D_CARTESIAN",lB="DIRECT",Gh="START",yg="END",pa="ANY",gf=[Gh,yg,pa],lT="OVERWRITE",hB="ADDITIVE";class Kt{static dot(e,t){const s=e.length;let i=0;for(let n=0;n<s;++n)i+=e[n]*t[n];return i}static normalize(e){let t=Kt.dot(e,e);if(t>0){t=1/Math.sqrt(t);const s=e.length;for(let i=0;i<s;++i)e[i]*=t}}static set(e,t,s){const i=e.length;if(s==="quaternion"){let n=Kt.dot(t,t);n>0&&(n=1/Math.sqrt(n));for(let a=0;a<i;++a)e[a]=t[a]*n}else for(let n=0;n<i;++n)e[n]=t[n]}static blendVec(e,t,s,i){const n=i?1:1-s,a=e.length;for(let o=0;o<a;++o)e[o]=e[o]*n+t[o]*s}static blendQuat(e,t,s,i){const n=e.length,a=i?1:1-s;Kt.dot(e,t)<0&&(s=-s);for(let o=0;o<n;++o)e[o]=e[o]*a+t[o]*s;i||Kt.normalize(e)}static blend(e,t,s,i,n){i==="quaternion"?Kt.blendQuat(e,t,s,n):Kt.blendVec(e,t,s,n)}static stableSort(e,t){const s=e.length;for(let i=0;i<s-1;++i)for(let n=i+1;n<s;++n)if(t(e[n],e[i])){const a=e[i];e[i]=e[n],e[n]=a}}}class $e{constructor(e,t){this._component=e,this.mask=new Int8Array(e.layers.length),this.weights=new Float32Array(e.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=t,this.dirty=!0,this.value=t===$e.TYPE_QUAT?[0,0,0,1]:[0,0,0],this.baseValue=null,this.setter=null}get _normalizeWeights(){return this._component.normalizeWeights}getWeight(e){return this.dirty&&this.updateWeights(),this._normalizeWeights&&this.totalWeight===0||!this.mask[e]?0:this._normalizeWeights?this.weights[e]/this.totalWeight:H.clamp(this.weights[e],0,1)}_layerBlendType(e){return this._component.layers[e].blendType}setMask(e,t){this.mask[e]=t,this._normalizeWeights&&(this._component.layers[e].blendType===lT&&(this.mask=this.mask.fill(0,0,e)),this.dirty=!0)}updateWeights(){this.totalWeight=0;for(let e=0;e<this.weights.length;e++)this.weights[e]=this._component.layers[e].weight,this.totalWeight+=this.mask[e]*this.weights[e];this.dirty=!1}updateValue(e,t){if(this.counter===0&&(Kt.set(this.value,$e.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||Kt.blend(this.value,this.baseValue,1,this.valueType)),!(!this.mask[e]||this.getWeight(e)===0)){if(this._layerBlendType(e)===hB&&!this._normalizeWeights)if(this.valueType===$e.TYPE_QUAT){const s=$e.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),i=$e.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),n=$e.q3.set(t[0],t[1],t[2],t[3]),a=i.invert().mul(n);a.slerp(re.IDENTITY,a,this.getWeight(e)),s.mul(a),$e.quatArr[0]=s.x,$e.quatArr[1]=s.y,$e.quatArr[2]=s.z,$e.quatArr[3]=s.w,Kt.set(this.value,$e.quatArr,this.valueType)}else $e.vecArr[0]=t[0]-this.baseValue[0],$e.vecArr[1]=t[1]-this.baseValue[1],$e.vecArr[2]=t[2]-this.baseValue[2],Kt.blend(this.value,$e.vecArr,this.getWeight(e),this.valueType,!0);else Kt.blend(this.value,t,this.getWeight(e),this.valueType);this.setter&&this.setter(this.value)}}unbind(){this.setter&&this.setter(this.baseValue)}}$e.TYPE_QUAT="quaternion";$e.TYPE_VEC3="vector3";$e.q1=new re;$e.q2=new re;$e.q3=new re;$e.quatArr=[0,0,0,1];$e.vecArr=[0,0,0];$e.IDENTITY_QUAT_ARR=[0,0,0,1];class hT{constructor(e){this._binder=e,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}get clips(){return this._clips}addClip(e){const t=this._targets,s=this._binder,i=e.track.curves,n=e.snapshot,a=[],o=[];for(let l=0;l<i.length;++l){const d=i[l].paths;for(let h=0;h<d.length;++h){const u=d[h],f=s.resolve(u);let p=t[f&&f.targetPath||null];if(!p&&f){p={target:f,value:[],curves:0,blendCounter:0};for(let _=0;_<p.target.components;++_)p.value.push(0);if(t[f.targetPath]=p,s.animComponent){if(!s.animComponent.targets[f.targetPath]){let _;f.targetPath.substring(f.targetPath.length-13)==="localRotation"?_=$e.TYPE_QUAT:_=$e.TYPE_VEC3,s.animComponent.targets[f.targetPath]=new $e(s.animComponent,_)}s.animComponent.targets[f.targetPath].layerCounter++,s.animComponent.targets[f.targetPath].setMask(s.layerIndex,1)}}p&&(p.curves++,a.push(n._results[l]),o.push(p))}}this._clips.push(e),this._inputs.push(a),this._outputs.push(o)}removeClip(e){const t=this._targets,s=this._binder,i=this._clips,a=i[e].track.curves;for(let o=0;o<a.length;++o){const c=a[o].paths;for(let d=0;d<c.length;++d){const h=c[d],u=this._binder.resolve(h);u&&(u.curves--,u.curves===0&&(s.unresolve(h),delete t[u.targetPath],s.animComponent&&s.animComponent.targets[u.targetPath].layerCounter--))}}i.splice(e,1),this._inputs.splice(e,1),this._outputs.splice(e,1)}removeClips(){for(;this._clips.length>0;)this.removeClip(0)}updateClipTrack(e,t){this._clips.forEach(s=>{s.name.includes(e)&&(s.track=t)}),this.rebind()}findClip(e){const t=this._clips;for(let s=0;s<t.length;++s){const i=t[s];if(i.name===e)return i}return null}rebind(){this._binder.rebind(),this._targets={};const e=[...this.clips];this.removeClips(),e.forEach(t=>{this.addClip(t)})}assignMask(e){return this._binder.assignMask(e)}update(e,t=!0){const s=this._clips,i=s.map(function(o,l){return l});Kt.stableSort(i,function(o,l){return s[o].blendOrder<s[l].blendOrder});for(let o=0;o<i.length;++o){const l=i[o],c=s[l],d=this._inputs[l],h=this._outputs[l],u=c.blendWeight;if(u>0&&c._update(e),!t)break;let f,p,_;if(u>=1)for(let m=0;m<d.length;++m)f=d[m],p=h[m],_=p.value,Kt.set(_,f,p.target.type),p.blendCounter++;else if(u>0)for(let m=0;m<d.length;++m)f=d[m],p=h[m],_=p.value,p.blendCounter===0?Kt.set(_,f,p.target.type):Kt.blend(_,f,u,p.target.type),p.blendCounter++}const n=this._targets,a=this._binder;for(const o in n)if(n.hasOwnProperty(o)){const l=n[o];if(a.animComponent&&l.target.isTransform){const c=a.animComponent.targets[o];c.counter===c.layerCounter&&(c.counter=0),c.path||(c.path=o,c.baseValue=l.target.get(),c.setter=l.target.set),c.updateValue(a.layerIndex,l.value),c.counter++}else l.target.set(l.value);l.blendCounter=0}this._binder.update(e)}}class cT{constructor(e){this._events=[...e],this._events.sort((t,s)=>t.time-s.time)}get events(){return this._events}}var dT;class qn{constructor(e,t,s,i,n,a=new cT([])){this._name=e,this._duration=t,this._inputs=s,this._outputs=i,this._curves=n,this._animEvents=a}get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}set events(e){this._animEvents=e}get events(){return this._animEvents.events}eval(e,t){t._time=e;const s=this._inputs,i=this._outputs,n=this._curves,a=t._cache,o=t._results;for(let l=0;l<s.length;++l)a[l].update(e,s[l]._data);for(let l=0;l<n.length;++l){const c=n[l],d=i[c._output],h=o[l];a[c._input].eval(h,c._interpolation,d)}}}dT=qn;qn.EMPTY=Object.freeze(new dT("empty",Number.MAX_VALUE,[],[],[]));class el{static joinPath(e,t){t=t||".";const s=function(n){return n.replace(/\\/g,"\\\\").replace(new RegExp("\\"+t,"g"),"\\"+t)};return e.map(s).join(t)}static splitPath(e,t){t=t||".";const s=[];let i="",n=0;for(;n<e.length;){let a=e[n++];a==="\\"&&n<e.length?(a=e[n++],a==="\\"||a===t?i+=a:i+="\\"+a):a===t?(s.push(i),i=""):i+=a}return i.length>0&&s.push(i),s}static encode(e,t,s){return`${Array.isArray(e)?e.join("/"):e}/${t}/${Array.isArray(s)?s.join("/"):s}`}resolve(e){return null}unresolve(e){}update(e){}}class vg{constructor(e,t,s,i){e.set?(this._set=e.set,this._get=e.get):this._set=e,this._type=t,this._components=s,this._targetPath=i,this._isTransform=this._targetPath.substring(this._targetPath.length-13)==="localRotation"||this._targetPath.substring(this._targetPath.length-13)==="localPosition"||this._targetPath.substring(this._targetPath.length-10)==="localScale"}get set(){return this._set}get get(){return this._get}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}}class xr{constructor(e){if(this._isPathInMask=(n,a)=>{const o=this._mask[n];if(o){if(o.children||a&&o.value!==!1)return!0}else return!1;return!1},this.graph=e,!e)return;this._mask=null;const t={};(function n(a){t[a.name]=a;for(let o=0;o<a.children.length;++o)n(a.children[o])})(e),this.nodes=t,this.targetCache={};const i=function(a){let o=a;for(;o&&!(o instanceof $);)o=o.parent;let l;return o&&(o.render?l=o.render.meshInstances:o.model&&(l=o.model.meshInstances)),l};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(n){const a=n.localPosition,o=function(c){a.set(...c)};return xr.createAnimTarget(o,"vector",3,n,"localPosition")},localRotation:function(n){const a=n.localRotation,o=function(c){a.set(...c)};return xr.createAnimTarget(o,"quaternion",4,n,"localRotation")},localScale:function(n){const a=n.localScale,o=function(c){a.set(...c)};return xr.createAnimTarget(o,"vector",3,n,"localScale")},weight:function(n,a){a.indexOf("name.")===0?a=a.replace("name.",""):a=Number(a);const o=i(n);let l;if(o){for(let c=0;c<o.length;++c)if(o[c].node.name===n.name&&o[c].morphInstance){const d=o[c].morphInstance,h=u=>{d.setWeight(a,u[0])};l||(l=[]),l.push(h)}}if(l){const c=d=>{for(let h=0;h<l.length;++h)l[h](d)};return xr.createAnimTarget(c,"number",1,n,`weight.${a}`)}return null},materialTexture:(n,a)=>{const o=i(n);if(o){let l;for(let c=0;c<o.length;++c)if(o[c].node.name===n.name){l=o[c];break}if(l){const c=d=>{const h=this.animComponent.system.app.assets.get(d[0]);h&&h.resource&&h.type==="texture"&&(l.material[a]=h.resource,l.material.update())};return xr.createAnimTarget(c,"vector",1,n,"materialTexture","material")}}return null}}}_isPathActive(e){if(!this._mask)return!0;const t=[e.entityPath[0],this.graph.name];for(let s=0;s<t.length;++s){let i=t[s];if(this._isPathInMask(i,e.entityPath.length===1))return!0;for(let n=1;n<e.entityPath.length;n++)if(i+="/"+e.entityPath[n],this._isPathInMask(i,n===e.entityPath.length-1))return!0}return!1}findNode(e){if(!this._isPathActive(e))return null;let t;return this.graph&&(t=this.graph.findByPath(e.entityPath),t||(t=this.graph.findByPath(e.entityPath.slice(1)))),t||(t=this.nodes[e.entityPath[e.entityPath.length-1]||""]),t}static createAnimTarget(e,t,s,i,n,a){const o=el.encode(i.path,a||"entity",n);return new vg(e,t,s,o)}resolve(e){const t=el.encode(e.entityPath,e.component,e.propertyPath);let s=this.targetCache[t];if(s)return s;const i=this.findNode(e);if(!i)return null;const n=this.handlers[e.propertyPath];return!n||(s=n(i),!s)?null:(this.targetCache[t]=s,this.nodeCounts[i.path]?this.nodeCounts[i.path]++:(this.activeNodes.push(i),this.nodeCounts[i.path]=1),s)}unresolve(e){if(e.component!=="graph")return;const t=this.nodes[e.entityPath[e.entityPath.length-1]||""];if(this.nodeCounts[t.path]--,this.nodeCounts[t.path]===0){const s=this.activeNodes,i=s.indexOf(t.node),n=s.length;i<n-1&&(s[i]=s[n-1]),s.pop()}}update(e){const t=this.activeNodes;for(let s=0;s<t.length;++s)t[s]._dirtifyLocal()}assignMask(e){return e!==this._mask?(this._mask=e,!0):!1}}class uT extends ge{constructor(e,t){super(e,t),this._animations={},this._assets=[],this._loop=!0,this.animEvaluator=null,this.model=null,this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animationsIndex={},this.prevAnim=null,this.currAnim=null,this.blend=0,this.blending=!1,this.blendSpeed=0,this.activate=!0,this.speed=1}set animations(e){this._animations=e,this.onSetAnimations()}get animations(){return this._animations}set assets(e){const t=this._assets;if(t&&t.length){for(let i=0;i<t.length;i++)if(t[i]){const n=this.system.app.assets.get(t[i]);if(n){n.off("change",this.onAssetChanged,this),n.off("remove",this.onAssetRemoved,this);const a=this.animationsIndex[n.id];this.currAnim===a&&this._stopCurrentAnimation(),delete this.animations[a],delete this.animationsIndex[n.id]}}}this._assets=e;const s=e.map(i=>i instanceof ne?i.id:i);this.loadAnimationAssets(s)}get assets(){return this._assets}set currentTime(e){if(this.skeleton&&(this.skeleton.currentTime=e,this.skeleton.addTime(0),this.skeleton.updateGraph()),this.animEvaluator){const t=this.animEvaluator.clips;for(let s=0;s<t.length;++s)t[s].time=e}}get currentTime(){if(this.skeleton)return this.skeleton._time;if(this.animEvaluator){const e=this.animEvaluator.clips;if(e.length>0)return e[e.length-1].time}return 0}get duration(){return this.currAnim?this.animations[this.currAnim].duration:0}set loop(e){if(this._loop=e,this.skeleton&&(this.skeleton.looping=e),this.animEvaluator)for(let t=0;t<this.animEvaluator.clips.length;++t)this.animEvaluator.clips[t].loop=e}get loop(){return this._loop}play(e,t=0){if(!(!this.enabled||!this.entity.enabled)&&this.animations[e]){if(this.prevAnim=this.currAnim,this.currAnim=e,this.model){!this.skeleton&&!this.animEvaluator&&this._createAnimationController();const s=this.animations[this.prevAnim],i=this.animations[this.currAnim];if(this.blending=t>0&&!!this.prevAnim,this.blending&&(this.blend=0,this.blendSpeed=1/t),this.skeleton&&(this.blending?(this.fromSkel.animation=s,this.fromSkel.addTime(this.skeleton._time),this.toSkel.animation=i):this.skeleton.animation=i),this.animEvaluator){const n=this.animEvaluator;if(this.blending)for(;n.clips.length>1;)n.removeClip(0);else this.animEvaluator.removeClips();const a=new jl(this.animations[this.currAnim],0,1,!0,this.loop);a.name=this.currAnim,a.blendWeight=this.blending?0:1,a.reset(),this.animEvaluator.addClip(a)}}this.playing=!0}}getAnimation(e){return this.animations[e]}setModel(e){e!==this.model&&(this._resetAnimationController(),this.model=e,this.animations&&this.currAnim&&this.animations[this.currAnim]&&this.play(this.currAnim))}onSetAnimations(){const e=this.entity.model;if(e){const t=e.model;t&&t!==this.model&&this.setModel(t)}if(!this.currAnim&&this.activate&&this.enabled&&this.entity.enabled){const t=Object.keys(this._animations);t.length>0&&this.play(t[0])}}_resetAnimationController(){this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null}_createAnimationController(){const e=this.model,t=this.animations;let s=!1,i=!1;for(const a in t)t.hasOwnProperty(a)&&(t[a].constructor===qn?i=!0:s=!0);const n=e.getGraph();s?(this.fromSkel=new Ki(n),this.toSkel=new Ki(n),this.skeleton=new Ki(n),this.skeleton.looping=this.loop,this.skeleton.setGraph(n)):i&&(this.animEvaluator=new hT(new xr(this.entity)))}loadAnimationAssets(e){if(!e||!e.length)return;const t=this.system.app.assets,s=n=>{if(n.resources.length>1)for(let a=0;a<n.resources.length;a++)this.animations[n.resources[a].name]=n.resources[a],this.animationsIndex[n.id]=n.resources[a].name;else this.animations[n.name]=n.resource,this.animationsIndex[n.id]=n.name;this.animations=this.animations},i=n=>{n.off("change",this.onAssetChanged,this),n.on("change",this.onAssetChanged,this),n.off("remove",this.onAssetRemoved,this),n.on("remove",this.onAssetRemoved,this),n.resource?s(n):(n.once("load",s,this),this.enabled&&this.entity.enabled&&t.load(n))};for(let n=0,a=e.length;n<a;n++){const o=t.get(e[n]);o?i(o):t.on("add:"+e[n],i)}}onAssetChanged(e,t,s,i){if(t==="resource"||t==="resources")if(t==="resources"&&s&&s.length===0&&(s=null),s){let n=!1;if(s.length>1){if(i&&i.length>1)for(let a=0;a<i.length;a++)delete this.animations[i[a].name];else delete this.animations[e.name];n=!1;for(let a=0;a<s.length;a++)this.animations[s[a].name]=s[a],!n&&this.currAnim===s[a].name&&this.playing&&this.enabled&&this.entity.enabled&&(n=!0,this.play(s[a].name));n||(this._stopCurrentAnimation(),this.onSetAnimations())}else{if(i&&i.length>1)for(let a=0;a<i.length;a++)delete this.animations[i[a].name];this.animations[e.name]=s[0]||s,n=!1,this.currAnim===e.name&&this.playing&&this.enabled&&this.entity.enabled&&(n=!0,this.play(e.name)),n||(this._stopCurrentAnimation(),this.onSetAnimations())}this.animationsIndex[e.id]=e.name}else{if(i.length>1)for(let n=0;n<i.length;n++)delete this.animations[i[n].name],this.currAnim===i[n].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id]}}onAssetRemoved(e){if(e.off("remove",this.onAssetRemoved,this),this.animations){if(e.resources.length>1)for(let t=0;t<e.resources.length;t++)delete this.animations[e.resources[t].name],this.currAnim===e.resources[t].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id]}}_stopCurrentAnimation(){if(this.currAnim=null,this.playing=!1,this.skeleton&&(this.skeleton.currentTime=0,this.skeleton.animation=null),this.animEvaluator){for(let e=0;e<this.animEvaluator.clips.length;++e)this.animEvaluator.clips[e].stop();this.animEvaluator.update(0),this.animEvaluator.removeClips()}}onEnable(){super.onEnable();const e=this.assets,t=this.system.app.assets;if(e)for(let s=0,i=e.length;s<i;s++){let n=e[s];n instanceof ne||(n=t.get(n)),n&&!n.resource&&t.load(n)}if(this.activate&&!this.currAnim){const s=Object.keys(this.animations);s.length>0&&this.play(s[0])}}onBeforeRemove(){for(let e=0;e<this.assets.length;e++){let t=this.assets[e];typeof t=="number"&&(t=this.system.app.assets.get(t)),t&&(t.off("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this))}this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null}update(e){if(this.blending&&(this.blend+=e*this.blendSpeed,this.blend>=1&&(this.blend=1)),this.playing){const s=this.skeleton;if(s!==null&&this.model!==null){if(this.blending)s.blend(this.fromSkel,this.toSkel,this.blend);else{const i=e*this.speed;s.addTime(i),this.speed>0&&s._time===s.animation.duration&&!this.loop?this.playing=!1:this.speed<0&&s._time===0&&!this.loop&&(this.playing=!1)}this.blending&&this.blend===1&&(s.animation=this.toSkel.animation),s.updateGraph()}}const t=this.animEvaluator;if(t){for(let s=0;s<t.clips.length;++s){const i=t.clips[s];i.speed=this.speed,this.playing?i.resume():i.pause()}this.blending&&t.clips.length>1&&(t.clips[1].blendWeight=this.blend),t.update(e)}this.blending&&this.blend===1&&(this.blending=!1)}}class cB{constructor(){this.enabled=!0}}const Sg=["enabled"];class dB extends tt{constructor(e){super(e),this.id="animation",this.ComponentType=uT,this.DataType=cB,this.schema=Sg,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){s=["activate","enabled","loop","speed","assets"];for(const i of s)t.hasOwnProperty(i)&&(e[i]=t[i]);super.initializeComponentData(e,t,Sg)}cloneComponent(e,t){this.addComponent(t,{}),t.animation.assets=e.animation.assets.slice(),t.animation.speed=e.animation.speed,t.animation.loop=e.animation.loop,t.animation.activate=e.animation.activate,t.animation.enabled=e.animation.enabled;const s={},i=e.animation.animations;for(const o in i)i.hasOwnProperty(o)&&(s[o]=i[o]);t.animation.animations=s;const n={},a=e.animation.animationsIndex;for(const o in a)a.hasOwnProperty(o)&&(n[o]=a[o]);return t.animation.animationsIndex=n,t.animation}onBeforeRemove(e,t){t.onBeforeRemove()}onUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s];i.data.enabled&&i.entity.enabled&&i.entity.animation.update(e)}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}ge._buildAccessors(uT.prototype,Sg);class Bc{constructor(e,t,s,i,n=1){this._state=e,this._parent=t,this._name=s,Array.isArray(i)?(this._point=new M(i[0],i[1]),this._pointLength=this._point.length()):(this._point=i,this._pointLength=i),this._speed=n,this._weightedSpeed=1,this._weight=1,this._animTrack=null}get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?this._parent.path+"."+this._name:this._name}get point(){return this._point}get pointLength(){return this._pointLength}set weight(e){this._weight=e}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}get normalizedWeight(){const e=this._state.totalWeight;return e===0?0:this.weight/e}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}set weightedSpeed(e){this._weightedSpeed=e}get weightedSpeed(){return this._weightedSpeed}set animTrack(e){this._animTrack=e}get animTrack(){return this._animTrack}}class ih extends Bc{constructor(e,t,s,i,n,a,o,l,c){super(e,t,s,i),this._parameters=n,this._parameterValues=new Array(n.length),this._children=[],this._findParameter=c,this._syncAnimations=o!==!1,this._pointCache={};for(let d=0;d<a.length;d++){const h=a[d];h.children?this._children.push(l(h.type,this,null,s,1,h.parameter?[h.parameter]:h.parameters,h.children,l,c)):this._children.push(new Bc(e,this,h.name,h.point,h.speed))}}get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(e){for(let t=0;t<this._children.length;t++)if(this._children[t].name===e)return this._children[t];return null}updateParameterValues(){let e=!0;for(let t=0;t<this._parameterValues.length;t++){const s=this._findParameter(this._parameters[t]).value;this._parameterValues[t]!==s&&(this._parameterValues[t]=s,e=!1)}return e}getNodeWeightedDuration(e){return this._children[e].animTrack.duration/this._children[e].speedMultiplier*this._children[e].weight}getNodeCount(){let e=0;for(let t=0;t<this._children.length;t++)this._children[t].constructor===ih?e+=this._children[t].getNodeCount():e++;return e}}class uB extends ih{constructor(e,t,s,i,n,a,o,l,c){a.sort((d,h)=>d.point-h.point),super(e,t,s,i,n,a,o,l,c)}calculateWeights(){if(this.updateParameterValues())return;let e=0;this._children[0].weight=0;for(let t=0;t<this._children.length;t++){const s=this._children[t];if(t!==this._children.length-1){const i=this._children[t+1];if(s.point===i.point)s.weight=.5,i.weight=.5;else if(H.between(this._parameterValues[0],s.point,i.point,!0)){const n=Math.abs(s.point-i.point),a=Math.abs(s.point-this._parameterValues[0]),o=(n-a)/n;s.weight=o,i.weight=1-o}else i.weight=0}this._syncAnimations&&(e+=s.animTrack.duration/s.absoluteSpeed*s.weight)}if(this._syncAnimations)for(let t=0;t<this._children.length;t++){const s=this._children[t];s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/e}}}class Mn extends ih{pointDistanceCache(e,t){const s=`${e}${t}`;return this._pointCache[s]||(this._pointCache[s]=this._children[t].point.clone().sub(this._children[e].point)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let e,t;Mn._p.set(...this._parameterValues),e=0,t=0;for(let s=0;s<this._children.length;s++){const i=this._children[s],n=i.point;Mn._pip.set(Mn._p.x,Mn._p.y).sub(n);let a=Number.MAX_VALUE;for(let o=0;o<this._children.length;o++){if(s===o)continue;const l=this.pointDistanceCache(s,o),c=H.clamp(1-Mn._pip.dot(l)/l.lengthSq(),0,1);c<a&&(a=c)}i.weight=a,e+=a,this._syncAnimations&&(t+=i.animTrack.duration/i.absoluteSpeed*i.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];i.weight=i._weight/e,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/t)}}}Mn._p=new M;Mn._pip=new M;class In extends ih{pointCache(e,t){const s=`${e}${t}`;return this._pointCache[s]||(this._pointCache[s]=new M((this._children[t].pointLength-this._children[e].pointLength)/((this._children[t].pointLength+this._children[e].pointLength)/2),M.angleRad(this._children[e].point,this._children[t].point)*2)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let e,t;In._p.set(...this._parameterValues);const s=In._p.length();e=0,t=0;for(let i=0;i<this._children.length;i++){const n=this._children[i],a=n.point,o=n.pointLength;let l=Number.MAX_VALUE;for(let c=0;c<this._children.length;c++){if(i===c)continue;const d=this.pointCache(i,c),h=this._children[c].pointLength;In._pip.set((s-o)/((h+o)/2),M.angleRad(a,In._p)*2);const u=H.clamp(1-Math.abs(In._pip.dot(d)/d.lengthSq()),0,1);u<l&&(l=u)}n.weight=l,e+=l,this._syncAnimations&&(t+=n.animTrack.duration/n.absoluteSpeed*n.weight)}for(let i=0;i<this._children.length;i++){const n=this._children[i];if(n.weight=n._weight/e,this._syncAnimations){const a=n.animTrack.duration/t*e;n.weightedSpeed=n.absoluteSpeed*a}}}}In._p=new M;In._pip=new M;class fB extends ih{calculateWeights(){if(this.updateParameterValues())return;let e=0,t=0;for(let s=0;s<this._children.length;s++)if(e+=Math.max(this._parameterValues[s],0),this._syncAnimations){const i=this._children[s];t+=i.animTrack.duration/i.absoluteSpeed*i.weight}for(let s=0;s<this._children.length;s++){const i=this._children[s],n=Math.max(this._parameterValues[s],0);e?(i.weight=n/e,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/t)):(i.weight=0,this._syncAnimations&&(i.weightedSpeed=0))}}}class tx{constructor(e,t,s=1,i=!0,n){this._animations={},this._animationList=[],this._controller=e,this._name=t,this._speed=s,this._loop=i,this._hasAnimations=!1,n?this._blendTree=this._createTree(n.type,this,null,t,1,n.parameter?[n.parameter]:n.parameters,n.children,n.syncAnimations,this._createTree,this._controller.findParameter):this._blendTree=new Bc(this,null,t,1,s)}_createTree(e,t,s,i,n,a,o,l,c,d){switch(e){case rB:return new uB(t,s,i,n,a,o,l,c,d);case oB:return new Mn(t,s,i,n,a,o,l,c,d);case aB:return new In(t,s,i,n,a,o,l,c,d);case lB:return new fB(t,s,i,n,a,o,l,c,d)}}_getNodeFromPath(e){let t=this._blendTree;for(let s=1;s<e.length;s++)t=t.getChild(e[s]);return t}addAnimation(e,t){const s=e.join("."),i=this._animationList.findIndex(function(n){return n.path===s});if(i>=0)this._animationList[i].animTrack=t;else{const n=this._getNodeFromPath(e);n.animTrack=t,this._animationList.push(n)}this._updateHasAnimations()}_updateHasAnimations(){this._hasAnimations=this._animationList.length>0&&this._animationList.every(e=>e.animTrack&&e.animTrack!==qn.EMPTY)}get name(){return this._name}set animations(e){this._animationList=e,this._updateHasAnimations()}get animations(){return this._animationList}get hasAnimations(){return this._hasAnimations}set speed(e){this._speed=e}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}get nodeCount(){return!this._blendTree||this._blendTree.constructor===Bc?1:this._blendTree.getNodeCount()}get playable(){return gf.indexOf(this.name)!==-1||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){const e=this.name+"."+this.animations[0].animTrack.name,t=this._controller.animEvaluator.findClip(e);if(t)return t.loop}return!1}get totalWeight(){let e=0;for(let t=0;t<this.animations.length;t++)e+=this.animations[t].weight;return e}get timelineDuration(){let e=0;for(let t=0;t<this.animations.length;t++){const s=this.animations[t];s.animTrack.duration>e&&(e=s.animTrack.duration)}return e}}class yf{constructor({from:e,to:t,time:s=0,priority:i=0,conditions:n=[],exitTime:a=null,transitionOffset:o=null,interruptionSource:l=oT}){this._from=e,this._to=t,this._time=s,this._priority=i,this._conditions=n,this._exitTime=a,this._transitionOffset=o,this._interruptionSource=l}get from(){return this._from}set to(e){this._to=e}get to(){return this._to}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return!!this.exitTime}}class pB{constructor(e,t,s,i,n,a,o){this.findParameter=l=>this._findParameter(l),this._animEvaluator=e,this._states={},this._stateNames=[],this._eventHandler=n,this._findParameter=a,this._consumeTrigger=o;for(let l=0;l<t.length;l++)this._states[t[l].name]=new tx(this,t[l].name,t[l].speed,t[l].loop,t[l].blendTree),this._stateNames.push(t[l].name);this._transitions=s.map(l=>new yf(Ft({},l))),this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._previousStateName=null,this._activeStateName=Gh,this._activeStateDuration=0,this._activeStateDurationDirty=!0,this._playing=!1,this._activate=i,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource=oT,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0}get animEvaluator(){return this._animEvaluator}set activeState(e){this._activeStateName=e}get activeState(){return this._findState(this._activeStateName)}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}set previousState(e){this._previousStateName=e}get previousState(){return this._findState(this._previousStateName)}get previousStateName(){return this._previousStateName}get playable(){let e=!0;for(let t=0;t<this._stateNames.length;t++)this._states[this._stateNames[t]].playable||(e=!1);return e}set playing(e){this._playing=e}get playing(){return this._playing}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if(this._activeStateDurationDirty){let e=0;for(let t=0;t<this.activeStateAnimations.length;t++){const s=this._animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(e=Math.max(e,s.track.duration))}this._activeStateDuration=e,this._activeStateDurationDirty=!1}return this._activeStateDuration}set activeStateCurrentTime(e){this._timeInStateBefore=e,this._timeInState=e;for(let t=0;t<this.activeStateAnimations.length;t++){const s=this.animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(s.time=e)}}get activeStateCurrentTime(){return this._timeInState}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(e){return this._animEvaluator.assignMask(e)}_findState(e){return this._states[e]}_getActiveStateProgressForTime(e){if(this.activeStateName===Gh||this.activeStateName===yg||this.activeStateName===pa)return 1;const t=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return t?t.progressForTime(e):null}_findTransitionsFromState(e){let t=this._findTransitionsFromStateCache[e];return t||(t=this._transitions.filter(function(s){return s.from===e}),Fc(t),this._findTransitionsFromStateCache[e]=t),t}_findTransitionsBetweenStates(e,t){let s=this._findTransitionsBetweenStatesCache[e+"->"+t];return s||(s=this._transitions.filter(function(i){return i.from===e&&i.to===t}),Fc(s),this._findTransitionsBetweenStatesCache[e+"->"+t]=s),s}_transitionHasConditionsMet(e){const t=e.conditions;for(let s=0;s<t.length;s++){const i=t[s],n=this._findParameter(i.parameterName);switch(i.predicate){case Qk:if(!(n.value>i.value))return!1;break;case eB:if(!(n.value<i.value))return!1;break;case tB:if(!(n.value>=i.value))return!1;break;case sB:if(!(n.value<=i.value))return!1;break;case iB:if(n.value!==i.value)return!1;break;case nB:if(n.value===i.value)return!1;break}}return!0}_findTransition(e,t){let s=[];if(e&&t)s=s.concat(this._findTransitionsBetweenStates(e,t));else if(!this._isTransitioning)s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(pa));else switch(this._transitionInterruptionSource){case Kk:s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(pa));break;case Yk:s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(pa));break;case Zk:s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(pa));break;case Jk:s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(pa));break}if(s=s.filter(i=>{if(i.to===this.activeStateName)return!1;if(i.hasExitTime){let n=this._getActiveStateProgressForTime(this._timeInStateBefore),a=this._getActiveStateProgressForTime(this._timeInState);if(i.exitTime<1&&this.activeState.loop&&(n-=Math.floor(n),a-=Math.floor(a)),a===n){if(a!==i.exitTime)return null}else if(!(i.exitTime>n&&i.exitTime<=a))return null}return this._transitionHasConditionsMet(i)}),s.length>0){const i=s[0];if(i.to===yg){const n=this._findTransitionsFromState(Gh)[0];i.to=n.to}return i}return null}updateStateFromTransition(e){let t,s,i;this.previousState=e.from?this.activeStateName:null,this.activeState=e.to,this._activeStateDurationDirty=!0;for(let c=0;c<e.conditions.length;c++){const d=e.conditions[c];this._findParameter(d.parameterName).type===ju&&this._consumeTrigger(d.parameterName)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});const c=Math.min(this._totalTransitionTime!==0?this._currTransitionTime/this._totalTransitionTime:1,1);for(let d=0;d<this._transitionPreviousStates.length;d++){this._isTransitioning?d!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[d].weight*=1-c:this._transitionPreviousStates[d].weight=c:this._transitionPreviousStates[d].weight=1,t=this._findState(this._transitionPreviousStates[d].name);for(let h=0;h<t.animations.length;h++)s=t.animations[h],i=this._animEvaluator.findClip(s.name+".previous."+d),i||(i=this._animEvaluator.findClip(s.name),i.name=s.name+".previous."+d),d!==this._transitionPreviousStates.length-1&&i.pause()}}this._isTransitioning=!0,this._totalTransitionTime=e.time,this._currTransitionTime=0,this._transitionInterruptionSource=e.interruptionSource;const n=this.activeState,a=e.transitionOffset&&e.transitionOffset>0&&e.transitionOffset<1;let o=0,l=0;if(a){const c=n.timelineDuration*e.transitionOffset;o=c,l=c}this._timeInState=o,this._timeInStateBefore=l;for(let c=0;c<n.animations.length;c++){if(i=this._animEvaluator.findClip(n.animations[c].name),i)i.reset();else{const d=Number.isFinite(n.animations[c].speed)?n.animations[c].speed:n.speed;i=new jl(n.animations[c].animTrack,this._timeInState,d,!0,n.loop,this._eventHandler),i.name=n.animations[c].name,this._animEvaluator.addClip(i)}if(e.time>0?i.blendWeight=0:i.blendWeight=n.animations[c].normalizedWeight,i.play(),a)i.time=n.timelineDuration*e.transitionOffset;else{const d=n.speed>=0?0:this.activeStateDuration;i.time=d}}}_transitionToState(e){if(!this._findState(e))return;let t=this._findTransition(this._activeStateName,e);t||(this._animEvaluator.removeClips(),t=new yf({from:null,to:e})),this.updateStateFromTransition(t)}assignAnimation(e,t,s,i){const n=e.split(".");let a=this._findState(n[0]);a||(a=new tx(this,n[0],s),this._states[n[0]]=a,this._stateNames.push(n[0])),a.addAnimation(n,t),this._animEvaluator.updateClipTrack(a.name,t),s!==void 0&&(a.speed=s),i!==void 0&&(a.loop=i),!this._playing&&this._activate&&this.playable&&this.play(),this._activeStateDurationDirty=!0}removeNodeAnimations(e){if(gf.indexOf(e)!==-1)return!1;const t=this._findState(e);return t?(t.animations=[],!0):!1}play(e){e&&this._transitionToState(e),this._playing=!0}pause(){this._playing=!1}reset(){this._previousStateName=null,this._activeStateName=Gh,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()}rebind(){this._animEvaluator.rebind()}update(e){if(!this._playing)return;let t,s,i;(this.activeState.loop||this._timeInState<this.activeStateDuration)&&(this._timeInStateBefore=this._timeInState,this._timeInState+=e*this.activeState.speed,!this.activeState.loop&&this._timeInState>this.activeStateDuration&&(this._timeInState=this.activeStateDuration,e=this.activeStateDuration-this._timeInStateBefore));const n=this._findTransition(this._activeStateName);if(n&&this.updateStateFromTransition(n),this._isTransitioning)if(this._currTransitionTime+=e,this._currTransitionTime<=this._totalTransitionTime){const a=this._totalTransitionTime!==0?this._currTransitionTime/this._totalTransitionTime:1;for(let o=0;o<this._transitionPreviousStates.length;o++){t=this._findState(this._transitionPreviousStates[o].name);const l=this._transitionPreviousStates[o].weight;for(let c=0;c<t.animations.length;c++)s=t.animations[c],i=this._animEvaluator.findClip(s.name+".previous."+o),i&&(i.blendWeight=(1-a)*s.normalizedWeight*l)}t=this.activeState;for(let o=0;o<t.animations.length;o++)s=t.animations[o],this._animEvaluator.findClip(s.name).blendWeight=a*s.normalizedWeight}else{this._isTransitioning=!1;const a=this.activeStateAnimations.length,o=this._animEvaluator.clips.length;for(let l=0;l<o-a;l++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],t=this.activeState;for(let l=0;l<t.animations.length;l++)s=t.animations[l],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight)}else if(this.activeState._blendTree.constructor!==Bc){t=this.activeState;for(let a=0;a<t.animations.length;a++)s=t.animations[a],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight,s.parent.syncAnimations&&(i.speed=s.speed))}this._animEvaluator.update(e,this.activeState.hasAnimations)}}const i_=new M,uu=new y,Ah=new P,Ph=new k,Mh=new re;class wn extends xr{constructor(e,t,s,i,n){super(t),this.animComponent=e,this._mask=i,this.layerName=s,this.layerIndex=n}static _packFloat(e){return e[0]}static _packBoolean(e){return!!e[0]}static _packVec2(e){return i_.x=e[0],i_.y=e[1],i_}static _packVec3(e){return uu.x=e[0],uu.y=e[1],uu.z=e[2],uu}static _packVec4(e){return Ah.x=e[0],Ah.y=e[1],Ah.z=e[2],Ah.w=e[3],Ah}static _packColor(e){return Ph.r=e[0],Ph.g=e[1],Ph.b=e[2],Ph.a=e[3],Ph}static _packQuat(e){return Mh.x=e[0],Mh.y=e[1],Mh.z=e[2],Mh.w=e[3],Mh}resolve(e){const t=el.encode(e.entityPath,e.component,e.propertyPath);let s=this.targetCache[t];if(s)return s;let i,n,a;switch(e.component){case"entity":i=this._getEntityFromHierarchy(e.entityPath),a=el.encode(i.path,"entity",e.propertyPath),n=i;break;case"graph":if(n=this.findNode(e),!n)return null;a=el.encode(n.path,"graph",e.propertyPath);break;default:if(i=this._getEntityFromHierarchy(e.entityPath),n=i.findComponent(e.component),!n)return null;a=el.encode(i.path,e.component,e.propertyPath);break}return s=this._createAnimTargetForProperty(n,e.propertyPath,a),this.targetCache[t]=s,s}update(e){const t=this.activeNodes;if(t)for(let s=0;s<t.length;s++)t[s]._dirtifyLocal()}_getEntityFromHierarchy(e){if(!this.animComponent.entity.name===e[0])return null;const t=this.animComponent.entity;return e.length===1?t:t._parent.findByPath(e)}_resolvePath(e,t,s){const i=t.length-(s?0:1);for(let n=0;n<i;n++)e=e[t[n]];return e}_setter(e,t,s){const i=this._resolvePath(e,t),n=t[t.length-1],a="set"+n.substring(0,1).toUpperCase()+n.substring(1);if(i[a]){let c=i["get"+n.substring(0,1).toUpperCase()+n.substring(1)].bind(i)();c=[c.x,c.y,c.z,c.w];const d=i[a].bind(i);return{set:h=>{d(s(h))},get:()=>c}}const o=i[n];if(typeof o=="object"&&o.hasOwnProperty("copy"))return function(l){o.copy(s(l))};if([M,y,P,k,re].indexOf(i.constructor)!==-1&&t.length>1){const l=t.length>2?this._resolvePath(e,t.slice(0,-1)):e,c=t[t.length-2];return function(d){i[n]=s(d),l[c]=i}}return function(l){i[n]=s(l)}}_createAnimTargetForProperty(e,t,s){if(this.handlers&&t[0].startsWith("weight."))return this.handlers.weight(e,t[0].replace("weight.",""));if(this.handlers&&t[0]==="material"&&t.length===2){const l=t[1];if(l.endsWith("Map"))return this.handlers.materialTexture(e,l)}const i=this._resolvePath(e,t,!0);if(typeof i>"u")return null;let n,a,o;if(typeof i=="number")n=this._setter(e,t,wn._packFloat),a="vector",o=1;else if(typeof i=="boolean")n=this._setter(e,t,wn._packBoolean),a="vector",o=1;else if(typeof i=="object")switch(i.constructor){case M:n=this._setter(e,t,wn._packVec2),a="vector",o=2;break;case y:n=this._setter(e,t,wn._packVec3),a="vector",o=3;break;case P:n=this._setter(e,t,wn._packVec4),a="vector",o=4;break;case k:n=this._setter(e,t,wn._packColor),a="vector",o=4;break;case re:n=this._setter(e,t,wn._packQuat),a="quaternion",o=4;break;default:return null}return t.indexOf("material")!==-1?new vg(function(l){n(l),e.material.update()},a,o,s):new vg(n,a,o,s)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;const e={};(function s(i){e[i.name]=i;for(let n=0;n<i.children.length;++n)s(i.children[n])})(this.graph),this.nodes=e}}class mB{constructor(e,t,s,i=1,n=lT,a=!0){this._name=e,this._controller=t,this._component=s,this._weight=i,this._blendType=n,this._normalizedWeight=a,this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0}get name(){return this._name}set playing(e){this._controller.playing=e}get playing(){return this._controller.playing}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}set activeStateCurrentTime(e){const t=this._controller,s=t.playing;t.playing=!0,t.activeStateCurrentTime=e,s||t.update(0),t.playing=s}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}set weight(e){this._weight=e,this._component.dirtifyTargets()}get weight(){return this._weight}set blendType(e){e!==this._blendType&&(this._blendType=e,this._controller.normalizeWeights&&this._component.rebind())}get blendType(){return this._blendType}set mask(e){this._controller.assignMask(e)&&this._component.rebind(),this._mask=e}get mask(){return this._mask}play(e){this._controller.play(e)}pause(){this._controller.pause()}reset(){this._controller.reset()}rebind(){this._controller.rebind()}update(e){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=H.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=e):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(e)}blendToWeight(e,t){this._startingWeight=this.weight,this._targetWeight=e,this._blendTime=Math.max(0,t),this._blendTimeElapsed=0}assignMask(e){this._controller.assignMask(e)&&this._component.rebind(),this._mask=e}assignAnimation(e,t,s,i){t instanceof qn&&(this._controller.assignAnimation(e,t,s,i),this._controller._transitions.length===0&&this._controller._transitions.push(new yf({from:"START",to:e})),this._component.activate&&this._component.playable&&(this._component.playing=!0))}removeNodeAnimations(e){this._controller.removeNodeAnimations(e)&&(this._component.playing=!1)}getAnimationAsset(e){return this._component.animationAssets[`${this.name}:${e}`]}transition(e,t=0,s=null){this._controller.updateStateFromTransition(new yf({from:this._controller.activeStateName,to:e,time:t,transitionOffset:s}))}}class $u{constructor(e){if(this._layers=[],this._parameters={},Array.isArray(e.layers))this._layers=e.layers;else for(const t in e.layers){const s=e.layers[t],i={name:s.name,blendType:s.blendType,weight:s.weight,states:[],transitions:[]};for(let n=0;n<s.states.length;n++)i.states.push(e.states[s.states[n]]);for(let n=0;n<s.transitions.length;n++){const a=e.transitions[s.transitions[n]];if(a.conditions&&!Array.isArray(a.conditions)){const o=Object.keys(a.conditions),l=[];for(let c=0;c<o.length;c++){const d=a.conditions[o[c]];d.parameterName&&l.push(d)}a.conditions=l}Number.isInteger(a.from)&&(a.from=e.states[a.from].name),Number.isInteger(a.to)&&(a.to=e.states[a.to].name),i.transitions.push(a)}this._layers.push(i)}for(const t in e.parameters){const s=e.parameters[t];this._parameters[s.name]={type:s.type,value:s.value}}}get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}}class fT extends ge{constructor(e,t){super(e,t),this.findParameter=s=>this._parameters[s],this.consumeTrigger=s=>{this._consumedTriggers.add(s)},this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=!0,this._playing=!1,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set,this._normalizeWeights=!1}set stateGraphAsset(e){if(e===null){this.removeStateGraph();return}this._stateGraphAsset&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this);let t,s;e instanceof ne?(t=e.id,s=this.system.app.assets.get(t),s||(this.system.app.assets.add(e),s=this.system.app.assets.get(t))):(t=e,s=this.system.app.assets.get(t)),!(!s||this._stateGraphAsset===t)&&(s.resource?(this._stateGraph=s.resource,this.loadStateGraph(this._stateGraph),s.on("change",this._onStateGraphAssetChangeEvent,this)):(s.once("load",i=>{this._stateGraph=i.resource,this.loadStateGraph(this._stateGraph)}),s.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(s)),this._stateGraphAsset=t)}get stateGraphAsset(){return this._stateGraphAsset}set normalizeWeights(e){this._normalizeWeights=e,this.unbind()}get normalizeWeights(){return this._normalizeWeights}set animationAssets(e){this._animationAssets=e,this.loadAnimationAssets()}get animationAssets(){return this._animationAssets}set speed(e){this._speed=e}get speed(){return this._speed}set activate(e){this._activate=e}get activate(){return this._activate}set playing(e){this._playing=e}get playing(){return this._playing}set rootBone(e){if(typeof e=="string"){const t=this.entity.root.findByGuid(e);this._rootBone=t}else e instanceof $?this._rootBone=e:this._rootBone=null;this.rebind()}get rootBone(){return this._rootBone}set stateGraph(e){this._stateGraph=e}get stateGraph(){return this._stateGraph}get layers(){return this._layers}set layerIndices(e){this._layerIndices=e}get layerIndices(){return this._layerIndices}set parameters(e){this._parameters=e}get parameters(){return this._parameters}set targets(e){this._targets=e}get targets(){return this._targets}get playable(){for(let e=0;e<this._layers.length;e++)if(!this._layers[e].playable)return!1;return!0}get baseLayer(){return this._layers.length>0?this._layers[0]:null}_onStateGraphAssetChangeEvent(e){const t=this.animationAssets,s=this.layers.map(i=>i.mask);this.removeStateGraph(),this._stateGraph=new $u(e._data),this.loadStateGraph(this._stateGraph),this.animationAssets=t,this.loadAnimationAssets(),this.layers.forEach((i,n)=>{i.mask=s[n]}),this.rebind()}dirtifyTargets(){const e=Object.values(this._targets);for(let t=0;t<e.length;t++)e[t].dirty=!0}_addLayer({name:e,states:t,transitions:s,weight:i,mask:n,blendType:a}){let o;this.rootBone?o=this.rootBone:o=this.entity;const l=this._layers.length,c=new wn(this,o,e,n,l),d=new hT(c),h=new pB(d,t,s,this._activate,this,this.findParameter,this.consumeTrigger);return this._layers.push(new mB(e,h,this,i,a)),this._layerIndices[e]=l,this._layers[l]}addLayer(e,t,s,i){const n=this.findAnimationLayer(e);if(n)return n;const a=[{name:"START",speed:1}],o=[];return this._addLayer({name:e,states:a,transitions:o,weight:t,mask:s,blendType:i})}_assignParameters(e){this._parameters={};const t=Object.keys(e.parameters);for(let s=0;s<t.length;s++){const i=t[s];this._parameters[i]={type:e.parameters[i].type,value:e.parameters[i].value}}}loadStateGraph(e){this._stateGraph=e,this._assignParameters(e),this._layers=[];let t=!1;for(let s=0;s<e.layers.length;s++){const i=e.layers[s];this._addLayer(Ft({},i)),i.states.some(n=>n.blendTree)&&(t=!0)}t||this.setupAnimationAssets()}setupAnimationAssets(){for(let e=0;e<this._layers.length;e++){const t=this._layers[e],s=t.name;for(let i=0;i<t.states.length;i++){const n=t.states[i];if(gf.indexOf(n)===-1){const a=s+":"+n;this._animationAssets[a]||(this._animationAssets[a]={asset:null})}}}this.loadAnimationAssets()}loadAnimationAssets(){for(let e=0;e<this._layers.length;e++){const t=this._layers[e];for(let s=0;s<t.states.length;s++){const i=t.states[s];if(gf.indexOf(i)!==-1)continue;const n=this._animationAssets[t.name+":"+i];if(!n||!n.asset){this.findAnimationLayer(t.name).assignAnimation(i,qn.EMPTY);continue}const a=n.asset,o=this.system.app.assets.get(a);o&&(o.resource?this.onAnimationAssetLoaded(t.name,i,o):(o.once("load",(function(l,c){return(function(d){this.onAnimationAssetLoaded(l,c,d)}).bind(this)}).bind(this)(t.name,i)),this.system.app.assets.load(o)))}}}onAnimationAssetLoaded(e,t,s){this.findAnimationLayer(e).assignAnimation(t,s.resource)}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1,this.unbind(),this._targets={}}reset(){this._assignParameters(this._stateGraph);for(let e=0;e<this._layers.length;e++){const t=this._layers[e].playing;this._layers[e].reset(),this._layers[e].playing=t}}unbind(){this._normalizeWeights||Object.keys(this._targets).forEach(e=>{this._targets[e].unbind()})}rebind(){this._targets={};for(let e=0;e<this._layers.length;e++)this._layers[e].rebind()}findAnimationLayer(e){const t=this._layerIndices[e];return this._layers[t]||null}addAnimationState(e,t,s=1,i=!0,n="Base"){this._stateGraph||this.loadStateGraph(new $u({layers:[{name:n,states:[{name:"START",speed:1},{name:e,speed:s,loop:i,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}}));const a=this.findAnimationLayer(n);if(a)a.assignAnimation(e,t,s,i);else{var o;(o=this.addLayer(n))==null||o.assignAnimation(e,t,s,i)}}assignAnimation(e,t,s,i=1,n=!0){if(!this._stateGraph&&e.indexOf(".")===-1){this.loadStateGraph(new $u({layers:[{name:"Base",states:[{name:"START",speed:1},{name:e,speed:i,loop:n,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}})),this.baseLayer.assignAnimation(e,t);return}const a=s?this.findAnimationLayer(s):this.baseLayer;a&&a.assignAnimation(e,t,i,n)}removeNodeAnimations(e,t){const s=t?this.findAnimationLayer(t):this.baseLayer;s&&s.removeNodeAnimations(e)}getParameterValue(e,t){const s=this._parameters[e];if(s&&s.type===t)return s.value}setParameterValue(e,t,s){const i=this._parameters[e];if(i&&i.type===t){i.value=s;return}}getFloat(e){return this.getParameterValue(e,QS)}setFloat(e,t){this.setParameterValue(e,QS,t)}getInteger(e){return this.getParameterValue(e,JS)}setInteger(e,t){typeof t=="number"&&t%1===0&&this.setParameterValue(e,JS,t)}getBoolean(e){return this.getParameterValue(e,ex)}setBoolean(e,t){this.setParameterValue(e,ex,!!t)}getTrigger(e){return this.getParameterValue(e,ju)}setTrigger(e,t=!1){this.setParameterValue(e,ju,!0),t&&this._consumedTriggers.add(e)}resetTrigger(e){this.setParameterValue(e,ju,!1)}onBeforeRemove(){Number.isFinite(this._stateGraphAsset)&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}update(e){for(let t=0;t<this.layers.length;t++)this.layers[t].update(e*this.speed);this._consumedTriggers.forEach(t=>{this.parameters[t].value=!1}),this._consumedTriggers.clear()}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&t[e.rootBone.getGuid()]?this.rootBone=t[e.rootBone.getGuid()]:this.rebind()}}class _B{constructor(){this.enabled=!0}}const xg=["enabled"];class gB extends tt{constructor(e){super(e),this.id="anim",this.ComponentType=fT,this.DataType=_B,this.schema=xg,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this)}initializeComponentData(e,t,s){super.initializeComponentData(e,t,xg);const i=["animationAssets","stateGraph","layers","masks"];Object.keys(t).forEach(n=>{i.includes(n)||(e[n]=t[n])}),t.stateGraph&&(e.stateGraph=t.stateGraph,e.loadStateGraph(e.stateGraph)),t.layers?t.layers.forEach((n,a)=>{n._controller.states.forEach(o=>{n._controller._states[o]._animationList.forEach(l=>{if(!l.animTrack||l.animTrack===qn.EMPTY){const c=this.app.assets.get(n._component._animationAssets[n.name+":"+l.name].asset);c&&!c.loaded&&c.once("load",()=>{e.layers[a].assignAnimation(l.name,c.resource)})}else e.layers[a].assignAnimation(l.name,l.animTrack)})})}):t.animationAssets&&(e.animationAssets=Object.assign(e.animationAssets,t.animationAssets)),t.masks&&Object.keys(t.masks).forEach(n=>{if(e.layers[n]){const a=t.masks[n].mask,o={};Object.keys(a).forEach(l=>{o[decodeURI(l)]=a[l]}),e.layers[n].mask=o}})}onAnimationUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s].entity.anim;i.data.enabled&&i.entity.enabled&&i.playing&&i.update(e)}}cloneComponent(e,t){let s;(!e.anim.rootBone||e.anim.rootBone===e)&&(s={},e.anim.layers.forEach((n,a)=>{if(n.mask){const o={};Object.keys(n.mask).forEach(l=>{const c=l.split("/");c.shift();const d=[t.name,...c].join("/");o[d]=n.mask[l]}),s[a]={mask:o}}}));const i={stateGraphAsset:e.anim.stateGraphAsset,animationAssets:e.anim.animationAssets,speed:e.anim.speed,activate:e.anim.activate,playing:e.anim.playing,rootBone:e.anim.rootBone,stateGraph:e.anim.stateGraph,layers:e.anim.layers,layerIndices:e.anim.layerIndices,parameters:e.anim.parameters,normalizeWeights:e.anim.normalizeWeights,masks:s};return this.addComponent(t,i)}onBeforeRemove(e,t){t.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this)}}ge._buildAccessors(fT.prototype,xg);class pT extends ge{constructor(e,t){super(e,t)}setCurrentListener(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;const e=this.system.current.getPosition();this.system.manager.listener.setPosition(e)}}onEnable(){this.setCurrentListener()}onDisable(){this.system.current===this.entity&&(this.system.current=null)}}class yB{constructor(){this.enabled=!0}}const mT=["enabled"];class vB extends tt{constructor(e){super(e),this.id="audiolistener",this.ComponentType=pT,this.DataType=yB,this.schema=mT,this.manager=e.soundManager,this.current=null,this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){s=["enabled"],super.initializeComponentData(e,t,s)}onUpdate(e){if(this.current){const t=this.current.getPosition();this.manager.listener.setPosition(t);const s=this.current.getWorldTransform();this.manager.listener.setOrientation(s)}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}ge._buildAccessors(pT.prototype,mT);class _T extends ge{constructor(e,t){super(e,t),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this),this.on("set_volume",this.onSetVolume,this),this.on("set_pitch",this.onSetPitch,this),this.on("set_minDistance",this.onSetMinDistance,this),this.on("set_maxDistance",this.onSetMaxDistance,this),this.on("set_rollOffFactor",this.onSetRollOffFactor,this),this.on("set_distanceModel",this.onSetDistanceModel,this),this.on("set_3d",this.onSet3d,this)}play(e){if(!this.enabled||!this.entity.enabled)return;this.channel&&this.stop();let t;const s=this.data;if(s.sources[e])if(!s["3d"])t=this.system.manager.playSound(s.sources[e],s),s.currentSource=e,s.channel=t;else{const i=this.entity.getPosition();t=this.system.manager.playSound3d(s.sources[e],i,s),s.currentSource=e,s.channel=t}}pause(){this.channel&&this.channel.pause()}unpause(){this.channel&&this.channel.paused&&this.channel.unpause()}stop(){this.channel&&(this.channel.stop(),this.channel=null)}onSetAssets(e,t,s){const i=[],n=s.length;if(t&&t.length){for(let a=0;a<t.length;a++)if(t[a]){const o=this.system.app.assets.get(t[a]);o&&(o.off("change",this.onAssetChanged,this),o.off("remove",this.onAssetRemoved,this),this.currentSource===o.name&&this.stop())}}if(n)for(let a=0;a<n;a++)t.indexOf(s[a])<0&&(s[a]instanceof ne?i.push(s[a].id):i.push(s[a]));!this.system._inTools&&i.length&&this.loadAudioSourceAssets(i)}onAssetChanged(e,t,s,i){t==="resource"&&this.data.sources&&(this.data.sources[e.name]=s,this.data.currentSource===e.name&&this.channel&&(this.channel.paused?(this.play(e.name),this.pause()):this.play(e.name)))}onAssetRemoved(e){e.off("remove",this.onAssetRemoved,this),this.data.sources[e.name]&&(delete this.data.sources[e.name],this.data.currentSource===e.name&&(this.stop(),this.data.currentSource=null))}onSetLoop(e,t,s){t!==s&&this.channel&&this.channel.setLoop(s)}onSetVolume(e,t,s){t!==s&&this.channel&&this.channel.setVolume(s)}onSetPitch(e,t,s){t!==s&&this.channel&&this.channel.setPitch(s)}onSetMaxDistance(e,t,s){t!==s&&this.channel instanceof Tr&&this.channel.setMaxDistance(s)}onSetMinDistance(e,t,s){t!==s&&this.channel instanceof Tr&&this.channel.setMinDistance(s)}onSetRollOffFactor(e,t,s){t!==s&&this.channel instanceof Tr&&this.channel.setRollOffFactor(s)}onSetDistanceModel(e,t,s){t!==s&&this.channel instanceof Tr&&this.channel.setDistanceModel(s)}onSet3d(e,t,s){if(t!==s&&this.system.initialized&&this.currentSource){let i=!1,n=!1;this.channel&&(i=this.channel.paused,n=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=i,this.channel.suspended=n)}}onEnable(){const e=this.data.assets;if(e){const t=this.system.app.assets;for(let s=0,i=e.length;s<i;s++){let n=e[s];n instanceof ne||(n=t.get(n)),n&&!n.resource&&t.load(n)}}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())}onDisable(){this.pause()}loadAudioSourceAssets(e){const t=e.map(l=>this.system.app.assets.get(l)),s={};let i=null,n=t.length;const a=l=>{n--},o=()=>{this.data.sources=s,this.data.currentSource=i,this.enabled&&this.activate&&i&&this.onEnable()};t.forEach((l,c)=>{l?(i=i||l.name,l.off("change",this.onAssetChanged,this),l.on("change",this.onAssetChanged,this),l.off("remove",this.onAssetRemoved,this),l.on("remove",this.onAssetRemoved,this),l.off("error",a,this),l.on("error",a,this),l.ready(d=>{s[d.name]=d.resource,n--,n===0&&o()}),!l.resource&&this.enabled&&this.entity.enabled&&this.system.app.assets.load(l)):(n--,n===0&&o(),this.system.app.assets.on("add:"+e[c],d=>{d.ready(h=>{this.data.sources[h.name]=h.resource}),d.resource||this.system.app.assets.load(d)}))})}}class SB{constructor(){this.enabled=!0,this.assets=[],this.activate=!0,this.volume=1,this.pitch=1,this.loop=!1,this["3d"]=!0,this.minDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel=rp,this.paused=!0,this.sources={},this.currentSource=null,this.channel=null}}const gT=["enabled","assets","volume","pitch","loop","activate","3d","minDistance","maxDistance","rollOffFactor","distanceModel","sources","currentSource","channel"];class xB extends tt{constructor(e){super(e),this.id="audiosource",this.ComponentType=_T,this.DataType=SB,this.schema=gT,this.manager=e.soundManager,this.initialized=!1,this.app.systems.on("initialize",this.onInitialize,this),this.app.systems.on("update",this.onUpdate,this),this.on("remove",this.onRemove,this)}initializeComponentData(e,t,s){s=["activate","volume","pitch","loop","3d","minDistance","maxDistance","rollOffFactor","distanceModel","enabled","assets"],super.initializeComponentData(e,t,s),e.paused=!(e.enabled&&e.activate)}onInitialize(e){e.audiosource&&e.enabled&&e.audiosource.enabled&&e.audiosource.activate&&e.audiosource.play(e.audiosource.currentSource);const t=e._children;for(let s=0,i=t.length;s<i;s++)t[s]instanceof $&&this.onInitialize(t[s]);this.initialized=!0}onUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s],n=i.entity,a=i.data;if(a.enabled&&n.enabled&&a.channel instanceof Tr){const o=n.getPosition();a.channel.setPosition(o)}}}onRemove(e,t){t.channel&&(t.channel.stop(),t.channel=null)}setVolume(e){this.manager.setVolume(e)}destroy(){super.destroy(),this.app.systems.off("initialize",this.onInitialize,this),this.app.systems.off("update",this.onUpdate,this)}}ge._buildAccessors(_T.prototype,gT);class Aa extends ie{constructor(e,t,s){if(super(),!e||!(e instanceof ge))throw new Error("The parentComponent argument is required and must be a Component");if(!t||typeof t!="string")throw new Error("The propertyName argument is required and must be a string");if(s&&typeof s!="object")throw new Error("If provided, the eventConfig argument must be an object");this._parentComponent=e,this._entityPropertyName=t,this._entity=null,this._app=e.system.app,this._configureEventListeners(s||{},{"entity#destroy":this._onEntityDestroy}),this._toggleLifecycleListeners("on")}_configureEventListeners(e,t){const s=this._parseEventListenerConfig(e,"external",this._parentComponent),i=this._parseEventListenerConfig(t,"internal",this);this._eventListenerConfigs=s.concat(i),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}}_parseEventListenerConfig(e,t,s){return Object.keys(e).map(function(i,n){const a=i.split("#"),o=a[0],l=a[1],c=e[i];if(a.length!==2||typeof o!="string"||o.length===0||typeof l!="string"||l.length===0)throw new Error("Invalid event listener description: `"+i+"`");if(typeof c!="function")throw new Error("Invalid or missing callback for event listener `"+i+"`");return{id:t+"_"+n+"_"+i,sourceName:o,eventName:l,callback:c,scope:s}},this)}_toggleLifecycleListeners(e){this._parentComponent[e]("set_"+this._entityPropertyName,this._onSetEntity,this),this._parentComponent.system[e]("beforeremove",this._onParentComponentRemove,this),this._app.systems[e]("postPostInitialize",this._updateEntityReference,this),this._app[e]("tools:sceneloaded",this._onSceneLoaded,this);const t=[];for(let s=0;s<this._eventListenerConfigs.length;++s){const i=this._eventListenerConfigs[s],n=this._app.systems[i.sourceName];n&&(t.indexOf(n)===-1&&t.push(n),n&&i.eventName==="gain"&&(this._gainListeners[i.sourceName]=i),n&&i.eventName==="lose"&&(this._loseListeners[i.sourceName]=i))}for(let s=0;s<t.length;++s)t[s][e]("add",this._onComponentAdd,this),t[s][e]("beforeremove",this._onComponentRemove,this)}_onSetEntity(e,t,s){if(s instanceof $)this._updateEntityReference();else{if(s!=null&&typeof s!="string"){console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof s+"'");return}t!==s&&this._updateEntityReference()}}onParentComponentEnable(){this._entity||this._updateEntityReference()}_onSceneLoaded(){this._updateEntityReference()}_updateEntityReference(){let e=this._parentComponent.data[this._entityPropertyName],t;if(e instanceof $)t=e,e=t.getGuid(),this._parentComponent.data[this._entityPropertyName]=e;else{const i=this._parentComponent.system.app.root;t=this._parentComponent.entity.isDescendantOf(i)&&e?i.findByGuid(e):null}this._entity!==t&&(this._entity&&this._onBeforeEntityChange(),this._entity=t,this._entity&&this._onAfterEntityChange(),this.fire("set:entity",this._entity))}_onBeforeEntityChange(){this._toggleEntityListeners("off"),this._callAllGainOrLoseListeners(this._loseListeners)}_onAfterEntityChange(){this._toggleEntityListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)}_onComponentAdd(e,t){const s=t.system.id;e===this._entity&&(this._callGainOrLoseListener(s,this._gainListeners),this._toggleComponentListeners("on",s))}_onComponentRemove(e,t){const s=t.system.id;e===this._entity&&(this._callGainOrLoseListener(s,this._loseListeners),this._toggleComponentListeners("off",s,!0))}_callAllGainOrLoseListeners(e){for(const t in this._entity.c)this._callGainOrLoseListener(t,e)}_callGainOrLoseListener(e,t){if(this._entity.c.hasOwnProperty(e)&&t[e]){const s=t[e];s.callback.call(s.scope)}}_toggleEntityListeners(e,t){if(this._entity)for(let s=0;s<this._eventListenerConfigs.length;++s)this._safeToggleListener(e,this._eventListenerConfigs[s],t)}_toggleComponentListeners(e,t,s){for(let i=0;i<this._eventListenerConfigs.length;++i){const n=this._eventListenerConfigs[i];n.sourceName===t&&this._safeToggleListener(e,n,s)}}_safeToggleListener(e,t,s){const i=e==="on";if(i&&this._listenerStatusFlags[t.id])return;const n=this._getEventSource(t.sourceName,s);n&&(n[e](t.eventName,t.callback,t.scope),this._listenerStatusFlags[t.id]=i)}_getEventSource(e,t){if(e==="entity")return this._entity;const s=this._entity[e];return s||(t||console.warn("Entity has no component with name "+e),null)}_onEntityDestroy(e){this._entity===e&&(this._toggleEntityListeners("off",!0),this._entity=null)}_onParentComponentRemove(e,t){t===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))}hasComponent(e){return this._entity&&this._entity.c?!!this._entity.c[e]:!1}get entity(){return this._entity}}const wg=0,sx=1,Bs="group",pt="image",o0="text",Xu="stretch",wB="contain",bB="cover",ft={DEFAULT:"DEFAULT",HOVER:"HOVER",PRESSED:"PRESSED",INACTIVE:"INACTIVE"},Ad={};Ad[ft.DEFAULT]="_defaultTint";Ad[ft.HOVER]="hoverTint";Ad[ft.PRESSED]="pressedTint";Ad[ft.INACTIVE]="inactiveTint";const Pd={};Pd[ft.DEFAULT]="_defaultSpriteAsset";Pd[ft.HOVER]="hoverSpriteAsset";Pd[ft.PRESSED]="pressedSpriteAsset";Pd[ft.INACTIVE]="inactiveSpriteAsset";const Md={};Md[ft.DEFAULT]="_defaultSpriteFrame";Md[ft.HOVER]="hoverSpriteFrame";Md[ft.PRESSED]="pressedSpriteFrame";Md[ft.INACTIVE]="inactiveSpriteFrame";class Dt extends ge{constructor(e,t){super(e,t),this._visualState=ft.DEFAULT,this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._defaultTint=new k(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._imageReference=new Aa(this,"imageEntity",{"element#gain":this._onImageElementGain,"element#lose":this._onImageElementLose,"element#set:color":this._onSetColor,"element#set:opacity":this._onSetOpacity,"element#set:spriteAsset":this._onSetSpriteAsset,"element#set:spriteFrame":this._onSetSpriteFrame}),this._toggleLifecycleListeners("on",e)}_toggleLifecycleListeners(e,t){this[e]("set_active",this._onSetActive,this),this[e]("set_transitionMode",this._onSetTransitionMode,this),this[e]("set_hoverTint",this._onSetTransitionValue,this),this[e]("set_pressedTint",this._onSetTransitionValue,this),this[e]("set_inactiveTint",this._onSetTransitionValue,this),this[e]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[e]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[e]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[e]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),t.app.systems.element[e]("add",this._onElementComponentAdd,this),t.app.systems.element[e]("beforeremove",this._onElementComponentRemove,this)}_onSetActive(e,t,s){t!==s&&this._updateVisualState()}_onSetTransitionMode(e,t,s){t!==s&&(this._cancelTween(),this._resetToDefaultVisualState(t),this._forceReapplyVisualState())}_onSetTransitionValue(e,t,s){t!==s&&this._forceReapplyVisualState()}_onElementComponentRemove(e){this.entity===e&&this._toggleHitElementListeners("off")}_onElementComponentAdd(e){this.entity===e&&this._toggleHitElementListeners("on")}_onImageElementLose(){this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode)}_onImageElementGain(){this._storeDefaultVisualState(),this._forceReapplyVisualState()}_toggleHitElementListeners(e){if(this.entity.element){const t=e==="on";if(t&&this._hasHitElementListeners)return;this.entity.element[e]("mouseenter",this._onMouseEnter,this),this.entity.element[e]("mouseleave",this._onMouseLeave,this),this.entity.element[e]("mousedown",this._onMouseDown,this),this.entity.element[e]("mouseup",this._onMouseUp,this),this.entity.element[e]("touchstart",this._onTouchStart,this),this.entity.element[e]("touchend",this._onTouchEnd,this),this.entity.element[e]("touchleave",this._onTouchLeave,this),this.entity.element[e]("touchcancel",this._onTouchCancel,this),this.entity.element[e]("selectstart",this._onSelectStart,this),this.entity.element[e]("selectend",this._onSelectEnd,this),this.entity.element[e]("selectenter",this._onSelectEnter,this),this.entity.element[e]("selectleave",this._onSelectLeave,this),this.entity.element[e]("click",this._onClick,this),this._hasHitElementListeners=t}}_storeDefaultVisualState(){if(this._imageReference.hasComponent("element")){const e=this._imageReference.entity.element;e.type!==Bs&&(this._storeDefaultColor(e.color),this._storeDefaultOpacity(e.opacity),this._storeDefaultSpriteAsset(e.spriteAsset),this._storeDefaultSpriteFrame(e.spriteFrame))}}_storeDefaultColor(e){this._defaultTint.r=e.r,this._defaultTint.g=e.g,this._defaultTint.b=e.b}_storeDefaultOpacity(e){this._defaultTint.a=e}_storeDefaultSpriteAsset(e){this._defaultSpriteAsset=e}_storeDefaultSpriteFrame(e){this._defaultSpriteFrame=e}_onSetColor(e){this._isApplyingTint||(this._storeDefaultColor(e),this._forceReapplyVisualState())}_onSetOpacity(e){this._isApplyingTint||(this._storeDefaultOpacity(e),this._forceReapplyVisualState())}_onSetSpriteAsset(e){this._isApplyingSprite||(this._storeDefaultSpriteAsset(e),this._forceReapplyVisualState())}_onSetSpriteFrame(e){this._isApplyingSprite||(this._storeDefaultSpriteFrame(e),this._forceReapplyVisualState())}_onMouseEnter(e){this._isHovering=!0,this._updateVisualState(),this._fireIfActive("mouseenter",e)}_onMouseLeave(e){this._isHovering=!1,this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseleave",e)}_onMouseDown(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("mousedown",e)}_onMouseUp(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseup",e)}_onTouchStart(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("touchstart",e)}_onTouchEnd(e){e.event.preventDefault(),this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchend",e)}_onTouchLeave(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchleave",e)}_onTouchCancel(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchcancel",e)}_onSelectStart(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("selectstart",e)}_onSelectEnd(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("selectend",e)}_onSelectEnter(e){this._hoveringCounter++,this._hoveringCounter===1&&(this._isHovering=!0,this._updateVisualState()),this._fireIfActive("selectenter",e)}_onSelectLeave(e){this._hoveringCounter--,this._hoveringCounter===0&&(this._isHovering=!1,this._isPressed=!1,this._updateVisualState()),this._fireIfActive("selectleave",e)}_onClick(e){this._fireIfActive("click",e)}_fireIfActive(e,t){this.data.active&&this.fire(e,t)}_updateVisualState(e){const t=this._visualState,s=this._determineVisualState();if((t!==s||e)&&this.enabled)switch(this._visualState=s,t===ft.HOVER&&this._fireIfActive("hoverend"),t===ft.PRESSED&&this._fireIfActive("pressedend"),s===ft.HOVER&&this._fireIfActive("hoverstart"),s===ft.PRESSED&&this._fireIfActive("pressedstart"),this.transitionMode){case wg:{const i=Ad[this._visualState],n=this[i];this._applyTint(n);break}case sx:{const i=Pd[this._visualState],n=Md[this._visualState],a=this[i],o=this[n];this._applySprite(a,o);break}}}_forceReapplyVisualState(){this._updateVisualState(!0)}_resetToDefaultVisualState(e){if(this._imageReference.hasComponent("element"))switch(e){case wg:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case sx:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame);break}}_determineVisualState(){if(this.active){if(this._isPressed)return ft.PRESSED;if(this._isHovering)return ft.HOVER}else return ft.INACTIVE;return ft.DEFAULT}_applySprite(e,t){t=t||0,this._imageReference.hasComponent("element")&&(this._isApplyingSprite=!0,this._imageReference.entity.element.spriteAsset!==e&&(this._imageReference.entity.element.spriteAsset=e),this._imageReference.entity.element.spriteFrame!==t&&(this._imageReference.entity.element.spriteFrame=t),this._isApplyingSprite=!1)}_applyTint(e){this._cancelTween(),this.fadeDuration===0?this._applyTintImmediately(e):this._applyTintWithTween(e)}_applyTintImmediately(e){if(!e||!this._imageReference.hasComponent("element")||this._imageReference.entity.element.type===Bs)return;const t=ix(e);this._isApplyingTint=!0,t.equals(this._imageReference.entity.element.color)||(this._imageReference.entity.element.color=t),this._imageReference.entity.element.opacity!==e.a&&(this._imageReference.entity.element.opacity=e.a),this._isApplyingTint=!1}_applyTintWithTween(e){if(!e||!this._imageReference.hasComponent("element")||this._imageReference.entity.element.type===Bs)return;const t=ix(e),s=this._imageReference.entity.element.color,i=this._imageReference.entity.element.opacity;t.equals(s)&&e.a===i||(this._tweenInfo={startTime:Zi(),from:new k(s.r,s.g,s.b,i),to:e.clone(),lerpColor:new k})}_updateTintTween(){const e=Zi()-this._tweenInfo.startTime;let t=this.fadeDuration===0?1:e/this.fadeDuration;if(t=H.clamp(t,0,1),Math.abs(t-1)>1e-5){const s=this._tweenInfo.lerpColor;s.lerp(this._tweenInfo.from,this._tweenInfo.to,t),this._applyTintImmediately(new k(s.r,s.g,s.b,s.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()}_cancelTween(){delete this._tweenInfo}onUpdate(){this._tweenInfo&&this._updateTintTween()}onEnable(){this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._imageReference.onParentComponentEnable(),this._toggleHitElementListeners("on"),this._forceReapplyVisualState()}onDisable(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode)}onRemove(){this._toggleLifecycleListeners("off",this.system),this.onDisable()}}Dt.EVENT_MOUSEDOWN="mousedown";Dt.EVENT_MOUSEUP="mouseup";Dt.EVENT_MOUSEENTER="mouseenter";Dt.EVENT_MOUSELEAVE="mouseleave";Dt.EVENT_CLICK="click";Dt.EVENT_TOUCHSTART="touchstart";Dt.EVENT_TOUCHEND="touchend";Dt.EVENT_TOUCHCANCEL="touchcancel";Dt.EVENT_TOUCHLEAVE="touchleave";Dt.EVENT_SELECTSTART="selectstart";Dt.EVENT_SELECTEND="selectend";Dt.EVENT_SELECTENTER="selectenter";Dt.EVENT_SELECTLEAVE="selectleave";Dt.EVENT_HOVERSTART="hoverstart";Dt.EVENT_HOVEREND="hoverend";Dt.EVENT_PRESSEDSTART="pressedstart";Dt.EVENT_PRESSEDEND="pressedend";function ix(r){return new k(r.r,r.g,r.b)}class TB{constructor(){this.enabled=!0,this.active=!0,this.imageEntity=null,this.hitPadding=new P,this.transitionMode=wg,this.hoverTint=new k(.75,.75,.75),this.pressedTint=new k(.5,.5,.5),this.inactiveTint=new k(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0}}const bg=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"];class EB extends tt{constructor(e){super(e),this.id="button",this.ComponentType=Dt,this.DataType=TB,this.schema=bg,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){super.initializeComponentData(e,t,bg)}onUpdate(e){const t=this.store;for(const s in t){const i=t[s].entity,n=i.button;n.enabled&&i.enabled&&n.onUpdate()}}_onRemoveComponent(e,t){t.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}ge._buildAccessors(Dt.prototype,bg);const nx=new y,rx=new re;class co extends ge{constructor(e,t){super(e,t),this._compoundParent=null,this._hasOffset=!1,this.entity.on("insert",this._onInsert,this),this.on("set_type",this.onSetType,this),this.on("set_halfExtents",this.onSetHalfExtents,this),this.on("set_linearOffset",this.onSetOffset,this),this.on("set_angularOffset",this.onSetOffset,this),this.on("set_radius",this.onSetRadius,this),this.on("set_height",this.onSetHeight,this),this.on("set_axis",this.onSetAxis,this),this.on("set_asset",this.onSetAsset,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_model",this.onSetModel,this),this.on("set_render",this.onSetRender,this)}onSetType(e,t,s){t!==s&&this.system.changeType(this,t,s)}onSetHalfExtents(e,t,s){const i=this.data.type;this.data.initialized&&i==="box"&&this.system.recreatePhysicalShapes(this)}onSetOffset(e,t,s){this._hasOffset=!this.data.linearOffset.equals(y.ZERO)||!this.data.angularOffset.equals(re.IDENTITY),this.data.initialized&&this.system.recreatePhysicalShapes(this)}onSetRadius(e,t,s){const i=this.data.type;this.data.initialized&&(i==="sphere"||i==="capsule"||i==="cylinder"||i==="cone")&&this.system.recreatePhysicalShapes(this)}onSetHeight(e,t,s){const i=this.data.type;this.data.initialized&&(i==="capsule"||i==="cylinder"||i==="cone")&&this.system.recreatePhysicalShapes(this)}onSetAxis(e,t,s){const i=this.data.type;this.data.initialized&&(i==="capsule"||i==="cylinder"||i==="cone")&&this.system.recreatePhysicalShapes(this)}onSetAsset(e,t,s){const i=this.system.app.assets;if(t){const n=i.get(t);n&&n.off("remove",this.onAssetRemoved,this)}if(s){s instanceof ne&&(this.data.asset=s.id);const n=i.get(this.data.asset);n&&(n.off("remove",this.onAssetRemoved,this),n.on("remove",this.onAssetRemoved,this))}this.data.initialized&&this.data.type==="mesh"&&(s||(this.data.model=null),this.system.recreatePhysicalShapes(this))}onSetRenderAsset(e,t,s){const i=this.system.app.assets;if(t){const n=i.get(t);n&&n.off("remove",this.onRenderAssetRemoved,this)}if(s){s instanceof ne&&(this.data.renderAsset=s.id);const n=i.get(this.data.renderAsset);n&&(n.off("remove",this.onRenderAssetRemoved,this),n.on("remove",this.onRenderAssetRemoved,this))}this.data.initialized&&this.data.type==="mesh"&&(s||(this.data.render=null),this.system.recreatePhysicalShapes(this))}onSetModel(e,t,s){this.data.initialized&&this.data.type==="mesh"&&this.system.implementations.mesh.doRecreatePhysicalShape(this)}onSetRender(e,t,s){this.onSetModel(e,t,s)}onAssetRemoved(e){e.off("remove",this.onAssetRemoved,this),this.data.asset===e.id&&(this.asset=null)}onRenderAssetRemoved(e){e.off("remove",this.onRenderAssetRemoved,this),this.data.renderAsset===e.id&&(this.renderAsset=null)}_getCompoundChildShapeIndex(e){const t=this.data.shape,s=t.getNumChildShapes();for(let i=0;i<s;i++)if(t.getChildShape(i).ptr===e.ptr)return i;return null}_onInsert(e){if(!(typeof Ammo>"u")){if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody){let t=this.entity.parent;for(;t;){if(t.collision&&t.collision.type==="compound"){t.collision.shape.getNumChildShapes()===0?this.system.recreatePhysicalShapes(t.collision):this.system.recreatePhysicalShapes(this);break}t=t.parent}}}}_updateCompound(){const e=this.entity;if(e._dirtyWorld){let t=e._dirtyLocal,s=e;for(;s&&!t&&!(s.collision&&s.collision===this._compoundParent);)s._dirtyLocal&&(t=!0),s=s.parent;if(t){e.forEach(this.system.implementations.compound._updateEachDescendantTransform,e);const i=this._compoundParent.entity.rigidbody;i&&i.activate()}}}getShapePosition(){const e=this.entity.getPosition();if(this._hasOffset){const t=this.entity.getRotation(),s=this.data.linearOffset;return rx.copy(t).transformVector(s,nx),nx.add(e)}return e}getShapeRotation(){const e=this.entity.getRotation();return this._hasOffset?rx.copy(e).mul(this.data.angularOffset):e}onEnable(){if(this.data.type==="mesh"&&(this.data.asset||this.data.renderAsset)&&this.data.initialized){const e=this.system.app.assets.get(this.data.asset||this.data.renderAsset);if(e&&(!e.resource||!this.data.shape)){this.system.recreatePhysicalShapes(this);return}}if(this.entity.rigidbody)this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation();else if(this._compoundParent&&this!==this._compoundParent)if(this._compoundParent.shape.getNumChildShapes()===0)this.system.recreatePhysicalShapes(this._compoundParent);else{const e=this.system._getNodeTransform(this.entity,this._compoundParent.entity);this._compoundParent.shape.addChildShape(e,this.data.shape),Ammo.destroy(e),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()}else this.entity.trigger&&this.entity.trigger.enable()}onDisable(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()}onBeforeRemove(){this.asset&&(this.asset=null),this.renderAsset&&(this.renderAsset=null),this.entity.off("insert",this._onInsert,this),this.off()}}co.EVENT_CONTACT="contact";co.EVENT_COLLISIONSTART="collisionstart";co.EVENT_COLLISIONEND="collisionend";co.EVENT_TRIGGERENTER="triggerenter";co.EVENT_TRIGGERLEAVE="triggerleave";class CB{constructor(){this.enabled=!0,this.type="box",this.halfExtents=new y(.5,.5,.5),this.linearOffset=new y,this.angularOffset=new re,this.radius=.5,this.axis=1,this.height=2,this.asset=null,this.renderAsset=null,this.checkVertexDuplicates=!0,this.shape=null,this.model=null,this.render=null,this.initialized=!1}}const Ih="static",mi="dynamic",Do="kinematic",AB=2,Hh=4,Tg=1,ax=4,yT=5,PB=1,ox=2,MB=4,vf=16,lx=65535,Eg=65533;let _i,ta,Oo;class vT{constructor(e,t,s){this.entity=t.entity,this.component=t,this.app=e,typeof Ammo<"u"&&!_i&&(_i=new Ammo.btVector3,ta=new Ammo.btQuaternion,Oo=new Ammo.btTransform),this.initialize(s)}initialize(e){const t=this.entity,s=e.shape;if(s&&typeof Ammo<"u"){t.trigger&&t.trigger.destroy();const i=1,n=this.component;if(n){const o=n.getShapePosition(),l=n.getShapeRotation();_i.setValue(o.x,o.y,o.z),ta.setValue(l.x,l.y,l.z,l.w)}else{const o=t.getPosition(),l=t.getRotation();_i.setValue(o.x,o.y,o.z),ta.setValue(l.x,l.y,l.z,l.w)}Oo.setOrigin(_i),Oo.setRotation(ta);const a=this.app.systems.rigidbody.createBody(i,s,Oo);a.setRestitution(0),a.setFriction(0),a.setDamping(0,0),_i.setValue(0,0,0),a.setLinearFactor(_i),a.setAngularFactor(_i),a.setCollisionFlags(a.getCollisionFlags()|Hh),a.entity=t,this.body=a,this.component.enabled&&t.enabled&&this.enable()}}destroy(){const e=this.body;e&&(this.disable(),this.app.systems.rigidbody.destroyBody(e))}_getEntityTransform(e){const t=this.component;if(t){const s=t.getShapePosition(),i=t.getShapeRotation();_i.setValue(s.x,s.y,s.z),ta.setValue(i.x,i.y,i.z,i.w)}else{const s=this.entity.getPosition(),i=this.entity.getRotation();_i.setValue(s.x,s.y,s.z),ta.setValue(i.x,i.y,i.z,i.w)}e.setOrigin(_i),e.setRotation(ta)}updateTransform(){this._getEntityTransform(Oo);const e=this.body;e.setWorldTransform(Oo),e.activate()}enable(){const e=this.body;if(!e)return;const t=this.app.systems;t.rigidbody.addBody(e,vf,Eg^vf),t.rigidbody._triggers.push(this),e.forceActivationState(Tg),this.updateTransform()}disable(){const e=this.body;if(!e)return;const t=this.app.systems,s=t.rigidbody._triggers.indexOf(this);s>-1&&t.rigidbody._triggers.splice(s,1),t.rigidbody.removeBody(e),e.forceActivationState(yT)}}const fu=new q,IB=new y,RB=new y,sa=new re,LB=new ze,ST=["enabled","type","halfExtents","linearOffset","angularOffset","radius","axis","height","asset","renderAsset","shape","model","render","checkVertexDuplicates"];class uo{constructor(e){this.system=e}beforeInitialize(e,t){t.shape=null,t.model=new $n,t.model.graph=new ze}afterInitialize(e,t){this.recreatePhysicalShapes(e),e.data.initialized=!0}reset(e,t){this.beforeInitialize(e,t),this.afterInitialize(e,t)}recreatePhysicalShapes(e){const t=e.entity,s=e.data;if(typeof Ammo<"u"){t.trigger&&(t.trigger.destroy(),delete t.trigger),s.shape&&(e._compoundParent&&(this.system._removeCompoundChild(e._compoundParent,s.shape),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate()),this.destroyShape(s)),s.shape=this.createPhysicalShape(e.entity,s);const i=!e._compoundParent;if(s.type==="compound"&&(!e._compoundParent||e===e._compoundParent))e._compoundParent=e,t.forEach(this._addEachDescendant,e);else if(s.type!=="compound"&&(e._compoundParent&&e===e._compoundParent&&t.forEach(this.system.implementations.compound._updateEachDescendant,e),!e.rigidbody)){e._compoundParent=null;let n=t.parent;for(;n;){if(n.collision&&n.collision.type==="compound"){e._compoundParent=n.collision;break}n=n.parent}}e._compoundParent&&e!==e._compoundParent&&(i&&e._compoundParent.shape.getNumChildShapes()===0?this.system.recreatePhysicalShapes(e._compoundParent):(this.system.updateCompoundChildTransform(t),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate())),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):e._compoundParent||(t.trigger?t.trigger.initialize(s):t.trigger=new vT(this.system.app,e,s))}}createPhysicalShape(e,t){}updateTransform(e,t,s,i){e.entity.trigger&&e.entity.trigger.updateTransform()}destroyShape(e){e.shape&&(Ammo.destroy(e.shape),e.shape=null)}beforeRemove(e,t){t.data.shape&&(t._compoundParent&&!t._compoundParent.entity._destroying&&(this.system._removeCompoundChild(t._compoundParent,t.data.shape),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate()),t._compoundParent=null,this.destroyShape(t.data))}remove(e,t){e.rigidbody&&e.rigidbody.body&&e.rigidbody.disableSimulation(),e.trigger&&(e.trigger.destroy(),delete e.trigger)}clone(e,t){const s=this.system.store[e.getGuid()],i={enabled:s.data.enabled,type:s.data.type,halfExtents:[s.data.halfExtents.x,s.data.halfExtents.y,s.data.halfExtents.z],linearOffset:[s.data.linearOffset.x,s.data.linearOffset.y,s.data.linearOffset.z],angularOffset:[s.data.angularOffset.x,s.data.angularOffset.y,s.data.angularOffset.z,s.data.angularOffset.w],radius:s.data.radius,axis:s.data.axis,height:s.data.height,asset:s.data.asset,renderAsset:s.data.renderAsset,model:s.data.model,render:s.data.render,checkVertexDuplicates:s.data.checkVertexDuplicates};return this.system.addComponent(t,i)}}class DB extends uo{createPhysicalShape(e,t){if(typeof Ammo<"u"){const s=t.halfExtents,i=new Ammo.btVector3(s?s.x:.5,s?s.y:.5,s?s.z:.5),n=new Ammo.btBoxShape(i);return Ammo.destroy(i),n}}}class OB extends uo{createPhysicalShape(e,t){if(typeof Ammo<"u")return new Ammo.btSphereShape(t.radius)}}class FB extends uo{createPhysicalShape(e,t){var s,i,n;const a=(s=t.axis)!=null?s:1,o=(i=t.radius)!=null?i:.5,l=Math.max(((n=t.height)!=null?n:2)-2*o,0);let c=null;if(typeof Ammo<"u")switch(a){case 0:c=new Ammo.btCapsuleShapeX(o,l);break;case 1:c=new Ammo.btCapsuleShape(o,l);break;case 2:c=new Ammo.btCapsuleShapeZ(o,l);break}return c}}class kB extends uo{createPhysicalShape(e,t){var s,i,n;const a=(s=t.axis)!=null?s:1,o=(i=t.radius)!=null?i:.5,l=(n=t.height)!=null?n:1;let c=null,d=null;if(typeof Ammo<"u")switch(a){case 0:c=new Ammo.btVector3(l*.5,o,o),d=new Ammo.btCylinderShapeX(c);break;case 1:c=new Ammo.btVector3(o,l*.5,o),d=new Ammo.btCylinderShape(c);break;case 2:c=new Ammo.btVector3(o,o,l*.5),d=new Ammo.btCylinderShapeZ(c);break}return c&&Ammo.destroy(c),d}}class BB extends uo{createPhysicalShape(e,t){var s,i,n;const a=(s=t.axis)!=null?s:1,o=(i=t.radius)!=null?i:.5,l=(n=t.height)!=null?n:1;let c=null;if(typeof Ammo<"u")switch(a){case 0:c=new Ammo.btConeShapeX(o,l);break;case 1:c=new Ammo.btConeShape(o,l);break;case 2:c=new Ammo.btConeShapeZ(o,l);break}return c}}class NB extends uo{beforeInitialize(e,t){}createAmmoMesh(e,t,s,i,n=!0){const a=this.system;let o;if(a._triMeshCache[e.id])o=a._triMeshCache[e.id];else{const h=e.vertexBuffer,u=h.getFormat();let f,p;for(let L=0;L<u.elements.length;L++){const V=u.elements[L];if(V.name===ht){p=new Float32Array(h.lock(),V.offset),f=V.stride/4;break}}const _=[];e.getIndices(_);const m=e.primitive[0].count/3,g=new Ammo.btVector3;let v,x,S;const w=e.primitive[0].base;o=new Ammo.btTriangleMesh,a._triMeshCache[e.id]=o;const T=new Map,b=o.getIndexedMeshArray();b.at(0).m_numTriangles=m;const C=i?i.x:1,E=i?i.y:1,R=i?i.z:1,B=L=>{const V=p[L*f]*C,I=p[L*f+1]*E,F=p[L*f+2]*R;let D;if(n){const A=`${V}:${I}:${F}`;if(D=T.get(A),D!==void 0)return D;g.setValue(V,I,F),D=o.findOrAddVertex(g,!1),T.set(A,D)}else g.setValue(V,I,F),D=o.findOrAddVertex(g,!1);return D};for(var l=0;l<m;l++)v=B(_[w+l*3]),x=B(_[w+l*3+1]),S=B(_[w+l*3+2]),o.addIndex(v),o.addIndex(x),o.addIndex(S);Ammo.destroy(g)}const c=new Ammo.btBvhTriangleMeshShape(o,!0);if(!i){const h=a._getNodeScaling(t);c.setLocalScaling(h),Ammo.destroy(h)}const d=a._getNodeTransform(t);s.addChildShape(d,c),Ammo.destroy(d)}createPhysicalShape(e,t){if(!(typeof Ammo>"u")&&(t.model||t.render)){const s=new Ammo.btCompoundShape,n=e.getWorldTransform().getScale();if(t.model){const a=t.model.meshInstances;for(let l=0;l<a.length;l++)this.createAmmoMesh(a[l].mesh,a[l].node,s,null,t.checkVertexDuplicates);const o=new Ammo.btVector3(n.x,n.y,n.z);s.setLocalScaling(o),Ammo.destroy(o)}else if(t.render){const a=t.render.meshes;for(let o=0;o<a.length;o++)this.createAmmoMesh(a[o],LB,s,n,t.checkVertexDuplicates)}return s}}recreatePhysicalShapes(e){const t=e.data;if((t.renderAsset||t.asset)&&e.enabled&&e.entity.enabled){this.loadAsset(e,t.renderAsset||t.asset,t.renderAsset?"render":"model");return}this.doRecreatePhysicalShape(e)}loadAsset(e,t,s){const i=e.data,n=this.system.app.assets,a=i[s],o=d=>{i[s]===a&&(i[s]=d.resource,this.doRecreatePhysicalShape(e))},l=d=>{d.ready(h=>{if(h.data.containerAsset){const u=n.get(h.data.containerAsset);u.loaded?o(h):(u.ready(()=>{o(h)}),n.load(u))}else o(h)}),n.load(d)},c=n.get(t);c?l(c):n.once("add:"+t,l)}doRecreatePhysicalShape(e){const t=e.entity,s=e.data;s.model||s.render?(this.destroyShape(s),s.shape=this.createPhysicalShape(t,s),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):t.trigger?t.trigger.initialize(s):t.trigger=new vT(this.system.app,e,s)):(this.beforeRemove(t,e),this.remove(t,s))}updateTransform(e,t,s,i){if(e.shape){const a=e.entity.getWorldTransform().getScale(),o=e.shape.getLocalScaling();(a.x!==o.x()||a.y!==o.y()||a.z!==o.z())&&this.doRecreatePhysicalShape(e)}super.updateTransform(e,t,s,i)}destroyShape(e){if(!e.shape)return;const t=e.shape.getNumChildShapes();for(let s=0;s<t;s++){const i=e.shape.getChildShape(s);Ammo.destroy(i)}Ammo.destroy(e.shape),e.shape=null}}class UB extends uo{createPhysicalShape(e,t){if(typeof Ammo<"u")return new Ammo.btCompoundShape}_addEachDescendant(e){!e.collision||e.rigidbody||(e.collision._compoundParent=this,e!==this.entity&&e.collision.system.recreatePhysicalShapes(e.collision))}_updateEachDescendant(e){e.collision&&e.collision._compoundParent===this&&(e.collision._compoundParent=null,e!==this.entity&&!e.rigidbody&&e.collision.system.recreatePhysicalShapes(e.collision))}_updateEachDescendantTransform(e){!e.collision||e.collision._compoundParent!==this.collision._compoundParent||this.collision.system.updateCompoundChildTransform(e)}}class zB extends tt{constructor(e){super(e),this.id="collision",this.ComponentType=co,this.DataType=CB,this.schema=ST,this.implementations={},this._triMeshCache={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)}initializeComponentData(e,t,s){s=["type","halfExtents","radius","axis","height","shape","model","asset","render","renderAsset","enabled","linearOffset","angularOffset","checkVertexDuplicates"];const i={};for(let o=0,l=s.length;o<l;o++){const c=s[o];i[c]=t[c]}let n;if(t.hasOwnProperty("asset")?(n=s.indexOf("model"),n!==-1&&s.splice(n,1),n=s.indexOf("render"),n!==-1&&s.splice(n,1)):t.hasOwnProperty("model")&&(n=s.indexOf("asset"),n!==-1&&s.splice(n,1)),i.type||(i.type=e.data.type),e.data.type=i.type,Array.isArray(i.halfExtents)&&(i.halfExtents=new y(i.halfExtents)),Array.isArray(i.linearOffset)&&(i.linearOffset=new y(i.linearOffset)),Array.isArray(i.angularOffset)){const o=i.angularOffset;o.length===3?i.angularOffset=new re().setFromEulerAngles(o[0],o[1],o[2]):i.angularOffset=new re(i.angularOffset)}const a=this._createImplementation(i.type);a.beforeInitialize(e,i),super.initializeComponentData(e,i,s),a.afterInitialize(e,i)}_createImplementation(e){if(this.implementations[e]===void 0){let t;switch(e){case"box":t=new DB(this);break;case"sphere":t=new OB(this);break;case"capsule":t=new FB(this);break;case"cylinder":t=new kB(this);break;case"cone":t=new BB(this);break;case"mesh":t=new NB(this);break;case"compound":t=new UB(this);break}this.implementations[e]=t}return this.implementations[e]}_getImplementation(e){return this.implementations[e.collision.data.type]}cloneComponent(e,t){return this._getImplementation(e).clone(e,t)}onBeforeRemove(e,t){this.implementations[t.data.type].beforeRemove(e,t),t.onBeforeRemove()}onRemove(e,t){this.implementations[t.type].remove(e,t)}updateCompoundChildTransform(e){if(this._removeCompoundChild(e.collision._compoundParent,e.collision.data.shape),e.enabled&&e.collision.enabled){const t=this._getNodeTransform(e,e.collision._compoundParent.entity);e.collision._compoundParent.shape.addChildShape(t,e.collision.data.shape),Ammo.destroy(t)}}_removeCompoundChild(e,t){if(e.shape.removeChildShape)e.shape.removeChildShape(t);else{const s=e._getCompoundChildShapeIndex(t);s!==null&&e.shape.removeChildShapeByIndex(s)}}onTransformChanged(e,t,s,i){this.implementations[e.data.type].updateTransform(e,t,s,i)}changeType(e,t,s){this.implementations[t].beforeRemove(e.entity,e),this.implementations[t].remove(e.entity,e.data),this._createImplementation(s).reset(e,e.data)}recreatePhysicalShapes(e){this.implementations[e.data.type].recreatePhysicalShapes(e)}_calculateNodeRelativeTransform(e,t){if(e===t){const s=e.getWorldTransform().getScale();fu.setScale(s.x,s.y,s.z)}else this._calculateNodeRelativeTransform(e.parent,t),fu.mul(e.getLocalTransform())}_getNodeScaling(e){const s=e.getWorldTransform().getScale();return new Ammo.btVector3(s.x,s.y,s.z)}_getNodeTransform(e,t){let s,i;t?(this._calculateNodeRelativeTransform(e,t),s=IB,i=sa,fu.getTranslation(s),i.setFromMat4(fu)):(s=e.getPosition(),i=e.getRotation());const n=new Ammo.btQuaternion,a=new Ammo.btTransform;a.setIdentity();const o=a.getOrigin(),l=e.collision;if(l&&l._hasOffset){const c=l.data.linearOffset,d=l.data.angularOffset,h=RB;sa.copy(i).transformVector(c,h),h.add(s),sa.copy(i).mul(d),o.setValue(h.x,h.y,h.z),n.setValue(sa.x,sa.y,sa.z,sa.w)}else o.setValue(s.x,s.y,s.z),n.setValue(i.x,i.y,i.z,i.w);return a.setRotation(n),Ammo.destroy(n),Ammo.destroy(o),a}destroy(){for(const e in this._triMeshCache)Ammo.destroy(this._triMeshCache[e]);this._triMeshCache=null,super.destroy()}}ge._buildAccessors(co.prototype,ST);const VB=new di;class GB{constructor(e,t,s){this._entity=e,this._element=e.element,this.model=new $n,this.node=new ze,this.model.graph=this.node,this.mesh=t,this.meshInstance=new Fe(this.mesh,s,this.node),this.meshInstance.name="ImageElement: "+e.name,this.meshInstance.castShadow=!1,this.meshInstance.receiveShadow=!1,this._meshDirty=!1,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null}destroy(){this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this.model=null,this.node=null,this.mesh=null,this.meshInstance=null,this._entity=null,this._element=null}setMesh(e){this.meshInstance&&(this.mesh=e,this.meshInstance.mesh=e,this.meshInstance.visible=!!e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=e),this.forceUpdateAabb())}setMask(e){if(this.meshInstance){if(e){this.unmaskMeshInstance=new Fe(this.mesh,this.meshInstance.material,this.node),this.unmaskMeshInstance.name="Unmask: "+this._entity.name,this.unmaskMeshInstance.castShadow=!1,this.unmaskMeshInstance.receiveShadow=!1,this.unmaskMeshInstance.pick=!1,this.model.meshInstances.push(this.unmaskMeshInstance);for(const t in this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(t,this.meshInstance.parameters[t].data)}else{const t=this.model.meshInstances.indexOf(this.unmaskMeshInstance);t>=0&&this.model.meshInstances.splice(t,1),this.unmaskMeshInstance=null}this._entity.enabled&&this._element.enabled&&(this._element.removeModelFromLayers(this.model),this._element.addModelToLayers(this.model))}}setMaterial(e){this.meshInstance&&(this.meshInstance.material=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=e))}setParameter(e,t){this.meshInstance&&(this.meshInstance.setParameter(e,t),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(e,t))}deleteParameter(e){this.meshInstance&&(this.meshInstance.deleteParameter(e),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(e))}setUnmaskDrawOrder(){if(!this.meshInstance)return;const e=function t(s){let i;const n=s.children,a=n.length;if(a){for(let l=0;l<a;l++)n[l].element&&(i=n[l]);if(!i)return null;const o=t(i);return o||i}return null};if(this.unmaskMeshInstance){const t=e(this._entity);t&&t.element?this.unmaskMeshInstance.drawOrder=t.element.drawOrder+t.element.getMaskOffset():this.unmaskMeshInstance.drawOrder=this.meshInstance.drawOrder+this._element.getMaskOffset()}}setDrawOrder(e){this.meshInstance&&(this.meshInstance.drawOrder=e)}setCull(e){if(!this.meshInstance)return;const t=this._element;let s=null;e&&t._isScreenSpace()&&(s=function(i){return t.isVisibleForCamera(i)}),this.meshInstance.cull=e,this.meshInstance.isVisibleFunc=s,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=e,this.unmaskMeshInstance.isVisibleFunc=s)}setScreenSpace(e){this.meshInstance&&(this.meshInstance.screenSpace=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=e))}setLayer(e){this.meshInstance&&(this.meshInstance.layer=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=e))}forceUpdateAabb(e){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))}setAabbFunc(e){this.meshInstance&&(this.meshInstance._updateAabbFunc=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=e))}}class HB{constructor(e){this._element=e,this._entity=e.entity,this._system=e.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._spriteAsset=null,this._sprite=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._targetAspectRatio=-1,this._rect=new P(0,0,1,1),this._mask=!1,this._maskRef=0,this._outerScale=new M,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new P,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new P,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new GB(this._entity,this._defaultMesh,this._material),this._color=new k(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this)}destroy(){this.textureAsset=null,this.spriteAsset=null,this.materialAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this)}_onResolutionChange(e){}_onParentResizeOrPivotChange(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)}_onScreenSpaceChange(e){this._updateMaterial(e)}_onScreenChange(e,t){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)}_onDrawOrderChange(e){this._renderable.setDrawOrder(e),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder()},this)}_hasUserMaterial(){return!!this._materialAsset||!!this._material&&this._system.defaultImageMaterials.indexOf(this._material)===-1}_use9Slicing(){return this.sprite&&(this.sprite.renderMode===wt||this.sprite.renderMode===mt)}_updateMaterial(e){const t=!!this._mask,s=!!(this.sprite&&this.sprite.renderMode===wt),i=!!(this.sprite&&this.sprite.renderMode===mt);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(e,t,s,i)),this._renderable&&(this._renderable.setCull(!this._element._isScreenSpace()||this._element._isScreenCulled()),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(e),this._renderable.setLayer(e?lI:Ib))}_createMesh(){const e=this._element,t=e.calculatedWidth,s=e.calculatedHeight,i=this._rect,n=this._system.app.graphicsDevice,a=new Float32Array([t,0,0,0,0,1,i.x+i.z,1-i.y,t,s,0,0,0,1,i.x+i.z,1-(i.y+i.w),0,0,0,0,0,1,i.x,1-i.y,0,s,0,0,0,1,i.x,1-(i.y+i.w)]),o=VB.get(n,()=>new os(n,[{semantic:ht,components:3,type:Me},{semantic:Us,components:3,type:Me},{semantic:zs,components:2,type:Me}])),l=new Mi(n,o,4,as,a.buffer),c=new Vs(n);return c.vertexBuffer=l,c.primitive[0].type=Ji,c.primitive[0].base=0,c.primitive[0].count=4,c.primitive[0].indexed=!1,c.aabb.setMinMax(y.ZERO,new y(t,s,0)),this._updateMesh(c),c}_updateMesh(e){const t=this._element;let s=t.calculatedWidth,i=t.calculatedHeight;if(t.fitMode!==Xu&&this._targetAspectRatio>0){const a=t.calculatedWidth/t.calculatedHeight;t.fitMode===wB&&a>this._targetAspectRatio||t.fitMode===bB&&a<this._targetAspectRatio?s=t.calculatedHeight*this._targetAspectRatio:i=t.calculatedWidth/this._targetAspectRatio}const n=t._isScreenSpace();if(this._updateMaterial(n),this._renderable&&this._renderable.forceUpdateAabb(),this.sprite&&(this.sprite.renderMode===wt||this.sprite.renderMode===mt)){const a=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],o=2/a.rect.z,l=2/a.rect.w;this._innerOffset.set(a.border.x*o,a.border.y*l,a.border.z*o,a.border.w*l);const c=this.sprite.atlas.texture;this._atlasRect.set(a.rect.x/c.width,a.rect.y/c.height,a.rect.z/c.width,a.rect.w/c.height);const d=this._pixelsPerUnit!==null?this._pixelsPerUnit:this.sprite.pixelsPerUnit,h=a.rect.z/d,u=a.rect.w/d;this._outerScale.set(Math.max(s,this._innerOffset.x*h),Math.max(i,this._innerOffset.y*u));let f=h,p=u;this._outerScale.x/=h,this._outerScale.y/=u,f*=H.clamp(s/(this._innerOffset.x*h),1e-4,1),p*=H.clamp(i/(this._innerOffset.y*u),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(f,p,1),this._renderable.node.setLocalPosition((.5-t.pivot.x)*s,(.5-t.pivot.y)*i,0))}else{const a=e.vertexBuffer,o=new Float32Array(a.lock()),l=t.pivot.x,c=t.pivot.y;o[0]=s-l*s,o[1]=0-c*i,o[8]=s-l*s,o[9]=i-c*i,o[16]=0-l*s,o[17]=0-c*i,o[24]=0-l*s,o[25]=i-c*i;let d=1,h=1,u=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){const _=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];_&&(u=_.rect,d=this._sprite.atlas.texture.width,h=this._sprite.atlas.texture.height)}o[6]=(u.x+u.z)/d,o[7]=1-u.y/h,o[14]=(u.x+u.z)/d,o[15]=1-(u.y+u.w)/h,o[22]=u.x/d,o[23]=1-u.y/h,o[30]=u.x/d,o[31]=1-(u.y+u.w)/h,a.unlock();const f=new y(0-l*s,0-c*i,0),p=new y(s-l*s,i-c*i,0);e.aabb.setMinMax(f,p),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}this._meshDirty=!1}_updateSprite(){let e=!1,t=null;if(this._targetAspectRatio=-1,this._sprite&&this._sprite.atlas){t=this._sprite.meshes[this.spriteFrame],e=this._sprite.renderMode===wt||this._sprite.renderMode===mt;const s=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];(s==null?void 0:s.rect.w)>0&&(this._targetAspectRatio=s.rect.z/s.rect.w)}this.mesh=e?t:this._defaultMesh,this.refreshMesh()}refreshMesh(){this.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh))}_updateAabb(e){return e.center.set(0,0,0),e.halfExtents.set(this._outerScale.x*.5,this._outerScale.y*.5,.001),e.setFromTransformedAabb(e,this._renderable.node.getWorldTransform()),e}_toggleMask(){this._element._dirtifyMask();const e=this._element._isScreenSpace();this._updateMaterial(e),this._renderable.setMask(!!this._mask)}_onMaterialLoad(e){this.material=e.resource}_onMaterialAdded(e){this._system.app.assets.off("add:"+e.id,this._onMaterialAdded,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)}_bindMaterialAsset(e){this._entity.enabled&&(e.on("load",this._onMaterialLoad,this),e.on("change",this._onMaterialChange,this),e.on("remove",this._onMaterialRemove,this),e.resource?this._onMaterialLoad(e):this._system.app.assets.load(e))}_unbindMaterialAsset(e){e.off("load",this._onMaterialLoad,this),e.off("change",this._onMaterialChange,this),e.off("remove",this._onMaterialRemove,this)}_onMaterialChange(){}_onMaterialRemove(){}_onTextureAdded(e){this._system.app.assets.off("add:"+e.id,this._onTextureAdded,this),this._textureAsset===e.id&&this._bindTextureAsset(e)}_bindTextureAsset(e){this._entity.enabled&&(e.on("load",this._onTextureLoad,this),e.on("change",this._onTextureChange,this),e.on("remove",this._onTextureRemove,this),e.resource?this._onTextureLoad(e):this._system.app.assets.load(e))}_unbindTextureAsset(e){e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this)}_onTextureLoad(e){this.texture=e.resource}_onTextureChange(e){}_onTextureRemove(e){}_onSpriteAssetAdded(e){this._system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)}_bindSpriteAsset(e){this._entity.enabled&&(e.on("load",this._onSpriteAssetLoad,this),e.on("change",this._onSpriteAssetChange,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._system.app.assets.load(e))}_unbindSpriteAsset(e){e.off("load",this._onSpriteAssetLoad,this),e.off("change",this._onSpriteAssetChange,this),e.off("remove",this._onSpriteAssetRemove,this),e.data.textureAtlasAsset&&this._system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this)}_onSpriteAssetLoad(e){if(!e||!e.resource)this.sprite=null;else if(e.resource.atlas)this.sprite=e.resource;else{const t=e.data.textureAtlasAsset;if(t){const s=this._system.app.assets;s.off("load:"+t,this._onTextureAtlasLoad,this),s.once("load:"+t,this._onTextureAtlasLoad,this)}}}_onSpriteAssetChange(e){this._onSpriteAssetLoad(e)}_onSpriteAssetRemove(e){}_bindSprite(e){e.on("set:meshes",this._onSpriteMeshesChange,this),e.on("set:pixelsPerUnit",this._onSpritePpuChange,this),e.on("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.on("set:texture",this._onAtlasTextureChange,this)}_unbindSprite(e){e.off("set:meshes",this._onSpriteMeshesChange,this),e.off("set:pixelsPerUnit",this._onSpritePpuChange,this),e.off("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.off("set:texture",this._onAtlasTextureChange,this)}_onSpriteMeshesChange(){this._sprite&&(this._spriteFrame=H.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}_onSpritePpuChange(){this.sprite.renderMode!==Pn&&this._pixelsPerUnit===null&&this._updateSprite()}_onAtlasTextureChange(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}_onTextureAtlasLoad(e){const t=this._spriteAsset;t instanceof ne?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._system.app.assets.get(t))}onEnable(){if(this._materialAsset){const e=this._system.app.assets.get(this._materialAsset);e&&e.resource!==this._material&&this._bindMaterialAsset(e)}if(this._textureAsset){const e=this._system.app.assets.get(this._textureAsset);e&&e.resource!==this._texture&&this._bindTextureAsset(e)}if(this._spriteAsset){const e=this._system.app.assets.get(this._spriteAsset);e&&e.resource!==this._sprite&&this._bindSpriteAsset(e)}this._element.addModelToLayers(this._renderable.model)}onDisable(){this._element.removeModelFromLayers(this._renderable.model)}_setStencil(e){this._renderable.meshInstance.stencilFront=e,this._renderable.meshInstance.stencilBack=e;let t=0;if(this._element.maskedBy&&(t=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance){const s=new oi({ref:t+1,func:tf,zpass:s1});this._renderable.unmaskMeshInstance.stencilFront=s,this._renderable.unmaskMeshInstance.stencilBack=s}}set color(e){const t=e.r,s=e.g,i=e.b;(this._color.r!==t||this._color.g!==s||this._color.b!==i)&&(this._color.r=t,this._color.g=s,this._color.b=i,this._colorUniform[0]=t,this._colorUniform[1]=s,this._colorUniform[2]=i,this._renderable.setParameter("material_emissive",this._colorUniform)),this._element&&this._element.fire("set:color",this._color)}get color(){return this._color}set opacity(e){e!==this._color.a&&(this._color.a=e,this._renderable.setParameter("material_opacity",e)),this._element&&this._element.fire("set:opacity",e)}get opacity(){return this._color.a}set rect(e){let t,s,i,n;e instanceof P?(t=e.x,s=e.y,i=e.z,n=e.w):(t=e[0],s=e[1],i=e[2],n=e[3]),!(t===this._rect.x&&s===this._rect.y&&i===this._rect.z&&n===this._rect.w)&&(this._rect.set(t,s,i,n),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh)))}get rect(){return this._rect}_removeMaterialAssetEvents(){if(this._materialAsset){const e=this._system.app.assets;e.off("add:"+this._materialAsset,this._onMaterialAdded,this);const t=e.get(this._materialAsset);t&&(t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this))}}set material(e){if(this._material!==e){if(!e){const t=this._element._isScreenSpace();this.mask?e=t?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:e=t?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial}if(this._material=e,this._materialAsset){const t=this._system.app.assets.get(this._materialAsset);(!t||t.resource!==e)&&(this._removeMaterialAssetEvents(),this._materialAsset=null)}e&&(this._renderable.setMaterial(e),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)))}}get material(){return this._material}set materialAsset(e){const t=this._system.app.assets;let s=e;if(e instanceof ne&&(s=e.id),this._materialAsset!==s)if(this._removeMaterialAssetEvents(),this._materialAsset=s,this._materialAsset){const i=t.get(this._materialAsset);i?this._bindMaterialAsset(i):(this._materialAsset=null,this.material=null,this._materialAsset=s,t.on("add:"+this._materialAsset,this._onMaterialAdded,this))}else this._materialAsset=null,this.material=null,this._materialAsset=s}get materialAsset(){return this._materialAsset}set texture(e){if(this._texture!==e){if(this._textureAsset){const t=this._system.app.assets.get(this._textureAsset);t&&t.resource!==e&&(this.textureAsset=null)}if(this._texture=e,e){this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a);const t=this._texture.width/this._texture.height;t!==this._targetAspectRatio&&(this._targetAspectRatio=t,this._element.fitMode!==Xu&&this.refreshMesh())}else this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"),this._targetAspectRatio=-1,this._element.fitMode!==Xu&&this.refreshMesh()}}get texture(){return this._texture}set textureAsset(e){const t=this._system.app.assets;let s=e;if(e instanceof ne&&(s=e.id),this._textureAsset!==s){if(this._textureAsset){t.off("add:"+this._textureAsset,this._onTextureAdded,this);const i=t.get(this._textureAsset);i&&(i.off("load",this._onTextureLoad,this),i.off("change",this._onTextureChange,this),i.off("remove",this._onTextureRemove,this))}if(this._textureAsset=s,this._textureAsset){const i=t.get(this._textureAsset);i?this._bindTextureAsset(i):(this.texture=null,t.on("add:"+this._textureAsset,this._onTextureAdded,this))}else this.texture=null}}get textureAsset(){return this._textureAsset}set spriteAsset(e){const t=this._system.app.assets;let s=e;if(e instanceof ne&&(s=e.id),this._spriteAsset!==s){if(this._spriteAsset){t.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this);const i=t.get(this._spriteAsset);i&&this._unbindSpriteAsset(i)}if(this._spriteAsset=s,this._spriteAsset){const i=t.get(this._spriteAsset);i?this._bindSpriteAsset(i):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}this._element&&this._element.fire("set:spriteAsset",s)}get spriteAsset(){return this._spriteAsset}set sprite(e){if(this._sprite!==e){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){const t=this._system.app.assets.get(this._spriteAsset);t&&t.resource!==e&&(this.spriteAsset=null)}this._sprite=e,this._sprite&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=H.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}}get sprite(){return this._sprite}set spriteFrame(e){const t=this._spriteFrame;this._sprite?this._spriteFrame=H.clamp(e,0,this._sprite.frameKeys.length-1):this._spriteFrame=e,this._spriteFrame!==t&&this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",e)}get spriteFrame(){return this._spriteFrame}set mesh(e){this._renderable.setMesh(e),this._defaultMesh===e?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}get mesh(){return this._renderable.mesh}set mask(e){this._mask!==e&&(this._mask=e,this._toggleMask())}get mask(){return this._mask}set pixelsPerUnit(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this._sprite&&(this._sprite.renderMode===wt||this._sprite.renderMode===mt)&&this._updateSprite())}get pixelsPerUnit(){return this._pixelsPerUnit}get aabb(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}class WB extends ie{constructor(e){super(),this._app=e,e.i18n.on("set:locale",this._onSetLocale,this),this._autoLoad=!1,this._disableLocalization=!1,this._defaultAsset=null,this._localizedAsset=null}set defaultAsset(e){const t=e instanceof ne?e.id:e;this._defaultAsset!==t&&(this._defaultAsset&&this._unbindDefaultAsset(),this._defaultAsset=t,this._defaultAsset&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}get defaultAsset(){return this._defaultAsset}set localizedAsset(e){const t=e instanceof ne?e.id:e;this._localizedAsset!==t&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset(),this._localizedAsset=null),this._localizedAsset=t,this._localizedAsset&&(this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this)))}get localizedAsset(){return this._localizedAsset}set autoLoad(e){this._autoLoad!==e&&(this._autoLoad=e,this._autoLoad&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset()))}get autoLoad(){return this._autoLoad}set disableLocalization(e){this._disableLocalization!==e&&(this._disableLocalization=e,this._onSetLocale(this._app.i18n.locale))}get disableLocalization(){return this._disableLocalization}_bindDefaultAsset(){const e=this._app.assets.get(this._defaultAsset);e?this._onDefaultAssetAdd(e):this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this)}_unbindDefaultAsset(){if(!this._defaultAsset)return;this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);const e=this._app.assets.get(this._defaultAsset);e&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleRemove,this),e.off("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetAdd(e){this._defaultAsset===e.id&&(e.on("add:localized",this._onLocaleAdd,this),e.on("remove:localized",this._onLocaleRemove,this),e.once("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetRemove(e){this._defaultAsset===e.id&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))}_bindLocalizedAsset(){if(!this._autoLoad)return;const e=this._app.assets.get(this._localizedAsset);e&&(e.on("load",this._onLocalizedAssetLoad,this),e.on("change",this._onLocalizedAssetChange,this),e.on("remove",this._onLocalizedAssetRemove,this),e.resource?this._onLocalizedAssetLoad(e):this._app.assets.load(e))}_unbindLocalizedAsset(){const e=this._app.assets.get(this._localizedAsset);e&&(e.off("load",this._onLocalizedAssetLoad,this),e.off("change",this._onLocalizedAssetChange,this),e.off("remove",this._onLocalizedAssetRemove,this))}_onLocalizedAssetAdd(e){this._localizedAsset===e.id&&this._bindLocalizedAsset()}_onLocalizedAssetLoad(e){this.fire("load",e)}_onLocalizedAssetChange(e,t,s,i){this.fire("change",e,t,s,i)}_onLocalizedAssetRemove(e){this._localizedAsset===e.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",e)}_onLocaleAdd(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)}_onLocaleRemove(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)}_onSetLocale(e){if(!this._defaultAsset){this.localizedAsset=null;return}const t=this._app.assets.get(this._defaultAsset);if(!t||this._disableLocalization){this.localizedAsset=this._defaultAsset;return}const s=t.getLocalizedAssetId(e);if(!s){this.localizedAsset=this._defaultAsset;return}this.localizedAsset=s}destroy(){this.defaultAsset=null,this._app.i18n.off("set:locale",this._onSetLocale,this),this.off()}}const Sf="msdf",jB="bitmap",Wh=0,qo=1,Cg=2,xT=3,Ag=4,Pg=5,Mg=6,Ig=7,hx=8,$B=` 	
\r\v\f`,XB=/[A-Z|a-z|0-9|_|-|/]/;class qB{constructor(e){this._symbols=e,this._index=0,this._last=0,this._cur=this._symbols.length>0?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null}read(){let e=this._read();for(;e===hx;)e=this._read();return e!==Wh&&e!==qo&&(this._last=this._index),e}buf(){return this._buf}last(){return this._last}error(){return this._error}debugPrint(){const e=["EOF","ERROR","TEXT","OPEN_BRACKET","CLOSE_BRACKET","EQUALS","STRING","IDENTIFIER","WHITESPACE"];let t=this.read(),s="";for(;s+=(s.length>0?`
`:"")+e[t]+" '"+this.buf().join("")+"'",!(t===Wh||t===qo);)t=this.read();return s}_read(){return this._buf=[],this._eof()?Wh:this._mode==="text"?this._text():this._tag()}_text(){for(;;)switch(this._cur){case null:return this._buf.length>0?Cg:Wh;case"[":return this._mode="tag",this._buf.length>0?Cg:this._tag();case"\\":switch(this._next(),this._cur){case"[":this._store();break;default:this._output("\\");break}break;default:this._store();break}}_tag(){switch(this._cur){case null:return this._error="unexpected end of input reading tag",qo;case"[":return this._store(),xT;case"]":return this._store(),this._mode="text",Ag;case"=":return this._store(),Pg;case" ":case"	":case`
`:case"\r":case"\v":case"\f":return this._whitespace();case'"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",qo)}}_whitespace(){for(this._store();$B.indexOf(this._cur)!==-1;)this._store();return hx}_string(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",qo;case'"':return this._next(),Mg;default:this._store();break}}_identifier(){for(this._store();this._cur!==null&&this._isIdentifierSymbol(this._cur);)this._store();return Ig}_isIdentifierSymbol(e){return e.length===1&&e.match(XB)!==null}_eof(){return this._cur===null}_next(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur}_store(){return this._buf.push(this._cur),this._next()}_output(e){this._buf.push(e)}}class KB{constructor(e){this._scanner=new qB(e),this._error=null}parse(e,t){for(;;)switch(this._scanner.read()){case Wh:return!0;case qo:return!1;case Cg:Array.prototype.push.apply(e,this._scanner.buf());break;case xT:if(!this._parseTag(e,t))return!1;break;default:return!1}}error(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"}_parseTag(e,t){let s=this._scanner.read();if(s!==Ig)return this._error="expected identifier",!1;const i=this._scanner.buf().join("");if(i[0]==="/"){for(let a=t.length-1;a>=0;--a)if(i==="/"+t[a].name&&t[a].end===null)return t[a].end=e.length,s=this._scanner.read(),s!==Ag?(this._error="expected close bracket",!1):!0;return this._error="failed to find matching tag",!1}const n={name:i,value:null,attributes:{},start:e.length,end:null};if(s=this._scanner.read(),s===Pg){if(s=this._scanner.read(),s!==Mg)return this._error="expected string",!1;n.value=this._scanner.buf().join(""),s=this._scanner.read()}for(;;){switch(s){case Ag:return t.push(n),!0;case Ig:{const a=this._scanner.buf().join("");if(s=this._scanner.read(),s!==Pg)return this._error="expected equals",!1;if(s=this._scanner.read(),s!==Mg)return this._error="expected string",!1;const o=this._scanner.buf().join("");n.attributes[a]=o;break}default:return this._error="expected close bracket or identifier",!1}s=this._scanner.read()}}}function wT(r,e){for(const t in e){if(!e.hasOwnProperty(t))continue;const s=e[t];s instanceof Object?(r.hasOwnProperty(t)||(r[t]={}),wT(r[t],e[t])):r[t]=s}}function YB(r){if(r.length===0)return null;const e={};for(let t=0;t<r.length;++t){const s=r[t],i={};i[s.name]={value:s.value,attributes:s.attributes},wT(e,i)}return e}function ZB(r,e){if(r.length===0)return null;const t={};for(let d=0;d<r.length;++d){const h=r[d];t.hasOwnProperty(h.start)?t[h.start].open===null?t[h.start].open=[h]:t[h.start].open.push(h):t[h.start]={open:[h],close:null},t.hasOwnProperty(h.end)?t[h.end].close===null?t[h.end].close=[h]:t[h.end].close.push(h):t[h.end]={open:null,close:[h]}}let s=[];function i(d){s=s.filter(function(h){return d.find(function(u){return u===h})===void 0})}function n(d){for(let h=0;h<d.length;++h)s.push(d[h])}const a=Object.keys(t).sort(function(d,h){return d-h}),o=[];for(let d=0;d<a.length;++d){const h=t[a[d]];h.close!==null&&i(h.close),h.open!==null&&n(h.open),o.push({start:a[d],tags:YB(s)})}const l=[];let c=null;for(let d=0;d<o.length;++d){const h=o[d];for(;l.length<h.start;)l.push(c?c.tags:null);c=h}for(;l.length<e;)l.push(null);return l}function JB(r){const e=new KB(r),t=[],s=[];if(!e.parse(t,s))return console.warn(e.error()),{symbols:r,tags:null};const i=s.find(function(a){return a.end===null});if(i)return console.warn(`Markup error: found unclosed tag='${i.name}'`),{symbols:r,tags:null};const n=ZB(s,t.length);return{symbols:t,tags:n}}class QB{static evaluate(e){return JB(e)}}class eN{constructor(){this.count=0,this.quad=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.outlines=[],this.shadows=[],this.meshInstance=null}}function tN(r,e){const t=new Vs(r);return t.setPositions(e.positions),t.setNormals(e.normals),t.setColors32(e.colors),t.setUvs(0,e.uvs),t.setIndices(e.indices),t.setVertexStream(Ra,e.outlines,3,void 0,Me,!1),t.setVertexStream(La,e.shadows,3,void 0,Me,!1),t.update(),t}const cx=/^[\r\n]$/,sN=/^[ \t]$/,dx=/^[ \t\-]|[\u200b]$/,iN=/^[a-z0-9]$/i,ux=/^[\u1100-\u11ff]|[\u3000-\u9fff]|[\ua960-\ua97f]|[\uac00-\ud7ff]$/,nN=/^[]$/,rN=["","","","","","","","","","","","",""],aN={width:0,height:0,xadvance:0,xoffset:0,yoffset:0},fx=new k,oN=new M;class l0{constructor(e){this._element=e,this._system=e.system,this._entity=e.entity,this._text="",this._symbols=[],this._colorPalette=[],this._outlinePalette=[],this._shadowPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null,this._i18nKey=null,this._fontAsset=new WB(this._system.app),this._fontAsset.disableLocalization=!0,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new k(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMinY=0,this._fontMaxY=0,this._originalFontSize=32,this._maxFontSize=32,this._minFontSize=8,this._autoFitWidth=!1,this._autoFitHeight=!1,this._maxLines=-1,this._lineHeight=32,this._scaledLineHeight=32,this._wrapLines=!1,this._drawOrder=0,this._alignment=new M(.5,.5),this._autoWidth=!0,this._autoHeight=!0,this.width=0,this.height=0,this._node=new ze,this._model=new $n,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=!0,this._aabb=new Re,this._noResize=!1,this._currentMaterialType=null,this._maskedMaterialSrc=null,this._rtlReorder=!1,this._unicodeConverter=!1,this._rtl=!1,this._outlineColor=new k(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new k(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new M(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=!1,this._onScreenChange(this._element.screen),e.on("resize",this._onParentResize,this),e.on("set:screen",this._onScreenChange,this),e.on("screen:set:screenspace",this._onScreenSpaceChange,this),e.on("set:draworder",this._onDrawOrderChange,this),e.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on("set:locale",this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeStart=0,this._rangeEnd=0}destroy(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off("set:locale",this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this)}_onParentResize(e,t){this._noResize||this._font&&this._updateText()}_onScreenChange(e){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)}_onScreenSpaceChange(e){this._updateMaterial(e)}_onDrawOrderChange(e){if(this._drawOrder=e,this._model)for(let t=0,s=this._model.meshInstances.length;t<s;t++)this._model.meshInstances[t].drawOrder=e}_onPivotChange(e){this._font&&this._updateText()}_onLocaleSet(e){if(this._i18nKey){if(this.fontAsset){const t=this._system.app.assets.get(this.fontAsset);(!t||!t.resource||t.resource!==this._font)&&(this.font=null)}this._resetLocalizedText()}}_onLocalizationData(e,t){this._i18nKey&&t[this._i18nKey]&&this._resetLocalizedText()}_resetLocalizedText(){this._setText(this._system.app.i18n.getText(this._i18nKey))}_setText(e){if(this.unicodeConverter){const t=this._system.getUnicodeConverter();t?e=t(e):console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}this._text!==e&&(this._font&&this._updateText(e),this._text=e)}_updateText(e){let t;if(e===void 0&&(e=this._text),this._symbols=yl.getSymbols(e.normalize?e.normalize("NFC"):e),this._symbols.length===0&&(this._symbols=[" "]),this._enableMarkup){const h=QB.evaluate(this._symbols);this._symbols=h.symbols,t=h.tags||[]}if(this._rtlReorder){const h=this._system.app.systems.element.getRtlReorder();if(h){const u=h(this._symbols);this._rtl=u.rtl,this._symbols=u.mapping.map(function(f){return this._symbols[f]},this),t&&(t=u.mapping.map(function(f){return t[f]}))}else console.warn("Element created with rtlReorder option but no rtlReorder function registered")}else this._rtl=!1;const s=(h,u)=>`${h.toString(!0).toLowerCase()}:${u.toFixed(2)}`,i=(h,u)=>`${h.toString(!0).toLowerCase()}:${u.x.toFixed(2)}:${u.y.toFixed(2)}`;if(t){const h={},u={},f={};this._colorPalette=[Math.round(this._color.r*255),Math.round(this._color.g*255),Math.round(this._color.b*255)],this._outlinePalette=[Math.round(this._outlineColor.r*255),Math.round(this._outlineColor.g*255),Math.round(this._outlineColor.b*255),Math.round(this._outlineColor.a*255),Math.round(this._outlineThickness*255)],this._shadowPalette=[Math.round(this._shadowColor.r*255),Math.round(this._shadowColor.g*255),Math.round(this._shadowColor.b*255),Math.round(this._shadowColor.a*255),Math.round(this._shadowOffset.x*127),Math.round(this._shadowOffset.y*127)],this._symbolColors=[],this._symbolOutlineParams=[],this._symbolShadowParams=[],h[this._color.toString(!1).toLowerCase()]=0,u[s(this._outlineColor,this._outlineThickness)]=0,f[i(this._shadowColor,this._shadowOffset)]=0;for(let p=0,_=this._symbols.length;p<_;++p){const m=t[p];let g=0;if(m&&m.color&&m.color.value){const S=m.color.value;if(S.length===7&&S[0]==="#"){const w=S.substring(1).toLowerCase();h.hasOwnProperty(w)?g=h[w]:/^([0-9a-f]{2}){3}$/.test(w)&&(g=this._colorPalette.length/3,h[w]=g,this._colorPalette.push(parseInt(w.substring(0,2),16)),this._colorPalette.push(parseInt(w.substring(2,4),16)),this._colorPalette.push(parseInt(w.substring(4,6),16)))}}this._symbolColors.push(g);let v=0;if(m&&m.outline&&(m.outline.attributes.color||m.outline.attributes.thickness)){let S=m.outline.attributes.color?fx.fromString(m.outline.attributes.color):this._outlineColor,w=Number(m.outline.attributes.thickness);(Number.isNaN(S.r)||Number.isNaN(S.g)||Number.isNaN(S.b)||Number.isNaN(S.a))&&(S=this._outlineColor),Number.isNaN(w)&&(w=this._outlineThickness);const T=s(S,w);u.hasOwnProperty(T)?v=u[T]:(v=this._outlinePalette.length/5,u[T]=v,this._outlinePalette.push(Math.round(S.r*255),Math.round(S.g*255),Math.round(S.b*255),Math.round(S.a*255),Math.round(w*255)))}this._symbolOutlineParams.push(v);let x=0;if(m&&m.shadow&&(m.shadow.attributes.color||m.shadow.attributes.offset||m.shadow.attributes.offsetX||m.shadow.attributes.offsetY)){let S=m.shadow.attributes.color?fx.fromString(m.shadow.attributes.color):this._shadowColor;const w=Number(m.shadow.attributes.offset),T=Number(m.shadow.attributes.offsetX),b=Number(m.shadow.attributes.offsetY);(Number.isNaN(S.r)||Number.isNaN(S.g)||Number.isNaN(S.b)||Number.isNaN(S.a))&&(S=this._shadowColor);const C=oN.set(Number.isNaN(T)?Number.isNaN(w)?this._shadowOffset.x:w:T,Number.isNaN(b)?Number.isNaN(w)?this._shadowOffset.y:w:b),E=i(S,C);f.hasOwnProperty(E)?x=f[E]:(x=this._shadowPalette.length/6,f[E]=x,this._shadowPalette.push(Math.round(S.r*255),Math.round(S.g*255),Math.round(S.b*255),Math.round(S.a*255),Math.round(C.x*127),Math.round(C.y*127)))}this._symbolShadowParams.push(x)}}else this._colorPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null;this._updateMaterialEmissive(),this._updateMaterialOutline(),this._updateMaterialShadow();const n=this._calculateCharsPerTexture();let a=!1;const o=this._element,l=o._isScreenSpace(),c=o._isScreenCulled(),d=function(u){return o.isVisibleForCamera(u)};for(let h=0,u=this._meshInfo.length;h<u;h++){const f=n[h]||0,p=this._meshInfo[h];if(p.count!==f){if(a||(o.removeModelFromLayers(this._model),a=!0),p.count=f,p.positions.length=p.normals.length=f*3*4,p.indices.length=f*3*2,p.uvs.length=f*2*4,p.colors.length=f*4*4,p.outlines.length=f*4*3,p.shadows.length=f*4*3,p.meshInstance&&this._removeMeshInstance(p.meshInstance),f===0){p.meshInstance=null;continue}for(let g=0;g<f;g++)p.indices[g*3*2+0]=g*4,p.indices[g*3*2+1]=g*4+1,p.indices[g*3*2+2]=g*4+3,p.indices[g*3*2+3]=g*4+2,p.indices[g*3*2+4]=g*4+3,p.indices[g*3*2+5]=g*4+1,p.normals[g*4*3+0]=0,p.normals[g*4*3+1]=0,p.normals[g*4*3+2]=-1,p.normals[g*4*3+3]=0,p.normals[g*4*3+4]=0,p.normals[g*4*3+5]=-1,p.normals[g*4*3+6]=0,p.normals[g*4*3+7]=0,p.normals[g*4*3+8]=-1,p.normals[g*4*3+9]=0,p.normals[g*4*3+10]=0,p.normals[g*4*3+11]=-1;const _=tN(this._system.app.graphicsDevice,p),m=new Fe(_,this._material,this._node);if(m.name="Text Element: "+this._entity.name,m.castShadow=!1,m.receiveShadow=!1,m.cull=!l,m.screenSpace=l,m.drawOrder=this._drawOrder,c&&(m.cull=!0,m.isVisibleFunc=d),this._setTextureParams(m,this._font.textures[h]),m.setParameter("material_emissive",this._colorUniform),m.setParameter("material_opacity",this._color.a),m.setParameter("font_sdfIntensity",this._font.intensity),m.setParameter("font_pxrange",this._getPxRange(this._font)),m.setParameter("font_textureWidth",this._font.data.info.maps[h].width),m.setParameter("outline_color",this._outlineColorUniform),m.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),m.setParameter("shadow_color",this._shadowColorUniform),this._symbolShadowParams)this._shadowOffsetUniform[0]=0,this._shadowOffsetUniform[1]=0;else{const g=-this._font.data.info.maps[h].width/this._font.data.info.maps[h].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=g*this._shadowOffsetScale*this._shadowOffset.y}m.setParameter("shadow_offset",this._shadowOffsetUniform),p.meshInstance=m,this._model.meshInstances.push(m)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),a&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange()}_removeMeshInstance(e){e.destroy();const t=this._model.meshInstances.indexOf(e);t!==-1&&this._model.meshInstances.splice(t,1)}_setMaterial(e){if(this._material=e,this._model)for(let t=0,s=this._model.meshInstances.length;t<s;t++){const i=this._model.meshInstances[t];i.material=e}}_updateMaterial(e){const t=this._element,s=t._isScreenCulled(),i=function(o){return t.isVisibleForCamera(o)},n=this._font&&this._font.type===Sf;if(this._material=this._system.getTextElementMaterial(e,n,this._enableMarkup),this._model)for(let a=0,o=this._model.meshInstances.length;a<o;a++){const l=this._model.meshInstances[a];l.cull=!e,l.material=this._material,l.screenSpace=e,s?(l.cull=!0,l.isVisibleFunc=i):l.isVisibleFunc=null}}_updateMaterialEmissive(){this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b)}_updateMaterialOutline(){this._symbolOutlineParams?(this._outlineColorUniform[0]=0,this._outlineColorUniform[1]=0,this._outlineColorUniform[2]=0,this._outlineColorUniform[3]=1):(this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a)}_updateMaterialShadow(){this._symbolOutlineParams?(this._shadowColorUniform[0]=0,this._shadowColorUniform[1]=0,this._shadowColorUniform[2]=0,this._shadowColorUniform[3]=0):(this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a)}_isWordBoundary(e){return dx.test(e)}_isValidNextChar(e){return e!==null&&!nN.test(e)}_isNextCJKBoundary(e,t){return ux.test(e)&&(dx.test(t)||iN.test(t))}_isNextCJKWholeWord(e){return ux.test(e)}_updateMeshes(){const e=this._font.data,t=this,s=Math.min(this._minFontSize,this._maxFontSize),i=this._maxFontSize,n=this._shouldAutoFit();n&&(this._fontSize=this._maxFontSize);const a=32,o=this._symbols.length;let l=0,c=0,d=0,h=0,u=1,f=0,p=0,_=0,m=0,g=0,v=0;const x=Math.abs(this._element.anchor.x-this._element.anchor.z)>=1e-4;let S=this._element.calculatedWidth;(this.autoWidth&&!x||!this._wrapLines)&&(S=Number.POSITIVE_INFINITY);let w=0,T=0,b,C,E,R;function B(A,N,U){t._lineWidths.push(Math.abs(U));const G=_>N?N+1:_,X=_>N?_+1:N,j=A.slice(G,X);if(v){let J=j.length;for(;J--&&v>0;)cx.test(j[J])&&(j.splice(J,1),v--)}t._lineContents.push(j.join("")),l=0,c-=t._scaledLineHeight,u++,m=0,g=0,v=0,f=0,_=N}let L=!0;for(;L;){L=!1,n?this._scaledLineHeight=this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._scaledLineHeight=this._lineHeight,this.width=0,this.height=0,this._lineWidths=[],this._lineContents=[],l=0,c=0,d=0,h=0,u=1,f=0,p=0,_=0,m=0,g=0,v=0;const A=this._fontSize/a;w=this._fontMinY*A,T=this._fontMaxY*A;for(let ce=0;ce<this._meshInfo.length;ce++)this._meshInfo[ce].quad=0,this._meshInfo[ce].lines={};let N=255,U=255,G=255,X=255+255*256,j=255+255*256,J=0,ee=255+255*256,se=255+255*256,oe=127+127*256;for(let ce=0;ce<o;ce++){if(b=this._symbols[ce],R=ce+1>=o?null:this._symbols[ce+1],cx.test(b)){v++,(!this._wrapLines||this._maxLines<0||u<this._maxLines)&&(B(this._symbols,ce,h),p=ce+1,_=ce+1);continue}let Xt=0,es=0,ts=0,_o=1,H0,W0;if(C=e.chars[b],!C)if(rN.indexOf(b)!==-1)C=aN;else if(e.chars[" "])C=e.chars[" "];else for(const Ve in e.chars){C=e.chars[Ve];break}if(C){let Ve=0;if(g>0){const kd=this._font.data.kerning;if(kd){const Bd=kd[yl.getCodePoint(this._symbols[ce-1])||0];Bd&&(Ve=Bd[yl.getCodePoint(this._symbols[ce])||0]||0)}}H0=C.scale||1,W0=(C.width+C.height)/2,_o=A*W0/H0,ts=(C.xadvance+Ve)*A,Xt=(C.xoffset-Ve)*A,es=C.yoffset*A}else console.error(`Couldn't substitute missing character: '${b}'`);const j0=sN.test(b),cm=C&&C.map||0,JC=-this._font.data.info.maps[cm].width/this._font.data.info.maps[cm].height,te=this._meshInfo[cm],$0=l+this._spacing*ts;if($0>S&&g>0&&!j0&&(this._maxLines<0||u<this._maxLines))if(m===0)p=ce,B(this._symbols,ce,h);else{const Ve=Math.max(ce-p,0);if(this._meshInfo.length<=1)te.lines[u-1]-=Ve,te.quad-=Ve;else{const kd=p,Bd=ce;for(let fm=kd;fm<Bd;fm++){const QC=this._symbols[fm],q0=e.chars[QC],K0=this._meshInfo[q0&&q0.map||0];K0.lines[u-1]-=1,K0.quad-=1}}ce-=Ve+1,B(this._symbols,p,f);continue}E=te.quad,te.lines[u-1]=E;let Fd=l-Xt,dm=Fd+_o;const um=c-es,X0=um+_o;if(this._rtl){const Ve=_o-Xt-this._spacing*ts-Xt;Fd-=Ve,dm-=Ve}te.positions[E*4*3+0]=Fd,te.positions[E*4*3+1]=um,te.positions[E*4*3+2]=d,te.positions[E*4*3+3]=dm,te.positions[E*4*3+4]=um,te.positions[E*4*3+5]=d,te.positions[E*4*3+6]=dm,te.positions[E*4*3+7]=X0,te.positions[E*4*3+8]=d,te.positions[E*4*3+9]=Fd,te.positions[E*4*3+10]=X0,te.positions[E*4*3+11]=d,this.width=Math.max(this.width,$0);let Zn;if(this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(Zn=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),Zn=H.clamp(Zn,s,i),Zn!==this._element.fontSize)){this._fontSize=Zn,L=!0;break}if(this.height=Math.max(this.height,T-(c+w)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(Zn=H.clamp(this._fontSize-1,s,i),Zn!==this._element.fontSize)){this._fontSize=Zn,L=!0;break}l+=this._spacing*ts,j0||(h=l),(this._isWordBoundary(b)||this._isValidNextChar(R)&&(this._isNextCJKBoundary(b,R)||this._isNextCJKWholeWord(R)))&&(m++,f=h,p=ce+1),g++;const Jn=this._getUv(b);if(te.uvs[E*4*2+0]=Jn[0],te.uvs[E*4*2+1]=1-Jn[1],te.uvs[E*4*2+2]=Jn[2],te.uvs[E*4*2+3]=1-Jn[1],te.uvs[E*4*2+4]=Jn[2],te.uvs[E*4*2+5]=1-Jn[3],te.uvs[E*4*2+6]=Jn[0],te.uvs[E*4*2+7]=1-Jn[3],this._symbolColors){const Ve=this._symbolColors[ce]*3;N=this._colorPalette[Ve],U=this._colorPalette[Ve+1],G=this._colorPalette[Ve+2]}if(te.colors[E*4*4+0]=N,te.colors[E*4*4+1]=U,te.colors[E*4*4+2]=G,te.colors[E*4*4+3]=255,te.colors[E*4*4+4]=N,te.colors[E*4*4+5]=U,te.colors[E*4*4+6]=G,te.colors[E*4*4+7]=255,te.colors[E*4*4+8]=N,te.colors[E*4*4+9]=U,te.colors[E*4*4+10]=G,te.colors[E*4*4+11]=255,te.colors[E*4*4+12]=N,te.colors[E*4*4+13]=U,te.colors[E*4*4+14]=G,te.colors[E*4*4+15]=255,this._symbolOutlineParams){const Ve=this._symbolOutlineParams[ce]*5;X=this._outlinePalette[Ve]+this._outlinePalette[Ve+1]*256,j=this._outlinePalette[Ve+2]+this._outlinePalette[Ve+3]*256,J=this._outlinePalette[Ve+4]}if(te.outlines[E*4*3+0]=X,te.outlines[E*4*3+1]=j,te.outlines[E*4*3+2]=J,te.outlines[E*4*3+3]=X,te.outlines[E*4*3+4]=j,te.outlines[E*4*3+5]=J,te.outlines[E*4*3+6]=X,te.outlines[E*4*3+7]=j,te.outlines[E*4*3+8]=J,te.outlines[E*4*3+9]=X,te.outlines[E*4*3+10]=j,te.outlines[E*4*3+11]=J,this._symbolShadowParams){const Ve=this._symbolShadowParams[ce]*6;ee=this._shadowPalette[Ve]+this._shadowPalette[Ve+1]*256,se=this._shadowPalette[Ve+2]+this._shadowPalette[Ve+3]*256,oe=this._shadowPalette[Ve+4]+127+Math.round(JC*this._shadowPalette[Ve+5]+127)*256}te.shadows[E*4*3+0]=ee,te.shadows[E*4*3+1]=se,te.shadows[E*4*3+2]=oe,te.shadows[E*4*3+3]=ee,te.shadows[E*4*3+4]=se,te.shadows[E*4*3+5]=oe,te.shadows[E*4*3+6]=ee,te.shadows[E*4*3+7]=se,te.shadows[E*4*3+8]=oe,te.shadows[E*4*3+9]=ee,te.shadows[E*4*3+10]=se,te.shadows[E*4*3+11]=oe,te.quad++}L||_<o&&B(this._symbols,o,l)}this._noResize=!0,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=!1;const V=this._element.pivot.x,I=this._element.pivot.y,F=this._alignment.x,D=this._alignment.y;for(let A=0;A<this._meshInfo.length;A++){if(this._meshInfo[A].count===0)continue;let N=0;for(const j in this._meshInfo[A].lines){const J=this._meshInfo[A].lines[j],ee=this._lineWidths[parseInt(j,10)],se=-V*this._element.calculatedWidth+F*(this._element.calculatedWidth-ee)*(this._rtl?-1:1),oe=(1-I)*this._element.calculatedHeight-T-(1-D)*(this._element.calculatedHeight-this.height);for(let ce=N;ce<=J;ce++)this._meshInfo[A].positions[ce*4*3]+=se,this._meshInfo[A].positions[ce*4*3+3]+=se,this._meshInfo[A].positions[ce*4*3+6]+=se,this._meshInfo[A].positions[ce*4*3+9]+=se,this._meshInfo[A].positions[ce*4*3+1]+=oe,this._meshInfo[A].positions[ce*4*3+4]+=oe,this._meshInfo[A].positions[ce*4*3+7]+=oe,this._meshInfo[A].positions[ce*4*3+10]+=oe;if(this._rtl)for(let ce=N;ce<=J;ce++){const st=ce*4*3;for(let ts=0;ts<4;++ts)this._meshInfo[A].positions[st+ts*3]=this._element.calculatedWidth-this._meshInfo[A].positions[st+ts*3]+se*2;const Xt=this._meshInfo[A].positions[st+3],es=this._meshInfo[A].positions[st+6];this._meshInfo[A].positions[st+3]=this._meshInfo[A].positions[st+0],this._meshInfo[A].positions[st+6]=this._meshInfo[A].positions[st+9],this._meshInfo[A].positions[st+0]=Xt,this._meshInfo[A].positions[st+9]=es}N=J+1}const U=this._meshInfo[A].count*4,G=this._meshInfo[A].quad*4,X=new Jh(this._meshInfo[A].meshInstance.mesh.vertexBuffer);for(let j=0;j<U;j++)j>=G?(X.element[ht].set(0,0,0),X.element[zs].set(0,0),X.element[Zt].set(0,0,0,0),X.element[Ra].set(0,0,0,0),X.element[La].set(0,0,0,0)):(X.element[ht].set(this._meshInfo[A].positions[j*3+0],this._meshInfo[A].positions[j*3+1],this._meshInfo[A].positions[j*3+2]),X.element[zs].set(this._meshInfo[A].uvs[j*2+0],this._meshInfo[A].uvs[j*2+1]),X.element[Zt].set(this._meshInfo[A].colors[j*4+0],this._meshInfo[A].colors[j*4+1],this._meshInfo[A].colors[j*4+2],this._meshInfo[A].colors[j*4+3]),X.element[Ra].set(this._meshInfo[A].outlines[j*3+0],this._meshInfo[A].outlines[j*3+1],this._meshInfo[A].outlines[j*3+2]),X.element[La].set(this._meshInfo[A].shadows[j*3+0],this._meshInfo[A].shadows[j*3+1],this._meshInfo[A].shadows[j*3+2])),X.next();X.end(),this._meshInfo[A].meshInstance.mesh.aabb.compute(this._meshInfo[A].positions),this._meshInfo[A].meshInstance._aabbVer=-1}this._aabbDirty=!0}_onFontRender(){this.font=this._font}_onFontLoad(e){this.font!==e.resource&&(this.font=e.resource)}_onFontChange(e,t,s,i){if(t==="data"){this._font.data=s;const n=this._font.data.info.maps.length;for(let a=0;a<n;a++){if(!this._meshInfo[a])continue;const o=this._meshInfo[a].meshInstance;o&&(o.setParameter("font_sdfIntensity",this._font.intensity),o.setParameter("font_pxrange",this._getPxRange(this._font)),o.setParameter("font_textureWidth",this._font.data.info.maps[a].width))}}}_onFontRemove(e){}_setTextureParams(e,t){this._font&&(this._font.type===Sf?(e.deleteParameter("texture_emissiveMap"),e.deleteParameter("texture_opacityMap"),e.setParameter("texture_msdfMap",t)):this._font.type===jB&&(e.deleteParameter("texture_msdfMap"),e.setParameter("texture_emissiveMap",t),e.setParameter("texture_opacityMap",t)))}_getPxRange(e){const t=Object.keys(this._font.data.chars);for(let s=0;s<t.length;s++){const i=this._font.data.chars[t[s]];if(i.range)return(i.scale||1)*i.range}return 2}_getUv(e){const t=this._font.data;if(!t.chars[e]){const f=" ";return t.chars[f]?this._getUv(f):[0,0,0,0]}const s=t.chars[e].map,i=t.info.maps[s].width,n=t.info.maps[s].height,a=t.chars[e].x,o=t.chars[e].y,l=a,c=o,d=a+t.chars[e].width,h=o-t.chars[e].height,u=1-t.chars[e].height/n;return[l/i,u-c/n,d/i,u-h/n]}onEnable(){this._fontAsset.autoLoad=!0,this._model&&this._element.addModelToLayers(this._model)}onDisable(){this._fontAsset.autoLoad=!1,this._model&&this._element.removeModelFromLayers(this._model)}_setStencil(e){if(this._model){const t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].stencilFront=e,t[s].stencilBack=e}}_shouldAutoFitWidth(){return this._autoFitWidth&&!this._autoWidth}_shouldAutoFitHeight(){return this._autoFitHeight&&!this._autoHeight}_shouldAutoFit(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight}_calculateCharsPerTexture(e){const t={};e===void 0&&(e=this._symbols.length);for(let s=0,i=e;s<i;s++){const n=this._symbols[s];let a=this._font.data.chars[n];a||(a=this._font.data.chars[" "],a||(a=this._font.data.chars[Object.keys(this._font.data.chars)[0]]));const o=a.map;t[o]?t[o]++:t[o]=1}return t}_updateRenderRange(){const e=this._rangeStart===0?0:this._calculateCharsPerTexture(this._rangeStart),t=this._rangeEnd===0?0:this._calculateCharsPerTexture(this._rangeEnd);for(let s=0,i=this._meshInfo.length;s<i;s++){const n=e[s]||0,a=t[s]||0,o=this._meshInfo[s].meshInstance;if(o){const l=o.mesh;l&&(l.primitive[0].base=n*3*2,l.primitive[0].count=(a-n)*3*2)}}}set text(e){this._i18nKey=null;const t=e!=null&&e.toString()||"";this._setText(t)}get text(){return this._text}set key(e){const t=e!==null?e.toString():null;this._i18nKey!==t&&(this._i18nKey=t,t?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}get key(){return this._i18nKey}set color(e){const t=e.r,s=e.g,i=e.b;if(!(this._color.r===t&&this._color.g===s&&this._color.b===i)&&(this._color.r=t,this._color.g=s,this._color.b=i,!!this._model)){if(this._symbolColors)this._font&&this._updateText();else{this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b;for(let n=0,a=this._model.meshInstances.length;n<a;n++)this._model.meshInstances[n].setParameter("material_emissive",this._colorUniform)}this._element&&this._element.fire("set:color",this._color)}}get color(){return this._color}set opacity(e){if(this._color.a!==e&&(this._color.a=e,this._model))for(let t=0,s=this._model.meshInstances.length;t<s;t++)this._model.meshInstances[t].setParameter("material_opacity",e);this._element&&this._element.fire("set:opacity",e)}get opacity(){return this._color.a}set lineHeight(e){const t=this._lineHeight;this._lineHeight=e,this._scaledLineHeight=e,t!==e&&this._font&&this._updateText()}get lineHeight(){return this._lineHeight}set wrapLines(e){const t=this._wrapLines;this._wrapLines=e,t!==e&&this._font&&this._updateText()}get wrapLines(){return this._wrapLines}get lines(){return this._lineContents}set spacing(e){const t=this._spacing;this._spacing=e,t!==e&&this._font&&this._updateText()}get spacing(){return this._spacing}set fontSize(e){const t=this._fontSize;this._fontSize=e,this._originalFontSize=e,t!==e&&this._font&&this._updateText()}get fontSize(){return this._fontSize}set fontAsset(e){this._fontAsset.defaultAsset=e}get fontAsset(){return this._fontAsset.localizedAsset}set font(e){let t;if(this._font&&(t=this._font.type,this._font.off&&this._font.off("render",this._onFontRender,this)),this._font=e,this._fontMinY=0,this._fontMaxY=0,!e)return;const s=this._font.data;for(const n in s.chars){const a=s.chars[n];a.bounds&&(this._fontMinY=Math.min(this._fontMinY,a.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,a.bounds[3]))}if(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset&&this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null),e.type!==t){const n=this._element._isScreenSpace();this._updateMaterial(n)}for(let n=0,a=this._font.textures.length;n<a;n++)if(!this._meshInfo[n])this._meshInfo[n]=new eN;else{const o=this._meshInfo[n].meshInstance;o&&(o.setParameter("font_sdfIntensity",this._font.intensity),o.setParameter("font_pxrange",this._getPxRange(this._font)),o.setParameter("font_textureWidth",this._font.data.info.maps[n].width),this._setTextureParams(o,this._font.textures[n]))}let i=!1;for(let n=this._font.textures.length;n<this._meshInfo.length;n++)this._meshInfo[n].meshInstance&&(i||(this._element.removeModelFromLayers(this._model),i=!0),this._removeMeshInstance(this._meshInfo[n].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText()}get font(){return this._font}set alignment(e){e instanceof M?this._alignment.set(e.x,e.y):this._alignment.set(e[0],e[1]),this._font&&this._updateText()}get alignment(){return this._alignment}set autoWidth(e){const t=this._autoWidth;if(this._autoWidth=e,e&&Math.abs(this._element.anchor.x-this._element.anchor.z)<1e-4&&(this._element.width=this.width),t!==e){const s=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;s!==this._fontSize&&(this._fontSize=s,this._font&&this._updateText())}}get autoWidth(){return this._autoWidth}set autoHeight(e){const t=this._autoHeight;if(this._autoHeight=e,e&&Math.abs(this._element.anchor.y-this._element.anchor.w)<1e-4&&(this._element.height=this.height),t!==e){const s=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;s!==this._fontSize&&(this._fontSize=s,this._font&&this._updateText())}}get autoHeight(){return this._autoHeight}set rtlReorder(e){this._rtlReorder!==e&&(this._rtlReorder=e,this._font&&this._updateText())}get rtlReorder(){return this._rtlReorder}set unicodeConverter(e){this._unicodeConverter!==e&&(this._unicodeConverter=e,this._setText(this._text))}get unicodeConverter(){return this._unicodeConverter}get aabb(){if(this._aabbDirty){let e=!1;for(let t=0;t<this._meshInfo.length;t++)this._meshInfo[t].meshInstance&&(e?this._aabb.add(this._meshInfo[t].meshInstance.aabb):(this._aabb.copy(this._meshInfo[t].meshInstance.aabb),e=!0));this._aabbDirty=!1}return this._aabb}set outlineColor(e){const t=e instanceof k?e.r:e[0],s=e instanceof k?e.g:e[1],i=e instanceof k?e.b:e[2],n=e instanceof k?e.a:e[3];if(!(this._outlineColor.r===t&&this._outlineColor.g===s&&this._outlineColor.b===i&&this._outlineColor.a===n)&&(this._outlineColor.r=t,this._outlineColor.g=s,this._outlineColor.b=i,this._outlineColor.a=n,!!this._model)){if(this._symbolOutlineParams)this._font&&this._updateText();else{this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a;for(let a=0,o=this._model.meshInstances.length;a<o;a++)this._model.meshInstances[a].setParameter("outline_color",this._outlineColorUniform)}this._element&&this._element.fire("set:outline",this._color)}}get outlineColor(){return this._outlineColor}set outlineThickness(e){const t=this._outlineThickness;if(this._outlineThickness=e,t!==e&&this._font){if(!this._model)return;if(this._symbolOutlineParams)this._font&&this._updateText();else for(let s=0,i=this._model.meshInstances.length;s<i;s++)this._model.meshInstances[s].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}}get outlineThickness(){return this._outlineThickness}set shadowColor(e){const t=e instanceof k?e.r:e[0],s=e instanceof k?e.g:e[1],i=e instanceof k?e.b:e[2],n=e instanceof k?e.a:e[3];if(!(this._shadowColor.r===t&&this._shadowColor.g===s&&this._shadowColor.b===i&&this._shadowColor.a===n)&&(this._shadowColor.r=t,this._shadowColor.g=s,this._shadowColor.b=i,this._shadowColor.a=n,!!this._model))if(this._symbolShadowParams)this._font&&this._updateText();else{this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a;for(let a=0,o=this._model.meshInstances.length;a<o;a++)this._model.meshInstances[a].setParameter("shadow_color",this._shadowColorUniform)}}get shadowColor(){return this._shadowColor}set shadowOffset(e){const t=e instanceof M?e.x:e[0],s=e instanceof M?e.y:e[1];if(!(this._shadowOffset.x===t&&this._shadowOffset.y===s)&&(this._shadowOffset.set(t,s),this._font&&this._model))if(this._symbolShadowParams)this._updateText();else for(let i=0,n=this._model.meshInstances.length;i<n;i++){const a=-this._font.data.info.maps[i].width/this._font.data.info.maps[i].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=a*this._shadowOffsetScale*this._shadowOffset.y,this._model.meshInstances[i].setParameter("shadow_offset",this._shadowOffsetUniform)}}get shadowOffset(){return this._shadowOffset}set minFontSize(e){this._minFontSize!==e&&(this._minFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}get minFontSize(){return this._minFontSize}set maxFontSize(e){this._maxFontSize!==e&&(this._maxFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}get maxFontSize(){return this._maxFontSize}set autoFitWidth(e){this._autoFitWidth!==e&&(this._autoFitWidth=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitWidth(){return this._autoFitWidth}set autoFitHeight(e){this._autoFitHeight!==e&&(this._autoFitHeight=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitHeight(){return this._autoFitHeight}set maxLines(e){this._maxLines!==e&&(e===null&&this._maxLines===-1||(this._maxLines=e===null?-1:e,this.font&&this._wrapLines&&this._updateText()))}get maxLines(){return this._maxLines}set enableMarkup(e){if(e=!!e,this._enableMarkup===e)return;this._enableMarkup=e,this.font&&this._updateText();const t=this._element._isScreenSpace();this._updateMaterial(t)}get enableMarkup(){return this._enableMarkup}get symbols(){return this._symbols}get symbolColors(){return this._symbolColors===null?null:this._symbolColors.map(function(e){return this._colorPalette.slice(e*3,e*3+3)},this)}get symbolOutlineParams(){return this._symbolOutlineParams===null?null:this._symbolOutlineParams.map(function(e){return this._outlinePalette.slice(e*5,e*5+5)},this)}get symbolShadowParams(){return this._symbolShadowParams===null?null:this._symbolShadowParams.map(function(e){return this._shadowPalette.slice(e*6,e*6+6)},this)}get rtl(){return this._rtl}set rangeStart(e){e=Math.max(0,Math.min(e,this._symbols.length)),e!==this._rangeStart&&(this._rangeStart=e,this._updateRenderRange())}get rangeStart(){return this._rangeStart}set rangeEnd(e){e=Math.max(this._rangeStart,Math.min(e,this._symbols.length)),e!==this._rangeEnd&&(this._rangeEnd=e,this._updateRenderRange())}get rangeEnd(){return this._rangeEnd}}const n_=new y,px=new q,gn=new y,lN=new y,Ks=new q,pu=new q,mu=new q,Fo=new q;class ls extends ge{constructor(e,t){super(e,t),this._beingInitialized=!1,this._anchor=new P,this._localAnchor=new P,this._pivot=new M,this._width=this._calculatedWidth=32,this._height=this._calculatedHeight=32,this._margin=new P(0,0,-32,-32),this._modelTransform=new q,this._screenToWorld=new q,this._anchorTransform=new q,this._anchorDirty=!0,this._parentWorldTransform=new q,this._screenTransform=new q,this._screenCorners=[new y,new y,new y,new y],this._canvasCorners=[new M,new M,new M,new M],this._worldCorners=[new y,new y,new y,new y],this._cornersDirty=!0,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this.entity.on("insert",this._onInsert,this),this._patch(),this.screen=null,this._type=Bs,this._image=null,this._text=null,this._group=null,this._drawOrder=0,this._fitMode=Xu,this._useInput=!1,this._layers=[Kp],this._addedModels=[],this._batchGroupId=-1,this._offsetReadAt=0,this._maskOffset=.5,this._maskedBy=null}get _absLeft(){return this._localAnchor.x+this._margin.x}get _absRight(){return this._localAnchor.z-this._margin.z}get _absTop(){return this._localAnchor.w-this._margin.w}get _absBottom(){return this._localAnchor.y+this._margin.y}get _hasSplitAnchorsX(){return Math.abs(this._anchor.x-this._anchor.z)>.001}get _hasSplitAnchorsY(){return Math.abs(this._anchor.y-this._anchor.w)>.001}get aabb(){return this._image?this._image.aabb:this._text?this._text.aabb:null}set anchor(e){e instanceof P?this._anchor.copy(e):this._anchor.set(...e),!this.entity._parent&&!this.screen?this._calculateLocalAnchors():this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this._anchorDirty=!0,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor)}get anchor(){return this._anchor}set batchGroupId(e){if(this._batchGroupId!==e){if(this.entity.enabled&&this._batchGroupId>=0){var t;(t=this.system.app.batcher)==null||t.remove(_t.ELEMENT,this.batchGroupId,this.entity)}if(this.entity.enabled&&e>=0){var s;(s=this.system.app.batcher)==null||s.insert(_t.ELEMENT,e,this.entity)}e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=e}}get batchGroupId(){return this._batchGroupId}set bottom(e){this._margin.y=e;const t=this.entity.getLocalPosition(),s=this._absTop,i=this._localAnchor.y+e;this._setHeight(s-i),t.y=e+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(t)}get bottom(){return this._margin.y}set calculatedWidth(e){this._setCalculatedWidth(e,!0)}get calculatedWidth(){return this._calculatedWidth}set calculatedHeight(e){this._setCalculatedHeight(e,!0)}get calculatedHeight(){return this._calculatedHeight}get canvasCorners(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;const e=this.system.app.graphicsDevice,t=this.screenCorners,s=e.canvas.clientWidth/e.width,i=e.canvas.clientHeight/e.height;for(let n=0;n<4;n++)this._canvasCorners[n].set(t[n].x*s,(e.height-t[n].y)*i);return this._canvasCornersDirty=!1,this._canvasCorners}set drawOrder(e){let t=0;this.screen&&(t=this.screen.screen.priority),e>16777215&&(e=16777215),this._drawOrder=(t<<24)+e,this.fire("set:draworder",this._drawOrder)}get drawOrder(){return this._drawOrder}set height(e){this._height=e,this._hasSplitAnchorsY||this._setCalculatedHeight(e,!0),this.fire("set:height",this._height)}get height(){return this._height}set layers(e){if(this._addedModels.length)for(let t=0;t<this._layers.length;t++){const s=this.system.app.scene.layers.getLayerById(this._layers[t]);if(s)for(let i=0;i<this._addedModels.length;i++)s.removeMeshInstances(this._addedModels[i].meshInstances)}if(this._layers=e,!(!this.enabled||!this.entity.enabled||!this._addedModels.length))for(let t=0;t<this._layers.length;t++){const s=this.system.app.scene.layers.getLayerById(this._layers[t]);if(s)for(let i=0;i<this._addedModels.length;i++)s.addMeshInstances(this._addedModels[i].meshInstances)}}get layers(){return this._layers}set left(e){this._margin.x=e;const t=this.entity.getLocalPosition(),s=this._absRight,i=this._localAnchor.x+e;this._setWidth(s-i),t.x=e+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(t)}get left(){return this._margin.x}set margin(e){this._margin.copy(e),this._calculateSize(!0,!0),this.fire("set:margin",this._margin)}get margin(){return this._margin}get maskedBy(){return this._maskedBy}set pivot(e){const{pivot:t,margin:s}=this,i=t.x,n=t.y;e instanceof M?t.copy(e):t.set(...e);const a=s.x+s.z,o=t.x-i;s.x+=a*o,s.z-=a*o;const l=s.y+s.w,c=t.y-n;s.y+=l*c,s.w-=l*c,this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(!1,!1),this._flagChildrenAsDirty(),this.fire("set:pivot",t)}get pivot(){return this._pivot}set right(e){this._margin.z=e;const t=this.entity.getLocalPosition(),s=this._absLeft,i=this._localAnchor.z-e;this._setWidth(i-s),t.x=this._localAnchor.z-this._localAnchor.x-e-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(t)}get right(){return this._margin.z}get screenCorners(){if(!this._cornersDirty||!this.screen)return this._screenCorners;const e=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);const t=this.screen.screen.screenSpace;for(let s=0;s<4;s++)this._screenTransform.transformPoint(this._screenCorners[s],this._screenCorners[s]),t&&this._screenCorners[s].mulScalar(this.screen.screen.scale),e&&this._screenCorners[s].add(e);return this._cornersDirty=!1,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this._screenCorners}get textWidth(){return this._text?this._text.width:0}get textHeight(){return this._text?this._text.height:0}set top(e){this._margin.w=e;const t=this.entity.getLocalPosition(),s=this._absBottom,i=this._localAnchor.w-e;this._setHeight(i-s),t.y=this._localAnchor.w-this._localAnchor.y-e-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(t)}get top(){return this._margin.w}set type(e){e!==this._type&&(this._type=e,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),e===pt?this._image=new HB(this):e===o0&&(this._text=new l0(this)))}get type(){return this._type}set useInput(e){this._useInput!==e&&(this._useInput=e,this.system.app.elementInput?e?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this):this._useInput,this.fire("set:useInput",e))}get useInput(){return this._useInput}set fitMode(e){this._fitMode=e,this._calculateSize(!0,!0),this._image&&this._image.refreshMesh()}get fitMode(){return this._fitMode}set width(e){this._width=e,this._hasSplitAnchorsX||this._setCalculatedWidth(e,!0),this.fire("set:width",this._width)}get width(){return this._width}get worldCorners(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){const e=this.screenCorners;if(!this.screen.screen.screenSpace){Ks.copy(this.screen.screen._screenMatrix),Ks.data[13]=-Ks.data[13],Ks.mul2(this.screen.getWorldTransform(),Ks);for(let t=0;t<4;t++)Ks.transformPoint(e[t],this._worldCorners[t])}}else{const e=this.entity.getLocalPosition();Ks.setTranslate(-e.x,-e.y,-e.z),pu.setTRS(y.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),mu.setTranslate(e.x,e.y,e.z);const t=this.entity.parent?this.entity.parent:this.entity;Fo.copy(t.getWorldTransform()),Fo.mul(mu).mul(pu).mul(Ks),gn.set(e.x-this.pivot.x*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),Fo.transformPoint(gn,this._worldCorners[0]),gn.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),Fo.transformPoint(gn,this._worldCorners[1]),gn.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),Fo.transformPoint(gn,this._worldCorners[2]),gn.set(e.x-this.pivot.x*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),Fo.transformPoint(gn,this._worldCorners[3])}return this._worldCornersDirty=!1,this._worldCorners}_patch(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition}_unpatch(){this.entity._sync=$.prototype._sync,this.entity.setPosition=$.prototype.setPosition,this.entity.setLocalPosition=$.prototype.setLocalPosition}_setPosition(e,t,s){if(!this.element.screen){$.prototype.setPosition.call(this,e,t,s);return}e instanceof y?n_.copy(e):n_.set(e,t,s),this.getWorldTransform(),px.copy(this.element._screenToWorld).invert(),px.transformPoint(n_,this.localPosition),this._dirtyLocal||this._dirtifyLocal()}_setLocalPosition(e,t,s){e instanceof y?this.localPosition.copy(e):this.localPosition.set(e,t,s);const i=this.element,n=this.localPosition,a=i._pivot;i._margin.x=n.x-i._calculatedWidth*a.x,i._margin.z=i._localAnchor.z-i._localAnchor.x-i._calculatedWidth-i._margin.x,i._margin.y=n.y-i._calculatedHeight*a.y,i._margin.w=i._localAnchor.w-i._localAnchor.y-i._calculatedHeight-i._margin.y,this._dirtyLocal||this._dirtifyLocal()}_sync(){const e=this.element,t=e.screen;if(t){if(e._anchorDirty){let s=0,i=0,n=0,a=1;if(this._parent&&this._parent.element)s=this._parent.element.calculatedWidth,i=this._parent.element.calculatedHeight,n=this._parent.element.pivot.x,a=this._parent.element.pivot.y;else{const o=t.screen.resolution;s=o.x/t.screen.scale,i=o.y/t.screen.scale}e._anchorTransform.setTranslate(s*(e.anchor.x-n),-(i*(a-e.anchor.y)),0),e._anchorDirty=!1,e._calculateLocalAnchors()}e._sizeDirty&&e._calculateSize(!1,!1)}if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);const s=this.localPosition,i=e._pivot;e._margin.x=s.x-e._calculatedWidth*i.x,e._margin.z=e._localAnchor.z-e._localAnchor.x-e._calculatedWidth-e._margin.x,e._margin.y=s.y-e._calculatedHeight*i.y,e._margin.w=e._localAnchor.w-e._localAnchor.y-e._calculatedHeight-e._margin.y,this._dirtyLocal=!1}if(!t){this._dirtyWorld&&(e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0),$.prototype._sync.call(this);return}if(this._dirtyWorld){if(this._parent===null)this.worldTransform.copy(this.localTransform);else if(this._parent.element?e._screenToWorld.mul2(this._parent.element._modelTransform,e._anchorTransform):e._screenToWorld.copy(e._anchorTransform),e._modelTransform.mul2(e._screenToWorld,this.localTransform),t){e._screenToWorld.mul2(t.screen._screenMatrix,e._screenToWorld),t.screen.screenSpace||e._screenToWorld.mul2(t.worldTransform,e._screenToWorld),this.worldTransform.mul2(e._screenToWorld,this.localTransform);const s=e._parentWorldTransform;s.setIdentity();const i=this._parent;i&&i.element&&i!==t&&(Ks.setTRS(y.ZERO,i.getLocalRotation(),i.getLocalScale()),s.mul2(i.element._parentWorldTransform,Ks));const n=gn;n.set(0,0,this.localPosition.z);const a=lN;a.set(e._absLeft+e._pivot.x*e.calculatedWidth,e._absBottom+e._pivot.y*e.calculatedHeight,0),Ks.setTranslate(-a.x,-a.y,-a.z),pu.setTRS(n,this.getLocalRotation(),this.getLocalScale()),mu.setTranslate(a.x,a.y,a.z),e._screenTransform.mul2(e._parentWorldTransform,mu).mul(pu).mul(Ks),e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0}else this.worldTransform.copy(e._modelTransform);this._dirtyWorld=!1}}_onInsert(e){const t=this._parseUpToScreen();this.entity._dirtifyWorld(),this._updateScreen(t.screen),this._dirtifyMask()}_dirtifyMask(){let e=this.entity;for(;e;){const t=e.parent;if((t===null||t.screen)&&e.element){(!this.system._prerender||!this.system._prerender.length)&&(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));const s=this.system._prerender.indexOf(this.entity);s>=0&&this.system._prerender.splice(s,1),this.system._prerender.indexOf(e)<0&&this.system._prerender.push(e)}e=t}}_onPrerender(){for(let e=0;e<this.system._prerender.length;e++){const t=this.system._prerender[e];t.element&&t.element.syncMask(1)}this.system._prerender.length=0}_bindScreen(e){e._bindElement(this)}_unbindScreen(e){e._unbindElement(this)}_updateScreen(e){this.screen&&this.screen!==e&&this._unbindScreen(this.screen.screen);const t=this.screen;this.screen=e,this.screen&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,t),this._anchorDirty=!0;const s=this.entity.children;for(let i=0,n=s.length;i<n;i++)s[i].element&&s[i].element._updateScreen(e);this.screen&&this.screen.screen.syncDrawOrder()}syncMask(e){const t=this._parseUpToScreen();this._updateMask(t.mask,e)}_setMaskedBy(e){const t=this._image||this._text;if(e){const s=e.element._image._maskRef;t==null||t._setStencil(new oi({ref:s,func:tf})),this._maskedBy=e}else t==null||t._setStencil(null),this._maskedBy=null}_updateMask(e,t){if(e){if(this._setMaskedBy(e),this.mask){const a=e.element._image._maskRef,o=new oi({ref:a,func:tf,zpass:t1});this._image._setStencil(o),this._image._maskRef=t,t++,e=this.entity}const n=this.entity.children;for(let a=0,o=n.length;a<o;a++){var s;(s=n[a].element)==null||s._updateMask(e,t)}this.mask&&t--}else{if(this._setMaskedBy(null),this.mask){const a=new oi({ref:t,func:kn,zpass:e1});this._image._setStencil(a),this._image._maskRef=t,t++,e=this.entity}const n=this.entity.children;for(let a=0,o=n.length;a<o;a++){var i;(i=n[a].element)==null||i._updateMask(e,t)}this.mask&&t--}}_parseUpToScreen(){const e={screen:null,mask:null};let t=this.entity._parent;for(;t&&!t.screen;)t.element&&t.element.mask&&(e.mask||(e.mask=t)),t=t.parent;return t&&t.screen&&(e.screen=t),e}_onScreenResize(e){this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",e)}_onScreenSpaceChange(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)}_onScreenRemove(){this.screen&&(this.screen._destroying?this.screen=null:this._updateScreen(null))}_calculateLocalAnchors(){let e=1e3,t=1e3;const s=this.entity._parent;if(s&&s.element)e=s.element.calculatedWidth,t=s.element.calculatedHeight;else if(this.screen){const i=this.screen.screen.resolution,n=this.screen.screen.scale;e=i.x/n,t=i.y/n}this._localAnchor.set(this._anchor.x*e,this._anchor.y*t,this._anchor.z*e,this._anchor.w*t)}getOffsetPosition(e,t){const s=this.entity.getLocalPosition().clone();return s.x+=e,s.y+=t,this._screenToWorld.transformPoint(s,s),s}onLayersChanged(e,t){this.addModelToLayers(this._image?this._image._renderable.model:this._text._model),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||(this._image?e.addMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.addMeshInstances(this._text._model.meshInstances))}onLayerRemoved(e){this.layers.indexOf(e.id)<0||(this._image?e.removeMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.removeMeshInstances(this._text._model.meshInstances))}onEnable(){if(this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this._batchGroupId>=0){var e;(e=this.system.app.batcher)==null||e.insert(_t.ELEMENT,this.batchGroupId,this.entity)}this.fire("enableelement")}onDisable(){if(this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this._batchGroupId>=0){var e;(e=this.system.app.batcher)==null||e.remove(_t.ELEMENT,this.batchGroupId,this.entity)}this.fire("disableelement")}onRemove(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off()}_calculateSize(e,t){if(!this.entity._parent&&!this.screen)return;this._calculateLocalAnchors();const s=this._absRight-this._absLeft,i=this._absTop-this._absBottom;e?this._setWidth(s):this._setCalculatedWidth(s,!1),t?this._setHeight(i):this._setCalculatedHeight(i,!1);const n=this.entity.getLocalPosition();n.x=this._margin.x+this._calculatedWidth*this._pivot.x,n.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(n),this._sizeDirty=!1}_setWidth(e){this._width=e,this._setCalculatedWidth(e,!1),this.fire("set:width",this._width)}_setHeight(e){this._height=e,this._setCalculatedHeight(e,!1),this.fire("set:height",this._height)}_setCalculatedWidth(e,t){if(!(Math.abs(e-this._calculatedWidth)<=1e-4)){if(this._calculatedWidth=e,this.entity._dirtifyLocal(),t){const s=this.entity.getLocalPosition(),i=this._pivot;this._margin.x=s.x-this._calculatedWidth*i.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x}this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_setCalculatedHeight(e,t){if(!(Math.abs(e-this._calculatedHeight)<=1e-4)){if(this._calculatedHeight=e,this.entity._dirtifyLocal(),t){const s=this.entity.getLocalPosition(),i=this._pivot;this._margin.y=s.y-this._calculatedHeight*i.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y}this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_flagChildrenAsDirty(){const e=this.entity._children;for(let t=0,s=e.length;t<s;t++)e[t].element&&(e[t].element._anchorDirty=!0,e[t].element._sizeDirty=!0)}addModelToLayers(e){this._addedModels.push(e);for(let t=0;t<this.layers.length;t++){const s=this.system.app.scene.layers.getLayerById(this.layers[t]);s&&s.addMeshInstances(e.meshInstances)}}removeModelFromLayers(e){const t=this._addedModels.indexOf(e);t>=0&&this._addedModels.splice(t,1);for(let s=0;s<this.layers.length;s++){const i=this.system.app.scene.layers.getLayerById(this.layers[s]);i&&i.removeMeshInstances(e.meshInstances)}}getMaskOffset(){const e=this.system.app.frame;this._offsetReadAt!==e&&(this._maskOffset=.5,this._offsetReadAt=e);const t=this._maskOffset;return this._maskOffset-=.001,t}isVisibleForCamera(e){let t,s,i,n;if(this.maskedBy){const h=this.maskedBy.element.screenCorners;t=Math.min(Math.min(h[0].x,h[1].x),Math.min(h[2].x,h[3].x)),s=Math.max(Math.max(h[0].x,h[1].x),Math.max(h[2].x,h[3].x)),n=Math.min(Math.min(h[0].y,h[1].y),Math.min(h[2].y,h[3].y)),i=Math.max(Math.max(h[0].y,h[1].y),Math.max(h[2].y,h[3].y))}else{const h=this.system.app.graphicsDevice.width,u=this.system.app.graphicsDevice.height,f=e._rect.z*h,p=e._rect.w*u;t=e._rect.x*h,s=t+f,i=(1-e._rect.y)*u,n=i-p}const a=this.screenCorners,o=Math.min(Math.min(a[0].x,a[1].x),Math.min(a[2].x,a[3].x)),l=Math.max(Math.max(a[0].x,a[1].x),Math.max(a[2].x,a[3].x)),c=Math.min(Math.min(a[0].y,a[1].y),Math.min(a[2].y,a[3].y)),d=Math.max(Math.max(a[0].y,a[1].y),Math.max(a[2].y,a[3].y));return!(l<t||o>s||c>i||d<n)}_isScreenSpace(){return this.screen&&this.screen.screen?this.screen.screen.screenSpace:!1}_isScreenCulled(){return this.screen&&this.screen.screen?this.screen.screen.cull:!1}_dirtyBatch(){if(this.batchGroupId!==-1){var e;(e=this.system.app.batcher)==null||e.markGroupDirty(this.batchGroupId)}}}ls.EVENT_MOUSEDOWN="mousedown";ls.EVENT_MOUSEUP="mouseup";ls.EVENT_MOUSEENTER="mouseenter";ls.EVENT_MOUSELEAVE="mouseleave";ls.EVENT_MOUSEMOVE="mousemove";ls.EVENT_MOUSEWHEEL="mousewheel";ls.EVENT_CLICK="click";ls.EVENT_TOUCHSTART="touchstart";ls.EVENT_TOUCHEND="touchend";ls.EVENT_TOUCHMOVE="touchmove";ls.EVENT_TOUCHCANCEL="touchcancel";function Ce(r){Object.defineProperty(ls.prototype,r,{get:function(){return this._text?this._text[r]:this._image?this._image[r]:null},set:function(e){this._text?(this._text[r]!==e&&this._dirtyBatch(),this._text[r]=e):this._image&&(this._image[r]!==e&&this._dirtyBatch(),this._image[r]=e)}})}Ce("fontSize");Ce("minFontSize");Ce("maxFontSize");Ce("maxLines");Ce("autoFitWidth");Ce("autoFitHeight");Ce("color");Ce("font");Ce("fontAsset");Ce("spacing");Ce("lineHeight");Ce("wrapLines");Ce("lines");Ce("alignment");Ce("autoWidth");Ce("autoHeight");Ce("rtlReorder");Ce("unicodeConverter");Ce("text");Ce("key");Ce("texture");Ce("textureAsset");Ce("material");Ce("materialAsset");Ce("sprite");Ce("spriteAsset");Ce("spriteFrame");Ce("pixelsPerUnit");Ce("opacity");Ce("rect");Ce("mask");Ce("outlineColor");Ce("outlineThickness");Ce("shadowColor");Ce("shadowOffset");Ce("enableMarkup");Ce("rangeStart");Ce("rangeEnd");class hN{constructor(){this.enabled=!0}}const bT=["enabled"];class cN extends tt{constructor(e){super(e),this.id="element",this.ComponentType=ls,this.DataType=hN,this.schema=bT,this._unicodeConverter=null,this._rtlReorder=null,this._defaultTexture=new _e(e.graphicsDevice,{width:1,height:1,format:xe,name:"element-system"});const t=this._defaultTexture.lock(),s=new Uint8Array(4);s[0]=255,s[1]=255,s[2]=255,s[3]=255,t.set(s),this._defaultTexture.unlock(),this.defaultImageMaterial=null,this.defaultImage9SlicedMaterial=null,this.defaultImage9TiledMaterial=null,this.defaultImageMaskMaterial=null,this.defaultImage9SlicedMaskMaterial=null,this.defaultImage9TiledMaskMaterial=null,this.defaultScreenSpaceImageMaterial=null,this.defaultScreenSpaceImage9SlicedMaterial=null,this.defaultScreenSpaceImage9TiledMaterial=null,this.defaultScreenSpaceImageMask9SlicedMaterial=null,this.defaultScreenSpaceImageMask9TiledMaterial=null,this.defaultScreenSpaceImageMaskMaterial=null,this._defaultTextMaterials={},this.defaultImageMaterials=[],this.on("beforeremove",this.onRemoveComponent,this)}destroy(){super.destroy(),this._defaultTexture.destroy()}initializeComponentData(e,t,s){e._beingInitialized=!0,t.anchor!==void 0&&(t.anchor instanceof P?e.anchor.copy(t.anchor):e.anchor.set(t.anchor[0],t.anchor[1],t.anchor[2],t.anchor[3])),t.pivot!==void 0&&(t.pivot instanceof M?e.pivot.copy(t.pivot):e.pivot.set(t.pivot[0],t.pivot[1]));const i=Math.abs(e.anchor.x-e.anchor.z)>.001,n=Math.abs(e.anchor.y-e.anchor.w)>.001;let a=!1,o;t.margin!==void 0&&(t.margin instanceof P?e.margin.copy(t.margin):e._margin.set(t.margin[0],t.margin[1],t.margin[2],t.margin[3]),a=!0),t.left!==void 0&&(e._margin.x=t.left,a=!0),t.bottom!==void 0&&(e._margin.y=t.bottom,a=!0),t.right!==void 0&&(e._margin.z=t.right,a=!0),t.top!==void 0&&(e._margin.w=t.top,a=!0),a&&(e.margin=e._margin);let l=!1;t.width!==void 0&&!i?e.width=t.width:i&&(l=!0),t.height!==void 0&&!n?e.height=t.height:n&&(l=!0),l&&(e.anchor=e.anchor),t.enabled!==void 0&&(e.enabled=t.enabled),t.useInput!==void 0&&(e.useInput=t.useInput),t.fitMode!==void 0&&(e.fitMode=t.fitMode),e.batchGroupId=t.batchGroupId===void 0||t.batchGroupId===null?-1:t.batchGroupId,t.layers&&Array.isArray(t.layers)&&(e.layers=t.layers.slice(0)),t.type!==void 0&&(e.type=t.type),e.type===pt?(t.rect!==void 0&&(e.rect=t.rect),t.color!==void 0&&(o=t.color,o instanceof k||(o=new k(t.color[0],t.color[1],t.color[2])),e.color=o),t.opacity!==void 0&&(e.opacity=t.opacity),t.textureAsset!==void 0&&(e.textureAsset=t.textureAsset),t.texture&&(e.texture=t.texture),t.spriteAsset!==void 0&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),t.spriteFrame!==void 0&&(e.spriteFrame=t.spriteFrame),t.pixelsPerUnit!==void 0&&t.pixelsPerUnit!==null&&(e.pixelsPerUnit=t.pixelsPerUnit),t.materialAsset!==void 0&&(e.materialAsset=t.materialAsset),t.material&&(e.material=t.material),t.mask!==void 0&&(e.mask=t.mask)):e.type===o0&&(t.autoWidth!==void 0&&(e.autoWidth=t.autoWidth),t.autoHeight!==void 0&&(e.autoHeight=t.autoHeight),t.rtlReorder!==void 0&&(e.rtlReorder=t.rtlReorder),t.unicodeConverter!==void 0&&(e.unicodeConverter=t.unicodeConverter),t.text!==null&&t.text!==void 0?e.text=t.text:t.key!==null&&t.key!==void 0&&(e.key=t.key),t.color!==void 0&&(o=t.color,o instanceof k||(o=new k(o[0],o[1],o[2])),e.color=o),t.opacity!==void 0&&(e.opacity=t.opacity),t.spacing!==void 0&&(e.spacing=t.spacing),t.fontSize!==void 0&&(e.fontSize=t.fontSize,t.lineHeight||(e.lineHeight=t.fontSize)),t.lineHeight!==void 0&&(e.lineHeight=t.lineHeight),t.maxLines!==void 0&&(e.maxLines=t.maxLines),t.wrapLines!==void 0&&(e.wrapLines=t.wrapLines),t.minFontSize!==void 0&&(e.minFontSize=t.minFontSize),t.maxFontSize!==void 0&&(e.maxFontSize=t.maxFontSize),t.autoFitWidth&&(e.autoFitWidth=t.autoFitWidth),t.autoFitHeight&&(e.autoFitHeight=t.autoFitHeight),t.fontAsset!==void 0&&(e.fontAsset=t.fontAsset),t.font!==void 0&&(e.font=t.font),t.alignment!==void 0&&(e.alignment=t.alignment),t.outlineColor!==void 0&&(e.outlineColor=t.outlineColor),t.outlineThickness!==void 0&&(e.outlineThickness=t.outlineThickness),t.shadowColor!==void 0&&(e.shadowColor=t.shadowColor),t.shadowOffset!==void 0&&(e.shadowOffset=t.shadowOffset),t.enableMarkup!==void 0&&(e.enableMarkup=t.enableMarkup));const c=e._parseUpToScreen();c.screen&&e._updateScreen(c.screen),super.initializeComponentData(e,t,s),e._beingInitialized=!1,e.type===pt&&e._image._meshDirty&&e._image._updateMesh(e._image.mesh)}onRemoveComponent(e,t){t.onRemove()}cloneComponent(e,t){const s=e.element,i={enabled:s.enabled,width:s.width,height:s.height,anchor:s.anchor.clone(),pivot:s.pivot.clone(),margin:s.margin.clone(),alignment:s.alignment&&s.alignment.clone()||s.alignment,autoWidth:s.autoWidth,autoHeight:s.autoHeight,type:s.type,rect:s.rect&&s.rect.clone()||s.rect,rtlReorder:s.rtlReorder,unicodeConverter:s.unicodeConverter,materialAsset:s.materialAsset,material:s.material,color:s.color&&s.color.clone()||s.color,opacity:s.opacity,textureAsset:s.textureAsset,texture:s.texture,spriteAsset:s.spriteAsset,sprite:s.sprite,spriteFrame:s.spriteFrame,pixelsPerUnit:s.pixelsPerUnit,spacing:s.spacing,lineHeight:s.lineHeight,wrapLines:s.wrapLines,layers:s.layers,fontSize:s.fontSize,minFontSize:s.minFontSize,maxFontSize:s.maxFontSize,autoFitWidth:s.autoFitWidth,autoFitHeight:s.autoFitHeight,maxLines:s.maxLines,fontAsset:s.fontAsset,font:s.font,useInput:s.useInput,fitMode:s.fitMode,batchGroupId:s.batchGroupId,mask:s.mask,outlineColor:s.outlineColor&&s.outlineColor.clone()||s.outlineColor,outlineThickness:s.outlineThickness,shadowColor:s.shadowColor&&s.shadowColor.clone()||s.shadowColor,shadowOffset:s.shadowOffset&&s.shadowOffset.clone()||s.shadowOffset,enableMarkup:s.enableMarkup};return s.key!==void 0&&s.key!==null?i.key=s.key:i.text=s.text,this.addComponent(t,i)}getTextElementMaterial(e,t,s){const i=(e&&1)|(t&&2)|(s&&4);let n=this._defaultTextMaterials[i];if(n)return n;let a="TextMaterial";return n=new Gs,t?(n.msdfMap=this._defaultTexture,n.msdfTextAttribute=s,n.emissive.set(1,1,1)):(a="Bitmap"+a,n.emissive.set(.5,.5,.5),n.emissiveMap=this._defaultTexture,n.emissiveTint=!0,n.opacityMap=this._defaultTexture,n.opacityMapChannel="a"),e&&(a="ScreenSpace"+a,n.depthTest=!1),n.name="default"+a,n.useLighting=!1,n.useGammaTonemap=!1,n.useFog=!1,n.useSkybox=!1,n.diffuse.set(0,0,0),n.opacity=.5,n.blendType=qa,n.depthWrite=!1,n.emissiveVertexColor=!0,n.update(),this._defaultTextMaterials[i]=n,n}_createBaseImageMaterial(){const e=new Gs;return e.diffuse.set(0,0,0),e.emissive.set(.5,.5,.5),e.emissiveMap=this._defaultTexture,e.emissiveTint=!0,e.opacityMap=this._defaultTexture,e.opacityMapChannel="a",e.opacityTint=!0,e.opacity=0,e.useLighting=!1,e.useGammaTonemap=!1,e.useFog=!1,e.useSkybox=!1,e.blendType=qa,e.depthWrite=!1,e}getImageElementMaterial(e,t,s,i){return e?t?s?(this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=wt,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial):i?(this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=mt,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial):(this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial):s?(this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=wt,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial):i?(this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=mt,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial):(this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial):t?s?(this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=wt,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial):i?(this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=mt,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial):(this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial):s?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=wt,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):i?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=mt,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)}registerUnicodeConverter(e){this._unicodeConverter=e}registerRtlReorder(e){this._rtlReorder=e}getUnicodeConverter(){return this._unicodeConverter}getRtlReorder(){return this._rtlReorder}}ge._buildAccessors(ls.prototype,bT);const ko="free",Bo="limited",No="locked",dN=["angularDampingX","angularDampingY","angularDampingZ","angularEquilibriumX","angularEquilibriumY","angularEquilibriumZ","angularLimitsX","angularLimitsY","angularLimitsZ","angularMotionX","angularMotionY","angularMotionZ","angularSpringX","angularSpringY","angularSpringZ","angularStiffnessX","angularStiffnessY","angularStiffnessZ","breakForce","enableCollision","enabled","entityA","entityB","linearDampingX","linearDampingY","linearDampingZ","linearEquilibriumX","linearEquilibriumY","linearEquilibriumZ","linearLimitsX","linearLimitsY","linearLimitsZ","linearMotionX","linearMotionY","linearMotionZ","linearSpringX","linearSpringY","linearSpringZ","linearStiffnessX","linearStiffnessY","linearStiffnessZ"];class h0 extends ge{constructor(e,t){super(e,t),this._constraint=null,this._entityA=null,this._entityB=null,this._breakForce=34e37,this._enableCollision=!0,this._linearMotionX=No,this._linearLimitsX=new M(0,0),this._linearSpringX=!1,this._linearStiffnessX=0,this._linearDampingX=1,this._linearEquilibriumX=0,this._linearMotionY=No,this._linearLimitsY=new M(0,0),this._linearSpringY=!1,this._linearStiffnessY=0,this._linearDampingY=1,this._linearEquilibriumY=0,this._linearMotionZ=No,this._linearLimitsZ=new M(0,0),this._linearSpringZ=!1,this._linearStiffnessZ=0,this._linearDampingZ=1,this._linearEquilibriumZ=0,this._angularMotionX=No,this._angularLimitsX=new M(0,0),this._angularSpringX=!1,this._angularStiffnessX=0,this._angularDampingX=1,this._angularEquilibriumX=0,this._angularMotionY=No,this._angularLimitsY=new M(0,0),this._angularSpringY=!1,this._angularStiffnessY=0,this._angularDampingY=1,this._angularEquilibriumY=0,this._angularMotionZ=No,this._angularLimitsZ=new M(0,0),this._angularSpringZ=!1,this._angularEquilibriumZ=0,this._angularDampingZ=1,this._angularStiffnessZ=0,this.on("set_enabled",this._onSetEnabled,this)}set entityA(e){this._destroyConstraint(),this._entityA=e,this._createConstraint()}get entityA(){return this._entityA}set entityB(e){this._destroyConstraint(),this._entityB=e,this._createConstraint()}get entityB(){return this._entityB}set breakForce(e){this._constraint&&this._breakForce!==e&&(this._constraint.setBreakingImpulseThreshold(e),this._breakForce=e)}get breakForce(){return this._breakForce}set enableCollision(e){this._destroyConstraint(),this._enableCollision=e,this._createConstraint()}get enableCollision(){return this._enableCollision}set angularLimitsX(e){this._angularLimitsX.equals(e)||(this._angularLimitsX.copy(e),this._updateAngularLimits())}get angularLimitsX(){return this._angularLimitsX}set angularMotionX(e){this._angularMotionX!==e&&(this._angularMotionX=e,this._updateAngularLimits())}get angularMotionX(){return this._angularMotionX}set angularLimitsY(e){this._angularLimitsY.equals(e)||(this._angularLimitsY.copy(e),this._updateAngularLimits())}get angularLimitsY(){return this._angularLimitsY}set angularMotionY(e){this._angularMotionY!==e&&(this._angularMotionY=e,this._updateAngularLimits())}get angularMotionY(){return this._angularMotionY}set angularLimitsZ(e){this._angularLimitsZ.equals(e)||(this._angularLimitsZ.copy(e),this._updateAngularLimits())}get angularLimitsZ(){return this._angularLimitsZ}set angularMotionZ(e){this._angularMotionZ!==e&&(this._angularMotionZ=e,this._updateAngularLimits())}get angularMotionZ(){return this._angularMotionZ}set linearLimitsX(e){this._linearLimitsX.equals(e)||(this._linearLimitsX.copy(e),this._updateLinearLimits())}get linearLimitsX(){return this._linearLimitsX}set linearMotionX(e){this._linearMotionX!==e&&(this._linearMotionX=e,this._updateLinearLimits())}get linearMotionX(){return this._linearMotionX}set linearLimitsY(e){this._linearLimitsY.equals(e)||(this._linearLimitsY.copy(e),this._updateLinearLimits())}get linearLimitsY(){return this._linearLimitsY}set linearMotionY(e){this._linearMotionY!==e&&(this._linearMotionY=e,this._updateLinearLimits())}get linearMotionY(){return this._linearMotionY}set linearLimitsZ(e){this._linearLimitsZ.equals(e)||(this._linearLimitsZ.copy(e),this._updateLinearLimits())}get linearLimitsZ(){return this._linearLimitsZ}set linearMotionZ(e){this._linearMotionZ!==e&&(this._linearMotionZ=e,this._updateLinearLimits())}get linearMotionZ(){return this._linearMotionZ}_convertTransform(e,t){const s=e.getTranslation(),i=new re;i.setFromMat4(e);const n=new Ammo.btVector3(s.x,s.y,s.z),a=new Ammo.btQuaternion(i.x,i.y,i.z,i.w);t.setOrigin(n),t.setRotation(a),Ammo.destroy(n),Ammo.destroy(a)}_updateAngularLimits(){const e=this._constraint;if(e){let t,s,i,n,a,o;this._angularMotionX===Bo?(t=this._angularLimitsX.x*H.DEG_TO_RAD,n=this._angularLimitsX.y*H.DEG_TO_RAD):this._angularMotionX===ko?(t=1,n=0):t=n=0,this._angularMotionY===Bo?(s=this._angularLimitsY.x*H.DEG_TO_RAD,a=this._angularLimitsY.y*H.DEG_TO_RAD):this._angularMotionY===ko?(s=1,a=0):s=a=0,this._angularMotionZ===Bo?(i=this._angularLimitsZ.x*H.DEG_TO_RAD,o=this._angularLimitsZ.y*H.DEG_TO_RAD):this._angularMotionZ===ko?(i=1,o=0):i=o=0;const l=new Ammo.btVector3(t,s,i);e.setAngularLowerLimit(l),l.setValue(n,a,o),e.setAngularUpperLimit(l),Ammo.destroy(l)}}_updateLinearLimits(){const e=this._constraint;if(e){let t,s,i,n,a,o;this._linearMotionX===Bo?(t=this._linearLimitsX.x,n=this._linearLimitsX.y):this._linearMotionX===ko?(t=1,n=0):t=n=0,this._linearMotionY===Bo?(s=this._linearLimitsY.x,a=this._linearLimitsY.y):this._linearMotionY===ko?(s=1,a=0):s=a=0,this._linearMotionZ===Bo?(i=this._linearLimitsZ.x,o=this._linearLimitsZ.y):this._linearMotionZ===ko?(i=1,o=0):i=o=0;const l=new Ammo.btVector3(t,s,i);e.setLinearLowerLimit(l),l.setValue(n,a,o),e.setLinearUpperLimit(l),Ammo.destroy(l)}}_createConstraint(){if(this._entityA&&this._entityA.rigidbody){this._destroyConstraint();const e=new q,t=this._entityA.rigidbody.body;t.activate();const s=this.entity.getWorldTransform(),n=this._entityA.getWorldTransform().clone().invert();e.mul2(n,s);const a=new Ammo.btTransform;if(this._convertTransform(e,a),this._entityB&&this._entityB.rigidbody){const d=this._entityB.rigidbody.body;d.activate();const u=this._entityB.getWorldTransform().clone().invert();e.mul2(u,s);const f=new Ammo.btTransform;this._convertTransform(e,f),this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,d,a,f,!this._enableCollision),Ammo.destroy(f)}else this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,a,!this._enableCollision);Ammo.destroy(a);const o=["X","Y","Z","X","Y","Z"];for(let d=0;d<6;d++){const h=d<3?"_linear":"_angular";this._constraint.enableSpring(d,this[h+"Spring"+o[d]]),this._constraint.setDamping(d,this[h+"Damping"+o[d]]),this._constraint.setEquilibriumPoint(d,this[h+"Equilibrium"+o[d]]),this._constraint.setStiffness(d,this[h+"Stiffness"+o[d]])}this._constraint.setBreakingImpulseThreshold(this._breakForce),this._updateLinearLimits(),this._updateAngularLimits(),this.system.app.systems.rigidbody.dynamicsWorld.addConstraint(this._constraint,!this._enableCollision)}}_destroyConstraint(){this._constraint&&(this.system.app.systems.rigidbody.dynamicsWorld.removeConstraint(this._constraint),Ammo.destroy(this._constraint),this._constraint=null)}initFromData(e){for(const t of dN)e.hasOwnProperty(t)&&(e[t]instanceof M?this["_"+t].copy(e[t]):this["_"+t]=e[t]);this._createConstraint()}onEnable(){this._createConstraint()}onDisable(){this._destroyConstraint()}_onSetEnabled(e,t,s){}_onBeforeRemove(){this.fire("remove")}}const uN={Damping:"setDamping",Equilibrium:"setEquilibriumPoint",Spring:"enableSpring",Stiffness:"setStiffness"};["linear","angular"].forEach(r=>{["Damping","Equilibrium","Spring","Stiffness"].forEach(e=>{["X","Y","Z"].forEach(t=>{const s=r+e+t,i="_"+s;let n=r==="linear"?0:3;t==="Y"&&(n+=1),t==="Z"&&(n+=2),Object.defineProperty(h0.prototype,s,{get:function(){return this[i]},set:function(a){this[i]!==a&&(this[i]=a,this._constraint[uN[e]](n,a))}})})})});class fN{constructor(){this.enabled=!0}}const TT=["enabled"];class pN extends tt{constructor(e){super(e),this.id="joint",this.app=e,this.ComponentType=h0,this.DataType=fN,this.schema=TT}initializeComponentData(e,t,s){e.initFromData(t)}}ge._buildAccessors(h0.prototype,TT);class ET extends ge{constructor(e,t){super(e,t),this._minWidth=0,this._minHeight=0,this._maxWidth=null,this._maxHeight=null,this._fitWidthProportion=0,this._fitHeightProportion=0,this._excludeFromLayout=!1}set minWidth(e){e!==this._minWidth&&(this._minWidth=e,this.fire("resize"))}get minWidth(){return this._minWidth}set minHeight(e){e!==this._minHeight&&(this._minHeight=e,this.fire("resize"))}get minHeight(){return this._minHeight}set maxWidth(e){e!==this._maxWidth&&(this._maxWidth=e,this.fire("resize"))}get maxWidth(){return this._maxWidth}set maxHeight(e){e!==this._maxHeight&&(this._maxHeight=e,this.fire("resize"))}get maxHeight(){return this._maxHeight}set fitWidthProportion(e){e!==this._fitWidthProportion&&(this._fitWidthProportion=e,this.fire("resize"))}get fitWidthProportion(){return this._fitWidthProportion}set fitHeightProportion(e){e!==this._fitHeightProportion&&(this._fitHeightProportion=e,this.fire("resize"))}get fitHeightProportion(){return this._fitHeightProportion}set excludeFromLayout(e){e!==this._excludeFromLayout&&(this._excludeFromLayout=e,this.fire("resize"))}get excludeFromLayout(){return this._excludeFromLayout}}class mN{constructor(){this.enabled=!0}}const CT=["enabled"];class _N extends tt{constructor(e){super(e),this.id="layoutchild",this.ComponentType=ET,this.DataType=mN,this.schema=CT}initializeComponentData(e,t,s){t.enabled!==void 0&&(e.enabled=t.enabled),t.minWidth!==void 0&&(e.minWidth=t.minWidth),t.minHeight!==void 0&&(e.minHeight=t.minHeight),t.maxWidth!==void 0&&(e.maxWidth=t.maxWidth),t.maxHeight!==void 0&&(e.maxHeight=t.maxHeight),t.fitWidthProportion!==void 0&&(e.fitWidthProportion=t.fitWidthProportion),t.fitHeightProportion!==void 0&&(e.fitHeightProportion=t.fitHeightProportion),t.excludeFromLayout!==void 0&&(e.excludeFromLayout=t.excludeFromLayout),super.initializeComponentData(e,t,s)}cloneComponent(e,t){const s=e.layoutchild;return this.addComponent(t,{enabled:s.enabled,minWidth:s.minWidth,minHeight:s.minHeight,maxWidth:s.maxWidth,maxHeight:s.maxHeight,fitWidthProportion:s.fitWidthProportion,fitHeightProportion:s.fitHeightProportion,excludeFromLayout:s.excludeFromLayout})}}ge._buildAccessors(ET.prototype,CT);const Nc=0,gN=1,Rg=2,yN=3,xf={};xf[pe]={axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"};xf[Pe]={axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"};const c0={};c0[pe]=Pe;c0[Pe]=pe;const vN={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},Ts={NONE:"NONE",APPLY_STRETCHING:"APPLY_STRETCHING",APPLY_SHRINKING:"APPLY_SHRINKING"},Es=new M;function AT(r){let e;const t=xf[r],s=xf[c0[r]];function i(A,N){return-N[t.size]*A.pivot[t.axis]}function n(A,N){return-N[s.size]*A.pivot[s.axis]}function a(A,N){return N[t.size]*(1-A.pivot[t.axis])}function o(A,N){A=A.filter(l),e=N,Es.x=e.containerSize.x-e.padding.x-e.padding.z,Es.y=e.containerSize.y-e.padding.y-e.padding.w,c(A);const U=h(d(A)),G=f(U,u(U)),X=x(U,G);return S(U,G,X),w(U,G,X),T(U)}function l(A){const N=A.entity.layoutchild;return!N||!N.enabled||!N.excludeFromLayout}function c(A){for(let N=0;N<A.length;++N){const U=A[N],G=U.anchor;(G.x!==0||G.y!==0||G.z!==0||G.w!==0)&&(U.anchor=P.ZERO)}}function d(A){if(!e.wrap)return[A];const N=[[]],U=b(A);let G=0;const X=e[t.fitting]===Rg;for(let j=0;j<A.length;++j){N[N.length-1].length>0&&(G+=e.spacing[t.axis]);const J=U[j][t.size];G+=J,!X&&G>Es[t.axis]&&N[N.length-1].length!==0&&(G=J,N.push([])),N[N.length-1].push(A[j]),X&&G>Es[t.axis]&&j!==A.length-1&&(G=0,N.push([]))}return N}function h(A){const N=e.orientation===pe&&e.reverseX||e.orientation===Pe&&e.reverseY,U=e.orientation===pe&&e.reverseY||e.orientation===Pe&&e.reverseX;if(N)for(let G=0;G<A.length;++G)N&&A[G].reverse();return U&&A.reverse(),A}function u(A){const N=[];for(let U=0;U<A.length;++U){const G=A[U],X=b(G),j=_(X,t),J=p(e[t.fitting],j,Es[t.axis]);J===Ts.APPLY_STRETCHING?m(X,j,t):J===Ts.APPLY_SHRINKING&&g(X,j,t),N.push(X)}return N}function f(A,N){const U=[],G=[];for(let J=0;J<A.length;++J){const ee=A[J];ee.largestElement=null,ee.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(let se=0;se<ee.length;++se){const oe=N[J][se];oe[s.size]>ee.largestSize[s.size]&&(ee.largestElement=ee[se],ee.largestSize=oe)}U.push(ee.largestElement),G.push(ee.largestSize)}const X=_(G,s),j=p(e[s.fitting],X,Es[s.axis]);j===Ts.APPLY_STRETCHING?m(G,X,s):j===Ts.APPLY_SHRINKING&&g(G,X,s);for(let J=0;J<A.length;++J){const ee=A[J];for(let se=0;se<ee.length;++se){const oe=N[J][se],ce=oe[s.size],st=A.length===1?Es[s.axis]:ee.largestSize[s.size],Xt=p(e[s.fitting],ce,st);Xt===Ts.APPLY_STRETCHING?oe[s.size]=Math.min(st,oe[s.maxSize]):Xt===Ts.APPLY_SHRINKING&&(oe[s.size]=Math.max(st,oe[s.minSize]))}}return N}function p(A,N,U){switch(A){case Nc:return Ts.NONE;case gN:return N<U?Ts.APPLY_STRETCHING:Ts.NONE;case Rg:return N>=U?Ts.APPLY_SHRINKING:Ts.NONE;case yN:return N<U?Ts.APPLY_STRETCHING:Ts.APPLY_SHRINKING;default:throw new Error(`Unrecognized fitting mode: ${A}`)}}function _(A,N){const U=R(A,N.size),G=(A.length-1)*e.spacing[N.axis];return U+G}function m(A,N,U){const G=V(A,U.maxSize),X=B(A,U.fittingProportion),j=D(X,G);let J=Es[U.axis]-N;for(let ee=0;ee<A.length;++ee){const se=G[ee],oe=v(se,J,X,j),ce=A[se][U.size]+oe,st=A[se][U.maxSize],Xt=Math.min(ce,st);A[se][U.size]=Xt;const es=Math.max(ce-Xt,0),ts=oe-es;J-=ts}}function g(A,N,U){const G=V(A,U.minSize,!0),X=B(A,U.fittingProportion),j=L(X),J=D(j,G);let ee=N-Es[U.axis];for(let se=0;se<A.length;++se){const oe=G[se],ce=v(oe,ee,j,J),st=A[oe][U.size]-ce,Xt=A[oe][U.minSize],es=Math.max(st,Xt);A[oe][U.size]=es;const ts=Math.max(es-st,0),_o=ce-ts;ee-=_o}}function v(A,N,U,G){const X=U[A],j=G[A];return Math.abs(X)<1e-5&&Math.abs(j)<1e-5?N:N*X/j}function x(A,N){const U={};U[t.axis]=0,U[s.axis]=0,A[t.size]=Number.NEGATIVE_INFINITY;const G=[];for(let X=0;X<A.length;++X){const j=A[X];if(j.length===0){G.push([]);continue}const J=[],ee=N[X];for(let se=0;se<j.length;++se){const oe=j[se],ce=ee[se];U[s.axis]-=n(oe,ce),U[t.axis]-=i(oe,ce),J[se]={},J[se][t.axis]=U[t.axis],J[se][s.axis]=U[s.axis],U[s.axis]+=n(oe,ce),U[t.axis]+=a(oe,ce)+e.spacing[t.axis]}j[t.size]=U[t.axis]-e.spacing[t.axis],j[s.size]=j.largestSize[s.size],A[t.size]=Math.max(A[t.size],j[t.size]),U[t.axis]=0,U[s.axis]+=j[s.size]+e.spacing[s.axis],G.push(J)}return A[s.size]=U[s.axis]-e.spacing[s.axis],G}function S(A,N,U){const G=e.alignment[t.axis],X=e.alignment[s.axis],j=e.padding[t.axis],J=e.padding[s.axis];for(let ee=0;ee<A.length;++ee){const se=A[ee],oe=N[ee],ce=U[ee],st=(Es[t.axis]-se[t.size])*G+j,Xt=(Es[s.axis]-A[s.size])*X+J;for(let es=0;es<se.length;++es){const ts=(se[s.size]-oe[es][s.size])*e.alignment[s.axis];ce[es][t.axis]+=st,ce[es][s.axis]+=Xt+ts}}}function w(A,N,U){for(let G=0;G<A.length;++G){const X=A[G],j=N[G],J=U[G];for(let ee=0;ee<X.length;++ee){const se=X[ee];se[t.calculatedSize]=j[ee][t.size],se[s.calculatedSize]=j[ee][s.size],e.orientation===pe?se.entity.setLocalPosition(J[ee][t.axis],J[ee][s.axis],se.entity.getLocalPosition().z):se.entity.setLocalPosition(J[ee][s.axis],J[ee][t.axis],se.entity.getLocalPosition().z)}}}function T(A){const N=A.width,U=A.height,G=(Es.x-N)*e.alignment.x+e.padding.x,X=(Es.y-U)*e.alignment.y+e.padding.y;return{bounds:new P(G,X,N,U)}}function b(A){const N=[];for(let U=0;U<A.length;++U){const G=A[U],X=Math.max(C(G,"minWidth"),0),j=Math.max(C(G,"minHeight"),0),J=Math.max(C(G,"maxWidth"),X),ee=Math.max(C(G,"maxHeight"),j),se=E(C(G,"width"),X,J),oe=E(C(G,"height"),j,ee),ce=C(G,"fitWidthProportion"),st=C(G,"fitHeightProportion");N.push({minWidth:X,minHeight:j,maxWidth:J,maxHeight:ee,width:se,height:oe,fitWidthProportion:ce,fitHeightProportion:st})}return N}function C(A,N){const U=A.entity.layoutchild;return U&&U.enabled&&U[N]!==void 0&&U[N]!==null?U[N]:A[N]!==void 0?A[N]:vN[N]}function E(A,N,U){return Math.min(Math.max(A,N),U)}function R(A,N){return A.reduce(function(U,G){return U+G[N]},0)}function B(A,N){const U=R(A,N),G=[],X=A.length;if(U===0)for(let j=0;j<X;++j)G.push(1/X);else for(let j=0;j<X;++j)G.push(A[j][N]/U);return G}function L(A){if(A.length===1)return[1];const N=[],U=A.length;for(let G=0;G<U;++G)N.push((1-A[G])/(U-1));return N}function V(A,N,U){return A.forEach(I),A.slice().sort(function(G,X){return U?X[N]-G[N]:G[N]-X[N]}).map(F)}function I(A,N){A.index=N}function F(A){return A.index}function D(A,N){const U=[];U[N[A.length-1]]=A[N[A.length-1]];for(let G=A.length-2;G>=0;--G)U[N[G]]=U[N[G+1]]+A[N[G]];return U}return o}const d0={};d0[pe]=AT(pe);d0[Pe]=AT(Pe);class SN{calculateLayout(e,t){const s=d0[t.orientation];if(s)return s(e,t);throw new Error("Unrecognized orientation value: "+t.orientation)}}function mx(r){return r.element}function xN(r){return r.enabled&&r.element&&r.element.enabled}class PT extends ge{constructor(e,t){super(e,t),this._orientation=pe,this._reverseX=!1,this._reverseY=!0,this._alignment=new M(0,1),this._padding=new P,this._spacing=new M,this._widthFitting=Nc,this._heightFitting=Nc,this._wrap=!1,this._layoutCalculator=new SN,this._listenForReflowEvents(this.entity,"on"),this.entity.children.forEach(s=>{this._listenForReflowEvents(s,"on")}),this.entity.on("childinsert",this._onChildInsert,this),this.entity.on("childremove",this._onChildRemove,this),e.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this),e.app.systems.layoutchild.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this)}set orientation(e){e!==this._orientation&&(this._orientation=e,this._scheduleReflow())}get orientation(){return this._orientation}set reverseX(e){e!==this._reverseX&&(this._reverseX=e,this._scheduleReflow())}get reverseX(){return this._reverseX}set reverseY(e){e!==this._reverseY&&(this._reverseY=e,this._scheduleReflow())}get reverseY(){return this._reverseY}set alignment(e){e.equals(this._alignment)||(this._alignment.copy(e),this._scheduleReflow())}get alignment(){return this._alignment}set padding(e){e.equals(this._padding)||(this._padding.copy(e),this._scheduleReflow())}get padding(){return this._padding}set spacing(e){e.equals(this._spacing)||(this._spacing.copy(e),this._scheduleReflow())}get spacing(){return this._spacing}set widthFitting(e){e!==this._widthFitting&&(this._widthFitting=e,this._scheduleReflow())}get widthFitting(){return this._widthFitting}set heightFitting(e){e!==this._heightFitting&&(this._heightFitting=e,this._scheduleReflow())}get heightFitting(){return this._heightFitting}set wrap(e){e!==this._wrap&&(this._wrap=e,this._scheduleReflow())}get wrap(){return this._wrap}_isSelfOrChild(e){return e===this.entity||this.entity.children.indexOf(e)!==-1}_listenForReflowEvents(e,t){e.element&&(e.element[t]("enableelement",this._scheduleReflow,this),e.element[t]("disableelement",this._scheduleReflow,this),e.element[t]("resize",this._scheduleReflow,this),e.element[t]("set:pivot",this._scheduleReflow,this)),e.layoutchild&&(e.layoutchild[t]("set_enabled",this._scheduleReflow,this),e.layoutchild[t]("resize",this._scheduleReflow,this))}_onElementOrLayoutComponentAdd(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"on"),this._scheduleReflow())}_onElementOrLayoutComponentRemove(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"off"),this._scheduleReflow())}_onChildInsert(e){this._listenForReflowEvents(e,"on"),this._scheduleReflow()}_onChildRemove(e){this._listenForReflowEvents(e,"off"),this._scheduleReflow()}_scheduleReflow(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)}reflow(){const e=mx(this.entity),t=this.entity.children.filter(xN).map(mx);if(!e||t.length===0)return;const s=Math.max(e.calculatedWidth,0),i=Math.max(e.calculatedHeight,0),n={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new M(s,i)};this._isPerformingReflow=!0;const a=this._layoutCalculator.calculateLayout(t,n);this._isPerformingReflow=!1,this.fire("reflow",a)}onEnable(){this._scheduleReflow()}onRemove(){this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach(e=>{this._listenForReflowEvents(e,"off")}),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)}}class wN{constructor(){this.enabled=!0}}const MT=["enabled"],bN=100;class TN extends tt{constructor(e){super(e),this.id="layoutgroup",this.ComponentType=PT,this.DataType=wN,this.schema=MT,this._reflowQueue=[],this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(e,t,s){t.enabled!==void 0&&(e.enabled=t.enabled),t.orientation!==void 0&&(e.orientation=t.orientation),t.reverseX!==void 0&&(e.reverseX=t.reverseX),t.reverseY!==void 0&&(e.reverseY=t.reverseY),t.alignment!==void 0&&(e.alignment=Array.isArray(t.alignment)?new M(t.alignment):t.alignment),t.padding!==void 0&&(e.padding=Array.isArray(t.padding)?new P(t.padding):t.padding),t.spacing!==void 0&&(e.spacing=Array.isArray(t.spacing)?new M(t.spacing):t.spacing),t.widthFitting!==void 0&&(e.widthFitting=t.widthFitting),t.heightFitting!==void 0&&(e.heightFitting=t.heightFitting),t.wrap!==void 0&&(e.wrap=t.wrap),super.initializeComponentData(e,t,s)}cloneComponent(e,t){const s=e.layoutgroup;return this.addComponent(t,{enabled:s.enabled,orientation:s.orientation,reverseX:s.reverseX,reverseY:s.reverseY,alignment:s.alignment,padding:s.padding,spacing:s.spacing,widthFitting:s.widthFitting,heightFitting:s.heightFitting,wrap:s.wrap})}scheduleReflow(e){this._reflowQueue.indexOf(e)===-1&&this._reflowQueue.push(e)}_onPostUpdate(){this._processReflowQueue()}_processReflowQueue(){if(this._reflowQueue.length===0)return;let e=0;for(;this._reflowQueue.length>0;){const t=this._reflowQueue.slice();this._reflowQueue.length=0,t.sort(function(s,i){return s.entity.graphDepth-i.entity.graphDepth});for(let s=0;s<t.length;++s)t[s].reflow();if(++e>=bN){console.warn("Max reflow iterations limit reached, bailing.");break}}}_onRemoveComponent(e,t){t.onRemove()}destroy(){super.destroy(),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}ge._buildAccessors(PT.prototype,MT);class em extends ge{constructor(e,t){super(e,t),this._type="asset",this._asset=null,this._model=null,this._mapping={},this._castShadows=!0,this._receiveShadows=!0,this._materialAsset=null,this._material=void 0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._layers=[Ws],this._batchGroupId=-1,this._customAabb=null,this._area=null,this._materialEvents=null,this._clonedModel=!1,this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set meshInstances(e){this._model&&(this._model.meshInstances=e)}get meshInstances(){return this._model?this._model.meshInstances:null}set customAabb(e){if(this._customAabb=e,this._model){const t=this._model.meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].setCustomAabb(this._customAabb)}}get customAabb(){return this._customAabb}set type(e){if(this._type!==e)if(this._area=null,this._type=e,e==="asset")this._asset!==null?this._bindModelAsset(this._asset):this.model=null;else{const t=Nb(this.system.app.graphicsDevice,e);this._area=t.area;const s=t.mesh,i=new ze,n=new $n;n.graph=i,n.meshInstances=[new Fe(s,this._material,i)],this.model=n,this._asset=null}}get type(){return this._type}set asset(e){const t=this.system.app.assets;let s=e;if(e instanceof ne&&(s=e.id),this._asset!==s){if(this._asset){t.off("add:"+this._asset,this._onModelAssetAdded,this);const i=t.get(this._asset);i&&this._unbindModelAsset(i)}if(this._asset=s,this._asset){const i=t.get(this._asset);i?this._bindModelAsset(i):(this.model=null,t.on("add:"+this._asset,this._onModelAssetAdded,this))}else this.model=null}}get asset(){return this._asset}set model(e){if(this._model!==e&&!(e&&e._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this._model.getGraph().destroy(),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=e,this._model)){this._model._immutable=!0;const t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].castShadow=this._castShadows,t[s].receiveShadow=this._receiveShadows,t[s].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&this.entity.anim.rebind(),this.type==="asset"?this.mapping=this._mapping:this._unsetMaterialEvents()}}get model(){return this._model}set lightmapped(e){if(e!==this._lightmapped&&(this._lightmapped=e,this._model)){const t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].setLightmapped(e)}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows===e)return;const t=this._model;if(t){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(let a=0;a<s.length;a++){const o=this.system.app.scene.layers.getLayerById(this.layers[a]);o&&o.removeShadowCasters(t.meshInstances)}const n=t.meshInstances;for(let a=0;a<n.length;a++)n[a].castShadow=e;if(!this._castShadows&&e)for(let a=0;a<s.length;a++){const o=i.layers.getLayerById(s[a]);o&&o.addShadowCasters(t.meshInstances)}}this._castShadows=e}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e&&(this._receiveShadows=e,this._model)){const t=this._model.meshInstances;for(let s=0,i=t.length;s<i;s++)t[s].receiveShadow=e}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){const t=this.system.app.scene.layers;if(this.meshInstances)for(let s=0;s<this._layers.length;s++){const i=t.getLayerById(this._layers[s]);i&&i.removeMeshInstances(this.meshInstances)}this._layers.length=0;for(let s=0;s<e.length;s++)this._layers[s]=e[s];if(!(!this.enabled||!this.entity.enabled||!this.meshInstances))for(let s=0;s<this._layers.length;s++){const i=t.getLayerById(this._layers[s]);i&&i.addMeshInstances(this.meshInstances)}}get layers(){return this._layers}set batchGroupId(e){if(this._batchGroupId!==e){if(this.entity.enabled&&this._batchGroupId>=0){var t;(t=this.system.app.batcher)==null||t.remove(_t.MODEL,this.batchGroupId,this.entity)}if(this.entity.enabled&&e>=0){var s;(s=this.system.app.batcher)==null||s.insert(_t.MODEL,e,this.entity)}e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=e}}get batchGroupId(){return this._batchGroupId}set materialAsset(e){let t=e;e instanceof ne&&(t=e.id);const s=this.system.app.assets;if(t!==this._materialAsset){if(this._materialAsset){s.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);const i=s.get(this._materialAsset);i&&this._unbindMaterialAsset(i)}if(this._materialAsset=t,this._materialAsset){const i=s.get(this._materialAsset);i?this._bindMaterialAsset(i):(this._setMaterial(this.system.defaultMaterial),s.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this))}else this._setMaterial(this.system.defaultMaterial)}}get materialAsset(){return this._materialAsset}set material(e){this._material!==e&&(this.materialAsset=null,this._setMaterial(e))}get material(){return this._material}set mapping(e){if(this._type!=="asset"||(this._unsetMaterialEvents(),e||(e={}),this._mapping=e,!this._model))return;const t=this._model.meshInstances,s=this.asset?this.system.app.assets.get(this.asset):null,i=s?s.data.mapping:null;let n=null;for(let a=0,o=t.length;a<o;a++)if(e[a]!==void 0)e[a]?(n=this.system.app.assets.get(e[a]),this._loadAndSetMeshInstanceMaterial(n,t[a],a)):t[a].material=this.system.defaultMaterial;else if(i)if(i[a]&&(i[a].material||i[a].path)){if(i[a].material!==void 0)n=this.system.app.assets.get(i[a].material);else if(i[a].path!==void 0){const l=this._getMaterialAssetUrl(i[a].path);l&&(n=this.system.app.assets.getByUrl(l))}this._loadAndSetMeshInstanceMaterial(n,t[a],a)}else t[a].material=this.system.defaultMaterial}get mapping(){return this._mapping}addModelToLayers(){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this.meshInstances)}}removeModelFromLayers(){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this.meshInstances)}}onRemoveChild(){this._model&&this.removeModelFromLayers()}onInsertChild(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()}onRemove(){this.asset=null,this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addModelToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this.meshInstances)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this.meshInstances)}_setMaterialEvent(e,t,s,i){const n=t+":"+s;this.system.app.assets.on(n,i,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[e]||(this._materialEvents[e]={}),this._materialEvents[e][n]={id:s,handler:i}}_unsetMaterialEvents(){const e=this.system.app.assets,t=this._materialEvents;if(t){for(let s=0,i=t.length;s<i;s++){if(!t[s])continue;const n=t[s];for(const a in n)e.off(a,n[a].handler,this)}this._materialEvents=null}}_getAssetByIdOrPath(e){let t=null;if(!isNaN(parseInt(e,10)))t=this.system.app.assets.get(e);else if(this.asset){const i=this._getMaterialAssetUrl(e);i&&(t=this.system.app.assets.getByUrl(i))}return t}_getMaterialAssetUrl(e){if(!this.asset)return null;const t=this.system.app.assets.get(this.asset);return t?t.getAbsoluteUrl(e):null}_loadAndSetMeshInstanceMaterial(e,t,s){const i=this.system.app.assets;e&&(e.resource?(t.material=e.resource,this._setMaterialEvent(s,"remove",e.id,function(){t.material=this.system.defaultMaterial})):(this._setMaterialEvent(s,"load",e.id,function(n){t.material=n.resource,this._setMaterialEvent(s,"remove",e.id,function(){t.material=this.system.defaultMaterial})}),this.enabled&&this.entity.enabled&&i.load(e)))}onEnable(){const e=this.system.app,t=e.scene;t.on("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.on("add",this.onLayerAdded,this),t.layers.on("remove",this.onLayerRemoved,this));const s=this._type==="asset";let i;if(this._model?this.addModelToLayers():s&&this._asset&&(i=e.assets.get(this._asset),i&&i.resource!==this._model&&this._bindModelAsset(i)),this._materialAsset&&(i=e.assets.get(this._materialAsset),i&&i.resource!==this._material&&this._bindMaterialAsset(i)),s&&this._mapping)for(const a in this._mapping)this._mapping[a]&&(i=this._getAssetByIdOrPath(this._mapping[a]),i&&!i.resource&&e.assets.load(i));if(this._batchGroupId>=0){var n;(n=e.batcher)==null||n.insert(_t.MODEL,this.batchGroupId,this.entity)}}onDisable(){const e=this.system.app,t=e.scene;if(t.off("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.off("add",this.onLayerAdded,this),t.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0){var s;(s=e.batcher)==null||s.remove(_t.MODEL,this.batchGroupId,this.entity)}this._model&&this.removeModelFromLayers()}hide(){if(this._model){const e=this._model.meshInstances;for(let t=0,s=e.length;t<s;t++)e[t].visible=!1}}show(){if(this._model){const e=this._model.meshInstances;for(let t=0,s=e.length;t<s;t++)e[t].visible=!0}}_bindMaterialAsset(e){if(e.on("load",this._onMaterialAssetLoad,this),e.on("unload",this._onMaterialAssetUnload,this),e.on("remove",this._onMaterialAssetRemove,this),e.on("change",this._onMaterialAssetChange,this),e.resource)this._onMaterialAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindMaterialAsset(e){e.off("load",this._onMaterialAssetLoad,this),e.off("unload",this._onMaterialAssetUnload,this),e.off("remove",this._onMaterialAssetRemove,this),e.off("change",this._onMaterialAssetChange,this)}_onMaterialAssetAdd(e){this.system.app.assets.off("add:"+e.id,this._onMaterialAssetAdd,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)}_onMaterialAssetLoad(e){this._setMaterial(e.resource)}_onMaterialAssetUnload(e){this._setMaterial(this.system.defaultMaterial)}_onMaterialAssetRemove(e){this._onMaterialAssetUnload(e)}_onMaterialAssetChange(e){}_bindModelAsset(e){if(this._unbindModelAsset(e),e.on("load",this._onModelAssetLoad,this),e.on("unload",this._onModelAssetUnload,this),e.on("change",this._onModelAssetChange,this),e.on("remove",this._onModelAssetRemove,this),e.resource)this._onModelAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindModelAsset(e){e.off("load",this._onModelAssetLoad,this),e.off("unload",this._onModelAssetUnload,this),e.off("change",this._onModelAssetChange,this),e.off("remove",this._onModelAssetRemove,this)}_onModelAssetAdded(e){this.system.app.assets.off("add:"+e.id,this._onModelAssetAdded,this),e.id===this._asset&&this._bindModelAsset(e)}_onModelAssetLoad(e){this.model=e.resource.clone(),this._clonedModel=!0}_onModelAssetUnload(e){this.model=null}_onModelAssetChange(e,t,s,i){t==="data"&&(this.mapping=this._mapping)}_onModelAssetRemove(e){this.model=null}_setMaterial(e){if(this._material===e)return;this._material=e;const t=this._model;if(t&&this._type!=="asset"){const s=t.meshInstances;for(let i=0,n=s.length;i<n;i++)s[i].material=e}}}class EN{constructor(){this.enabled=!0}}const IT=["enabled"];class CN extends tt{constructor(e){super(e),this.id="model",this.ComponentType=em,this.DataType=EN,this.schema=IT,this.defaultMaterial=sh(e.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(e,t,s){s=["material","materialAsset","asset","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","mapping","layers","isStatic","batchGroupId"],(t.batchGroupId===null||t.batchGroupId===void 0)&&(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let i=0;i<s.length;i++)t.hasOwnProperty(s[i])&&(e[s[i]]=t[s[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new Re(new y(t.aabbCenter),new y(t.aabbHalfExtents))),super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s={type:e.model.type,asset:e.model.asset,castShadows:e.model.castShadows,receiveShadows:e.model.receiveShadows,castShadowsLightmap:e.model.castShadowsLightmap,lightmapped:e.model.lightmapped,lightmapSizeMultiplier:e.model.lightmapSizeMultiplier,isStatic:e.model.isStatic,enabled:e.model.enabled,layers:e.model.layers,batchGroupId:e.model.batchGroupId,mapping:Cr({},e.model.mapping)};let i=e.model.materialAsset;!(i instanceof ne)&&i!=null&&(i=this.app.assets.get(i));const n=e.model.material;(!n||n===this.defaultMaterial||!i||n===i.resource)&&(s.materialAsset=i);const a=this.addComponent(t,s);if(e.model.model&&e.model.type==="asset"&&!e.model.asset&&(a.model=e.model.model.clone(),a._clonedModel=!0),s.materialAsset||(a.material=n),e.model.model){const o=e.model.model.meshInstances,l=a.model.meshInstances;for(let c=0;c<o.length;c++)l[c].mask=o[c].mask,l[c].material=o[c].material,l[c].layer=o[c].layer,l[c].receiveShadow=o[c].receiveShadow}return e.model.customAabb&&(a.customAabb=e.model.customAabb.clone()),a}onRemove(e,t){t.onRemove()}}ge._buildAccessors(em.prototype,IT);const AN=["emitterExtents","emitterRadius","emitterExtentsInner","emitterRadiusInner","loop","initialVelocity","animSpeed","normalMap","particleNormal"],PN=["numParticles","lifetime","rate","rate2","startAngle","startAngle2","lighting","halfLambert","intensity","wrap","wrapBounds","depthWrite","noFog","sort","stretch","alignToMotion","preWarm","emitterShape","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animLoop","colorMap","localSpace","screenSpace","orientation"],MN=["scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","velocityGraph","velocityGraph2","localVelocityGraph","localVelocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2"],_u=["colorMapAsset","normalMapAsset","meshAsset","renderAsset"];let Uo;class RT extends ge{constructor(e,t){super(e,t),this._requestedDepth=!1,this._drawOrder=0,this.on("set_colorMapAsset",this.onSetColorMapAsset,this),this.on("set_normalMapAsset",this.onSetNormalMapAsset,this),this.on("set_meshAsset",this.onSetMeshAsset,this),this.on("set_mesh",this.onSetMesh,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_loop",this.onSetLoop,this),this.on("set_blendType",this.onSetBlendType,this),this.on("set_depthSoftening",this.onSetDepthSoftening,this),this.on("set_layers",this.onSetLayers,this),AN.forEach(s=>{this.on(`set_${s}`,this.onSetSimpleProperty,this)}),PN.forEach(s=>{this.on(`set_${s}`,this.onSetComplexProperty,this)}),MN.forEach(s=>{this.on(`set_${s}`,this.onSetGraphProperty,this)})}set drawOrder(e){this._drawOrder=e,this.emitter&&(this.emitter.drawOrder=e)}get drawOrder(){return this._drawOrder}addMeshInstanceToLayers(){if(this.emitter)for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addMeshInstances([this.emitter.meshInstance]),this.emitter._layer=t)}}removeMeshInstanceFromLayers(){if(this.emitter)for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this.emitter.meshInstance])}}onSetLayers(e,t,s){if(this.emitter){for(let i=0;i<t.length;i++){const n=this.system.app.scene.layers.getLayerById(t[i]);n&&n.removeMeshInstances([this.emitter.meshInstance])}if(!(!this.enabled||!this.entity.enabled))for(let i=0;i<s.length;i++){const n=this.system.app.scene.layers.getLayerById(s[i]);n&&n.addMeshInstances([this.emitter.meshInstance])}}}onLayersChanged(e,t){this.addMeshInstanceToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){!this.emitter||this.layers.indexOf(e.id)<0||e.addMeshInstances([this.emitter.meshInstance])}onLayerRemoved(e){!this.emitter||this.layers.indexOf(e.id)<0||e.removeMeshInstances([this.emitter.meshInstance])}_bindColorMapAsset(e){if(e.on("load",this._onColorMapAssetLoad,this),e.on("unload",this._onColorMapAssetUnload,this),e.on("remove",this._onColorMapAssetRemove,this),e.on("change",this._onColorMapAssetChange,this),e.resource)this._onColorMapAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindColorMapAsset(e){e.off("load",this._onColorMapAssetLoad,this),e.off("unload",this._onColorMapAssetUnload,this),e.off("remove",this._onColorMapAssetRemove,this),e.off("change",this._onColorMapAssetChange,this)}_onColorMapAssetLoad(e){this.colorMap=e.resource}_onColorMapAssetUnload(e){this.colorMap=null}_onColorMapAssetRemove(e){this._onColorMapAssetUnload(e)}_onColorMapAssetChange(e){}onSetColorMapAsset(e,t,s){const i=this.system.app.assets;if(t){const n=i.get(t);n&&this._unbindColorMapAsset(n)}if(s){s instanceof ne&&(this.data.colorMapAsset=s.id,s=s.id);const n=i.get(s);n?this._bindColorMapAsset(n):i.once("add:"+s,a=>{this._bindColorMapAsset(a)})}else this.colorMap=null}_bindNormalMapAsset(e){if(e.on("load",this._onNormalMapAssetLoad,this),e.on("unload",this._onNormalMapAssetUnload,this),e.on("remove",this._onNormalMapAssetRemove,this),e.on("change",this._onNormalMapAssetChange,this),e.resource)this._onNormalMapAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindNormalMapAsset(e){e.off("load",this._onNormalMapAssetLoad,this),e.off("unload",this._onNormalMapAssetUnload,this),e.off("remove",this._onNormalMapAssetRemove,this),e.off("change",this._onNormalMapAssetChange,this)}_onNormalMapAssetLoad(e){this.normalMap=e.resource}_onNormalMapAssetUnload(e){this.normalMap=null}_onNormalMapAssetRemove(e){this._onNormalMapAssetUnload(e)}_onNormalMapAssetChange(e){}onSetNormalMapAsset(e,t,s){const i=this.system.app.assets;if(t){const n=i.get(t);n&&this._unbindNormalMapAsset(n)}if(s){s instanceof ne&&(this.data.normalMapAsset=s.id,s=s.id);const n=i.get(s);n?this._bindNormalMapAsset(n):i.once("add:"+s,a=>{this._bindNormalMapAsset(a)})}else this.normalMap=null}_bindMeshAsset(e){if(e.on("load",this._onMeshAssetLoad,this),e.on("unload",this._onMeshAssetUnload,this),e.on("remove",this._onMeshAssetRemove,this),e.on("change",this._onMeshAssetChange,this),e.resource)this._onMeshAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindMeshAsset(e){e.off("load",this._onMeshAssetLoad,this),e.off("unload",this._onMeshAssetUnload,this),e.off("remove",this._onMeshAssetRemove,this),e.off("change",this._onMeshAssetChange,this)}_onMeshAssetLoad(e){this._onMeshChanged(e.resource)}_onMeshAssetUnload(e){this.mesh=null}_onMeshAssetRemove(e){this._onMeshAssetUnload(e)}_onMeshAssetChange(e){}onSetMeshAsset(e,t,s){const i=this.system.app.assets;if(t){const n=i.get(t);n&&this._unbindMeshAsset(n)}if(s){s instanceof ne&&(this.data.meshAsset=s.id,s=s.id);const n=i.get(s);n&&this._bindMeshAsset(n)}else this._onMeshChanged(null)}onSetMesh(e,t,s){!s||s instanceof ne||typeof s=="number"?this.meshAsset=s:this._onMeshChanged(s)}_onMeshChanged(e){e&&!(e instanceof Vs)&&(e.meshInstances[0]?e=e.meshInstances[0].mesh:e=null),this.data.mesh=e,this.emitter&&(this.emitter.mesh=e,this.emitter.resetMaterial(),this.rebuild())}onSetRenderAsset(e,t,s){const i=this.system.app.assets;if(t){const n=i.get(t);n&&this._unbindRenderAsset(n)}if(s){s instanceof ne&&(this.data.renderAsset=s.id,s=s.id);const n=i.get(s);n&&this._bindRenderAsset(n)}else this._onRenderChanged(null)}_bindRenderAsset(e){if(e.on("load",this._onRenderAssetLoad,this),e.on("unload",this._onRenderAssetUnload,this),e.on("remove",this._onRenderAssetRemove,this),e.resource)this._onRenderAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindRenderAsset(e){e.off("load",this._onRenderAssetLoad,this),e.off("unload",this._onRenderAssetUnload,this),e.off("remove",this._onRenderAssetRemove,this),e.resource&&e.resource.off("set:meshes",this._onRenderSetMeshes,this)}_onRenderAssetLoad(e){this._onRenderChanged(e.resource)}_onRenderAssetUnload(e){this._onRenderChanged(null)}_onRenderAssetRemove(e){this._onRenderAssetUnload(e)}_onRenderChanged(e){if(!e){this._onMeshChanged(null);return}e.off("set:meshes",this._onRenderSetMeshes,this),e.on("set:meshes",this._onRenderSetMeshes,this),e.meshes&&this._onRenderSetMeshes(e.meshes)}_onRenderSetMeshes(e){this._onMeshChanged(e&&e[0])}onSetLoop(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetTime())}onSetBlendType(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.material.blendType=s,this.emitter.resetMaterial(),this.rebuild())}_requestDepth(){this._requestedDepth||(Uo||(Uo=this.system.app.scene.layers.getLayerById(_s)),Uo&&(Uo.incrementCounter(),this._requestedDepth=!0))}_releaseDepth(){this._requestedDepth&&Uo&&(Uo.decrementCounter(),this._requestedDepth=!1)}onSetDepthSoftening(e,t,s){t!==s&&(s?(this.enabled&&this.entity.enabled&&this._requestDepth(),this.emitter&&(this.emitter[e]=s)):(this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[e]=s)),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))}onSetSimpleProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetMaterial())}onSetComplexProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetMaterial(),this.rebuild(),this.reset())}onSetGraphProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())}onEnable(){const e=this.data;for(let t=0,s=_u.length;t<s;t++){let i=e[_u[t]];if(i){if(!(i instanceof ne))if(parseInt(i,10)>=0)i=this.system.app.assets.get(i);else continue;i&&!i.resource&&this.system.app.assets.load(i)}}if(!this.system.app.graphicsDevice.disableParticleSystem){if(!this.emitter){let t=e.mesh;t instanceof Vs||(t=null),this.emitter=new zF(this.system.app.graphicsDevice,{numParticles:e.numParticles,emitterExtents:e.emitterExtents,emitterExtentsInner:e.emitterExtentsInner,emitterRadius:e.emitterRadius,emitterRadiusInner:e.emitterRadiusInner,emitterShape:e.emitterShape,initialVelocity:e.initialVelocity,wrap:e.wrap,localSpace:e.localSpace,screenSpace:e.screenSpace,wrapBounds:e.wrapBounds,lifetime:e.lifetime,rate:e.rate,rate2:e.rate2,orientation:e.orientation,particleNormal:e.particleNormal,animTilesX:e.animTilesX,animTilesY:e.animTilesY,animStartFrame:e.animStartFrame,animNumFrames:e.animNumFrames,animNumAnimations:e.animNumAnimations,animIndex:e.animIndex,randomizeAnimIndex:e.randomizeAnimIndex,animSpeed:e.animSpeed,animLoop:e.animLoop,startAngle:e.startAngle,startAngle2:e.startAngle2,scaleGraph:e.scaleGraph,scaleGraph2:e.scaleGraph2,colorGraph:e.colorGraph,colorGraph2:e.colorGraph2,alphaGraph:e.alphaGraph,alphaGraph2:e.alphaGraph2,localVelocityGraph:e.localVelocityGraph,localVelocityGraph2:e.localVelocityGraph2,velocityGraph:e.velocityGraph,velocityGraph2:e.velocityGraph2,rotationSpeedGraph:e.rotationSpeedGraph,rotationSpeedGraph2:e.rotationSpeedGraph2,radialSpeedGraph:e.radialSpeedGraph,radialSpeedGraph2:e.radialSpeedGraph2,colorMap:e.colorMap,normalMap:e.normalMap,loop:e.loop,preWarm:e.preWarm,sort:e.sort,stretch:e.stretch,alignToMotion:e.alignToMotion,lighting:e.lighting,halfLambert:e.halfLambert,intensity:e.intensity,depthSoftening:e.depthSoftening,scene:this.system.app.scene,mesh:t,depthWrite:e.depthWrite,noFog:e.noFog,node:this.entity,blendType:e.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,e.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1)}this.emitter.colorMap&&this.addMeshInstanceToLayers(),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&e.depthSoftening&&this._requestDepth()}}onDisable(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.emitter&&(this.removeMeshInstanceFromLayers(),this.data.depthSoftening&&this._releaseDepth(),this.emitter.camera=null)}onBeforeRemove(){this.enabled&&(this.enabled=!1),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(let e=0;e<_u.length;e++){const t=_u[e];this.data[t]&&(this[t]=null)}this.off()}reset(){this.emitter&&this.emitter.reset()}stop(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))}pause(){this.data.paused=!0}unpause(){this.data.paused=!1}play(){this.data.paused=!1,this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())}isPlaying(){return this.data.paused?!1:this.emitter&&this.emitter.loop?!0:Date.now()<=this.emitter.endTime}rebuild(){const e=this.enabled;this.enabled=!1,this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity),this.enabled=e}}class IN{constructor(){this.numParticles=1,this.rate=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new y,this.emitterExtentsInner=new y,this.emitterRadius=0,this.emitterRadiusInner=0,this.emitterShape=zi,this.initialVelocity=0,this.wrapBounds=new y,this.localSpace=!1,this.screenSpace=!1,this.colorMap=null,this.colorMapAsset=null,this.normalMap=null,this.normalMapAsset=null,this.loop=!0,this.preWarm=!1,this.sort=0,this.mode=Rb,this.scene=null,this.lighting=!1,this.halfLambert=!1,this.intensity=1,this.stretch=0,this.alignToMotion=!1,this.depthSoftening=0,this.meshAsset=null,this.mesh=null,this.depthWrite=!1,this.noFog=!1,this.orientation=Uu,this.particleNormal=new y(0,1,0),this.animTilesX=1,this.animTilesY=1,this.animStartFrame=0,this.animNumFrames=1,this.animNumAnimations=1,this.animIndex=0,this.randomizeAnimIndex=!1,this.animSpeed=1,this.animLoop=!0,this.scaleGraph=null,this.scaleGraph2=null,this.colorGraph=null,this.colorGraph2=null,this.alphaGraph=null,this.alphaGraph2=null,this.localVelocityGraph=null,this.localVelocityGraph2=null,this.velocityGraph=null,this.velocityGraph2=null,this.rotationSpeedGraph=null,this.rotationSpeedGraph2=null,this.radialSpeedGraph=null,this.radialSpeedGraph2=null,this.blendType=Bt,this.enabled=!0,this.paused=!1,this.autoPlay=!0,this.layers=[Ws]}}const LT=["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterExtentsInner","emitterRadius","emitterRadiusInner","initialVelocity","wrap","wrapBounds","localSpace","screenSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","renderAsset","orientation","particleNormal","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animSpeed","animLoop","layers"];class RN extends tt{constructor(e){super(e),this.id="particlesystem",this.ComponentType=RT,this.DataType=IN,this.schema=LT,this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){const i={};s=[];const n=this.propertyTypes;(t.mesh instanceof ne||typeof t.mesh=="number")&&(t.meshAsset=t.mesh,delete t.mesh);for(const a in t){if(t.hasOwnProperty(a)&&(s.push(a),i[a]=t[a]),n[a]==="vec3")Array.isArray(i[a])&&(i[a]=new y(i[a][0],i[a][1],i[a][2]));else if(n[a]==="curve"){if(!(i[a]instanceof dt)){const o=i[a].type;i[a]=new dt(i[a].keys),i[a].type=o}}else if(n[a]==="curveset"&&!(i[a]instanceof St)){const o=i[a].type;i[a]=new St(i[a].keys),i[a].type=o}i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0))}super.initializeComponentData(e,i,s)}cloneComponent(e,t){const s=e.particlesystem.data,i=this.schema,n={};for(let a=0,o=i.length;a<o;a++){const l=i[a];let c=s[l];c instanceof y||c instanceof dt||c instanceof St?(c=c.clone(),n[l]=c):l==="layers"?n.layers=s.layers.slice(0):c!=null&&(n[l]=c)}return this.addComponent(t,n)}onUpdate(e){const t=this.store;let s;const i=this.app.stats.particles,n=this.app.scene.layers;for(let a=0;a<n.layerList.length;a++)n.layerList[a].requiresLightCube=!1;for(const a in t)if(t.hasOwnProperty(a)){const o=t[a],l=o.entity,c=o.data;if(c.enabled&&l.enabled){const d=l.particlesystem.emitter;if(!(d!=null&&d.meshInstance.visible))continue;if(d.lighting){const h=c.layers;for(let u=0;u<h.length;u++){const f=n.getLayerById(h[u]);f&&(f.requiresLightCube=!0)}}if(!c.paused){if(d.simTime+=e,d.simTime>d.fixedTimeStep&&(s=Math.floor(d.simTime/d.fixedTimeStep),d.simTime-=s*d.fixedTimeStep),s){s=Math.min(s,d.maxSubSteps);for(let h=0;h<s;h++)d.addTime(d.fixedTimeStep,!1);i._updatesPerFrame+=s,i._frameTime+=d._addTimeTime,d._addTimeTime=0}d.finishFrame()}}}}onBeforeRemove(e,t){t.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}ge._buildAccessors(RT.prototype,LT);class LN extends Ky{constructor(e,t){super(),this.skin=e,this.skinInstance=t}}class ti{static createCachedSkinInstance(e,t,s){let i=ti.getCachedSkinInstance(e,t);return i||(i=new Td(e),i.resolve(t,s),ti.addCachedSkinInstance(e,t,i)),i}static getCachedSkinInstance(e,t){let s=null;const i=ti._skinInstanceCache.get(t);if(i){const n=i.find(a=>a.skin===e);n&&(n.incRefCount(),s=n.skinInstance)}return s}static addCachedSkinInstance(e,t,s){let i=ti._skinInstanceCache.get(t);i||(i=[],ti._skinInstanceCache.set(t,i));let n=i.find(a=>a.skin===e);n||(n=new LN(e,s),i.push(n)),n.incRefCount()}static removeCachedSkinInstance(e){if(e){const t=e.rootBone;if(t){const s=ti._skinInstanceCache.get(t);if(s){const i=s.findIndex(n=>n.skinInstance===e);if(i>=0){const n=s[i];n.decRefCount(),n.refCount===0&&(s.splice(i,1),s.length||ti._skinInstanceCache.delete(t),e&&(e.destroy(),n.skinInstance=null))}}}}}}ti._skinInstanceCache=new Map;class Uc{constructor(e,t,s,i,n){this.propertyName=e,this.parent=t,this._scope=n,this._registry=s,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=i.load,this._onAssetAdd=i.add,this._onAssetRemove=i.remove,this._onAssetUnload=i.unload}set id(e){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=e,this.asset=this._registry.get(this._id),this._bind()}get id(){return this._id}set url(e){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=e,this.asset=this._registry.getByUrl(this._url),this._bind()}get url(){return this._url}_bind(){this.id&&(this._onAssetLoad&&this._registry.on("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.on("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.on("load:url:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:url:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:url:"+this.url,this._onRemove,this))}_unbind(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.off("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.off("load:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))}_onLoad(e){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,e)}_onAdd(e){this.asset=e,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,e)}_onRemove(e){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,e),this.asset=null}_onUnload(e){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,e)}}class u0 extends ge{constructor(e,t){super(e,t),this._type="asset",this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._batchGroupId=-1,this._layers=[Ws],this._renderStyle=Qh,this._meshInstances=[],this._customAabb=null,this._area=null,this._assetReference=void 0,this._materialReferences=[],this._material=void 0,this._rootBone=void 0,this._rootBone=new Aa(this,"rootBone"),this._rootBone.on("set:entity",this._onSetRootBone,this),this._assetReference=new Uc("asset",this,e.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set renderStyle(e){this._renderStyle!==e&&(this._renderStyle=e,Fe._prepareRenderStyleForArray(this._meshInstances,e))}get renderStyle(){return this._renderStyle}set customAabb(e){this._customAabb=e;const t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set type(e){if(this._type!==e&&(this._area=null,this._type=e,this.destroyMeshInstances(),e!=="asset")){let t=this._material;(!t||t===this.system.defaultMaterial)&&(t=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);const s=Nb(this.system.app.graphicsDevice,e);this._area=s.area,this.meshInstances=[new Fe(s.mesh,t||this.system.defaultMaterial,this.entity)]}}get type(){return this._type}set meshInstances(e){if(this.destroyMeshInstances(),this._meshInstances=e,this._meshInstances){const t=this._meshInstances;for(let s=0;s<t.length;s++)t[s].node||(t[s].node=this.entity),t[s].castShadow=this._castShadows,t[s].receiveShadow=this._receiveShadows,t[s].renderStyle=this._renderStyle,t[s].setLightmapped(this._lightmapped),t[s].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}get meshInstances(){return this._meshInstances}set lightmapped(e){if(e!==this._lightmapped){this._lightmapped=e;const t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].setLightmapped(e)}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows!==e){const t=this._meshInstances;if(t){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(let n=0;n<s.length;n++){const a=i.layers.getLayerById(this.layers[n]);a&&a.removeShadowCasters(t)}for(let n=0;n<t.length;n++)t[n].castShadow=e;if(!this._castShadows&&e)for(let n=0;n<s.length;n++){const a=i.layers.getLayerById(s[n]);a&&a.addShadowCasters(t)}}this._castShadows=e}}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e){this._receiveShadows=e;const t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].receiveShadow=e}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){const t=this.system.app.scene.layers;let s;if(this._meshInstances)for(let i=0;i<this._layers.length;i++)s=t.getLayerById(this._layers[i]),s&&s.removeMeshInstances(this._meshInstances);this._layers.length=0;for(let i=0;i<e.length;i++)this._layers[i]=e[i];if(!(!this.enabled||!this.entity.enabled||!this._meshInstances))for(let i=0;i<this._layers.length;i++)s=t.getLayerById(this._layers[i]),s&&s.addMeshInstances(this._meshInstances)}get layers(){return this._layers}set batchGroupId(e){if(this._batchGroupId!==e){if(this.entity.enabled&&this._batchGroupId>=0){var t;(t=this.system.app.batcher)==null||t.remove(_t.RENDER,this.batchGroupId,this.entity)}if(this.entity.enabled&&e>=0){var s;(s=this.system.app.batcher)==null||s.insert(_t.RENDER,e,this.entity)}e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=e}}get batchGroupId(){return this._batchGroupId}set material(e){if(this._material!==e&&(this._material=e,this._meshInstances&&this._type!=="asset"))for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].material=e}get material(){return this._material}set materialAssets(e=[]){if(this._materialReferences.length>e.length){for(let t=e.length;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this._materialReferences.length=e.length}for(let t=0;t<e.length;t++)if(this._materialReferences[t]||this._materialReferences.push(new Uc(t,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),e[t]){const s=e[t]instanceof ne?e[t].id:e[t];this._materialReferences[t].id!==s&&(this._materialReferences[t].id=s),this._materialReferences[t].asset&&this._onMaterialAdded(t,this,this._materialReferences[t].asset)}else this._materialReferences[t].id=null,this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial)}get materialAssets(){return this._materialReferences.map(function(e){return e.id})}set asset(e){const t=e instanceof ne?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onRenderAssetAdded())}get asset(){return this._assetReference.id}assignAsset(e){const t=e instanceof ne?e.id:e;this._assetReference.id=t}_onSetRootBone(e){e&&this._onRootBoneChanged()}_onRootBoneChanged(){this._clearSkinInstances(),this.enabled&&this.entity.enabled&&this._cloneSkinInstances()}destroyMeshInstances(){const e=this._meshInstances;if(e){this.removeFromLayers(),this._clearSkinInstances();for(let t=0;t<e.length;t++)e[t].destroy();this._meshInstances.length=0}}addToLayers(){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this._meshInstances)}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this._meshInstances)}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(let e=0;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this._meshInstances)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this._meshInstances)}onEnable(){const e=this.system.app,t=e.scene;this._rootBone.onParentComponentEnable(),this._cloneSkinInstances(),t.on("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.on("add",this.onLayerAdded,this),t.layers.on("remove",this.onLayerRemoved,this));const s=this._type==="asset";this._meshInstances&&this._meshInstances.length?this.addToLayers():s&&this.asset&&this._onRenderAssetAdded();for(let n=0;n<this._materialReferences.length;n++)this._materialReferences[n].asset&&this.system.app.assets.load(this._materialReferences[n].asset);if(this._batchGroupId>=0){var i;(i=e.batcher)==null||i.insert(_t.RENDER,this.batchGroupId,this.entity)}}onDisable(){const e=this.system.app,t=e.scene;if(t.off("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.off("add",this.onLayerAdded,this),t.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0){var s;(s=e.batcher)==null||s.remove(_t.RENDER,this.batchGroupId,this.entity)}this.removeFromLayers()}hide(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!1}show(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!0}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){const e=this._assetReference.asset.resource;e.off("set:meshes",this._onSetMeshes,this),e.on("set:meshes",this._onSetMeshes,this),e.meshes&&this._onSetMeshes(e.meshes)}}_onSetMeshes(e){this._cloneMeshes(e)}_clearSkinInstances(){for(let e=0;e<this._meshInstances.length;e++){const t=this._meshInstances[e];ti.removeCachedSkinInstance(t.skinInstance),t.skinInstance=null}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone.entity instanceof ze)for(let e=0;e<this._meshInstances.length;e++){const t=this._meshInstances[e],s=t.mesh;s.skin&&!t.skinInstance&&(t.skinInstance=ti.createCachedSkinInstance(s.skin,this._rootBone.entity,this.entity))}}_cloneMeshes(e){if(e&&e.length){const t=[];for(let s=0;s<e.length;s++){const i=e[s],n=this._materialReferences[s]&&this._materialReferences[s].asset&&this._materialReferences[s].asset.resource,a=new Fe(i,n||this.system.defaultMaterial,this.entity);t.push(a),i.morph&&(a.morphInstance=new Ja(i.morph))}this.meshInstances=t,this._cloneSkinInstances()}}_onRenderAssetUnload(){this._type==="asset"&&this.destroyMeshInstances()}_onRenderAssetRemove(){this._assetReference.asset&&this._assetReference.asset.resource&&this._assetReference.asset.resource.off("set:meshes",this._onSetMeshes,this),this._onRenderAssetUnload()}_onMaterialAdded(e,t,s){s.resource?this._onMaterialLoad(e,t,s):this.enabled&&this.entity.enabled&&this.system.app.assets.load(s)}_updateMainMaterial(e,t){e===0&&(this.material=t)}_onMaterialLoad(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=s.resource),this._updateMainMaterial(e,s.resource)}_onMaterialRemove(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}_onMaterialUnload(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&t[e.rootBone]&&(this.rootBone=t[e.rootBone]),this._clearSkinInstances()}}class DN{constructor(){this.enabled=!0,this.rootBone=null}}const Lg=[{name:"rootBone",type:"entity"},"enabled"],ia=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId"];class ON extends tt{constructor(e){super(e),this.id="render",this.ComponentType=u0,this.DataType=DN,this.schema=Lg,this.defaultMaterial=sh(e.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(e,t,s){(t.batchGroupId===null||t.batchGroupId===void 0)&&(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let i=0;i<ia.length;i++)t.hasOwnProperty(ia[i])&&(e[ia[i]]=t[ia[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new Re(new y(t.aabbCenter),new y(t.aabbHalfExtents))),super.initializeComponentData(e,t,Lg)}cloneComponent(e,t){const s={};for(let o=0;o<ia.length;o++)s[ia[o]]=e.render[ia[o]];s.enabled=e.render.enabled,delete s.meshInstances;const i=this.addComponent(t,s),n=e.render.meshInstances,a=n.map(o=>o.mesh);i._onSetMeshes(a);for(let o=0;o<n.length;o++)i.meshInstances[o].material=n[o].material;return e.render.customAabb&&(i.customAabb=e.render.customAabb.clone()),i}onRemove(e,t){t.onRemove()}}ge._buildAccessors(u0.prototype,Lg);class r_{constructor(e,t){this._pool=[],this._count=0,this._constructor=e,this._resize(t)}_resize(e){if(e>this._pool.length)for(let t=this._pool.length;t<e;t++)this._pool[t]=new this._constructor}allocate(){return this._count>=this._pool.length&&this._resize(this._pool.length*2),this._pool[this._count++]}freeAll(){this._count=0}}let gi,ke,yn,gu;const FN=new re,kN=new re,yu=new y;class rn extends ge{constructor(e,t){super(e,t),this._angularDamping=0,this._angularFactor=new y(1,1,1),this._angularVelocity=new y,this._body=null,this._friction=.5,this._group=ox,this._linearDamping=0,this._linearFactor=new y(1,1,1),this._linearVelocity=new y,this._mask=Eg,this._mass=1,this._restitution=0,this._rollingFriction=0,this._simulationEnabled=!1,this._type=Ih}static onLibraryLoaded(){typeof Ammo<"u"&&(gi=new Ammo.btTransform,ke=new Ammo.btVector3,yn=new Ammo.btVector3,gu=new Ammo.btQuaternion)}set angularDamping(e){this._angularDamping!==e&&(this._angularDamping=e,this._body&&this._body.setDamping(this._linearDamping,e))}get angularDamping(){return this._angularDamping}set angularFactor(e){this._angularFactor.equals(e)||(this._angularFactor.copy(e),this._body&&this._type===mi&&(ke.setValue(e.x,e.y,e.z),this._body.setAngularFactor(ke)))}get angularFactor(){return this._angularFactor}set angularVelocity(e){this._body&&this._type===mi&&(this._body.activate(),ke.setValue(e.x,e.y,e.z),this._body.setAngularVelocity(ke),this._angularVelocity.copy(e))}get angularVelocity(){if(this._body&&this._type===mi){const e=this._body.getAngularVelocity();this._angularVelocity.set(e.x(),e.y(),e.z())}return this._angularVelocity}set body(e){this._body!==e&&(this._body=e,e&&this._simulationEnabled&&e.activate())}get body(){return this._body}set friction(e){this._friction!==e&&(this._friction=e,this._body&&this._body.setFriction(e))}get friction(){return this._friction}set group(e){this._group!==e&&(this._group=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get group(){return this._group}set linearDamping(e){this._linearDamping!==e&&(this._linearDamping=e,this._body&&this._body.setDamping(e,this._angularDamping))}get linearDamping(){return this._linearDamping}set linearFactor(e){this._linearFactor.equals(e)||(this._linearFactor.copy(e),this._body&&this._type===mi&&(ke.setValue(e.x,e.y,e.z),this._body.setLinearFactor(ke)))}get linearFactor(){return this._linearFactor}set linearVelocity(e){this._body&&this._type===mi&&(this._body.activate(),ke.setValue(e.x,e.y,e.z),this._body.setLinearVelocity(ke),this._linearVelocity.copy(e))}get linearVelocity(){if(this._body&&this._type===mi){const e=this._body.getLinearVelocity();this._linearVelocity.set(e.x(),e.y(),e.z())}return this._linearVelocity}set mask(e){this._mask!==e&&(this._mask=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get mask(){return this._mask}set mass(e){if(this._mass!==e&&(this._mass=e,this._body&&this._type===mi)){const t=this.enabled&&this.entity.enabled;t&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(e,ke),this._body.setMassProps(e,ke),this._body.updateInertiaTensor(),t&&this.enableSimulation()}}get mass(){return this._mass}set restitution(e){this._restitution!==e&&(this._restitution=e,this._body&&this._body.setRestitution(e))}get restitution(){return this._restitution}set rollingFriction(e){this._rollingFriction!==e&&(this._rollingFriction=e,this._body&&this._body.setRollingFriction(e))}get rollingFriction(){return this._rollingFriction}set type(e){if(this._type!==e){switch(this._type=e,this.disableSimulation(),e){case mi:this._group=PB,this._mask=lx;break;case Do:this._group=MB,this._mask=lx;break;case Ih:default:this._group=ox,this._mask=Eg;break}this.createBody()}}get type(){return this._type}createBody(){const e=this.entity;let t;if(e.collision&&(t=e.collision.shape,e.trigger&&(e.trigger.destroy(),delete e.trigger)),t){this._body&&(this.system.removeBody(this._body),this.system.destroyBody(this._body),this._body=null);const s=this._type===mi?this._mass:0;this._getEntityTransform(gi);const i=this.system.createBody(s,t,gi);if(i.setRestitution(this._restitution),i.setFriction(this._friction),i.setRollingFriction(this._rollingFriction),i.setDamping(this._linearDamping,this._angularDamping),this._type===mi){const n=this._linearFactor;ke.setValue(n.x,n.y,n.z),i.setLinearFactor(ke);const a=this._angularFactor;ke.setValue(a.x,a.y,a.z),i.setAngularFactor(ke)}else this._type===Do&&(i.setCollisionFlags(i.getCollisionFlags()|AB),i.setActivationState(ax));i.entity=e,this.body=i,this.enabled&&e.enabled&&this.enableSimulation()}}isActive(){return this._body?this._body.isActive():!1}activate(){this._body&&this._body.activate()}enableSimulation(){const e=this.entity;if(e.collision&&e.collision.enabled&&!this._simulationEnabled){const t=this._body;if(t){switch(this.system.addBody(t,this._group,this._mask),this._type){case mi:this.system._dynamic.push(this),t.forceActivationState(Tg),this.syncEntityToBody();break;case Do:this.system._kinematic.push(this),t.forceActivationState(ax);break;case Ih:t.forceActivationState(Tg),this.syncEntityToBody();break}e.collision.type==="compound"&&this.system._compounds.push(e.collision),t.activate(),this._simulationEnabled=!0}}}disableSimulation(){const e=this._body;if(e&&this._simulationEnabled){const t=this.system;let s=t._compounds.indexOf(this.entity.collision);s>-1&&t._compounds.splice(s,1),s=t._dynamic.indexOf(this),s>-1&&t._dynamic.splice(s,1),s=t._kinematic.indexOf(this),s>-1&&t._kinematic.splice(s,1),t.removeBody(e),e.forceActivationState(yT),this._simulationEnabled=!1}}applyForce(e,t,s,i,n,a){const o=this._body;o&&(o.activate(),e instanceof y?ke.setValue(e.x,e.y,e.z):ke.setValue(e,t,s),t instanceof y?yn.setValue(t.x,t.y,t.z):i!==void 0?yn.setValue(i,n,a):yn.setValue(0,0,0),o.applyForce(ke,yn))}applyTorque(e,t,s){const i=this._body;i&&(i.activate(),e instanceof y?ke.setValue(e.x,e.y,e.z):ke.setValue(e,t,s),i.applyTorque(ke))}applyImpulse(e,t,s,i,n,a){const o=this._body;o&&(o.activate(),e instanceof y?ke.setValue(e.x,e.y,e.z):ke.setValue(e,t,s),t instanceof y?yn.setValue(t.x,t.y,t.z):i!==void 0?yn.setValue(i,n,a):yn.setValue(0,0,0),o.applyImpulse(ke,yn))}applyTorqueImpulse(e,t,s){const i=this._body;i&&(i.activate(),e instanceof y?ke.setValue(e.x,e.y,e.z):ke.setValue(e,t,s),i.applyTorqueImpulse(ke))}isStatic(){return this._type===Ih}isStaticOrKinematic(){return this._type===Ih||this._type===Do}isKinematic(){return this._type===Do}_getEntityTransform(e){const t=this.entity,s=t.collision;if(s){const i=s.getShapePosition(),n=s.getShapeRotation();ke.setValue(i.x,i.y,i.z),gu.setValue(n.x,n.y,n.z,n.w)}else{const i=t.getPosition(),n=t.getRotation();ke.setValue(i.x,i.y,i.z),gu.setValue(n.x,n.y,n.z,n.w)}e.setOrigin(ke),e.setRotation(gu)}syncEntityToBody(){const e=this._body;if(e){if(this._getEntityTransform(gi),e.setWorldTransform(gi),this._type===Do){const t=e.getMotionState();t&&t.setWorldTransform(gi)}e.activate()}}_updateDynamic(){const e=this._body;if(e.isActive()){const t=e.getMotionState();if(t){const s=this.entity;t.getWorldTransform(gi);const i=gi.getOrigin(),n=gi.getRotation(),a=s.collision;if(a&&a._hasOffset){const o=a.data.linearOffset,l=a.data.angularOffset,c=kN.copy(l).invert(),d=FN.set(n.x(),n.y(),n.z(),n.w()).mul(c);d.transformVector(o,yu),s.setPosition(i.x()-yu.x,i.y()-yu.y,i.z()-yu.z),s.setRotation(d)}else s.setPosition(i.x(),i.y(),i.z()),s.setRotation(n.x(),n.y(),n.z(),n.w())}}}_updateKinematic(){const e=this._body.getMotionState();e&&(this._getEntityTransform(gi),e.setWorldTransform(gi))}teleport(e,t,s,i,n,a){e instanceof y?this.entity.setPosition(e):this.entity.setPosition(e,t,s),t instanceof re?this.entity.setRotation(t):t instanceof y?this.entity.setEulerAngles(t):i!==void 0&&this.entity.setEulerAngles(i,n,a),this.syncEntityToBody()}onEnable(){this._body||this.createBody(),this.enableSimulation()}onDisable(){this.disableSimulation()}}rn.EVENT_CONTACT="contact";rn.EVENT_COLLISIONSTART="collisionstart";rn.EVENT_COLLISIONEND="collisionend";rn.EVENT_TRIGGERENTER="triggerenter";rn.EVENT_TRIGGERLEAVE="triggerleave";class BN{constructor(){this.enabled=!0}}let na,ra;class _x{constructor(e,t,s,i){this.entity=e,this.point=t,this.normal=s,this.hitFraction=i}}class NN{constructor(e,t,s){arguments.length===0?(this.a=null,this.b=null,this.impulse=0,this.localPointA=new y,this.localPointB=new y,this.pointA=new y,this.pointB=new y,this.normal=new y):(this.a=e,this.b=t,this.impulse=s.impulse,this.localPointA=s.localPoint,this.localPointB=s.localPointOther,this.pointA=s.point,this.pointB=s.pointOther,this.normal=s.normal)}}class UN{constructor(e=new y,t=new y,s=new y,i=new y,n=new y,a=0){this.localPoint=e,this.localPointOther=t,this.point=s,this.pointOther=i,this.normal=n,this.impulse=a}}class zN{constructor(e,t){this.other=e,this.contacts=t}}const DT=["enabled"];class f0 extends tt{constructor(e){super(e),this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new y(0,-9.81,0),this._gravityFloat32=new Float32Array(3),this._dynamic=[],this._kinematic=[],this._triggers=[],this._compounds=[],this.id="rigidbody",this._stats=e.stats.frame,this.ComponentType=rn,this.DataType=BN,this.contactPointPool=null,this.contactResultPool=null,this.singleContactResultPool=null,this.schema=DT,this.collisions={},this.frameCollisions={},this.on("beforeremove",this.onBeforeRemove,this)}onLibraryLoaded(){if(typeof Ammo<"u"){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){const e=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(e)}na=new Ammo.btVector3,ra=new Ammo.btVector3,rn.onLibraryLoaded(),this.contactPointPool=new r_(UN,1),this.contactResultPool=new r_(zN,1),this.singleContactResultPool=new r_(NN,1),this.app.systems.on("update",this.onUpdate,this)}else this.app.systems.off("update",this.onUpdate,this)}initializeComponentData(e,t,s){const i=["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"];for(const n of i)if(t.hasOwnProperty(n)){const a=t[n];Array.isArray(a)?e[n]=new y(a[0],a[1],a[2]):e[n]=a}super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s=e.rigidbody,i={enabled:s.enabled,mass:s.mass,linearDamping:s.linearDamping,angularDamping:s.angularDamping,linearFactor:[s.linearFactor.x,s.linearFactor.y,s.linearFactor.z],angularFactor:[s.angularFactor.x,s.angularFactor.y,s.angularFactor.z],friction:s.friction,rollingFriction:s.rollingFriction,restitution:s.restitution,type:s.type,group:s.group,mask:s.mask};return this.addComponent(t,i)}onBeforeRemove(e,t){t.enabled&&(t.enabled=!1),t.body&&(this.destroyBody(t.body),t.body=null)}addBody(e,t,s){t!==void 0&&s!==void 0?this.dynamicsWorld.addRigidBody(e,t,s):this.dynamicsWorld.addRigidBody(e)}removeBody(e){this.dynamicsWorld.removeRigidBody(e)}createBody(e,t,s){const i=new Ammo.btVector3(0,0,0);e!==0&&t.calculateLocalInertia(e,i);const n=new Ammo.btDefaultMotionState(s),a=new Ammo.btRigidBodyConstructionInfo(e,n,t,i),o=new Ammo.btRigidBody(a);return Ammo.destroy(a),Ammo.destroy(i),o}destroyBody(e){const t=e.getMotionState();t&&Ammo.destroy(t),Ammo.destroy(e)}raycastFirst(e,t,s={}){if(s.filterTags||s.filterCallback)return s.sort=!0,this.raycastAll(e,t,s)[0]||null;let i=null;na.setValue(e.x,e.y,e.z),ra.setValue(t.x,t.y,t.z);const n=new Ammo.ClosestRayResultCallback(na,ra);if(typeof s.filterCollisionGroup=="number"&&n.set_m_collisionFilterGroup(s.filterCollisionGroup),typeof s.filterCollisionMask=="number"&&n.set_m_collisionFilterMask(s.filterCollisionMask),this.dynamicsWorld.rayTest(na,ra,n),n.hasHit()){const a=n.get_m_collisionObject(),o=Ammo.castObject(a,Ammo.btRigidBody);if(o){const l=n.get_m_hitPointWorld(),c=n.get_m_hitNormalWorld();i=new _x(o.entity,new y(l.x(),l.y(),l.z()),new y(c.x(),c.y(),c.z()),n.get_m_closestHitFraction())}}return Ammo.destroy(n),i}raycastAll(e,t,s={}){const i=[];na.setValue(e.x,e.y,e.z),ra.setValue(t.x,t.y,t.z);const n=new Ammo.AllHitsRayResultCallback(na,ra);if(typeof s.filterCollisionGroup=="number"&&n.set_m_collisionFilterGroup(s.filterCollisionGroup),typeof s.filterCollisionMask=="number"&&n.set_m_collisionFilterMask(s.filterCollisionMask),this.dynamicsWorld.rayTest(na,ra,n),n.hasHit()){const a=n.get_m_collisionObjects(),o=n.get_m_hitPointWorld(),l=n.get_m_hitNormalWorld(),c=n.get_m_hitFractions(),d=a.size();for(let h=0;h<d;h++){const u=Ammo.castObject(a.at(h),Ammo.btRigidBody);if(u&&u.entity){if(s.filterTags&&!u.entity.tags.has(...s.filterTags)||s.filterCallback&&!s.filterCallback(u.entity))continue;const f=o.at(h),p=l.at(h),_=new _x(u.entity,new y(f.x(),f.y(),f.z()),new y(p.x(),p.y(),p.z()),c.at(h));i.push(_)}}s.sort&&i.sort((h,u)=>h.hitFraction-u.hitFraction)}return Ammo.destroy(n),i}_storeCollision(e,t){let s=!1;const i=e.getGuid();return this.collisions[i]=this.collisions[i]||{others:[],entity:e},this.collisions[i].others.indexOf(t)<0&&(this.collisions[i].others.push(t),s=!0),this.frameCollisions[i]=this.frameCollisions[i]||{others:[],entity:e},this.frameCollisions[i].others.push(t),s}_createContactPointFromAmmo(e){const t=e.get_m_localPointA(),s=e.get_m_localPointB(),i=e.getPositionWorldOnA(),n=e.getPositionWorldOnB(),a=e.get_m_normalWorldOnB(),o=this.contactPointPool.allocate();return o.localPoint.set(t.x(),t.y(),t.z()),o.localPointOther.set(s.x(),s.y(),s.z()),o.point.set(i.x(),i.y(),i.z()),o.pointOther.set(n.x(),n.y(),n.z()),o.normal.set(a.x(),a.y(),a.z()),o.impulse=e.getAppliedImpulse(),o}_createReverseContactPointFromAmmo(e){const t=e.get_m_localPointA(),s=e.get_m_localPointB(),i=e.getPositionWorldOnA(),n=e.getPositionWorldOnB(),a=e.get_m_normalWorldOnB(),o=this.contactPointPool.allocate();return o.localPointOther.set(t.x(),t.y(),t.z()),o.localPoint.set(s.x(),s.y(),s.z()),o.pointOther.set(i.x(),i.y(),i.z()),o.point.set(n.x(),n.y(),n.z()),o.normal.set(a.x(),a.y(),a.z()),o.impulse=e.getAppliedImpulse(),o}_createSingleContactResult(e,t,s){const i=this.singleContactResultPool.allocate();return i.a=e,i.b=t,i.localPointA=s.localPoint,i.localPointB=s.localPointOther,i.pointA=s.point,i.pointB=s.pointOther,i.normal=s.normal,i.impulse=s.impulse,i}_createContactResult(e,t){const s=this.contactResultPool.allocate();return s.other=e,s.contacts=t,s}_cleanOldCollisions(){for(const e in this.collisions)if(this.collisions.hasOwnProperty(e)){const t=this.frameCollisions[e],s=this.collisions[e],i=s.entity,n=i.collision,a=i.rigidbody,o=s.others;let c=o.length;for(;c--;){const d=o[c];(!t||t.others.indexOf(d)<0)&&(o.splice(c,1),i.trigger?(n&&n.fire("triggerleave",d),d.rigidbody&&d.rigidbody.fire("triggerleave",i)):d.trigger||(a&&a.fire("collisionend",d),n&&n.fire("collisionend",d)))}o.length===0&&delete this.collisions[e]}}_hasContactEvent(e){const t=e.collision;if(t&&(t.hasEvent("collisionstart")||t.hasEvent("collisionend")||t.hasEvent("contact")))return!0;const s=e.rigidbody;return s&&(s.hasEvent("collisionstart")||s.hasEvent("collisionend")||s.hasEvent("contact"))}_checkForCollisions(e,t){const i=Ammo.wrapPointer(e,Ammo.btDynamicsWorld).getDispatcher(),n=i.getNumManifolds();this.frameCollisions={};for(let a=0;a<n;a++){const o=i.getManifoldByIndexInternal(a),l=o.getBody0(),c=o.getBody1(),d=Ammo.castObject(l,Ammo.btRigidBody),h=Ammo.castObject(c,Ammo.btRigidBody),u=d.entity,f=h.entity;if(!u||!f)continue;const p=d.getCollisionFlags(),_=h.getCollisionFlags(),m=o.getNumContacts(),g=[],v=[];let x;if(m>0)if(p&Hh||_&Hh){const S=u.collision&&(u.collision.hasEvent("triggerenter")||u.collision.hasEvent("triggerleave")),w=f.collision&&(f.collision.hasEvent("triggerenter")||f.collision.hasEvent("triggerleave")),T=u.rigidbody&&(u.rigidbody.hasEvent("triggerenter")||u.rigidbody.hasEvent("triggerleave")),b=f.rigidbody&&(f.rigidbody.hasEvent("triggerenter")||f.rigidbody.hasEvent("triggerleave"));S&&(x=this._storeCollision(u,f),x&&!(_&Hh)&&u.collision.fire("triggerenter",f)),w&&(x=this._storeCollision(f,u),x&&!(p&Hh)&&f.collision.fire("triggerenter",u)),T&&(x||(x=this._storeCollision(f,u)),x&&u.rigidbody.fire("triggerenter",f)),b&&(x||(x=this._storeCollision(u,f)),x&&f.rigidbody.fire("triggerenter",u))}else{const S=this._hasContactEvent(u),w=this._hasContactEvent(f),T=this.hasEvent("contact");if(T||S||w){for(let b=0;b<m;b++){const C=o.getContactPoint(b),E=this._createContactPointFromAmmo(C);if(S||w){g.push(E);const R=this._createReverseContactPointFromAmmo(C);v.push(R)}if(T){const R=this._createSingleContactResult(u,f,E);this.fire("contact",R)}}if(S){const b=this._createContactResult(f,g);x=this._storeCollision(u,f),u.collision&&(u.collision.fire("contact",b),x&&u.collision.fire("collisionstart",b)),u.rigidbody&&(u.rigidbody.fire("contact",b),x&&u.rigidbody.fire("collisionstart",b))}if(w){const b=this._createContactResult(u,v);x=this._storeCollision(f,u),f.collision&&(f.collision.fire("contact",b),x&&f.collision.fire("collisionstart",b)),f.rigidbody&&(f.rigidbody.fire("contact",b),x&&f.rigidbody.fire("collisionstart",b))}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()}onUpdate(e){let t,s;this._gravityFloat32[0]=this.gravity.x,this._gravityFloat32[1]=this.gravity.y,this._gravityFloat32[2]=this.gravity.z;const i=this.dynamicsWorld.getGravity();(i.x()!==this._gravityFloat32[0]||i.y()!==this._gravityFloat32[1]||i.z()!==this._gravityFloat32[2])&&(i.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(i));const n=this._triggers;for(t=0,s=n.length;t<s;t++)n[t].updateTransform();const a=this._compounds;for(t=0,s=a.length;t<s;t++)a[t]._updateCompound();const o=this._kinematic;for(t=0,s=o.length;t<s;t++)o[t]._updateKinematic();this.dynamicsWorld.stepSimulation(e,this.maxSubSteps,this.fixedTimeStep);const l=this._dynamic;for(t=0,s=l.length;t<s;t++)l[t]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),e)}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),typeof Ammo<"u"&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null)}}f0.EVENT_CONTACT="contact";ge._buildAccessors(rn.prototype,DT);const zo="none",Id="blend",gx=new q;class OT extends ge{constructor(e,t){super(e,t),this._resolution=new M(640,320),this._referenceResolution=new M(640,320),this._scaleMode=zo,this.scale=1,this._scaleBlend=.5,this._priority=0,this._screenSpace=!1,this.cull=this._screenSpace,this._screenMatrix=new q,this._elements=new Set,e.app.graphicsDevice.on("resizecanvas",this._onResize,this)}syncDrawOrder(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)}_recurseDrawOrderSync(e,t){if(!(e instanceof $))return t;if(e.element){const n=e.element.drawOrder;if(e.element.drawOrder=t++,e.element._batchGroupId>=0&&n!==e.element.drawOrder){var s;(s=this.system.app.batcher)==null||s.markGroupDirty(e.element._batchGroupId)}}e.particlesystem&&(e.particlesystem.drawOrder=t++);const i=e.children;for(let n=0;n<i.length;n++)t=this._recurseDrawOrderSync(i[n],t);return t}_processDrawOrderSync(){this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder")}_calcProjectionMatrix(){const e=this._resolution.x/this.scale,t=this._resolution.y/this.scale,s=0,i=e,n=-t;this._screenMatrix.setOrtho(s,i,n,0,1,-1),this._screenSpace||(gx.setScale(.5*e,.5*t,1),this._screenMatrix.mul2(gx,this._screenMatrix))}_updateScale(){this.scale=this._calcScale(this._resolution,this.referenceResolution)}_calcScale(e,t){const s=Math.log2((e.x||1)/t.x),i=Math.log2((e.y||1)/t.y);return Math.pow(2,s*(1-this._scaleBlend)+i*this._scaleBlend)}_onResize(e,t){this._screenSpace&&(this._resolution.set(e,t),this.resolution=this._resolution)}_bindElement(e){this._elements.add(e)}_unbindElement(e){this._elements.delete(e)}onRemove(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this._elements.forEach(e=>e._onScreenRemove()),this._elements.clear(),this.off()}set resolution(e){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution),this._elements.forEach(t=>t._onScreenResize(this._resolution))}get resolution(){return this._resolution}set referenceResolution(e){this._referenceResolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution),this._elements.forEach(t=>t._onScreenResize(this._resolution))}get referenceResolution(){return this._scaleMode===zo?this._resolution:this._referenceResolution}set screenSpace(e){this._screenSpace=e,this._screenSpace&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace),this._elements.forEach(t=>t._onScreenSpaceChange())}get screenSpace(){return this._screenSpace}set scaleMode(e){e!==zo&&e!==Id&&(e=zo),!this._screenSpace&&e!==zo&&(e=zo),this._scaleMode=e,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)}get scaleMode(){return this._scaleMode}set scaleBlend(e){this._scaleBlend=e,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend),this._elements.forEach(t=>t._onScreenResize(this._resolution))}get scaleBlend(){return this._scaleBlend}set priority(e){e>255&&(e=255),this._priority!==e&&(this._priority=e,this.syncDrawOrder())}get priority(){return this._priority}}class VN{constructor(){this.enabled=!0}}const FT=["enabled"];class GN extends tt{constructor(e){super(e),this.id="screen",this.ComponentType=OT,this.DataType=VN,this.schema=FT,this.windowResolution=new M,this._drawOrderSyncQueue=new CA,this.app.graphicsDevice.on("resizecanvas",this._onResize,this),this.app.systems.on("update",this._onUpdate,this),this.on("beforeremove",this.onRemoveComponent,this)}initializeComponentData(e,t,s){t.priority!==void 0&&(e.priority=t.priority),t.screenSpace!==void 0&&(e.screenSpace=t.screenSpace),e.cull=e.screenSpace,t.scaleMode!==void 0&&(e.scaleMode=t.scaleMode),t.scaleBlend!==void 0&&(e.scaleBlend=t.scaleBlend),t.resolution!==void 0&&(t.resolution instanceof M?e._resolution.copy(t.resolution):e._resolution.set(t.resolution[0],t.resolution[1]),e.resolution=e._resolution),t.referenceResolution!==void 0&&(t.referenceResolution instanceof M?e._referenceResolution.copy(t.referenceResolution):e._referenceResolution.set(t.referenceResolution[0],t.referenceResolution[1]),e.referenceResolution=e._referenceResolution),e.syncDrawOrder(),super.initializeComponentData(e,t,s)}destroy(){super.destroy(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.app.systems.off("update",this._onUpdate,this)}_onUpdate(e){const t=this.store;for(const s in t)t[s].entity.screen.update&&t[s].entity.screen.update(e)}_onResize(e,t){this.windowResolution.x=e,this.windowResolution.y=t}cloneComponent(e,t){const s=e.screen;return this.addComponent(t,{enabled:s.enabled,screenSpace:s.screenSpace,scaleMode:s.scaleMode,resolution:s.resolution.clone(),referenceResolution:s.referenceResolution.clone()})}onRemoveComponent(e,t){t.onRemove()}processDrawOrderSyncQueue(){const e=this._drawOrderSyncQueue.list();for(let t=0;t<e.length;t++){const s=e[t];s.callback.call(s.scope)}this._drawOrderSyncQueue.clear()}queueDrawOrderSync(e,t,s){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(e)||this._drawOrderSyncQueue.push(e,{callback:t,scope:s})}}ge._buildAccessors(OT.prototype,FT);class kT extends ge{constructor(e,t){super(e,t),this.on("set_scripts",this.onSetScripts,this)}send(e,t){const s=Array.prototype.slice.call(arguments,2),i=this.entity.script.instances;let n;if(i&&i[e]&&(n=i[e].instance[t],n))return n.apply(i[e].instance,s)}onEnable(){this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))}onDisable(){this.system._disableScriptComponent(this)}onSetScripts(e,t,s){if(!this.system._inTools||this.runInTools){if(this._updateScriptAttributes(t,s))return;this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),this.data.areScriptsLoaded=!1;const n=s.map(function(a){return a.url});if(this._loadFromCache(n))return;this._loadScripts(n)}}_updateScriptAttributes(e,t){let s=!0;if(e.length!==t.length)s=!1;else for(let i=0,n=t.length;i<n;i++)if(e[i].url!==t[i].url){s=!1;break}if(s)for(const i in this.instances)this.instances.hasOwnProperty(i)&&this.system._updateAccessors(this.entity,this.instances[i]);return s}_loadFromCache(e){const t=[],s=this.system.app._scriptPrefix||"",i=/^http(s)?:\/\//i;for(let n=0,a=e.length;n<a;n++){let o=e[n];i.test(o)||(o=me.join(s,o));const l=this.system.app.loader.getFromCache(o,"script");if(!l)return!1;t.push(l)}for(let n=0,a=t.length;n<a;n++){const o=t[n];if(o!==!0&&o&&this.entity.script&&!this.entity.script.instances[o._pcScriptName]){const l=new o(this.entity);this.system._preRegisterInstance(this.entity,e[n],o._pcScriptName,l)}}return this.data&&(this.data.areScriptsLoaded=!0),this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)),!0}_loadScripts(e){let t=e.length;const s=this.system.app._scriptPrefix||"";e.forEach(i=>{let n=null,a=null;i.toLowerCase().startsWith("http://")||i.toLowerCase().startsWith("https://")?(a=i,n=i):(a=i,n=me.join(s,i)),this.system.app.loader.load(n,"script",(o,l)=>{if(t--,o)console.error(o);else if(l&&this.entity.script&&!this.entity.script.instances[l._pcScriptName]){const c=new l(this.entity);this.system._preRegisterInstance(this.entity,a,l._pcScriptName,c)}t===0&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))})})}}class HN{constructor(){this.scripts=[],this.enabled=!0,this.instances={},this._instances={},this.runInTools=!1,this.attributes={},this.initialized=!1,this.postInitialized=!1,this.areScriptsLoaded=!1}}const BT=["enabled","scripts","instances","runInTools"],a_="initialize",o_="postInitialize",l_="update",h_="postUpdate",c_="fixedUpdate",d_="toolsUpdate",WN="onEnable",jN="onDisable";class $N extends tt{constructor(e){super(e),this.id="script",this.ComponentType=kT,this.DataType=HN,this.schema=BT,this.preloading=!1,this.instancesWithUpdate=[],this.instancesWithFixedUpdate=[],this.instancesWithPostUpdate=[],this.instancesWithToolsUpdate=[],this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on(a_,this.onInitialize,this),this.app.systems.on(o_,this.onPostInitialize,this),this.app.systems.on(l_,this.onUpdate,this),this.app.systems.on(c_,this.onFixedUpdate,this),this.app.systems.on(h_,this.onPostUpdate,this),this.app.systems.on(d_,this.onToolsUpdate,this)}initializeComponentData(e,t,s){s=["runInTools","enabled","scripts"],t.scripts&&t.scripts.length&&t.scripts.forEach(function(i){if(i.attributes&&Array.isArray(i.attributes)){const n={};for(let a=0;a<i.attributes.length;a++)n[i.attributes[a].name]=i.attributes[a];i.attributes=n}}),super.initializeComponentData(e,t,s)}cloneComponent(e,t){const s=this.store[e.getGuid()],i={runInTools:s.data.runInTools,scripts:[],enabled:s.data.enabled},n=s.data.scripts;for(let a=0,o=n.length;a<o;a++){const l=n[a].attributes;l&&delete n[a].attributes,i.scripts.push(Cr({},n[a])),l&&(i.scripts[a].attributes=this._cloneAttributes(l),n[a].attributes=l)}return this.addComponent(t,i)}onBeforeRemove(e,t){t.enabled&&this._disableScriptComponent(t),this._destroyScriptComponent(t)}onInitialize(e){if(this._registerInstances(e),e.enabled){e.script&&e.script.enabled&&this._initializeScriptComponent(e.script);const t=e._children;for(let s=0,i=t.length;s<i;s++)t[s]instanceof $&&this.onInitialize(t[s])}}onPostInitialize(e){if(e.enabled){e.script&&e.script.enabled&&this._postInitializeScriptComponent(e.script);const t=e._children;for(let s=0,i=t.length;s<i;s++)t[s]instanceof $&&this.onPostInitialize(t[s])}}_callInstancesMethod(e,t){const s=e.data.instances;for(const i in s)if(s.hasOwnProperty(i)){const n=s[i].instance;n[t]&&n[t]()}}_initializeScriptComponent(e){this._callInstancesMethod(e,a_),e.data.initialized=!0,e.enabled&&e.entity.enabled&&this._enableScriptComponent(e)}_enableScriptComponent(e){this._callInstancesMethod(e,WN)}_disableScriptComponent(e){this._callInstancesMethod(e,jN)}_destroyScriptComponent(e){const t=e.data.instances;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s].instance;if(i.destroy&&i.destroy(),i.update){const n=this.instancesWithUpdate.indexOf(i);n>=0&&this.instancesWithUpdate.splice(n,1)}if(i.fixedUpdate){const n=this.instancesWithFixedUpdate.indexOf(i);n>=0&&this.instancesWithFixedUpdate.splice(n,1)}if(i.postUpdate){const n=this.instancesWithPostUpdate.indexOf(i);n>=0&&this.instancesWithPostUpdate.splice(n,1)}if(i.toolsUpdate){const n=this.instancesWithToolsUpdate.indexOf(i);n>=0&&this.instancesWithToolsUpdate.splice(n,1)}e.instances[s].instance===e[s]&&delete e[s],delete e.instances[s]}}_postInitializeScriptComponent(e){this._callInstancesMethod(e,o_),e.data.postInitialized=!0}_updateInstances(e,t,s){for(let i=0,n=t.length;i<n;i++){const a=t[i];a&&a.entity&&a.entity.enabled&&a.entity.script.enabled&&a[e](s)}}onUpdate(e){this._updateInstances(l_,this.instancesWithUpdate,e)}onFixedUpdate(e){this._updateInstances(c_,this.instancesWithFixedUpdate,e)}onPostUpdate(e){this._updateInstances(h_,this.instancesWithPostUpdate,e)}onToolsUpdate(e){this._updateInstances(d_,this.instancesWithToolsUpdate,e)}broadcast(e,t){const s=Array.prototype.slice.call(arguments,2),i=this.store;for(const n in i)if(i.hasOwnProperty(n)){const a=i[n].data;if(a.instances[e]){const o=a.instances[e].instance[t];o&&o.apply(a.instances[e].instance,s)}}}_preRegisterInstance(e,t,s,i){if(e.script){if(e.script.data._instances=e.script.data._instances||{},e.script.data._instances[s])throw Error(`Script name collision '${s}'. Scripts from '${t}' and '${e.script.data._instances[s].url}' {${e.getGuid()}}`);e.script.data._instances[s]={url:t,name:s,instance:i}}}_registerInstances(e){if(e.script&&e.script.data._instances){e.script.instances=e.script.data._instances;for(const s in e.script.instances){const i=e.script.instances[s],n=i.instance;if(oy.attach(n),n.update&&this.instancesWithUpdate.push(n),n.fixedUpdate&&this.instancesWithFixedUpdate.push(n),n.postUpdate&&this.instancesWithPostUpdate.push(n),n.toolsUpdate&&this.instancesWithToolsUpdate.push(n),e.script.scripts&&this._createAccessors(e,i),e.script[s])throw Error(`Script with name '${s}' is already attached to Script Component`);e.script[s]=n}delete e.script.data._instances}const t=e._children;for(let s=0,i=t.length;s<i;s++)t[s]instanceof $&&this._registerInstances(t[s])}_cloneAttributes(e){const t={};for(const s in e)if(e.hasOwnProperty(s))if(e[s].type!=="entity")t[s]=Cr({},e[s]);else{const i=e[s].value;delete e[s].value,t[s]=Cr({},e[s]),t[s].value=i,e[s].value=i}return t}_createAccessors(e,t){const s=e.script.scripts.length,i=t.url;for(let n=0;n<s;n++){const a=e.script.scripts[n];if(a.url===i){const o=a.attributes;if(a.name&&o){for(const l in o)o.hasOwnProperty(l)&&this._createAccessor(o[l],t);e.script.data.attributes[a.name]=this._cloneAttributes(o)}break}}}_createAccessor(e,t){const s=this;e={name:e.name,value:e.value,type:e.type},this._convertAttributeValue(e),Object.defineProperty(t.instance,e.name,{get:function(){return e.value},set:function(i){const n=e.value;e.value=i,s._convertAttributeValue(e),t.instance.fire("set",e.name,n,e.value)},configurable:!0})}_updateAccessors(e,t){const s=e.script.scripts.length,i=t.url;for(let n=0;n<s;n++){const a=e.script,o=a.scripts[n];if(o.url===i){const l=o.name,c=o.attributes;if(l){if(c)for(const h in c)c.hasOwnProperty(h)&&this._createAccessor(c[h],t);const d=a.data.attributes[l];if(d)for(const h in d){const u=d[h];h in c?c[h].value!==u.value&&t.instance.onAttributeChanged&&t.instance.onAttributeChanged(u.name,u.value,c[h].value):delete t.instance[u.name]}c?a.data.attributes[l]=this._cloneAttributes(c):delete a.data.attributes[l]}break}}}_convertAttributeValue(e){if(e.type==="rgb"||e.type==="rgba")Array.isArray(e.value)&&(e.value=e.value.length===3?new k(e.value[0],e.value[1],e.value[2]):new k(e.value[0],e.value[1],e.value[2],e.value[3]));else if(e.type==="vec2")Array.isArray(e.value)&&(e.value=new M(e.value[0],e.value[1]));else if(e.type==="vec3"||e.type==="vector")Array.isArray(e.value)&&(e.value=new y(e.value[0],e.value[1],e.value[2]));else if(e.type==="vec4")Array.isArray(e.value)&&(e.value=new P(e.value[0],e.value[1],e.value[2],e.value[3]));else if(e.type==="entity")e.value!==null&&typeof e.value=="string"&&(e.value=this.app.root.findByGuid(e.value));else if(e.type==="curve"||e.type==="colorcurve"){const t=e.value.keys[0]instanceof Array?St:dt;e.value=new t(e.value.keys),e.value.type=e.value.type}}destroy(){super.destroy(),this.app.systems.off(a_,this.onInitialize,this),this.app.systems.off(o_,this.onPostInitialize,this),this.app.systems.off(l_,this.onUpdate,this),this.app.systems.off(c_,this.onFixedUpdate,this),this.app.systems.off(h_,this.onPostUpdate,this),this.app.systems.off(d_,this.onToolsUpdate,this)}}ge._buildAccessors(kT.prototype,BT);const or=new M,yx=new y,aa=new Ga,vx=new FA,Sx=new y,Rh=new y,XN=new re,qN={x:"y",y:"x"};class Rd extends ie{constructor(e,t){if(super(),!e||!(e instanceof ls))throw new Error("Element was null or not an ElementComponent");if(t&&t!=="x"&&t!=="y")throw new Error("Unrecognized axis: "+t);this._element=e,this._app=e.system.app,this._axis=t||null,this._enabled=!0,this._dragScale=new y,this._dragStartMousePosition=new y,this._dragStartHandlePosition=new y,this._deltaMousePosition=new y,this._deltaHandlePosition=new y,this._isDragging=!1,this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(e){this._element[e]("mousedown",this._onMouseDownOrTouchStart,this),this._element[e]("touchstart",this._onMouseDownOrTouchStart,this),this._element[e]("selectstart",this._onMouseDownOrTouchStart,this)}_toggleDragListeners(e){const t=e==="on";this._hasDragListeners&&t||(this._app.mouse&&(this._element[e]("mousemove",this._onMove,this),this._element[e]("mouseup",this._onMouseUpOrTouchEnd,this)),Te.touch&&(this._element[e]("touchmove",this._onMove,this),this._element[e]("touchend",this._onMouseUpOrTouchEnd,this),this._element[e]("touchcancel",this._onMouseUpOrTouchEnd,this)),this._element[e]("selectmove",this._onMove,this),this._element[e]("selectend",this._onMouseUpOrTouchEnd,this),this._hasDragListeners=t)}_onMouseDownOrTouchStart(e){if(this._element&&!this._isDragging&&this.enabled){this._dragCamera=e.camera,this._calculateDragScale();const t=this._screenToLocal(e);t&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(t),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))}}_onMouseUpOrTouchEnd(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))}_screenToLocal(e){return e.inputSource?aa.set(e.inputSource.getOrigin(),e.inputSource.getDirection()):(this._determineInputPosition(e),this._chooseRayOriginAndDirection()),Sx.copy(this._element.entity.forward).mulScalar(-1),vx.setFromPointNormal(this._element.entity.getPosition(),Sx),vx.intersectsRay(aa,Rh)?(XN.copy(this._element.entity.getRotation()).invert().transformVector(Rh,Rh),Rh.mul(this._dragScale),Rh):null}_determineInputPosition(e){const t=this._app.graphicsDevice.maxPixelRatio;typeof e.x<"u"&&typeof e.y<"u"?(or.x=e.x*t,or.y=e.y*t):e.changedTouches?(or.x=e.changedTouches[0].x*t,or.y=e.changedTouches[0].y*t):console.warn("Could not determine position from input event")}_chooseRayOriginAndDirection(){this._element.screen&&this._element.screen.screen.screenSpace?(aa.origin.set(or.x,-or.y,0),aa.direction.copy(y.FORWARD)):(yx.copy(this._dragCamera.screenToWorld(or.x,or.y,1)),aa.origin.copy(this._dragCamera.entity.getPosition()),aa.direction.copy(yx).sub(aa.origin).normalize())}_calculateDragScale(){let e=this._element.entity.parent;const t=this._element.screen&&this._element.screen.screen,s=t&&t.screenSpace,i=s?t.scale:1,n=this._dragScale;for(n.set(i,i,i);e&&(n.mul(e.getLocalScale()),e=e.parent,!(s&&e.screen)););n.x=1/n.x,n.y=1/n.y,n.z=0}_onMove(e){const{_element:t,_deltaMousePosition:s,_deltaHandlePosition:i,_axis:n}=this;if(t&&this._isDragging&&this.enabled&&t.enabled&&t.entity.enabled){const a=this._screenToLocal(e);if(a){if(s.sub2(a,this._dragStartMousePosition),i.add2(this._dragStartHandlePosition,s),n){const o=t.entity.getLocalPosition(),l=qN[n];i[l]=o[l]}t.entity.setLocalPosition(i),this.fire("drag:move",i)}}}destroy(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off")}set enabled(e){this._enabled=e}get enabled(){return this._enabled}get isDragging(){return this._isDragging}}Rd.EVENT_DRAGSTART="drag:start";Rd.EVENT_DRAGEND="drag:end";Rd.EVENT_DRAGMOVE="drag:move";const KN=0,$l=1,YN=2,ZN=0,tm=1,Lh=new M;class p0 extends ge{constructor(e,t){super(e,t),this._viewportReference=new Aa(this,"viewportEntity",{"element#gain":this._onViewportElementGain,"element#resize":this._onSetContentOrViewportSize}),this._contentReference=new Aa(this,"contentEntity",{"element#gain":this._onContentElementGain,"element#lose":this._onContentElementLose,"element#resize":this._onSetContentOrViewportSize}),this._scrollbarUpdateFlags={},this._scrollbarReferences={},this._scrollbarReferences[pe]=new Aa(this,"horizontalScrollbarEntity",{"scrollbar#set:value":this._onSetHorizontalScrollbarValue,"scrollbar#gain":this._onHorizontalScrollbarGain}),this._scrollbarReferences[Pe]=new Aa(this,"verticalScrollbarEntity",{"scrollbar#set:value":this._onSetVerticalScrollbarValue,"scrollbar#gain":this._onVerticalScrollbarGain}),this._prevContentSizes={},this._prevContentSizes[pe]=null,this._prevContentSizes[Pe]=null,this._scroll=new M,this._velocity=new y,this._dragStartPosition=new y,this._disabledContentInput=!1,this._disabledContentInputEntities=[],this._toggleLifecycleListeners("on",e),this._toggleElementListeners("on")}_toggleLifecycleListeners(e,t){this[e]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[e]("set_vertical",this._onSetVerticalScrollingEnabled,this),t.app.systems.element[e]("add",this._onElementComponentAdd,this),t.app.systems.element[e]("beforeremove",this._onElementComponentRemove,this)}_toggleElementListeners(e){if(this.entity.element){if(e==="on"&&this._hasElementListeners)return;this.entity.element[e]("resize",this._onSetContentOrViewportSize,this),this.entity.element[e](Oy,this._onMouseWheel,this),this._hasElementListeners=e==="on"}}_onElementComponentAdd(e){this.entity===e&&this._toggleElementListeners("on")}_onElementComponentRemove(e){this.entity===e&&this._toggleElementListeners("off")}_onViewportElementGain(){this._syncAll()}_onContentElementGain(){this._destroyDragHelper(),this._contentDragHelper=new Rd(this._contentReference.entity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[pe]=null,this._prevContentSizes[Pe]=null,this._syncAll()}_onContentElementLose(){this._destroyDragHelper()}_onContentDragStart(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())}_onContentDragEnd(){this._prevContentDragPosition=null,this._enableContentInput()}_onContentDragMove(e){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(e),this._setVelocityFromContentPositionDelta(e),!this._disabledContentInput)){const t=e.x-this._dragStartPosition.x,s=e.y-this._dragStartPosition.y;(Math.abs(t)>this.dragThreshold||Math.abs(s)>this.dragThreshold)&&this._disableContentInput()}}_onSetContentOrViewportSize(){this._syncAll()}_onSetHorizontalScrollbarValue(e){!this._scrollbarUpdateFlags[pe]&&this.enabled&&this.entity.enabled&&this._onSetScroll(e,null)}_onSetVerticalScrollbarValue(e){!this._scrollbarUpdateFlags[Pe]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,e)}_onSetHorizontalScrollingEnabled(){this._syncScrollbarEnabledState(pe)}_onSetVerticalScrollingEnabled(){this._syncScrollbarEnabledState(Pe)}_onHorizontalScrollbarGain(){this._syncScrollbarEnabledState(pe),this._syncScrollbarPosition(pe)}_onVerticalScrollbarGain(){this._syncScrollbarEnabledState(Pe),this._syncScrollbarPosition(Pe)}_onSetScroll(e,t,s){s!==!1&&this._velocity.set(0,0,0);const i=this._updateAxis(e,"x",pe),n=this._updateAxis(t,"y",Pe);(i||n)&&this.fire("set:scroll",this._scroll)}_updateAxis(e,t,s){const i=e!==null&&Math.abs(e-this._scroll[t])>1e-5;return(i||this._isDragging()||e===0)&&(this._scroll[t]=this._determineNewScrollValue(e,t,s),this._syncContentPosition(s),this._syncScrollbarPosition(s)),i}_determineNewScrollValue(e,t,s){if(!this._getScrollingEnabled(s))return this._scroll[t];switch(this.scrollMode){case KN:return H.clamp(e,0,this._getMaxScrollValue(s));case $l:return this._setVelocityFromOvershoot(e,t,s),e;case YN:return e;default:return console.warn("Unhandled scroll mode:"+this.scrollMode),e}}_syncAll(){this._syncContentPosition(pe),this._syncContentPosition(Pe),this._syncScrollbarPosition(pe),this._syncScrollbarPosition(Pe),this._syncScrollbarEnabledState(pe),this._syncScrollbarEnabledState(Pe)}_syncContentPosition(e){const t=this._getAxis(e),s=this._getSign(e),i=this._contentReference.entity;if(i){const n=this._prevContentSizes[e],a=this._getContentSize(e);if(n!==null&&Math.abs(n-a)>1e-4){const c=this._getMaxOffset(e,n),d=this._getMaxOffset(e,a);d===0?this._scroll[t]=1:this._scroll[t]=H.clamp(this._scroll[t]*c/d,0,1)}const o=this._scroll[t]*this._getMaxOffset(e),l=i.getLocalPosition();l[t]=o*s,i.setLocalPosition(l),this._prevContentSizes[e]=a}}_syncScrollbarPosition(e){const t=this._getAxis(e),s=this._scrollbarReferences[e].entity;s&&s.scrollbar&&(this._scrollbarUpdateFlags[e]=!0,s.scrollbar.value=this._scroll[t],s.scrollbar.handleSize=this._getScrollbarHandleSize(t,e),this._scrollbarUpdateFlags[e]=!1)}_syncScrollbarEnabledState(e){const t=this._scrollbarReferences[e].entity;if(t){const s=this._getScrollingEnabled(e),i=this._getScrollbarVisibility(e);switch(i){case ZN:t.enabled=s;return;case tm:t.enabled=s&&this._contentIsLargerThanViewport(e);return;default:console.warn("Unhandled scrollbar visibility:"+i),t.enabled=s}}}_contentIsLargerThanViewport(e){return this._getContentSize(e)>this._getViewportSize(e)}_contentPositionToScrollValue(e){const t=this._getMaxOffset(pe),s=this._getMaxOffset(Pe);return t===0?Lh.x=0:Lh.x=e.x/t,s===0?Lh.y=0:Lh.y=e.y/-s,Lh}_getMaxOffset(e,t){t=t===void 0?this._getContentSize(e):t;const s=this._getViewportSize(e);return t<s?-this._getViewportSize(e):s-t}_getMaxScrollValue(e){return this._contentIsLargerThanViewport(e)?1:0}_getScrollbarHandleSize(e,t){const s=this._getViewportSize(t),i=this._getContentSize(t);if(Math.abs(i)<.001)return 1;const n=Math.min(s/i,1),a=this._toOvershoot(this._scroll[e],t);return a===0?n:n/(1+Math.abs(a))}_getViewportSize(e){return this._getSize(e,this._viewportReference)}_getContentSize(e){return this._getSize(e,this._contentReference)}_getSize(e,t){return t.entity&&t.entity.element?t.entity.element[this._getCalculatedDimension(e)]:0}_getScrollingEnabled(e){if(e===pe)return this.horizontal;if(e===Pe)return this.vertical}_getScrollbarVisibility(e){if(e===pe)return this.horizontalScrollbarVisibility;if(e===Pe)return this.verticalScrollbarVisibility}_getSign(e){return e===pe?1:-1}_getAxis(e){return e===pe?"x":"y"}_getCalculatedDimension(e){return e===pe?"calculatedWidth":"calculatedHeight"}_destroyDragHelper(){this._contentDragHelper&&this._contentDragHelper.destroy()}onUpdate(){this._contentReference.entity&&(this._updateVelocity(),this._syncScrollbarEnabledState(pe),this._syncScrollbarEnabledState(Pe))}_updateVelocity(){if(!this._isDragging()){if(this.scrollMode===$l&&(this._hasOvershoot("x",pe)&&this._setVelocityFromOvershoot(this.scroll.x,"x",pe),this._hasOvershoot("y",Pe)&&this._setVelocityFromOvershoot(this.scroll.y,"y",Pe)),Math.abs(this._velocity.x)>1e-4||Math.abs(this._velocity.y)>1e-4){const e=this._contentReference.entity.getLocalPosition();e.x+=this._velocity.x,e.y+=this._velocity.y,this._contentReference.entity.setLocalPosition(e),this._setScrollFromContentPosition(e)}this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction}}_hasOvershoot(e,t){return Math.abs(this._toOvershoot(this.scroll[e],t))>.001}_toOvershoot(e,t){const s=this._getMaxScrollValue(t);return e<0?e:e>s?e-s:0}_setVelocityFromOvershoot(e,t,s){const n=this._toOvershoot(e,s)*this._getMaxOffset(s)*this._getSign(s);Math.abs(n)>0&&(this._velocity[t]=-n/(this.bounceAmount*50+1))}_setVelocityFromContentPositionDelta(e){this._prevContentDragPosition?(this._velocity.sub2(e,this._prevContentDragPosition),this._prevContentDragPosition.copy(e)):(this._velocity.set(0,0,0),this._prevContentDragPosition=e.clone())}_setScrollFromContentPosition(e){let t=this._contentPositionToScrollValue(e);this._isDragging()&&(t=this._applyScrollValueTension(t)),this._onSetScroll(t.x,t.y,!1)}_applyScrollValueTension(e){let s=this._getMaxScrollValue(pe),i=this._toOvershoot(e.x,pe);return i>0?e.x=s+1*Math.log10(1+i):i<0&&(e.x=-1*Math.log10(1-i)),s=this._getMaxScrollValue(Pe),i=this._toOvershoot(e.y,Pe),i>0?e.y=s+1*Math.log10(1+i):i<0&&(e.y=-1*Math.log10(1-i)),e}_isDragging(){return this._contentDragHelper&&this._contentDragHelper.isDragging}_setScrollbarComponentsEnabled(e){this._scrollbarReferences[pe].hasComponent("scrollbar")&&(this._scrollbarReferences[pe].entity.scrollbar.enabled=e),this._scrollbarReferences[Pe].hasComponent("scrollbar")&&(this._scrollbarReferences[Pe].entity.scrollbar.enabled=e)}_setContentDraggingEnabled(e){this._contentDragHelper&&(this._contentDragHelper.enabled=e)}_onMouseWheel(e){if(this.useMouseWheel){const t=e.event,s=t.deltaX/this._contentReference.entity.element.calculatedWidth*this.mouseWheelSensitivity.x,i=t.deltaY/this._contentReference.entity.element.calculatedHeight*this.mouseWheelSensitivity.y,n=H.clamp(this._scroll.x+s,0,this._getMaxScrollValue(pe)),a=H.clamp(this._scroll.y+i,0,this._getMaxScrollValue(Pe));this.scroll=new M(n,a)}}_enableContentInput(){for(;this._disabledContentInputEntities.length;){const e=this._disabledContentInputEntities.pop();e.element&&(e.element.useInput=!0)}this._disabledContentInput=!1}_disableContentInput(){const e=s=>{s.element&&s.element.useInput&&(this._disabledContentInputEntities.push(s),s.element.useInput=!1);const i=s.children;for(let n=0,a=i.length;n<a;n++)e(i[n])},t=this._contentReference.entity;if(t){const s=t.children;for(let i=0,n=s.length;i<n;i++)e(s[i])}this._disabledContentInput=!0}onEnable(){this._viewportReference.onParentComponentEnable(),this._contentReference.onParentComponentEnable(),this._scrollbarReferences[pe].onParentComponentEnable(),this._scrollbarReferences[Pe].onParentComponentEnable(),this._setScrollbarComponentsEnabled(!0),this._setContentDraggingEnabled(!0),this._syncAll()}onDisable(){this._setScrollbarComponentsEnabled(!1),this._setContentDraggingEnabled(!1)}onRemove(){this._toggleLifecycleListeners("off",this.system),this._toggleElementListeners("off"),this._destroyDragHelper()}set scroll(e){this._onSetScroll(e.x,e.y)}get scroll(){return this._scroll}}p0.EVENT_SETSCROLL="set:scroll";class JN{constructor(){this.enabled=!0}}const Dg=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"useMouseWheel",type:"boolean"},{name:"mouseWheelSensitivity",type:"vec2"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},{name:"verticalScrollbarEntity",type:"entity"}],QN=10;class eU extends tt{constructor(e){super(e),this.id="scrollview",this.ComponentType=p0,this.DataType=JN,this.schema=Dg,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){t.dragThreshold===void 0&&(t.dragThreshold=QN),t.useMouseWheel===void 0&&(t.useMouseWheel=!0),t.mouseWheelSensitivity===void 0&&(t.mouseWheelSensitivity=new M(1,1)),super.initializeComponentData(e,t,Dg)}onUpdate(e){const t=this.store;for(const s in t){const i=t[s].entity,n=i.scrollview;n.enabled&&i.enabled&&n.onUpdate()}}_onRemoveComponent(e,t){t.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}ge._buildAccessors(p0.prototype,Dg);class m0 extends ge{constructor(e,t){super(e,t),this._handleReference=new Aa(this,"handleEntity",{"element#gain":this._onHandleElementGain,"element#lose":this._onHandleElementLose,"element#set:anchor":this._onSetHandleAlignment,"element#set:margin":this._onSetHandleAlignment,"element#set:pivot":this._onSetHandleAlignment}),this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(e){this[e]("set_value",this._onSetValue,this),this[e]("set_handleSize",this._onSetHandleSize,this),this[e]("set_orientation",this._onSetOrientation,this)}_onHandleElementGain(){this._destroyDragHelper(),this._handleDragHelper=new Rd(this._handleReference.entity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize()}_onHandleElementLose(){this._destroyDragHelper()}_onHandleDrag(e){this._handleReference.entity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(e[this._getAxis()]))}_onSetValue(e,t,s){Math.abs(s-t)>1e-5&&(this.data.value=H.clamp(s,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))}_onSetHandleSize(e,t,s){Math.abs(s-t)>1e-5&&(this.data.handleSize=H.clamp(s,0,1),this._updateHandlePositionAndSize())}_onSetHandleAlignment(){this._updateHandlePositionAndSize()}_onSetOrientation(e,t,s){s!==t&&this._handleReference.hasComponent("element")&&(this._handleReference.entity.element[this._getOppositeDimension()]=0)}_updateHandlePositionAndSize(){const e=this._handleReference.entity,t=e&&e.element;if(e){const s=e.getLocalPosition();s[this._getAxis()]=this._getHandlePosition(),this._handleReference.entity.setLocalPosition(s)}t&&(t[this._getDimension()]=this._getHandleLength())}_handlePositionToScrollValue(e){return e*this._getSign()/this._getUsableTrackLength()}_scrollValueToHandlePosition(e){return e*this._getSign()*this._getUsableTrackLength()}_getUsableTrackLength(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)}_getTrackLength(){return this.entity.element?this.orientation===pe?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0}_getHandleLength(){return this._getTrackLength()*this.handleSize}_getHandlePosition(){return this._scrollValueToHandlePosition(this.value)}_getSign(){return this.orientation===pe?1:-1}_getAxis(){return this.orientation===pe?"x":"y"}_getDimension(){return this.orientation===pe?"width":"height"}_getOppositeDimension(){return this.orientation===pe?"height":"width"}_destroyDragHelper(){this._handleDragHelper&&this._handleDragHelper.destroy()}_setHandleDraggingEnabled(e){this._handleDragHelper&&(this._handleDragHelper.enabled=e)}onEnable(){this._handleReference.onParentComponentEnable(),this._setHandleDraggingEnabled(!0)}onDisable(){this._setHandleDraggingEnabled(!1)}onRemove(){this._destroyDragHelper(),this._toggleLifecycleListeners("off")}}m0.EVENT_SETVALUE="set:value";class tU{constructor(){this.enabled=!0}}const Og=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"},{name:"handleEntity",type:"entity"}];class sU extends tt{constructor(e){super(e),this.id="scrollbar",this.ComponentType=m0,this.DataType=tU,this.schema=Og,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(e,t,s){super.initializeComponentData(e,t,Og)}_onRemoveComponent(e,t){t.onRemove()}}ge._buildAccessors(m0.prototype,Og);const iU={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new y,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null};class Ar extends ie{constructor(e,t="Untitled",s={}){super(),this.name=void 0,this.instances=[],this._component=e,this._assets=e.system.app.assets,this._manager=e.system.manager,this.name=t,this._volume=s.volume!==void 0?H.clamp(Number(s.volume)||0,0,1):1,this._pitch=s.pitch!==void 0?Math.max(.01,Number(s.pitch)||0):1,this._loop=!!(s.loop!==void 0&&s.loop),this._duration=s.duration>0?s.duration:null,this._startTime=Math.max(0,Number(s.startTime)||0),this._overlap=!!s.overlap,this._autoPlay=!!s.autoPlay,this._firstNode=null,this._lastNode=null,this._asset=s.asset,this._asset instanceof ne&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this)}play(){if(this.overlap||this.stop(),!this.isLoaded&&!this._hasAsset())return;const e=this._createInstance();if(this.instances.push(e),this.isLoaded)e.play();else{const t=function(i){const n=e._playWhenLoaded;e.sound=i,n&&e.play()};this.off("load",t),this.once("load",t),this.load()}return e}pause(){let e=!1;const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].pause()&&(e=!0);return e}resume(){let e=!1;const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].resume()&&(e=!0);return e}stop(){let e=!1;const t=this.instances;let s=t.length;for(;s--;)t[s].stop(),e=!0;return t.length=0,e}load(){if(!this._hasAsset())return;const e=this._assets.get(this._asset);if(!e){this._assets.off("add:"+this._asset,this._onAssetAdd,this),this._assets.once("add:"+this._asset,this._onAssetAdd,this);return}if(e.off("remove",this._onAssetRemoved,this),e.on("remove",this._onAssetRemoved,this),!e.resource){e.off("load",this._onAssetLoad,this),e.once("load",this._onAssetLoad,this),this._assets.load(e);return}this.fire("load",e.resource)}setExternalNodes(e,t){if(!e){console.error("The firstNode must have a valid AudioNode");return}if(t||(t=e),this._firstNode=e,this._lastNode=t,!this._overlap){const s=this.instances;for(let i=0,n=s.length;i<n;i++)s[i].setExternalNodes(e,t)}}clearExternalNodes(){if(this._firstNode=null,this._lastNode=null,!this._overlap){const e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].clearExternalNodes()}}getExternalNodes(){return[this._firstNode,this._lastNode]}_hasAsset(){return this._asset!=null}_createInstance(){let e=null;const t=this._component;let s=null;if(this._hasAsset()){const n=this._assets.get(this._asset);n&&(s=n.resource)}const i=iU;return i.volume=this._volume*t.volume,i.pitch=this._pitch*t.pitch,i.loop=this._loop,i.startTime=this._startTime,i.duration=this._duration,i.onPlay=this._onInstancePlayHandler,i.onPause=this._onInstancePauseHandler,i.onResume=this._onInstanceResumeHandler,i.onStop=this._onInstanceStopHandler,i.onEnd=this._onInstanceEndHandler,t.positional?(i.position.copy(t.entity.getPosition()),i.maxDistance=t.maxDistance,i.refDistance=t.refDistance,i.rollOffFactor=t.rollOffFactor,i.distanceModel=t.distanceModel,e=new Xo(this._manager,s,i)):e=new ri(this._manager,s,i),this._firstNode&&e.setExternalNodes(this._firstNode,this._lastNode),e}_onInstancePlay(e){this.fire("play",e),this._component.fire("play",this,e)}_onInstancePause(e){this.fire("pause",e),this._component.fire("pause",this,e)}_onInstanceResume(e){this.fire("resume",e),this._component.fire("resume",this,e)}_onInstanceStop(e){const t=this.instances.indexOf(e);t!==-1&&this.instances.splice(t,1),this.fire("stop",e),this._component.fire("stop",this,e)}_onInstanceEnd(e){const t=this.instances.indexOf(e);t!==-1&&this.instances.splice(t,1),this.fire("end",e),this._component.fire("end",this,e)}_onAssetAdd(e){this.load()}_onAssetLoad(e){this.load()}_onAssetRemoved(e){e.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+e.id,this._onAssetAdd,this),this.stop()}updatePosition(e){const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].position=e}set asset(e){const t=this._asset;if(t){this._assets.off("add:"+t,this._onAssetAdd,this);const s=this._assets.get(t);s&&s.off("remove",this._onAssetRemoved,this)}this._asset=e,this._asset instanceof ne&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}get asset(){return this._asset}set autoPlay(e){this._autoPlay=!!e}get autoPlay(){return this._autoPlay}set duration(e){if(this._duration=Math.max(0,Number(e)||0)||null,!this._overlap){const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].duration=this._duration}}get duration(){let e=0;if(this._hasAsset()){const t=this._assets.get(this._asset);e=t!=null&&t.resource?t.resource.duration:0}return this._duration!=null?this._duration%(e||1):e}get isLoaded(){if(this._hasAsset()){const e=this._assets.get(this._asset);if(e)return!!e.resource}return!1}get isPaused(){const e=this.instances,t=e.length;if(t===0)return!1;for(let s=0;s<t;s++)if(!e[s].isPaused)return!1;return!0}get isPlaying(){const e=this.instances;for(let t=0,s=e.length;t<s;t++)if(e[t].isPlaying)return!0;return!1}get isStopped(){const e=this.instances;for(let t=0,s=e.length;t<s;t++)if(!e[t].isStopped)return!1;return!0}set loop(e){this._loop=!!e;const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].loop=this._loop}get loop(){return this._loop}set overlap(e){this._overlap=!!e}get overlap(){return this._overlap}set pitch(e){if(this._pitch=Math.max(Number(e)||0,.01),!this._overlap){const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].pitch=this.pitch*this._component.pitch}}get pitch(){return this._pitch}set startTime(e){if(this._startTime=Math.max(0,Number(e)||0),!this._overlap){const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].startTime=this._startTime}}get startTime(){return this._startTime}set volume(e){if(this._volume=H.clamp(Number(e)||0,0,1),!this._overlap){const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].volume=this._volume*this._component.volume}}get volume(){return this._volume}}Ar.EVENT_PLAY="play";Ar.EVENT_PAUSE="pause";Ar.EVENT_RESUME="resume";Ar.EVENT_STOP="stop";Ar.EVENT_LOAD="load";class fo extends ge{constructor(e,t){super(e,t),this._volume=1,this._pitch=1,this._positional=!0,this._refDistance=1,this._maxDistance=1e4,this._rollOffFactor=1,this._distanceModel=np,this._slots={},this._playingBeforeDisable={}}_updateSoundInstances(e,t,s){const i=this._slots;for(const n in i){const a=i[n];if(!a.overlap){const o=a.instances;for(let l=0,c=o.length;l<c;l++)o[l][e]=s?a[e]*t:t}}}set distanceModel(e){this._distanceModel=e,this._updateSoundInstances("distanceModel",e,!1)}get distanceModel(){return this._distanceModel}set maxDistance(e){this._maxDistance=e,this._updateSoundInstances("maxDistance",e,!1)}get maxDistance(){return this._maxDistance}set refDistance(e){this._refDistance=e,this._updateSoundInstances("refDistance",e,!1)}get refDistance(){return this._refDistance}set rollOffFactor(e){this._rollOffFactor=e,this._updateSoundInstances("rollOffFactor",e,!1)}get rollOffFactor(){return this._rollOffFactor}set pitch(e){this._pitch=e,this._updateSoundInstances("pitch",e,!0)}get pitch(){return this._pitch}set volume(e){this._volume=e,this._updateSoundInstances("volume",e,!0)}get volume(){return this._volume}set positional(e){this._positional=e;const t=this._slots;for(const s in t){const i=t[s];if(!i.overlap){const n=i.instances,a=n.length;for(let o=a-1;o>=0;o--){const l=n[o].isPlaying||n[o].isSuspended,c=n[o].currentTime;l&&n[o].stop();const d=i._createInstance();l&&(d.play(),d.currentTime=c),n.push(d)}}}}get positional(){return this._positional}set slots(e){const t=this._slots;if(t)for(const i in t)t[i].stop();const s={};for(const i in e)e[i]instanceof Ar?s[e[i].name]=e[i]:e[i].name&&(s[e[i].name]=new Ar(this,e[i].name,e[i]));this._slots=s,this.enabled&&this.entity.enabled&&this.onEnable()}get slots(){return this._slots}onEnable(){if(this.system._inTools)return;const e=this._slots,t=this._playingBeforeDisable;for(const s in e){const i=e[s];i.autoPlay&&i.isStopped?i.play():t[s]?i.resume():i.isLoaded||i.load()}}onDisable(){const e=this._slots,t={};for(const s in e)e[s].overlap||e[s].isPlaying&&(e[s].pause(),t[s]=!0);this._playingBeforeDisable=t}onRemove(){this.off()}addSlot(e,t){const s=this._slots;if(s[e])return null;const i=new Ar(this,e,t);return s[e]=i,i.autoPlay&&this.enabled&&this.entity.enabled&&i.play(),i}removeSlot(e){const t=this._slots;t[e]&&(t[e].stop(),delete t[e])}slot(e){return this._slots[e]}_getSlotProperty(e,t){if(!this.enabled||!this.entity.enabled)return;const s=this._slots[e];if(s)return s[t]}isPlaying(e){return this._getSlotProperty(e,"isPlaying")||!1}isLoaded(e){return this._getSlotProperty(e,"isLoaded")||!1}isPaused(e){return this._getSlotProperty(e,"isPaused")||!1}isStopped(e){return this._getSlotProperty(e,"isStopped")||!1}play(e){if(!this.enabled||!this.entity.enabled)return null;const t=this._slots[e];return t?t.play():null}pause(e){const t=this._slots;if(e){const s=t[e];if(!s)return;s.pause()}else for(const s in t)t[s].pause()}resume(e){const t=this._slots;if(e){const s=t[e];if(!s)return;s.isPaused&&s.resume()}else for(const s in t)t[s].resume()}stop(e){const t=this._slots;if(e){const s=t[e];if(!s)return;s.stop()}else for(const s in t)t[s].stop()}}fo.EVENT_PLAY="play";fo.EVENT_PAUSE="pause";fo.EVENT_RESUME="resume";fo.EVENT_STOP="stop";fo.EVENT_END="end";class nU{constructor(){this.enabled=!0}}const NT=["enabled"];class rU extends tt{constructor(e){super(e),this.id="sound",this.ComponentType=fo,this.DataType=nU,this.schema=NT,this.manager=e.soundManager,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}set volume(e){this.manager.volume=e}get volume(){return this.manager.volume}get context(){return jn()?this.manager.context:null}initializeComponentData(e,t,s){s=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"];for(let i=0;i<s.length;i++)t.hasOwnProperty(s[i])&&(e[s[i]]=t[s[i]]);super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s=e.sound,i=s.slots,n={};for(const o in i){const l=i[o];n[o]={name:l.name,volume:l.volume,pitch:l.pitch,loop:l.loop,duration:l.duration,startTime:l.startTime,overlap:l.overlap,autoPlay:l.autoPlay,asset:l.asset}}const a={distanceModel:s.distanceModel,enabled:s.enabled,maxDistance:s.maxDistance,pitch:s.pitch,positional:s.positional,refDistance:s.refDistance,rollOffFactor:s.rollOffFactor,slots:n,volume:s.volume};return this.addComponent(t,a)}onUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const n=t[s].entity;if(n.enabled){const a=n.sound;if(a.enabled&&a.positional){const o=n.getPosition(),l=a.slots;for(const c in l)l[c].updatePosition(o)}}}}onBeforeRemove(e,t){const s=t.slots;for(const i in s)s[i].overlap||s[i].stop();t.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}ge._buildAccessors(fo.prototype,NT);const Ur="simple",wf="animated";class Ht extends ie{constructor(e,t){super(),this._component=e,this._frame=0,this._sprite=null,this._spriteAsset=null,this.spriteAsset=t.spriteAsset,this.name=t.name,this.fps=t.fps||0,this.loop=t.loop||!1,this._playing=!1,this._paused=!1,this._time=0}get duration(){if(this._sprite){const e=this.fps||Number.MIN_VALUE;return this._sprite.frameKeys.length/Math.abs(e)}return 0}set frame(e){this._setFrame(e);const t=this.fps||Number.MIN_VALUE;this._setTime(this._frame/t)}get frame(){return this._frame}get isPaused(){return this._paused}get isPlaying(){return this._playing}set sprite(e){if(this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),this._sprite=e,this._sprite&&(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this){let t;!e||!e.atlas?(t=this._component._meshInstance,t&&(t.deleteParameter("texture_emissiveMap"),t.deleteParameter("texture_opacityMap")),this._component._hideModel()):(e.atlas.texture&&(t=this._component._meshInstance,t&&(t.setParameter("texture_emissiveMap",e.atlas.texture),t.setParameter("texture_opacityMap",e.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame)}}get sprite(){return this._sprite}set spriteAsset(e){const t=this._component.system.app.assets;let s=e;if(e instanceof ne&&(s=e.id),this._spriteAsset!==s){if(this._spriteAsset){const i=t.get(this._spriteAsset);i&&this._unbindSpriteAsset(i)}if(this._spriteAsset=s,this._spriteAsset){const i=t.get(this._spriteAsset);i?this._bindSpriteAsset(i):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}}get spriteAsset(){return this._spriteAsset}set time(e){this._setTime(e),this._sprite?this.frame=Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):this.frame=0}get time(){return this._time}_onSpriteAssetAdded(e){this._component.system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)}_bindSpriteAsset(e){e.on("load",this._onSpriteAssetLoad,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._component.system.app.assets.load(e)}_unbindSpriteAsset(e){e&&(e.off("load",this._onSpriteAssetLoad,this),e.off("remove",this._onSpriteAssetRemove,this),e.resource&&!e.resource.atlas&&this._component.system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this))}_onSpriteAssetLoad(e){if(!e.resource)this.sprite=null;else if(e.resource.atlas)this.sprite=e.resource;else{const t=e.data.textureAtlasAsset,s=this._component.system.app.assets;s.off("load:"+t,this._onTextureAtlasLoad,this),s.once("load:"+t,this._onTextureAtlasLoad,this)}}_onTextureAtlasLoad(e){const t=this._spriteAsset;t instanceof ne?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._component.system.app.assets.get(t))}_onSpriteAssetRemove(e){this.sprite=null}_onSpriteMeshesChange(){this._component.currentClip===this&&this._component._showFrame(this.frame)}_onSpritePpuChanged(){this._component.currentClip===this&&this.sprite.renderMode!==Pn&&this._component._showFrame(this.frame)}_update(e){if(this.fps===0||!this._playing||this._paused||!this._sprite)return;const t=this.fps<0?-1:1,s=this._time+e*this._component.speed*t,i=this.duration,n=s>i||s<0;this._setTime(s);let a=this.frame;this._sprite?a=Math.floor(this._sprite.frameKeys.length*this._time/i):a=0,a!==this._frame&&this._setFrame(a),n&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._playing=!1,this._paused=!1,this.fire("end"),this._component.fire("end",this)))}_setTime(e){this._time=e;const t=this.duration;this._time<0?this.loop?this._time=this._time%t+t:this._time=0:this._time>t&&(this.loop?this._time%=t:this._time=t)}_setFrame(e){this._sprite?this._frame=H.clamp(e,0,this._sprite.frameKeys.length-1):this._frame=e,this._component.currentClip===this&&this._component._showFrame(this._frame)}_destroy(){if(this._spriteAsset){const e=this._component.system.app.assets;this._unbindSpriteAsset(e.get(this._spriteAsset))}this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null)}play(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))}pause(){!this._playing||this._paused||(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))}resume(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))}stop(){this._playing&&(this._playing=!1,this._paused=!1,this._time=0,this.frame=0,this.fire("stop"),this._component.fire("stop",this))}}Ht.EVENT_PLAY="play";Ht.EVENT_PAUSE="pause";Ht.EVENT_RESUME="resume";Ht.EVENT_STOP="stop";Ht.EVENT_END="end";Ht.EVENT_LOOP="loop";const xx="texture_emissiveMap",wx="texture_opacityMap",bx="material_emissive",Tx="material_opacity",aU="innerOffset",oU="outerScale",lU="atlasRect";class Xr extends ge{constructor(e,t){super(e,t),this._type=Ur,this._material=e.defaultMaterial,this._color=new k(1,1,1,1),this._colorUniform=new Float32Array(3),this._speed=1,this._flipX=!1,this._flipY=!1,this._width=1,this._height=1,this._drawOrder=0,this._layers=[Ws],this._outerScale=new M(1,1),this._outerScaleUniform=new Float32Array(2),this._innerOffset=new P,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new P,this._atlasRectUniform=new Float32Array(4),this._batchGroupId=-1,this._batchGroup=null,this._node=new ze,this._model=new $n,this._model.graph=this._node,this._meshInstance=null,t.addChild(this._model.graph),this._model._entity=t,this._updateAabbFunc=this._updateAabb.bind(this),this._addedModel=!1,this._autoPlayClip=null,this._clips={},this._defaultClip=new Ht(this,{name:this.entity.name,fps:0,loop:!1,spriteAsset:null}),this._currentClip=this._defaultClip}set type(e){this._type!==e&&(this._type=e,this._type===Ur?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):this._type===wf&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}get type(){return this._type}set frame(e){this._currentClip.frame=e}get frame(){return this._currentClip.frame}set spriteAsset(e){this._defaultClip.spriteAsset=e}get spriteAsset(){return this._defaultClip._spriteAsset}set sprite(e){this._currentClip.sprite=e}get sprite(){return this._currentClip.sprite}set material(e){this._material=e,this._meshInstance&&(this._meshInstance.material=e)}get material(){return this._material}set color(e){this._color.r=e.r,this._color.g=e.g,this._color.b=e.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(bx,this._colorUniform))}get color(){return this._color}set opacity(e){this._color.a=e,this._meshInstance&&this._meshInstance.setParameter(Tx,e)}get opacity(){return this._color.a}set clips(e){if(!e){for(const t in this._clips)this.removeClip(t);return}for(const t in this._clips){let s=!1;for(const i in e)if(e[i].name===t){s=!0,this._clips[t].fps=e[i].fps,this._clips[t].loop=e[i].loop,e[i].hasOwnProperty("sprite")?this._clips[t].sprite=e[i].sprite:e[i].hasOwnProperty("spriteAsset")&&(this._clips[t].spriteAsset=e[i].spriteAsset);break}s||this.removeClip(t)}for(const t in e)this._clips[e[t].name]||this.addClip(e[t]);this._autoPlayClip&&this._tryAutoPlay(),(!this._currentClip||!this._currentClip.sprite)&&this._hideModel()}get clips(){return this._clips}get currentClip(){return this._currentClip}set speed(e){this._speed=e}get speed(){return this._speed}set flipX(e){this._flipX!==e&&(this._flipX=e,this._updateTransform())}get flipX(){return this._flipX}set flipY(e){this._flipY!==e&&(this._flipY=e,this._updateTransform())}get flipY(){return this._flipY}set width(e){e!==this._width&&(this._width=e,this._outerScale.x=this._width,this.sprite&&(this.sprite.renderMode===mt||this.sprite.renderMode===wt)&&this._updateTransform())}get width(){return this._width}set height(e){e!==this._height&&(this._height=e,this._outerScale.y=this.height,this.sprite&&(this.sprite.renderMode===mt||this.sprite.renderMode===wt)&&this._updateTransform())}get height(){return this._height}set batchGroupId(e){if(this._batchGroupId===e)return;const t=this._batchGroupId;if(this._batchGroupId=e,this.entity.enabled&&t>=0){var s;(s=this.system.app.batcher)==null||s.remove(_t.SPRITE,t,this.entity)}if(this.entity.enabled&&e>=0){var i;(i=this.system.app.batcher)==null||i.insert(_t.SPRITE,e,this.entity)}else t>=0&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}get batchGroupId(){return this._batchGroupId}set autoPlayClip(e){this._autoPlayClip=e instanceof Ht?e.name:e,this._tryAutoPlay()}get autoPlayClip(){return this._autoPlayClip}set drawOrder(e){this._drawOrder=e,this._meshInstance&&(this._meshInstance.drawOrder=e)}get drawOrder(){return this._drawOrder}set layers(e){this._addedModel&&this._hideModel(),this._layers=e,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}get layers(){return this._layers}get aabb(){return this._meshInstance?this._meshInstance.aabb:null}onEnable(){const e=this.system.app,t=e.scene;if(t.on("set:layers",this._onLayersChanged,this),t.layers&&(t.layers.on("add",this._onLayerAdded,this),t.layers.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),this._batchGroupId>=0){var s;(s=e.batcher)==null||s.insert(_t.SPRITE,this._batchGroupId,this.entity)}}onDisable(){const e=this.system.app,t=e.scene;if(t.off("set:layers",this._onLayersChanged,this),t.layers&&(t.layers.off("add",this._onLayerAdded,this),t.layers.off("remove",this._onLayerRemoved,this)),this.stop(),this._hideModel(),this._batchGroupId>=0){var s;(s=e.batcher)==null||s.remove(_t.SPRITE,this._batchGroupId,this.entity)}}onDestroy(){var e;this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null);for(const t in this._clips)this._clips[t]._destroy();this._clips=null,this._hideModel(),this._model=null,(e=this._node)==null||e.remove(),this._node=null,this._meshInstance&&(this._meshInstance.material=null,this._meshInstance.mesh=null,this._meshInstance=null)}_showModel(){if(this._addedModel||!this._meshInstance)return;const e=[this._meshInstance];for(let t=0,s=this._layers.length;t<s;t++){const i=this.system.app.scene.layers.getLayerById(this._layers[t]);i&&i.addMeshInstances(e)}this._addedModel=!0}_hideModel(){if(!this._addedModel||!this._meshInstance)return;const e=[this._meshInstance];for(let t=0,s=this._layers.length;t<s;t++){const i=this.system.app.scene.layers.getLayerById(this._layers[t]);i&&i.removeMeshInstances(e)}this._addedModel=!1}_showFrame(e){if(!this.sprite)return;const t=this.sprite.meshes[e];if(!t){this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1);return}let s;if(this.sprite.renderMode===wt?s=this.system.default9SlicedMaterialSlicedMode:this.sprite.renderMode===mt?s=this.system.default9SlicedMaterialTiledMode:s=this.system.defaultMaterial,this._meshInstance||(this._meshInstance=new Fe(t,this._material,this._node),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(bx,this._colorUniform),this._meshInstance.setParameter(Tx,this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==s&&(this._meshInstance.material=s),this._meshInstance.mesh!==t&&(this._meshInstance.mesh=t,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter(xx,this.sprite.atlas.texture),this._meshInstance.setParameter(wx,this.sprite.atlas.texture)):(this._meshInstance.deleteParameter(xx),this._meshInstance.deleteParameter(wx)),this.sprite.atlas&&(this.sprite.renderMode===wt||this.sprite.renderMode===mt)){this._meshInstance._updateAabbFunc=this._updateAabbFunc;const i=this.sprite.atlas.frames[this.sprite.frameKeys[e]];if(i){const n=2/i.rect.z,a=2/i.rect.w;this._innerOffset.set(i.border.x*n,i.border.y*a,i.border.z*n,i.border.w*a);const o=this.sprite.atlas.texture;this._atlasRect.set(i.rect.x/o.width,i.rect.y/o.height,i.rect.z/o.width,i.rect.w/o.height)}else this._innerOffset.set(0,0,0,0);this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter(aU,this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter(lU,this._atlasRectUniform)}else this._meshInstance._updateAabbFunc=null;this._updateTransform()}_updateTransform(){let e=this.flipX?-1:1,t=this.flipY?-1:1,s=0,i=0;if(this.sprite&&(this.sprite.renderMode===wt||this.sprite.renderMode===mt)){let n=1,a=1;if(this.sprite.atlas){const c=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];c&&(n=c.rect.z,a=c.rect.w,s=(.5-c.pivot.x)*this._width,i=(.5-c.pivot.y)*this._height)}const o=n/this.sprite.pixelsPerUnit,l=a/this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*o),Math.max(this._height,this._innerOffset.y*l)),e*=o,t*=l,this._outerScale.x/=o,this._outerScale.y/=l,e*=H.clamp(this._width/(this._innerOffset.x*o),1e-4,1),t*=H.clamp(this._height/(this._innerOffset.y*l),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter(oU,this._outerScaleUniform))}this._node.setLocalScale(e,t,1),this._node.setLocalPosition(s,i,0)}_updateAabb(e){return e.center.set(0,0,0),e.halfExtents.set(this._outerScale.x*.5,this._outerScale.y*.5,.001),e.setFromTransformedAabb(e,this._node.getWorldTransform()),e}_tryAutoPlay(){if(!this._autoPlayClip||this.type!==wf)return;const e=this._clips[this._autoPlayClip];e&&!e.isPlaying&&(!this._currentClip||!this._currentClip.isPlaying)&&this.enabled&&this.entity.enabled&&this.play(e.name)}_onLayersChanged(e,t){e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel()}_onLayerAdded(e){this.layers.indexOf(e.id)<0||this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&e.addMeshInstances([this._meshInstance])}_onLayerRemoved(e){!this._meshInstance||this.layers.indexOf(e.id)<0||e.removeMeshInstances([this._meshInstance])}removeModelFromLayers(){for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this._meshInstance])}}addClip(e){const t=new Ht(this,{name:e.name,fps:e.fps,loop:e.loop,spriteAsset:e.spriteAsset});return this._clips[e.name]=t,t.name&&t.name===this._autoPlayClip&&this._tryAutoPlay(),t}removeClip(e){delete this._clips[e]}clip(e){return this._clips[e]}play(e){const t=this._clips[e],s=this._currentClip;return s&&s!==t&&(s._playing=!1),this._currentClip=t,this._currentClip&&(this._currentClip=t,this._currentClip.play()),t}pause(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()}resume(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()}stop(){this._currentClip!==this._defaultClip&&this._currentClip.stop()}}Xr.EVENT_PLAY="play";Xr.EVENT_PAUSE="pause";Xr.EVENT_RESUME="resume";Xr.EVENT_STOP="stop";Xr.EVENT_END="end";Xr.EVENT_LOOP="loop";class hU{constructor(){this.enabled=!0}}const UT=["enabled"];class cU extends tt{constructor(e){super(e),this.id="sprite",this.ComponentType=Xr,this.DataType=hU,this.schema=UT,this._defaultTexture=null,this._defaultMaterial=null,this._default9SlicedMaterialSlicedMode=null,this._default9SlicedMaterialTiledMode=null,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}set defaultMaterial(e){this._defaultMaterial=e}get defaultMaterial(){if(!this._defaultMaterial){const e=new _e(this.app.graphicsDevice,{width:1,height:1,format:xe,name:"sprite"}),t=new Uint8Array(e.lock());t[0]=t[1]=t[2]=t[3]=255,e.unlock();const s=new Gs;s.diffuse.set(0,0,0),s.emissive.set(.5,.5,.5),s.emissiveMap=e,s.emissiveTint=!0,s.opacityMap=e,s.opacityMapChannel="a",s.opacityTint=!0,s.opacity=0,s.useLighting=!1,s.useGammaTonemap=!1,s.useFog=!1,s.useSkybox=!1,s.blendType=qa,s.depthWrite=!1,s.pixelSnap=!1,s.cull=Et,s.update(),this._defaultTexture=e,this._defaultMaterial=s}return this._defaultMaterial}set default9SlicedMaterialSlicedMode(e){this._default9SlicedMaterialSlicedMode=e}get default9SlicedMaterialSlicedMode(){if(!this._default9SlicedMaterialSlicedMode){const e=this.defaultMaterial.clone();e.nineSlicedMode=wt,e.update(),this._default9SlicedMaterialSlicedMode=e}return this._default9SlicedMaterialSlicedMode}set default9SlicedMaterialTiledMode(e){this._default9SlicedMaterialTiledMode=e}get default9SlicedMaterialTiledMode(){if(!this._default9SlicedMaterialTiledMode){const e=this.defaultMaterial.clone();e.nineSlicedMode=mt,e.update(),this._default9SlicedMaterialTiledMode=e}return this._default9SlicedMaterialTiledMode}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null)}initializeComponentData(e,t,s){if(t.enabled!==void 0&&(e.enabled=t.enabled),e.type=t.type,t.layers&&Array.isArray(t.layers)&&(e.layers=t.layers.slice(0)),t.drawOrder!==void 0&&(e.drawOrder=t.drawOrder),t.color!==void 0){if(t.color instanceof k){var i;e.color.set(t.color.r,t.color.g,t.color.b,(i=t.opacity)!=null?i:1)}else{var n;e.color.set(t.color[0],t.color[1],t.color[2],(n=t.opacity)!=null?n:1)}e.color=e.color}if(t.opacity!==void 0&&(e.opacity=t.opacity),t.flipX!==void 0&&(e.flipX=t.flipX),t.flipY!==void 0&&(e.flipY=t.flipY),t.width!==void 0&&(e.width=t.width),t.height!==void 0&&(e.height=t.height),t.spriteAsset!==void 0&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),t.frame!==void 0&&(e.frame=t.frame),t.clips)for(const a in t.clips)e.addClip(t.clips[a]);t.speed!==void 0&&(e.speed=t.speed),t.autoPlayClip&&(e.autoPlayClip=t.autoPlayClip),e.batchGroupId=t.batchGroupId===void 0||t.batchGroupId===null?-1:t.batchGroupId,super.initializeComponentData(e,t,s)}cloneComponent(e,t){const s=e.sprite;return this.addComponent(t,{enabled:s.enabled,type:s.type,spriteAsset:s.spriteAsset,sprite:s.sprite,width:s.width,height:s.height,frame:s.frame,color:s.color.clone(),opacity:s.opacity,flipX:s.flipX,flipY:s.flipY,speed:s.speed,clips:s.clips,autoPlayClip:s.autoPlayClip,batchGroupId:s.batchGroupId,drawOrder:s.drawOrder,layers:s.layers.slice(0)})}onUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s];if(i.data.enabled&&i.entity.enabled){const n=i.entity.sprite;n._currentClip&&n._currentClip._update(e)}}}onBeforeRemove(e,t){t.onDestroy()}}ge._buildAccessors(Xr.prototype,UT);class nh extends ge{constructor(e,t){super(e,t),this._oldState=!0,this._size=new y,this.on("set_enabled",this._onSetEnabled,this)}set size(e){e instanceof y?this._size.copy(e):e instanceof Array&&e.length>=3&&this.size.set(e[0],e[1],e[2])}get size(){return this._size}onEnable(){this._checkState()}onDisable(){this._checkState()}_onSetEnabled(e,t,s){this._checkState()}_checkState(){const e=this.enabled&&this.entity.enabled;e!==this._oldState&&(this._oldState=e,this.fire("enable"),this.fire("state",this.enabled))}_onBeforeRemove(){this.fire("remove")}}nh.EVENT_ENABLE="enable";nh.EVENT_DISABLE="disable";nh.EVENT_STATE="state";nh.EVENT_REMOVE="remove";class dU{constructor(){this.enabled=!0}}const zT=["enabled"];class uU extends tt{constructor(e){super(e),this.id="zone",this.ComponentType=nh,this.DataType=dU,this.schema=zT,this.on("beforeremove",this._onBeforeRemove,this)}initializeComponentData(e,t,s){e.enabled=t.hasOwnProperty("enabled")?!!t.enabled:!0,t.size&&(t.size instanceof y?e.size.copy(t.size):t.size instanceof Array&&t.size.length>=3&&e.size.set(t.size[0],t.size[1],t.size[2]))}cloneComponent(e,t){const s={size:e.zone.size};return this.addComponent(t,s)}_onBeforeRemove(e,t){t._onBeforeRemove()}}ge._buildAccessors(nh.prototype,zT);class fU{constructor(e,t){this.effect=e,this.inputTarget=t,this.outputTarget=null,this.name=e.constructor.name}}class pU{constructor(e,t){this.app=e,this.camera=t,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,t.on("set:rect",this.onCameraRectChanged,this)}_allocateColorBuffer(e,t){var s,i;const n=this.camera.rect,a=this.destinationRenderTarget,o=this.app.graphicsDevice,l=Math.floor(n.z*((s=a==null?void 0:a.width)!=null?s:o.width)),c=Math.floor(n.w*((i=a==null?void 0:a.height)!=null?i:o.height));return new _e(o,{name:t,format:e,width:l,height:c,mipmaps:!1,minFilter:Ee,magFilter:Ee,addressU:ae,addressV:ae})}_createOffscreenTarget(e,t){const s=this.app.graphicsDevice,i=t&&s.getRenderableHdrFormat([yt,rt],!0)||xe,n=this.camera.entity.name+"-posteffect-"+this.effects.length,a=this._allocateColorBuffer(i,n);return new Ct({colorBuffer:a,depth:e,stencil:e&&this.app.graphicsDevice.supportsStencil,samples:e?s.samples:1})}_resizeOffscreenTarget(e){const t=e.colorBuffer.format,s=e.colorBuffer.name;e.destroyFrameBuffers(),e.destroyTextureBuffers(),e._colorBuffer=this._allocateColorBuffer(t,s),e._colorBuffers=[e._colorBuffer]}_destroyOffscreenTarget(e){e.destroyTextureBuffers(),e.destroy()}addEffect(e){const t=this.effects,s=t.length===0,i=this._createOffscreenTarget(s,e.hdr),n=new fU(e,i);t.push(n),this._sourceTarget=n.inputTarget,t.length>1&&(t[t.length-2].outputTarget=n.inputTarget),this._newPostEffect=e,e.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0}removeEffect(e){let t=-1;for(let s=0,i=this.effects.length;s<i;s++)if(this.effects[s].effect===e){t=s;break}t>=0&&(t>0?this.effects[t-1].outputTarget=t+1<this.effects.length?this.effects[t+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[t].inputTarget),this.effects.splice(t,1)),this.enabled&&e.needsDepthBuffer&&this._releaseDepthMap(),this.effects.length===0&&this.disable()}_requestDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++){const s=this.effects[e].effect;this._newPostEffect!==s&&s.needsDepthBuffer&&this._requestDepthMap()}}_releaseDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++)this.effects[e].effect.needsDepthBuffer&&this._releaseDepthMap()}_requestDepthMap(){const e=this.app.scene.layers.getLayerById(_s);e&&(e.incrementCounter(),this.camera.requestSceneDepthMap(!0))}_releaseDepthMap(){const e=this.app.scene.layers.getLayerById(_s);e&&(e.decrementCounter(),this.camera.requestSceneDepthMap(!1))}destroy(){for(let e=0,t=this.effects.length;e<t;e++)this.effects[e].inputTarget.destroy();this.effects.length=0,this.disable()}enable(){!this.enabled&&this.effects.length&&(this.enabled=!0,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){let e=null;const t=this.effects.length;if(t)for(let s=0;s<t;s++){const i=this.effects[s];let n=i.outputTarget;s===t-1&&(e=this.camera.rect,this.destinationRenderTarget&&(n=this.destinationRenderTarget)),i.effect.render(i.inputTarget,n,e)}}})}disable(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=null,this.camera.onPostprocessing=null)}_onCanvasResized(e,t){var s,i;const n=this.camera.rect,a=this.destinationRenderTarget;e=(s=a==null?void 0:a.width)!=null?s:e,t=(i=a==null?void 0:a.height)!=null?i:t,this.camera.camera.aspectRatio=e*n.z/(t*n.w),this.resizeRenderTargets()}resizeRenderTargets(){var e,t;const s=this.app.graphicsDevice,i=this.destinationRenderTarget,n=(e=i==null?void 0:i.width)!=null?e:s.width,a=(t=i==null?void 0:i.height)!=null?t:s.height,o=this.camera.rect,l=Math.floor(o.z*n),c=Math.floor(o.w*a),d=this.effects;for(let h=0,u=d.length;h<u;h++){const f=d[h];(f.inputTarget.width!==l||f.inputTarget.height!==c)&&this._resizeOffscreenTarget(f.inputTarget)}}onCameraRectChanged(e,t,s){this.enabled&&this.resizeRenderTargets()}}class _0 extends ge{constructor(e,t){super(e,t),this.onPostprocessing=null,this.onPreRender=null,this.onPostRender=null,this._renderSceneDepthMap=0,this._renderSceneColorMap=0,this._sceneDepthMapRequested=!1,this._sceneColorMapRequested=!1,this._priority=0,this._disablePostEffectsLayer=Kp,this._camera=new Ed,this._camera.node=t,this._postEffects=new pU(e.app,this)}setShaderPass(e){const t=Ii.get(this.system.app.graphicsDevice),s=e?t.allocate(e,{isForward:!0}):null;return this._camera.shaderPassInfo=s,s.index}getShaderPass(){var e;return(e=this._camera.shaderPassInfo)==null?void 0:e.name}set renderPasses(e){this._camera.renderPasses=e}get renderPasses(){return this._camera.renderPasses}set aperture(e){this._camera.aperture=e}get aperture(){return this._camera.aperture}set aspectRatio(e){this._camera.aspectRatio=e}get aspectRatio(){return this._camera.aspectRatio}set aspectRatioMode(e){this._camera.aspectRatioMode=e}get aspectRatioMode(){return this._camera.aspectRatioMode}set calculateProjection(e){this._camera.calculateProjection=e}get calculateProjection(){return this._camera.calculateProjection}set calculateTransform(e){this._camera.calculateTransform=e}get calculateTransform(){return this._camera.calculateTransform}get camera(){return this._camera}set clearColor(e){this._camera.clearColor=e}get clearColor(){return this._camera.clearColor}set clearColorBuffer(e){this._camera.clearColorBuffer=e,this.dirtyLayerCompositionCameras()}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearDepthBuffer(e){this._camera.clearDepthBuffer=e,this.dirtyLayerCompositionCameras()}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearStencilBuffer(e){this._camera.clearStencilBuffer=e,this.dirtyLayerCompositionCameras()}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set cullFaces(e){this._camera.cullFaces=e}get cullFaces(){return this._camera.cullFaces}set disablePostEffectsLayer(e){this._disablePostEffectsLayer=e,this.dirtyLayerCompositionCameras()}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}set farClip(e){this._camera.farClip=e}get farClip(){return this._camera.farClip}set flipFaces(e){this._camera.flipFaces=e}get flipFaces(){return this._camera.flipFaces}set fov(e){this._camera.fov=e}get fov(){return this._camera.fov}get frustum(){return this._camera.frustum}set frustumCulling(e){this._camera.frustumCulling=e}get frustumCulling(){return this._camera.frustumCulling}set horizontalFov(e){this._camera.horizontalFov=e}get horizontalFov(){return this._camera.horizontalFov}set layers(e){const t=this._camera.layers;for(let s=0;s<t.length;s++){const i=this.system.app.scene.layers.getLayerById(t[s]);i&&i.removeCamera(this)}if(this._camera.layers=e,!(!this.enabled||!this.entity.enabled))for(let s=0;s<e.length;s++){const i=this.system.app.scene.layers.getLayerById(e[s]);i&&i.addCamera(this)}}get layers(){return this._camera.layers}get layersSet(){return this._camera.layersSet}set jitter(e){this._camera.jitter=e}get jitter(){return this._camera.jitter}set nearClip(e){this._camera.nearClip=e}get nearClip(){return this._camera.nearClip}set orthoHeight(e){this._camera.orthoHeight=e}get orthoHeight(){return this._camera.orthoHeight}get postEffects(){return this._postEffects}get postEffectsEnabled(){return this._postEffects.enabled}set priority(e){this._priority=e,this.dirtyLayerCompositionCameras()}get priority(){return this._priority}set projection(e){this._camera.projection=e}get projection(){return this._camera.projection}get projectionMatrix(){return this._camera.projectionMatrix}set rect(e){this._camera.rect=e,this.fire("set:rect",this._camera.rect)}get rect(){return this._camera.rect}set renderSceneColorMap(e){e&&!this._sceneColorMapRequested?(this.requestSceneColorMap(!0),this._sceneColorMapRequested=!0):this._sceneColorMapRequested&&(this.requestSceneColorMap(!1),this._sceneColorMapRequested=!1)}get renderSceneColorMap(){return this._renderSceneColorMap>0}set renderSceneDepthMap(e){e&&!this._sceneDepthMapRequested?(this.requestSceneDepthMap(!0),this._sceneDepthMapRequested=!0):this._sceneDepthMapRequested&&(this.requestSceneDepthMap(!1),this._sceneDepthMapRequested=!1)}get renderSceneDepthMap(){return this._renderSceneDepthMap>0}set renderTarget(e){this._camera.renderTarget=e,this.dirtyLayerCompositionCameras()}get renderTarget(){return this._camera.renderTarget}set scissorRect(e){this._camera.scissorRect=e}get scissorRect(){return this._camera.scissorRect}set sensitivity(e){this._camera.sensitivity=e}get sensitivity(){return this._camera.sensitivity}set shutter(e){this._camera.shutter=e}get shutter(){return this._camera.shutter}get viewMatrix(){return this._camera.viewMatrix}_enableDepthLayer(e){if(this.layers.find(s=>s===_s)){const s=this.system.app.scene.layers.getLayerById(_s);e?s==null||s.incrementCounter():s==null||s.decrementCounter()}else if(e)return!1;return!0}requestSceneColorMap(e){this._renderSceneColorMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassColorGrab(this.system.app.graphicsDevice,this.renderSceneColorMap)}requestSceneDepthMap(e){this._renderSceneDepthMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassDepthGrab(this.system.app.graphicsDevice,this.system.app.renderer,this.renderSceneDepthMap)}dirtyLayerCompositionCameras(){const e=this.system.app.scene.layers;e._dirty=!0}screenToWorld(e,t,s,i){const n=this.system.app.graphicsDevice,a=n.clientRect.width,o=n.clientRect.height;return this._camera.screenToWorld(e,t,s,a,o,i)}worldToScreen(e,t){const s=this.system.app.graphicsDevice,i=s.clientRect.width,n=s.clientRect.height;return this._camera.worldToScreen(e,i,n,t)}onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0}addCameraToLayers(){const e=this.layers;for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.addCamera(this)}}removeCameraFromLayers(){const e=this.layers;for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeCamera(this)}}onLayersChanged(e,t){this.addCameraToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addCamera(this)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeCamera(this)}onEnable(){const e=this.system,t=e.app.scene,s=t.layers;e.addCamera(this),t.on("set:layers",this.onLayersChanged,this),s&&(s.on("add",this.onLayerAdded,this),s.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()}onDisable(){const e=this.system,t=e.app.scene,s=t.layers;this.postEffects.disable(),this.removeCameraFromLayers(),t.off("set:layers",this.onLayersChanged,this),s&&(s.off("add",this.onLayerAdded,this),s.off("remove",this.onLayerRemoved,this)),e.removeCamera(this)}onRemove(){this.onDisable(),this.off(),this.camera.destroy()}calculateAspectRatio(e){const t=this.system.app.graphicsDevice,s=e?e.width:t.width,i=e?e.height:t.height;return s*this.rect.z/(i*this.rect.w)}frameUpdate(e){this.aspectRatioMode===qy&&(this.aspectRatio=this.calculateAspectRatio(e))}startXr(e,t,s){this.system.app.xr.start(this,e,t,s)}endXr(e){if(!this._camera.xr){e&&e(new Error("Camera is not in XR"));return}this._camera.xr.end(e)}copy(e){this.aperture=e.aperture,this.aspectRatio=e.aspectRatio,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.disablePostEffectsLayer=e.disablePostEffectsLayer,this.farClip=e.farClip,this.flipFaces=e.flipFaces,this.fov=e.fov,this.frustumCulling=e.frustumCulling,this.horizontalFov=e.horizontalFov,this.layers=e.layers,this.nearClip=e.nearClip,this.orthoHeight=e.orthoHeight,this.priority=e.priority,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.sensitivity=e.sensitivity,this.shutter=e.shutter}}class mU{constructor(){this.enabled=!0}}const VT=["enabled"];class _U extends tt{constructor(e){super(e),this.cameras=[],this.id="camera",this.ComponentType=_0,this.DataType=mU,this.schema=VT,this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onAppPrerender,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){s=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","renderSceneColorMap","renderSceneDepthMap","cullFaces","farClip","flipFaces","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect","aperture","shutter","sensitivity"];for(let i=0;i<s.length;i++){const n=s[i];if(t.hasOwnProperty(n)){const a=t[n];switch(n){case"rect":case"scissorRect":Array.isArray(a)?e[n]=new P(a[0],a[1],a[2],a[3]):e[n]=a;break;case"clearColor":Array.isArray(a)?e[n]=new k(a[0],a[1],a[2],a[3]):e[n]=a;break;default:e[n]=a;break}}}super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s=e.camera;return this.addComponent(t,{aspectRatio:s.aspectRatio,aspectRatioMode:s.aspectRatioMode,calculateProjection:s.calculateProjection,calculateTransform:s.calculateTransform,clearColor:s.clearColor,clearColorBuffer:s.clearColorBuffer,clearDepthBuffer:s.clearDepthBuffer,clearStencilBuffer:s.clearStencilBuffer,renderSceneDepthMap:s.renderSceneDepthMap,renderSceneColorMap:s.renderSceneColorMap,cullFaces:s.cullFaces,enabled:s.enabled,farClip:s.farClip,flipFaces:s.flipFaces,fov:s.fov,frustumCulling:s.frustumCulling,horizontalFov:s.horizontalFov,layers:s.layers,renderTarget:s.renderTarget,nearClip:s.nearClip,orthoHeight:s.orthoHeight,projection:s.projection,priority:s.priority,rect:s.rect,scissorRect:s.scissorRect,aperture:s.aperture,sensitivity:s.sensitivity,shutter:s.shutter})}onBeforeRemove(e,t){this.removeCamera(t),t.onRemove()}onUpdate(e){}onAppPrerender(){for(let e=0,t=this.cameras.length;e<t;e++)this.cameras[e].onAppPrerender()}addCamera(e){this.cameras.push(e),Fc(this.cameras)}removeCamera(e){const t=this.cameras.indexOf(e);t>=0&&(this.cameras.splice(t,1),Fc(this.cameras))}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}ge._buildAccessors(_0.prototype,VT);const eo=[],g0=[];class y0 extends ge{constructor(e,t){super(e,t),this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}addLightToLayers(){for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addLight(this),this.light.addLayer(t))}}removeLightFromLayers(){for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.removeLight(this),this.light.removeLayer(t))}}onLayersChanged(e,t){this.enabled&&this.entity.enabled&&this.addLightToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)>=0&&this.enabled&&this.entity.enabled&&(e.addLight(this),this.light.addLayer(e))}onLayerRemoved(e){this.layers.indexOf(e.id)>=0&&(e.removeLight(this),this.light.removeLayer(e))}refreshProperties(){for(let e=0;e<eo.length;e++){const t=eo[e];this[t]=this[t]}this.enabled&&this.entity.enabled&&this.onEnable()}onCookieAssetSet(){let e=!1;this._cookieAsset.type==="cubemap"&&!this._cookieAsset.loadFaces&&(this._cookieAsset.loadFaces=!0,e=!0),(!this._cookieAsset.resource||e)&&this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()}onCookieAssetAdd(e){this._cookieAssetId===e.id&&(this._cookieAsset=e,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))}onCookieAssetLoad(){!this._cookieAsset||!this._cookieAsset.resource||(this.cookie=this._cookieAsset.resource)}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)}onEnable(){this.light.enabled=!0,this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()}onDisable(){this.light.enabled=!1,this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.removeLightFromLayers()}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null}set shadowUpdateOverrides(e){this.light.shadowUpdateOverrides=e}get shadowUpdateOverrides(){return this.light.shadowUpdateOverrides}set penumbraSize(e){this.light.penumbraSize=e}get penumbraSize(){return this.light.penumbraSize}}function we(r,e,t,s){const i=y0.prototype;eo.push(r),g0.push(e),Object.defineProperty(i,r,{get:function(){return this.data[r]},set:function(n){const a=this.data,o=a[r];!s&&o===n||(a[r]=n,t&&t.call(this,n,o))},configurable:!0})}function gU(){we("enabled",!0,function(r,e){this.onSetEnabled(null,e,r)}),we("light",null),we("type","directional",function(r,e){this.system.changeType(this,e,r),this.refreshProperties()}),we("color",new k(1,1,1),function(r,e){this.light.setColor(r)},!0),we("intensity",1,function(r,e){this.light.intensity=r}),we("luminance",0,function(r,e){this.light.luminance=r}),we("shape",Ut,function(r,e){this.light.shape=r}),we("affectSpecularity",!0,function(r,e){this.light.affectSpecularity=r}),we("castShadows",!1,function(r,e){this.light.castShadows=r}),we("shadowDistance",40,function(r,e){this.light.shadowDistance=r}),we("shadowIntensity",1,function(r,e){this.light.shadowIntensity=r}),we("shadowResolution",1024,function(r,e){this.light.shadowResolution=r}),we("shadowBias",.05,function(r,e){this.light.shadowBias=-.01*H.clamp(r,0,1)}),we("numCascades",1,function(r,e){this.light.numCascades=H.clamp(Math.floor(r),1,4)}),we("bakeNumSamples",1,function(r,e){this.light.bakeNumSamples=H.clamp(Math.floor(r),1,255)}),we("bakeArea",0,function(r,e){this.light.bakeArea=H.clamp(r,0,180)}),we("cascadeDistribution",.5,function(r,e){this.light.cascadeDistribution=H.clamp(r,0,1)}),we("normalOffsetBias",0,function(r,e){this.light.normalOffsetBias=H.clamp(r,0,1)}),we("range",10,function(r,e){this.light.attenuationEnd=r}),we("innerConeAngle",40,function(r,e){this.light.innerConeAngle=r}),we("outerConeAngle",45,function(r,e){this.light.outerConeAngle=r}),we("falloffMode",Vy,function(r,e){this.light.falloffMode=r}),we("shadowType",xt,function(r,e){this.light.shadowType=r}),we("vsmBlurSize",11,function(r,e){this.light.vsmBlurSize=r}),we("vsmBlurMode",Gy,function(r,e){this.light.vsmBlurMode=r}),we("vsmBias",.01*.25,function(r,e){this.light.vsmBias=H.clamp(r,0,1)}),we("cookieAsset",null,function(r,e){if(!(this._cookieAssetId&&(r instanceof ne&&r.id===this._cookieAssetId||r===this._cookieAssetId))){if(this.onCookieAssetRemove(),this._cookieAssetId=null,r instanceof ne)this.data.cookieAsset=r.id,this._cookieAssetId=r.id,this.onCookieAssetAdd(r);else if(typeof r=="number"){this._cookieAssetId=r;const t=this.system.app.assets.get(r);t?this.onCookieAssetAdd(t):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}}}),we("cookie",null,function(r,e){this.light.cookie=r}),we("cookieIntensity",1,function(r,e){this.light.cookieIntensity=H.clamp(r,0,1)}),we("cookieFalloff",!0,function(r,e){this.light.cookieFalloff=r}),we("cookieChannel","rgb",function(r,e){this.light.cookieChannel=r}),we("cookieAngle",0,function(r,e){if(r!==0||this.cookieScale!==null){this._cookieMatrix||(this._cookieMatrix=new P);let t=1,s=1;this.cookieScale&&(t=this.cookieScale.x,s=this.cookieScale.y);const i=Math.cos(r*H.DEG_TO_RAD),n=Math.sin(r*H.DEG_TO_RAD);this._cookieMatrix.set(i/t,-n/t,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),we("cookieScale",null,function(r,e){if(r!==null||this.cookieAngle!==0){this._cookieMatrix||(this._cookieMatrix=new P);const t=r.x,s=r.y,i=Math.cos(this.cookieAngle*H.DEG_TO_RAD),n=Math.sin(this.cookieAngle*H.DEG_TO_RAD);this._cookieMatrix.set(i/t,-n/t,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null},!0),we("cookieOffset",null,function(r,e){this.light.cookieOffset=r},!0),we("shadowUpdateMode",Xy,function(r,e){this.light.shadowUpdateMode=r},!0),we("mask",1,function(r,e){this.light.mask=r}),we("affectDynamic",!0,function(r,e){r?this.light.mask|=Fs:this.light.mask&=~Fs,this.light.layersDirty()}),we("affectLightmapped",!1,function(r,e){r?(this.light.mask|=ji,this.bake&&(this.light.mask&=~$i)):(this.light.mask&=~ji,this.bake&&(this.light.mask|=$i))}),we("bake",!1,function(r,e){r?(this.light.mask|=$i,this.affectLightmapped&&(this.light.mask&=~ji)):(this.light.mask&=~$i,this.affectLightmapped&&(this.light.mask|=ji)),this.light.layersDirty()}),we("bakeDir",!0,function(r,e){this.light.bakeDir=r}),we("isStatic",!1,function(r,e){this.light.isStatic=r}),we("layers",[Ws],function(r,e){for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&(s.removeLight(this),this.light.removeLayer(s))}for(let t=0;t<r.length;t++){const s=this.system.app.scene.layers.getLayerById(r[t]);s&&this.enabled&&this.entity.enabled&&(s.addLight(this),this.light.addLayer(s))}}),eo.push("penumbraSize"),g0.push(1)}gU();class yU{constructor(){const e=eo,t=g0;for(let s=0;s<e.length;s++){const i=t[s];i&&i.clone?this[e[s]]=i.clone():this[e[s]]=i}}}class vU extends tt{constructor(e){super(e),this.id="light",this.ComponentType=y0,this.DataType=yU,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(e,t){const s=eo,i={};for(let a=0,o=s.length;a<o;a++){const l=s[a];i[l]=t[l]}i.type||(i.type=e.data.type),e.data.type=i.type,i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0)),i.color&&Array.isArray(i.color)&&(i.color=new k(i.color[0],i.color[1],i.color[2])),i.cookieOffset&&i.cookieOffset instanceof Array&&(i.cookieOffset=new M(i.cookieOffset[0],i.cookieOffset[1])),i.cookieScale&&i.cookieScale instanceof Array&&(i.cookieScale=new M(i.cookieScale[0],i.cookieScale[1])),i.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),i.enabled=i.enable),i.shape||(i.shape=Ut);const n=new kc(this.app.graphicsDevice,this.app.scene.clusteredLightingEnabled);n.type=ug[i.type],n._node=e.entity,e.data.light=n,super.initializeComponentData(e,i,s)}_onRemoveComponent(e,t){t.onRemove()}cloneComponent(e,t){const s=e.light,i=[];let n;const a=eo;for(let o=0;o<a.length;o++)n=a[o],n!=="light"&&(s[n]&&s[n].clone?i[n]=s[n].clone():i[n]=s[n]);return this.addComponent(t,i)}changeType(e,t,s){t!==s&&(e.light.type=ug[s])}}const SU=["x","y","z","w"],xU=[void 0,void 0,M,y,P];function bf(r,e,t,s){switch(e.type){case"boolean":return!!t;case"number":if(typeof t=="number")return t;if(typeof t=="string"){const i=parseInt(t,10);return isNaN(i)?null:i}else if(typeof t=="boolean")return 0+t;return null;case"json":{const i={};if(Array.isArray(e.schema)){(!t||typeof t!="object")&&(t={});for(let n=0;n<e.schema.length;n++){const a=e.schema[n];if(a.name)if(a.array){i[a.name]=[];const o=Array.isArray(t[a.name])?t[a.name]:[];for(let l=0;l<o.length;l++)i[a.name].push(bf(r,a,o[l]))}else{const o=t.hasOwnProperty(a.name)?t[a.name]:a.default;i[a.name]=bf(r,a,o)}}}return i}case"asset":return t instanceof ne?t:typeof t=="number"?r.assets.get(t)||null:typeof t=="string"&&r.assets.get(parseInt(t,10))||null;case"entity":return t instanceof ze?t:typeof t=="string"?r.getEntityFromIndex(t):null;case"rgb":case"rgba":if(t instanceof k)return s instanceof k?(s.copy(t),s):t.clone();if(t instanceof Array&&t.length>=3&&t.length<=4){for(let i=0;i<t.length;i++)if(typeof t[i]!="number")return null;return s||(s=new k),s.r=t[0],s.g=t[1],s.b=t[2],s.a=t.length===3?1:t[3],s}else if(typeof t=="string"&&/#([0-9abcdef]{2}){3,4}/i.test(t))return s||(s=new k),s.fromString(t),s;return null;case"vec2":case"vec3":case"vec4":{const i=parseInt(e.type.slice(3),10),n=xU[i];if(t instanceof n)return s instanceof n?(s.copy(t),s):t.clone();if(t instanceof Array&&t.length===i){for(let a=0;a<t.length;a++)if(typeof t[a]!="number")return null;s||(s=new n);for(let a=0;a<i;a++)s[SU[a]]=t[a];return s}return null}case"curve":if(t){let i;if(t instanceof dt||t instanceof St)i=t.clone();else{const n=t.keys[0]instanceof Array?St:dt;i=new n(t.keys),i.type=t.type}return i}break}return t}class qr{constructor(e){this.scriptType=e,this.index={}}add(e,t){this.index[e]||qr.reservedNames.has(e)||(this.index[e]=t,Object.defineProperty(this.scriptType.prototype,e,{get:function(){return this.__attributes[e]},set:function(s){const i="attr",n="attr:"+e,a=this.__attributes[e];let o=a;if(a&&t.type!=="json"&&t.type!=="entity"&&a.clone&&(this.hasEvent(i)||this.hasEvent(n))&&(o=a.clone()),t.array){if(this.__attributes[e]=[],s)for(let l=0,c=s.length;l<c;l++)this.__attributes[e].push(bf(this.app,t,s[l],a?a[l]:null))}else this.__attributes[e]=bf(this.app,t,s,a);this.fire(i,e,this.__attributes[e],o),this.fire(n,this.__attributes[e],o)}}))}remove(e){return this.index[e]?(delete this.index[e],delete this.scriptType.prototype[e],!0):!1}has(e){return!!this.index[e]}get(e){return this.index[e]||null}}qr.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"]);const Fg="initialize",kg="postInitialize",wU="update",bU="postUpdate",TU="swap";class Kn extends ge{constructor(e,t){super(e,t),this._scripts=[],this._updateList=new ef({sortBy:"__executionOrder"}),this._postUpdateList=new ef({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._oldState=!0,this._enabled=!0,this._beingEnabled=!1,this._isLoopingThroughScripts=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}set scripts(e){this._scriptsData=e;for(const t in e){if(!e.hasOwnProperty(t))continue;const s=this._scriptsIndex[t];if(s){if(typeof e[t].enabled=="boolean"&&(s.enabled=!!e[t].enabled),typeof e[t].attributes=="object"){for(const i in e[t].attributes)if(!qr.reservedNames.has(i)){if(!s.__attributes.hasOwnProperty(i)){const n=this.system.app.scripts.get(t);n&&n.attributes.add(i,{})}s[i]=e[t].attributes[i]}}}else console.log(this.order)}}get scripts(){return this._scripts}set enabled(e){const t=this._enabled;this._enabled=e,this.fire("set","enabled",t,e)}get enabled(){return this._enabled}onEnable(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1}onDisable(){this._checkState()}onPostStateChange(){const e=this._beginLooping();for(let t=0,s=this.scripts.length;t<s;t++){const i=this.scripts[t];i._initialized&&!i._postInitialized&&i.enabled&&(i._postInitialized=!0,i.postInitialize&&this._scriptMethod(i,kg))}this._endLooping(e)}_beginLooping(){const e=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,e}_endLooping(e){this._isLoopingThroughScripts=e,this._isLoopingThroughScripts||this._removeDestroyedScripts()}_onSetEnabled(e,t,s){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1}_checkState(){const e=this.enabled&&this.entity.enabled;if(e===this._oldState)return;this._oldState=e,this.fire(e?"enable":"disable"),this.fire("state",e),e?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);const t=this._beginLooping();for(let s=0,i=this.scripts.length;s<i;s++){const n=this.scripts[s];n.enabled=n._enabled}this._endLooping(t)}_onBeforeRemove(){this.fire("remove");const e=this._beginLooping();for(let t=0;t<this.scripts.length;t++){const s=this.scripts[t];s&&this.destroy(s.__scriptType.__name)}this._endLooping(e)}_removeDestroyedScripts(){const e=this._destroyedScripts.length;if(e){for(let t=0;t<e;t++){const s=this._destroyedScripts[t];this._removeScriptInstance(s)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}}_onInitializeAttributes(){for(let e=0,t=this.scripts.length;e<t;e++)this.scripts[e].__initializeAttributes()}_scriptMethod(e,t,s){e[t](s)}_onInitialize(){const e=this._scripts,t=this._beginLooping();for(let s=0,i=e.length;s<i;s++){const n=e[s];!n._initialized&&n.enabled&&(n._initialized=!0,n.initialize&&this._scriptMethod(n,Fg))}this._endLooping(t)}_onPostInitialize(){this.onPostStateChange()}_onUpdate(e){const t=this._updateList;if(!t.length)return;const s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const i=t.items[t.loopIndex];i.enabled&&this._scriptMethod(i,wU,e)}this._endLooping(s)}_onPostUpdate(e){const t=this._postUpdateList;if(!t.length)return;const s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const i=t.items[t.loopIndex];i.enabled&&this._scriptMethod(i,bU,e)}this._endLooping(s)}_insertScriptInstance(e,t,s){t===-1?(this._scripts.push(e),e.__executionOrder=s,e.update&&this._updateList.append(e),e.postUpdate&&this._postUpdateList.append(e)):(this._scripts.splice(t,0,e),e.__executionOrder=t,this._resetExecutionOrder(t+1,s+1),e.update&&this._updateList.insert(e),e.postUpdate&&this._postUpdateList.insert(e))}_removeScriptInstance(e){const t=this._scripts.indexOf(e);return t===-1||(this._scripts.splice(t,1),e.update&&this._updateList.remove(e),e.postUpdate&&this._postUpdateList.remove(e)),t}_resetExecutionOrder(e,t){for(let s=e;s<t;s++)this._scripts[s].__executionOrder=s}_resolveEntityScriptAttribute(e,t,s,i,n,a){if(e.array){const o=s.length;if(!o)return;const l=s.slice();for(let c=0;c<o;c++){const d=l[c]instanceof $?l[c].getGuid():l[c];a[d]&&(l[c]=i?a[d].getGuid():a[d])}n[t]=l}else{if(s instanceof $)s=s.getGuid();else if(typeof s!="string")return;a[s]&&(n[t]=a[s])}}has(e){if(typeof e=="string")return!!this._scriptsIndex[e];if(!e)return!1;const t=e,s=t.__name,i=this._scriptsIndex[s];return(i&&i.instance)instanceof t}get(e){if(typeof e=="string"){const a=this._scriptsIndex[e];return a?a.instance:null}if(!e)return null;const t=e,s=t.__name,i=this._scriptsIndex[s],n=i&&i.instance;return n instanceof t?n:null}create(e,t={}){const s=this;let i=e,n=e;if(typeof i=="string"?i=this.system.app.scripts.get(i):i&&(n=i.__name),i){if(!this._scriptsIndex[n]||!this._scriptsIndex[n].instance){const a=new i({app:this.system.app,entity:this.entity,enabled:t.hasOwnProperty("enabled")?t.enabled:!0,attributes:t.attributes}),o=this._scripts.length;let l=-1;return typeof t.ind=="number"&&t.ind!==-1&&o>t.ind&&(l=t.ind),this._insertScriptInstance(a,l,o),this._scriptsIndex[n]={instance:a,onSwap:function(){s.swap(n)}},this[n]=a,t.preloading||a.__initializeAttributes(),this.fire("create",n,a),this.fire("create:"+n,a),this.system.app.scripts.on("swap:"+n,this._scriptsIndex[n].onSwap),t.preloading||(a.enabled&&!a._initialized&&(a._initialized=!0,a.initialize&&this._scriptMethod(a,Fg)),a.enabled&&!a._postInitialized&&(a._postInitialized=!0,a.postInitialize&&this._scriptMethod(a,kg))),a}}else this._scriptsIndex[n]={awaiting:!0,ind:this._scripts.length};return null}destroy(e){let t=e,s=e;typeof s=="string"?s=this.system.app.scripts.get(s):s&&(t=s.__name);const i=this._scriptsIndex[t];if(delete this._scriptsIndex[t],!i)return!1;const n=i.instance;if(n&&!n._destroyed)if(n.enabled=!1,n._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(n);else{const a=this._removeScriptInstance(n);a>=0&&this._resetExecutionOrder(a,this._scripts.length)}return this.system.app.scripts.off("swap:"+t,i.onSwap),delete this[t],this.fire("destroy",t,n||null),this.fire("destroy:"+t,n||null),n&&n.fire("destroy"),!0}swap(e){let t=e,s=e;typeof s=="string"?s=this.system.app.scripts.get(s):s&&(t=s.__name);const i=this._scriptsIndex[t];if(!i||!i.instance)return!1;const n=i.instance,a=this._scripts.indexOf(n),o=new s({app:this.system.app,entity:this.entity,enabled:n.enabled,attributes:n.__attributes});return o.swap?(o.__initializeAttributes(),this._scripts[a]=o,this._scriptsIndex[t].instance=o,this[t]=o,o.__executionOrder=a,n.update&&this._updateList.remove(n),n.postUpdate&&this._postUpdateList.remove(n),o.update&&this._updateList.insert(o),o.postUpdate&&this._postUpdateList.insert(o),this._scriptMethod(o,TU,n),this.fire("swap",t,o),this.fire("swap:"+t,o),!0):!1}resolveDuplicatedEntityReferenceProperties(e,t){const s=this.entity.script;for(const i in e._scriptsIndex){const n=this.system.app.scripts.get(i);if(!n)continue;const a=e._scriptsIndex[i];if(!a||!a.instance)continue;const o=s[i].__attributesRaw,l=s[i].__attributes;if(!o&&!l)continue;const c=!!o,d=a.instance.__attributes;for(const h in d){if(!d[h])continue;const u=n.attributes.get(h);if(u){if(u.type==="entity")this._resolveEntityScriptAttribute(u,h,d[h],c,o||l,t);else if(u.type==="json"&&Array.isArray(u.schema)){const f=d[h],p=o?o[h]:l[h];for(let _=0;_<u.schema.length;_++){const m=u.schema[_];if(m.type==="entity")if(u.array)for(let g=0;g<f.length;g++)this._resolveEntityScriptAttribute(m,m.name,f[g][m.name],c,p[g],t);else this._resolveEntityScriptAttribute(m,m.name,f[m.name],c,p,t)}}}}}}move(e,t){const s=this._scripts.length;if(t>=s||t<0)return!1;let i=e,n=e;typeof n!="string"?n=e.__name:i=null;const a=this._scriptsIndex[n];if(!a||!a.instance)return!1;const o=a.instance;if(i&&!(o instanceof i))return!1;const l=this._scripts.indexOf(o);return l===-1||l===t?!1:(this._scripts.splice(t,0,this._scripts.splice(l,1)[0]),this._resetExecutionOrder(0,s),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",n,o,t,l),this.fire("move:"+n,o,t,l),!0)}}Kn.EVENT_CREATE="create";Kn.EVENT_DESTROY="destroy";Kn.EVENT_ENABLE="enable";Kn.EVENT_DISABLE="disable";Kn.EVENT_REMOVE="remove";Kn.EVENT_STATE="state";Kn.EVENT_MOVE="move";Kn.EVENT_ERROR="error";class EU{constructor(){this.enabled=!0}}const CU="_onInitializeAttributes",AU="_onInitialize",PU="_onPostInitialize",MU="_onUpdate",IU="_onPostUpdate";let vu=0;class RU extends tt{constructor(e){super(e),this.id="script",this.ComponentType=Kn,this.DataType=EU,this._components=new ef({sortBy:"_executionOrder"}),this._enabledComponents=new ef({sortBy:"_executionOrder"}),this.preloading=!0,this.on("beforeremove",this._onBeforeRemove,this),this.app.systems.on("initialize",this._onInitialize,this),this.app.systems.on("postInitialize",this._onPostInitialize,this),this.app.systems.on("update",this._onUpdate,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(e,t){if(e._executionOrder=vu++,this._components.append(e),vu>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),e.enabled=t.hasOwnProperty("enabled")?!!t.enabled:!0,e.enabled&&e.entity.enabled&&this._enabledComponents.append(e),t.hasOwnProperty("order")&&t.hasOwnProperty("scripts")){e._scriptsData=t.scripts;for(let s=0;s<t.order.length;s++)e.create(t.order[s],{enabled:t.scripts[t.order[s]].enabled,attributes:t.scripts[t.order[s]].attributes,preloading:this.preloading})}}cloneComponent(e,t){const s=[],i={};for(let a=0;a<e.script._scripts.length;a++){const o=e.script._scripts[a],l=o.__scriptType.__name;s.push(l);const c={};for(const d in o.__attributes)c[d]=o.__attributes[d];i[l]={enabled:o._enabled,attributes:c}}for(const a in e.script._scriptsIndex)a.awaiting&&s.splice(a.ind,0,a);const n={enabled:e.script.enabled,order:s,scripts:i};return this.addComponent(t,n)}_resetExecutionOrder(){vu=0;for(let e=0,t=this._components.length;e<t;e++)this._components.items[e]._executionOrder=vu++}_callComponentMethod(e,t,s){for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++)e.items[e.loopIndex][t](s)}_onInitialize(){this.preloading=!1,this._callComponentMethod(this._components,CU),this._callComponentMethod(this._enabledComponents,AU)}_onPostInitialize(){this._callComponentMethod(this._enabledComponents,PU)}_onUpdate(e){this._callComponentMethod(this._enabledComponents,MU,e)}_onPostUpdate(e){this._callComponentMethod(this._enabledComponents,IU,e)}_addComponentToEnabled(e){this._enabledComponents.insert(e)}_removeComponentFromEnabled(e){this._enabledComponents.remove(e)}_onBeforeRemove(e,t){this._components.items.indexOf(t)>=0&&t._onBeforeRemove(),this._removeComponentFromEnabled(t),this._components.remove(t)}destroy(){super.destroy(),this.app.systems.off("initialize",this._onInitialize,this),this.app.systems.off("postInitialize",this._onPostInitialize,this),this.app.systems.off("update",this._onUpdate,this),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}class GT extends ge{constructor(e,t){super(e,t),this._layers=[Ws],this._instance=null,this._customAabb=null,this._assetReference=void 0,this._materialOptions=null,this._assetReference=new Uc("asset",this,e.app.assets,{add:this._onGSplatAssetAdded,load:this._onGSplatAssetLoad,remove:this._onGSplatAssetRemove,unload:this._onGSplatAssetUnload},this),t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set customAabb(e){var t;this._customAabb=e,(t=this._instance)==null||t.meshInstance.setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set instance(e){if(this.destroyInstance(),this._instance=e,this._instance){const t=this._instance.meshInstance;t.node||(t.node=this.entity),t.setCustomAabb(this._customAabb),this._materialOptions&&this._instance.createMaterial(this._materialOptions),this.enabled&&this.entity.enabled&&this.addToLayers()}}get instance(){return this._instance}set materialOptions(e){this._materialOptions=Object.assign({},e),this._instance&&this._instance.createMaterial(this._materialOptions)}get materialOptions(){return this._materialOptions}get material(){var e;return(e=this._instance)==null?void 0:e.material}set layers(e){this.removeFromLayers(),this._layers.length=0;for(let t=0;t<e.length;t++)this._layers[t]=e[t];!this.enabled||!this.entity.enabled||this.addToLayers()}get layers(){return this._layers}set asset(e){const t=e instanceof ne?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onGSplatAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onGSplatAssetAdded())}get asset(){return this._assetReference.id}assignAsset(e){const t=e instanceof ne?e.id:e;this._assetReference.id=t}destroyInstance(){if(this._instance){var e;this.removeFromLayers(),(e=this._instance)==null||e.destroy(),this._instance=null}}addToLayers(){var e;const t=(e=this.instance)==null?void 0:e.meshInstance;if(t){const i=this.system.app.scene.layers;for(let n=0;n<this._layers.length;n++){var s;(s=i.getLayerById(this._layers[n]))==null||s.addMeshInstances([t])}}}removeFromLayers(){var e;const t=(e=this.instance)==null?void 0:e.meshInstance;if(t){const i=this.system.app.scene.layers;for(let n=0;n<this._layers.length;n++){var s;(s=i.getLayerById(this._layers[n]))==null||s.removeMeshInstances([t])}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._instance&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyInstance(),this.asset=null,this._assetReference.id=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||this._instance&&e.addMeshInstances(this._instance.meshInstance)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||this._instance&&e.removeMeshInstances(this._instance.meshInstance)}onEnable(){const e=this.system.app.scene;e.on("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.on("add",this.onLayerAdded,this),e.layers.on("remove",this.onLayerRemoved,this)),this._instance?this.addToLayers():this.asset&&this._onGSplatAssetAdded()}onDisable(){const e=this.system.app.scene;e.off("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.off("add",this.onLayerAdded,this),e.layers.off("remove",this.onLayerRemoved,this)),this.removeFromLayers()}hide(){this._instance&&(this._instance.meshInstance.visible=!1)}show(){this._instance&&(this._instance.meshInstance.visible=!0)}_onGSplatAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onGSplatAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onGSplatAssetLoad(){this.destroyInstance();const e=this._assetReference.asset;e&&(this.instance=e.resource.createInstance())}_onGSplatAssetUnload(){this.destroyInstance()}_onGSplatAssetRemove(){this._onGSplatAssetUnload()}}class LU{constructor(){this.enabled=!0}}const Bg=["enabled"],oa=["instance","asset","layers"];class DU extends tt{constructor(e){super(e),this.id="gsplat",this.ComponentType=GT,this.DataType=LU,this.schema=Bg,this.on("beforeremove",this.onRemove,this)}initializeComponentData(e,t,s){t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let i=0;i<oa.length;i++)t.hasOwnProperty(oa[i])&&(e[oa[i]]=t[oa[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new Re(new y(t.aabbCenter),new y(t.aabbHalfExtents))),super.initializeComponentData(e,t,Bg)}cloneComponent(e,t){const s=e.gsplat,i={};for(let a=0;a<oa.length;a++)i[oa[a]]=s[oa[a]];i.enabled=s.enabled,delete i.instance;const n=this.addComponent(t,i);return n.instance=s.instance.clone(),s.customAabb&&(n.customAabb=s.customAabb.clone()),n}onRemove(e,t){t.onRemove()}}ge._buildAccessors(GT.prototype,Bg);class v0 extends ie{constructor(){super(),this._meshes=null}set meshes(e){this.decRefMeshes(),this._meshes=e,this.incRefMeshes(),this.fire("set:meshes",e)}get meshes(){return this._meshes}destroy(){this.meshes=null}decRefMeshes(){if(this._meshes){const e=this._meshes.length;for(let t=0;t<e;t++){const s=this._meshes[t];s&&(s.decRefCount(),s.refCount<1&&(s.destroy(),this._meshes[t]=null))}}}incRefMeshes(){if(this._meshes){const e=this._meshes.length;for(let t=0;t<e;t++)this._meshes[t]&&this._meshes[t].incRefCount()}}}v0.EVENT_SETMESHES="set:meshes";function qu(r){const e=this;if(!e.resource)return;const t=r.resource,s=t.renders&&t.renders[e.data.renderIndex];s&&(e.resource.meshes=s.resource.meshes)}function Ex(r){const e=this;e.registry.off("load:"+r.id,qu,e),e.registry.on("load:"+r.id,qu,e),e.registry.off("remove:"+r.id,Cx,e),e.registry.once("remove:"+r.id,Cx,e),r.resource?qu.call(e,r):e.registry.load(r)}function Cx(r){const e=this;e.registry.off("load:"+r.id,qu,e),e.resource&&e.resource.destroy()}class OU extends Ze{constructor(e){super(e,"render"),this._registry=e.assets}open(e,t){return new v0}patch(e,t){if(!e.data.containerAsset)return;const s=t.get(e.data.containerAsset);if(!s){t.once("add:"+e.data.containerAsset,Ex,e);return}Ex.call(e,s)}}class HT{constructor(e,t,s,i){this._paths=e,this._input=t,this._output=s,this._interpolation=i}get paths(){return this._paths}get input(){return this._input}get output(){return this._output}get interpolation(){return this._interpolation}}class Tf{constructor(e,t){this._components=e,this._data=t}get components(){return this._components}get data(){return this._data}}function FU(r,e){let t;const n=(f,p)=>{switch(p){case t.DT_INT8:return new Int8Array(f.buffer,f.byteOffset,f.byteLength);case t.DT_INT16:return new Int16Array(f.buffer,f.byteOffset,f.byteLength/2);case t.DT_INT32:return new Int32Array(f.buffer,f.byteOffset,f.byteLength/4);case t.DT_UINT8:return new Uint8Array(f.buffer,f.byteOffset,f.byteLength);case t.DT_UINT16:return new Uint16Array(f.buffer,f.byteOffset,f.byteLength/2);case t.DT_UINT32:return new Uint32Array(f.buffer,f.byteOffset,f.byteLength/4);case t.DT_FLOAT32:return new Float32Array(f.buffer,f.byteOffset,f.byteLength/4)}return null},a=f=>{switch(f){case t.DT_INT8:return 1;case t.DT_INT16:return 2;case t.DT_INT32:return 4;case t.DT_UINT8:return 1;case t.DT_UINT16:return 2;case t.DT_UINT32:return 4;case t.DT_FLOAT32:return 4}return 1},o=f=>f.num_components()*a(f.data_type()),l={0:0,1:1,5:2,2:3,7:4,8:5,4:6,3:7},c=(f,p)=>{const _=(L,V,I)=>{L[0]=V[0]-I[0],L[1]=V[1]-I[1],L[2]=V[2]-I[2]},m=(L,V,I)=>{L[0]=V[1]*I[2]-I[1]*V[2],L[1]=V[2]*I[0]-I[2]*V[0],L[2]=V[0]*I[1]-I[0]*V[1]},g=(L,V)=>{const I=L[V+0],F=L[V+1],D=L[V+2],A=1/Math.sqrt(I*I+F*F+D*D);L[V+0]*=A,L[V+1]*=A,L[V+2]*=A},v=(L,V,I)=>{for(let F=0;F<3;++F)L[F]=V[I+F]},x=p.length/3,S=f.length/3,w=new Float32Array(f.length),T=[0,0,0],b=[0,0,0],C=[0,0,0],E=[0,0,0],R=[0,0,0],B=[0,0,0];for(let L=0;L<x;++L){const V=p[L*3+0]*3,I=p[L*3+1]*3,F=p[L*3+2]*3;v(T,f,V),v(b,f,I),v(C,f,F),_(E,b,T),_(R,C,T),m(B,E,R),g(B,0);for(let D=0;D<3;++D)w[V+D]+=B[D],w[I+D]+=B[D],w[F+D]+=B[D]}for(let L=0;L<S;++L)g(w,L*3);return new Uint8Array(w.buffer)},d=f=>{const p={},_=new t.DecoderBuffer;_.Init(f,f.length);const m=new t.Decoder;if(m.GetEncodedGeometryType(_)!==t.TRIANGULAR_MESH)return p.error="Failed to decode draco mesh: not a mesh",p;const g=new t.Mesh,v=m.DecodeBufferToMesh(_,g);if(!v||!v.ok()||g.ptr===0)return p.error="Failed to decode draco asset",p;const x=g.num_faces()*3,S=g.num_points()<=65535,w=x*(S?2:4),T=t._malloc(w);S?(m.GetTrianglesUInt16Array(g,w,T),p.indices=new Uint16Array(t.HEAPU16.buffer,T,x).slice().buffer):(m.GetTrianglesUInt32Array(g,w,T),p.indices=new Uint32Array(t.HEAPU32.buffer,T,x).slice().buffer),t._free(T);const b=[];for(let V=0;V<g.num_attributes();++V)b.push(m.GetAttribute(g,V));b.sort((V,I)=>{var F,D;return((F=l[V.attribute_type()])!=null?F:l.length)-((D=l[I.attribute_type()])!=null?D:l.length)}),p.attributes=b.map(V=>V.unique_id());let C=0;const E=b.map(V=>{const I=C;return C+=Math.ceil(o(V)/4)*4,I}),R=b.some(V=>V.attribute_type()===1),B=E[1];if(!R){for(let V=1;V<E.length;++V)E[V]+=12;C+=12}p.vertices=new ArrayBuffer(g.num_points()*C);const L=new Uint8Array(p.vertices);for(let V=0;V<g.num_attributes();++V){const I=b[V],F=o(I),D=g.num_points()*F,A=t._malloc(D);m.GetAttributeDataArrayForAllPoints(g,I,I.data_type(),D,A);const N=new Uint8Array(t.HEAPU8.buffer,A,D);for(let U=0;U<g.num_points();++U)for(let G=0;G<F;++G)L[U*C+E[V]+G]=N[U*F+G];if(!R&&I.attribute_type()===0){const U=c(n(N,I.data_type()),S?new Uint16Array(p.indices):new Uint32Array(p.indices));for(let G=0;G<g.num_points();++G)for(let X=0;X<12;++X)L[G*C+B+X]=U[G*12+X]}t._free(A)}return t.destroy(g),t.destroy(m),t.destroy(_),p},h=f=>{const p=d(new Uint8Array(f.buffer));self.postMessage({jobId:f.jobId,error:p.error,indices:p.indices,vertices:p.vertices,attributes:p.attributes},[p.indices,p.vertices].filter(_=>_!=null))},u=[];self.onmessage=f=>{const p=f.data;switch(p.type){case"init":self.DracoDecoderModule({instantiateWasm:(_,m)=>(WebAssembly.instantiate(p.module,_).then(g=>m(g)).catch(g=>console.error("instantiate failed + "+g)),{})}).then(_=>{t=_,u.forEach(m=>h(m))});break;case"decodeMesh":t?h(p):u.push(p);break}}}const Ax=3;class kU{constructor(){this.workers=[[],[],[]],this.jobId=0,this.jobQueue=[],this.jobCallbacks=new Map,this.run=(e,t)=>{e.postMessage({type:"decodeMesh",jobId:t.jobId,buffer:t.buffer},[t.buffer])}}init(e){for(e.forEach(t=>{t.addEventListener("message",s=>{const i=s.data,n=this.jobCallbacks.get(i.jobId);if(n&&n(i.error,{indices:i.indices,vertices:i.vertices,attributes:i.attributes}),this.jobCallbacks.delete(i.jobId),this.jobQueue.length>0){const a=this.jobQueue.shift();this.run(t,a)}else{const a=this.workers[2].indexOf(t);if(a!==-1)this.workers[2].splice(a,1),this.workers[1].push(t);else{const o=this.workers[1].indexOf(t);o!==-1&&(this.workers[1].splice(o,1),this.workers[0].push(t))}}})}),this.workers[0]=e;this.jobQueue.length&&(this.workers[0].length||this.workers[1].length);){const t=this.jobQueue.shift();if(this.workers[0].length>0){const s=this.workers[0].shift();this.workers[1].push(s),this.run(s,t)}else{const s=this.workers[1].shift();this.workers[2].push(s),this.run(s,t)}}}enqueueJob(e,t){const s={jobId:this.jobId++,buffer:e};if(this.jobCallbacks.set(s.jobId,t),this.workers[0].length>0){const i=this.workers[0].shift();this.workers[1].push(i),this.run(i,s)}else if(this.workers[1].length>0){const i=this.workers[1].shift();this.workers[2].push(i),this.run(i,s)}else this.jobQueue.push(s)}}const BU=r=>new Promise((e,t)=>{const s={cache:!0,responseType:"text",retry:Ax>0,maxRetries:Ax};at.get(r,s,(i,n)=>{i?t(i):e(n)})}),NU=r=>{const e=()=>fetch(r).then(s=>s.arrayBuffer()).then(s=>WebAssembly.compile(s)),t=()=>WebAssembly.compileStreaming(fetch(r)).catch(s=>e());return WebAssembly.compileStreaming?t():e()},Px=1;let Ku;const UU=r=>{if(Ku)return!0;if(!r){const e=Qu.getConfig("DracoDecoderModule");e?r={jsUrl:e.glueUrl,wasmUrl:e.wasmUrl,numWorkers:e.numWorkers}:r={jsUrl:"draco.wasm.js",wasmUrl:"draco.wasm.wasm",numWorkers:Px}}return!r.jsUrl||!r.wasmUrl?!1:(Ku=new kU,Promise.all([BU(r.jsUrl),NU(r.wasmUrl)]).then(([e,t])=>{const s=["/* draco */",e,"/* worker */",`(
${FU.toString()}
)()

`].join(`
`),i=new Blob([s],{type:"application/javascript"}),n=URL.createObjectURL(i),a=Math.max(1,Math.min(16,r.numWorkers||Px)),o=[];for(let l=0;l<a;++l){const c=new Worker(n);c.postMessage({type:"init",module:t}),o.push(c)}Ku.init(o)}),!0)},zU=(r,e)=>UU()?(Ku.enqueueJob(r,e),!0):!1;class VU{constructor(){this.gltf=void 0,this.nodes=void 0,this.scenes=void 0,this.animations=void 0,this.textures=void 0,this.materials=void 0,this.variants=void 0,this.meshVariants=void 0,this.meshDefaultMaterials=void 0,this.renders=void 0,this.skins=void 0,this.lights=void 0,this.cameras=void 0}destroy(){this.renders&&this.renders.forEach(e=>{e.meshes=null})}}const WT=r=>/^data:.*,.*$/i.test(r),GU=r=>r.substring(r.indexOf(":")+1,r.indexOf(";")),zc=r=>{switch(r){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 3}},sm=r=>{switch(r){case 5120:return ao;case 5121:return en;case 5122:return oo;case 5123:return Wr;case 5124:return fd;case 5125:return Ql;case 5126:return Me;default:return 0}},HU=r=>{switch(r){case 5120:return 1;case 5121:return 1;case 5122:return 2;case 5123:return 2;case 5124:return 4;case 5125:return 4;case 5126:return 4;default:return 0}},WU=r=>{switch(r){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}},Ef={POSITION:ht,NORMAL:Us,TANGENT:ln,COLOR_0:Zt,JOINTS_0:Os,WEIGHTS_0:hn,TEXCOORD_0:zs,TEXCOORD_1:Hr,TEXCOORD_2:nd,TEXCOORD_3:rd,TEXCOORD_4:ad,TEXCOORD_5:od,TEXCOORD_6:ld,TEXCOORD_7:hd},Mx={[ht]:0,[Us]:1,[ln]:2,[Zt]:3,[Os]:4,[hn]:5,[zs]:6,[Hr]:7,[nd]:8,[rd]:9,[ad]:10,[od]:11,[ld]:12,[hd]:13},jU=r=>{switch(r){case ao:return e=>Math.max(e/127,-1);case en:return e=>e/255;case oo:return e=>Math.max(e/32767,-1);case Wr:return e=>e/65535;default:return e=>e}},Ng=(r,e,t)=>{const s=jU(t),i=e.length;for(let n=0;n<i;++n)r[n]=s(e[n]);return r},za=(r,e,t=!1)=>{const s=zc(r.type),i=WU(r.componentType);if(!i)return null;let n;if(r.sparse){const a=r.sparse,o={count:a.count,type:"SCALAR"},l=za(Object.assign(o,a.indices),e,!0),c={count:a.count,type:r.type,componentType:r.componentType},d=za(Object.assign(c,a.values),e,!0);if(r.hasOwnProperty("bufferView")){const h={bufferView:r.bufferView,byteOffset:r.byteOffset,componentType:r.componentType,count:r.count,type:r.type};n=za(h,e,!0).slice()}else n=new i(r.count*s);for(let h=0;h<a.count;++h){const u=l[h];for(let f=0;f<s;++f)n[u*s+f]=d[h*s+f]}}else if(r.hasOwnProperty("bufferView")){const a=e[r.bufferView];if(t&&a.hasOwnProperty("byteStride")){const o=s*i.BYTES_PER_ELEMENT,l=new ArrayBuffer(r.count*o),c=new Uint8Array(l);let d=0;for(let h=0;h<r.count;++h){let u=(r.byteOffset||0)+h*a.byteStride;for(let f=0;f<o;++f)c[d++]=a[u++]}n=new i(l)}else n=new i(a.buffer,a.byteOffset+(r.byteOffset||0),r.count*s)}else n=new i(r.count*s);return n},Ug=(r,e)=>{const t=za(r,e,!0);if(t instanceof Float32Array||!r.normalized)return t;const s=new Float32Array(t.length);return Ng(s,t,sm(r.componentType)),s},zg=r=>{let e=r.min,t=r.max;if(!e||!t)return null;if(r.normalized){const s=sm(r.componentType);e=Ng([],e,s),t=Ng([],t,s)}return new Re(new y((t[0]+e[0])*.5,(t[1]+e[1])*.5,(t[2]+e[2])*.5),new y((t[0]-e[0])*.5,(t[1]-e[1])*.5,(t[2]-e[2])*.5))},jT=r=>{if(!r.hasOwnProperty("mode"))return Ln;switch(r.mode){case 0:return Rp;case 1:return Lp;case 2:return tb;case 3:return sb;case 4:return Ln;case 5:return Ji;case 6:return Ia;default:return Ln}},$U=r=>{const e=new Uint16Array(r);for(let t=0;t<r;t++)e[t]=t;return e},XU=(r,e)=>{const t=r[ht];if(!t||t.components!==3)return;let s;if(t.size!==t.stride){const o=t.stride/Zh[t.type],l=new xl[t.type](t.buffer,t.offset,t.count*o);s=new xl[t.type](t.count*3);for(let c=0;c<t.count;++c)s[c*3+0]=l[c*o+0],s[c*3+1]=l[c*o+1],s[c*3+2]=l[c*o+2]}else s=new xl[t.type](t.buffer,t.offset,t.count*3);const i=t.count;e||(e=$U(i));const n=II(s,e),a=new Float32Array(n.length);a.set(n),r[Us]={buffer:a.buffer,size:12,offset:0,stride:12,count:i,components:3,type:Me}},qU=r=>{let e,t;const s=[],i=[],n=[];for(e=0;e<r.format.elements.length;++e){const o=r.format.elements[e];if(o.name===zs||o.name===Hr)switch(o.dataType){case Me:s.push({offset:o.offset/4+1,stride:o.stride/4});break;case Wr:i.push({offset:o.offset/2+1,stride:o.stride/2});break;case en:n.push({offset:o.offset+1,stride:o.stride});break}}const a=(o,l,c)=>{const d=new l(r.storage);for(e=0;e<o.length;++e){let h=o[e].offset;const u=o[e].stride;for(t=0;t<r.numVertices;++t)d[h]=c-d[h],h+=u}};s.length>0&&a(s,Float32Array,1),i.length>0&&a(i,Uint16Array,65535),n.length>0&&a(n,Uint8Array,255)},KU=r=>{const e=s=>{const i=[];for(let n=0;n<s._levels.length;++n){let a=[];if(s.cubemap)for(let o=0;o<6;++o)a.push(s._levels[n][o]);else a=s._levels[n];i.push(a)}return i},t=new _e(r.device,r);return t._levels=e(r),t},YU=r=>{const e=new ne(r.name+"_clone",r.type,r.file,r.data,r.options);return e.loaded=!0,e.resource=KU(r.resource),r.registry.add(e),e},ZU=(r,e,t)=>{const s=e[ht];if(!s)return null;const i=s.count,n=[];for(const v in e)if(e.hasOwnProperty(v)){const x={semantic:v,components:e[v].components,type:e[v].type,normalize:!!e[v].normalize};os.isElementValid(r,x)||x.components++,n.push(x)}n.sort((v,x)=>Mx[v.semantic]-Mx[x.semantic]);let a,o,l,c,d,h;const u=new os(r,n);let f=!0;for(a=0;a<u.elements.length;++a)if(d=u.elements[a],c=e[d.name],h=c.offset-s.offset,c.buffer!==s.buffer||c.stride!==d.stride||c.size!==d.size||h!==d.offset){f=!1;break}const p=new Mi(r,u,i,as),_=p.lock(),m=new Uint32Array(_);let g;if(f)g=new Uint32Array(s.buffer,s.offset,i*p.format.size/4),m.set(g);else{let v,x;for(a=0;a<p.format.elements.length;++a){d=p.format.elements[a],v=d.stride/4,c=e[d.name],x=c.stride/4,g=new Uint32Array(c.buffer,c.offset,(c.count-1)*x+(c.size+3)/4);let S=0,w=d.offset/4;const T=Math.floor((c.size+3)/4);for(o=0;o<i;++o){for(l=0;l<T;++l)m[w+l]=g[S+l];S+=x,w+=v}}}return t&&qU(p),p.unlock(),p},JU=(r,e,t,s,i,n,a)=>{const o={},l=[];for(const h in e)e.hasOwnProperty(h)&&Ef.hasOwnProperty(h)&&(o[h]=e[h],l.push(h+":"+e[h]));l.sort();const c=l.join();let d=a[c];if(!d){const h={};for(const u in o){const f=s[e[u]],p=za(f,i),_=i[f.bufferView],m=Ef[u],g=zc(f.type)*HU(f.componentType),v=_&&_.hasOwnProperty("byteStride")?_.byteStride:g;h[m]={buffer:p.buffer,size:g,offset:p.byteOffset,stride:v,count:f.count,components:zc(f.type),type:sm(f.componentType),normalize:f.normalized}}h.hasOwnProperty(Us)||XU(h,t),d=ZU(r,h,n),a[c]=d}return d},QU=(r,e,t,s,i,n)=>{let a,o,l;const c=e.joints,d=c.length,h=[];if(e.hasOwnProperty("inverseBindMatrices")){const _=e.inverseBindMatrices,m=za(t[_],s,!0),g=[];for(a=0;a<d;a++){for(o=0;o<16;o++)g[o]=m[a*16+o];l=new q,l.set(g),h.push(l)}}else for(a=0;a<d;a++)l=new q,h.push(l);const u=[];for(a=0;a<d;a++)u[a]=i[c[a]].name;const f=u.join("#");let p=n.get(f);return p||(p=new eT(r,h,u),n.set(f,p)),p},e3=(r,e,t,s,i,n,a)=>{var o;const l=new Vs(r);l.aabb=zg(t[e.attributes.POSITION]);const c=[];for(const[h,u]of Object.entries(e.attributes)){var d;const f=t[u],p=Ef[h],_=sm(f.componentType);c.push({semantic:p,components:zc(f.type),type:_,normalize:(d=f.normalized)!=null?d:p===Zt&&(_===en||_===Wr)})}if(a.push(new Promise((h,u)=>{const f=e.extensions.KHR_draco_mesh_compression;zU(s[f.bufferView].slice().buffer,(p,_)=>{if(p)console.log(p),u(p);else{var m;const g={};for(const[C,E]of Object.entries(f.attributes))g[Ef[C]]=_.attributes.indexOf(E);c.sort((C,E)=>g[C.semantic]-g[E.semantic]),(m=e.attributes)!=null&&m.NORMAL||c.splice(1,0,{semantic:"NORMAL",components:3,type:Me});const v=new os(r,c),x=_.vertices.byteLength/v.size,S=x<=65535?ai:Fr,w=_.indices.byteLength/(x<=65535?2:4),T=new Mi(r,v,x,as,_.vertices),b=new Br(r,S,w,as,_.indices);l.vertexBuffer=T,l.indexBuffer[0]=b,l.primitive[0].type=jT(e),l.primitive[0].base=0,l.primitive[0].count=b?w:x,l.primitive[0].indexed=!!b,h()}})})),e!=null&&(o=e.extensions)!=null&&o.KHR_materials_variants){const h=e.extensions.KHR_materials_variants,u={};h.mappings.forEach(f=>{f.variants.forEach(p=>{u[p]=f.material})}),i[l.id]=u}return n[l.id]=e.material,l},t3=(r,e,t,s,i,n,a,o,l,c)=>{const d=[];return e.primitives.forEach(h=>{var u;if((u=h.extensions)!=null&&u.KHR_draco_mesh_compression)d.push(e3(r,h,t,s,a,o,c));else{let f=h.hasOwnProperty("indices")?za(t[h.indices],s,!0):null;const p=JU(r,h.attributes,f,t,s,i,n),_=jT(h),m=new Vs(r);if(m.vertexBuffer=p,m.primitive[0].type=_,m.primitive[0].base=0,m.primitive[0].indexed=f!==null,f!==null){let v;f instanceof Uint8Array?v=H_:f instanceof Uint16Array?v=ai:v=Fr,v===Fr&&!r.extUintElement&&(v=ai,f=new Uint16Array(f)),v===H_&&r.isWebGPU&&(v=ai,f=new Uint16Array(f));const x=new Br(r,v,f.length,as,f);m.indexBuffer[0]=x,m.primitive[0].count=f.length}else m.primitive[0].count=p.numVertices;if(h.hasOwnProperty("extensions")&&h.extensions.hasOwnProperty("KHR_materials_variants")){const v=h.extensions.KHR_materials_variants,x={};v.mappings.forEach(S=>{S.variants.forEach(w=>{x[w]=S.material})}),a[m.id]=x}o[m.id]=h.material;let g=t[h.attributes.POSITION];if(m.aabb=zg(g),h.hasOwnProperty("targets")){const v=[];h.targets.forEach((x,S)=>{const w={};x.hasOwnProperty("POSITION")&&(g=t[x.POSITION],w.deltaPositions=Ug(g,s),w.deltaPositionsType=Me,w.aabb=zg(g)),x.hasOwnProperty("NORMAL")&&(g=t[x.NORMAL],w.deltaNormals=Ug(g,s),w.deltaNormalsType=Me),e.hasOwnProperty("extras")&&e.extras.hasOwnProperty("targetNames")?w.name=e.extras.targetNames[S]:w.name=S.toString(10),e.hasOwnProperty("weights")&&(w.defaultWeight=e.weights[S]),w.preserveData=l.morphPreserveData,v.push(new Qp(w))}),m.morph=new s0(v,r,{preferHighPrecision:l.morphPreferHighPrecision})}d.push(m)}}),d},Ot=(r,e,t)=>{var s;let i;const n=r.texCoord;if(n)for(i=0;i<t.length;++i)e[t[i]+"MapUv"]=n;const a=[0,0],o=[1,1],l=(s=r.extensions)==null?void 0:s.KHR_texture_transform;if(l){const c=l.offset||a,d=l.scale||o,h=l.rotation?-l.rotation*H.RAD_TO_DEG:0,u=new M(d[0],d[1]),f=new M(c[0],1-d[1]-c[1]);for(i=0;i<t.length;++i)e[`${t[i]}MapTiling`]=u,e[`${t[i]}MapOffset`]=f,e[`${t[i]}MapRotation`]=h}},s3=(r,e,t)=>{let s,i;if(r.hasOwnProperty("diffuseFactor")?(s=r.diffuseFactor,e.diffuse.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2)),e.opacity=s[3]):(e.diffuse.set(1,1,1),e.opacity=1),r.hasOwnProperty("diffuseTexture")){const n=r.diffuseTexture;i=t[n.index],e.diffuseMap=i,e.diffuseMapChannel="rgb",e.opacityMap=i,e.opacityMapChannel="a",Ot(n,e,["diffuse","opacity"])}if(e.useMetalness=!1,r.hasOwnProperty("specularFactor")?(s=r.specularFactor,e.specular.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))):e.specular.set(1,1,1),r.hasOwnProperty("glossinessFactor")?e.gloss=r.glossinessFactor:e.gloss=1,r.hasOwnProperty("specularGlossinessTexture")){const n=r.specularGlossinessTexture;e.specularEncoding="srgb",e.specularMap=e.glossMap=t[n.index],e.specularMapChannel="rgb",e.glossMapChannel="a",Ot(n,e,["gloss","metalness"])}},i3=(r,e,t)=>{if(r.hasOwnProperty("clearcoatFactor")?e.clearCoat=r.clearcoatFactor*.25:e.clearCoat=0,r.hasOwnProperty("clearcoatTexture")){const s=r.clearcoatTexture;e.clearCoatMap=t[s.index],e.clearCoatMapChannel="r",Ot(s,e,["clearCoat"])}if(r.hasOwnProperty("clearcoatRoughnessFactor")?e.clearCoatGloss=r.clearcoatRoughnessFactor:e.clearCoatGloss=0,r.hasOwnProperty("clearcoatRoughnessTexture")){const s=r.clearcoatRoughnessTexture;e.clearCoatGlossMap=t[s.index],e.clearCoatGlossMapChannel="g",Ot(s,e,["clearCoatGloss"])}if(r.hasOwnProperty("clearcoatNormalTexture")){const s=r.clearcoatNormalTexture;e.clearCoatNormalMap=t[s.index],Ot(s,e,["clearCoatNormal"]),s.hasOwnProperty("scale")&&(e.clearCoatBumpiness=s.scale)}e.clearCoatGlossInvert=!0},n3=(r,e,t)=>{e.useLighting=!1,e.emissive.copy(e.diffuse),e.emissiveTint=e.diffuseTint,e.emissiveMap=e.diffuseMap,e.emissiveMapUv=e.diffuseMapUv,e.emissiveMapTiling.copy(e.diffuseMapTiling),e.emissiveMapOffset.copy(e.diffuseMapOffset),e.emissiveMapRotation=e.diffuseMapRotation,e.emissiveMapChannel=e.diffuseMapChannel,e.emissiveVertexColor=e.diffuseVertexColor,e.emissiveVertexColorChannel=e.diffuseVertexColorChannel,e.useLighting=!1,e.useSkybox=!1,e.diffuse.set(0,0,0),e.diffuseTint=!1,e.diffuseMap=null,e.diffuseVertexColor=!1},r3=(r,e,t)=>{if(e.useMetalnessSpecularColor=!0,r.hasOwnProperty("specularColorTexture")&&(e.specularEncoding="srgb",e.specularMap=t[r.specularColorTexture.index],e.specularMapChannel="rgb",Ot(r.specularColorTexture,e,["specular"])),r.hasOwnProperty("specularColorFactor")){const s=r.specularColorFactor;e.specular.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else e.specular.set(1,1,1);r.hasOwnProperty("specularFactor")?e.specularityFactor=r.specularFactor:e.specularityFactor=1,r.hasOwnProperty("specularTexture")&&(e.specularityFactorMapChannel="a",e.specularityFactorMap=t[r.specularTexture.index],Ot(r.specularTexture,e,["specularityFactor"]))},a3=(r,e,t)=>{r.hasOwnProperty("ior")&&(e.refractionIndex=1/r.ior)},o3=(r,e,t)=>{e.blendType=Bt,e.useDynamicRefraction=!0,r.hasOwnProperty("transmissionFactor")&&(e.refraction=r.transmissionFactor),r.hasOwnProperty("transmissionTexture")&&(e.refractionMapChannel="r",e.refractionMap=t[r.transmissionTexture.index],Ot(r.transmissionTexture,e,["refraction"]))},l3=(r,e,t)=>{if(e.useSheen=!0,r.hasOwnProperty("sheenColorFactor")){const s=r.sheenColorFactor;e.sheen.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else e.sheen.set(1,1,1);r.hasOwnProperty("sheenColorTexture")&&(e.sheenMap=t[r.sheenColorTexture.index],e.sheenEncoding="srgb",Ot(r.sheenColorTexture,e,["sheen"])),r.hasOwnProperty("sheenRoughnessFactor")?e.sheenGloss=r.sheenRoughnessFactor:e.sheenGloss=0,r.hasOwnProperty("sheenRoughnessTexture")&&(e.sheenGlossMap=t[r.sheenRoughnessTexture.index],e.sheenGlossMapChannel="a",Ot(r.sheenRoughnessTexture,e,["sheenGloss"])),e.sheenGlossInvert=!0},h3=(r,e,t)=>{if(e.blendType=Bt,e.useDynamicRefraction=!0,r.hasOwnProperty("thicknessFactor")&&(e.thickness=r.thicknessFactor),r.hasOwnProperty("thicknessTexture")&&(e.thicknessMap=t[r.thicknessTexture.index],e.thicknessMapChannel="g",Ot(r.thicknessTexture,e,["thickness"])),r.hasOwnProperty("attenuationDistance")&&(e.attenuationDistance=r.attenuationDistance),r.hasOwnProperty("attenuationColor")){const s=r.attenuationColor;e.attenuation.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}},c3=(r,e,t)=>{r.hasOwnProperty("emissiveStrength")&&(e.emissiveIntensity=r.emissiveStrength)},d3=(r,e,t)=>{e.useIridescence=!0,r.hasOwnProperty("iridescenceFactor")&&(e.iridescence=r.iridescenceFactor),r.hasOwnProperty("iridescenceTexture")&&(e.iridescenceMapChannel="r",e.iridescenceMap=t[r.iridescenceTexture.index],Ot(r.iridescenceTexture,e,["iridescence"])),r.hasOwnProperty("iridescenceIor")&&(e.iridescenceRefractionIndex=r.iridescenceIor),r.hasOwnProperty("iridescenceThicknessMinimum")&&(e.iridescenceThicknessMin=r.iridescenceThicknessMinimum),r.hasOwnProperty("iridescenceThicknessMaximum")&&(e.iridescenceThicknessMax=r.iridescenceThicknessMaximum),r.hasOwnProperty("iridescenceThicknessTexture")&&(e.iridescenceThicknessMapChannel="g",e.iridescenceThicknessMap=t[r.iridescenceThicknessTexture.index],Ot(r.iridescenceThicknessTexture,e,["iridescenceThickness"]))},$T=(r,e,t)=>{const s=new Gs;s.occludeSpecular=Cc,s.diffuseTint=!0,s.diffuseVertexColor=!0,s.specularTint=!0,s.specularVertexColor=!0,r.hasOwnProperty("name")&&(s.name=r.name);let i,n;if(r.hasOwnProperty("pbrMetallicRoughness")){const o=r.pbrMetallicRoughness;if(o.hasOwnProperty("baseColorFactor")?(i=o.baseColorFactor,s.diffuse.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),s.opacity=i[3]):(s.diffuse.set(1,1,1),s.opacity=1),o.hasOwnProperty("baseColorTexture")){const l=o.baseColorTexture;n=e[l.index],s.diffuseMap=n,s.diffuseMapChannel="rgb",s.opacityMap=n,s.opacityMapChannel="a",Ot(l,s,["diffuse","opacity"])}if(s.useMetalness=!0,s.specular.set(1,1,1),o.hasOwnProperty("metallicFactor")?s.metalness=o.metallicFactor:s.metalness=1,o.hasOwnProperty("roughnessFactor")?s.gloss=o.roughnessFactor:s.gloss=1,s.glossInvert=!0,o.hasOwnProperty("metallicRoughnessTexture")){const l=o.metallicRoughnessTexture;s.metalnessMap=s.glossMap=e[l.index],s.metalnessMapChannel="b",s.glossMapChannel="g",Ot(l,s,["gloss","metalness"])}}if(r.hasOwnProperty("normalTexture")){const o=r.normalTexture;s.normalMap=e[o.index],Ot(o,s,["normal"]),o.hasOwnProperty("scale")&&(s.bumpiness=o.scale)}if(r.hasOwnProperty("occlusionTexture")){const o=r.occlusionTexture;s.aoMap=e[o.index],s.aoMapChannel="r",Ot(o,s,["ao"])}if(r.hasOwnProperty("emissiveFactor")?(i=r.emissiveFactor,s.emissive.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),s.emissiveTint=!0):(s.emissive.set(0,0,0),s.emissiveTint=!1),r.hasOwnProperty("emissiveTexture")){const o=r.emissiveTexture;s.emissiveMap=e[o.index],Ot(o,s,["emissive"])}if(r.hasOwnProperty("alphaMode"))switch(r.alphaMode){case"MASK":s.blendType=ms,r.hasOwnProperty("alphaCutoff")?s.alphaTest=r.alphaCutoff:s.alphaTest=.5;break;case"BLEND":s.blendType=Bt,s.depthWrite=!1;break;default:case"OPAQUE":s.blendType=ms;break}else s.blendType=ms;r.hasOwnProperty("doubleSided")?(s.twoSidedLighting=r.doubleSided,s.cull=r.doubleSided?Et:Dr):(s.twoSidedLighting=!1,s.cull=Dr);const a={KHR_materials_clearcoat:i3,KHR_materials_emissive_strength:c3,KHR_materials_ior:a3,KHR_materials_iridescence:d3,KHR_materials_pbrSpecularGlossiness:s3,KHR_materials_sheen:l3,KHR_materials_specular:r3,KHR_materials_transmission:o3,KHR_materials_unlit:n3,KHR_materials_volume:h3};if(r.hasOwnProperty("extensions"))for(const o in r.extensions){const l=a[o];l!==void 0&&l(r.extensions[o],s,e)}return s.update(),s},u3=(r,e,t,s,i,n,a)=>{const o=C=>new Tf(zc(C.type),Ug(C,s)),l={STEP:aT,LINEAR:_g,CUBICSPLINE:gg},c={},d={},h={};let u=1,f;for(f=0;f<r.samplers.length;++f){const C=r.samplers[f];c.hasOwnProperty(C.input)||(c[C.input]=o(t[C.input])),d.hasOwnProperty(C.output)||(d[C.output]=o(t[C.output]));const E=C.hasOwnProperty("interpolation")&&l.hasOwnProperty(C.interpolation)?l[C.interpolation]:_g,R={paths:[],input:C.input,output:C.output,interpolation:E};h[f]=R}const p=[],_={translation:"localPosition",rotation:"localRotation",scale:"localScale"},m=C=>{const E=[];for(;C;)E.unshift(C.name),C=C.parent;return E},g=(C,E,R)=>{const B=d[C.output];if(!B)return;let L;if(n&&n[E.mesh]){const U=n[E.mesh];U.hasOwnProperty("extras")&&U.extras.hasOwnProperty("targetNames")&&(L=U.extras.targetNames)}const V=B.data,I=V.length/c[C.input].data.length,F=V.length/I,D=F*4,A=new ArrayBuffer(D*I);for(let U=0;U<I;U++){var N;const G=new Float32Array(A,D*U,F);for(let ee=0;ee<F;ee++)G[ee]=V[ee*I+U];const X=new Tf(1,G),j=(N=L)!=null&&N[U]?`name.${L[U]}`:U;d[-u]=X;const J={paths:[{entityPath:R,component:"graph",propertyPath:[`weight.${j}`]}],input:C.input,output:-u,interpolation:C.interpolation};u++,h[`morphCurve-${f}-${U}`]=J}};for(f=0;f<r.channels.length;++f){const C=r.channels[f],E=C.target,R=h[C.sampler],B=i[E.node],L=a[E.node],V=m(B);E.path.startsWith("weights")?(g(R,L,V),h[C.sampler].morphCurve=!0):R.paths.push({entityPath:V,component:"graph",propertyPath:[_[E.path]]})}const v=[],x=[],S=[];for(const C in c)v.push(c[C]),c[C]=v.length-1;for(const C in d)x.push(d[C]),d[C]=x.length-1;for(const C in h){const E=h[C];E.morphCurve||(S.push(new HT(E.paths,c[E.input],d[E.output],E.interpolation)),E.paths.length>0&&E.paths[0].propertyPath[0]==="localRotation"&&E.interpolation!==gg&&p.push(S[S.length-1].output))}p.sort();let w=null,T;for(f=0;f<p.length;++f){const C=p[f];if(f===0||C!==w){if(T=x[C],T.components===4){const E=T.data,R=E.length-4;for(let B=0;B<R;B+=4)E[B+0]*E[B+4]+E[B+1]*E[B+5]+E[B+2]*E[B+6]+E[B+3]*E[B+7]<0&&(E[B+4]*=-1,E[B+5]*=-1,E[B+6]*=-1,E[B+7]*=-1)}w=C}}let b=0;for(f=0;f<v.length;f++)T=v[f]._data,b=Math.max(b,T.length===0?0:T[T.length-1]);return new qn(r.hasOwnProperty("name")?r.name:"animation_"+e,b,v,x,S)},Su=new q,Vo=new y,f3=(r,e)=>{const t=new ze;if(r.hasOwnProperty("name")&&r.name.length>0?t.name=r.name:t.name="node_"+e,r.hasOwnProperty("matrix")&&(Su.data.set(r.matrix),Su.getTranslation(Vo),t.setLocalPosition(Vo),Su.getEulerAngles(Vo),t.setLocalEulerAngles(Vo),Su.getScale(Vo),t.setLocalScale(Vo)),r.hasOwnProperty("rotation")){const s=r.rotation;t.setLocalRotation(s[0],s[1],s[2],s[3])}if(r.hasOwnProperty("translation")){const s=r.translation;t.setLocalPosition(s[0],s[1],s[2])}if(r.hasOwnProperty("scale")){const s=r.scale;t.setLocalScale(s[0],s[1],s[2])}return t},p3=(r,e)=>{const t=r.type==="orthographic"?Ua:Gi,s=t===Ua?r.orthographic:r.perspective,i={enabled:!1,projection:t,nearClip:s.znear,aspectRatioMode:qy};s.zfar&&(i.farClip=s.zfar),t===Ua?(i.orthoHeight=.5*s.ymag,s.ymag&&(i.aspectRatioMode=og,i.aspectRatio=s.xmag/s.ymag)):(i.fov=s.yfov*H.RAD_TO_DEG,s.aspectRatio&&(i.aspectRatioMode=og,i.aspectRatio=s.aspectRatio));const n=new $(r.name);return n.addComponent("camera",i),n},m3=(r,e)=>{const t={enabled:!1,type:r.type==="point"?"omni":r.type,color:r.hasOwnProperty("color")?new k(r.color):k.WHITE,range:r.hasOwnProperty("range")?r.range:9999,falloffMode:fI,intensity:r.hasOwnProperty("intensity")?H.clamp(r.intensity,0,2):1};r.hasOwnProperty("spot")&&(t.innerConeAngle=r.spot.hasOwnProperty("innerConeAngle")?r.spot.innerConeAngle*H.RAD_TO_DEG:0,t.outerConeAngle=r.spot.hasOwnProperty("outerConeAngle")?r.spot.outerConeAngle*H.RAD_TO_DEG:Math.PI/4),r.hasOwnProperty("intensity")&&(t.luminance=r.intensity*kc.getLightUnitConversion(ug[t.type],t.outerConeAngle,t.innerConeAngle));const s=new $(e.name);return s.rotateLocal(90,0,0),s.addComponent("light",t),s},_3=(r,e,t,s)=>{if(!e.hasOwnProperty("skins")||e.skins.length===0)return[];const i=new Map;return e.skins.map(n=>QU(r,n,e.accessors,s,t,i))},g3=(r,e,t,s,i)=>{var n,a,o;const l={},c={},d={},h=[];return{meshes:!i.skipMeshes&&(e==null||(n=e.meshes)==null?void 0:n.length)&&(e==null||(a=e.accessors)==null?void 0:a.length)&&(e==null||(o=e.bufferViews)==null?void 0:o.length)?e.meshes.map(p=>t3(r,p,e.accessors,t,s,l,c,d,i,h)):[],meshVariants:c,meshDefaultMaterials:d,promises:h}},y3=(r,e,t,s)=>{var i,n,a,o;if(!r.hasOwnProperty("materials")||r.materials.length===0)return[];const l=t==null||(i=t.material)==null?void 0:i.preprocess,c=(n=t==null||(a=t.material)==null?void 0:a.process)!=null?n:$T,d=t==null||(o=t.material)==null?void 0:o.postprocess;return r.materials.map(h=>{l&&l(h);const u=c(h,e,s);return d&&d(h,u),u})},v3=r=>{if(!r.hasOwnProperty("extensions")||!r.extensions.hasOwnProperty("KHR_materials_variants"))return null;const e=r.extensions.KHR_materials_variants.variants,t={};for(let s=0;s<e.length;s++)t[e[s].name]=s;return t},S3=(r,e,t,s)=>{var i,n;if(!r.hasOwnProperty("animations")||r.animations.length===0)return[];const a=s==null||(i=s.animation)==null?void 0:i.preprocess,o=s==null||(n=s.animation)==null?void 0:n.postprocess;return r.animations.map((l,c)=>{a&&a(l);const d=u3(l,c,r.accessors,t,e,r.meshes,r.nodes);return o&&o(l,d),d})},x3=(r,e)=>{var t,s,i,n;if(!r.hasOwnProperty("nodes")||r.nodes.length===0)return[];const a=e==null||(t=e.node)==null?void 0:t.preprocess,o=(s=e==null||(i=e.node)==null?void 0:i.process)!=null?s:f3,l=e==null||(n=e.node)==null?void 0:n.postprocess,c=r.nodes.map((d,h)=>{a&&a(d);const u=o(d,h);return l&&l(d,u),u});for(let d=0;d<r.nodes.length;++d){const h=r.nodes[d];if(h.hasOwnProperty("children")){const u=c[d],f={};for(let p=0;p<h.children.length;++p){const _=c[h.children[p]];_.parent||(f.hasOwnProperty(_.name)?_.name+=f[_.name]++:f[_.name]=1,u.addChild(_))}}}return c},w3=(r,e)=>{var t;const s=[],i=r.scenes.length;if(i===1&&((t=r.scenes[0].nodes)==null?void 0:t.length)===1){const n=r.scenes[0].nodes[0];s.push(e[n])}else for(let n=0;n<i;n++){const a=r.scenes[n];if(a.nodes){const o=new ze(a.name);for(let l=0;l<a.nodes.length;l++){const c=e[a.nodes[l]];o.addChild(c)}s.push(o)}}return s},b3=(r,e,t)=>{let s=null;if(r.hasOwnProperty("nodes")&&r.hasOwnProperty("cameras")&&r.cameras.length>0){var i,n,a,o;const l=t==null||(i=t.camera)==null?void 0:i.preprocess,c=(n=t==null||(a=t.camera)==null?void 0:a.process)!=null?n:p3,d=t==null||(o=t.camera)==null?void 0:o.postprocess;r.nodes.forEach((h,u)=>{if(h.hasOwnProperty("camera")){const f=r.cameras[h.camera];if(f){l&&l(f);const p=c(f,e[u]);d&&d(f,p),p&&(s||(s=new Map),s.set(h,p))}}})}return s},T3=(r,e,t)=>{let s=null;if(r.hasOwnProperty("nodes")&&r.hasOwnProperty("extensions")&&r.extensions.hasOwnProperty("KHR_lights_punctual")&&r.extensions.KHR_lights_punctual.hasOwnProperty("lights")){const l=r.extensions.KHR_lights_punctual.lights;if(l.length){var i,n,a,o;const c=t==null||(i=t.light)==null?void 0:i.preprocess,d=(n=t==null||(a=t.light)==null?void 0:a.process)!=null?n:m3,h=t==null||(o=t.light)==null?void 0:o.postprocess;r.nodes.forEach((u,f)=>{if(u.hasOwnProperty("extensions")&&u.extensions.hasOwnProperty("KHR_lights_punctual")&&u.extensions.KHR_lights_punctual.hasOwnProperty("light")){const p=u.extensions.KHR_lights_punctual.light,_=l[p];if(_){c&&c(_);const m=d(_,e[f]);h&&h(_,m),m&&(s||(s=new Map),s.set(u,m))}}})}}return s},E3=(r,e,t)=>{r.nodes.forEach(s=>{s.hasOwnProperty("mesh")&&s.hasOwnProperty("skin")&&e[s.mesh].meshes.forEach(n=>{n.skin=t[s.skin]})})},C3=async(r,e,t,s,i)=>{var n,a;const o=i==null||(n=i.global)==null?void 0:n.preprocess,l=i==null||(a=i.global)==null?void 0:a.postprocess;o&&o(e);const c=e.asset&&e.asset.generator==="PlayCanvas",d=x3(e,i),h=w3(e,d),u=T3(e,d,i),f=b3(e,d,i),p=v3(e),_=await Promise.all(t),{meshes:m,meshVariants:g,meshDefaultMaterials:v,promises:x}=g3(r,e,_,c,i),S=S3(e,d,_,i),w=await Promise.all(s),T=w.map(B=>B.resource),b=y3(e,T,i,c),C=_3(r,e,d,_),E=[];for(let B=0;B<m.length;B++)E[B]=new v0,E[B].meshes=m[B];E3(e,E,C);const R=new VU;return R.gltf=e,R.nodes=d,R.scenes=h,R.animations=S,R.textures=w,R.materials=b,R.variants=p,R.meshVariants=g,R.meshDefaultMaterials=v,R.renders=E,R.skins=C,R.lights=u,R.cameras=f,l&&l(e,R),await Promise.all(x),R},A3=(r,e)=>{const t=(n,a)=>{switch(n){case 9728:return Ee;case 9729:return nt;case 9984:return qc;case 9985:return Yc;case 9986:return Kc;case 9987:return Or;default:return a}},s=(n,a)=>{switch(n){case 33071:return ae;case 33648:return ap;case 10497:return Tt;default:return a}};if(r){var i;e=(i=e)!=null?i:{},r.minFilter=t(e.minFilter,Or),r.magFilter=t(e.magFilter,nt),r.addressU=s(e.wrapS,Tt),r.addressV=s(e.wrapT,Tt)}};let P3=0;const M3=(r,e,t,s,i)=>{var n,a,o;if(!r.images||r.images.length===0)return[];const l=i==null||(n=i.image)==null?void 0:n.preprocess,c=i==null||(a=i.image)==null?void 0:a.processAsync,d=i==null||(o=i.image)==null?void 0:o.postprocess,h={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},u=(f,p,_,m,g)=>new Promise((v,x)=>{const S=w=>{const T=(f.name||"gltf-texture")+"-"+P3++,b={url:p||T};if(w&&(b.contents=w.slice(0).buffer),m){const E=h[m];E&&(b.filename=b.url+"."+E)}const C=new ne(T,"texture",b,null,g);C.on("load",E=>v(E)),C.on("error",E=>x(E)),s.add(C),s.load(C)};_?_.then(w=>S(w)):S(null)});return r.images.map((f,p)=>{l&&l(f);let _;return c?_=new Promise((m,g)=>{c(f,(v,x)=>{v?g(v):m(x)})}):_=new Promise(m=>{m(null)}),_=_.then(m=>m||(f.hasOwnProperty("uri")?WT(f.uri)?u(f,f.uri,null,GU(f.uri),null):u(f,Wl.test(f.uri)?f.uri:me.join(t,f.uri),null,null,{crossOrigin:"anonymous"}):f.hasOwnProperty("bufferView")&&f.hasOwnProperty("mimeType")?u(f,null,e[f.bufferView],f.mimeType,null):Promise.reject(new Error(`Invalid image found in gltf (neither uri or bufferView found). index=${p}`)))),d&&(_=_.then(m=>(d(f,m),m))),_})},I3=(r,e,t)=>{var s,i,n,a,o;if(!(r!=null&&(s=r.images)!=null&&s.length)||!(r!=null&&(i=r.textures)!=null&&i.length))return[];const l=t==null||(n=t.texture)==null?void 0:n.preprocess,c=t==null||(a=t.texture)==null?void 0:a.processAsync,d=t==null||(o=t.texture)==null?void 0:o.postprocess,h=new Set;return r.textures.map(u=>{l&&l(u);let f;return c?f=new Promise((p,_)=>{c(u,r.images,(m,g)=>{m?_(m):p(g)})}):f=new Promise(p=>{p(null)}),f=f.then(p=>{var _,m,g,v,x;p=(_=(m=(g=p)!=null?g:u==null||(v=u.extensions)==null||(v=v.KHR_texture_basisu)==null?void 0:v.source)!=null?m:u==null||(x=u.extensions)==null||(x=x.EXT_texture_webp)==null?void 0:x.source)!=null?_:u.source;const S=h.has(p);return h.add(p),e[p].then(w=>{var T;const b=S?YU(w):w;return A3(b.resource,((T=r.samplers)!=null?T:[])[u.sampler]),b})}),d&&(f=f.then(p=>(d(u,p),p))),f})},R3=(r,e,t,s)=>{var i,n,a;if(!r.buffers||r.buffers.length===0)return[];const o=s==null||(i=s.buffer)==null?void 0:i.preprocess,l=s==null||(n=s.buffer)==null?void 0:n.processAsync,c=s==null||(a=s.buffer)==null?void 0:a.postprocess;return r.buffers.map((d,h)=>{o&&o(d);let u;return l?u=new Promise((f,p)=>{l(d,(_,m)=>{_?p(_):f(m)})}):u=new Promise(f=>{f(null)}),u=u.then(f=>{if(f)return f;if(d.hasOwnProperty("uri")){if(WT(d.uri)){const p=atob(d.uri.split(",")[1]),_=new Uint8Array(p.length);for(let m=0;m<p.length;m++)_[m]=p.charCodeAt(m);return _}return new Promise((p,_)=>{at.get(Wl.test(d.uri)?d.uri:me.join(t,d.uri),{cache:!0,responseType:"arraybuffer",retry:!1},(m,g)=>{m?_(m):p(new Uint8Array(g))})})}return e}),c&&(u=u.then(f=>(c(r.buffers[h],f),f))),u})},L3=(r,e)=>{const s=JSON.parse((i=>{if(typeof TextDecoder<"u")return new TextDecoder().decode(i);let n="";for(let a=0;a<i.length;a++)n+=String.fromCharCode(i[a]);return decodeURIComponent(escape(n))})(r));if(s.asset&&s.asset.version&&parseFloat(s.asset.version)<2){e(`Invalid gltf version. Expected version 2.0 or above but found version '${s.asset.version}'.`);return}e(null,s)},D3=(r,e)=>{const t=r instanceof ArrayBuffer?new DataView(r):new DataView(r.buffer,r.byteOffset,r.byteLength),s=t.getUint32(0,!0),i=t.getUint32(4,!0),n=t.getUint32(8,!0);if(s!==1179937895){e("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+s.toString(16));return}if(i!==2){e("Invalid version number found in glb header. Expected 2, found "+i);return}if(n<=0||n>t.byteLength){e("Invalid length found in glb header. Found "+n);return}const a=[];let o=12;for(;o<n;){const l=t.getUint32(o,!0);o+l+8>t.byteLength&&e(`Invalid chunk length found in glb. Found ${l}`);const c=t.getUint32(o+4,!0),d=new Uint8Array(t.buffer,t.byteOffset+o+8,l);a.push({length:l,type:c,data:d}),o+=l+8}if(a.length!==1&&a.length!==2){e("Invalid number of chunks found in glb file.");return}if(a[0].type!==1313821514){e(`Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x${a[0].type.toString(16)}`);return}if(a.length>1&&a[1].type!==5130562){e(`Invalid chunk type found in glb file. Expected 0x004E4942, found 0x${a[1].type.toString(16)}`);return}e(null,{gltfChunk:a[0].data,binaryChunk:a.length===2?a[1].data:null})},O3=(r,e,t)=>{const s=()=>{const i=new Uint8Array(e);return i[0]===103&&i[1]===108&&i[2]===84&&i[3]===70};r&&r.toLowerCase().endsWith(".glb")||s()?D3(e,t):t(null,{gltfChunk:e,binaryChunk:null})},F3=(r,e,t)=>{var s,i,n,a;const o=[],l=t==null||(s=t.bufferView)==null?void 0:s.preprocess,c=t==null||(i=t.bufferView)==null?void 0:i.processAsync,d=t==null||(n=t.bufferView)==null?void 0:n.postprocess;if(!((a=r.bufferViews)!=null&&a.length))return o;for(let h=0;h<r.bufferViews.length;++h){const u=r.bufferViews[h];l&&l(u);let f;c?f=new Promise((p,_)=>{c(u,e,(m,g)=>{m?_(m):p(g)})}):f=new Promise(p=>{p(null)}),f=f.then(p=>p||e[u.buffer].then(_=>new Uint8Array(_.buffer,_.byteOffset+(u.byteOffset||0),u.byteLength))),u.hasOwnProperty("byteStride")&&(f=f.then(p=>(p.byteStride=u.byteStride,p))),d&&(f=f.then(p=>(d(u,p),p))),o.push(f)}return o};class Cf{static parse(e,t,s,i,n,a,o){O3(e,s,(l,c)=>{if(l){o(l);return}L3(c.gltfChunk,(d,h)=>{if(d){o(d);return}const u=R3(h,c.binaryChunk,t,a),f=F3(h,u,a),p=M3(h,f,t,n,a),_=I3(h,p,a);C3(i,h,f,_,a).then(m=>o(null,m)).catch(m=>o(m))})})}static createDefaultMaterial(){return $T({name:"defaultGlbMaterial"},[])}}class k3 extends Ze{constructor(e){super(e,"animation"),this.device=e.graphicsDevice,this.assets=e.assets}load(e,t,s){typeof e=="string"&&(e={load:e,original:e});const i={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.load.startsWith("blob:")||e.load.startsWith("data:"))&&(me.getExtension(e.original).toLowerCase()===".glb"?i.responseType=be.ResponseType.ARRAY_BUFFER:i.responseType=be.ResponseType.JSON),at.get(e.load,i,(n,a)=>{if(n)t(`Error loading animation resource: ${e.original} [${n}]`);else if(me.getExtension(e.original).toLowerCase()===".glb"){var o;Cf.parse("filename.glb","",a,this.device,this.assets,(o=s==null?void 0:s.options)!=null?o:{},(l,c)=>{if(l)t(l);else{var d;const h=c.animations;if(s!=null&&(d=s.data)!=null&&d.events)for(let u=0;u<h.length;u++)h[u].events=new cT(Object.values(s.data.events));c.destroy(),t(null,h)}})}else t(null,this["_parseAnimationV"+a.animation.version](a))})}open(e,t,s){return t}_parseAnimationV3(e){const t=e.animation,s=new Qa;s.name=t.name,s.duration=t.duration;for(let i=0;i<t.nodes.length;i++){const n=new kS,a=t.nodes[i];n._name=a.name;for(let o=0;o<a.keys.length;o++){const l=a.keys[o],c=l.time,d=l.pos,h=l.rot,u=l.scale,f=new y(d[0],d[1],d[2]),p=new re().setFromEulerAngles(h[0],h[1],h[2]),_=new y(u[0],u[1],u[2]),m=new FS(c,f,p,_);n._keys.push(m)}s.addNode(n)}return s}_parseAnimationV4(e){const t=e.animation,s=new Qa;s.name=t.name,s.duration=t.duration;for(let i=0;i<t.nodes.length;i++){const n=new kS,a=t.nodes[i];n._name=a.name;const o=a.defaults.p,l=a.defaults.r,c=a.defaults.s;for(let d=0;d<a.keys.length;d++){const h=a.keys[d],u=h.t,f=o||h.p,p=l||h.r,_=c||h.s,m=new y(f[0],f[1],f[2]),g=new re().setFromEulerAngles(p[0],p[1],p[2]),v=new y(_[0],_[1],_[2]),x=new FS(u,m,g,v);n._keys.push(x)}s.addNode(n)}return s}}class B3 extends Ze{constructor(e){super(e,"animclip")}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=be.ResponseType.JSON),at.get(e.load,s,function(i,n){i?t(`Error loading animation clip resource: ${e.original} [${i}]`):t(null,n)})}open(e,t){const s=t.name,i=t.duration,n=t.inputs.map(function(l){return new Tf(1,l)}),a=t.outputs.map(function(l){return new Tf(l.components,l.data)}),o=t.curves.map(function(l){return new HT([l.path],l.inputIndex,l.outputIndex,l.interpolation)});return new qn(s,i,n,a,o)}}class N3 extends Ze{constructor(e){super(e,"animstategraph")}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=be.ResponseType.JSON),at.get(e.load,s,function(i,n){i?t(`Error loading animation state graph resource: ${e.original} [${i}]`):t(null,n)})}open(e,t){return new $u(t)}}const u_=function(){if(typeof window>"u")return!1;const r=window.navigator.userAgent,e=r.indexOf("MSIE ");if(e>0)return parseInt(r.substring(e+5,r.indexOf(".",e)),10);if(r.indexOf("Trident/")>0){const s=r.indexOf("rv:");return parseInt(r.substring(s+3,r.indexOf(".",s)),10)}return!1}(),U3=[".ogg",".mp3",".wav",".mp4a",".m4a",".mp4",".aac",".opus"];class z3 extends Ze{constructor(e){super(e,"audio"),this.manager=e.soundManager}_isSupported(e){const t=me.getExtension(e);return U3.indexOf(t)>-1}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s=function(a){t(null,new rI(a))},i=function(a){let o="Error loading audio url: "+e.original;a&&(o+=": "+(a.message||a)),console.warn(o),t(o)};if(this._createSound){if(!this._isSupported(e.original)){i(`Audio format for ${e.original} not supported`);return}this._createSound(e.load,s,i)}else i(null)}_createSound(e,t,s){if(jn()){const i=this.manager;if(!i.context){s("Audio manager has no audio context");return}const n={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.startsWith("blob:")||e.startsWith("data:"))&&(n.responseType=be.ResponseType.ARRAY_BUFFER),at.get(e,n,function(a,o){if(a){s(a);return}i.context.decodeAudioData(o,t,s)})}else{let i=null;try{i=new Audio}catch{s("No support for Audio element");return}u_&&document.body.appendChild(i);const n=function a(){i.removeEventListener("canplaythrough",a),u_&&document.body.removeChild(i),t(i)};i.onerror=function(){i.onerror=null,u_&&document.body.removeChild(i),s()},i.addEventListener("canplaythrough",n),i.src=e}}}class V3 extends Ze{constructor(e){super(e,"binary")}load(e,t){typeof e=="string"&&(e={load:e,original:e}),at.get(e.load,{responseType:be.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?t(`Error loading binary resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){return e.buffer}}class wr{constructor(e,t,s,i){const n=function(d,h,u){const f=wr.createAsset(t.name,d,h,u);return s.add(f),f},a=[];for(let c=0;c<e.renders.length;++c)a.push(n("render",e.renders[c],c));const o=[];for(let c=0;c<e.materials.length;++c)o.push(n("material",e.materials[c],c));const l=[];for(let c=0;c<e.animations.length;++c)l.push(n("animation",e.animations[c],c));this.data=e,this._model=null,this._assetName=t.name,this._assets=s,this._defaultMaterial=i,this.renders=a,this.materials=o,this.textures=e.textures,this.animations=l}get model(){if(!this._model){const e=wr.createModel(this.data,this._defaultMaterial),t=wr.createAsset(this._assetName,"model",e,0);this._assets.add(t),this._model=t}return this._model}static createAsset(e,t,s,i){const n=new ne(e+"/"+t+"/"+i,t,{url:""});return n.resource=s,n.loaded=!0,n}instantiateModelEntity(e){const t=new $;return t.addComponent("model",Object.assign({type:"asset",asset:this.model},e)),t}instantiateRenderEntity(e){const t=this._defaultMaterial,s=[],i=function(l,c,d,h,u,f,p){const _=u[d.id],m=_===void 0?t:h[_],g=new Fe(d,m);return d.morph&&(g.morphInstance=new Ja(d.morph)),p.hasOwnProperty("skin")&&s.push({meshInstance:g,rootBone:l,entity:c}),g},n=(o,l,c)=>{const d=new $;l._cloneInternal(d),o||(o=d);let h=null,u=null;for(let p=0;p<c.nodes.length;p++)if(c.nodes[p]===l){const m=c.gltf.nodes[p];if(m.hasOwnProperty("mesh")){const g=c.renders[m.mesh].meshes;u=this.renders[m.mesh];for(let v=0;v<g.length;v++){const x=g[v];if(x){const S=i(o,d,x,c.materials,c.meshDefaultMaterials,c.skins,m);h||(h=[]),h.push(S)}}}if(c.lights){const g=c.lights.get(m);g&&d.addChild(g.clone())}if(c.cameras){const g=c.cameras.get(m);g&&g.camera.system.cloneComponent(g,d)}}h&&(d.addComponent("render",Object.assign({type:"asset",meshInstances:h,rootBone:o},e)),d.render.assignAsset(u));const f=l.children;for(let p=0;p<f.length;p++){const _=n(o,f[p],c);d.addChild(_)}return d},a=[];for(const o of this.data.scenes)a.push(n(null,o,this.data));return s.forEach(o=>{o.meshInstance.skinInstance=ti.createCachedSkinInstance(o.meshInstance.mesh.skin,o.rootBone,o.entity)}),wr.createSceneHierarchy(a,"Entity")}getMaterialVariants(){return this.data.variants?Object.keys(this.data.variants):[]}applyMaterialVariant(e,t){const s=t?this.data.variants[t]:null;if(s===void 0)return;const i=e.findComponents("render");for(let n=0;n<i.length;n++){const a=i[n];this._applyMaterialVariant(s,a.meshInstances)}}applyMaterialVariantInstances(e,t){const s=t?this.data.variants[t]:null;s!==void 0&&this._applyMaterialVariant(s,e)}_applyMaterialVariant(e,t){t.forEach(s=>{if(e===null)s.material=this._defaultMaterial;else{const i=this.data.meshVariants[s.mesh.id];i&&(s.material=this.data.materials[i[e]])}})}static createSceneHierarchy(e,t){let s=null;if(e.length===1)s=e[0];else{s=new t("SceneGroup");for(const i of e)s.addChild(i)}return s}static createModel(e,t){const s=function(o,l,c,d,h,u,f){const p=e.meshDefaultMaterials[l.id],_=p===void 0?t:h[p],m=new Fe(l,_,u);if(l.morph){const g=new Ja(l.morph);m.morphInstance=g,o.morphInstances.push(g)}if(f.hasOwnProperty("skin")){const g=f.skin,v=c[g];l.skin=v;const x=d[g];m.skinInstance=x,o.skinInstances.push(x)}o.meshInstances.push(m)},i=new $n,n=[];for(const a of e.skins){const o=new Td(a);o.bones=a.bones,n.push(o)}i.graph=wr.createSceneHierarchy(e.scenes,"GraphNode");for(let a=0;a<e.nodes.length;a++){const o=e.nodes[a];if(o.root===i.graph){const l=e.gltf.nodes[a];if(l.hasOwnProperty("mesh")){const c=e.renders[l.mesh].meshes;for(let d=0;d<c.length;d++){const h=c[d];h&&s(i,h,e.skins,n,e.materials,o,l)}}}}return i}destroy(){const e=this._assets,t=function(n){e.remove(n),n.unload()},s=function(n){n.forEach(function(a){t(a)})};this.animations&&(s(this.animations),this.animations=null),this.textures&&(s(this.textures),this.textures=null),this.materials&&(s(this.materials),this.materials=null),this.renders&&(s(this.renders),this.renders=null),this._model&&(t(this._model),this._model=null),this.data=null,this.assets=null}}class G3{constructor(e,t,s){this._device=e,this._assets=t,this._defaultMaterial=Cf.createDefaultMaterial(),this.maxRetries=s}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}load(e,t,s){ne.fetchArrayBuffer(e.load,(i,n)=>{i?t(i):Cf.parse(this._getUrlWithoutParams(e.original),me.extractPath(e.load),n,this._device,s.registry,s.options,(a,o)=>{a?t(a):t(null,new wr(o,s,this._assets,this._defaultMaterial))})},s,this.maxRetries)}open(e,t,s){return t}patch(e,t){}}class H3 extends Ze{constructor(e){super(e,"container"),this.glbContainerParser=new G3(e.graphicsDevice,e.assets,0),this.parsers={}}set maxRetries(e){this.glbContainerParser.maxRetries=e;for(const t in this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e)}get maxRetries(){return this.glbContainerParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){const t=e?me.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".",""):null;return this.parsers[t]||this.glbContainerParser}load(e,t,s){typeof e=="string"&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s)}open(e,t,s){return this._getParser(e).open(e,t,s)}}class W3 extends Ze{constructor(e){super(e,"css"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e}),at.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?t(`Error loading css resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){var t;return(t=this.decoder)!=null||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}}class j3 extends Ze{constructor(e){super(e,"cubemap"),this._device=e.graphicsDevice,this._registry=e.assets,this._loader=e.loader}load(e,t,s){this.loadAssets(s,t)}open(e,t,s){return s?s.resource:null}patch(e,t){this.loadAssets(e,function(s,i){s&&(t.fire("error",e),t.fire("error:"+e.id,s,e),e.fire("error",e))})}getAssetIds(e){const t=[];if(t[0]=e.file,(e.loadFaces||!e.file)&&e.data&&e.data.textures)for(let s=0;s<6;++s)t[s+1]=e.data.textures[s];else t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=null;return t}compareAssetIds(e,t){return e&&t?parseInt(e,10)===e||typeof e=="string"?e===t:e.url===t.url:e!==null==(t!==null)}update(e,t,s){const i=e.data||{},n=e._handlerState.assets,a=e._resources;let o,l,c;const d=[null,null,null,null,null,null,null],h=function(){return i.hasOwnProperty("type")?i.type:i.hasOwnProperty("rgbm")?i.rgbm?Qi:ps:null};if(!e.loaded||s[0]!==n[0]){if(s[0])if(o=s[0].resource,o.cubemap)for(c=0;c<6;++c)d[c+1]=new _e(this._device,{name:e.name+"_prelitCubemap"+(o.width>>c),cubemap:!0,type:h()||o.type,width:o.width>>c,height:o.height>>c,format:o.format,levels:[o._levels[c]],fixCubemapSeams:!0,addressU:ae,addressV:ae,mipmaps:c===0});else o.type=Rl,o.addressU=ae,o.addressV=ae,o.mipmaps=!1,d[1]=o}else d[1]=a[1]||null,d[2]=a[2]||null,d[3]=a[3]||null,d[4]=a[4]||null,d[5]=a[5]||null,d[6]=a[6]||null;const u=s.slice(1);if(!e.loaded||!this.cmpArrays(u,n.slice(1))){if(u.indexOf(null)===-1){var f;const p=u.map(function(v){return v.resource}),_=[];for(l=0;l<p[0]._levels.length;++l)_.push(p.map(function(v){return v._levels[l]}));const m=p[0].format,g=new _e(this._device,{name:e.name+"_faces",cubemap:!0,type:h()||p[0].type,width:p[0].width,height:p[0].height,format:m===Gn?xe:m,mipmaps:(f=i.mipmaps)!=null?f:!0,levels:_,minFilter:i.hasOwnProperty("minFilter")?i.minFilter:p[0].minFilter,magFilter:i.hasOwnProperty("magFilter")?i.magFilter:p[0].magFilter,anisotropy:i.hasOwnProperty("anisotropy")?i.anisotropy:1,addressU:ae,addressV:ae,fixCubemapSeams:!!s[0]});d[0]=g}}else d[0]=a[0]||null;if(!this.cmpArrays(d,a))for(e.resources=d,e._handlerState.assetIds=t,e._handlerState.assets=s,c=0;c<a.length;++c)a[c]!==null&&d.indexOf(a[c])===-1&&a[c].destroy();for(c=0;c<n.length;++c)n[c]!==null&&s.indexOf(n[c])===-1&&n[c].unload()}cmpArrays(e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;++s)if(e[s]!==t[s])return!1;return!0}resolveId(e){const t=parseInt(e,10);return t===e||t.toString()===e?t:e}loadAssets(e,t){e.hasOwnProperty("_handlerState")||(e._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});const s=this,i=s.getAssetIds(e),n=[null,null,null,null,null,null,null],a=e._handlerState.assetIds,o=e._handlerState.assets,l=s._registry;let c=7;const d=function(_,m){n[_]=m,c--,c===0&&(s.update(e,i,n),t(null,e.resources))},h=function(_,m,g){t(m)},u=function(_,m){m.loaded?d(_,m):(l.once("load:"+m.id,d.bind(s,_)),l.once("error:"+m.id,h.bind(s,_)),m.loading||l.load(m))};let f;for(let p=0;p<7;++p){const _=this.resolveId(i[p]);if(!_)d(p,null);else if(s.compareAssetIds(_,a[p]))d(p,o[p]);else if(parseInt(_,10)===_)f=l.get(_),f?u(p,f):setTimeout((function(m,g){const v=l.get(g);v?u(m,v):h(m,"failed to find dependent cubemap asset="+g)}).bind(null,p,_));else{const m=typeof _=="string"?{url:_,filename:_}:_;f=new ne(e.name+"_part_"+p,"texture",m),l.add(f),l.once("load:"+f.id,d.bind(s,p)),l.once("error:"+f.id,h.bind(s,p)),l.load(f)}}}}class $3 extends Ze{constructor(e){super(e,"folder")}load(e,t){t(null,null)}}class Ix{constructor(e,t){this.type=t&&t.type||Sf,this.em=1,this.textures=e,this.intensity=0,this._data=null,this.data=t}set data(e){if(this._data=e,!!e&&(this._data.intensity!==void 0&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),(!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)))for(const t in this._data.chars)this._data.chars[t].map=0}get data(){return this._data}}function f_(r){return r.version<3&&(r.version<2&&(r.info.maps=r.info.maps||[{width:r.info.width,height:r.info.height}]),r.chars=Object.keys(r.chars||{}).reduce(function(e,t){const s=r.chars[t],i=s.letter!==void 0?s.letter:yl.fromCodePoint(t);return r.version<2&&(s.map=s.map||0),e[i]=s,e},{}),r.version=3),r}class X3 extends Ze{constructor(e){super(e,"font"),this._loader=e.loader,this.maxRetries=0}load(e,t,s){typeof e=="string"&&(e={load:e,original:e});const i=this;me.getExtension(e.original)===".json"?at.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,a){if(n)t(`Error loading font resource: ${e.original} [${n}]`);else{const o=f_(a);i._loadTextures(e.load.replace(".json",".png"),o,function(l,c){l?t(l):t(null,{data:o,textures:c})})}}):(s&&s.data&&(s.data=f_(s.data)),this._loadTextures(e.load,s&&s.data,t))}_loadTextures(e,t,s){const i=t.info.maps.length;let n=0,a=null;const o=new Array(i),l=this._loader,c=function(h){const u=function(p,_){if(!a){if(p){a=p,s(p);return}_.upload(),o[h]=_,n++,n===i&&s(null,o)}};h===0?l.load(e,"texture",u):l.load(e.replace(".png",h+".png"),"texture",u)};for(let d=0;d<i;d++)c(d)}open(e,t,s){let i;return t.textures?i=new Ix(t.textures,t.data):i=new Ix(t,null),i}patch(e,t){const s=e.resource;!s.data&&e.data?s.data=e.data:!e.data&&s.data&&(e.data=s.data),e.data&&(e.data=f_(e.data))}}class q3{constructor(e,t){this.device=void 0,this.splatData=void 0,this.splat=null,this.device=e,this.splatData=t.isCompressed?t.decompress():t}destroy(){var e;this.device=null,this.splatData=null,(e=this.splat)==null||e.destroy(),this.splat=null}createSplat(){if(!this.splat){const e=this.splatData,t=new Re;this.splatData.calcAabb(t);const s=new ok(this.device,e.numSplats,t);this.splat=s,s.updateColorData(e.getProp("f_dc_0"),e.getProp("f_dc_1"),e.getProp("f_dc_2"),e.getProp("opacity")),s.updateTransformData(e.getProp("x"),e.getProp("y"),e.getProp("z"),e.getProp("rot_0"),e.getProp("rot_1"),e.getProp("rot_2"),e.getProp("rot_3"),e.getProp("scale_0"),e.getProp("scale_1"),e.getProp("scale_2"));const i=e.getProp("x"),n=e.getProp("y"),a=e.getProp("z"),o=new Float32Array(this.splatData.numSplats*3);for(let l=0;l<this.splatData.numSplats;++l)o[l*3+0]=i[l],o[l*3+1]=n[l],o[l*3+2]=a[l];s.centers=o}return this.splat}instantiate(e={}){const t=this.createInstance(e),s=new $,i=s.addComponent("gsplat",{instance:t});return i.customAabb=t.splat.aabb.clone(),s}createInstance(e={}){const t=this.createSplat();return new n0(t,e)}}const Rx=new Uint8Array([112,108,121,10]),Lx=new Uint8Array([10,101,110,100,95,104,101,97,100,101,114,10]),Dx=new Map([["char",Int8Array],["uchar",Uint8Array],["short",Int16Array],["ushort",Uint16Array],["int",Int32Array],["uint",Uint32Array],["float",Float32Array],["double",Float64Array]]),K3=async(r,e=null)=>{const t=(f,p)=>{const _=new Uint8Array(f.byteLength+p.byteLength);return _.set(f),_.set(p,f.byteLength),_},s=(f,p)=>{const _=f.length-p.length;let m,g;for(m=0;m<=_;++m){for(g=0;g<p.length&&f[m+g]===p[g];++g);if(g===p.length)return m}return-1},i=(f,p)=>{if(f.length<p.length)return!1;for(let _=0;_<p.length;++_)if(f[_]!==p[_])return!1;return!0};let n,a;for(;;){const{value:f,done:p}=await r.read();if(p)throw new Error("Stream finished before end of header");if(n=n?t(n,f):f,n.length>=Rx.length&&!i(n,Rx))throw new Error("Invalid ply header");if(a=s(n,Lx),a!==-1)break}const l=new TextDecoder("ascii").decode(n.slice(0,a)).split(`
`).filter(f=>!f.startsWith("comment ")),c=[];for(let f=1;f<l.length;++f){const p=l[f].split(" ");switch(p[0]){case"format":if(p[1]!=="binary_little_endian")throw new Error("Unsupported ply format");break;case"element":c.push({name:p[1],count:parseInt(p[2],10),properties:[]});break;case"property":{if(!Dx.has(p[1]))throw new Error(`Unrecognized property data type '${p[1]}' in ply header`);const _=c[c.length-1],m=Dx.get(p[1]),g=!e||e(p[2])?new m(_.count):null;_.properties.push({type:p[1],name:p[2],storage:g,byteSize:m.BYTES_PER_ELEMENT});break}default:throw new Error(`Unrecognized header value '${p[0]}' in ply header`)}}let d=a+Lx.length,h=n.length-d,u=new DataView(n.buffer);for(let f=0;f<c.length;++f){const p=c[f];for(let _=0;_<p.count;++_)for(let m=0;m<p.properties.length;++m){const g=p.properties[m];for(;h<g.byteSize;){const{value:v,done:x}=await r.read();if(x)throw new Error("Stream finished before end of data");const S=new Uint8Array(h+v.byteLength);S.set(n.slice(d)),S.set(v,h),n=S,u=new DataView(n.buffer),d=0,h=n.length}if(g.storage)switch(g.type){case"char":g.storage[_]=u.getInt8(d);break;case"uchar":g.storage[_]=u.getUint8(d);break;case"short":g.storage[_]=u.getInt16(d,!0);break;case"ushort":g.storage[_]=u.getUint16(d,!0);break;case"int":g.storage[_]=u.getInt32(d,!0);break;case"uint":g.storage[_]=u.getUint32(d,!0);break;case"float":g.storage[_]=u.getFloat32(d,!0);break;case"double":g.storage[_]=u.getFloat64(d,!0);break}d+=g.byteSize,h-=g.byteSize}}return c},Y3=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","rot_0","rot_1","rot_2","rot_3","scale_0","scale_1","scale_2","min_x","min_y","min_z","max_x","max_y","max_z","min_scale_x","min_scale_y","min_scale_z","max_scale_x","max_scale_y","max_scale_z","packed_position","packed_rotation","packed_scale","packed_color"],Z3=new Set(Y3),J3=r=>Z3.has(r);class Q3{constructor(e,t,s){this.device=void 0,this.assets=void 0,this.maxRetries=void 0,this.device=e,this.assets=t,this.maxRetries=s}async load(e,t,s){const i=await fetch(e.load);if(!i||!i.body)t("Error loading resource",null);else{var n;K3(i.body.getReader(),(n=s.data.elementFilter)!=null?n:J3).then(a=>{t(null,new q3(this.device,new ic(a)))}).catch(a=>{t(a,null)})}}open(e,t){return t}}class ez extends Ze{constructor(e){super(e,"gsplat"),this.parser=new Q3(e.graphicsDevice,e.assets,3)}load(e,t,s){typeof e=="string"&&(e={load:e,original:e}),this.parser.load(e,t,s)}open(e,t,s){return this.parser.open(e,t,s)}}class Vg{static setCompressedPRS(e,t,s){const i=s.singleVecs;let n,a;const o=t.___1;o||(n=s.tripleVecs,a=t.___2);let l=o?o[0]:n[a];e.setLocalPosition(i[l],i[l+1],i[l+2]),l=o?o[1]:n[a+1],e.setLocalEulerAngles(i[l],i[l+1],i[l+2]),l=o?o[2]:n[a+2],e.setLocalScale(i[l],i[l+1],i[l+2])}static oneCharToKey(e,t){const s=e.charCodeAt(0)-t.fieldFirstCode;return t.fieldArray[s]}static multCharToKey(e,t){let s=0;for(let i=0;i<e.length;i++)s=s*t.fieldCodeBase+e.charCodeAt(i)-t.fieldFirstCode;return t.fieldArray[s]}}class Af{constructor(e,t){this._node=e,this._data=t}run(){const e=Object.prototype.toString.call(this._node);return e==="[object Object]"?this._handleMap():e==="[object Array]"?this._handleArray():this._result=this._node,this._result}_handleMap(){this._result={},Object.keys(this._node).forEach(this._handleKey,this)}_handleKey(e){let t=e;const s=e.length;s===1?t=Vg.oneCharToKey(e,this._data):s===2&&(t=Vg.multCharToKey(e,this._data)),this._result[t]=new Af(this._node[e],this._data).run()}_handleArray(){this._result=[],this._node.forEach(this._handleArElt,this)}_handleArElt(e){const t=new Af(e,this._data).run();this._result.push(t)}}class S0{constructor(e,t){this._app=e,this._isTemplate=t}parse(e){const t={};let s=null;const i=e.compressedFormat;i&&!e.entDecompressed&&(e.entDecompressed=!0,e.entities=new Af(e.entities,i).run());for(const n in e.entities){const a=e.entities[n],o=this._createEntity(a,i);t[n]=o,a.parent===null&&(s=o)}for(const n in e.entities){const a=t[n],o=e.entities[n].children,l=o.length;for(let c=0;c<l;c++){const d=t[o[c]];d&&a.addChild(d)}}return this._openComponentData(s,e.entities),s}_createEntity(e,t){var s;const i=new $(e.name,this._app);if(i.setGuid(e.resource_id),this._setPosRotScale(i,e,t),i._enabled=(s=e.enabled)!=null?s:!0,this._isTemplate?i._template=!0:i._enabledInHierarchy=i._enabled,i.template=e.template,e.tags)for(let n=0;n<e.tags.length;n++)i.tags.add(e.tags[n]);return e.labels&&e.labels.forEach(function(n){i.addLabel(n)}),i}_setPosRotScale(e,t,s){if(s)Vg.setCompressedPRS(e,t,s);else{const i=t.position,n=t.rotation,a=t.scale;e.setLocalPosition(i[0],i[1],i[2]),e.setLocalEulerAngles(n[0],n[1],n[2]),e.setLocalScale(a[0],a[1],a[2])}}_openComponentData(e,t){const s=this._app.systems.list;let i=s.length;const n=t[e.getGuid()];for(let o=0;o<i;o++){const l=s[o],c=n.components[l.id];c&&l.addComponent(e,c)}i=n.children.length;const a=e._children;for(let o=0;o<i;o++)a[o]&&(a[o]=this._openComponentData(a[o],t));return e}}class XT{static load(e,t,s){typeof e=="string"&&(e={load:e,original:e}),at.get(e.load,{retry:t>0,maxRetries:t},function(i,n){if(!i)s(i,n);else{let a="Error while loading scene JSON "+e.original;i.message?(a+=": "+i.message,i.stack&&(a+=`
`+i.stack)):a+=": "+i,s(a)}})}}class tz extends Ze{constructor(e){super(e,"hierarchy")}load(e,t){XT.load(e,this.maxRetries,t)}open(e,t){this._app.systems.script.preloading=!0;const i=new S0(this._app,!1).parse(t);return this._app.systems.script.preloading=!1,i}}class sz extends Ze{constructor(e){super(e,"html"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e}),at.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?t(`Error loading html resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){var t;return(t=this.decoder)!=null||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}}class iz extends Ze{constructor(e){super(e,"json"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=be.ResponseType.JSON),at.get(e.load,s,function(i,n){i?t(`Error loading JSON resource: ${e.original} [${i}]`):t(null,n)})}openBinary(e){var t;return(t=this.decoder)!=null||(this.decoder=new TextDecoder("utf-8")),JSON.parse(this.decoder.decode(e))}}class nz{constructor(){this.removeInvalid=!0,this.valid=!0,this.enumValidators={occludeSpecular:this._createEnumValidator([xI,Cc,rg]),cull:this._createEnumValidator([Et,Dr,Xh,HA]),blendType:this._createEnumValidator([Eb,ky,Bt,ms,qa,By,Ny,Cb,Ab,Pb,Mb]),depthFunc:this._createEnumValidator([WA,_y,tf,G_,jA,$A,XA,kn]),shadingModel:this._createEnumValidator([tn,yd])}}setInvalid(e,t){this.valid=!1,this.removeInvalid&&delete t[e]}validate(e){const t=Hl,s=PO,i=e.mappingFormat==="path";for(const n in e){const a=t[n];if(!a){s[n]?delete e[n]:this.valid=!1;continue}if(a.startsWith("enum")){const o=a.split(":")[1];this.enumValidators[o]&&(this.enumValidators[o](e[n])||this.setInvalid(n,e))}else if(a==="number")typeof e[n]!="number"&&this.setInvalid(n,e);else if(a==="boolean")typeof e[n]!="boolean"&&this.setInvalid(n,e);else if(a==="string")typeof e[n]!="string"&&this.setInvalid(n,e);else if(a==="vec2")e[n]instanceof Array&&e[n].length===2||this.setInvalid(n,e);else if(a==="rgb")e[n]instanceof Array&&e[n].length===3||this.setInvalid(n,e);else if(a==="texture")i?typeof e[n]=="string"||e[n]===null||e[n]instanceof _e||this.setInvalid(n,e):typeof e[n]=="number"||e[n]===null||e[n]instanceof _e||this.setInvalid(n,e);else if(a==="boundingbox")e[n].center&&e[n].center instanceof Array&&e[n].center.length===3||this.setInvalid(n,e),e[n].halfExtents&&e[n].halfExtents instanceof Array&&e[n].halfExtents.length===3||this.setInvalid(n,e);else if(a==="cubemap")typeof e[n]=="number"||e[n]===null||e[n]===void 0||e[n]instanceof _e&&e[n].cubemap||this.setInvalid(n,e);else if(a==="chunks"){const o=Object.keys(e[n]);for(let l=0;l<o.length;l++)typeof e[n][o[l]]!="string"&&this.setInvalid(o[l],e[n])}else console.error("Unknown material type: "+a)}return e.validated=!0,this.valid}_createEnumValidator(e){return function(t){return e.indexOf(t)>=0}}}class rz{constructor(){this._validator=null}parse(e){const t=this.migrate(e),s=this._validate(t),i=new Gs;return this.initialize(i,s),i}initialize(e,t){t.validated||(t=this._validate(t)),t.chunks&&(e.chunks=Ft({},t.chunks));for(const s in t){const i=Hl[s],n=t[s];if(i==="vec2")e[s]=new M(n[0],n[1]);else if(i==="rgb")e[s]=new k(n[0],n[1],n[2]);else if(i==="texture")n instanceof _e?e[s]=n:e[s]instanceof _e&&typeof n=="number"&&n>0||(e[s]=null);else if(i==="cubemap")n instanceof _e?e[s]=n:e[s]instanceof _e&&typeof n=="number"&&n>0||(e[s]=null),s==="cubeMap"&&!n&&(e.prefilteredCubemaps=null);else if(i==="boundingbox"){const a=new y(n.center[0],n.center[1],n.center[2]),o=new y(n.halfExtents[0],n.halfExtents[1],n.halfExtents[2]);e[s]=new Re(a,o)}else e[s]=t[s]}e.update()}migrate(e){e.shadingModel===void 0&&(e.shader==="blinn"?e.shadingModel=yd:e.shadingModel=tn),e.shader&&delete e.shader,e.mapping_format&&(e.mappingFormat=e.mapping_format,delete e.mapping_format);let t;const s=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["diffuseMapTint","diffuseTint"],["specularMapTint","specularTint"],["emissiveMapTint","emissiveTint"],["metalnessMapTint","metalnessTint"],["clearCoatGlossiness","clearCoatGloss"]];for(t=0;t<s.length;t++){const n=s[t][0],a=s[t][1];e[n]!==void 0&&(e[a]===void 0&&(e[a]=e[n]),delete e[n])}const i=["fresnelFactor","shadowSampleType"];for(t=0;t<i.length;t++){const n=i[t];e.hasOwnProperty(n)&&delete e[n]}return e}_validate(e){return e.validated||(this._validator||(this._validator=new nz),this._validator.validate(e)),e}}const az={aoMap:"white",diffuseMap:"gray",specularMap:"gray",specularityFactorMap:"white",metalnessMap:"black",glossMap:"gray",sheenMap:"black",sheenGlossinessMap:"gray",clearCoatMap:"black",clearCoatGlossMap:"gray",clearCoatNormalMap:"normal",refractionMap:"white",emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white"};class oz extends Ze{constructor(e){super(e,"material"),this._assets=e.assets,this._device=e.graphicsDevice,this._placeholderTextures=null,this._parser=new rz}load(e,t){typeof e=="string"&&(e={load:e,original:e}),at.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?t&&t(`Error loading material: ${e.original} [${s}]`):t&&(i._engine=!0,t(null,i))})}open(e,t){const s=this._parser.parse(t);return t._engine&&(s._data=t,delete t._engine),s}_createPlaceholders(){this._placeholderTextures={};const e={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]};for(const t in e){if(!e.hasOwnProperty(t))continue;this._placeholderTextures[t]=new _e(this._device,{width:2,height:2,format:xe,name:"material_placeholder"});const s=this._placeholderTextures[t].lock();for(let i=0;i<4;i++)for(let n=0;n<4;n++)s[i*4+n]=e[t][n];this._placeholderTextures[t].unlock()}}patch(e,t){e.resource._data&&(e._data=e.resource._data,delete e.resource._data),e.data.name=e.name,e.resource.name=e.name,this._bindAndAssignAssets(e,t),e.off("unload",this._onAssetUnload,this),e.on("unload",this._onAssetUnload,this)}_onAssetUnload(e){delete e.data.parameters,delete e.data.chunks,delete e.data.name}_assignTexture(e,t,s){t.resource[e]=s}_getPlaceholderTexture(e){this._placeholderTextures||this._createPlaceholders();const t=az[e];return this._placeholderTextures[t]}_assignPlaceholderTexture(e,t){t.resource[e]=this._getPlaceholderTexture(e)}_onTextureLoad(e,t,s){this._assignTexture(e,t,s.resource),t.resource.update()}_onTextureAdd(e,t,s){this._assets.load(s)}_onTextureRemoveOrUnload(e,t,s){const i=t.resource;i&&t.resource[e]===s.resource&&(this._assignPlaceholderTexture(e,t),i.update())}_assignCubemap(e,t,s){if(t.resource[e]=s[0],e==="cubeMap"){const i=s.slice(1);i.every(n=>n)?t.resource.prefilteredCubemaps=i:i[0]&&(t.resource.envAtlas=i[0])}}_onCubemapLoad(e,t,s){this._assignCubemap(e,t,s.resources),this._parser.initialize(t.resource,t.data)}_onCubemapAdd(e,t,s){t.data.shadingModel===tn&&(t.loadFaces=!0),this._assets.load(s)}_onCubemapRemoveOrUnload(e,t,s){const i=t.resource;t.data.prefilteredCubeMap128===s.resources[1]&&(this._assignCubemap(e,t,[null,null,null,null,null,null,null]),i.update())}_bindAndAssignAssets(e,t){const s=this._parser.migrate(e.data),i=e.resource,n=s.mappingFormat==="path",a=Yp;let o,l,c;for(o=0;o<a.length;o++){l=a[o],c=i._assetReferences[l];const h=s[l],u=i[l],f=u===this._getPlaceholderTexture(l),p=s.validated;h&&(!u||!p||f)?(c||(c=new Uc(l,e,t,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemoveOrUnload,unload:this._onTextureRemoveOrUnload},this),i._assetReferences[l]=c),n?c.url=e.getAbsoluteUrl(h):c.id=h,c.asset&&(c.asset.resource?this._assignTexture(l,e,c.asset.resource):this._assignPlaceholderTexture(l,e),t.load(c.asset))):c&&(n?c.url=null:c.id=null)}const d=Qy;for(o=0;o<d.length;o++)l=d[o],c=i._assetReferences[l],s[l]&&!e.data.prefilteredCubeMap128&&(c||(c=new Uc(l,e,t,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemoveOrUnload,unload:this._onCubemapRemoveOrUnload},this),i._assetReferences[l]=c),n?c.url=s[l]:c.id=s[l],c.asset&&(c.asset.loaded&&this._assignCubemap(l,e,c.asset.resources),t.load(c.asset)));this._parser.initialize(i,s)}}class lz{constructor(e){this._device=e.device,this._defaultMaterial=e.defaultMaterial,this._assets=e.assets}parse(e,t,s){var i;Cf.parse("filename.glb","",e,this._device,this._assets,(i=s==null?void 0:s.options)!=null?i:{},(n,a)=>{if(n)t(n);else{const o=wr.createModel(a,this._defaultMaterial);a.destroy(),t(null,o)}})}}class hz{constructor(){this.index=0,this.boneIndices=[0,0,0,0]}}class cz{constructor(){this.partition=0,this.vertexStart=0,this.vertexCount=0,this.indexStart=0,this.indexCount=0,this.boneIndices=[],this.vertices=[],this.indices=[],this.indexMap={},this.originalMesh=null}addVertex(e,t,s){let i=-1;if(this.indexMap[t]!==void 0)i=this.indexMap[t],this.indices.push(i);else{for(let n=0;n<4;n++){if(s.blendWeight.data[t*4+n]===0)continue;const a=s.blendIndices.data[e.index*4+n];e.boneIndices[n]=this.getBoneRemap(a)}i=this.vertices.length,this.indices.push(i),this.vertices.push(e),this.indexMap[t]=i}}addPrimitive(e,t,s,i){const n=[];let a=0;const o=e.length;for(let l=0;l<o;l++){const d=e[l].index;for(let h=0;h<4;h++)if(s.blendWeight.data[d*4+h]>0){const u=s.blendIndices.data[d*4+h];let f=!0;for(let p=0;p<a;p++)if(n[p]===u){f=!1;break}if(f){n[a]=u;const p=this.getBoneRemap(u);a+=p===-1?1:0}}}if(this.boneIndices.length+a>i)return!1;for(let l=0;l<a;l++)this.boneIndices.push(n[l]);for(let l=0;l<o;l++)this.addVertex(e[l],t[l],s);return!0}getBoneRemap(e){for(let t=0;t<this.boneIndices.length;t++)if(this.boneIndices[t]===e)return t;return-1}}function dz(r){const e=r.vertices,t=r.skins,s=r.meshes,i=r.meshInstances;for(let n=0;n<s.length;n++)s[n].vertices=e[s[n].vertices],s[n].skin!==void 0&&(s[n].skin=t[s[n].skin]);for(let n=0;n<i.length;n++)i[n].mesh=s[i[n].mesh]}function uz(r){const e=r.vertices,t=r.skins,s=r.meshes,i=r.meshInstances;for(let n=0;n<s.length;n++)s[n].vertices=e.indexOf(s[n].vertices),s[n].skin!==void 0&&(s[n].skin=t.indexOf(s[n].skin));for(let n=0;n<i.length;n++)i[n].mesh=s.indexOf(i[n].mesh)}function fz(r,e,t){let s,i,n,a;dz(r);const o=r.vertices,l=r.skins;let c;const d=r.meshes,h=r.meshInstances,u=function(p){const _=new hz;return _.index=p,_};for(s=l.length-1;s>=0;s--)if(l[s].boneNames.length>t){const f=l.splice(s,1)[0],p=[];for(i=0;i<d.length;i++)d[i].skin===f&&p.push(d[i]);for(i=0;i<p.length;i++)a=d.indexOf(p[i]),a!==-1&&d.splice(a,1);if(p.length===0)throw new Error("partitionSkin: There should be at least one mesh that references a skin");const _=p[0].vertices;for(i=1;i<p.length;i++)if(p[i].vertices!==_)throw new Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");let m;const g=[],v=[],x=[];let S=0;for(i=0;i<p.length;i++){c=p[i];const V=c.indices;for(let I=c.base;I<c.base+c.count;){a=V[I++],v[0]=u(a),x[0]=a,a=V[I++],v[1]=u(a),x[1]=a,a=V[I++],v[2]=u(a),x[2]=a;let F=!1;for(let D=S;D<g.length;D++)if(m=g[D],m.addPrimitive(v,x,_,t)){F=!0;break}F||(m=new cz,m.originalMesh=c,m.addPrimitive(v,x,_,t),g.push(m))}S=g.length}const w=[],T=[];for(i=0;i<g.length;i++)if(m=g[i],m.vertices.length&&m.indices.length){const V=w.length,I=m.vertices.length,F=T.length,D=m.indices.length;m.partition=i,m.vertexStart=V,m.vertexCount=I,m.indexStart=F,m.indexCount=D;let A,N;for(A=0,N=V;A<I;)w[N++]=m.vertices[A++];for(A=0,N=F;A<D;)T[N++]=m.indices[A++]+V}const b=[];for(i=0;i<g.length;i++){m=g[i];const V=[],I=[];for(n=0;n<m.boneIndices.length;n++)V.push(f.inverseBindMatrices[m.boneIndices[n]]),I.push(f.boneNames[m.boneIndices[n]]);const F={inverseBindMatrices:V,boneNames:I};b.push(F),l.push(F)}let C,E,R,B;const L={};for(E in _)L[E]={components:_[E].components,data:[],type:_[E].type};for(E in _)if(E==="blendIndices"){const V=L[E].data;for(i=0;i<w.length;i++){const I=w[i].boneIndices;V.push(I[0],I[1],I[2],I[3])}}else for(C=_[E],R=C.data,B=C.components,i=0;i<w.length;i++)for(a=w[i].index,n=0;n<B;n++)L[E].data.push(R[a*B+n]);for(o[o.indexOf(_)]=L,i=0;i<g.length;i++)for(m=g[i],c={aabb:{min:[0,0,0],max:[0,0,0]},vertices:L,skin:b[i],indices:T.splice(0,m.indexCount),type:"triangles",base:0,count:m.indexCount},d.push(c),n=h.length-1;n>=0;n--)h[n].mesh===m.originalMesh&&(h.push({mesh:c,node:h[n].node}),e&&e.push({material:e[n].material,path:e[n].path}));for(i=0;i<g.length;i++)for(m=g[i],n=h.length-1;n>=0;n--)h[n].mesh===m.originalMesh&&(h.splice(n,1),e&&e.splice(n,1))}uz(r)}const pz={points:Rp,lines:Lp,lineloop:tb,linestrip:sb,triangles:Ln,trianglestrip:Ji,trianglefan:Ia},mz={int8:ao,uint8:en,int16:oo,uint16:Wr,int32:fd,uint32:Ql,float32:Me};class _z{constructor(e){this._device=e.device,this._defaultMaterial=e.defaultMaterial}parse(e,t){const s=e.model;if(!s){t(null,null);return}if(s.version<=1){t("JsonModelParser#parse: Trying to parse unsupported model format.");return}const i=this._parseNodes(e),n=this._parseSkins(e,i),a=this._parseVertexBuffers(e),o=this._parseIndexBuffers(e,a),l=this._parseMorphs(e,i,a),c=this._parseMeshes(e,n.skins,l.morphs,a,o.buffer,o.data),d=this._parseMeshInstances(e,i,c,n.skins,n.instances,l.morphs,l.instances),h=new $n;h.graph=i[0],h.meshInstances=d,h.skinInstances=n.instances,h.morphInstances=l.instances,h.getGraph().syncHierarchy(),t(null,h)}_parseNodes(e){const t=e.model,s=[];let i;for(i=0;i<t.nodes.length;i++){const n=t.nodes[i],a=new ze(n.name);a.setLocalPosition(n.position[0],n.position[1],n.position[2]),a.setLocalEulerAngles(n.rotation[0],n.rotation[1],n.rotation[2]),a.setLocalScale(n.scale[0],n.scale[1],n.scale[2]),a.scaleCompensation=!!n.scaleCompensation,s.push(a)}for(i=1;i<t.parents.length;i++)s[t.parents[i]].addChild(s[i]);return s}_parseSkins(e,t){const s=e.model,i=[],n=[];let a,o;if(!this._device.supportsBoneTextures&&s.skins.length>0){const l=this._device.getBoneLimit();fz(s,null,l)}for(a=0;a<s.skins.length;a++){const l=s.skins[a],c=[];for(o=0;o<l.inverseBindMatrices.length;o++){const f=l.inverseBindMatrices[o];c[o]=new q().set(f)}const d=new eT(this._device,c,l.boneNames);i.push(d);const h=new Td(d),u=[];for(o=0;o<d.boneNames.length;o++){const f=d.boneNames[o],p=t[0].findByName(f);u.push(p)}h.bones=u,n.push(h)}return{skins:i,instances:n}}_getMorphVertexCount(e,t,s){for(let i=0;i<e.meshes.length;i++){const n=e.meshes[i];if(n.morph===t)return s[n.vertices].numVertices}}_parseMorphs(e,t,s){const i=e.model,n=[],a=[];let o,l,c,d,h,u;if(i.morphs){const f=function(_,m,g){const v=new Float32Array(g*3);for(let x=0;x<m.length;x++){const S=m[x]*3;v[S]=_[x*3],v[S+1]=_[x*3+1],v[S+2]=_[x*3+2]}return v};for(o=0;o<i.morphs.length;o++){for(d=i.morphs[o].targets,u=[],c=this._getMorphVertexCount(i,o,s),l=0;l<d.length;l++){const m=d[l].aabb,g=m.min,v=m.max,x=new Re(new y((v[0]+g[0])*.5,(v[1]+g[1])*.5,(v[2]+g[2])*.5),new y((v[0]-g[0])*.5,(v[1]-g[1])*.5,(v[2]-g[2])*.5)),S=d[l].indices;let w=d[l].deltaPositions,T=d[l].deltaNormals;S&&(w=f(w,S,c),T=f(T,S,c)),h=new Qp({deltaPositions:w,deltaNormals:T,name:d[l].name,aabb:x}),u.push(h)}const p=new s0(u,this._device);n.push(p);const _=new Ja(p);a.push(_)}}return{morphs:n,instances:a}}_parseVertexBuffers(e){const t=e.model,s=[],i={position:ht,normal:Us,tangent:ln,blendWeight:hn,blendIndices:Os,color:Zt,texCoord0:zs,texCoord1:Hr,texCoord2:nd,texCoord3:rd,texCoord4:ad,texCoord5:od,texCoord6:ld,texCoord7:hd};for(let n=0;n<t.vertices.length;n++){const a=t.vertices[n],o=[];for(const u in a){const f=a[u];o.push({semantic:i[u],components:f.components,type:mz[f.type],normalize:i[u]===Zt})}const l=new os(this._device,o),c=a.position.data.length/a.position.components,d=new Mi(this._device,l,c),h=new Jh(d);for(let u=0;u<c;u++){for(const f in a){const p=a[f];switch(p.components){case 1:h.element[i[f]].set(p.data[u]);break;case 2:h.element[i[f]].set(p.data[u*2],1-p.data[u*2+1]);break;case 3:h.element[i[f]].set(p.data[u*3],p.data[u*3+1],p.data[u*3+2]);break;case 4:h.element[i[f]].set(p.data[u*4],p.data[u*4+1],p.data[u*4+2],p.data[u*4+3]);break}}h.next()}h.end(),s.push(d)}return s}_parseIndexBuffers(e,t){const s=e.model;let i=null,n=null,a,o=0;for(a=0;a<s.meshes.length;a++){const c=s.meshes[a];c.indices!==void 0&&(o+=c.indices.length)}let l=0;for(a=0;a<t.length;a++)l=Math.max(l,t[a].numVertices);return o>0&&(l>65535&&this._device.extUintElement?(i=new Br(this._device,Fr,o),n=new Uint32Array(i.lock())):(i=new Br(this._device,ai,o),n=new Uint16Array(i.lock()))),{buffer:i,data:n}}_parseMeshes(e,t,s,i,n,a){const o=e.model,l=[];let c=0;for(let d=0;d<o.meshes.length;d++){const h=o.meshes[d],u=h.aabb,f=u.min,p=u.max,_=new Re(new y((p[0]+f[0])*.5,(p[1]+f[1])*.5,(p[2]+f[2])*.5),new y((p[0]-f[0])*.5,(p[1]-f[1])*.5,(p[2]-f[2])*.5)),m=h.indices!==void 0,g=new Vs(this._device);g.vertexBuffer=i[h.vertices],g.indexBuffer[0]=m?n:null,g.primitive[0].type=pz[h.type],g.primitive[0].base=m?h.base+c:h.base,g.primitive[0].count=h.count,g.primitive[0].indexed=m,g.skin=h.skin!==void 0?t[h.skin]:null,g.morph=h.morph!==void 0?s[h.morph]:null,g.aabb=_,m&&(a.set(h.indices,c),c+=h.indices.length),l.push(g)}return n!==null&&n.unlock(),l}_parseMeshInstances(e,t,s,i,n,a,o){const l=e.model,c=[];let d;for(d=0;d<l.meshInstances.length;d++){const h=l.meshInstances[d],u=t[h.node],f=s[h.mesh],p=new Fe(f,this._defaultMaterial,u);if(f.skin){const _=i.indexOf(f.skin);p.skinInstance=n[_]}if(f.morph){const _=a.indexOf(f.morph);p.morphInstance=o[_]}c.push(p)}return c}}class gz extends Ze{constructor(e){super(e,"model"),this._parsers=[],this.device=e.graphicsDevice,this.assets=e.assets,this.defaultMaterial=sh(this.device),this.addParser(new _z(this),function(t,s){return me.getExtension(t)===".json"}),this.addParser(new lz(this),function(t,s){return me.getExtension(t)===".glb"})}load(e,t,s){typeof e=="string"&&(e={load:e,original:e});const i={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.load.startsWith("blob:")||e.load.startsWith("data:"))&&(me.getExtension(e.original).toLowerCase()===".glb"?i.responseType=be.ResponseType.ARRAY_BUFFER:i.responseType=be.ResponseType.JSON),at.get(e.load,i,(n,a)=>{if(t)if(n)t(`Error loading model: ${e.original} [${n}]`);else{for(let o=0;o<this._parsers.length;o++){const l=this._parsers[o];if(l.decider(e.original,a)){l.parser.parse(a,(c,d)=>{c?t(c):t(null,d)},s);return}}t("No parsers found")}})}open(e,t){return t}patch(e,t){if(!e.resource)return;const s=e.data,i=this;e.resource.meshInstances.forEach(function(n,a){if(s.mapping){const o=function h(u){u.resource?n.material=u.resource:(u.once("load",h),t.load(u)),u.once("remove",function(f){n.material===f.resource&&(n.material=i.defaultMaterial)})};if(!s.mapping[a]){n.material=i.defaultMaterial;return}const l=s.mapping[a].material,c=s.mapping[a].path;let d;if(l!==void 0)l?(d=t.get(l),d?o(d):t.once("add:"+l,o)):n.material=i.defaultMaterial;else if(c){const h=e.getAbsoluteUrl(s.mapping[a].path);d=t.getByUrl(h),d?o(d):t.once("add:url:"+h,o)}}})}addParser(e,t){this._parsers.push({parser:e,decider:t})}}class yz extends Ze{constructor(e){super(e,"scene")}load(e,t){XT.load(e,this.maxRetries,t)}open(e,t){this._app.systems.script.preloading=!0;const i=new S0(this._app,!1).parse(t),n=this._app.scene;return n.root=i,this._app.applySceneSettings(t.settings),this._app.systems.script.preloading=!1,n}}const vz=new RegExp("^\\s*function(?:\\s|\\s*\\/\\*.*\\*\\/\\s*)+([^\\(\\s\\/]*)\\s*");class Rt extends ie{constructor(e){super(),this.app=void 0,this.entity=void 0,this._enabled=void 0,this._enabledOld=void 0,this._initialized=void 0,this._postInitialized=void 0,this.__destroyed=void 0,this.__attributes=void 0,this.__attributesRaw=void 0,this.__scriptType=void 0,this.__executionOrder=void 0,this.initScriptType(e)}set enabled(e){this._enabled=!!e,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),this.initialize&&this.entity.script._scriptMethod(this,Fg)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,kg)))}get enabled(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled}initScriptType(e){const t=this.constructor;this.app=e.app,this.entity=e.entity,this._enabled=typeof e.enabled=="boolean"?e.enabled:!0,this._enabledOld=this.enabled,this.__destroyed=!1,this.__attributes={},this.__attributesRaw=e.attributes||{},this.__scriptType=t,this.__executionOrder=-1}static __getScriptName(e){if(typeof e!="function")return;if("name"in Function.prototype)return e.name;if(e===Function||e===Function.prototype.constructor)return"Function";const t=(""+e).match(vz);return t?t[1]:void 0}static get scriptName(){return this.__name}static get attributes(){return this.hasOwnProperty("__attributes")||(this.__attributes=new qr(this)),this.__attributes}__initializeAttributes(e){if(!(!e&&!this.__attributesRaw)){for(const t in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(t)?this[t]=this.__attributesRaw[t]:this.__attributes.hasOwnProperty(t)||(this.__scriptType.attributes.index[t].hasOwnProperty("default")?this[t]=this.__scriptType.attributes.index[t].default:this[t]=null);this.__attributesRaw=null}}static extend(e){for(const t in e)e.hasOwnProperty(t)&&(this.prototype[t]=e[t])}}Rt.EVENT_ENABLE="enable";Rt.EVENT_DISABLE="disable";Rt.EVENT_STATE="state";Rt.EVENT_DESTROY="destroy";Rt.EVENT_ATTR="attr";Rt.EVENT_ERROR="error";Rt.__name=null;const Sz=new Set(["system","entity","create","destroy","swap","move","data","scripts","_scripts","_scriptsIndex","_scriptsData","enabled","_oldState","onEnable","onDisable","onPostStateChange","_onSetEnabled","_checkState","_onBeforeRemove","_onInitializeAttributes","_onInitialize","_onPostInitialize","_onUpdate","_onPostUpdate","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"]),xz={};qr.reservedNames.forEach((r,e,t)=>{xz[r]=1});function qT(r,e,t){if(r.legacy)return;if(typeof r!="function")throw new Error(`script class: '${r}' must be a constructor function (i.e. class).`);if(!(r.prototype instanceof Rt))throw new Error(`script class: '${Rt.__getScriptName(r)}' does not extend pc.ScriptType.`);if(e=e||r.__name||Rt.__getScriptName(r),Sz.has(e))throw new Error(`script name: '${e}' is reserved, please change script name`);r.__name=e,(t?t.scripts:gt.getApplication().scripts).add(r),ii.push(r,r.legacy)}class wz extends Ze{constructor(e){super(e,"script"),this._scripts={},this._cache={}}clearCache(){for(const e in this._cache){const t=this._cache[e],s=t.parentNode;s&&s.removeChild(t)}this._cache={}}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s=this;ns.app=this._app;const i=(e.load,(l,c,d)=>{if(l)t(l);else if(ns.legacy){let h=null;ii._types.length&&(h=ii._types.pop()),h?this._scripts[c]=h:h=null,t(null,h,d)}else{const h={};for(let u=0;u<ii._types.length;u++)h[ii._types[u].name]=ii._types[u];ii._types.length=0,t(null,h,d),delete s._loader._cache[Tl.makeKey(c,"script")]}}),[n,a]=e.load.split("?");if(n.endsWith(".mjs")){let l=e.load;l.startsWith(this._app.assets.prefix)&&(l=l.replace(this._app.assets.prefix,""));const c=this._app.assets.getByUrl(l).file.hash,d=new URLSearchParams(a);d.set("hash",c);const h=`${n}?${d.toString()}`;this._loadModule(h,i)}else this._loadScript(e.load,i)}open(e,t){return t}patch(e,t){}_loadScript(e,t){const s=document.head,i=document.createElement("script");this._cache[e]=i,i.async=!1,i.addEventListener("error",function(a){t(`Script: ${a.target.src} failed to load`)},!1);let n=!1;i.onload=i.onreadystatechange=function(){!n&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")&&(n=!0,t(null,e,i))},i.src=e,s.appendChild(i)}_loadModule(e,t){const s=Te.browser?window.location.origin:import.meta.url,i=new URL(e,s);B_(()=>import(i.toString()),__vite__mapDeps([]),import.meta.url).then(n=>{for(const a in n){const o=n[a];if(o.prototype instanceof Rt){if(ns.attributesDefinition)for(const c in ns.attributesDefinition)o.attributes.add(c,ns.attributesDefinition[c]);qT(o,o.name.toLowerCase())}}t(null,e,null)}).catch(n=>{t(n)})}}class bz extends Ze{constructor(e){super(e,"shader"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e}),at.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?t(`Error loading shader resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){var t;return(t=this.decoder)!=null||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}}function p_(r){const e=this;e.resource&&(e.resource.atlas=r.resource)}function m_(r){this.registry.load(r)}class Tz extends Ze{constructor(e){super(e,"sprite"),this._assets=e.assets,this._device=e.graphicsDevice}load(e,t){typeof e=="string"&&(e={load:e,original:e}),me.getExtension(e.original)===".json"&&at.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?t(s):t(null,i)})}open(e,t){const s=new tc(this._device);return e&&(s.__data=t),s}patch(e,t){const s=e.resource;if(s.__data&&(e.data.pixelsPerUnit=s.__data.pixelsPerUnit,e.data.renderMode=s.__data.renderMode,e.data.frameKeys=s.__data.frameKeys,s.__data.textureAtlasAsset)){const i=t.getByUrl(s.__data.textureAtlasAsset);i?e.data.textureAtlasAsset=i.id:console.warn("Could not find textureatlas with url: "+s.__data.textureAtlasAsset)}s.startUpdate(),s.renderMode=e.data.renderMode,s.pixelsPerUnit=e.data.pixelsPerUnit,s.frameKeys=e.data.frameKeys,this._updateAtlas(e),s.endUpdate(),e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this)}_updateAtlas(e){const t=e.resource;if(!e.data.textureAtlasAsset){t.atlas=null;return}this._assets.off("load:"+e.data.textureAtlasAsset,p_,e),this._assets.on("load:"+e.data.textureAtlasAsset,p_,e);const s=this._assets.get(e.data.textureAtlasAsset);s&&s.resource?t.atlas=s.resource:s?this._assets.load(s):(this._assets.off("add:"+e.data.textureAtlasAsset,m_,e),this._assets.on("add:"+e.data.textureAtlasAsset,m_,e))}_onAssetChange(e,t,s,i){t==="data"&&s&&s.textureAtlasAsset&&i&&s.textureAtlasAsset!==i.textureAtlasAsset&&(this._assets.off("load:"+i.textureAtlasAsset,p_,e),this._assets.off("add:"+i.textureAtlasAsset,m_,e))}}class Ox{constructor(e,t){this._app=void 0,this._data=void 0,this._templateRoot=null,this._app=e,this._data=t}instantiate(){return this._templateRoot||this._parseTemplate(),this._templateRoot.clone()}_parseTemplate(){const e=new S0(this._app,!0);this._templateRoot=e.parse(this._data)}}class Ez extends Ze{constructor(e){super(e,"template"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};at.get(e.load,s,function(i,n){i?t("Error requesting template: "+e.original):t(i,n)})}open(e,t){return new Ox(this._app,t)}openBinary(e){var t;return(t=this.decoder)!=null||(this.decoder=new TextDecoder("utf-8")),new Ox(this._app,JSON.parse(this.decoder.decode(e)))}}class Cz extends Ze{constructor(e){super(e,"text"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e}),at.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?t(`Error loading text resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){var t;return(t=this.decoder)!=null||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}}const xu={repeat:Tt,clamp:ae,mirror:ap},wu={nearest:Ee,linear:nt,nearest_mip_nearest:qc,linear_mip_nearest:Yc,nearest_mip_linear:Kc,linear_mip_linear:Or},Az=/^data\.frames\.(\d+)$/;class Pz extends Ze{constructor(e){super(e,"textureatlas"),this._loader=e.loader}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s=this,i=this._loader.getHandler("texture");me.getExtension(e.original)===".json"?at.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,a){if(n)t(n);else{const o=e.original.replace(".json",".png");s._loader.load(o,"texture",function(l,c){l?t(l):t(null,{data:a,texture:c})})}}):i.load(e,t)}open(e,t){const s=new sc;if(t.texture&&t.data)s.texture=t.texture,s.__data=t.data;else{const n=this._loader.getHandler("texture").open(e,t);if(!n)return null;s.texture=n}return s}patch(e,t){if(!e.resource)return;e.resource.__data&&(e.resource.__data.minfilter!==void 0&&(e.data.minfilter=e.resource.__data.minfilter),e.resource.__data.magfilter!==void 0&&(e.data.magfilter=e.resource.__data.magfilter),e.resource.__data.addressu!==void 0&&(e.data.addressu=e.resource.__data.addressu),e.resource.__data.addressv!==void 0&&(e.data.addressv=e.resource.__data.addressv),e.resource.__data.mipmaps!==void 0&&(e.data.mipmaps=e.resource.__data.mipmaps),e.resource.__data.anisotropy!==void 0&&(e.data.anisotropy=e.resource.__data.anisotropy),e.resource.__data.rgbm!==void 0&&(e.data.rgbm=!!e.resource.__data.rgbm),e.data.frames=e.resource.__data.frames,delete e.resource.__data);const s=e.resource.texture;if(s&&(s.name=e.name,e.data.hasOwnProperty("minfilter")&&s.minFilter!==wu[e.data.minfilter]&&(s.minFilter=wu[e.data.minfilter]),e.data.hasOwnProperty("magfilter")&&s.magFilter!==wu[e.data.magfilter]&&(s.magFilter=wu[e.data.magfilter]),e.data.hasOwnProperty("addressu")&&s.addressU!==xu[e.data.addressu]&&(s.addressU=xu[e.data.addressu]),e.data.hasOwnProperty("addressv")&&s.addressV!==xu[e.data.addressv]&&(s.addressV=xu[e.data.addressv]),e.data.hasOwnProperty("mipmaps")&&s.mipmaps!==e.data.mipmaps&&(s.mipmaps=e.data.mipmaps),e.data.hasOwnProperty("anisotropy")&&s.anisotropy!==e.data.anisotropy&&(s.anisotropy=e.data.anisotropy),e.data.hasOwnProperty("rgbm"))){const n=e.data.rgbm?Qi:ps;s.type!==n&&(s.type=n)}e.resource.texture=s;const i={};for(const n in e.data.frames){const a=e.data.frames[n];i[n]={rect:new P(a.rect),pivot:new M(a.pivot),border:new P(a.border)}}e.resource.frames=i,e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this)}_onAssetChange(e,t,s){let i;if(t==="data"||t==="data.frames"){const n={};for(const a in s.frames)i=s.frames[a],n[a]={rect:new P(i.rect),pivot:new M(i.pivot),border:new P(i.border)};e.resource.frames=n}else{const n=t.match(Az);if(n){const a=n[1];s?(e.resource.frames[a]?(i=e.resource.frames[a],i.rect.set(s.rect[0],s.rect[1],s.rect[2],s.rect[3]),i.pivot.set(s.pivot[0],s.pivot[1]),i.border.set(s.border[0],s.border[1],s.border[2],s.border[3])):e.resource.frames[a]={rect:new P(s.rect),pivot:new M(s.pivot),border:new P(s.border)},e.resource.fire("set:frame",a,e.resource.frames[a])):e.resource.frames[a]&&(delete e.resource.frames[a],e.resource.fire("remove:frame",a))}}}}function Mz(){const r={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFRGBA4444:16},e={astc:r.cTFASTC_4x4,dxt:r.cTFBC1,etc1:r.cTFETC1,etc2:r.cTFETC1,pvr:r.cTFPVRTC1_4_RGB,atc:r.cTFATC_RGB,none:r.cTFRGB565},t={astc:r.cTFASTC_4x4,dxt:r.cTFBC3,etc1:r.cTFRGBA4444,etc2:r.cTFETC2,pvr:r.cTFPVRTC1_4_RGBA,atc:r.cTFATC_RGBA_INTERPOLATED_ALPHA,none:r.cTFRGBA4444},s={ETC1:21,ETC2_RGB:22,ETC2_RGBA:23,DXT1:8,DXT5:10,PVRTC_4BPP_RGB_1:26,PVRTC_4BPP_RGBA_1:27,ASTC_4x4:28,ATC_RGB:29,ATC_RGBA:30,R8_G8_B8_A8:7,R5_G6_B5:3,R4_G4_B4_A4:5},i=(S,w)=>{switch(S){case r.cTFETC1:return w.formats.etc1?s.ETC1:s.ETC2_RGB;case r.cTFETC2:return s.ETC2_RGBA;case r.cTFBC1:return s.DXT1;case r.cTFBC3:return s.DXT5;case r.cTFPVRTC1_4_RGB:return s.PVRTC_4BPP_RGB_1;case r.cTFPVRTC1_4_RGBA:return s.PVRTC_4BPP_RGBA_1;case r.cTFASTC_4x4:return s.ASTC_4x4;case r.cTFATC_RGB:return s.ATC_RGB;case r.cTFATC_RGBA_INTERPOLATED_ALPHA:return s.ATC_RGBA;case r.cTFRGBA32:return s.R8_G8_B8_A8;case r.cTFRGB565:return s.R5_G6_B5;case r.cTFRGBA4444:return s.R4_G4_B4_A4}},n=S=>{const w=function(b,C){const E=b*.00784313725490196-1,R=C*(2/255)-1,B=Math.sqrt(1-Math.min(1,E*E+R*R));return Math.max(0,Math.min(255,Math.floor((B+1)*.5*255)))};for(let T=0;T<S.length;T+=4){const b=S[T+3],C=S[T+1];S[T+0]=b,S[T+2]=w(b,C),S[T+3]=255}return S},a=S=>{const w=new Uint16Array(S.length/4);for(let T=0;T<S.length;T+=4){const b=S[T+0],C=S[T+1],E=S[T+2];w[T/4]=(b&248)<<8|(C&252)<<3|E>>3}return w},o=(S,w)=>(S&S-1)===0&&(w&w-1)===0,l=()=>typeof performance<"u"?performance.now():0;let c,d,h;const u=(S,w,T)=>{if(T){if(S.formats.astc)return"astc"}else if(w){if(S.formats.etc2)return"etc2"}else if(S.formats.etc1||S.formats.etc2)return"etc1";return(C=>{for(let E=0;E<C.length;++E){const R=C[E];if(S.formats[R])return R}return"none"})(w?h:d)},f=(S,w,T,b)=>{switch(T){case r.cTFETC1:case r.cTFETC2:return!0;case r.cTFBC1:case r.cTFBC3:return(S&3)===0&&(w&3)===0;case r.cTFPVRTC1_4_RGB:case r.cTFPVRTC1_4_RGBA:return o(S,w)&&(S===w||b);case r.cTFASTC_4x4:return!0;case r.cTFATC_RGB:case r.cTFATC_RGBA_INTERPOLATED_ALPHA:return!0}return!1},p=(S,w,T)=>{if(!c.KTX2File)throw new Error("Basis transcoder module does not include support for KTX2.");const b=l(),C=new c.KTX2File(new Uint8Array(w)),E=C.getWidth(),R=C.getHeight(),B=C.getLevels(),L=!!C.getHasAlpha(),V=C.isUASTC&&C.isUASTC();if(!E||!R||!B)throw C.close(),C.delete(),new Error(`Invalid image dimensions url=${S} width=${E} height=${R} levels=${B}`);const I=u(T.deviceDetails,L,V),F=!!T.isGGGR&&I==="pvr";let D;if(F?D=r.cTFRGBA32:(D=L?t[I]:e[I],f(E,R,D,T.deviceDetails.webgl2)||(D=L?r.cTFRGBA32:r.cTFRGB565)),!C.startTranscoding())throw C.close(),C.delete(),new Error("Failed to start transcoding url="+S);let A;const N=[];for(let U=0;U<B;++U){const G=C.getImageTranscodedSizeInBytes(U,0,0,D),X=new Uint8Array(G);if(!C.transcodeImage(X,U,0,0,D,0,-1,-1))throw C.close(),C.delete(),new Error("Failed to transcode image url="+S);const j=D===r.cTFRGB565||D===r.cTFRGBA4444;N.push(j?new Uint16Array(X.buffer):X)}if(C.close(),C.delete(),F)for(D=r.cTFRGB565,A=0;A<N.length;++A)N[A]=a(n(N[A]));return{format:i(D,T.deviceDetails),width:E,height:R,levels:N,cubemap:!1,transcodeTime:l()-b,url:S,unswizzledGGGR:F}},_=(S,w,T)=>{const b=l(),C=new c.BasisFile(new Uint8Array(w)),E=C.getImageWidth(0,0),R=C.getImageHeight(0,0),B=C.getNumImages(),L=C.getNumLevels(0),V=!!C.getHasAlpha(),I=C.isUASTC&&C.isUASTC();if(!E||!R||!B||!L)throw C.close(),C.delete(),new Error(`Invalid image dimensions url=${S} width=${E} height=${R} images=${B} levels=${L}`);const F=u(T.deviceDetails,V,I),D=!!T.isGGGR&&F==="pvr";let A;if(D?A=r.cTFRGBA32:(A=V?t[F]:e[F],f(E,R,A,T.deviceDetails.webgl2)||(A=V?r.cTFRGBA32:r.cTFRGB565)),!C.startTranscoding())throw C.close(),C.delete(),new Error("Failed to start transcoding url="+S);let N;const U=[];for(let G=0;G<L;++G){const X=C.getImageTranscodedSizeInBytes(0,G,A),j=new Uint8Array(X);if(!C.transcodeImage(j,0,G,A,0,0))if(G===L-1&&X===U[G-1].buffer.byteLength)j.set(new Uint8Array(U[G-1].buffer)),console.warn("Failed to transcode last mipmap level, using previous level instead url="+S);else throw C.close(),C.delete(),new Error("Failed to transcode image url="+S);const J=A===r.cTFRGB565||A===r.cTFRGBA4444;U.push(J?new Uint16Array(j.buffer):j)}if(C.close(),C.delete(),D)for(A=r.cTFRGB565,N=0;N<U.length;++N)U[N]=a(n(U[N]));return{format:i(A,T.deviceDetails),width:E,height:R,levels:U,cubemap:!1,transcodeTime:l()-b,url:S,unswizzledGGGR:D}},m=(S,w,T)=>T.isKTX2?p(S,w,T):_(S,w,T),g=(S,w,T)=>{try{const b=m(S,w,T);b.levels=b.levels.map(C=>C.buffer),self.postMessage({url:S,data:b},b.levels)}catch(b){self.postMessage({url:S,err:b},null)}},v=(S,w)=>{const T=(b,C)=>(WebAssembly.instantiate(S.module,b).then(E=>{C(E)}).catch(E=>{console.error("instantiate failed + "+E)}),{});self.BASIS(S.module?{instantiateWasm:T}:null).then(b=>{b.initializeBasis(),c=b,d=S.rgbPriority,h=S.rgbaPriority,w(null)})},x=[];self.onmessage=S=>{const w=S.data;switch(w.type){case"init":v(w.config,()=>{for(let T=0;T<x.length;++T)g(x[T].url,x[T].data,x[T].options);x.length=0});break;case"transcode":c?g(w.url,w.data,w.options):x.push(w);break}}}const Iz=r=>({astc:!!r.extCompressedTextureASTC,atc:!!r.extCompressedTextureATC,dxt:!!r.extCompressedTextureS3TC,etc1:!!r.extCompressedTextureETC1,etc2:!!r.extCompressedTextureETC,pvr:!!r.extCompressedTexturePVRTC}),Rz=(r,e)=>{const t=a=>{const o=["/* basis */",a,"","("+Mz.toString()+`)()

`].join(`
`);return new Blob([o],{type:"application/javascript"})},s=()=>{try{if(typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function"){const a=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(a instanceof WebAssembly.Module)return new WebAssembly.Instance(a)instanceof WebAssembly.Instance}}catch{}return!1},i=(a,o)=>{e(null,{workerUrl:URL.createObjectURL(t(a)),module:o,rgbPriority:r.rgbPriority,rgbaPriority:r.rgbaPriority})},n={cache:!0,responseType:"text",retry:r.maxRetries>0,maxRetries:r.maxRetries};if(r.glueUrl&&r.wasmUrl&&s()){let a=null,o=null;at.get(r.glueUrl,n,(d,h)=>{d?e(d):o?i(h,o):a=h});const l=fetch(r.wasmUrl),c=()=>{l.then(d=>d.arrayBuffer()).then(d=>WebAssembly.compile(d)).then(d=>{a?i(a,d):o=d}).catch(d=>{e(d,null)})};WebAssembly.compileStreaming?WebAssembly.compileStreaming(l).then(d=>{a?i(a,d):o=d}).catch(d=>{c()}):c()}else at.get(r.fallbackUrl,n,(a,o)=>{a?e(a,null):i(o,null)})};class Lz{constructor(){this.callbacks={},this.queue=[],this.clients=[]}enqueueJob(e,t,s,i){if(this.callbacks.hasOwnProperty(e))this.callbacks[e].push(s);else{this.callbacks[e]=[s];const n={url:e,data:t,options:i};this.clients.length>0?this.clients.shift().run(n):this.queue.push(n)}}enqueueClient(e){this.queue.length>0?e.run(this.queue.shift()):this.clients.push(e)}handleResponse(e,t,s){const i=this.callbacks[e];if(t)for(let n=0;n<i.length;++n)i[n](t);else{s.format===Zc||s.format===Jc?s.levels=s.levels.map(function(n){return new Uint16Array(n)}):s.levels=s.levels.map(function(n){return new Uint8Array(n)});for(let n=0;n<i.length;++n)i[n](null,s)}delete this.callbacks[e]}}class Dz{constructor(e,t,s){this.queue=e,this.worker=new Worker(t.workerUrl),this.worker.addEventListener("message",i=>{const n=i.data;this.queue.handleResponse(n.url,n.err,n.data),this.eager||this.queue.enqueueClient(this)}),this.worker.postMessage({type:"init",config:t}),this.eager=s}run(e){const t=[];e.data instanceof ArrayBuffer&&t.push(e.data),this.worker.postMessage({type:"transcode",url:e.url,format:e.format,data:e.data,options:e.options},t),this.eager&&this.queue.enqueueClient(this)}}const Oz=1,Fz=["etc1","etc2","astc","dxt","pvr","atc"],kz=["astc","dxt","etc2","pvr","atc"],Bz=5,Gg=new Lz;let Fx=null,Hg=!1;function Nz(r){if(!Hg){if(!r)r=Fx||{};else if(r.lazyInit){Fx=r;return}if(!r.glueUrl||!r.wasmUrl||!r.fallbackUrl){const e=Qu.getConfig("BASIS");e&&(r={glueUrl:e.glueUrl,wasmUrl:e.wasmUrl,fallbackUrl:e.fallbackUrl,numWorkers:e.numWorkers})}if(r.glueUrl||r.wasmUrl||r.fallbackUrl){Hg=!0;const e=Math.max(1,Math.min(16,r.numWorkers||Oz)),t=r.numWorkers===1||(r.hasOwnProperty("eagerWorkers")?r.eagerWorkers:!0);r.rgbPriority=r.rgbPriority||Fz,r.rgbaPriority=r.rgbaPriority||kz,r.maxRetries=r.hasOwnProperty("maxRetries")?r.maxRetries:Bz,Rz(r,(s,i)=>{if(s)console.error(`failed to initialize basis worker: ${s}`);else for(let n=0;n<e;++n)Gg.enqueueClient(new Dz(Gg,i,t))})}}}let __=null;function KT(r,e,t,s,i){return Nz(),__||(__={webgl2:r.isWebGL2,formats:Iz(r)}),Gg.enqueueJob(e,t,s,{deviceDetails:__,isGGGR:!!(i!=null&&i.isGGGR),isKTX2:!!(i!=null&&i.isKTX2)}),Hg}class Uz{constructor(e,t){this.device=t,this.maxRetries=0}load(e,t,s){const i=this.device,n=a=>{var o;KT(i,e.load,a,t,{isGGGR:((s==null||(o=s.file)==null||(o=o.variants)==null||(o=o.basis)==null?void 0:o.opt)&8)!==0})||t(`Basis module not found. Asset '${s.name}' basis texture variant will not be loaded.`)};ne.fetchArrayBuffer(e.load,(a,o)=>{a?t(a):n(o)},s,this.maxRetries)}open(e,t,s,i={}){const n=new _e(s,Ft({name:e,addressU:t.cubemap?ae:Tt,addressV:t.cubemap?ae:Tt,width:t.width,height:t.height,format:t.format,cubemap:t.cubemap,levels:t.levels},i));return n.upload(),n}}class zz{constructor(e,t){this.crossOrigin=e.prefix?"anonymous":null,this.maxRetries=0,this.device=t}load(e,t,s){var i;const n=!!(s!=null&&(i=s.file)!=null&&i.contents);if(n){if(this.device.supportsImageBitmap){this._loadImageBitmapFromBlob(new Blob([s.file.contents]),t);return}e={load:URL.createObjectURL(new Blob([s.file.contents])),original:e.original}}const a=(l,c)=>{n&&URL.revokeObjectURL(e.load),t(l,c)};let o;s&&s.options&&s.options.hasOwnProperty("crossOrigin")?o=s.options.crossOrigin:Wl.test(e.load)&&(o=this.crossOrigin),this.device.supportsImageBitmap?this._loadImageBitmap(e.load,e.original,o,a):this._loadImage(e.load,e.original,o,a)}open(e,t,s,i={}){const n=new _e(s,Ft({name:e,width:t.width,height:t.height,format:xe},i));return n.setSource(t),n}_loadImage(e,t,s,i){const n=new Image;s&&(n.crossOrigin=s);let a=0;const o=this.maxRetries;let l;n.onload=function(){i(null,n)},n.onerror=function(){if(!l)if(o>0&&++a<=o){const c=Math.pow(2,a)*100;console.log(`Error loading Texture from: '${t}' - Retrying in ${c}ms...`);const h=e.indexOf("?")>=0?"&":"?";l=setTimeout(function(){n.src=e+h+"retry="+Date.now(),l=null},c)}else i(`Error loading Texture from: '${t}'`)},n.src=e}_loadImageBitmap(e,t,s,i){const n={cache:!0,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries};at.get(e,n,(a,o)=>{a?i(a):this._loadImageBitmapFromBlob(o,i)})}_loadImageBitmapFromBlob(e,t){createImageBitmap(e,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then(s=>t(null,s)).catch(s=>t(s))}}const g_=[1481919403,3140563232,169478669],Vz={33776:Qc,33778:cp,33779:ql,36196:ed,37492:fp,37496:pp,35840:td,35841:Zl,35842:sd,35843:Jl,32849:Gn,32856:xe,35905:dp,35907:up,35898:ja,34843:Kl,34842:yt};function Gz(r,e,t,s){return r===ja?new Uint32Array(e,t,s/4):new Uint8Array(e,t,s)}class Hz{constructor(e){this.maxRetries=0}load(e,t,s){ne.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s,i={}){const n=this.parse(t);if(!n)return null;const a=new _e(s,Ft({name:e,addressU:n.cubemap?ae:Tt,addressV:n.cubemap?ae:Tt,width:n.width,height:n.height,format:n.format,cubemap:n.cubemap,levels:n.levels},i));return a.upload(),a}parse(e){const t=new Uint32Array(e);if(g_[0]!==t[0]||g_[1]!==t[1]||g_[2]!==t[2])return null;const s={endianness:t[3],glType:t[4],glTypeSize:t[5],glFormat:t[6],glInternalFormat:t[7],glBaseInternalFormat:t[8],pixelWidth:t[9],pixelHeight:t[10],pixelDepth:t[11],numberOfArrayElements:t[12],numberOfFaces:t[13],numberOfMipmapLevels:t[14],bytesOfKeyValueData:t[15]};if(s.pixelDepth>1||s.numberOfArrayElements!==0)return null;const i=Vz[s.glInternalFormat];if(i===void 0)return null;let n=16+s.bytesOfKeyValueData/4;const a=s.numberOfFaces>1,o=[];for(let l=0;l<(s.numberOfMipmapLevels||1);l++){const c=t[n++];a&&o.push([]);const d=a?o[l]:o;for(let h=0;h<(a?6:1);++h)d.push(Gz(i,e,n*4,c)),n+=c+3>>2}return{format:i,width:s.pixelWidth,height:s.pixelHeight,levels:o,cubemap:a}}}const Wz={KHR_DF_MODEL_ETC1S:163,KHR_DF_MODEL_UASTC:166};class jz{constructor(e,t){this.maxRetries=0,this.device=t}load(e,t,s){ne.fetchArrayBuffer(e.load,(i,n)=>{i?t(i,n):this.parse(n,e,t,s)},s,this.maxRetries)}open(e,t,s,i={}){const n=new _e(s,Ft({name:e,addressU:t.cubemap?ae:Tt,addressV:t.cubemap?ae:Tt,width:t.width,height:t.height,format:t.format,cubemap:t.cubemap,levels:t.levels},i));return n.upload(),n}parse(e,t,s,i){const n=new Kw(e),a=[n.readU32be(),n.readU32be(),n.readU32be()];if(a[0]!==2873840728||a[1]!==540160187||a[2]!==218765834)return null;const o={vkFormat:n.readU32(),typeSize:n.readU32(),pixelWidth:n.readU32(),pixelHeight:n.readU32(),pixelDepth:n.readU32(),layerCount:n.readU32(),faceCount:n.readU32(),levelCount:n.readU32(),supercompressionScheme:n.readU32()},l={dfdByteOffset:n.readU32(),dfdByteLength:n.readU32(),kvdByteOffset:n.readU32(),kvdByteLength:n.readU32(),sgdByteOffset:n.readU64(),sgdByteLength:n.readU64()},c=[];for(let f=0;f<Math.max(1,o.levelCount);++f)c.push({byteOffset:n.readU64(),byteLength:n.readU64(),uncompressedByteLength:n.readU64()});if(n.readU32()!==l.kvdByteOffset-l.dfdByteOffset)return null;n.skip(8);const h=n.readU8();if(n.skip(l.dfdByteLength-9),n.skip(l.kvdByteLength),o.supercompressionScheme===1||h===Wz.KHR_DF_MODEL_UASTC){var u;KT(this.device,t.load,e,s,{isGGGR:((i==null||(u=i.file)==null||(u=u.variants)==null||(u=u.basis)==null?void 0:u.opt)&8)!==0,isKTX2:!0})||s('Basis module not found. Asset "'+i.name+'" basis texture variant will not be loaded.')}else s("unsupported KTX2 pixel format")}}class $z{constructor(e){this.maxRetries=0}load(e,t,s){ne.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s,i={}){const n=new Uint32Array(t,0,32),a=n[4],o=n[3],l=Math.max(n[7],1),c=n[20]===4,d=n[21],h=n[22],u=n[28]===65024,f=827611204,p=894720068,_=113,m=116,g=826496069,v=825438800,x=825504336,S=825439312,w=825504848;let T=!1,b=!1,C=!1,E=!1,R=null,B=1,L;if(c?d===f?(R=Qc,T=!0):d===p?(R=ql,T=!0):d===_?(R=yt,B=2):d===m?(R=rt,B=4):d===g?(R=ed,T=!0,b=!0):d===v||d===x?(R=d===v?Zl:Jl,T=!0,C=!0):(d===S||d===w)&&(R=d===S?td:sd,T=!0,E=!0):h===32&&(R=xe),!R)return L=new _e(s,{width:4,height:4,format:Gn,name:"dds-legacy-empty"}),L;L=new _e(s,Ft({name:e,addressU:u?ae:Tt,addressV:u?ae:Tt,width:a,height:o,format:R,cubemap:u,mipmaps:l>1},i));let V=128;const I=u?6:1;let F;const D=4,A=4,N=d===f?8:16;let U,G,X;for(let j=0;j<I;j++){let J=a,ee=o;for(let se=0;se<l;se++){T?b?F=Math.floor((J+3)/4)*Math.floor((ee+3)/4)*8:C?F=Math.max(J,16)*Math.max(ee,8)/4:E?F=Math.max(J,8)*Math.max(ee,8)/2:(U=Math.floor((J+D-1)/D),G=Math.floor((ee+A-1)/A),X=U*G,F=X*N):F=J*ee*4;const oe=R===rt?new Float32Array(t,V,F):R===yt?new Uint16Array(t,V,F):new Uint8Array(t,V,F);u?(L._levels[se]||(L._levels[se]=[]),L._levels[se][j]=oe):L._levels[se]=oe,V+=F*B,J=Math.max(J*.5,1),ee=Math.max(ee*.5,1)}}return L.upload(),L}}class Xz{constructor(e){this.maxRetries=0}load(e,t,s){ne.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s,i={}){const n=this.parse(t);if(!n)return null;const a=new _e(s,Ft({name:e,addressU:Tt,addressV:ae,minFilter:Ee,magFilter:Ee,width:n.width,height:n.height,levels:n.levels,format:xe,type:Ey,mipmaps:!1},i));return a.upload(),a}parse(e){const t=new Kw(e);if(!t.readLine().startsWith("#?RADIANCE"))return null;const i={};for(;;){const c=t.readLine();if(c.length===0)break;{const d=c.split("=");d.length===2&&(i[d[0]]=d[1])}}if(!i.hasOwnProperty("FORMAT"))return null;const n=t.readLine().split(" ");if(n.length!==4)return null;const a=parseInt(n[1],10),o=parseInt(n[3],10),l=this._readPixels(t,o,a,n[0]==="-Y");return l?{width:o,height:a,levels:[l]}:null}_readPixels(e,t,s,i){if(t<8||t>32767)return this._readPixelsFlat(e,t,s);const n=[0,0,0,0];if(e.readArray(n),n[0]!==2||n[1]!==2||n[2]&128)return e.skip(-4),this._readPixelsFlat(e,t,s);const a=new ArrayBuffer(t*s*4),o=new Uint8Array(a);let l=i?0:t*4*(s-1),c,d,h,u,f,p;for(d=0;d<s;++d){if(d&&e.readArray(n),(n[2]<<8)+n[3]!==t)return null;for(u=0;u<4;++u)for(c=0;c<t;)if(f=e.readU8(),f>128){if(f-=128,c+f>t)return null;for(p=e.readU8(),h=0;h<f;++h)o[l+u+4*c++]=p}else{if(f===0||c+f>t)return null;for(h=0;h<f;++h)o[l+u+4*c++]=e.readU8()}l+=t*4*(i?1:-1)}return o}_readPixelsFlat(e,t,s){return e.remainingBytes===t*s*4?new Uint8Array(e.arraybuffer,e.offset):null}}const kx={repeat:Tt,clamp:ae,mirror:ap},Bx={nearest:Ee,linear:nt,nearest_mip_nearest:qc,linear_mip_nearest:Yc,nearest_mip_linear:Kc,linear_mip_linear:Or},qz={default:ps,rgbm:Qi,rgbe:Ey,rgbp:Rl,swizzleGGGR:Ll},Kz=function(e){const t=Dn.calcMipLevelsCount(e._width,e._height),s=function(a){return a instanceof HTMLCanvasElement||a instanceof HTMLImageElement||a instanceof HTMLVideoElement};if(!(e._format===xe||e._format===rt)||e._volume||e._compressed||e._levels.length===1||e._levels.length===t||s(e._cubemap?e._levels[0][0]:e._levels[0]))return;const i=function(a,o,l){const c=Math.max(1,a>>1),d=Math.max(1,o>>1),h=new l.constructor(c*d*4),u=Math.floor(a/c),f=Math.floor(o/d),p=u*f;for(let _=0;_<d;++_)for(let m=0;m<c;++m)for(let g=0;g<4;++g){let v=0;for(let x=0;x<f;++x)for(let S=0;S<u;++S)v+=l[(m*u+S+(_*f+x)*a)*4+g];h[(m+_*c)*4+g]=v/p}return h};for(let n=e._levels.length;n<t;++n){const a=Math.max(1,e._width>>n-1),o=Math.max(1,e._height>>n-1);if(e._cubemap){const l=[];for(let c=0;c<6;++c)l.push(i(a,o,e._levels[n-1][c]));e._levels.push(l)}else e._levels.push(i(a,o,e._levels[n-1]))}e._levelsUpdated=e._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]};class Yz extends Ze{constructor(e){super(e,"texture");const t=e.assets,s=e.graphicsDevice;this._device=s,this._assets=t,this.imgParser=new zz(t,s),this.parsers={dds:new $z(t),ktx:new Hz(t),ktx2:new jz(t,s),basis:new Uz(t,s),hdr:new Xz(t)}}set crossOrigin(e){this.imgParser.crossOrigin=e}get crossOrigin(){return this.imgParser.crossOrigin}set maxRetries(e){this.imgParser.maxRetries=e;for(const t in this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e)}get maxRetries(){return this.imgParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){const t=me.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".","");return this.parsers[t]||this.imgParser}_getTextureOptions(e){const t={};if(e){var s;((s=e.name)==null?void 0:s.length)>0&&(t.name=e.name);const i=e.data;i.hasOwnProperty("minfilter")&&(t.minFilter=Bx[i.minfilter]),i.hasOwnProperty("magfilter")&&(t.magFilter=Bx[i.magfilter]),i.hasOwnProperty("addressu")&&(t.addressU=kx[i.addressu]),i.hasOwnProperty("addressv")&&(t.addressV=kx[i.addressv]),i.hasOwnProperty("mipmaps")&&(t.mipmaps=i.mipmaps),i.hasOwnProperty("anisotropy")&&(t.anisotropy=i.anisotropy),i.hasOwnProperty("flipY")&&(t.flipY=!!i.flipY),i.hasOwnProperty("type")?t.type=qz[i.type]:i.hasOwnProperty("rgbm")&&i.rgbm?t.type=Qi:e.file&&e.file.opt&8&&(t.type=Ll)}return t}load(e,t,s){typeof e=="string"&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s)}open(e,t,s){if(!e)return;const i=this._getTextureOptions(s);let n=this._getParser(e).open(e,t,this._device,i);return n===null?n=new _e(this._device,{width:4,height:4,format:Gn}):(Kz(n),t.unswizzledGGGR&&(s.file.variants.basis.opt&=-9)),n}patch(e,t){const s=e.resource;if(!s)return;const i=this._getTextureOptions(e);for(const n of Object.keys(i))s[n]=i[n]}}const Zz="inline",Jz="immersive-vr",nc="immersive-ar",Qz="viewer",eV="left",tV="cpu-optimized",sV="gpu-optimized",YT="luminance-alpha",iV="float32";class im extends ie{constructor(e){super(),this._manager=void 0,this._views=void 0,this._available=!1,this._evtDepthResize=null,this._uvMatrix=q.IDENTITY.clone(),this._manager=e,this._views=e.views,this._views.supportedDepth&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}_onSessionStart(){var e;this._views.availableDepth&&(this._evtDepthResize=(e=this._views.list[0])==null?void 0:e.on("depth:resize",this._onDepthResize,this))}_onSessionEnd(){this._evtDepthResize&&(this._evtDepthResize.off(),this._evtDepthResize=null),this._available&&(this._available=!1,this.fire("unavailable"))}_onDepthResize(e,t){this.fire("resize",e,t)}getDepth(e,t){var s,i;return(s=(i=this._views.list[0])==null?void 0:i.getDepth(e,t))!=null?s:null}update(){this._manager.session&&this.supported&&this._views.availableDepth&&this._views.list.length&&!this._available&&(this._available=!0,this.fire("available"))}get supported(){return this._views.supportedDepth}get available(){return this._views.availableDepth}get usage(){return this._views.depthUsage}get dataFormat(){return this._views.depthFormat}get width(){var e,t;return(e=(t=this._views.list[0])==null||(t=t.textureDepth)==null?void 0:t.width)!=null?e:0}get height(){var e,t;return(e=(t=this._views.list[0])==null||(t=t.textureDepth)==null?void 0:t.height)!=null?e:0}get texture(){var e;return(e=this._views.list[0])==null?void 0:e.textureDepth}get uvMatrix(){var e,t;return(e=(t=this._views.list[0])==null?void 0:t.depthUvMatrix)!=null?e:this._uvMatrix}get rawValueToMeters(){var e,t;return(e=(t=this._views.list[0])==null?void 0:t.depthValueToMeters)!=null?e:0}}im.EVENT_AVAILABLE="available";im.EVENT_UNAVAILABLE="unavailable";im.EVENT_RESIZE="resize";class nV{constructor(e){this._manager=void 0,this._supported=Te.browser&&!!window.XRDOMOverlayState,this._root=null,this._manager=e}get supported(){return this._supported}get available(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState!==null}get state(){return!this._supported||!this._manager.active||!this._manager._session.domOverlayState?null:this._manager._session.domOverlayState.type}set root(e){!this._supported||this._manager.active||(this._root=e)}get root(){return this._root}}const bu=[],Nx=[];class x0 extends ie{constructor(e,t,s,i=null){super(),this.manager=void 0,this._xrHitTestSource=void 0,this._transient=void 0,this._inputSource=void 0,this.manager=e,this._xrHitTestSource=t,this._transient=s,this._inputSource=i}remove(){if(!this._xrHitTestSource)return;const e=this.manager.hitTest.sources,t=e.indexOf(this);t!==-1&&e.splice(t,1),this.onStop()}onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)}update(e){if(this._transient){const t=e.getHitTestResultsForTransientInput(this._xrHitTestSource);for(let s=0;s<t.length;s++){const i=t[s];if(!i.results.length)continue;let n;i.inputSource&&(n=this.manager.input._getByInputSource(i.inputSource)),this.updateHitResults(i.results,n)}}else{const t=e.getHitTestResults(this._xrHitTestSource);if(!t.length)return;this.updateHitResults(t)}}updateHitResults(e,t){var s,i,n;if(this._inputSource&&this._inputSource!==t)return;const a=(s=bu.pop())!=null?s:new y;t?a.copy(t.getOrigin()):a.copy(this.manager.camera.getPosition());let o=1/0,l=null;const c=(i=bu.pop())!=null?i:new y,d=(n=Nx.pop())!=null?n:new re;for(let h=0;h<e.length;h++){const u=e[h].getPose(this.manager._referenceSpace),f=a.distance(u.transform.position);f>=o||(o=f,l=e[h],c.copy(u.transform.position),d.copy(u.transform.orientation))}this.fire("result",c,d,t||this._inputSource,l),this.manager.hitTest.fire("result",this,c,d,t||this._inputSource,l),bu.push(a),bu.push(c),Nx.push(d)}}x0.EVENT_REMOVE="remove";x0.EVENT_RESULT="result";class po extends ie{constructor(e){super(),this.manager=void 0,this._supported=Te.browser&&!!(window.XRSession&&window.XRSession.prototype.requestHitTestSource),this._available=!1,this.sources=[],this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){const e=this.manager.session.enabledFeatures.indexOf("hit-test")!==-1;e&&(this._available=e,this.fire("available"))}_onSessionEnd(){if(this._available){this._available=!1;for(let e=0;e<this.sources.length;e++)this.sources[e].onStop();this.sources=[],this.fire("unavailable")}}start(e={}){if(!this._supported){e.callback==null||e.callback(new Error("XR HitTest is not supported"),null);return}if(!this._available){e.callback==null||e.callback(new Error("XR HitTest is not available"),null);return}!e.profile&&!e.spaceType&&(e.spaceType=Qz);let t;const s=e.offsetRay;if(s){const n=new DOMPoint(s.origin.x,s.origin.y,s.origin.z,1),a=new DOMPoint(s.direction.x,s.direction.y,s.direction.z,0);t=new XRRay(n,a)}const i=e.callback;e.spaceType?this.manager.session.requestReferenceSpace(e.spaceType).then(n=>{if(!this.manager.session){const a=new Error("XR Session is not started (2)");i&&i(a),this.fire("error",a);return}this.manager.session.requestHitTestSource({space:n,entityTypes:e.entityTypes||void 0,offsetRay:t}).then(a=>{this._onHitTestSource(a,!1,e.inputSource,i)}).catch(a=>{i&&i(a),this.fire("error",a)})}).catch(n=>{i&&i(n),this.fire("error",n)}):this.manager.session.requestHitTestSourceForTransientInput({profile:e.profile,entityTypes:e.entityTypes||void 0,offsetRay:t}).then(n=>{this._onHitTestSource(n,!0,e.inputSource,i)}).catch(n=>{i&&i(n),this.fire("error",n)})}_onHitTestSource(e,t,s,i){if(!this.manager.session){e.cancel();const a=new Error("XR Session is not started (3)");i&&i(a),this.fire("error",a);return}const n=new x0(this.manager,e,t,s??null);this.sources.push(n),i&&i(null,n),this.fire("add",n)}update(e){for(let t=0;t<this.sources.length;t++)this.sources[t].update(e)}get supported(){return this._supported}get available(){return this._available}}po.EVENT_AVAILABLE="available";po.EVENT_UNAVAILABLE="unavailable";po.EVENT_ADD="add";po.EVENT_REMOVE="remove";po.EVENT_RESULT="result";po.EVENT_ERROR="error";class w0 extends ie{constructor(e,t){super(),this._image=void 0,this._width=void 0,this._bitmap=null,this._measuredWidth=0,this._trackable=!1,this._tracking=!1,this._emulated=!1,this._pose=null,this._position=new y,this._rotation=new re,this._image=e,this._width=t}get image(){return this._image}set width(e){this._width=e}get width(){return this._width}get trackable(){return this._trackable}get tracking(){return this._tracking}get emulated(){return this._emulated}prepare(){return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then(e=>(this._bitmap=e,{image:this._bitmap,widthInMeters:this._width}))}destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)}getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position}getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation}}w0.EVENT_TRACKED="tracked";w0.EVENT_UNTRACKED="untracked";class ZT extends ie{constructor(e){super(),this._manager=void 0,this._supported=Te.browser&&!!window.XRImageTrackingResult,this._available=!1,this._images=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}add(e,t){if(!this._supported||this._manager.active)return null;const s=new w0(e,t);return this._images.push(s),s}remove(e){if(this._manager.active)return;const t=this._images.indexOf(e);t!==-1&&(e.destroy(),this._images.splice(t,1))}_onSessionStart(){this._manager.session.getTrackedImageScores().then(e=>{this._available=!0;for(let t=0;t<e.length;t++)this._images[t]._trackable=e[t]==="trackable"}).catch(e=>{this._available=!1,this.fire("error",e)})}_onSessionEnd(){this._available=!1;for(let e=0;e<this._images.length;e++){const t=this._images[e];t._pose=null,t._measuredWidth=0,t._tracking&&(t._tracking=!1,t.fire("untracked"))}}prepareImages(e){this._images.length?Promise.all(this._images.map(function(t){return t.prepare()})).then(function(t){e(null,t)}).catch(function(t){e(t,null)}):e(null,null)}update(e){if(!this._available)return;const t=e.getImageTrackingResults(),s={};for(let i=0;i<t.length;i++){s[t[i].index]=t[i];const n=this._images[t[i].index];n._emulated=t[i].trackingState==="emulated",n._measuredWidth=t[i].measuredWidthInMeters,n._pose=e.getPose(t[i].imageSpace,this._manager._referenceSpace)}for(let i=0;i<this._images.length;i++)this._images[i]._tracking&&!s[i]?(this._images[i]._tracking=!1,this._images[i].fire("untracked")):!this._images[i]._tracking&&s[i]&&(this._images[i]._tracking=!0,this._images[i].fire("tracked"))}get supported(){return this._supported}get available(){return this._available}get images(){return this._images}}ZT.EVENT_ERROR="error";class rV{constructor(e,t){this._index=void 0,this._hand=void 0,this._joints=[],this._tip=null,this._index=e,this._hand=t,this._hand._fingers.push(this)}get index(){return this._index}get hand(){return this._hand}get joints(){return this._joints}get tip(){return this._tip}}const Ux=Te.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],JT={};for(let r=0;r<Ux.length;r++)JT[Ux[r]]=!0;class zx{constructor(e,t,s,i=null){this._index=void 0,this._id=void 0,this._hand=void 0,this._finger=void 0,this._wrist=void 0,this._tip=void 0,this._radius=null,this._localTransform=new q,this._worldTransform=new q,this._localPosition=new y,this._localRotation=new re,this._position=new y,this._rotation=new re,this._dirtyLocal=!0,this._index=e,this._id=t,this._hand=s,this._finger=i,this._wrist=t==="wrist",this._tip=this._finger&&!!JT[t]}update(e){this._dirtyLocal=!0,this._radius=e.radius,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation)}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,y.ONE));const t=this._hand._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position}getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation}get index(){return this._index}get hand(){return this._hand}get finger(){return this._finger}get wrist(){return this._wrist}get tip(){return this._tip}get radius(){return this._radius||.005}}let Yu=[];const la=new y,Tu=new y,Vx=new y;Te.browser&&window.XRHand&&(Yu=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);class b0 extends ie{constructor(e){super(),this._manager=void 0,this._inputSource=void 0,this._tracking=!1,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null;const t=e._xrInputSource.hand;if(this._manager=e._manager,this._inputSource=e,t.get("wrist")){const s=new zx(0,"wrist",this,null);this._wrist=s,this._joints.push(s),this._jointsById.wrist=s}for(let s=0;s<Yu.length;s++){const i=new rV(s,this);for(let n=0;n<Yu[s].length;n++){const a=Yu[s][n];if(!t.get(a))continue;const o=new zx(n,a,this,i);this._joints.push(o),this._jointsById[a]=o,o.tip&&(this._tips.push(o),i._tip=o),i._joints.push(o)}}}update(e){const t=this._inputSource._xrInputSource;for(let d=0;d<this._joints.length;d++){const h=this._joints[d],u=t.hand.get(h._id);if(u){let f;if(e.session.visibilityState!=="hidden"&&(f=e.getJointPose(u,this._manager._referenceSpace)),f)h.update(f),h.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(h.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}const s=this._jointsById["thumb-metacarpal"],i=this._jointsById["thumb-tip"],n=this._jointsById["index-finger-phalanx-proximal"],a=this._jointsById["index-finger-tip"],o=this._jointsById["ring-finger-phalanx-proximal"],l=this._jointsById["pinky-finger-phalanx-proximal"];if(s&&i&&n&&a&&o&&l){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(i._localPosition,a._localPosition,.5);let d=s,h=l;if(this._inputSource.handedness===eV){const u=d;d=h,h=u}la.sub2(d._localPosition,this._wrist._localPosition),Tu.sub2(h._localPosition,this._wrist._localPosition),Vx.cross(la,Tu).normalize(),la.lerp(n._localPosition,o._localPosition,.5),la.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(Vx,la,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))}_fingerIsClosed(e){const t=this._fingers[e];return la.sub2(t.joints[0]._localPosition,t.joints[1]._localPosition).normalize(),Tu.sub2(t.joints[2]._localPosition,t.joints[3]._localPosition).normalize(),la.dot(Tu)<-.8}getJointById(e){return this._jointsById[e]||null}get fingers(){return this._fingers}get joints(){return this._joints}get tips(){return this._tips}get wrist(){return this._wrist}get tracking(){return this._tracking}}b0.EVENT_TRACKING="tracking";b0.EVENT_TRACKINGLOST="trackinglost";const Gx=new y,Hx=new re;let aV=0;class vs extends ie{constructor(e,t){super(),this._id=void 0,this._manager=void 0,this._xrInputSource=void 0,this._ray=new Ga,this._rayLocal=new Ga,this._grip=!1,this._hand=null,this._velocitiesAvailable=!1,this._velocitiesTimestamp=Zi(),this._localTransform=null,this._worldTransform=null,this._position=new y,this._rotation=new re,this._localPosition=null,this._localPositionLast=null,this._localRotation=null,this._linearVelocity=null,this._dirtyLocal=!0,this._dirtyRay=!1,this._selecting=!1,this._squeezing=!1,this._elementInput=!0,this._elementEntity=null,this._hitTestSources=[],this._id=++aV,this._manager=e,this._xrInputSource=t,t.hand&&(this._hand=new b0(this))}get id(){return this._id}get inputSource(){return this._xrInputSource}get targetRayMode(){return this._xrInputSource.targetRayMode}get handedness(){return this._xrInputSource.handedness}get profiles(){return this._xrInputSource.profiles}get grip(){return this._grip}get hand(){return this._hand}get gamepad(){return this._xrInputSource.gamepad||null}get selecting(){return this._selecting}get squeezing(){return this._squeezing}set elementInput(e){this._elementInput!==e&&(this._elementInput=e,this._elementInput||(this._elementEntity=null))}get elementInput(){return this._elementInput}get elementEntity(){return this._elementEntity}get hitTestSources(){return this._hitTestSources}update(e){if(this._hand)this._hand.update(e);else{const t=this._xrInputSource.gripSpace;if(t){const i=e.getPose(t,this._manager._referenceSpace);if(i){this._grip||(this._grip=!0,this._localTransform=new q,this._worldTransform=new q,this._localPositionLast=new y,this._localPosition=new y,this._localRotation=new re,this._linearVelocity=new y);const n=Zi(),a=(n-this._velocitiesTimestamp)/1e3;this._velocitiesTimestamp=n,this._dirtyLocal=!0,this._localPositionLast.copy(this._localPosition),this._localPosition.copy(i.transform.position),this._localRotation.copy(i.transform.orientation),this._velocitiesAvailable=!0,this._manager.input.velocitiesSupported&&i.linearVelocity?this._linearVelocity.copy(i.linearVelocity):a>0&&(Gx.sub2(this._localPosition,this._localPositionLast).divScalar(a),this._linearVelocity.lerp(this._linearVelocity,Gx,.15))}else this._velocitiesAvailable=!1}const s=e.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);s&&(this._dirtyRay=!0,this._rayLocal.origin.copy(s.transform.position),this._rayLocal.direction.set(0,0,-1),Hx.copy(s.transform.orientation),Hx.transformVector(this._rayLocal.direction,this._rayLocal.direction))}}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,y.ONE));const e=this._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}_updateRayTransforms(){const e=this._dirtyRay;if(this._dirtyRay=!1,this._manager.camera.parent){const s=this._manager.camera.parent.getWorldTransform();s.getTranslation(this._position),this._rotation.setFromMat4(s),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else e&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))}getPosition(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null}getLocalPosition(){return this._localPosition}getRotation(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null}getLocalRotation(){return this._localRotation}getLinearVelocity(){return this._velocitiesAvailable?this._linearVelocity:null}getOrigin(){return this._updateRayTransforms(),this._ray.origin}getDirection(){return this._updateRayTransforms(),this._ray.direction}hitTestStart(e={}){e.inputSource=this,e.profile=this._xrInputSource.profiles[0];const t=e.callback;e.callback=(s,i)=>{i&&this.onHitTestSourceAdd(i),t&&t(s,i)},this._manager.hitTest.start(e)}onHitTestSourceAdd(e){this._hitTestSources.push(e),this.fire("hittest:add",e),e.on("result",(t,s,i,n)=>{i===this&&this.fire("hittest:result",e,t,s,n)}),e.once("remove",()=>{this.onHitTestSourceRemove(e),this.fire("hittest:remove",e)})}onHitTestSourceRemove(e){const t=this._hitTestSources.indexOf(e);t!==-1&&this._hitTestSources.splice(t,1)}}vs.EVENT_REMOVE="remove";vs.EVENT_SELECT="select";vs.EVENT_SELECTSTART="selectstart";vs.EVENT_SELECTEND="selectend";vs.EVENT_SQUEEZE="squeeze";vs.EVENT_SQUEEZESTART="squeezestart";vs.EVENT_SQUEEZEEND="squeezeend";vs.EVENT_HITTESTADD="hittest:add";vs.EVENT_HITTESTREMOVE="hittest:remove";vs.EVENT_HITTESTRESULT="hittest:result";class Yn extends ie{constructor(e){var t;super(),this.manager=void 0,this._inputSources=[],this._onInputSourcesChangeEvt=void 0,this.velocitiesSupported=!1,this.manager=e,this.velocitiesSupported=!!(Te.browser&&(t=window.XRPose)!=null&&(t=t.prototype)!=null&&t.hasOwnProperty("linearVelocity")),this._onInputSourcesChangeEvt=s=>{this._onInputSourcesChange(s)},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this)}_onSessionStart(){const e=this.manager.session;e.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),e.addEventListener("select",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i.fire("select",s),this.fire("select",i,s)}),e.addEventListener("selectstart",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i._selecting=!0,i.fire("selectstart",s),this.fire("selectstart",i,s)}),e.addEventListener("selectend",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i._selecting=!1,i.fire("selectend",s),this.fire("selectend",i,s)}),e.addEventListener("squeeze",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i.fire("squeeze",s),this.fire("squeeze",i,s)}),e.addEventListener("squeezestart",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i._squeezing=!0,i.fire("squeezestart",s),this.fire("squeezestart",i,s)}),e.addEventListener("squeezeend",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i._squeezing=!1,i.fire("squeezeend",s),this.fire("squeezeend",i,s)});const t=e.inputSources;for(let s=0;s<t.length;s++)this._addInputSource(t[s])}_onSessionEnd(){let e=this._inputSources.length;for(;e--;){const s=this._inputSources[e];this._inputSources.splice(e,1),s.fire("remove"),this.fire("remove",s)}this.manager.session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt)}_onInputSourcesChange(e){for(let t=0;t<e.removed.length;t++)this._removeInputSource(e.removed[t]);for(let t=0;t<e.added.length;t++)this._addInputSource(e.added[t])}_getByInputSource(e){for(let t=0;t<this._inputSources.length;t++)if(this._inputSources[t].inputSource===e)return this._inputSources[t];return null}_addInputSource(e){if(this._getByInputSource(e))return;const t=new vs(this.manager,e);this._inputSources.push(t),this.fire("add",t)}_removeInputSource(e){for(let t=0;t<this._inputSources.length;t++){if(this._inputSources[t].inputSource!==e)continue;const s=this._inputSources[t];this._inputSources.splice(t,1);let i=s.hitTestSources.length;for(;i--;)s.hitTestSources[i].remove();s.fire("remove"),this.fire("remove",s);return}}update(e){for(let t=0;t<this._inputSources.length;t++)this._inputSources[t].update(e)}get inputSources(){return this._inputSources}}Yn.EVENT_ADD="add";Yn.EVENT_REMOVE="remove";Yn.EVENT_SELECT="select";Yn.EVENT_SELECTSTART="selectstart";Yn.EVENT_SELECTEND="selectend";Yn.EVENT_SQUEEZE="squeeze";Yn.EVENT_SQUEEZESTART="squeezestart";Yn.EVENT_SQUEEZEEND="squeezeend";const Go=new y,Wx=new y,y_=new q,jx=new q;class T0 extends ie{constructor(e){super(),this._manager=void 0,this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null,this._intensity=0,this._rotation=new re,this._color=new k,this._sphericalHarmonics=new Float32Array(27),this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}_onSessionStart(){this._manager.session.requestLightProbe&&(this._supported=!0)}_onSessionEnd(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null}start(){let e;if(this._manager.session||(e=new Error("XR session is not running")),!e&&this._manager.type!==nc&&(e=new Error("XR session type is not AR")),!e&&!this._supported&&(e=new Error("light-estimation is not supported")),(!e&&this._lightProbe||this._lightProbeRequested)&&(e=new Error("light estimation is already requested")),e){this.fire("error",e);return}this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then(t=>{const s=this._lightProbeRequested;this._lightProbeRequested=!1,this._manager.active?s&&(this._lightProbe=t):this.fire("error",new Error("XR session is not active"))}).catch(t=>{this._lightProbeRequested=!1,this.fire("error",t)})}end(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1}update(e){if(!this._lightProbe)return;const t=e.getLightEstimate(this._lightProbe);if(!t)return;this._available||(this._available=!0,this.fire("available"));const s=t.primaryLightIntensity;this._intensity=Math.max(1,Math.max(s.x,Math.max(s.y,s.z))),Go.copy(s).mulScalar(1/this._intensity),this._color.set(Go.x,Go.y,Go.z),Go.set(0,0,0),Wx.copy(t.primaryLightDirection),y_.setLookAt(Wx,Go,y.UP),jx.setFromAxisAngle(y.RIGHT,90),y_.mul(jx),this._rotation.setFromMat4(y_),this._sphericalHarmonics.set(t.sphericalHarmonicsCoefficients)}get supported(){return this._supported}get available(){return this._available}get intensity(){return this._available?this._intensity:null}get color(){return this._available?this._color:null}get rotation(){return this._available?this._rotation:null}get sphericalHarmonics(){return this._available?this._sphericalHarmonics:null}}T0.EVENT_AVAILABLE="available";T0.EVENT_ERROR="error";let oV=0;class E0 extends ie{constructor(e,t){super(),this._id=void 0,this._planeDetection=void 0,this._xrPlane=void 0,this._lastChangedTime=void 0,this._orientation=void 0,this._position=new y,this._rotation=new re,this._id=++oV,this._planeDetection=e,this._xrPlane=t,this._lastChangedTime=t.lastChangedTime,this._orientation=t.orientation}destroy(){this._xrPlane&&(this._xrPlane=null,this.fire("remove"))}update(e){const t=this._planeDetection._manager,s=e.getPose(this._xrPlane.planeSpace,t._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}get id(){return this._id}get orientation(){return this._orientation}get points(){return this._xrPlane.polygon}get label(){return this._xrPlane.semanticLabel||""}}E0.EVENT_REMOVE="remove";E0.EVENT_CHANGE="change";class Ld extends ie{constructor(e){super(),this._manager=void 0,this._supported=Te.browser&&!!window.XRPlane,this._available=!1,this._planesIndex=new Map,this._planes=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}_onSessionStart(){this._supported&&this._manager.session.enabledFeatures.indexOf("plane-detection")!==-1&&(this._available=!0,this.fire("available"))}_onSessionEnd(){for(let e=0;e<this._planes.length;e++)this._planes[e].destroy(),this.fire("remove",this._planes[e]);this._planesIndex.clear(),this._planes.length=0,this._available&&(this._available=!1,this.fire("unavailable"))}update(e){if(!this._supported||!this._available)return;const t=e.detectedPlanes;for(const[s,i]of this._planesIndex)t.has(s)||(this._planesIndex.delete(s),this._planes.splice(this._planes.indexOf(i),1),i.destroy(),this.fire("remove",i));for(const s of t){let i=this._planesIndex.get(s);i?i.update(e):(i=new E0(this,s),this._planesIndex.set(s,i),this._planes.push(i),i.update(e),this.fire("add",i))}}get supported(){return this._supported}get available(){return this._available}get planes(){return this._planes}}Ld.EVENT_AVAILABLE="available";Ld.EVENT_UNAVAILABLE="unavailable";Ld.EVENT_ADD="add";Ld.EVENT_REMOVE="remove";class Dd extends ie{constructor(e,t,s=null){super(),this._position=new y,this._rotation=new re,this._uuid=null,this._uuidRequests=null,this._anchors=e,this._xrAnchor=t,this._uuid=s}destroy(){if(!this._xrAnchor)return;const e=this._xrAnchor;this._xrAnchor.delete(),this._xrAnchor=null,this.fire("destroy",e,this)}update(e){if(!this._xrAnchor)return;const t=e.getPose(this._xrAnchor.anchorSpace,this._anchors.manager._referenceSpace);if(t){if(this._position.equals(t.transform.position)&&this._rotation.equals(t.transform.orientation))return;this._position.copy(t.transform.position),this._rotation.copy(t.transform.orientation),this.fire("change")}}getPosition(){return this._position}getRotation(){return this._rotation}persist(e){if(!this._anchors.persistence){e==null||e(new Error("Persistent Anchors are not supported"),null);return}if(this._uuid){e==null||e(null,this._uuid);return}if(this._uuidRequests){e&&this._uuidRequests.push(e);return}this._uuidRequests=[],this._xrAnchor.requestPersistentHandle().then(t=>{this._uuid=t,this._anchors._indexByUuid.set(this._uuid,this),e==null||e(null,t);for(let s=0;s<this._uuidRequests.length;s++)this._uuidRequests[s](null,t);this._uuidRequests=null,this.fire("persist",t)}).catch(t=>{e==null||e(t,null);for(let s=0;s<this._uuidRequests.length;s++)this._uuidRequests[s](t);this._uuidRequests=null})}forget(e){if(!this._uuid){e==null||e(new Error("Anchor is not persistent"));return}this._anchors.forget(this._uuid,t=>{this._uuid=null,e==null||e(t),this.fire("forget")})}get uuid(){return this._uuid}get persistent(){return!!this._uuid}}Dd.EVENT_DESTROY="destroy";Dd.EVENT_CHANGE="change";Dd.EVENT_PERSIST="persist";Dd.EVENT_FORGET="forget";class rh extends ie{constructor(e){var t;super(),this.manager=void 0,this._supported=Te.browser&&!!window.XRAnchor,this._available=!1,this._persistence=Te.browser&&!!((t=window)!=null&&(t=t.XRSession)!=null&&t.prototype.restorePersistentAnchor),this._creationQueue=[],this._index=new Map,this._indexByUuid=new Map,this._list=[],this._callbacksAnchors=new Map,this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){const e=this.manager.session.enabledFeatures.indexOf("anchors")!==-1;e&&(this._available=e,this.fire("available"))}_onSessionEnd(){if(!this._available)return;this._available=!1;for(let t=0;t<this._creationQueue.length;t++)this._creationQueue[t].callback&&this._creationQueue[t].callback(new Error("session ended"),null);this._creationQueue.length=0,this._index.clear(),this._indexByUuid.clear();let e=this._list.length;for(;e--;)this._list[e].destroy();this._list.length=0,this.fire("unavailable")}_createAnchor(e,t=null){const s=new Dd(this,e,t);return this._index.set(e,s),t&&this._indexByUuid.set(t,s),this._list.push(s),s.once("destroy",this._onAnchorDestroy,this),s}_onAnchorDestroy(e,t){this._index.delete(e),t.uuid&&this._indexByUuid.delete(t.uuid);const s=this._list.indexOf(t);s!==-1&&this._list.splice(s,1),this.fire("destroy",t)}create(e,t,s){if(!this._available){s==null||s(new Error("Anchors API is not available"),null);return}if(window.XRHitTestResult&&e instanceof XRHitTestResult){const i=e;if(s=t,!this._supported){s==null||s(new Error("Anchors API is not supported"),null);return}if(!i.createAnchor){s==null||s(new Error("Creating Anchor from Hit Test is not supported"),null);return}i.createAnchor().then(n=>{const a=this._createAnchor(n);s==null||s(null,a),this.fire("add",a)}).catch(n=>{s==null||s(n,null),this.fire("error",n)})}else this._creationQueue.push({transform:new XRRigidTransform(e,t),callback:s})}restore(e,t){if(!this._available){t==null||t(new Error("Anchors API is not available"),null);return}if(!this._persistence){t==null||t(new Error("Anchor Persistence is not supported"),null);return}if(!this.manager.active){t==null||t(new Error("WebXR session is not active"),null);return}this.manager.session.restorePersistentAnchor(e).then(s=>{const i=this._createAnchor(s,e);t==null||t(null,i),this.fire("add",i)}).catch(s=>{t==null||t(s,null),this.fire("error",s)})}forget(e,t){if(!this._available){t==null||t(new Error("Anchors API is not available"));return}if(!this._persistence){t==null||t(new Error("Anchor Persistence is not supported"));return}if(!this.manager.active){t==null||t(new Error("WebXR session is not active"));return}this.manager.session.deletePersistentAnchor(e).then(()=>{t==null||t(null)}).catch(s=>{t==null||t(s),this.fire("error",s)})}update(e){if(this._available){if(this._creationQueue.length){for(let t=0;t<this._creationQueue.length;t++){const s=this._creationQueue[t];e.createAnchor(s.transform,this.manager._referenceSpace).then(i=>{s.callback&&this._callbacksAnchors.set(i,s.callback)}).catch(i=>{s.callback&&s.callback(i,null),this.fire("error",i)})}this._creationQueue.length=0}for(const[t,s]of this._index)e.trackedAnchors.has(t)||(this._index.delete(t),s.destroy());for(let t=0;t<this._list.length;t++)this._list[t].update(e);for(const t of e.trackedAnchors){if(this._index.has(t))continue;try{const n=t.anchorSpace}catch{continue}const s=this._createAnchor(t);s.update(e);const i=this._callbacksAnchors.get(t);i&&(this._callbacksAnchors.delete(t),i(null,s)),this.fire("add",s)}}}get supported(){return this._supported}get available(){return this._available}get persistence(){return this._persistence}get uuids(){return!this._available||!this._persistence||!this.manager.active?null:this.manager.session.persistentAnchors}get list(){return this._list}}rh.EVENT_AVAILABLE="available";rh.EVENT_UNAVAILABLE="unavailable";rh.EVENT_ERROR="error";rh.EVENT_ADD="add";rh.EVENT_DESTROY="destroy";class C0 extends ie{constructor(e,t){super(),this._meshDetection=void 0,this._xrMesh=void 0,this._lastChanged=0,this._position=new y,this._rotation=new re,this._meshDetection=e,this._xrMesh=t,this._lastChanged=this._xrMesh.lastChangedTime}get xrMesh(){return this._xrMesh}get label(){return this._xrMesh.semanticLabel||""}get vertices(){return this._xrMesh.vertices}get indices(){return this._xrMesh.indices}destroy(){this._xrMesh&&(this._xrMesh=null,this.fire("remove"))}update(e){const t=this._meshDetection._manager,s=e.getPose(this._xrMesh.meshSpace,t._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChanged!==this._xrMesh.lastChangedTime&&(this._lastChanged=this._xrMesh.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}}C0.EVENT_REMOVE="remove";C0.EVENT_CHANGE="change";class Od extends ie{constructor(e){super(),this._manager=void 0,this._supported=Te.browser&&!!window.XRMesh,this._available=!1,this._index=new Map,this._list=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}update(e){if(!(!this._supported||!this._available)){for(const t of e.detectedMeshes){let s=this._index.get(t);s?s.update(e):(s=new C0(this,t),this._index.set(t,s),this._list.push(s),s.update(e),this.fire("add",s))}for(const t of this._index.values())e.detectedMeshes.has(t.xrMesh)||this._removeMesh(t)}}_removeMesh(e){this._index.delete(e.xrMesh),this._list.splice(this._list.indexOf(e),1),e.destroy(),this.fire("remove",e)}_onSessionStart(){const e=this._manager.session.enabledFeatures.indexOf("mesh-detection")!==-1;e&&(this._available=e,this.fire("available"))}_onSessionEnd(){if(this._available){this._available=!1;for(const e of this._index.values())this._removeMesh(e);this.fire("unavailable")}}get supported(){return this._supported}get available(){return this._available}get meshes(){return this._list}}Od.EVENT_AVAILABLE="available";Od.EVENT_UNAVAILABLE="unavailable";Od.EVENT_ADD="add";Od.EVENT_REMOVE="remove";class QT extends ie{constructor(e,t,s){super(),this._manager=void 0,this._xrView=void 0,this._positionData=new Float32Array(3),this._viewport=new P,this._projMat=new q,this._projViewOffMat=new q,this._viewMat=new q,this._viewOffMat=new q,this._viewMat3=new hi,this._viewInvMat=new q,this._viewInvOffMat=new q,this._xrCamera=null,this._textureColor=null,this._textureDepth=null,this._depthInfo=null,this._emptyDepthBuffer=new Uint8Array(32),this._depthMatrix=new q,this._manager=e,this._xrView=t;const i=this._manager.app.graphicsDevice;if(this._manager.views.supportedColor&&(this._xrCamera=this._xrView.camera,this._manager.views.availableColor&&this._xrCamera&&(this._textureColor=new _e(i,{format:Gn,mipmaps:!1,addressU:ae,addressV:ae,minFilter:nt,magFilter:nt,width:this._xrCamera.width,height:this._xrCamera.height,name:`XrView-${this._xrView.eye}-Color`}))),this._manager.views.supportedDepth&&this._manager.views.availableDepth){this._textureDepth=new _e(i,{format:this._manager.views.depthPixelFormat,arrayLength:s===1?0:s,mipmaps:!1,addressU:ae,addressV:ae,minFilter:nt,magFilter:nt,width:4,height:4,name:`XrView-${this._xrView.eye}-Depth`});for(let n=0;n<this._textureDepth._levels.length;n++)this._textureDepth._levels[n]=this._emptyDepthBuffer}(this._textureColor||this._textureDepth)&&i.on("devicelost",this._onDeviceLost,this)}get textureColor(){return this._textureColor}get textureDepth(){return this._textureDepth}get depthUvMatrix(){return this._depthMatrix}get depthValueToMeters(){var e;return((e=this._depthInfo)==null?void 0:e.rawValueToMeters)||0}get eye(){return this._xrView.eye}get viewport(){return this._viewport}get projMat(){return this._projMat}get projViewOffMat(){return this._projViewOffMat}get viewOffMat(){return this._viewOffMat}get viewInvOffMat(){return this._viewInvOffMat}get viewMat3(){return this._viewMat3}get positionData(){return this._positionData}update(e,t){this._xrView=t,this._manager.views.availableColor&&(this._xrCamera=this._xrView.camera);const i=e.session.renderState.baseLayer.getViewport(this._xrView);this._viewport.x=i.x,this._viewport.y=i.y,this._viewport.z=i.width,this._viewport.w=i.height,this._projMat.set(this._xrView.projectionMatrix),this._viewMat.set(this._xrView.transform.inverse.matrix),this._viewInvMat.set(this._xrView.transform.matrix),this._updateTextureColor(),this._updateDepth(e)}_updateTextureColor(){if(!this._manager.views.availableColor||!this._xrCamera||!this._textureColor)return;const e=this._manager.webglBinding;if(!e)return;const t=e.getCameraImage(this._xrCamera);if(!t)return;const s=this._manager.app.graphicsDevice,i=s.gl;if(!this._frameBufferSource)this._frameBufferSource=i.createFramebuffer(),this._frameBuffer=i.createFramebuffer();else{var n,a;const o=s.isWebGL2?i.COLOR_ATTACHMENT0:(n=(a=s.extDrawBuffers)==null?void 0:a.COLOR_ATTACHMENT0_WEBGL)!=null?n:i.COLOR_ATTACHMENT0,l=this._xrCamera.width,c=this._xrCamera.height;s.setFramebuffer(this._frameBufferSource),i.framebufferTexture2D(i.FRAMEBUFFER,o,i.TEXTURE_2D,t,0),s.setFramebuffer(this._frameBuffer),i.framebufferTexture2D(i.FRAMEBUFFER,o,i.TEXTURE_2D,this._textureColor.impl._glTexture,0),i.bindFramebuffer(i.READ_FRAMEBUFFER,this._frameBufferSource),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this._frameBuffer),i.blitFramebuffer(0,c,l,0,0,0,l,c,i.COLOR_BUFFER_BIT,i.NEAREST)}}_updateDepth(e){var t,s;if(!this._manager.views.availableDepth||!this._textureDepth)return;const i=this._manager.views.depthGpuOptimized,n=i?this._manager.webglBinding:e;if(!n){this._depthInfo=null;return}const a=n.getDepthInformation(this._xrView);if(!a){this._depthInfo=null;return}let o=!this._depthInfo!=!a;this._depthInfo=a;const l=((t=this._depthInfo)==null?void 0:t.width)||4,c=((s=this._depthInfo)==null?void 0:s.height)||4;let d=!1;(this._textureDepth.width!==l||this._textureDepth.height!==c)&&(this._textureDepth._width=l,this._textureDepth._height=c,o=!0,d=!0),o&&(this._depthInfo?this._depthMatrix.data.set(this._depthInfo.normDepthBufferFromNormView.matrix):this._depthMatrix.setIdentity()),this._depthInfo?i?this._depthInfo.texture&&(this._textureDepth.impl._glTexture=this._depthInfo.texture):(this._textureDepth._levels[0]=new Uint8Array(this._depthInfo.data),this._textureDepth.upload()):(this._textureDepth._levels[0]=this._emptyDepthBuffer,this._textureDepth.upload()),d&&this.fire("depth:resize",l,c)}updateTransforms(e){e?(this._viewInvOffMat.mul2(e,this._viewInvMat),this.viewOffMat.copy(this._viewInvOffMat).invert()):(this._viewInvOffMat.copy(this._viewInvMat),this.viewOffMat.copy(this._viewMat)),this._viewMat3.setFromMat4(this._viewOffMat),this._projViewOffMat.mul2(this._projMat,this._viewOffMat),this._positionData[0]=this._viewInvOffMat.data[12],this._positionData[1]=this._viewInvOffMat.data[13],this._positionData[2]=this._viewInvOffMat.data[14]}_onDeviceLost(){this._frameBufferSource=null,this._frameBuffer=null,this._depthInfo=null}getDepth(e,t){var s,i;return this._manager.views.depthGpuOptimized?null:(s=(i=this._depthInfo)==null?void 0:i.getDepthInMeters(e,t))!=null?s:null}destroy(){if(this._depthInfo=null,this._textureColor&&(this._textureColor.destroy(),this._textureColor=null),this._textureDepth&&(this._textureDepth.destroy(),this._textureDepth=null),this._frameBufferSource){const e=this._manager.app.graphicsDevice.gl;e.deleteFramebuffer(this._frameBufferSource),this._frameBufferSource=null,e.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null}}}QT.EVENT_DEPTHRESIZE="depth:resize";class Pf extends ie{constructor(e){super(),this._manager=void 0,this._index=new Map,this._indexTmp=new Map,this._list=[],this._supportedColor=Te.browser&&!!window.XRCamera&&!!window.XRWebGLBinding,this._supportedDepth=Te.browser&&!!window.XRDepthInformation,this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._depthFormats={[YT]:lp,[iV]:Bn},this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}get list(){return this._list}get supportedColor(){return this._supportedColor}get supportedDepth(){return this._supportedDepth}get availableColor(){return this._availableColor}get availableDepth(){return this._availableDepth}get depthUsage(){return this._depthUsage}get depthGpuOptimized(){return this._depthUsage===sV}get depthFormat(){return this._depthFormat}get depthPixelFormat(){var e;return(e=this._depthFormats[this._depthFormat])!=null?e:null}update(e,t){for(let s=0;s<t.length;s++)this._indexTmp.set(t[s].eye,t[s]);for(const[s,i]of this._indexTmp){let n=this._index.get(s);n?n.update(e,i):(n=new QT(this._manager,i,t.length),this._index.set(s,n),this._list.push(n),n.update(e,i),this.fire("add",n))}for(const[s,i]of this._index){if(this._indexTmp.has(s))continue;i.destroy(),this._index.delete(s);const n=this._list.indexOf(i);n!==-1&&this._list.splice(n,1),this.fire("remove",i)}this._indexTmp.clear()}get(e){return this._index.get(e)||null}_onSessionStart(){if(this._manager.type===nc&&(this._availableColor=this._manager.session.enabledFeatures.indexOf("camera-access")!==-1,this._availableDepth=this._manager.session.enabledFeatures.indexOf("depth-sensing")!==-1,this._availableDepth)){const e=this._manager.session;this._depthUsage=e.depthUsage,this._depthFormat=e.depthDataFormat}}_onSessionEnd(){for(const e of this._index.values())e.destroy();this._index.clear(),this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._list.length=0}}Pf.EVENT_ADD="add";Pf.EVENT_REMOVE="remove";class ah extends ie{constructor(e){super(),this.app=void 0,this._supported=Te.browser&&!!navigator.xr,this._available={},this._type=null,this._spaceType=null,this._session=null,this._baseLayer=null,this.webglBinding=null,this._referenceSpace=null,this.depthSensing=void 0,this.domOverlay=void 0,this.hitTest=void 0,this.imageTracking=void 0,this.planeDetection=void 0,this.meshDetection=void 0,this.input=void 0,this.lightEstimation=void 0,this.views=void 0,this.anchors=void 0,this._camera=null,this._localPosition=new y,this._localRotation=new re,this._depthNear=.1,this._depthFar=1e3,this._supportedFrameRates=null,this._width=0,this._height=0,this._framebufferScaleFactor=1,this.app=e,this._available[Zz]=!1,this._available[Jz]=!1,this._available[nc]=!1,this.views=new Pf(this),this.depthSensing=new im(this),this.domOverlay=new nV(this),this.hitTest=new po(this),this.imageTracking=new ZT(this),this.planeDetection=new Ld(this),this.meshDetection=new Od(this),this.input=new Yn(this),this.lightEstimation=new T0(this),this.anchors=new rh(this),this.views=new Pf(this),this._supported&&(navigator.xr.addEventListener("devicechange",()=>{this._deviceAvailabilityCheck()}),this._deviceAvailabilityCheck(),this.app.graphicsDevice.on("devicelost",this._onDeviceLost,this),this.app.graphicsDevice.on("devicerestored",this._onDeviceRestored,this))}destroy(){}start(e,t,s,i){var n,a,o;let l=i;if(typeof i=="object"&&(l=i.callback),!this._available[t]){l&&l(new Error("XR is not available"));return}if(this._session){l&&l(new Error("XR session is already started"));return}this._camera=e,this._camera.camera.xr=this,this._type=t,this._spaceType=s,this._framebufferScaleFactor=(n=i==null?void 0:i.framebufferScaleFactor)!=null?n:1,this._setClipPlanes(e.nearClip,e.farClip);const c={requiredFeatures:[s],optionalFeatures:[]},d=((a=this.app.graphicsDevice)==null?void 0:a.isWebGL1)||((o=this.app.graphicsDevice)==null?void 0:o.isWebGL2);if(t===nc){if(c.optionalFeatures.push("light-estimation"),c.optionalFeatures.push("hit-test"),i&&(i.imageTracking&&this.imageTracking.supported&&c.optionalFeatures.push("image-tracking"),i.planeDetection&&c.optionalFeatures.push("plane-detection"),i.meshDetection&&c.optionalFeatures.push("mesh-detection")),this.domOverlay.supported&&this.domOverlay.root&&(c.optionalFeatures.push("dom-overlay"),c.domOverlay={root:this.domOverlay.root}),i&&i.anchors&&this.anchors.supported&&c.optionalFeatures.push("anchors"),i&&i.depthSensing&&this.depthSensing.supported){c.optionalFeatures.push("depth-sensing");const h=[tV],u=[YT];if(i.depthSensing.usagePreference){const f=h.indexOf(i.depthSensing.usagePreference);f!==-1&&h.splice(f,1),h.unshift(i.depthSensing.usagePreference)}if(i.depthSensing.dataFormatPreference){const f=u.indexOf(i.depthSensing.dataFormatPreference);f!==-1&&u.splice(f,1),u.unshift(i.depthSensing.dataFormatPreference)}c.depthSensing={usagePreference:h,dataFormatPreference:u}}d&&i&&i.cameraColor&&this.views.supportedColor&&c.optionalFeatures.push("camera-access")}c.optionalFeatures.push("hand-tracking"),i&&i.optionalFeatures&&(c.optionalFeatures=c.optionalFeatures.concat(i.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages((h,u)=>{if(h){l&&l(h),this.fire("error",h);return}u!==null&&(c.trackedImages=u),this._onStartOptionsReady(t,s,c,l)}):this._onStartOptionsReady(t,s,c,l)}_onStartOptionsReady(e,t,s,i){navigator.xr.requestSession(e,s).then(n=>{this._onSessionStart(n,t,i)}).catch(n=>{this._camera.camera.xr=null,this._camera=null,this._type=null,this._spaceType=null,i&&i(n),this.fire("error",n)})}end(e){if(!this._session){e&&e(new Error("XR Session is not initialized"));return}this.webglBinding=null,e&&this.once("end",e),this._session.end()}isAvailable(e){return this._available[e]}_deviceAvailabilityCheck(){for(const e in this._available)this._sessionSupportCheck(e)}initiateRoomCapture(e){if(!this._session){e(new Error("Session is not active"));return}if(!this._session.initiateRoomCapture){e(new Error("Session does not support manual room capture"));return}this._session.initiateRoomCapture().then(()=>{e&&e(null)}).catch(t=>{e&&e(t)})}updateTargetFrameRate(e,t){var s;if(!((s=this._session)!=null&&s.updateTargetFrameRate)){t==null||t(new Error("unable to update frameRate"));return}this._session.updateTargetFrameRate(e).then(()=>{t==null||t()}).catch(i=>{t==null||t(i)})}_sessionSupportCheck(e){navigator.xr.isSessionSupported(e).then(t=>{this._available[e]!==t&&(this._available[e]=t,this.fire("available",e,t),this.fire("available:"+e,t))}).catch(t=>{this.fire("error",t)})}_onSessionStart(e,t,s){let i=!1;this._session=e;const n=()=>{this.fire("visibility:change",e.visibilityState)},a=()=>{this._setClipPlanes(this._camera.nearClip,this._camera.farClip)},o=()=>{this._camera&&(this._camera.off("set_nearClip",a),this._camera.off("set_farClip",a),this._camera.camera.xr=null,this._camera=null),e.removeEventListener("end",o),e.removeEventListener("visibilitychange",n),i||this.fire("end"),this._session=null,this._referenceSpace=null,this._width=0,this._height=0,this._type=null,this._spaceType=null,this.app.systems&&this.app.tick()};e.addEventListener("end",o),e.addEventListener("visibilitychange",n),this._camera.on("set_nearClip",a),this._camera.on("set_farClip",a),this._createBaseLayer(),this.session.supportedFrameRates?this._supportedFrameRates=Array.from(this.session.supportedFrameRates):this._supportedFrameRates=null,this._session.addEventListener("frameratechange",()=>{var l;this.fire("frameratechange",(l=this._session)==null?void 0:l.frameRate)}),e.requestReferenceSpace(t).then(l=>{this._referenceSpace=l,this.app.tick(),s&&s(null),this.fire("start")}).catch(l=>{i=!0,e.end(),s&&s(l),this.fire("error",l)})}_setClipPlanes(e,t){this._depthNear===e&&this._depthFar===t||(this._depthNear=e,this._depthFar=t,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))}_createBaseLayer(){const e=this.app.graphicsDevice,t=e.maxPixelRatio/window.devicePixelRatio*this._framebufferScaleFactor;this._baseLayer=new XRWebGLLayer(this._session,e.gl,{alpha:!0,depth:!0,stencil:!0,framebufferScaleFactor:t,antialias:!1});const s=e.deviceType;if((s===Yh||s===Zo)&&window.XRWebGLBinding)try{this.webglBinding=new XRWebGLBinding(this._session,e.gl)}catch(i){this.fire("error",i)}this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar})}_onDeviceLost(){this._session&&(this.webglBinding&&(this.webglBinding=null),this._baseLayer=null,this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}))}_onDeviceRestored(){this._session&&setTimeout(()=>{this.app.graphicsDevice.gl.makeXRCompatible().then(()=>{this._createBaseLayer()}).catch(e=>{this.fire("error",e)})},0)}update(e){if(!this._session)return!1;const t=e.session.renderState.baseLayer.framebufferWidth,s=e.session.renderState.baseLayer.framebufferHeight;(this._width!==t||this._height!==s)&&(this._width=t,this._height=s,this.app.graphicsDevice.setResolution(t,s));const i=e.getViewerPose(this._referenceSpace);if(!i)return!1;const n=this.views.list.length;this.views.update(e,i.views);const a=i.transform.position,o=i.transform.orientation;if(this._localPosition.set(a.x,a.y,a.z),this._localRotation.set(o.x,o.y,o.z,o.w),n===0&&this.views.list.length>0){const l=new q,c=this.views.list[0];l.copy(c.projMat);const d=l.data,h=2*Math.atan(1/d[5])*180/Math.PI,u=d[5]/d[0],f=d[14]/(d[10]+1),p=d[14]/(d[10]-1);this._camera.camera.setXrProperties({aspectRatio:u,farClip:f,fov:h,horizontalFov:!1,nearClip:p})}return this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(e),this._type===nc&&(this.hitTest.supported&&this.hitTest.update(e),this.lightEstimation.supported&&this.lightEstimation.update(e),this.imageTracking.supported&&this.imageTracking.update(e),this.anchors.supported&&this.anchors.update(e),this.planeDetection.supported&&this.planeDetection.update(e),this.depthSensing.supported&&this.depthSensing.update(),this.meshDetection.supported&&this.meshDetection.update(e)),this.fire("update",e),!0}get supported(){return this._supported}get active(){return!!this._session}get type(){return this._type}get spaceType(){return this._spaceType}get session(){return this._session}get frameRate(){var e,t;return(e=(t=this._session)==null?void 0:t.frameRate)!=null?e:null}get supportedFrameRates(){return this._supportedFrameRates}get framebufferScaleFactor(){return this._framebufferScaleFactor}set fixedFoveation(e){var t,s;((t=(s=this._baseLayer)==null?void 0:s.fixedFoveation)!=null?t:null)!==null&&(this.app.graphicsDevice.samples>1,this._baseLayer.fixedFoveation=e)}get fixedFoveation(){var e,t;return(e=(t=this._baseLayer)==null?void 0:t.fixedFoveation)!=null?e:null}get camera(){return this._camera?this._camera.entity:null}get visibilityState(){return this._session?this._session.visibilityState:null}}ah.EVENT_AVAILABLE="available";ah.EVENT_START="start";ah.EVENT_END="end";ah.EVENT_UPDATE="update";ah.EVENT_ERROR="error";class lV extends gt{constructor(e,t={}){var s;super(e);const i=new Uk;i.graphicsDevice=(s=t.graphicsDevice)!=null?s:this.createDevice(e,t),this.addComponentSystems(i),this.addResourceHandles(i),i.elementInput=t.elementInput,i.keyboard=t.keyboard,i.mouse=t.mouse,i.touch=t.touch,i.gamepads=t.gamepads,i.scriptPrefix=t.scriptPrefix,i.assetPrefix=t.assetPrefix,i.scriptsOrder=t.scriptsOrder,i.soundManager=new Xp,i.lightmapper=$k,i.batchManager=V2,i.xr=ah,this.init(i)}createDevice(e,t){return t.graphicsDeviceOptions||(t.graphicsDeviceOptions={}),Te.browser&&navigator.xr&&(t.graphicsDeviceOptions.xrCompatible=!0),t.graphicsDeviceOptions.alpha=t.graphicsDeviceOptions.alpha||!1,new Sb(e,t.graphicsDeviceOptions)}addComponentSystems(e){e.componentSystems=[f0,zB,pN,dB,gB,CN,ON,_U,vU,ns.legacy?$N:RU,xB,rU,vB,RN,GN,cN,EB,eU,sU,cU,TN,_N,uU,DU]}addResourceHandles(e){e.resourceHandlers=[OU,k3,B3,N3,gz,oz,Yz,Cz,iz,z3,wz,yz,j3,sz,W3,bz,tz,$3,X3,V3,Pz,Tz,Ez,H3,ez]}}let lr,hr;const v_=new y,$x=new y,Sn=new Ga,jh=new Ga,Wg=new Ga;Sn.end=new y;jh.end=new y;Wg.end=new y;const Ho=new y,Eu=new y,S_=new y,Xx=new y,x_=new y,Cu=new y,Au=new y,Pu=new y,Mu=new y,w_=new y,hV=new y,Wo=new y,Dh=new y,Iu=new y,Ru=new y,Oh=new y,qx=new y,Kx=new y,Yx=new y,Zx=new y,cV=new P;function Jx(r,e,t){return hV.cross(r,e).dot(t)}function dV(r,e,t){Ho.sub2(e,r),Eu.sub2(t[0],r),S_.sub2(t[1],r),Xx.sub2(t[2],r),Cu.cross(Xx,Ho);let s=Eu.dot(Cu),i,n;if(s>=0){if(i=-S_.dot(Cu),i<0||(n=Jx(Ho,S_,Eu),n<0))return-1;const a=1/(i+s+n);Au.copy(t[0]).mulScalar(i*a),Pu.copy(t[1]).mulScalar(s*a),Mu.copy(t[2]).mulScalar(n*a),w_.copy(Au).add(Pu).add(Mu)}else{if(x_.sub2(t[3],r),i=x_.dot(Cu),i<0||(n=Jx(Ho,Eu,x_),n<0))return-1;s=-s;const a=1/(i+s+n);Au.copy(t[0]).mulScalar(i*a),Pu.copy(t[3]).mulScalar(s*a),Mu.copy(t[2]).mulScalar(n*a),w_.copy(Au).add(Pu).add(Mu)}return Ho.sub2(t[0],t[2]).lengthSq()<1e-4*1e-4||Ho.sub2(t[1],t[3]).lengthSq()<1e-4*1e-4?-1:w_.sub(r).lengthSq()}class A0{constructor(e,t,s){this.event=e,this.element=t,this.camera=s,this._stopPropagation=!1}stopPropagation(){this._stopPropagation=!0,this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())}}class Fh extends A0{constructor(e,t,s,i,n,a,o){super(e,t,s),this.x=i,this.y=n,this.ctrlKey=e.ctrlKey||!1,this.altKey=e.altKey||!1,this.shiftKey=e.shiftKey||!1,this.metaKey=e.metaKey||!1,this.button=e.button,Nr.isPointerLocked()?(this.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(this.dx=i-a,this.dy=n-o),this.wheelDelta=0,e.type==="wheel"&&(e.deltaY>0?this.wheelDelta=1:e.deltaY<0&&(this.wheelDelta=-1))}}class kh extends A0{constructor(e,t,s,i,n,a){super(e,t,s),this.touches=e.touches,this.changedTouches=e.changedTouches,this.x=i,this.y=n,this.touch=a}}class cr extends A0{constructor(e,t,s,i){super(e,t,s),this.inputSource=i}}class El{constructor(e,t){this._app=null,this._attached=!1,this._target=null,this._enabled=!0,this._lastX=0,this._lastY=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchendHandler=this._handleTouchEnd.bind(this),this._touchcancelHandler=this._touchendHandler,this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._hoveredElement=null,this._pressedElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._selectedElements={},this._selectedPressedElements={},this._useMouse=!t||t.useMouse!==!1,this._useTouch=!t||t.useTouch!==!1,this._useXr=!t||t.useXr!==!1,this._selectEventsAttached=!1,Te.touch&&(this._clickedEntities={}),this.attach(e)}set enabled(e){this._enabled=e}get enabled(){return this._enabled}set app(e){this._app=e}get app(){return this._app||Ai()}attach(e){this._attached&&(this._attached=!1,this.detach()),this._target=e,this._attached=!0;const t=Te.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t)),this._useTouch&&Te.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,t),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1)),this.attachSelectEvents()}attachSelectEvents(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))}detach(){if(!this._attached)return;this._attached=!1;const e=Te.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,e),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1)),this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)),this._target=null}addElement(e){this._elements.indexOf(e)===-1&&this._elements.push(e)}removeElement(e){const t=this._elements.indexOf(e);t!==-1&&this._elements.splice(t,1)}_handleUp(e){this._enabled&&(Nr.isPointerLocked()||(this._calcMouseCoords(e),this._onElementMouseEvent("mouseup",e)))}_handleDown(e){this._enabled&&(Nr.isPointerLocked()||(this._calcMouseCoords(e),this._onElementMouseEvent("mousedown",e)))}_handleMove(e){this._enabled&&(this._calcMouseCoords(e),this._onElementMouseEvent("mousemove",e),this._lastX=lr,this._lastY=hr)}_handleWheel(e){this._enabled&&(this._calcMouseCoords(e),this._onElementMouseEvent("mousewheel",e))}_determineTouchedElements(e){const t={},s=this.app.systems.camera.cameras;for(let i=s.length-1;i>=0;i--){const n=s[i];let a=0;const o=e.changedTouches.length;for(let l=0;l<o;l++){if(t[e.changedTouches[l].identifier]){a++;continue}const c=this._calcTouchCoords(e.changedTouches[l]),d=this._getTargetElementByCoords(n,c.x,c.y);d&&(a++,t[e.changedTouches[l].identifier]={element:d,camera:n,x:c.x,y:c.y})}if(a===o)break}return t}_handleTouchStart(e){if(!this._enabled)return;const t=this._determineTouchedElements(e);for(let s=0,i=e.changedTouches.length;s<i;s++){const n=e.changedTouches[s],a=t[n.identifier],o=this._touchedElements[n.identifier];a&&(!o||a.element!==o.element)&&(this._fireEvent(e.type,new kh(e,a.element,a.camera,a.x,a.y,n)),this._touchesForWhichTouchLeaveHasFired[n.identifier]=!1)}for(const s in t)this._touchedElements[s]=t[s]}_handleTouchEnd(e){if(!this._enabled)return;const t=this.app.systems.camera.cameras;for(const s in this._clickedEntities)delete this._clickedEntities[s];for(let s=0,i=e.changedTouches.length;s<i;s++){const n=e.changedTouches[s],a=this._touchedElements[n.identifier];if(!a)continue;const o=a.element,l=a.camera,c=a.x,d=a.y;delete this._touchedElements[n.identifier],delete this._touchesForWhichTouchLeaveHasFired[n.identifier];const h=this._calcTouchCoords(n);for(let u=t.length-1;u>=0;u--)this._getTargetElementByCoords(t[u],h.x,h.y)===o&&(this._clickedEntities[o.entity.getGuid()]||(this._fireEvent("click",new kh(e,o,l,c,d,n)),this._clickedEntities[o.entity.getGuid()]=Date.now()));this._fireEvent(e.type,new kh(e,o,l,c,d,n))}}_handleTouchMove(e){if(e.preventDefault(),!this._enabled)return;const t=this._determineTouchedElements(e);for(let s=0,i=e.changedTouches.length;s<i;s++){const n=e.changedTouches[s],a=t[n.identifier],o=this._touchedElements[n.identifier];if(o){const l=this._calcTouchCoords(n);(!a||a.element!==o.element)&&!this._touchesForWhichTouchLeaveHasFired[n.identifier]&&(this._fireEvent("touchleave",new kh(e,o.element,o.camera,l.x,l.y,n)),this._touchesForWhichTouchLeaveHasFired[n.identifier]=!0),this._fireEvent("touchmove",new kh(e,o.element,o.camera,l.x,l.y,n))}}}_onElementMouseEvent(e,t){let s=null;const i=this._hoveredElement;this._hoveredElement=null;const n=this.app.systems.camera.cameras;let a;for(let o=n.length-1;o>=0&&(a=n[o],s=this._getTargetElementByCoords(a,lr,hr),!s);o--);if(this._hoveredElement=s,(e==="mousemove"||e==="mouseup")&&this._pressedElement?this._fireEvent(e,new Fh(t,this._pressedElement,a,lr,hr,this._lastX,this._lastY)):s&&(this._fireEvent(e,new Fh(t,s,a,lr,hr,this._lastX,this._lastY)),e==="mousedown"&&(this._pressedElement=s)),i!==this._hoveredElement&&(i&&this._fireEvent("mouseleave",new Fh(t,i,a,lr,hr,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new Fh(t,this._hoveredElement,a,lr,hr,this._lastX,this._lastY))),e==="mouseup"&&this._pressedElement){if(this._pressedElement===this._hoveredElement){const o=this._hoveredElement.entity.getGuid();let l=!this._clickedEntities;if(this._clickedEntities){const c=this._clickedEntities[o]||0;l=Date.now()-c>300,delete this._clickedEntities[o]}l&&this._fireEvent("click",new Fh(t,this._hoveredElement,a,lr,hr,this._lastX,this._lastY))}this._pressedElement=null}}_onXrStart(){this.app.xr.on("end",this._onXrEnd,this),this.app.xr.on("update",this._onXrUpdate,this),this.app.xr.input.on("selectstart",this._onSelectStart,this),this.app.xr.input.on("selectend",this._onSelectEnd,this),this.app.xr.input.on("remove",this._onXrInputRemove,this)}_onXrEnd(){this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)}_onXrUpdate(){if(!this._enabled)return;const e=this.app.xr.input.inputSources;for(let t=0;t<e.length;t++)this._onElementSelectEvent("selectmove",e[t],null)}_onXrInputRemove(e){const t=this._selectedElements[e.id];t&&(e._elementEntity=null,this._fireEvent("selectleave",new cr(null,t,null,e))),delete this._selectedElements[e.id],delete this._selectedPressedElements[e.id]}_onSelectStart(e,t){this._enabled&&this._onElementSelectEvent("selectstart",e,t)}_onSelectEnd(e,t){this._enabled&&this._onElementSelectEvent("selectend",e,t)}_onElementSelectEvent(e,t,s){let i;const n=this._selectedElements[t.id];let a;const o=this.app.systems.camera.cameras;let l;if(t.elementInput){Wg.set(t.getOrigin(),t.getDirection());for(let d=o.length-1;d>=0&&(l=o[d],i=this._getTargetElementByRay(Wg,l),!i);d--);}t._elementEntity=i||null,i?(this._selectedElements[t.id]=i,a=i):delete this._selectedElements[t.id],n!==a&&(n&&this._fireEvent("selectleave",new cr(s,n,l,t)),a&&this._fireEvent("selectenter",new cr(s,a,l,t)));const c=this._selectedPressedElements[t.id];e==="selectmove"&&c&&this._fireEvent("selectmove",new cr(s,c,l,t)),e==="selectstart"&&(this._selectedPressedElements[t.id]=a,a&&this._fireEvent("selectstart",new cr(s,a,l,t))),!t.elementInput&&c&&(delete this._selectedPressedElements[t.id],n&&this._fireEvent("selectend",new cr(s,c,l,t))),e==="selectend"&&t.elementInput&&(delete this._selectedPressedElements[t.id],c&&this._fireEvent("selectend",new cr(s,c,l,t)),c&&c===n&&this._fireEvent("click",new cr(s,c,l,t)))}_fireEvent(e,t){let s=t.element;for(;s.fire(e,t),!(t._stopPropagation||!s.entity.parent||(s=s.entity.parent.element,!s)););}_calcMouseCoords(e){const t=this._target.getBoundingClientRect(),s=Math.floor(t.left),i=Math.floor(t.top);lr=e.clientX-s,hr=e.clientY-i}_calcTouchCoords(e){let t=0,s=0,i=e.target;for(;!(i instanceof HTMLElement);)i=i.parentNode;let n=i;do t+=n.offsetLeft-n.scrollLeft,s+=n.offsetTop-n.scrollTop,n=n.offsetParent;while(n);return{x:e.pageX-t,y:e.pageY-s}}_sortElements(e,t){const s=this.app.scene.layers.sortTransparentLayers(e.layers,t.layers);return s!==0?s:e.screen&&!t.screen?-1:!e.screen&&t.screen?1:!e.screen&&!t.screen?0:e.screen.screen.screenSpace&&!t.screen.screen.screenSpace?-1:t.screen.screen.screenSpace&&!e.screen.screen.screenSpace?1:t.drawOrder-e.drawOrder}_getTargetElementByCoords(e,t,s){const i=this._calculateRayScreen(t,s,e,Sn)?Sn:null,n=this._calculateRay3d(t,s,e,jh)?jh:null;return this._getTargetElement(e,i,n)}_getTargetElementByRay(e,t){Sn.origin.copy(e.origin),Sn.direction.copy(e.direction),Sn.end.copy(Sn.direction).mulScalar(t.farClip*2).add(Sn.origin);const s=Sn,i=t.worldToScreen(s.origin,v_),n=this._calculateRayScreen(i.x,i.y,t,jh)?jh:null;return this._getTargetElement(t,n,s)}_getTargetElement(e,t,s){let i=null,n=1/0;this._elements.sort(this._sortHandler);for(let a=0,o=this._elements.length;a<o;a++){const l=this._elements[a];if(l.layers.some(c=>e.layersSet.has(c)))if(l.screen&&l.screen.screen.screenSpace){if(!t)continue;if(this._checkElement(t,l,!0)>=0){i=l;break}}else{if(!s)continue;const c=this._checkElement(s,l,!1);if(c>=0&&(c<n&&(i=l,n=c),l.screen)){i=l;break}}}return i}_calculateRayScreen(e,t,s,i){const n=this.app.graphicsDevice.width,a=this.app.graphicsDevice.height,o=s.rect.z*n,l=s.rect.w*a,c=s.rect.x*n,d=c+o,h=(1-s.rect.y)*a,u=h-l;let f=e*n/this._target.clientWidth,p=t*a/this._target.clientHeight;return f>=c&&f<=d&&p<=h&&p>=u?(f=n*(f-c)/o,p=a*(p-u)/l,p=a-p,i.origin.set(f,p,1),i.direction.set(0,0,-1),i.end.copy(i.direction).mulScalar(2).add(i.origin),!0):!1}_calculateRay3d(e,t,s,i){const n=this._target.clientWidth,a=this._target.clientHeight,o=s.rect.z*n,l=s.rect.w*a,c=s.rect.x*n,d=c+o,h=(1-s.rect.y)*a,u=h-l;let f=e,p=t;return e>=c&&e<=d&&t<=h&&p>=u?(f=n*(f-c)/o,p=a*(p-u)/l,s.screenToWorld(f,p,s.nearClip,v_),s.screenToWorld(f,p,s.farClip,$x),i.origin.copy(v_),i.direction.set(0,0,-1),i.end.copy($x),!0):!1}_checkElement(e,t,s){if(t.maskedBy&&this._checkElement(e,t.maskedBy.element,s)<0)return-1;let i;s?i=El.calculateScaleToScreen(t):i=El.calculateScaleToWorld(t);const n=El.buildHitCorners(t,s?t.screenCorners:t.worldCorners,i);return dV(e.origin,e.end,n)}static buildHitCorners(e,t,s){let i=t;if(e.entity&&e.entity.button){const a=e.entity.button.hitPadding||cV;Dh.copy(e.entity.up),Iu.copy(Dh).mulScalar(-1),Oh.copy(e.entity.right),Ru.copy(Oh).mulScalar(-1),Dh.mulScalar(a.w*s.y),Iu.mulScalar(a.y*s.y),Oh.mulScalar(a.z*s.x),Ru.mulScalar(a.x*s.x),qx.copy(i[0]).add(Iu).add(Ru),Kx.copy(i[1]).add(Iu).add(Oh),Yx.copy(i[2]).add(Dh).add(Oh),Zx.copy(i[3]).add(Dh).add(Ru),i=[qx,Kx,Yx,Zx]}if(s.x<0){const a=i[2].x,o=i[0].x;i[0].x=a,i[1].x=o,i[2].x=o,i[3].x=a}if(s.y<0){const a=i[2].y,o=i[0].y;i[0].y=a,i[1].y=a,i[2].y=o,i[3].y=o}if(s.z<0){const a=i[2].x,o=i[2].y,l=i[2].z;i[2].x=i[0].x,i[2].y=i[0].y,i[2].z=i[0].z,i[0].x=a,i[0].y=o,i[0].z=l}return i}static calculateScaleToScreen(e){let t=e.entity;const s=e.screen.screen.scale;for(Wo.set(s,s,s);t&&!t.screen;)Wo.mul(t.getLocalScale()),t=t.parent;return Wo}static calculateScaleToWorld(e){let t=e.entity;for(Wo.set(1,1,1);t;)Wo.mul(t.getLocalScale()),t=t.parent;return Wo}}const jg=1;yl.endsWith=function(r,e){return r.endsWith(e)};yl.startsWith=function(r,e){return r.startsWith(e)};Object.defineProperty(k.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.r,this._data[1]=this.g,this._data[2]=this.b,this._data[3]=this.a,this._data}});Object.defineProperty(k.prototype,"data3",{get:function(){return this._data3||(this._data3=new Float32Array(3)),this._data3[0]=this.r,this._data3[1]=this.g,this._data3[2]=this.b,this._data3}});H.INV_LOG2=Math.LOG2E;H.intToBytes=H.intToBytes32;H.bytesToInt=H.bytesToInt32;Object.defineProperty(M.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(2)),this._data[0]=this.x,this._data[1]=this.y,this._data}});M.prototype.scale=M.prototype.mulScalar;Object.defineProperty(y.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(3)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data}});y.prototype.scale=y.prototype.mulScalar;Object.defineProperty(P.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data[3]=this.w,this._data}});P.prototype.scale=P.prototype.mulScalar;Al.prototype.intersectRay=Al.prototype.intersectsRay;Jw.prototype.update=function(r,e){const t=new q;t.mul2(r,e),this.setFromMat4(t)};new P;Object.defineProperty(W,"transformSkinnedVS",{get:function(){return`#define SKIN
`+W.transformVS}});const uV={"ambientPrefilteredCube.frag":"ambientEnv.frag","ambientPrefilteredCubeLod.frag":"ambientEnv.frag","dpAtlasQuad.frag":null,"genParaboloid.frag":null,"prefilterCubemap.frag":null,"reflectionDpAtlas.frag":"reflectionEnv.frag","reflectionPrefilteredCube.frag":"reflectionEnv.frag","reflectionPrefilteredCubeLod.frag":"reflectionEnv.frag"};Object.keys(uV).forEach(r=>{Object.defineProperty(W,r,{get:function(){return null},set:function(){}})});Object.defineProperties(Ct.prototype,{_glFrameBuffer:{get:function(){return this.impl._glFrameBuffer},set:function(r){}}});Object.defineProperty(os,"defaultInstancingFormat",{get:function(){return null}});Object.defineProperties(_e.prototype,{rgbm:{get:function(){return this.type===Qi},set:function(r){this.type=r?Qi:ps}},swizzleGGGR:{get:function(){return this.type===Ll},set:function(r){this.type=r?Ll:ps}},_glTexture:{get:function(){return this.impl._glTexture}},autoMipmap:{get:function(){return this._mipmaps},set:function(r){this._mipmaps=r}}});Object.defineProperty(ct.prototype,"webgl2",{get:function(){return this.isWebGL2}});ct.prototype.getProgramLibrary=function(){return cn(this)};ct.prototype.setProgramLibrary=function(r){Gb(this,r)};ct.prototype.removeShaderFromCache=function(r){cn(this).removeFromCache(r)};Xe.DEFAULT=Object.freeze(new Xe);const Ne=new Xe,Fn=new kt;ct.prototype.setBlendFunction=function(r,e){const t=this.blendState;Ne.copy(t),Ne.setColorBlend(t.colorOp,r,e),Ne.setAlphaBlend(t.alphaOp,r,e),this.setBlendState(Ne)};ct.prototype.setBlendFunctionSeparate=function(r,e,t,s){const i=this.blendState;Ne.copy(i),Ne.setColorBlend(i.colorOp,r,e),Ne.setAlphaBlend(i.alphaOp,t,s),this.setBlendState(Ne)};ct.prototype.setBlendEquation=function(r){const e=this.blendState;Ne.copy(e),Ne.setColorBlend(r,e.colorSrcFactor,e.colorDstFactor),Ne.setAlphaBlend(r,e.alphaSrcFactor,e.alphaDstFactor),this.setBlendState(Ne)};ct.prototype.setBlendEquationSeparate=function(r,e){const t=this.blendState;Ne.copy(t),Ne.setColorBlend(r,t.colorSrcFactor,t.colorDstFactor),Ne.setAlphaBlend(e,t.alphaSrcFactor,t.alphaDstFactor),this.setBlendState(Ne)};ct.prototype.setColorWrite=function(r,e,t,s){const i=this.blendState;Ne.copy(i),Ne.setColorWrite(r,e,t,s),this.setBlendState(Ne)};ct.prototype.getBlending=function(){return this.blendState.blend};ct.prototype.setBlending=function(r){Ne.copy(this.blendState),Ne.blend=r,this.setBlendState(Ne)};ct.prototype.setDepthWrite=function(r){Fn.copy(this.depthState),Fn.write=r,this.setDepthState(Fn)};ct.prototype.setDepthFunc=function(r){Fn.copy(this.depthState),Fn.func=r,this.setDepthState(Fn)};ct.prototype.setDepthTest=function(r){Fn.copy(this.depthState),Fn.test=r,this.setDepthState(Fn)};ct.prototype.getCullMode=function(){return this.cullMode};Object.defineProperty(js.prototype,"defaultMaterial",{get:function(){return sh(Ai().graphicsDevice)}});Object.defineProperty(dg.prototype,"_meshInstances",{get:function(){return null}});Object.defineProperty(js.prototype,"drawCalls",{get:function(){return null}});["128","64","32","16","8","4"].forEach((r,e)=>{Object.defineProperty(js.prototype,`skyboxPrefiltered${r}`,{get:function(){return this._prefilteredCubemaps[e]},set:function(t){this._prefilteredCubemaps[e]=t,this.updateShaders=!0}})});Object.defineProperty(js.prototype,"models",{get:function(){return this._models||(this._models=[]),this._models}});Object.defineProperty(mr.prototype,"renderTarget",{set:function(r){this._renderTarget=r,this._dirtyComposition=!0},get:function(){return this._renderTarget}});js.prototype.addModel=function(r){if(this.containsModel(r))return;const e=this.layers.getLayerById(Ws);e&&(e.addMeshInstances(r.meshInstances),this.models.push(r))};js.prototype.addShadowCaster=function(r){const e=this.layers.getLayerById(Ws);e&&e.addShadowCasters(r.meshInstances)};js.prototype.removeModel=function(r){const e=this.models.indexOf(r);if(e!==-1){const t=this.layers.getLayerById(Ws);if(!t)return;t.removeMeshInstances(r.meshInstances),this.models.splice(e,1)}};js.prototype.removeShadowCasters=function(r){const e=this.layers.getLayerById(Ws);e&&e.removeShadowCasters(r.meshInstances)};js.prototype.containsModel=function(r){return this.models.indexOf(r)>=0};js.prototype.getModels=function(r){return this.models};Object.defineProperty(lg.prototype,"model",{get:function(){return null}});Zb.prototype.renderComposition=function(r){Ai().renderComposition(r)};Fe.prototype.syncAabb=function(){};s0.prototype.getTarget=function(r){return this.targets[r]};ze.prototype._dirtify=function(r){r?this._dirtifyLocal():this._dirtifyWorld()};ze.prototype.addLabel=function(r){this._labels[r]=!0};ze.prototype.getLabels=function(){return Object.keys(this._labels)};ze.prototype.hasLabel=function(r){return!!this._labels[r]};ze.prototype.removeLabel=function(r){delete this._labels[r]};ze.prototype.findByLabel=function(r,e=[]){this.hasLabel(r)&&e.push(this);for(let t=0;t<this._children.length;++t)e=this._children[t].findByLabel(r,e);return e};ze.prototype.getChildren=function(){return this.children};ze.prototype.getName=function(){return this.name};ze.prototype.getPath=function(){return this.path};ze.prototype.getRoot=function(){return this.root};ze.prototype.getParent=function(){return this.parent};ze.prototype.setName=function(r){this.name=r};Jt.prototype.getName=function(){return this.name};Jt.prototype.setName=function(r){this.name=r};Jt.prototype.getShader=function(){return this.shader};Jt.prototype.setShader=function(r){this.shader=r};Object.defineProperty(Jt.prototype,"blend",{set:function(r){this.blendState.blend=r},get:function(){return this.blendState.blend}});Object.defineProperty(Jt.prototype,"blendSrc",{set:function(r){const e=this.blendState;Ne.copy(e),Ne.setColorBlend(e.colorOp,r,e.colorDstFactor),Ne.setAlphaBlend(e.alphaOp,r,e.alphaDstFactor),this.blendState=Ne},get:function(){return this.blendState.colorSrcFactor}});Object.defineProperty(Jt.prototype,"blendDst",{set:function(r){const e=this.blendState;Ne.copy(e),Ne.setColorBlend(e.colorOp,e.colorSrcFactor,r),Ne.setAlphaBlend(e.alphaOp,e.alphaSrcFactor,r),this.blendState=Ne},get:function(){return this.blendState.colorDstFactor}});Object.defineProperty(Gs.prototype,"shininess",{get:function(){return this.gloss*100},set:function(r){this.gloss=r*.01}});function $s(r,e){Object.defineProperty(Gs.prototype,e,{get:function(){return this[r]},set:function(t){this[r]=t}})}$s("diffuseTint","diffuseMapTint");$s("specularTint","specularMapTint");$s("emissiveTint","emissiveMapTint");$s("aoVertexColor","aoMapVertexColor");$s("diffuseVertexColor","diffuseMapVertexColor");$s("specularVertexColor","specularMapVertexColor");$s("emissiveVertexColor","emissiveMapVertexColor");$s("metalnessVertexColor","metalnessMapVertexColor");$s("glossVertexColor","glossMapVertexColor");$s("opacityVertexColor","opacityMapVertexColor");$s("lightVertexColor","lightMapVertexColor");$s("sheenGloss","sheenGlossiess");$s("clearCoatGloss","clearCostGlossiness");function eE(r,e){r!=="pass"&&Object.defineProperty(Oc.prototype,r,{get:function(){return this.litOptions[e||r]},set:function(t){this.litOptions[e||r]=t}})}eE("refraction","useRefraction");const fV=new Zy,Qx=Object.getOwnPropertyNames(fV);for(const r in Qx)eE(Qx[r]);Qa.prototype.getDuration=function(){return this.duration};Qa.prototype.getName=function(){return this.name};Qa.prototype.getNodes=function(){return this.nodes};Qa.prototype.setDuration=function(r){this.duration=r};Qa.prototype.setName=function(r){this.name=r};Ki.prototype.getAnimation=function(){return this.animation};Ki.prototype.getCurrentTime=function(){return this.currentTime};Ki.prototype.getLooping=function(){return this.looping};Ki.prototype.getNumNodes=function(){return this.numNodes};Ki.prototype.setAnimation=function(r){this.animation=r};Ki.prototype.setCurrentTime=function(r){this.currentTime=r};Ki.prototype.setLooping=function(r){this.looping=r};Xp.prototype.getListener=function(){return this.listener};Xp.prototype.getVolume=function(){return this.volume};Xp.prototype.setVolume=function(r){this.volume=r};Xn.prototype.getAssetById=function(r){return this.get(r)};Object.defineProperty(vs.prototype,"ray",{get:function(){return this._rayLocal}});Object.defineProperty(vs.prototype,"position",{get:function(){return this._localPosition}});Object.defineProperty(vs.prototype,"rotation",{get:function(){return this._localRotation}});Object.defineProperty(El.prototype,"wheel",{get:function(){return this.wheelDelta*-2}});Object.defineProperty(zh.prototype,"wheel",{get:function(){return this.wheelDelta*-2}});gt.prototype.isFullscreen=function(){return!!document.fullscreenElement};gt.prototype.enableFullscreen=function(r,e,t){r=r||this.graphicsDevice.canvas;const s=function n(){e(),document.removeEventListener("fullscreenchange",n)},i=function n(){t(),document.removeEventListener("fullscreenerror",n)};e&&document.addEventListener("fullscreenchange",s,!1),t&&document.addEventListener("fullscreenerror",i,!1),r.requestFullscreen?r.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):t()};gt.prototype.disableFullscreen=function(r){const e=function t(){r(),document.removeEventListener("fullscreenchange",t)};r&&document.addEventListener("fullscreenchange",e,!1),document.exitFullscreen()};gt.prototype.getSceneUrl=function(r){const e=this.scenes.find(r);return e?e.url:null};gt.prototype.loadScene=function(r,e){this.scenes.loadScene(r,e)};gt.prototype.loadSceneHierarchy=function(r,e){this.scenes.loadSceneHierarchy(r,e)};gt.prototype.loadSceneSettings=function(r,e){this.scenes.loadSceneSettings(r,e)};gt.prototype.renderMeshInstance=function(r,e){const t=e!=null&&e.layer?e.layer:this.scene.defaultDrawLayer;this.scene.immediate.drawMesh(null,null,null,r,t)};gt.prototype.renderMesh=function(r,e,t,s){const i=s!=null&&s.layer?s.layer:this.scene.defaultDrawLayer;this.scene.immediate.drawMesh(e,t,r,null,i)};gt.prototype._addLines=function(r,e,t){const s=t&&t.layer?t.layer:this.scene.layers.getLayerById(Ti),i=t&&t.depthTest!==void 0?t.depthTest:!0;this.scene.immediate.getBatch(s,i).addLines(r,e)};gt.prototype.renderLine=function(r,e,t){let s=t,i;const n=arguments[3],a=arguments[4];n instanceof k?(s=n,typeof a=="number"?a===jg?i={layer:this.scene.layers.getLayerById(Ti),depthTest:!1}:i={layer:this.scene.layers.getLayerById(Ti),depthTest:!0}:i=a):typeof n=="number"?(s=t,n===jg?i={layer:this.scene.layers.getLayerById(Ti),depthTest:!1}:i={layer:this.scene.layers.getLayerById(Ti),depthTest:!0}):n&&(i=n),this._addLines([r,e],[t,s],i)};gt.prototype.renderLines=function(r,e,t){if(t?typeof t=="number"&&(t===jg?t={layer:this.scene.layers.getLayerById(Ti),depthTest:!1}:t={layer:this.scene.layers.getLayerById(Ti),depthTest:!0}):t={layer:this.scene.layers.getLayerById(Ti),depthTest:!0},!!e.length&&r.length!==e.length){console.error("renderLines: position/color arrays have different lengths");return}if(r.length%2!==0){console.error("renderLines: array length is not divisible by 2");return}this._addLines(r,e,t)};gt.prototype.enableVr=function(){};Object.defineProperty(_0.prototype,"node",{get:function(){return this.entity}});Object.defineProperty(y0.prototype,"enable",{get:function(){return this.enabled},set:function(r){this.enabled=r}});em.prototype.setVisible=function(r){this.enabled=r};Object.defineProperty(em.prototype,"aabb",{get:function(){return null},set:function(r){}});Object.defineProperty(u0.prototype,"aabb",{get:function(){return null},set:function(r){}});Object.defineProperty(rn.prototype,"bodyType",{get:function(){return this.type},set:function(r){this.type=r}});rn.prototype.syncBodyToEntity=function(){this._updateDynamic()};f0.prototype.setGravity=function(){arguments.length===1?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])};class ve{static isInRange(e,t,s){return e>=t&&e<=s}static linear(e,t,s){return e+(t-e)*s}static easeIn(e,t,s){return e+(t-e)*s**2}static easeOut(e,t,s){return e+(t-e)*(1-(1-s)**2)}static easeInOut(e,t,s){return e+(t-e)*(-Math.cos(s*Math.PI)/2+.5)}static copyObject(e,t){return t===void 0&&(t={}),Object.keys(e).forEach(s=>{t[s]=e[s]}),t}static hexToRgb(e){e=e.toLowerCase();const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e),s=parseInt(t[1],16)/255,i=parseInt(t[2],16)/255,n=parseInt(t[3],16)/255;return new k(s,i,n)}static clamp(e,t,s){return Math.min(Math.max(e,t),s)}static sign(e){return e<0?-1:1}static random(e,t){return typeof e=="number"&&typeof t=="number"?Math.random()*(t-e)+e:Math.random()<.5?e:t}static randomInt(e,t){return Math.floor(Math.random()*(t-e+1)+e)}static randomFromList(e){if(e&&e.length>0){const t=this.randomInt(0,e.length-1);return e[t]}else return}static randomItemsFromList(e,t,s=!1){const i=[];if(e&&e.length>0)for(;i.length<t;){const n=this.randomInt(0,e.length-1),a=e[n];s&&i.indexOf(a)!==-1||i.push(a)}return i}static formatCurrency(e,t=0){return this._numberFormatter||(this._numberFormatter=new Intl.NumberFormat("en-US",{maximumFractionDigits:t,currency:"USD",style:"currency"})),this._numberFormatter.format(e)}static randomFromEnum(e){const s=Object.keys(e).map(n=>e[n]),i=this.randomInt(0,s.length-1);return s[i]}static randomVector(e,t,s=new y){return s.x=ve.random(e.x,t.x),s.y=ve.random(e.y,t.y),s.z=ve.random(e.z,t.z),s}static distanceBetween(e,t){return Math.abs(Math.abs(e)-Math.abs(t))}static getAlpha(e,t){return t===0?90:this.toDegree(Math.atan(Math.abs(e)/Math.abs(t)))}static toDegree(e){return e*180/Math.PI}static toRadian(e){return e*Math.PI/180}static getRandomIntExclude(e,t,s){let i=Math.floor(Math.random()*(t-e))+e;return i===s&&(i=t),i}static getSpriteFrame(e,t=1){const s=e.atlas.frames[e.frameKeys[0]].rect;return{x:s.x,y:s.y,width:s.z*t,height:s.w*t}}static createColor(e=255,t=255,s=255,i=1){return new k(e/255,t/255,s/255,i)}static registerOnTouch(e,t,s){e.useInput=!0,e.on("mousedown",t,s),e.on("touchstart",t,s)}static registerOnceTouch(e,t,s){e.useInput=!0,e.once("mousedown",t,s),e.once("touchstart",t,s)}static updateCircleTransform(e,t,s,i){const n=e.getLocalPosition(),a=n.x,o=t**2,l=a**2,c=Math.sqrt(o+l)+s;n.y=c,e.setLocalPosition(n);const d=e.getLocalEulerAngles(),h=ve.sign(n.x),u=Math.abs(c-s),f=Math.atan(u/Math.abs(a))*180/Math.PI;d.z=-h*(f-90)*i,e.setLocalEulerAngles(d)}static getCashFormat(e){return e>=1e9?`${(e/1e9).toFixed(1).replace(/\.0$/,"")}B`:e>=1e6?`${(e/1e6).toFixed(1).replace(/\.0$/,"")}M`:e>=1e3?`${(e/1e3).toFixed(1).replace(/\.0$/,"")}K`:e.toString()}static shuffleArray(e){for(let t=e.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}}static upperFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}static padNumber(e,t){return e.toString().padStart(t,"0")}static isObjectEmpty(e){return Object.keys(e).length===0}static checkDevice(){const e=navigator.userAgent||navigator.vendor,t=/android|bb\d+|meego.+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i,s=/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i;return t.test(e)||s.test(e)?"mobile":"desktop"}}function Ko(r=1){return new Promise(e=>{let t=0;const s=()=>{t++,t>=r?e():requestAnimationFrame(s)};requestAnimationFrame(s)})}/*! js-yaml 4.1.0 https://github.com/nodeca/js-yaml @license MIT */function tE(r){return typeof r>"u"||r===null}function pV(r){return typeof r=="object"&&r!==null}function mV(r){return Array.isArray(r)?r:tE(r)?[]:[r]}function _V(r,e){var t,s,i,n;if(e)for(n=Object.keys(e),t=0,s=n.length;t<s;t+=1)i=n[t],r[i]=e[i];return r}function gV(r,e){var t="",s;for(s=0;s<e;s+=1)t+=r;return t}function yV(r){return r===0&&Number.NEGATIVE_INFINITY===1/r}var vV=tE,SV=pV,xV=mV,wV=gV,bV=yV,TV=_V,It={isNothing:vV,isObject:SV,toArray:xV,repeat:wV,isNegativeZero:bV,extend:TV};function sE(r,e){var t="",s=r.reason||"(unknown reason)";return r.mark?(r.mark.name&&(t+='in "'+r.mark.name+'" '),t+="("+(r.mark.line+1)+":"+(r.mark.column+1)+")",!e&&r.mark.snippet&&(t+=`

`+r.mark.snippet),s+" "+t):s}function Vc(r,e){Error.call(this),this.name="YAMLException",this.reason=r,this.mark=e,this.message=sE(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack||""}Vc.prototype=Object.create(Error.prototype);Vc.prototype.constructor=Vc;Vc.prototype.toString=function(e){return this.name+": "+sE(this,e)};var rs=Vc;function b_(r,e,t,s,i){var n="",a="",o=Math.floor(i/2)-1;return s-e>o&&(n=" ... ",e=s-o+n.length),t-s>o&&(a=" ...",t=s+o-a.length),{str:n+r.slice(e,t).replace(/\t/g,"")+a,pos:s-e+n.length}}function T_(r,e){return It.repeat(" ",e-r.length)+r}function EV(r,e){if(e=Object.create(e||null),!r.buffer)return null;e.maxLength||(e.maxLength=79),typeof e.indent!="number"&&(e.indent=1),typeof e.linesBefore!="number"&&(e.linesBefore=3),typeof e.linesAfter!="number"&&(e.linesAfter=2);for(var t=/\r?\n|\r|\0/g,s=[0],i=[],n,a=-1;n=t.exec(r.buffer);)i.push(n.index),s.push(n.index+n[0].length),r.position<=n.index&&a<0&&(a=s.length-2);a<0&&(a=s.length-1);var o="",l,c,d=Math.min(r.line+e.linesAfter,i.length).toString().length,h=e.maxLength-(e.indent+d+3);for(l=1;l<=e.linesBefore&&!(a-l<0);l++)c=b_(r.buffer,s[a-l],i[a-l],r.position-(s[a]-s[a-l]),h),o=It.repeat(" ",e.indent)+T_((r.line-l+1).toString(),d)+" | "+c.str+`
`+o;for(c=b_(r.buffer,s[a],i[a],r.position,h),o+=It.repeat(" ",e.indent)+T_((r.line+1).toString(),d)+" | "+c.str+`
`,o+=It.repeat("-",e.indent+d+3+c.pos)+`^
`,l=1;l<=e.linesAfter&&!(a+l>=i.length);l++)c=b_(r.buffer,s[a+l],i[a+l],r.position-(s[a]-s[a+l]),h),o+=It.repeat(" ",e.indent)+T_((r.line+l+1).toString(),d)+" | "+c.str+`
`;return o.replace(/\n$/,"")}var CV=EV,AV=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],PV=["scalar","sequence","mapping"];function MV(r){var e={};return r!==null&&Object.keys(r).forEach(function(t){r[t].forEach(function(s){e[String(s)]=t})}),e}function IV(r,e){if(e=e||{},Object.keys(e).forEach(function(t){if(AV.indexOf(t)===-1)throw new rs('Unknown option "'+t+'" is met in definition of "'+r+'" YAML type.')}),this.options=e,this.tag=r,this.kind=e.kind||null,this.resolve=e.resolve||function(){return!0},this.construct=e.construct||function(t){return t},this.instanceOf=e.instanceOf||null,this.predicate=e.predicate||null,this.represent=e.represent||null,this.representName=e.representName||null,this.defaultStyle=e.defaultStyle||null,this.multi=e.multi||!1,this.styleAliases=MV(e.styleAliases||null),PV.indexOf(this.kind)===-1)throw new rs('Unknown kind "'+this.kind+'" is specified for "'+r+'" YAML type.')}var jt=IV;function ew(r,e){var t=[];return r[e].forEach(function(s){var i=t.length;t.forEach(function(n,a){n.tag===s.tag&&n.kind===s.kind&&n.multi===s.multi&&(i=a)}),t[i]=s}),t}function RV(){var r={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}},e,t;function s(i){i.multi?(r.multi[i.kind].push(i),r.multi.fallback.push(i)):r[i.kind][i.tag]=r.fallback[i.tag]=i}for(e=0,t=arguments.length;e<t;e+=1)arguments[e].forEach(s);return r}function $g(r){return this.extend(r)}$g.prototype.extend=function(e){var t=[],s=[];if(e instanceof jt)s.push(e);else if(Array.isArray(e))s=s.concat(e);else if(e&&(Array.isArray(e.implicit)||Array.isArray(e.explicit)))e.implicit&&(t=t.concat(e.implicit)),e.explicit&&(s=s.concat(e.explicit));else throw new rs("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");t.forEach(function(n){if(!(n instanceof jt))throw new rs("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(n.loadKind&&n.loadKind!=="scalar")throw new rs("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(n.multi)throw new rs("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")}),s.forEach(function(n){if(!(n instanceof jt))throw new rs("Specified list of YAML types (or a single Type object) contains a non-Type object.")});var i=Object.create($g.prototype);return i.implicit=(this.implicit||[]).concat(t),i.explicit=(this.explicit||[]).concat(s),i.compiledImplicit=ew(i,"implicit"),i.compiledExplicit=ew(i,"explicit"),i.compiledTypeMap=RV(i.compiledImplicit,i.compiledExplicit),i};var iE=$g,nE=new jt("tag:yaml.org,2002:str",{kind:"scalar",construct:function(r){return r!==null?r:""}}),rE=new jt("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(r){return r!==null?r:[]}}),aE=new jt("tag:yaml.org,2002:map",{kind:"mapping",construct:function(r){return r!==null?r:{}}}),oE=new iE({explicit:[nE,rE,aE]});function LV(r){if(r===null)return!0;var e=r.length;return e===1&&r==="~"||e===4&&(r==="null"||r==="Null"||r==="NULL")}function DV(){return null}function OV(r){return r===null}var lE=new jt("tag:yaml.org,2002:null",{kind:"scalar",resolve:LV,construct:DV,predicate:OV,represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"});function FV(r){if(r===null)return!1;var e=r.length;return e===4&&(r==="true"||r==="True"||r==="TRUE")||e===5&&(r==="false"||r==="False"||r==="FALSE")}function kV(r){return r==="true"||r==="True"||r==="TRUE"}function BV(r){return Object.prototype.toString.call(r)==="[object Boolean]"}var hE=new jt("tag:yaml.org,2002:bool",{kind:"scalar",resolve:FV,construct:kV,predicate:BV,represent:{lowercase:function(r){return r?"true":"false"},uppercase:function(r){return r?"TRUE":"FALSE"},camelcase:function(r){return r?"True":"False"}},defaultStyle:"lowercase"});function NV(r){return 48<=r&&r<=57||65<=r&&r<=70||97<=r&&r<=102}function UV(r){return 48<=r&&r<=55}function zV(r){return 48<=r&&r<=57}function VV(r){if(r===null)return!1;var e=r.length,t=0,s=!1,i;if(!e)return!1;if(i=r[t],(i==="-"||i==="+")&&(i=r[++t]),i==="0"){if(t+1===e)return!0;if(i=r[++t],i==="b"){for(t++;t<e;t++)if(i=r[t],i!=="_"){if(i!=="0"&&i!=="1")return!1;s=!0}return s&&i!=="_"}if(i==="x"){for(t++;t<e;t++)if(i=r[t],i!=="_"){if(!NV(r.charCodeAt(t)))return!1;s=!0}return s&&i!=="_"}if(i==="o"){for(t++;t<e;t++)if(i=r[t],i!=="_"){if(!UV(r.charCodeAt(t)))return!1;s=!0}return s&&i!=="_"}}if(i==="_")return!1;for(;t<e;t++)if(i=r[t],i!=="_"){if(!zV(r.charCodeAt(t)))return!1;s=!0}return!(!s||i==="_")}function GV(r){var e=r,t=1,s;if(e.indexOf("_")!==-1&&(e=e.replace(/_/g,"")),s=e[0],(s==="-"||s==="+")&&(s==="-"&&(t=-1),e=e.slice(1),s=e[0]),e==="0")return 0;if(s==="0"){if(e[1]==="b")return t*parseInt(e.slice(2),2);if(e[1]==="x")return t*parseInt(e.slice(2),16);if(e[1]==="o")return t*parseInt(e.slice(2),8)}return t*parseInt(e,10)}function HV(r){return Object.prototype.toString.call(r)==="[object Number]"&&r%1===0&&!It.isNegativeZero(r)}var cE=new jt("tag:yaml.org,2002:int",{kind:"scalar",resolve:VV,construct:GV,predicate:HV,represent:{binary:function(r){return r>=0?"0b"+r.toString(2):"-0b"+r.toString(2).slice(1)},octal:function(r){return r>=0?"0o"+r.toString(8):"-0o"+r.toString(8).slice(1)},decimal:function(r){return r.toString(10)},hexadecimal:function(r){return r>=0?"0x"+r.toString(16).toUpperCase():"-0x"+r.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),WV=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$");function jV(r){return!(r===null||!WV.test(r)||r[r.length-1]==="_")}function $V(r){var e,t;return e=r.replace(/_/g,"").toLowerCase(),t=e[0]==="-"?-1:1,"+-".indexOf(e[0])>=0&&(e=e.slice(1)),e===".inf"?t===1?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:e===".nan"?NaN:t*parseFloat(e,10)}var XV=/^[-+]?[0-9]+e/;function qV(r,e){var t;if(isNaN(r))switch(e){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===r)switch(e){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===r)switch(e){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(It.isNegativeZero(r))return"-0.0";return t=r.toString(10),XV.test(t)?t.replace("e",".e"):t}function KV(r){return Object.prototype.toString.call(r)==="[object Number]"&&(r%1!==0||It.isNegativeZero(r))}var dE=new jt("tag:yaml.org,2002:float",{kind:"scalar",resolve:jV,construct:$V,predicate:KV,represent:qV,defaultStyle:"lowercase"}),uE=oE.extend({implicit:[lE,hE,cE,dE]}),fE=uE,pE=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),mE=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$");function YV(r){return r===null?!1:pE.exec(r)!==null||mE.exec(r)!==null}function ZV(r){var e,t,s,i,n,a,o,l=0,c=null,d,h,u;if(e=pE.exec(r),e===null&&(e=mE.exec(r)),e===null)throw new Error("Date resolve error");if(t=+e[1],s=+e[2]-1,i=+e[3],!e[4])return new Date(Date.UTC(t,s,i));if(n=+e[4],a=+e[5],o=+e[6],e[7]){for(l=e[7].slice(0,3);l.length<3;)l+="0";l=+l}return e[9]&&(d=+e[10],h=+(e[11]||0),c=(d*60+h)*6e4,e[9]==="-"&&(c=-c)),u=new Date(Date.UTC(t,s,i,n,a,o,l)),c&&u.setTime(u.getTime()-c),u}function JV(r){return r.toISOString()}var _E=new jt("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:YV,construct:ZV,instanceOf:Date,represent:JV});function QV(r){return r==="<<"||r===null}var gE=new jt("tag:yaml.org,2002:merge",{kind:"scalar",resolve:QV}),P0=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=
\r`;function e5(r){if(r===null)return!1;var e,t,s=0,i=r.length,n=P0;for(t=0;t<i;t++)if(e=n.indexOf(r.charAt(t)),!(e>64)){if(e<0)return!1;s+=6}return s%8===0}function t5(r){var e,t,s=r.replace(/[\r\n=]/g,""),i=s.length,n=P0,a=0,o=[];for(e=0;e<i;e++)e%4===0&&e&&(o.push(a>>16&255),o.push(a>>8&255),o.push(a&255)),a=a<<6|n.indexOf(s.charAt(e));return t=i%4*6,t===0?(o.push(a>>16&255),o.push(a>>8&255),o.push(a&255)):t===18?(o.push(a>>10&255),o.push(a>>2&255)):t===12&&o.push(a>>4&255),new Uint8Array(o)}function s5(r){var e="",t=0,s,i,n=r.length,a=P0;for(s=0;s<n;s++)s%3===0&&s&&(e+=a[t>>18&63],e+=a[t>>12&63],e+=a[t>>6&63],e+=a[t&63]),t=(t<<8)+r[s];return i=n%3,i===0?(e+=a[t>>18&63],e+=a[t>>12&63],e+=a[t>>6&63],e+=a[t&63]):i===2?(e+=a[t>>10&63],e+=a[t>>4&63],e+=a[t<<2&63],e+=a[64]):i===1&&(e+=a[t>>2&63],e+=a[t<<4&63],e+=a[64],e+=a[64]),e}function i5(r){return Object.prototype.toString.call(r)==="[object Uint8Array]"}var yE=new jt("tag:yaml.org,2002:binary",{kind:"scalar",resolve:e5,construct:t5,predicate:i5,represent:s5}),n5=Object.prototype.hasOwnProperty,r5=Object.prototype.toString;function a5(r){if(r===null)return!0;var e=[],t,s,i,n,a,o=r;for(t=0,s=o.length;t<s;t+=1){if(i=o[t],a=!1,r5.call(i)!=="[object Object]")return!1;for(n in i)if(n5.call(i,n))if(!a)a=!0;else return!1;if(!a)return!1;if(e.indexOf(n)===-1)e.push(n);else return!1}return!0}function o5(r){return r!==null?r:[]}var vE=new jt("tag:yaml.org,2002:omap",{kind:"sequence",resolve:a5,construct:o5}),l5=Object.prototype.toString;function h5(r){if(r===null)return!0;var e,t,s,i,n,a=r;for(n=new Array(a.length),e=0,t=a.length;e<t;e+=1){if(s=a[e],l5.call(s)!=="[object Object]"||(i=Object.keys(s),i.length!==1))return!1;n[e]=[i[0],s[i[0]]]}return!0}function c5(r){if(r===null)return[];var e,t,s,i,n,a=r;for(n=new Array(a.length),e=0,t=a.length;e<t;e+=1)s=a[e],i=Object.keys(s),n[e]=[i[0],s[i[0]]];return n}var SE=new jt("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:h5,construct:c5}),d5=Object.prototype.hasOwnProperty;function u5(r){if(r===null)return!0;var e,t=r;for(e in t)if(d5.call(t,e)&&t[e]!==null)return!1;return!0}function f5(r){return r!==null?r:{}}var xE=new jt("tag:yaml.org,2002:set",{kind:"mapping",resolve:u5,construct:f5}),M0=fE.extend({implicit:[_E,gE],explicit:[yE,vE,SE,xE]}),zr=Object.prototype.hasOwnProperty,Mf=1,wE=2,bE=3,If=4,E_=1,p5=2,tw=3,m5=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,_5=/[\x85\u2028\u2029]/,g5=/[,\[\]\{\}]/,TE=/^(?:!|!!|![a-z\-]+!)$/i,EE=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function sw(r){return Object.prototype.toString.call(r)}function Yi(r){return r===10||r===13}function Va(r){return r===9||r===32}function fs(r){return r===9||r===32||r===10||r===13}function tl(r){return r===44||r===91||r===93||r===123||r===125}function y5(r){var e;return 48<=r&&r<=57?r-48:(e=r|32,97<=e&&e<=102?e-97+10:-1)}function v5(r){return r===120?2:r===117?4:r===85?8:0}function S5(r){return 48<=r&&r<=57?r-48:-1}function iw(r){return r===48?"\0":r===97?"\x07":r===98?"\b":r===116||r===9?"	":r===110?`
`:r===118?"\v":r===102?"\f":r===114?"\r":r===101?"\x1B":r===32?" ":r===34?'"':r===47?"/":r===92?"\\":r===78?"":r===95?"":r===76?"\u2028":r===80?"\u2029":""}function x5(r){return r<=65535?String.fromCharCode(r):String.fromCharCode((r-65536>>10)+55296,(r-65536&1023)+56320)}var CE=new Array(256),AE=new Array(256);for(var jo=0;jo<256;jo++)CE[jo]=iw(jo)?1:0,AE[jo]=iw(jo);function w5(r,e){this.input=r,this.filename=e.filename||null,this.schema=e.schema||M0,this.onWarning=e.onWarning||null,this.legacy=e.legacy||!1,this.json=e.json||!1,this.listener=e.listener||null,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=r.length,this.position=0,this.line=0,this.lineStart=0,this.lineIndent=0,this.firstTabInLine=-1,this.documents=[]}function PE(r,e){var t={name:r.filename,buffer:r.input.slice(0,-1),position:r.position,line:r.line,column:r.position-r.lineStart};return t.snippet=CV(t),new rs(e,t)}function de(r,e){throw PE(r,e)}function Rf(r,e){r.onWarning&&r.onWarning.call(null,PE(r,e))}var nw={YAML:function(e,t,s){var i,n,a;e.version!==null&&de(e,"duplication of %YAML directive"),s.length!==1&&de(e,"YAML directive accepts exactly one argument"),i=/^([0-9]+)\.([0-9]+)$/.exec(s[0]),i===null&&de(e,"ill-formed argument of the YAML directive"),n=parseInt(i[1],10),a=parseInt(i[2],10),n!==1&&de(e,"unacceptable YAML version of the document"),e.version=s[0],e.checkLineBreaks=a<2,a!==1&&a!==2&&Rf(e,"unsupported YAML version of the document")},TAG:function(e,t,s){var i,n;s.length!==2&&de(e,"TAG directive accepts exactly two arguments"),i=s[0],n=s[1],TE.test(i)||de(e,"ill-formed tag handle (first argument) of the TAG directive"),zr.call(e.tagMap,i)&&de(e,'there is a previously declared suffix for "'+i+'" tag handle'),EE.test(n)||de(e,"ill-formed tag prefix (second argument) of the TAG directive");try{n=decodeURIComponent(n)}catch{de(e,"tag prefix is malformed: "+n)}e.tagMap[i]=n}};function Pr(r,e,t,s){var i,n,a,o;if(e<t){if(o=r.input.slice(e,t),s)for(i=0,n=o.length;i<n;i+=1)a=o.charCodeAt(i),a===9||32<=a&&a<=1114111||de(r,"expected valid JSON character");else m5.test(o)&&de(r,"the stream contains non-printable characters");r.result+=o}}function rw(r,e,t,s){var i,n,a,o;for(It.isObject(t)||de(r,"cannot merge mappings; the provided source object is unacceptable"),i=Object.keys(t),a=0,o=i.length;a<o;a+=1)n=i[a],zr.call(e,n)||(e[n]=t[n],s[n]=!0)}function sl(r,e,t,s,i,n,a,o,l){var c,d;if(Array.isArray(i))for(i=Array.prototype.slice.call(i),c=0,d=i.length;c<d;c+=1)Array.isArray(i[c])&&de(r,"nested arrays are not supported inside keys"),typeof i=="object"&&sw(i[c])==="[object Object]"&&(i[c]="[object Object]");if(typeof i=="object"&&sw(i)==="[object Object]"&&(i="[object Object]"),i=String(i),e===null&&(e={}),s==="tag:yaml.org,2002:merge")if(Array.isArray(n))for(c=0,d=n.length;c<d;c+=1)rw(r,e,n[c],t);else rw(r,e,n,t);else!r.json&&!zr.call(t,i)&&zr.call(e,i)&&(r.line=a||r.line,r.lineStart=o||r.lineStart,r.position=l||r.position,de(r,"duplicated mapping key")),i==="__proto__"?Object.defineProperty(e,i,{configurable:!0,enumerable:!0,writable:!0,value:n}):e[i]=n,delete t[i];return e}function I0(r){var e;e=r.input.charCodeAt(r.position),e===10?r.position++:e===13?(r.position++,r.input.charCodeAt(r.position)===10&&r.position++):de(r,"a line break is expected"),r.line+=1,r.lineStart=r.position,r.firstTabInLine=-1}function bt(r,e,t){for(var s=0,i=r.input.charCodeAt(r.position);i!==0;){for(;Va(i);)i===9&&r.firstTabInLine===-1&&(r.firstTabInLine=r.position),i=r.input.charCodeAt(++r.position);if(e&&i===35)do i=r.input.charCodeAt(++r.position);while(i!==10&&i!==13&&i!==0);if(Yi(i))for(I0(r),i=r.input.charCodeAt(r.position),s++,r.lineIndent=0;i===32;)r.lineIndent++,i=r.input.charCodeAt(++r.position);else break}return t!==-1&&s!==0&&r.lineIndent<t&&Rf(r,"deficient indentation"),s}function nm(r){var e=r.position,t;return t=r.input.charCodeAt(e),!!((t===45||t===46)&&t===r.input.charCodeAt(e+1)&&t===r.input.charCodeAt(e+2)&&(e+=3,t=r.input.charCodeAt(e),t===0||fs(t)))}function R0(r,e){e===1?r.result+=" ":e>1&&(r.result+=It.repeat(`
`,e-1))}function b5(r,e,t){var s,i,n,a,o,l,c,d,h=r.kind,u=r.result,f;if(f=r.input.charCodeAt(r.position),fs(f)||tl(f)||f===35||f===38||f===42||f===33||f===124||f===62||f===39||f===34||f===37||f===64||f===96||(f===63||f===45)&&(i=r.input.charCodeAt(r.position+1),fs(i)||t&&tl(i)))return!1;for(r.kind="scalar",r.result="",n=a=r.position,o=!1;f!==0;){if(f===58){if(i=r.input.charCodeAt(r.position+1),fs(i)||t&&tl(i))break}else if(f===35){if(s=r.input.charCodeAt(r.position-1),fs(s))break}else{if(r.position===r.lineStart&&nm(r)||t&&tl(f))break;if(Yi(f))if(l=r.line,c=r.lineStart,d=r.lineIndent,bt(r,!1,-1),r.lineIndent>=e){o=!0,f=r.input.charCodeAt(r.position);continue}else{r.position=a,r.line=l,r.lineStart=c,r.lineIndent=d;break}}o&&(Pr(r,n,a,!1),R0(r,r.line-l),n=a=r.position,o=!1),Va(f)||(a=r.position+1),f=r.input.charCodeAt(++r.position)}return Pr(r,n,a,!1),r.result?!0:(r.kind=h,r.result=u,!1)}function T5(r,e){var t,s,i;if(t=r.input.charCodeAt(r.position),t!==39)return!1;for(r.kind="scalar",r.result="",r.position++,s=i=r.position;(t=r.input.charCodeAt(r.position))!==0;)if(t===39)if(Pr(r,s,r.position,!0),t=r.input.charCodeAt(++r.position),t===39)s=r.position,r.position++,i=r.position;else return!0;else Yi(t)?(Pr(r,s,i,!0),R0(r,bt(r,!1,e)),s=i=r.position):r.position===r.lineStart&&nm(r)?de(r,"unexpected end of the document within a single quoted scalar"):(r.position++,i=r.position);de(r,"unexpected end of the stream within a single quoted scalar")}function E5(r,e){var t,s,i,n,a,o;if(o=r.input.charCodeAt(r.position),o!==34)return!1;for(r.kind="scalar",r.result="",r.position++,t=s=r.position;(o=r.input.charCodeAt(r.position))!==0;){if(o===34)return Pr(r,t,r.position,!0),r.position++,!0;if(o===92){if(Pr(r,t,r.position,!0),o=r.input.charCodeAt(++r.position),Yi(o))bt(r,!1,e);else if(o<256&&CE[o])r.result+=AE[o],r.position++;else if((a=v5(o))>0){for(i=a,n=0;i>0;i--)o=r.input.charCodeAt(++r.position),(a=y5(o))>=0?n=(n<<4)+a:de(r,"expected hexadecimal character");r.result+=x5(n),r.position++}else de(r,"unknown escape sequence");t=s=r.position}else Yi(o)?(Pr(r,t,s,!0),R0(r,bt(r,!1,e)),t=s=r.position):r.position===r.lineStart&&nm(r)?de(r,"unexpected end of the document within a double quoted scalar"):(r.position++,s=r.position)}de(r,"unexpected end of the stream within a double quoted scalar")}function C5(r,e){var t=!0,s,i,n,a=r.tag,o,l=r.anchor,c,d,h,u,f,p=Object.create(null),_,m,g,v;if(v=r.input.charCodeAt(r.position),v===91)d=93,f=!1,o=[];else if(v===123)d=125,f=!0,o={};else return!1;for(r.anchor!==null&&(r.anchorMap[r.anchor]=o),v=r.input.charCodeAt(++r.position);v!==0;){if(bt(r,!0,e),v=r.input.charCodeAt(r.position),v===d)return r.position++,r.tag=a,r.anchor=l,r.kind=f?"mapping":"sequence",r.result=o,!0;t?v===44&&de(r,"expected the node content, but found ','"):de(r,"missed comma between flow collection entries"),m=_=g=null,h=u=!1,v===63&&(c=r.input.charCodeAt(r.position+1),fs(c)&&(h=u=!0,r.position++,bt(r,!0,e))),s=r.line,i=r.lineStart,n=r.position,Xl(r,e,Mf,!1,!0),m=r.tag,_=r.result,bt(r,!0,e),v=r.input.charCodeAt(r.position),(u||r.line===s)&&v===58&&(h=!0,v=r.input.charCodeAt(++r.position),bt(r,!0,e),Xl(r,e,Mf,!1,!0),g=r.result),f?sl(r,o,p,m,_,g,s,i,n):h?o.push(sl(r,null,p,m,_,g,s,i,n)):o.push(_),bt(r,!0,e),v=r.input.charCodeAt(r.position),v===44?(t=!0,v=r.input.charCodeAt(++r.position)):t=!1}de(r,"unexpected end of the stream within a flow collection")}function A5(r,e){var t,s,i=E_,n=!1,a=!1,o=e,l=0,c=!1,d,h;if(h=r.input.charCodeAt(r.position),h===124)s=!1;else if(h===62)s=!0;else return!1;for(r.kind="scalar",r.result="";h!==0;)if(h=r.input.charCodeAt(++r.position),h===43||h===45)E_===i?i=h===43?tw:p5:de(r,"repeat of a chomping mode identifier");else if((d=S5(h))>=0)d===0?de(r,"bad explicit indentation width of a block scalar; it cannot be less than one"):a?de(r,"repeat of an indentation width identifier"):(o=e+d-1,a=!0);else break;if(Va(h)){do h=r.input.charCodeAt(++r.position);while(Va(h));if(h===35)do h=r.input.charCodeAt(++r.position);while(!Yi(h)&&h!==0)}for(;h!==0;){for(I0(r),r.lineIndent=0,h=r.input.charCodeAt(r.position);(!a||r.lineIndent<o)&&h===32;)r.lineIndent++,h=r.input.charCodeAt(++r.position);if(!a&&r.lineIndent>o&&(o=r.lineIndent),Yi(h)){l++;continue}if(r.lineIndent<o){i===tw?r.result+=It.repeat(`
`,n?1+l:l):i===E_&&n&&(r.result+=`
`);break}for(s?Va(h)?(c=!0,r.result+=It.repeat(`
`,n?1+l:l)):c?(c=!1,r.result+=It.repeat(`
`,l+1)):l===0?n&&(r.result+=" "):r.result+=It.repeat(`
`,l):r.result+=It.repeat(`
`,n?1+l:l),n=!0,a=!0,l=0,t=r.position;!Yi(h)&&h!==0;)h=r.input.charCodeAt(++r.position);Pr(r,t,r.position,!1)}return!0}function aw(r,e){var t,s=r.tag,i=r.anchor,n=[],a,o=!1,l;if(r.firstTabInLine!==-1)return!1;for(r.anchor!==null&&(r.anchorMap[r.anchor]=n),l=r.input.charCodeAt(r.position);l!==0&&(r.firstTabInLine!==-1&&(r.position=r.firstTabInLine,de(r,"tab characters must not be used in indentation")),!(l!==45||(a=r.input.charCodeAt(r.position+1),!fs(a))));){if(o=!0,r.position++,bt(r,!0,-1)&&r.lineIndent<=e){n.push(null),l=r.input.charCodeAt(r.position);continue}if(t=r.line,Xl(r,e,bE,!1,!0),n.push(r.result),bt(r,!0,-1),l=r.input.charCodeAt(r.position),(r.line===t||r.lineIndent>e)&&l!==0)de(r,"bad indentation of a sequence entry");else if(r.lineIndent<e)break}return o?(r.tag=s,r.anchor=i,r.kind="sequence",r.result=n,!0):!1}function P5(r,e,t){var s,i,n,a,o,l,c=r.tag,d=r.anchor,h={},u=Object.create(null),f=null,p=null,_=null,m=!1,g=!1,v;if(r.firstTabInLine!==-1)return!1;for(r.anchor!==null&&(r.anchorMap[r.anchor]=h),v=r.input.charCodeAt(r.position);v!==0;){if(!m&&r.firstTabInLine!==-1&&(r.position=r.firstTabInLine,de(r,"tab characters must not be used in indentation")),s=r.input.charCodeAt(r.position+1),n=r.line,(v===63||v===58)&&fs(s))v===63?(m&&(sl(r,h,u,f,p,null,a,o,l),f=p=_=null),g=!0,m=!0,i=!0):m?(m=!1,i=!0):de(r,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line"),r.position+=1,v=s;else{if(a=r.line,o=r.lineStart,l=r.position,!Xl(r,t,wE,!1,!0))break;if(r.line===n){for(v=r.input.charCodeAt(r.position);Va(v);)v=r.input.charCodeAt(++r.position);if(v===58)v=r.input.charCodeAt(++r.position),fs(v)||de(r,"a whitespace character is expected after the key-value separator within a block mapping"),m&&(sl(r,h,u,f,p,null,a,o,l),f=p=_=null),g=!0,m=!1,i=!1,f=r.tag,p=r.result;else if(g)de(r,"can not read an implicit mapping pair; a colon is missed");else return r.tag=c,r.anchor=d,!0}else if(g)de(r,"can not read a block mapping entry; a multiline key may not be an implicit key");else return r.tag=c,r.anchor=d,!0}if((r.line===n||r.lineIndent>e)&&(m&&(a=r.line,o=r.lineStart,l=r.position),Xl(r,e,If,!0,i)&&(m?p=r.result:_=r.result),m||(sl(r,h,u,f,p,_,a,o,l),f=p=_=null),bt(r,!0,-1),v=r.input.charCodeAt(r.position)),(r.line===n||r.lineIndent>e)&&v!==0)de(r,"bad indentation of a mapping entry");else if(r.lineIndent<e)break}return m&&sl(r,h,u,f,p,null,a,o,l),g&&(r.tag=c,r.anchor=d,r.kind="mapping",r.result=h),g}function M5(r){var e,t=!1,s=!1,i,n,a;if(a=r.input.charCodeAt(r.position),a!==33)return!1;if(r.tag!==null&&de(r,"duplication of a tag property"),a=r.input.charCodeAt(++r.position),a===60?(t=!0,a=r.input.charCodeAt(++r.position)):a===33?(s=!0,i="!!",a=r.input.charCodeAt(++r.position)):i="!",e=r.position,t){do a=r.input.charCodeAt(++r.position);while(a!==0&&a!==62);r.position<r.length?(n=r.input.slice(e,r.position),a=r.input.charCodeAt(++r.position)):de(r,"unexpected end of the stream within a verbatim tag")}else{for(;a!==0&&!fs(a);)a===33&&(s?de(r,"tag suffix cannot contain exclamation marks"):(i=r.input.slice(e-1,r.position+1),TE.test(i)||de(r,"named tag handle cannot contain such characters"),s=!0,e=r.position+1)),a=r.input.charCodeAt(++r.position);n=r.input.slice(e,r.position),g5.test(n)&&de(r,"tag suffix cannot contain flow indicator characters")}n&&!EE.test(n)&&de(r,"tag name cannot contain such characters: "+n);try{n=decodeURIComponent(n)}catch{de(r,"tag name is malformed: "+n)}return t?r.tag=n:zr.call(r.tagMap,i)?r.tag=r.tagMap[i]+n:i==="!"?r.tag="!"+n:i==="!!"?r.tag="tag:yaml.org,2002:"+n:de(r,'undeclared tag handle "'+i+'"'),!0}function I5(r){var e,t;if(t=r.input.charCodeAt(r.position),t!==38)return!1;for(r.anchor!==null&&de(r,"duplication of an anchor property"),t=r.input.charCodeAt(++r.position),e=r.position;t!==0&&!fs(t)&&!tl(t);)t=r.input.charCodeAt(++r.position);return r.position===e&&de(r,"name of an anchor node must contain at least one character"),r.anchor=r.input.slice(e,r.position),!0}function R5(r){var e,t,s;if(s=r.input.charCodeAt(r.position),s!==42)return!1;for(s=r.input.charCodeAt(++r.position),e=r.position;s!==0&&!fs(s)&&!tl(s);)s=r.input.charCodeAt(++r.position);return r.position===e&&de(r,"name of an alias node must contain at least one character"),t=r.input.slice(e,r.position),zr.call(r.anchorMap,t)||de(r,'unidentified alias "'+t+'"'),r.result=r.anchorMap[t],bt(r,!0,-1),!0}function Xl(r,e,t,s,i){var n,a,o,l=1,c=!1,d=!1,h,u,f,p,_,m;if(r.listener!==null&&r.listener("open",r),r.tag=null,r.anchor=null,r.kind=null,r.result=null,n=a=o=If===t||bE===t,s&&bt(r,!0,-1)&&(c=!0,r.lineIndent>e?l=1:r.lineIndent===e?l=0:r.lineIndent<e&&(l=-1)),l===1)for(;M5(r)||I5(r);)bt(r,!0,-1)?(c=!0,o=n,r.lineIndent>e?l=1:r.lineIndent===e?l=0:r.lineIndent<e&&(l=-1)):o=!1;if(o&&(o=c||i),(l===1||If===t)&&(Mf===t||wE===t?_=e:_=e+1,m=r.position-r.lineStart,l===1?o&&(aw(r,m)||P5(r,m,_))||C5(r,_)?d=!0:(a&&A5(r,_)||T5(r,_)||E5(r,_)?d=!0:R5(r)?(d=!0,(r.tag!==null||r.anchor!==null)&&de(r,"alias node should not have any properties")):b5(r,_,Mf===t)&&(d=!0,r.tag===null&&(r.tag="?")),r.anchor!==null&&(r.anchorMap[r.anchor]=r.result)):l===0&&(d=o&&aw(r,m))),r.tag===null)r.anchor!==null&&(r.anchorMap[r.anchor]=r.result);else if(r.tag==="?"){for(r.result!==null&&r.kind!=="scalar"&&de(r,'unacceptable node kind for !<?> tag; it should be "scalar", not "'+r.kind+'"'),h=0,u=r.implicitTypes.length;h<u;h+=1)if(p=r.implicitTypes[h],p.resolve(r.result)){r.result=p.construct(r.result),r.tag=p.tag,r.anchor!==null&&(r.anchorMap[r.anchor]=r.result);break}}else if(r.tag!=="!"){if(zr.call(r.typeMap[r.kind||"fallback"],r.tag))p=r.typeMap[r.kind||"fallback"][r.tag];else for(p=null,f=r.typeMap.multi[r.kind||"fallback"],h=0,u=f.length;h<u;h+=1)if(r.tag.slice(0,f[h].tag.length)===f[h].tag){p=f[h];break}p||de(r,"unknown tag !<"+r.tag+">"),r.result!==null&&p.kind!==r.kind&&de(r,"unacceptable node kind for !<"+r.tag+'> tag; it should be "'+p.kind+'", not "'+r.kind+'"'),p.resolve(r.result,r.tag)?(r.result=p.construct(r.result,r.tag),r.anchor!==null&&(r.anchorMap[r.anchor]=r.result)):de(r,"cannot resolve a node with !<"+r.tag+"> explicit tag")}return r.listener!==null&&r.listener("close",r),r.tag!==null||r.anchor!==null||d}function L5(r){var e=r.position,t,s,i,n=!1,a;for(r.version=null,r.checkLineBreaks=r.legacy,r.tagMap=Object.create(null),r.anchorMap=Object.create(null);(a=r.input.charCodeAt(r.position))!==0&&(bt(r,!0,-1),a=r.input.charCodeAt(r.position),!(r.lineIndent>0||a!==37));){for(n=!0,a=r.input.charCodeAt(++r.position),t=r.position;a!==0&&!fs(a);)a=r.input.charCodeAt(++r.position);for(s=r.input.slice(t,r.position),i=[],s.length<1&&de(r,"directive name must not be less than one character in length");a!==0;){for(;Va(a);)a=r.input.charCodeAt(++r.position);if(a===35){do a=r.input.charCodeAt(++r.position);while(a!==0&&!Yi(a));break}if(Yi(a))break;for(t=r.position;a!==0&&!fs(a);)a=r.input.charCodeAt(++r.position);i.push(r.input.slice(t,r.position))}a!==0&&I0(r),zr.call(nw,s)?nw[s](r,s,i):Rf(r,'unknown document directive "'+s+'"')}if(bt(r,!0,-1),r.lineIndent===0&&r.input.charCodeAt(r.position)===45&&r.input.charCodeAt(r.position+1)===45&&r.input.charCodeAt(r.position+2)===45?(r.position+=3,bt(r,!0,-1)):n&&de(r,"directives end mark is expected"),Xl(r,r.lineIndent-1,If,!1,!0),bt(r,!0,-1),r.checkLineBreaks&&_5.test(r.input.slice(e,r.position))&&Rf(r,"non-ASCII line breaks are interpreted as content"),r.documents.push(r.result),r.position===r.lineStart&&nm(r)){r.input.charCodeAt(r.position)===46&&(r.position+=3,bt(r,!0,-1));return}if(r.position<r.length-1)de(r,"end of the stream or a document separator is expected");else return}function ME(r,e){r=String(r),e=e||{},r.length!==0&&(r.charCodeAt(r.length-1)!==10&&r.charCodeAt(r.length-1)!==13&&(r+=`
`),r.charCodeAt(0)===65279&&(r=r.slice(1)));var t=new w5(r,e),s=r.indexOf("\0");for(s!==-1&&(t.position=s,de(t,"null byte is not allowed in input")),t.input+="\0";t.input.charCodeAt(t.position)===32;)t.lineIndent+=1,t.position+=1;for(;t.position<t.length-1;)L5(t);return t.documents}function D5(r,e,t){e!==null&&typeof e=="object"&&typeof t>"u"&&(t=e,e=null);var s=ME(r,t);if(typeof e!="function")return s;for(var i=0,n=s.length;i<n;i+=1)e(s[i])}function O5(r,e){var t=ME(r,e);if(t.length!==0){if(t.length===1)return t[0];throw new rs("expected a single document in the stream, but found more")}}var F5=D5,k5=O5,IE={loadAll:F5,load:k5},RE=Object.prototype.toString,LE=Object.prototype.hasOwnProperty,L0=65279,B5=9,Gc=10,N5=13,U5=32,z5=33,V5=34,Xg=35,G5=37,H5=38,W5=39,j5=42,DE=44,$5=45,Lf=58,X5=61,q5=62,K5=63,Y5=64,OE=91,FE=93,Z5=96,kE=123,J5=124,BE=125,Qt={};Qt[0]="\\0";Qt[7]="\\a";Qt[8]="\\b";Qt[9]="\\t";Qt[10]="\\n";Qt[11]="\\v";Qt[12]="\\f";Qt[13]="\\r";Qt[27]="\\e";Qt[34]='\\"';Qt[92]="\\\\";Qt[133]="\\N";Qt[160]="\\_";Qt[8232]="\\L";Qt[8233]="\\P";var Q5=["y","Y","yes","Yes","YES","on","On","ON","n","N","no","No","NO","off","Off","OFF"],eG=/^[-+]?[0-9_]+(?::[0-9_]+)+(?:\.[0-9_]*)?$/;function tG(r,e){var t,s,i,n,a,o,l;if(e===null)return{};for(t={},s=Object.keys(e),i=0,n=s.length;i<n;i+=1)a=s[i],o=String(e[a]),a.slice(0,2)==="!!"&&(a="tag:yaml.org,2002:"+a.slice(2)),l=r.compiledTypeMap.fallback[a],l&&LE.call(l.styleAliases,o)&&(o=l.styleAliases[o]),t[a]=o;return t}function sG(r){var e,t,s;if(e=r.toString(16).toUpperCase(),r<=255)t="x",s=2;else if(r<=65535)t="u",s=4;else if(r<=4294967295)t="U",s=8;else throw new rs("code point within a string may not be greater than 0xFFFFFFFF");return"\\"+t+It.repeat("0",s-e.length)+e}var iG=1,Hc=2;function nG(r){this.schema=r.schema||M0,this.indent=Math.max(1,r.indent||2),this.noArrayIndent=r.noArrayIndent||!1,this.skipInvalid=r.skipInvalid||!1,this.flowLevel=It.isNothing(r.flowLevel)?-1:r.flowLevel,this.styleMap=tG(this.schema,r.styles||null),this.sortKeys=r.sortKeys||!1,this.lineWidth=r.lineWidth||80,this.noRefs=r.noRefs||!1,this.noCompatMode=r.noCompatMode||!1,this.condenseFlow=r.condenseFlow||!1,this.quotingType=r.quotingType==='"'?Hc:iG,this.forceQuotes=r.forceQuotes||!1,this.replacer=typeof r.replacer=="function"?r.replacer:null,this.implicitTypes=this.schema.compiledImplicit,this.explicitTypes=this.schema.compiledExplicit,this.tag=null,this.result="",this.duplicates=[],this.usedDuplicates=null}function ow(r,e){for(var t=It.repeat(" ",e),s=0,i=-1,n="",a,o=r.length;s<o;)i=r.indexOf(`
`,s),i===-1?(a=r.slice(s),s=o):(a=r.slice(s,i+1),s=i+1),a.length&&a!==`
`&&(n+=t),n+=a;return n}function qg(r,e){return`
`+It.repeat(" ",r.indent*e)}function rG(r,e){var t,s,i;for(t=0,s=r.implicitTypes.length;t<s;t+=1)if(i=r.implicitTypes[t],i.resolve(e))return!0;return!1}function Df(r){return r===U5||r===B5}function Wc(r){return 32<=r&&r<=126||161<=r&&r<=55295&&r!==8232&&r!==8233||57344<=r&&r<=65533&&r!==L0||65536<=r&&r<=1114111}function lw(r){return Wc(r)&&r!==L0&&r!==N5&&r!==Gc}function hw(r,e,t){var s=lw(r),i=s&&!Df(r);return(t?s:s&&r!==DE&&r!==OE&&r!==FE&&r!==kE&&r!==BE)&&r!==Xg&&!(e===Lf&&!i)||lw(e)&&!Df(e)&&r===Xg||e===Lf&&i}function aG(r){return Wc(r)&&r!==L0&&!Df(r)&&r!==$5&&r!==K5&&r!==Lf&&r!==DE&&r!==OE&&r!==FE&&r!==kE&&r!==BE&&r!==Xg&&r!==H5&&r!==j5&&r!==z5&&r!==J5&&r!==X5&&r!==q5&&r!==W5&&r!==V5&&r!==G5&&r!==Y5&&r!==Z5}function oG(r){return!Df(r)&&r!==Lf}function $h(r,e){var t=r.charCodeAt(e),s;return t>=55296&&t<=56319&&e+1<r.length&&(s=r.charCodeAt(e+1),s>=56320&&s<=57343)?(t-55296)*1024+s-56320+65536:t}function NE(r){var e=/^\n* /;return e.test(r)}var UE=1,Kg=2,zE=3,VE=4,Yo=5;function lG(r,e,t,s,i,n,a,o){var l,c=0,d=null,h=!1,u=!1,f=s!==-1,p=-1,_=aG($h(r,0))&&oG($h(r,r.length-1));if(e||a)for(l=0;l<r.length;c>=65536?l+=2:l++){if(c=$h(r,l),!Wc(c))return Yo;_=_&&hw(c,d,o),d=c}else{for(l=0;l<r.length;c>=65536?l+=2:l++){if(c=$h(r,l),c===Gc)h=!0,f&&(u=u||l-p-1>s&&r[p+1]!==" ",p=l);else if(!Wc(c))return Yo;_=_&&hw(c,d,o),d=c}u=u||f&&l-p-1>s&&r[p+1]!==" "}return!h&&!u?_&&!a&&!i(r)?UE:n===Hc?Yo:Kg:t>9&&NE(r)?Yo:a?n===Hc?Yo:Kg:u?VE:zE}function hG(r,e,t,s,i){r.dump=function(){if(e.length===0)return r.quotingType===Hc?'""':"''";if(!r.noCompatMode&&(Q5.indexOf(e)!==-1||eG.test(e)))return r.quotingType===Hc?'"'+e+'"':"'"+e+"'";var n=r.indent*Math.max(1,t),a=r.lineWidth===-1?-1:Math.max(Math.min(r.lineWidth,40),r.lineWidth-n),o=s||r.flowLevel>-1&&t>=r.flowLevel;function l(c){return rG(r,c)}switch(lG(e,o,r.indent,a,l,r.quotingType,r.forceQuotes&&!s,i)){case UE:return e;case Kg:return"'"+e.replace(/'/g,"''")+"'";case zE:return"|"+cw(e,r.indent)+dw(ow(e,n));case VE:return">"+cw(e,r.indent)+dw(ow(cG(e,a),n));case Yo:return'"'+dG(e)+'"';default:throw new rs("impossible error: invalid scalar style")}}()}function cw(r,e){var t=NE(r)?String(e):"",s=r[r.length-1]===`
`,i=s&&(r[r.length-2]===`
`||r===`
`),n=i?"+":s?"":"-";return t+n+`
`}function dw(r){return r[r.length-1]===`
`?r.slice(0,-1):r}function cG(r,e){for(var t=/(\n+)([^\n]*)/g,s=function(){var c=r.indexOf(`
`);return c=c!==-1?c:r.length,t.lastIndex=c,uw(r.slice(0,c),e)}(),i=r[0]===`
`||r[0]===" ",n,a;a=t.exec(r);){var o=a[1],l=a[2];n=l[0]===" ",s+=o+(!i&&!n&&l!==""?`
`:"")+uw(l,e),i=n}return s}function uw(r,e){if(r===""||r[0]===" ")return r;for(var t=/ [^ ]/g,s,i=0,n,a=0,o=0,l="";s=t.exec(r);)o=s.index,o-i>e&&(n=a>i?a:o,l+=`
`+r.slice(i,n),i=n+1),a=o;return l+=`
`,r.length-i>e&&a>i?l+=r.slice(i,a)+`
`+r.slice(a+1):l+=r.slice(i),l.slice(1)}function dG(r){for(var e="",t=0,s,i=0;i<r.length;t>=65536?i+=2:i++)t=$h(r,i),s=Qt[t],!s&&Wc(t)?(e+=r[i],t>=65536&&(e+=r[i+1])):e+=s||sG(t);return e}function uG(r,e,t){var s="",i=r.tag,n,a,o;for(n=0,a=t.length;n<a;n+=1)o=t[n],r.replacer&&(o=r.replacer.call(t,String(n),o)),(Un(r,e,o,!1,!1)||typeof o>"u"&&Un(r,e,null,!1,!1))&&(s!==""&&(s+=","+(r.condenseFlow?"":" ")),s+=r.dump);r.tag=i,r.dump="["+s+"]"}function fw(r,e,t,s){var i="",n=r.tag,a,o,l;for(a=0,o=t.length;a<o;a+=1)l=t[a],r.replacer&&(l=r.replacer.call(t,String(a),l)),(Un(r,e+1,l,!0,!0,!1,!0)||typeof l>"u"&&Un(r,e+1,null,!0,!0,!1,!0))&&((!s||i!=="")&&(i+=qg(r,e)),r.dump&&Gc===r.dump.charCodeAt(0)?i+="-":i+="- ",i+=r.dump);r.tag=n,r.dump=i||"[]"}function fG(r,e,t){var s="",i=r.tag,n=Object.keys(t),a,o,l,c,d;for(a=0,o=n.length;a<o;a+=1)d="",s!==""&&(d+=", "),r.condenseFlow&&(d+='"'),l=n[a],c=t[l],r.replacer&&(c=r.replacer.call(t,l,c)),Un(r,e,l,!1,!1)&&(r.dump.length>1024&&(d+="? "),d+=r.dump+(r.condenseFlow?'"':"")+":"+(r.condenseFlow?"":" "),Un(r,e,c,!1,!1)&&(d+=r.dump,s+=d));r.tag=i,r.dump="{"+s+"}"}function pG(r,e,t,s){var i="",n=r.tag,a=Object.keys(t),o,l,c,d,h,u;if(r.sortKeys===!0)a.sort();else if(typeof r.sortKeys=="function")a.sort(r.sortKeys);else if(r.sortKeys)throw new rs("sortKeys must be a boolean or a function");for(o=0,l=a.length;o<l;o+=1)u="",(!s||i!=="")&&(u+=qg(r,e)),c=a[o],d=t[c],r.replacer&&(d=r.replacer.call(t,c,d)),Un(r,e+1,c,!0,!0,!0)&&(h=r.tag!==null&&r.tag!=="?"||r.dump&&r.dump.length>1024,h&&(r.dump&&Gc===r.dump.charCodeAt(0)?u+="?":u+="? "),u+=r.dump,h&&(u+=qg(r,e)),Un(r,e+1,d,!0,h)&&(r.dump&&Gc===r.dump.charCodeAt(0)?u+=":":u+=": ",u+=r.dump,i+=u));r.tag=n,r.dump=i||"{}"}function pw(r,e,t){var s,i,n,a,o,l;for(i=t?r.explicitTypes:r.implicitTypes,n=0,a=i.length;n<a;n+=1)if(o=i[n],(o.instanceOf||o.predicate)&&(!o.instanceOf||typeof e=="object"&&e instanceof o.instanceOf)&&(!o.predicate||o.predicate(e))){if(t?o.multi&&o.representName?r.tag=o.representName(e):r.tag=o.tag:r.tag="?",o.represent){if(l=r.styleMap[o.tag]||o.defaultStyle,RE.call(o.represent)==="[object Function]")s=o.represent(e,l);else if(LE.call(o.represent,l))s=o.represent[l](e,l);else throw new rs("!<"+o.tag+'> tag resolver accepts not "'+l+'" style');r.dump=s}return!0}return!1}function Un(r,e,t,s,i,n,a){r.tag=null,r.dump=t,pw(r,t,!1)||pw(r,t,!0);var o=RE.call(r.dump),l=s,c;s&&(s=r.flowLevel<0||r.flowLevel>e);var d=o==="[object Object]"||o==="[object Array]",h,u;if(d&&(h=r.duplicates.indexOf(t),u=h!==-1),(r.tag!==null&&r.tag!=="?"||u||r.indent!==2&&e>0)&&(i=!1),u&&r.usedDuplicates[h])r.dump="*ref_"+h;else{if(d&&u&&!r.usedDuplicates[h]&&(r.usedDuplicates[h]=!0),o==="[object Object]")s&&Object.keys(r.dump).length!==0?(pG(r,e,r.dump,i),u&&(r.dump="&ref_"+h+r.dump)):(fG(r,e,r.dump),u&&(r.dump="&ref_"+h+" "+r.dump));else if(o==="[object Array]")s&&r.dump.length!==0?(r.noArrayIndent&&!a&&e>0?fw(r,e-1,r.dump,i):fw(r,e,r.dump,i),u&&(r.dump="&ref_"+h+r.dump)):(uG(r,e,r.dump),u&&(r.dump="&ref_"+h+" "+r.dump));else if(o==="[object String]")r.tag!=="?"&&hG(r,r.dump,e,n,l);else{if(o==="[object Undefined]")return!1;if(r.skipInvalid)return!1;throw new rs("unacceptable kind of an object to dump "+o)}r.tag!==null&&r.tag!=="?"&&(c=encodeURI(r.tag[0]==="!"?r.tag.slice(1):r.tag).replace(/!/g,"%21"),r.tag[0]==="!"?c="!"+c:c.slice(0,18)==="tag:yaml.org,2002:"?c="!!"+c.slice(18):c="!<"+c+">",r.dump=c+" "+r.dump)}return!0}function mG(r,e){var t=[],s=[],i,n;for(Yg(r,t,s),i=0,n=s.length;i<n;i+=1)e.duplicates.push(t[s[i]]);e.usedDuplicates=new Array(n)}function Yg(r,e,t){var s,i,n;if(r!==null&&typeof r=="object")if(i=e.indexOf(r),i!==-1)t.indexOf(i)===-1&&t.push(i);else if(e.push(r),Array.isArray(r))for(i=0,n=r.length;i<n;i+=1)Yg(r[i],e,t);else for(s=Object.keys(r),i=0,n=s.length;i<n;i+=1)Yg(r[s[i]],e,t)}function _G(r,e){e=e||{};var t=new nG(e);t.noRefs||mG(r,t);var s=r;return t.replacer&&(s=t.replacer.call({"":s},"",s)),Un(t,0,s,!0,!0)?t.dump+`
`:""}var gG=_G,yG={dump:gG};function D0(r,e){return function(){throw new Error("Function yaml."+r+" is removed in js-yaml 4. Use yaml."+e+" instead, which is now safe by default.")}}var vG=jt,SG=iE,xG=oE,wG=uE,bG=fE,TG=M0,EG=IE.load,CG=IE.loadAll,AG=yG.dump,PG=rs,MG={binary:yE,float:dE,map:aE,null:lE,pairs:SE,set:xE,timestamp:_E,bool:hE,int:cE,merge:gE,omap:vE,seq:rE,str:nE},IG=D0("safeLoad","load"),RG=D0("safeLoadAll","loadAll"),LG=D0("safeDump","dump"),DG={Type:vG,Schema:SG,FAILSAFE_SCHEMA:xG,JSON_SCHEMA:wG,CORE_SCHEMA:bG,DEFAULT_SCHEMA:TG,load:EG,loadAll:CG,dump:AG,YAMLException:PG,types:MG,safeLoad:IG,safeLoadAll:RG,safeDump:LG},Bh=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function OG(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var fr={};/*!
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(r){(function(){var e=function(){this.init()};e.prototype={init:function(){var h=this||t;return h._counter=1e3,h._html5AudioPool=[],h.html5PoolSize=10,h._codecs={},h._howls=[],h._muted=!1,h._volume=1,h._canPlayEvent="canplaythrough",h._navigator=typeof window<"u"&&window.navigator?window.navigator:null,h.masterGain=null,h.noAudio=!1,h.usingWebAudio=!0,h.autoSuspend=!0,h.ctx=null,h.autoUnlock=!0,h._setup(),h},volume:function(h){var u=this||t;if(h=parseFloat(h),u.ctx||d(),typeof h<"u"&&h>=0&&h<=1){if(u._volume=h,u._muted)return u;u.usingWebAudio&&u.masterGain.gain.setValueAtTime(h,t.ctx.currentTime);for(var f=0;f<u._howls.length;f++)if(!u._howls[f]._webAudio)for(var p=u._howls[f]._getSoundIds(),_=0;_<p.length;_++){var m=u._howls[f]._soundById(p[_]);m&&m._node&&(m._node.volume=m._volume*h)}return u}return u._volume},mute:function(h){var u=this||t;u.ctx||d(),u._muted=h,u.usingWebAudio&&u.masterGain.gain.setValueAtTime(h?0:u._volume,t.ctx.currentTime);for(var f=0;f<u._howls.length;f++)if(!u._howls[f]._webAudio)for(var p=u._howls[f]._getSoundIds(),_=0;_<p.length;_++){var m=u._howls[f]._soundById(p[_]);m&&m._node&&(m._node.muted=h?!0:m._muted)}return u},stop:function(){for(var h=this||t,u=0;u<h._howls.length;u++)h._howls[u].stop();return h},unload:function(){for(var h=this||t,u=h._howls.length-1;u>=0;u--)h._howls[u].unload();return h.usingWebAudio&&h.ctx&&typeof h.ctx.close<"u"&&(h.ctx.close(),h.ctx=null,d()),h},codecs:function(h){return(this||t)._codecs[h.replace(/^x-/,"")]},_setup:function(){var h=this||t;if(h.state=h.ctx&&h.ctx.state||"suspended",h._autoSuspend(),!h.usingWebAudio)if(typeof Audio<"u")try{var u=new Audio;typeof u.oncanplaythrough>"u"&&(h._canPlayEvent="canplay")}catch{h.noAudio=!0}else h.noAudio=!0;try{var u=new Audio;u.muted&&(h.noAudio=!0)}catch{}return h.noAudio||h._setupCodecs(),h},_setupCodecs:function(){var h=this||t,u=null;try{u=typeof Audio<"u"?new Audio:null}catch{return h}if(!u||typeof u.canPlayType!="function")return h;var f=u.canPlayType("audio/mpeg;").replace(/^no$/,""),p=h._navigator?h._navigator.userAgent:"",_=p.match(/OPR\/(\d+)/g),m=_&&parseInt(_[0].split("/")[1],10)<33,g=p.indexOf("Safari")!==-1&&p.indexOf("Chrome")===-1,v=p.match(/Version\/(.*?) /),x=g&&v&&parseInt(v[1],10)<15;return h._codecs={mp3:!!(!m&&(f||u.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!f,opus:!!u.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!u.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!u.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(u.canPlayType('audio/wav; codecs="1"')||u.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!u.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!u.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(u.canPlayType("audio/x-m4a;")||u.canPlayType("audio/m4a;")||u.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(u.canPlayType("audio/x-m4b;")||u.canPlayType("audio/m4b;")||u.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(u.canPlayType("audio/x-mp4;")||u.canPlayType("audio/mp4;")||u.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!x&&u.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!x&&u.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!u.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(u.canPlayType("audio/x-flac;")||u.canPlayType("audio/flac;")).replace(/^no$/,"")},h},_unlockAudio:function(){var h=this||t;if(!(h._audioUnlocked||!h.ctx)){h._audioUnlocked=!1,h.autoUnlock=!1,!h._mobileUnloaded&&h.ctx.sampleRate!==44100&&(h._mobileUnloaded=!0,h.unload()),h._scratchBuffer=h.ctx.createBuffer(1,1,22050);var u=function(f){for(;h._html5AudioPool.length<h.html5PoolSize;)try{var p=new Audio;p._unlocked=!0,h._releaseHtml5Audio(p)}catch{h.noAudio=!0;break}for(var _=0;_<h._howls.length;_++)if(!h._howls[_]._webAudio)for(var m=h._howls[_]._getSoundIds(),g=0;g<m.length;g++){var v=h._howls[_]._soundById(m[g]);v&&v._node&&!v._node._unlocked&&(v._node._unlocked=!0,v._node.load())}h._autoResume();var x=h.ctx.createBufferSource();x.buffer=h._scratchBuffer,x.connect(h.ctx.destination),typeof x.start>"u"?x.noteOn(0):x.start(0),typeof h.ctx.resume=="function"&&h.ctx.resume(),x.onended=function(){x.disconnect(0),h._audioUnlocked=!0,document.removeEventListener("touchstart",u,!0),document.removeEventListener("touchend",u,!0),document.removeEventListener("click",u,!0),document.removeEventListener("keydown",u,!0);for(var S=0;S<h._howls.length;S++)h._howls[S]._emit("unlock")}};return document.addEventListener("touchstart",u,!0),document.addEventListener("touchend",u,!0),document.addEventListener("click",u,!0),document.addEventListener("keydown",u,!0),h}},_obtainHtml5Audio:function(){var h=this||t;if(h._html5AudioPool.length)return h._html5AudioPool.pop();var u=new Audio().play();return u&&typeof Promise<"u"&&(u instanceof Promise||typeof u.then=="function")&&u.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(h){var u=this||t;return h._unlocked&&u._html5AudioPool.push(h),u},_autoSuspend:function(){var h=this;if(!(!h.autoSuspend||!h.ctx||typeof h.ctx.suspend>"u"||!t.usingWebAudio)){for(var u=0;u<h._howls.length;u++)if(h._howls[u]._webAudio){for(var f=0;f<h._howls[u]._sounds.length;f++)if(!h._howls[u]._sounds[f]._paused)return h}return h._suspendTimer&&clearTimeout(h._suspendTimer),h._suspendTimer=setTimeout(function(){if(h.autoSuspend){h._suspendTimer=null,h.state="suspending";var p=function(){h.state="suspended",h._resumeAfterSuspend&&(delete h._resumeAfterSuspend,h._autoResume())};h.ctx.suspend().then(p,p)}},3e4),h}},_autoResume:function(){var h=this;if(!(!h.ctx||typeof h.ctx.resume>"u"||!t.usingWebAudio))return h.state==="running"&&h.ctx.state!=="interrupted"&&h._suspendTimer?(clearTimeout(h._suspendTimer),h._suspendTimer=null):h.state==="suspended"||h.state==="running"&&h.ctx.state==="interrupted"?(h.ctx.resume().then(function(){h.state="running";for(var u=0;u<h._howls.length;u++)h._howls[u]._emit("resume")}),h._suspendTimer&&(clearTimeout(h._suspendTimer),h._suspendTimer=null)):h.state==="suspending"&&(h._resumeAfterSuspend=!0),h}};var t=new e,s=function(h){var u=this;if(!h.src||h.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}u.init(h)};s.prototype={init:function(h){var u=this;return t.ctx||d(),u._autoplay=h.autoplay||!1,u._format=typeof h.format!="string"?h.format:[h.format],u._html5=h.html5||!1,u._muted=h.mute||!1,u._loop=h.loop||!1,u._pool=h.pool||5,u._preload=typeof h.preload=="boolean"||h.preload==="metadata"?h.preload:!0,u._rate=h.rate||1,u._sprite=h.sprite||{},u._src=typeof h.src!="string"?h.src:[h.src],u._volume=h.volume!==void 0?h.volume:1,u._xhr={method:h.xhr&&h.xhr.method?h.xhr.method:"GET",headers:h.xhr&&h.xhr.headers?h.xhr.headers:null,withCredentials:h.xhr&&h.xhr.withCredentials?h.xhr.withCredentials:!1},u._duration=0,u._state="unloaded",u._sounds=[],u._endTimers={},u._queue=[],u._playLock=!1,u._onend=h.onend?[{fn:h.onend}]:[],u._onfade=h.onfade?[{fn:h.onfade}]:[],u._onload=h.onload?[{fn:h.onload}]:[],u._onloaderror=h.onloaderror?[{fn:h.onloaderror}]:[],u._onplayerror=h.onplayerror?[{fn:h.onplayerror}]:[],u._onpause=h.onpause?[{fn:h.onpause}]:[],u._onplay=h.onplay?[{fn:h.onplay}]:[],u._onstop=h.onstop?[{fn:h.onstop}]:[],u._onmute=h.onmute?[{fn:h.onmute}]:[],u._onvolume=h.onvolume?[{fn:h.onvolume}]:[],u._onrate=h.onrate?[{fn:h.onrate}]:[],u._onseek=h.onseek?[{fn:h.onseek}]:[],u._onunlock=h.onunlock?[{fn:h.onunlock}]:[],u._onresume=[],u._webAudio=t.usingWebAudio&&!u._html5,typeof t.ctx<"u"&&t.ctx&&t.autoUnlock&&t._unlockAudio(),t._howls.push(u),u._autoplay&&u._queue.push({event:"play",action:function(){u.play()}}),u._preload&&u._preload!=="none"&&u.load(),u},load:function(){var h=this,u=null;if(t.noAudio){h._emit("loaderror",null,"No audio support.");return}typeof h._src=="string"&&(h._src=[h._src]);for(var f=0;f<h._src.length;f++){var p,_;if(h._format&&h._format[f])p=h._format[f];else{if(_=h._src[f],typeof _!="string"){h._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}p=/^data:audio\/([^;,]+);/i.exec(_),p||(p=/\.([^.]+)$/.exec(_.split("?",1)[0])),p&&(p=p[1].toLowerCase())}if(p||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),p&&t.codecs(p)){u=h._src[f];break}}if(!u){h._emit("loaderror",null,"No codec support for selected audio sources.");return}return h._src=u,h._state="loading",window.location.protocol==="https:"&&u.slice(0,5)==="http:"&&(h._html5=!0,h._webAudio=!1),new i(h),h._webAudio&&a(h),h},play:function(h,u){var f=this,p=null;if(typeof h=="number")p=h,h=null;else{if(typeof h=="string"&&f._state==="loaded"&&!f._sprite[h])return null;if(typeof h>"u"&&(h="__default",!f._playLock)){for(var _=0,m=0;m<f._sounds.length;m++)f._sounds[m]._paused&&!f._sounds[m]._ended&&(_++,p=f._sounds[m]._id);_===1?h=null:p=null}}var g=p?f._soundById(p):f._inactiveSound();if(!g)return null;if(p&&!h&&(h=g._sprite||"__default"),f._state!=="loaded"){g._sprite=h,g._ended=!1;var v=g._id;return f._queue.push({event:"play",action:function(){f.play(v)}}),v}if(p&&!g._paused)return u||f._loadQueue("play"),g._id;f._webAudio&&t._autoResume();var x=Math.max(0,g._seek>0?g._seek:f._sprite[h][0]/1e3),S=Math.max(0,(f._sprite[h][0]+f._sprite[h][1])/1e3-x),w=S*1e3/Math.abs(g._rate),T=f._sprite[h][0]/1e3,b=(f._sprite[h][0]+f._sprite[h][1])/1e3;g._sprite=h,g._ended=!1;var C=function(){g._paused=!1,g._seek=x,g._start=T,g._stop=b,g._loop=!!(g._loop||f._sprite[h][2])};if(x>=b){f._ended(g);return}var E=g._node;if(f._webAudio){var R=function(){f._playLock=!1,C(),f._refreshBuffer(g);var I=g._muted||f._muted?0:g._volume;E.gain.setValueAtTime(I,t.ctx.currentTime),g._playStart=t.ctx.currentTime,typeof E.bufferSource.start>"u"?g._loop?E.bufferSource.noteGrainOn(0,x,86400):E.bufferSource.noteGrainOn(0,x,S):g._loop?E.bufferSource.start(0,x,86400):E.bufferSource.start(0,x,S),w!==1/0&&(f._endTimers[g._id]=setTimeout(f._ended.bind(f,g),w)),u||setTimeout(function(){f._emit("play",g._id),f._loadQueue()},0)};t.state==="running"&&t.ctx.state!=="interrupted"?R():(f._playLock=!0,f.once("resume",R),f._clearTimer(g._id))}else{var B=function(){E.currentTime=x,E.muted=g._muted||f._muted||t._muted||E.muted,E.volume=g._volume*t.volume(),E.playbackRate=g._rate;try{var I=E.play();if(I&&typeof Promise<"u"&&(I instanceof Promise||typeof I.then=="function")?(f._playLock=!0,C(),I.then(function(){f._playLock=!1,E._unlocked=!0,u?f._loadQueue():f._emit("play",g._id)}).catch(function(){f._playLock=!1,f._emit("playerror",g._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),g._ended=!0,g._paused=!0})):u||(f._playLock=!1,C(),f._emit("play",g._id)),E.playbackRate=g._rate,E.paused){f._emit("playerror",g._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}h!=="__default"||g._loop?f._endTimers[g._id]=setTimeout(f._ended.bind(f,g),w):(f._endTimers[g._id]=function(){f._ended(g),E.removeEventListener("ended",f._endTimers[g._id],!1)},E.addEventListener("ended",f._endTimers[g._id],!1))}catch(F){f._emit("playerror",g._id,F)}};E.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(E.src=f._src,E.load());var L=window&&window.ejecta||!E.readyState&&t._navigator.isCocoonJS;if(E.readyState>=3||L)B();else{f._playLock=!0,f._state="loading";var V=function(){f._state="loaded",B(),E.removeEventListener(t._canPlayEvent,V,!1)};E.addEventListener(t._canPlayEvent,V,!1),f._clearTimer(g._id)}}return g._id},pause:function(h){var u=this;if(u._state!=="loaded"||u._playLock)return u._queue.push({event:"pause",action:function(){u.pause(h)}}),u;for(var f=u._getSoundIds(h),p=0;p<f.length;p++){u._clearTimer(f[p]);var _=u._soundById(f[p]);if(_&&!_._paused&&(_._seek=u.seek(f[p]),_._rateSeek=0,_._paused=!0,u._stopFade(f[p]),_._node))if(u._webAudio){if(!_._node.bufferSource)continue;typeof _._node.bufferSource.stop>"u"?_._node.bufferSource.noteOff(0):_._node.bufferSource.stop(0),u._cleanBuffer(_._node)}else(!isNaN(_._node.duration)||_._node.duration===1/0)&&_._node.pause();arguments[1]||u._emit("pause",_?_._id:null)}return u},stop:function(h,u){var f=this;if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"stop",action:function(){f.stop(h)}}),f;for(var p=f._getSoundIds(h),_=0;_<p.length;_++){f._clearTimer(p[_]);var m=f._soundById(p[_]);m&&(m._seek=m._start||0,m._rateSeek=0,m._paused=!0,m._ended=!0,f._stopFade(p[_]),m._node&&(f._webAudio?m._node.bufferSource&&(typeof m._node.bufferSource.stop>"u"?m._node.bufferSource.noteOff(0):m._node.bufferSource.stop(0),f._cleanBuffer(m._node)):(!isNaN(m._node.duration)||m._node.duration===1/0)&&(m._node.currentTime=m._start||0,m._node.pause(),m._node.duration===1/0&&f._clearSound(m._node))),u||f._emit("stop",m._id))}return f},mute:function(h,u){var f=this;if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"mute",action:function(){f.mute(h,u)}}),f;if(typeof u>"u")if(typeof h=="boolean")f._muted=h;else return f._muted;for(var p=f._getSoundIds(u),_=0;_<p.length;_++){var m=f._soundById(p[_]);m&&(m._muted=h,m._interval&&f._stopFade(m._id),f._webAudio&&m._node?m._node.gain.setValueAtTime(h?0:m._volume,t.ctx.currentTime):m._node&&(m._node.muted=t._muted?!0:h),f._emit("mute",m._id))}return f},volume:function(){var h=this,u=arguments,f,p;if(u.length===0)return h._volume;if(u.length===1||u.length===2&&typeof u[1]>"u"){var _=h._getSoundIds(),m=_.indexOf(u[0]);m>=0?p=parseInt(u[0],10):f=parseFloat(u[0])}else u.length>=2&&(f=parseFloat(u[0]),p=parseInt(u[1],10));var g;if(typeof f<"u"&&f>=0&&f<=1){if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"volume",action:function(){h.volume.apply(h,u)}}),h;typeof p>"u"&&(h._volume=f),p=h._getSoundIds(p);for(var v=0;v<p.length;v++)g=h._soundById(p[v]),g&&(g._volume=f,u[2]||h._stopFade(p[v]),h._webAudio&&g._node&&!g._muted?g._node.gain.setValueAtTime(f,t.ctx.currentTime):g._node&&!g._muted&&(g._node.volume=f*t.volume()),h._emit("volume",g._id))}else return g=p?h._soundById(p):h._sounds[0],g?g._volume:0;return h},fade:function(h,u,f,p){var _=this;if(_._state!=="loaded"||_._playLock)return _._queue.push({event:"fade",action:function(){_.fade(h,u,f,p)}}),_;h=Math.min(Math.max(0,parseFloat(h)),1),u=Math.min(Math.max(0,parseFloat(u)),1),f=parseFloat(f),_.volume(h,p);for(var m=_._getSoundIds(p),g=0;g<m.length;g++){var v=_._soundById(m[g]);if(v){if(p||_._stopFade(m[g]),_._webAudio&&!v._muted){var x=t.ctx.currentTime,S=x+f/1e3;v._volume=h,v._node.gain.setValueAtTime(h,x),v._node.gain.linearRampToValueAtTime(u,S)}_._startFadeInterval(v,h,u,f,m[g],typeof p>"u")}}return _},_startFadeInterval:function(h,u,f,p,_,m){var g=this,v=u,x=f-u,S=Math.abs(x/.01),w=Math.max(4,S>0?p/S:p),T=Date.now();h._fadeTo=f,h._interval=setInterval(function(){var b=(Date.now()-T)/p;T=Date.now(),v+=x*b,v=Math.round(v*100)/100,x<0?v=Math.max(f,v):v=Math.min(f,v),g._webAudio?h._volume=v:g.volume(v,h._id,!0),m&&(g._volume=v),(f<u&&v<=f||f>u&&v>=f)&&(clearInterval(h._interval),h._interval=null,h._fadeTo=null,g.volume(f,h._id),g._emit("fade",h._id))},w)},_stopFade:function(h){var u=this,f=u._soundById(h);return f&&f._interval&&(u._webAudio&&f._node.gain.cancelScheduledValues(t.ctx.currentTime),clearInterval(f._interval),f._interval=null,u.volume(f._fadeTo,h),f._fadeTo=null,u._emit("fade",h)),u},loop:function(){var h=this,u=arguments,f,p,_;if(u.length===0)return h._loop;if(u.length===1)if(typeof u[0]=="boolean")f=u[0],h._loop=f;else return _=h._soundById(parseInt(u[0],10)),_?_._loop:!1;else u.length===2&&(f=u[0],p=parseInt(u[1],10));for(var m=h._getSoundIds(p),g=0;g<m.length;g++)_=h._soundById(m[g]),_&&(_._loop=f,h._webAudio&&_._node&&_._node.bufferSource&&(_._node.bufferSource.loop=f,f&&(_._node.bufferSource.loopStart=_._start||0,_._node.bufferSource.loopEnd=_._stop,h.playing(m[g])&&(h.pause(m[g],!0),h.play(m[g],!0)))));return h},rate:function(){var h=this,u=arguments,f,p;if(u.length===0)p=h._sounds[0]._id;else if(u.length===1){var _=h._getSoundIds(),m=_.indexOf(u[0]);m>=0?p=parseInt(u[0],10):f=parseFloat(u[0])}else u.length===2&&(f=parseFloat(u[0]),p=parseInt(u[1],10));var g;if(typeof f=="number"){if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"rate",action:function(){h.rate.apply(h,u)}}),h;typeof p>"u"&&(h._rate=f),p=h._getSoundIds(p);for(var v=0;v<p.length;v++)if(g=h._soundById(p[v]),g){h.playing(p[v])&&(g._rateSeek=h.seek(p[v]),g._playStart=h._webAudio?t.ctx.currentTime:g._playStart),g._rate=f,h._webAudio&&g._node&&g._node.bufferSource?g._node.bufferSource.playbackRate.setValueAtTime(f,t.ctx.currentTime):g._node&&(g._node.playbackRate=f);var x=h.seek(p[v]),S=(h._sprite[g._sprite][0]+h._sprite[g._sprite][1])/1e3-x,w=S*1e3/Math.abs(g._rate);(h._endTimers[p[v]]||!g._paused)&&(h._clearTimer(p[v]),h._endTimers[p[v]]=setTimeout(h._ended.bind(h,g),w)),h._emit("rate",g._id)}}else return g=h._soundById(p),g?g._rate:h._rate;return h},seek:function(){var h=this,u=arguments,f,p;if(u.length===0)h._sounds.length&&(p=h._sounds[0]._id);else if(u.length===1){var _=h._getSoundIds(),m=_.indexOf(u[0]);m>=0?p=parseInt(u[0],10):h._sounds.length&&(p=h._sounds[0]._id,f=parseFloat(u[0]))}else u.length===2&&(f=parseFloat(u[0]),p=parseInt(u[1],10));if(typeof p>"u")return 0;if(typeof f=="number"&&(h._state!=="loaded"||h._playLock))return h._queue.push({event:"seek",action:function(){h.seek.apply(h,u)}}),h;var g=h._soundById(p);if(g)if(typeof f=="number"&&f>=0){var v=h.playing(p);v&&h.pause(p,!0),g._seek=f,g._ended=!1,h._clearTimer(p),!h._webAudio&&g._node&&!isNaN(g._node.duration)&&(g._node.currentTime=f);var x=function(){v&&h.play(p,!0),h._emit("seek",p)};if(v&&!h._webAudio){var S=function(){h._playLock?setTimeout(S,0):x()};setTimeout(S,0)}else x()}else if(h._webAudio){var w=h.playing(p)?t.ctx.currentTime-g._playStart:0,T=g._rateSeek?g._rateSeek-g._seek:0;return g._seek+(T+w*Math.abs(g._rate))}else return g._node.currentTime;return h},playing:function(h){var u=this;if(typeof h=="number"){var f=u._soundById(h);return f?!f._paused:!1}for(var p=0;p<u._sounds.length;p++)if(!u._sounds[p]._paused)return!0;return!1},duration:function(h){var u=this,f=u._duration,p=u._soundById(h);return p&&(f=u._sprite[p._sprite][1]/1e3),f},state:function(){return this._state},unload:function(){for(var h=this,u=h._sounds,f=0;f<u.length;f++)u[f]._paused||h.stop(u[f]._id),h._webAudio||(h._clearSound(u[f]._node),u[f]._node.removeEventListener("error",u[f]._errorFn,!1),u[f]._node.removeEventListener(t._canPlayEvent,u[f]._loadFn,!1),u[f]._node.removeEventListener("ended",u[f]._endFn,!1),t._releaseHtml5Audio(u[f]._node)),delete u[f]._node,h._clearTimer(u[f]._id);var p=t._howls.indexOf(h);p>=0&&t._howls.splice(p,1);var _=!0;for(f=0;f<t._howls.length;f++)if(t._howls[f]._src===h._src||h._src.indexOf(t._howls[f]._src)>=0){_=!1;break}return n&&_&&delete n[h._src],t.noAudio=!1,h._state="unloaded",h._sounds=[],h=null,null},on:function(h,u,f,p){var _=this,m=_["_on"+h];return typeof u=="function"&&m.push(p?{id:f,fn:u,once:p}:{id:f,fn:u}),_},off:function(h,u,f){var p=this,_=p["_on"+h],m=0;if(typeof u=="number"&&(f=u,u=null),u||f)for(m=0;m<_.length;m++){var g=f===_[m].id;if(u===_[m].fn&&g||!u&&g){_.splice(m,1);break}}else if(h)p["_on"+h]=[];else{var v=Object.keys(p);for(m=0;m<v.length;m++)v[m].indexOf("_on")===0&&Array.isArray(p[v[m]])&&(p[v[m]]=[])}return p},once:function(h,u,f){var p=this;return p.on(h,u,f,1),p},_emit:function(h,u,f){for(var p=this,_=p["_on"+h],m=_.length-1;m>=0;m--)(!_[m].id||_[m].id===u||h==="load")&&(setTimeout((function(g){g.call(this,u,f)}).bind(p,_[m].fn),0),_[m].once&&p.off(h,_[m].fn,_[m].id));return p._loadQueue(h),p},_loadQueue:function(h){var u=this;if(u._queue.length>0){var f=u._queue[0];f.event===h&&(u._queue.shift(),u._loadQueue()),h||f.action()}return u},_ended:function(h){var u=this,f=h._sprite;if(!u._webAudio&&h._node&&!h._node.paused&&!h._node.ended&&h._node.currentTime<h._stop)return setTimeout(u._ended.bind(u,h),100),u;var p=!!(h._loop||u._sprite[f][2]);if(u._emit("end",h._id),!u._webAudio&&p&&u.stop(h._id,!0).play(h._id),u._webAudio&&p){u._emit("play",h._id),h._seek=h._start||0,h._rateSeek=0,h._playStart=t.ctx.currentTime;var _=(h._stop-h._start)*1e3/Math.abs(h._rate);u._endTimers[h._id]=setTimeout(u._ended.bind(u,h),_)}return u._webAudio&&!p&&(h._paused=!0,h._ended=!0,h._seek=h._start||0,h._rateSeek=0,u._clearTimer(h._id),u._cleanBuffer(h._node),t._autoSuspend()),!u._webAudio&&!p&&u.stop(h._id,!0),u},_clearTimer:function(h){var u=this;if(u._endTimers[h]){if(typeof u._endTimers[h]!="function")clearTimeout(u._endTimers[h]);else{var f=u._soundById(h);f&&f._node&&f._node.removeEventListener("ended",u._endTimers[h],!1)}delete u._endTimers[h]}return u},_soundById:function(h){for(var u=this,f=0;f<u._sounds.length;f++)if(h===u._sounds[f]._id)return u._sounds[f];return null},_inactiveSound:function(){var h=this;h._drain();for(var u=0;u<h._sounds.length;u++)if(h._sounds[u]._ended)return h._sounds[u].reset();return new i(h)},_drain:function(){var h=this,u=h._pool,f=0,p=0;if(!(h._sounds.length<u)){for(p=0;p<h._sounds.length;p++)h._sounds[p]._ended&&f++;for(p=h._sounds.length-1;p>=0;p--){if(f<=u)return;h._sounds[p]._ended&&(h._webAudio&&h._sounds[p]._node&&h._sounds[p]._node.disconnect(0),h._sounds.splice(p,1),f--)}}},_getSoundIds:function(h){var u=this;if(typeof h>"u"){for(var f=[],p=0;p<u._sounds.length;p++)f.push(u._sounds[p]._id);return f}else return[h]},_refreshBuffer:function(h){var u=this;return h._node.bufferSource=t.ctx.createBufferSource(),h._node.bufferSource.buffer=n[u._src],h._panner?h._node.bufferSource.connect(h._panner):h._node.bufferSource.connect(h._node),h._node.bufferSource.loop=h._loop,h._loop&&(h._node.bufferSource.loopStart=h._start||0,h._node.bufferSource.loopEnd=h._stop||0),h._node.bufferSource.playbackRate.setValueAtTime(h._rate,t.ctx.currentTime),u},_cleanBuffer:function(h){var u=this,f=t._navigator&&t._navigator.vendor.indexOf("Apple")>=0;if(!h.bufferSource)return u;if(t._scratchBuffer&&h.bufferSource&&(h.bufferSource.onended=null,h.bufferSource.disconnect(0),f))try{h.bufferSource.buffer=t._scratchBuffer}catch{}return h.bufferSource=null,u},_clearSound:function(h){var u=/MSIE |Trident\//.test(t._navigator&&t._navigator.userAgent);u||(h.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var i=function(h){this._parent=h,this.init()};i.prototype={init:function(){var h=this,u=h._parent;return h._muted=u._muted,h._loop=u._loop,h._volume=u._volume,h._rate=u._rate,h._seek=0,h._paused=!0,h._ended=!0,h._sprite="__default",h._id=++t._counter,u._sounds.push(h),h.create(),h},create:function(){var h=this,u=h._parent,f=t._muted||h._muted||h._parent._muted?0:h._volume;return u._webAudio?(h._node=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),h._node.gain.setValueAtTime(f,t.ctx.currentTime),h._node.paused=!0,h._node.connect(t.masterGain)):t.noAudio||(h._node=t._obtainHtml5Audio(),h._errorFn=h._errorListener.bind(h),h._node.addEventListener("error",h._errorFn,!1),h._loadFn=h._loadListener.bind(h),h._node.addEventListener(t._canPlayEvent,h._loadFn,!1),h._endFn=h._endListener.bind(h),h._node.addEventListener("ended",h._endFn,!1),h._node.src=u._src,h._node.preload=u._preload===!0?"auto":u._preload,h._node.volume=f*t.volume(),h._node.load()),h},reset:function(){var h=this,u=h._parent;return h._muted=u._muted,h._loop=u._loop,h._volume=u._volume,h._rate=u._rate,h._seek=0,h._rateSeek=0,h._paused=!0,h._ended=!0,h._sprite="__default",h._id=++t._counter,h},_errorListener:function(){var h=this;h._parent._emit("loaderror",h._id,h._node.error?h._node.error.code:0),h._node.removeEventListener("error",h._errorFn,!1)},_loadListener:function(){var h=this,u=h._parent;u._duration=Math.ceil(h._node.duration*10)/10,Object.keys(u._sprite).length===0&&(u._sprite={__default:[0,u._duration*1e3]}),u._state!=="loaded"&&(u._state="loaded",u._emit("load"),u._loadQueue()),h._node.removeEventListener(t._canPlayEvent,h._loadFn,!1)},_endListener:function(){var h=this,u=h._parent;u._duration===1/0&&(u._duration=Math.ceil(h._node.duration*10)/10,u._sprite.__default[1]===1/0&&(u._sprite.__default[1]=u._duration*1e3),u._ended(h)),h._node.removeEventListener("ended",h._endFn,!1)}};var n={},a=function(h){var u=h._src;if(n[u]){h._duration=n[u].duration,c(h);return}if(/^data:[^;]+;base64,/.test(u)){for(var f=atob(u.split(",")[1]),p=new Uint8Array(f.length),_=0;_<f.length;++_)p[_]=f.charCodeAt(_);l(p.buffer,h)}else{var m=new XMLHttpRequest;m.open(h._xhr.method,u,!0),m.withCredentials=h._xhr.withCredentials,m.responseType="arraybuffer",h._xhr.headers&&Object.keys(h._xhr.headers).forEach(function(g){m.setRequestHeader(g,h._xhr.headers[g])}),m.onload=function(){var g=(m.status+"")[0];if(g!=="0"&&g!=="2"&&g!=="3"){h._emit("loaderror",null,"Failed loading audio file with status: "+m.status+".");return}l(m.response,h)},m.onerror=function(){h._webAudio&&(h._html5=!0,h._webAudio=!1,h._sounds=[],delete n[u],h.load())},o(m)}},o=function(h){try{h.send()}catch{h.onerror()}},l=function(h,u){var f=function(){u._emit("loaderror",null,"Decoding audio data failed.")},p=function(_){_&&u._sounds.length>0?(n[u._src]=_,c(u,_)):f()};typeof Promise<"u"&&t.ctx.decodeAudioData.length===1?t.ctx.decodeAudioData(h).then(p).catch(f):t.ctx.decodeAudioData(h,p,f)},c=function(h,u){u&&!h._duration&&(h._duration=u.duration),Object.keys(h._sprite).length===0&&(h._sprite={__default:[0,h._duration*1e3]}),h._state!=="loaded"&&(h._state="loaded",h._emit("load"),h._loadQueue())},d=function(){if(t.usingWebAudio){try{typeof AudioContext<"u"?t.ctx=new AudioContext:typeof webkitAudioContext<"u"?t.ctx=new webkitAudioContext:t.usingWebAudio=!1}catch{t.usingWebAudio=!1}t.ctx||(t.usingWebAudio=!1);var h=/iP(hone|od|ad)/.test(t._navigator&&t._navigator.platform),u=t._navigator&&t._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),f=u?parseInt(u[1],10):null;if(h&&f&&f<9){var p=/safari/.test(t._navigator&&t._navigator.userAgent.toLowerCase());t._navigator&&!p&&(t.usingWebAudio=!1)}t.usingWebAudio&&(t.masterGain=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),t.masterGain.gain.setValueAtTime(t._muted?0:t._volume,t.ctx.currentTime),t.masterGain.connect(t.ctx.destination)),t._setup()}};r.Howler=t,r.Howl=s,typeof Bh<"u"?(Bh.HowlerGlobal=e,Bh.Howler=t,Bh.Howl=s,Bh.Sound=i):typeof window<"u"&&(window.HowlerGlobal=e,window.Howler=t,window.Howl=s,window.Sound=i)})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(t){var s=this;if(!s.ctx||!s.ctx.listener)return s;for(var i=s._howls.length-1;i>=0;i--)s._howls[i].stereo(t);return s},HowlerGlobal.prototype.pos=function(t,s,i){var n=this;if(!n.ctx||!n.ctx.listener)return n;if(s=typeof s!="number"?n._pos[1]:s,i=typeof i!="number"?n._pos[2]:i,typeof t=="number")n._pos=[t,s,i],typeof n.ctx.listener.positionX<"u"?(n.ctx.listener.positionX.setTargetAtTime(n._pos[0],Howler.ctx.currentTime,.1),n.ctx.listener.positionY.setTargetAtTime(n._pos[1],Howler.ctx.currentTime,.1),n.ctx.listener.positionZ.setTargetAtTime(n._pos[2],Howler.ctx.currentTime,.1)):n.ctx.listener.setPosition(n._pos[0],n._pos[1],n._pos[2]);else return n._pos;return n},HowlerGlobal.prototype.orientation=function(t,s,i,n,a,o){var l=this;if(!l.ctx||!l.ctx.listener)return l;var c=l._orientation;if(s=typeof s!="number"?c[1]:s,i=typeof i!="number"?c[2]:i,n=typeof n!="number"?c[3]:n,a=typeof a!="number"?c[4]:a,o=typeof o!="number"?c[5]:o,typeof t=="number")l._orientation=[t,s,i,n,a,o],typeof l.ctx.listener.forwardX<"u"?(l.ctx.listener.forwardX.setTargetAtTime(t,Howler.ctx.currentTime,.1),l.ctx.listener.forwardY.setTargetAtTime(s,Howler.ctx.currentTime,.1),l.ctx.listener.forwardZ.setTargetAtTime(i,Howler.ctx.currentTime,.1),l.ctx.listener.upX.setTargetAtTime(n,Howler.ctx.currentTime,.1),l.ctx.listener.upY.setTargetAtTime(a,Howler.ctx.currentTime,.1),l.ctx.listener.upZ.setTargetAtTime(o,Howler.ctx.currentTime,.1)):l.ctx.listener.setOrientation(t,s,i,n,a,o);else return c;return l},Howl.prototype.init=function(t){return function(s){var i=this;return i._orientation=s.orientation||[1,0,0],i._stereo=s.stereo||null,i._pos=s.pos||null,i._pannerAttr={coneInnerAngle:typeof s.coneInnerAngle<"u"?s.coneInnerAngle:360,coneOuterAngle:typeof s.coneOuterAngle<"u"?s.coneOuterAngle:360,coneOuterGain:typeof s.coneOuterGain<"u"?s.coneOuterGain:0,distanceModel:typeof s.distanceModel<"u"?s.distanceModel:"inverse",maxDistance:typeof s.maxDistance<"u"?s.maxDistance:1e4,panningModel:typeof s.panningModel<"u"?s.panningModel:"HRTF",refDistance:typeof s.refDistance<"u"?s.refDistance:1,rolloffFactor:typeof s.rolloffFactor<"u"?s.rolloffFactor:1},i._onstereo=s.onstereo?[{fn:s.onstereo}]:[],i._onpos=s.onpos?[{fn:s.onpos}]:[],i._onorientation=s.onorientation?[{fn:s.onorientation}]:[],t.call(this,s)}}(Howl.prototype.init),Howl.prototype.stereo=function(t,s){var i=this;if(!i._webAudio)return i;if(i._state!=="loaded")return i._queue.push({event:"stereo",action:function(){i.stereo(t,s)}}),i;var n=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof s>"u")if(typeof t=="number")i._stereo=t,i._pos=[t,0,0];else return i._stereo;for(var a=i._getSoundIds(s),o=0;o<a.length;o++){var l=i._soundById(a[o]);if(l)if(typeof t=="number")l._stereo=t,l._pos=[t,0,0],l._node&&(l._pannerAttr.panningModel="equalpower",(!l._panner||!l._panner.pan)&&e(l,n),n==="spatial"?typeof l._panner.positionX<"u"?(l._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),l._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),l._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):l._panner.setPosition(t,0,0):l._panner.pan.setValueAtTime(t,Howler.ctx.currentTime)),i._emit("stereo",l._id);else return l._stereo}return i},Howl.prototype.pos=function(t,s,i,n){var a=this;if(!a._webAudio)return a;if(a._state!=="loaded")return a._queue.push({event:"pos",action:function(){a.pos(t,s,i,n)}}),a;if(s=typeof s!="number"?0:s,i=typeof i!="number"?-.5:i,typeof n>"u")if(typeof t=="number")a._pos=[t,s,i];else return a._pos;for(var o=a._getSoundIds(n),l=0;l<o.length;l++){var c=a._soundById(o[l]);if(c)if(typeof t=="number")c._pos=[t,s,i],c._node&&((!c._panner||c._panner.pan)&&e(c,"spatial"),typeof c._panner.positionX<"u"?(c._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),c._panner.positionY.setValueAtTime(s,Howler.ctx.currentTime),c._panner.positionZ.setValueAtTime(i,Howler.ctx.currentTime)):c._panner.setPosition(t,s,i)),a._emit("pos",c._id);else return c._pos}return a},Howl.prototype.orientation=function(t,s,i,n){var a=this;if(!a._webAudio)return a;if(a._state!=="loaded")return a._queue.push({event:"orientation",action:function(){a.orientation(t,s,i,n)}}),a;if(s=typeof s!="number"?a._orientation[1]:s,i=typeof i!="number"?a._orientation[2]:i,typeof n>"u")if(typeof t=="number")a._orientation=[t,s,i];else return a._orientation;for(var o=a._getSoundIds(n),l=0;l<o.length;l++){var c=a._soundById(o[l]);if(c)if(typeof t=="number")c._orientation=[t,s,i],c._node&&(c._panner||(c._pos||(c._pos=a._pos||[0,0,-.5]),e(c,"spatial")),typeof c._panner.orientationX<"u"?(c._panner.orientationX.setValueAtTime(t,Howler.ctx.currentTime),c._panner.orientationY.setValueAtTime(s,Howler.ctx.currentTime),c._panner.orientationZ.setValueAtTime(i,Howler.ctx.currentTime)):c._panner.setOrientation(t,s,i)),a._emit("orientation",c._id);else return c._orientation}return a},Howl.prototype.pannerAttr=function(){var t=this,s=arguments,i,n,a;if(!t._webAudio)return t;if(s.length===0)return t._pannerAttr;if(s.length===1)if(typeof s[0]=="object")i=s[0],typeof n>"u"&&(i.pannerAttr||(i.pannerAttr={coneInnerAngle:i.coneInnerAngle,coneOuterAngle:i.coneOuterAngle,coneOuterGain:i.coneOuterGain,distanceModel:i.distanceModel,maxDistance:i.maxDistance,refDistance:i.refDistance,rolloffFactor:i.rolloffFactor,panningModel:i.panningModel}),t._pannerAttr={coneInnerAngle:typeof i.pannerAttr.coneInnerAngle<"u"?i.pannerAttr.coneInnerAngle:t._coneInnerAngle,coneOuterAngle:typeof i.pannerAttr.coneOuterAngle<"u"?i.pannerAttr.coneOuterAngle:t._coneOuterAngle,coneOuterGain:typeof i.pannerAttr.coneOuterGain<"u"?i.pannerAttr.coneOuterGain:t._coneOuterGain,distanceModel:typeof i.pannerAttr.distanceModel<"u"?i.pannerAttr.distanceModel:t._distanceModel,maxDistance:typeof i.pannerAttr.maxDistance<"u"?i.pannerAttr.maxDistance:t._maxDistance,refDistance:typeof i.pannerAttr.refDistance<"u"?i.pannerAttr.refDistance:t._refDistance,rolloffFactor:typeof i.pannerAttr.rolloffFactor<"u"?i.pannerAttr.rolloffFactor:t._rolloffFactor,panningModel:typeof i.pannerAttr.panningModel<"u"?i.pannerAttr.panningModel:t._panningModel});else return a=t._soundById(parseInt(s[0],10)),a?a._pannerAttr:t._pannerAttr;else s.length===2&&(i=s[0],n=parseInt(s[1],10));for(var o=t._getSoundIds(n),l=0;l<o.length;l++)if(a=t._soundById(o[l]),a){var c=a._pannerAttr;c={coneInnerAngle:typeof i.coneInnerAngle<"u"?i.coneInnerAngle:c.coneInnerAngle,coneOuterAngle:typeof i.coneOuterAngle<"u"?i.coneOuterAngle:c.coneOuterAngle,coneOuterGain:typeof i.coneOuterGain<"u"?i.coneOuterGain:c.coneOuterGain,distanceModel:typeof i.distanceModel<"u"?i.distanceModel:c.distanceModel,maxDistance:typeof i.maxDistance<"u"?i.maxDistance:c.maxDistance,refDistance:typeof i.refDistance<"u"?i.refDistance:c.refDistance,rolloffFactor:typeof i.rolloffFactor<"u"?i.rolloffFactor:c.rolloffFactor,panningModel:typeof i.panningModel<"u"?i.panningModel:c.panningModel};var d=a._panner;d||(a._pos||(a._pos=t._pos||[0,0,-.5]),e(a,"spatial"),d=a._panner),d.coneInnerAngle=c.coneInnerAngle,d.coneOuterAngle=c.coneOuterAngle,d.coneOuterGain=c.coneOuterGain,d.distanceModel=c.distanceModel,d.maxDistance=c.maxDistance,d.refDistance=c.refDistance,d.rolloffFactor=c.rolloffFactor,d.panningModel=c.panningModel}return t},Sound.prototype.init=function(t){return function(){var s=this,i=s._parent;s._orientation=i._orientation,s._stereo=i._stereo,s._pos=i._pos,s._pannerAttr=i._pannerAttr,t.call(this),s._stereo?i.stereo(s._stereo):s._pos&&i.pos(s._pos[0],s._pos[1],s._pos[2],s._id)}}(Sound.prototype.init),Sound.prototype.reset=function(t){return function(){var s=this,i=s._parent;return s._orientation=i._orientation,s._stereo=i._stereo,s._pos=i._pos,s._pannerAttr=i._pannerAttr,s._stereo?i.stereo(s._stereo):s._pos?i.pos(s._pos[0],s._pos[1],s._pos[2],s._id):s._panner&&(s._panner.disconnect(0),s._panner=void 0,i._refreshBuffer(s)),t.call(this)}}(Sound.prototype.reset);var e=function(t,s){s=s||"spatial",s==="spatial"?(t._panner=Howler.ctx.createPanner(),t._panner.coneInnerAngle=t._pannerAttr.coneInnerAngle,t._panner.coneOuterAngle=t._pannerAttr.coneOuterAngle,t._panner.coneOuterGain=t._pannerAttr.coneOuterGain,t._panner.distanceModel=t._pannerAttr.distanceModel,t._panner.maxDistance=t._pannerAttr.maxDistance,t._panner.refDistance=t._pannerAttr.refDistance,t._panner.rolloffFactor=t._pannerAttr.rolloffFactor,t._panner.panningModel=t._pannerAttr.panningModel,typeof t._panner.positionX<"u"?(t._panner.positionX.setValueAtTime(t._pos[0],Howler.ctx.currentTime),t._panner.positionY.setValueAtTime(t._pos[1],Howler.ctx.currentTime),t._panner.positionZ.setValueAtTime(t._pos[2],Howler.ctx.currentTime)):t._panner.setPosition(t._pos[0],t._pos[1],t._pos[2]),typeof t._panner.orientationX<"u"?(t._panner.orientationX.setValueAtTime(t._orientation[0],Howler.ctx.currentTime),t._panner.orientationY.setValueAtTime(t._orientation[1],Howler.ctx.currentTime),t._panner.orientationZ.setValueAtTime(t._orientation[2],Howler.ctx.currentTime)):t._panner.setOrientation(t._orientation[0],t._orientation[1],t._orientation[2])):(t._panner=Howler.ctx.createStereoPanner(),t._panner.pan.setValueAtTime(t._stereo,Howler.ctx.currentTime)),t._panner.connect(t._node),t._paused||t._parent.pause(t._id,!0).play(t._id,!0)}})()})(fr);const O={GAME_WIDTH:1920,GAME_HEIGHT:1080,GAME_CODE:"PurusGames:DinoRunner",DEBUG_ORBIT_CAMERA:0,DEBUG_FPS:1,SCENE_PLAY:"PlayScene",SCENE_TRANSITION:"TransitionScene",ADS_SCREEN_NAME:"AdsScreen",CONTINUE_SCREEN_NAME:"ContinueScreen",CURRENCY_SCREEN_NAME:"CurrencyScreen",TUTORIAL_SCREEN_NAME:"TutorialScreen",PAUSE_SCREEN_NAME:"PauseScreen",LOADING_SCREEN_NAME:"LoadingScreen",SETTING_SCREEN_NAME:"SettingScreen",PLAY_SCREEN_NAME:"PlayScreen",HOME_SCREEN_NAME:"HomeScreen",SHOP_SCREEN_NAME:"ShopScreen",WIN_SCREEN_NAME:"WinScreen",LOSE_SCREEN_NAME:"LoseScreen",WARNING_SCREEN_NAME:"WarningScreen",DAILY_CHALLENGE_SCREEN_NAME:"DailyChallengeScreen",SETTING_IN_GAME_SCREEN_NAME:"SettingInGameScreen",CHALLENGE_LEVEL_SELECTOR_SCREEN_NAME:"ChallengeLevelSelectorScreen",TAP_ZONE_SCREEN_NAME:"TapZoneScreen",LOSE_SCREEN_CHALLENGE_NAME:"LoseScreenChallenge",GROUND_NAME:"JumpCollision",FINISH_POINT_NAME:"FinishCollision",AUTO_JUMP_POINT_NAME:"AutoJumpCollision",TAP_JUMP_POINT_NAME:"TapJumpCollision",COIN_NAME:"coin",CHECK_POINT_NAME:"CheckPointCollision",JUMP_INSTRUCTION_NAME:"JumpInstructionCollision",BEND_DOWN_INSTRUCTION_NAME:"BendDownInstructionCollision",OBSTACLE_COLLISION_NAME:"ObstacleCollision",UI_LAYER_MAIN:"UIMainLayer",UI_LAYER_POPUP:"PopupLayer",UI_LAYER_ADS:"AdsLayer",LAYER_TAP_ZONE:"TapZoneLayer",STORAGE_CLEAR_ON_START:0,STORAGE_KEY_SETTING:"setting",STORAGE_SOUND_EFFECT:"soundEffect",STORAGE_KEY_CURRENT_CHALLENGE_LEVEL:"currentChallengeLevel",STORAGE_KEY_HIGHEST_CHALLENGE_LEVEL:"highestChallengeLevel",STORAGE_KEY_CURRENT_MODE:"currentMode",STORAGE_KEY_CURRENT_SKIN:"currentSkin",STORAGE_KEY_SKIN_UNLOCKED:"skinUnlocked",STORAGE_KEY_DEFAULT_SKIN:"dino",STORAGE_KEY_DAILY_CHALLENGE_DATA:"dailyChallengeData",STORAGE_KEY_CURRENT_DATE:"currentDate",STORAGE_KEY_HIGHEST_SCORE:"highestScore",STORAGE_KEY_IS_TUTORIAL_COMPLETED:"isTutorialCompleted",STORAGE_KEY_FIRST_OPEN:"firstOpen",STORAGE_KEY_CURRENCY:"currency",DEFAULT_CURRENCY:0,STORAGE_COMPLETED_TUTORIALS:"completedTutorials",STORAGE_KEY_LANGUAGE:"language",GAME_FONT_NOTOSANS_BLACK:"NotoSans-Black",GAME_FONT_NOTOSANS_ARABIC_BLACK:"NotoSansArabic-Black",GAME_FONT_NOTOSERIF_THAI:"NotoSerifThai-Black",GAME_FONT_NOTOSANS_JP_BLACK:"NotoSansJP-Black",GAME_FONT_NOTOSANS_SC_BLACK:"NotoSansSC-Black",GAME_FONT_NOTOSANS_KR_BLACK:"NotoSansKR-Black",TEXT_TUTORIAL_PC_DEVICE:"PRESS SPACE TO START",TEXT_TUTORIAL_MOBILE_DEVICE:"TAP TO START",DURATION_DIALOG:.2,GAME_RESIZE_RATIO:.98,CAMERA_OFFSET_X:2,CAMERA_OFFSET_Y:20,CAMERA_OFFSET_Y_PTR:30,CAMERA_OFFSET_Z:10,MASK_MAP_OBJECT:256,MASK_PLAYER_BODY:512,MASK_PLAYER_BODY_GROUND:1024,MASK_OBSTACLE:2048,MASK_PLAYER:4096,MASK_GROUND:8192,DEBUG_PLAYER_IMMORTAL:!1,DEBUG_SHOW_PLAY_TIME_TRACKER:!1,QUANTITY_PER_SINGLE_COIN:20,DEVICE_DESKTOP_NAME:"desktop",DEVICE_MOBILE_NAME:"mobile",REVIVE_OFFSET:.23,REVIVE_COUNTDOWN_TIME:5,TOTAL_GAME_LIFE_PER_BY_ADS:3,DEFAULT_GAME_LIFE_EACH_LEVEL:3,MAP_MIN_X:-5,MAP_MAX_X:2,DELAY_TIME_BEFORE_SHOW_INTERSTITIAL_ADS:.75,MOUSE_MOVE_OUT_OF_CANVAS_EVENT:"mousemoveoutofcanvas",TUTORIAL_SHOP_NAME:"shop_tutorial",TUTORIAL_CHOOSE_LEVEL_NAME:"choose_level_tutorial",TUTORIAL_DAILY_CHALLENGE_NAME:"daily_challenge",ARROW_UP_KEY:"ArrowUp",ARROW_DOWN_KEY:"ArrowDown",SPACE_KEY:"Space"},jf=class jf extends ie{constructor(){super(),this.gameCode=O.GAME_CODE}clear(){localStorage.clear()}getItem(e){return e=this.getStorageKey(e),localStorage.getItem(e)}getBoolean(e,t=!1){let s=this.getItem(e);return s?s==="true":t}setItem(e,t){e=this.getStorageKey(e),localStorage.setItem(e,t),this.fire("GameStorage:ValueChanged",e)}addInt(e,t){const s=this.getInt(e);return this.setItem(e,s+t),s+t}addFloat(e,t){const s=this.getFloat(e);this.setItem(e,s+t)}getInt(e,t=0){const s=this.getItem(e);if(!s)return t;let i=parseInt(s);return i||(i=t),i}getFloat(e){const t=this.getItem(e);if(!t)return 0;let s=parseFloat(t);return s||(s=0),s}getObject(e,t){const s=this.getItem(e);return s?JSON.parse(s):t||{}}getString(e,t=""){let s=this.getItem(e);return s||(s=t),s}getStorageKey(e){return`${O.GAME_CODE}_${e}`}};jf.instance=new jf;let ye=jf;const Zs=class Zs{static loadSetting(){const e=ye.instance.getObject(O.STORAGE_KEY_SETTING,Zs._settings);e&&(Zs._settings=e),Zs.saveSetting(),Se.muteAllMusic(!Zs._settings.music),Se.muteAllSound(!Zs._settings.sound)}static saveSetting(){ye.instance.setItem(O.STORAGE_KEY_SETTING,JSON.stringify(Zs._settings))}static get(e){return Zs._settings[e]}static set(e,t){switch(Zs._settings[e]=t,Zs.saveSetting(),e){case"music":Se.muteAllMusic(!t);break;case"sound":Se.muteAllSound(!t);break}}};Zs._settings={music:!0,sound:!0,vibration:!0};let ni=Zs;class Se{static async load(e){this.audios={},this.songs={};let t=[];for(const s in e)t.push(this.loadAudio(s,e[s]));await Promise.all(t)}static hasAudio(e){return this.audios[e]!==void 0}static loadAudio(e,t){return new Promise(s=>{this.audios[e]=new fr.Howl({src:t,onloaderror:(i,n)=>console.error("SoundManager","Load error",i,n),onplayerror:(i,n)=>console.error("SoundManager","Play error",i,n),onload:()=>s()})})}static play(e,t=1,s=!1){fr.Howler.ctx.state!=="running"&&fr.Howler.ctx.resume();const i=this.audios[e],n=i.play();return i.volume(t),i.loop(s),ni.get("sound")===!1&&this.muteSound(e,!0),n}static playMusic(e,t=1,s=!0){if(fr.Howler.ctx.state!=="running")return this.suspendedMusics||(this.suspendedMusics=[]),this.suspendedMusics.find(a=>a.name===e)||this.suspendedMusics.push({name:e,volume:t,loop:s}),-1;const i=this.audios[e],n=i.play();return i.volume(t),i.loop(s),this.songs[e]=i,ni.get("music")===!1&&i.mute(!0),n}static isPlaying(e){return this.audios[e].playing()}static stop(e,t){this.audios[e].stop(t)}static muteAll(e){fr.Howler.mute(e)}static muteAllSound(e){for(const t in this.audios)this.songs[t]||this.muteSound(t,e)}static muteSound(e,t){var s;(s=this.audios[e])==null||s.mute(t)}static muteAllMusic(e){for(const t in this.songs)this.muteMusic(t,e)}static muteMusic(e,t){this.audios[e].mute(t)}static resumeAudioContext(){fr.Howler.ctx.state!=="running"&&fr.Howler.ctx.resume()}}const cl=class cl{static async init(e){this.app=e,this.assets=e.assets;let t=new ne("assetData","json",{url:"assets/assetData.json"});await new Promise(s=>{t.ready(()=>{this.assetData=t.resource,s()}),this.assets.load(t)})}static async load(){const e=[];for(const t in this.assetData.textures)e.push(this.loadAsset(t,"texture",this.assetData.textures[t]));for(const t in this.assetData.models)e.push(this.loadAsset(t,"model",this.assetData.models[t]));for(const t in this.assetData.fonts)e.push(this.loadAsset(t,"font",this.assetData.fonts[t]));for(const t in this.assetData.jsons)e.push(this.loadAsset(t,"json",this.assetData.jsons[t]));for(const t in this.assetData.materials)e.push(this.loadAsset(t,"material",this.assetData.materials[t]));for(const t in this.assetData.texts)e.push(this.loadAsset(t,"text",this.assetData.texts[t]));for(const t in this.assetData.animations)e.push(this.loadAsset(t,"animation",this.assetData.animations[t]));for(const t in this.assetData.cubemaps)e.push(this.loadCubeMap(t,this.assetData.cubemaps[t]));for(const t in this.assetData.rawModels)e.push(this.loadAsset(t,"container",this.assetData.rawModels[t]));for(let t in this.assetData.scripts)e.push(this.loadScript(t,this.assetData.scripts[t]));for(const t in this.assetData.webfonts)e.push(this.loadWebFont(this.assetData.webfonts[t],t));for(const t in this.assetData.spriteAnimations)e.push(this._loadAtlas(t,this.assetData.spriteAnimations[t]));e.push(this._loadAtlases()),e.push(Se.load(this.assetData.audios)),await Promise.all(e)}static async _loadAtlases(){await Promise.all(Object.keys(this.assetData.atlas).map(e=>this._loadAtlas(e,this.assetData.atlas[e])))}static async loadCubeMap(e,t){let s=this.assets._loader.getHandler("json");if(!s)return console.error(`Json Handler not found. Cannot load cubemap ${e}.`),null;const i=await new Promise(d=>{s.load(t,(h,u)=>{h&&console.error(`Error loading cubemap ${e}.`,h),d(u)})});if(!i)return null;let n=i.textures.filter((d,h,u)=>u.indexOf(d)===h),a=await Promise.all(n.map(d=>{const h=this._getFileName(d);return this.loadFromUrl(d,h,"texture")})),o=new _e(this.app.graphicsDevice,{cubemap:!0});o.name=e,o.anisotropy=i.anisotropy,o.minFilter=i.minFilter,o.magFilter=i.magFilter;let l=i.textures.map(d=>{const h=a.find(u=>u.name===this._getFileName(d));return h?h.resource.getSource():(console.error(`Texture ${d} not loaded`),null)});o.setSource(l),this.registerAsset(o,e,"cubemap");let c=new ne(e,"cubemap");return c.resource=o,c.loaded=!0,c}static async loadFromUrl(e,t,s){return await new Promise((i,n)=>{this.assets.loadFromUrl(e,s,(a,o)=>{(a||!o)&&n(`Error loading ${t}: ${a}`),o&&(o.name=t),i(o)})})}static async loadSprite(e){let t=cl.find(e);t||cl.hasResource(e,"texture")&&(t=await cl.loadResource(e,"texture"));let s=new sc;return s.texture=t.resource,s.texture.name=e,s.frames={[e]:{rect:new P(0,0,s.texture.width,s.texture.height),pivot:new M(.5,.5),border:new P(0,0,0,0)}},new tc(Z.app.graphicsDevice,{atlas:s,frameKeys:[e],pixelsPerUnit:100})}static async _loadSpriteAnimation(e,t){let s=`${t}.png`;const i=new ne(e,"texture",{url:s}),n=s.replace(".png",".json").replace(".jpg",".json"),a=new ne(e,"json",{url:n});await Promise.all([new Promise(u=>{i.ready(()=>{u()}),this.assets.load(i)}),new Promise(u=>{a.ready(()=>{u()}),this.assets.load(a)})]);const o=new sc,l=a.resource,c=i.resource,d={};for(const u in l.frames){const f=l.frames[u].frame,p=l.frames[u].pivot||{x:0,y:0};d[u]={rect:new P(f.x,c.height-f.y-f.h,f.w,f.h),pivot:new M(p.x,p.y),border:new P(0,0,0,0)}}o.frames=d,o.texture=c,o.texture.name=e;const h=new tc(Z.app.graphicsDevice,{atlas:o,frameKeys:Object.keys(o.frames)});this.registerAsset(h,e,"sprite")}static async _loadAtlas(e,t){const s=new ne(e,"texture",{url:t}),i=t.replace(".png",".json").replace(".jpg",".json"),n=new ne(e,"json",{url:i});await Promise.all([new Promise(d=>{s.ready(()=>{d()}),this.assets.load(s)}),new Promise(d=>{n.ready(()=>{d()}),this.assets.load(n)})]);const a=new sc,o=n.resource,l=s.resource,c={};for(const d in o.frames){const h=o.frames[d].frame,u=o.frames[d].pivot||{x:0,y:0};c[d]={rect:new P(h.x,l.height-h.y-h.h,h.w,h.h),pivot:new M(u.x,u.y),border:new P(0,0,0,0)}}a.frames=c,a.texture=l,a.texture.name=e,Object.keys(a.frames).forEach(d=>{const h=new tc(Z.app.graphicsDevice,{atlas:a,frameKeys:[d]});this.registerAsset(h,d,"sprite")})}static async loadScript(e,t){return e.startsWith("glslang")?Promise.resolve():typeof t=="string"?this.loadFromUrl(t,"script",e):new Promise(s=>{Qu.setConfig(e,t),Qu.getInstance(e,i=>s(i))})}static loadResource(e,t){switch(t){case"texture":return this.loadFromUrl(this.assetData.resources.textures[e],e,"texture");case"material":return this.loadFromUrl(this.assetData.resources.materials[e],e,"material");case"model":return this.loadFromUrl(this.assetData.resources.models[e],e,"model");case"json":return this.loadFromUrl(this.assetData.resources.jsons[e],e,"json");case"font":return this.loadFromUrl(this.assetData.resources.fonts[e],e,"font");case"animation":return this.loadFromUrl(this.assetData.resources.animations[e],e,"animation");case"cubemap":return this.loadCubeMap(this.assetData.resources.cubemaps[e],e);case"audio":return Se.loadAudio(e,this.assetData.resources.audios[e]);case"rawModel":return this.loadFromUrl(this.assetData.resources.rawModels[e],e,"container");case"webfont":return this.loadWebFont(this.assetData.resources.webfonts[e],e);case"spriteAnimations":return this._loadSpriteAnimation(e,this.assetData.resources.spriteAnimations[e]);default:return Promise.reject(`Unknown type: ${t}`)}}static hasResource(e,t){if(t!==void 0)return this.assetData.resources[`${t}s`]===void 0?!1:this.assetData.resources[`${t}s`][e]!==void 0;{let s=!1;for(let i in this.assetData.resources)s=s||this.assetData.resources[i][e]!==void 0;return s}}static registerAsset(e,t,s){const i=new ne(t,s);i.resource=e,i.loaded=!0,this.assets.add(i)}static loadAsset(e,t,s){return new Promise((i,n)=>{this.assets.loadFromUrl(s,t,(a,o)=>{(a||!o)&&n(a),o.name=e,i(o)})})}static async loadWebFont(e,t){const s=document.createElement("style");return s.innerHTML=`
      @font-face {
        font-family: "${t}";
        src: url(${e});
      }
    `,document.head.appendChild(s),new Promise(i=>{s.onload=()=>{i()}})}static find(e){return typeof e=="string"?this.assets.find(e):e}static findAll(e){return this.assets.findAll(e)}static getYamlData(e){if(!this._yamlDataCache[e]){const t=this.find(e);if(t){const s=t.resource;this._yamlDataCache[e]=DG.load(s)}}return this._yamlDataCache[e]}static _getFileName(e){return me.getBasename(e).replace(me.getExtension(e),"")}};cl._yamlDataCache={};let K=cl;const FG={version:1},kG=[{info:{locale:"vi"},messages:{loading:"ang ti",victory:"Chin thng",defeat:"nh bi",challenge:"Th thch",shop:"Ca hng",setting:"Ci t","press-arrow-up-to-start":"NHN MI TN LN  BT U","tap-to-start":"NHN  BT U","daily-challenge":"NHIM V HNG NGY","reach-scores":"t {number} im","reach-levels":"Chi {number} ln","collect-coins":"Thu thp {number} xu","jump-times":"Nhy {number} ln","unlock-a-new-level":"M kha cp  mi","unlock-a-new-skin":`M kha nhn vt mi
`,claim:"Nhn",claimed:" nhn","game-over":"TR CHI KT THC",collected:" thu thp",home:"Trang ch",restart:"Chi li",skin:"TRANG PHC","unlock-now":"M KHA",complete:"HON THNH","claim-x2":"Nhn x2",sound:"m thanh",vibration:"Rung",language:"Ngn ng","press-arrow-up-to-continue":"NHN MI TN LN  TIP TC","tap-to-continue":"NHN  TIP TC","character-uppercase":"NHN VT",next:"Tip theo",unreach:"Cha t","reach-2500-scores":"t 2500 im","collect-50-coins":"Thu thp 50 xu","jump-1000-times":"Nhy 1000 ln","unlock-level-5":"M kha cp 5","reach-5000-scores":"t 5000 im","play-40-games":"Chi 40 ln","collect-100-coins":"Thu thp 100 xu","jump-2000-times":"Nhy 2000 ln","unlock-level-10":"M kha cp  10","reach-10000-scores":"t 10000 im","play-100-games":"Chi 100 ln","collect-150-coins":"Thu thp 150 xu","jump-5000-times":"Nhy 5000 ln","unlock-level-15":"M kha cp  15",levels:"Cp ","endless-mode":"Ch  v tn ",continue:"Tip tc","continue-ask":"TIP TC?","open-daily-challenge":"M nhim v hng ngy","receive-reward":"Nhn thng","no-thanks":"B QUA",replay:"Chi li","open-shop":"M ca hng","click-to-skin":"Nhn vo nhn vt","click-to-buy":"Nhn  mua","swipe-up-to-jump":"Vut ln  nhy","swipe-down-to-crouch":"Vut xung v gi  ci","press-arrow-up-to-jump":"Nhn mi tn ln  nhy","press-arrow-down-to-crouch":"Nhn mi tn xung v gi  ci","open-level":"Chn cp ","click-to-play":"Nhn  chi","back-to-home":"Quay li trang ch"}},{info:{locale:"en"},messages:{loading:"Loading",victory:"Victory",defeat:"Defeat",challenge:"Challenge",shop:"Shop",setting:"Setting","press-arrow-up-to-start":"PRESS ARROW UP TO START","tap-to-start":"TAP TO START","daily-challenge":"DAILY CHALLENGE","reach-scores":"Reach {number} scores","reach-levels":"Play {number} games","collect-coins":"Collect {number} coins","jump-times":"Jump {number} times","unlock-a-new-level":"Unlock a new level","unlock-a-new-skin":"Unlock a new skin",claim:"Claim",claimed:"Claimed","game-over":"GAME OVER",collected:"Collected",home:"Home",restart:"Restart",skin:"SKIN","unlock-now":"UNLOCK",complete:"COMPLETED","claim-x2":"Claim x2",sound:"Sound",vibration:"Vibration",language:"Language","press-arrow-up-to-continue":"PRESS ARROW UP TO CONTINUE","tap-to-continue":"TAP TO CONTINUE","character-uppercase":"CHARACTER",next:"Next",unreach:"Unreach","reach-2500-scores":"Reach 2500 scores","collect-50-coins":"Collect 50 coins","jump-1000-times":"Jump 1000 times","unlock-level-5":"Unlock level 5","reach-5000-scores":"Reach 5000 scores","play-40-games":"Play 40 games","collect-100-coins":"Collect 100 coins","jump-2000-times":"Jump 2000 times","unlock-level-10":"Unlock level 10","reach-10000-scores":"Reach 10000 scores","play-100-games":"Play 100 games","collect-150-coins":"Collect 150 coins","jump-5000-times":"Jump 5000 times","unlock-level-15":"Unlock level 15",levels:"Levels","endless-mode":"Endless Mode",continue:"Continue","continue-ask":"CONTINUE?","open-daily-challenge":"Open daily challenge","receive-reward":"Receive reward","no-thanks":"NO THANKS",replay:"Replay","open-shop":"Open shop","click-to-skin":"Click to skin","click-to-buy":"Click to buy","swipe-up-to-jump":"Swipe up to jump","swipe-down-to-crouch":"Swipe down and hold to crouch","press-arrow-up-to-jump":"Press arrow up to jump","press-arrow-down-to-crouch":"Press arrow down and hold to crouch","open-level":"Open level","click-to-play":"Click to play","back-to-home":"Back to home"}},{info:{locale:"de"},messages:{loading:"Laden",victory:"Sieg",defeat:"Versagen",challenge:"Herausforderung",shop:"Geschft",setting:"Einstellung","press-arrow-up-to-start":"DRCKEN SIE DEN PFEIL NACH OBEN, UM ZU STARTEN","tap-to-start":"TIPPE, UM ZU STARTEN","daily-challenge":"TGLICHE HERAUSFORDERUNG","reach-scores":"Erreiche {number} Punkte","reach-levels":"Spielen Sie {Anzahl} Spiele","collect-coins":"Sammle {Anzahl} Mnzen","jump-times":"Springe {Anzahl} Mal","unlock-a-new-level":"Schalte ein neues Level frei","unlock-a-new-skin":"Schalte einen neuen Skin frei",claim:"Beanspruchen",claimed:"Behauptet","game-over":"SPIEL VORBEI",collected:"Gesammelt",home:"Heim",restart:"Neu starten",skin:"HAUT","unlock-now":"FREISCHALTEN",complete:"VOLLENDET","claim-x2":"Anspruch x2",sound:"Klang",vibration:"Vibration",language:"Sprache","press-arrow-up-to-continue":"DRCKEN SIE DEN PFEIL NACH OBEN, UM WEITERZUFAHREN","tap-to-continue":"TIPPEN SIE, UM FORTZUFAHREN","character-uppercase":"CHARAKTER",next:"Nchste",unreach:"Unerreichbar","reach-2500-scores":"Erreiche 2500 Punkte","collect-50-coins":"Sammle 50 Mnzen","jump-1000-times":"Springe 1000 Mal","unlock-level-5":"Schalte Level 5 frei","reach-5000-scores":"Erreiche 5000 Punkte","play-40-games":"Spiele 40 Spiele","collect-100-coins":"Sammle 100 Mnzen","jump-2000-times":"Springe 2000 Mal","unlock-level-10":"Schalte Level 10 frei","reach-10000-scores":"Erreiche 10.000 Punkte","play-100-games":"Spielen Sie 100 Spiele","collect-150-coins":"Sammle 150 Mnzen","jump-5000-times":"Springe 5000 Mal","unlock-level-15":"Schalte Level 15 frei",levels:"Ebenen","endless-mode":"Endlosmodus",continue:"Weitermachen","continue-ask":"WEITERMACHEN?","open-daily-challenge":"Tgliche Herausforderung ffnen","receive-reward":"Belohnung erhalten","no-thanks":"NEIN DANKE",replay:"Wiederholung","open-shop":"Offener Laden","click-to-skin":"Zum Skin anklicken","click-to-buy":"Klicken um zu kaufen","swipe-up-to-jump":"Wischen Sie nach oben, um zu springen","swipe-down-to-crouch":"Wischen Sie nach unten und halten Sie die Taste gedrckt, um sich zu ducken","press-arrow-up-to-jump":"Drcken Sie den Pfeil nach oben, um zu springen","press-arrow-down-to-crouch":"Drcken Sie den Pfeil nach unten und halten Sie ihn gedrckt, um sich zu ducken","open-level":"Offene Ebene","click-to-play":"Anklicken um abzuspielen","back-to-home":"Zurck nach Hause"}},{info:{locale:"pt"},messages:{loading:"Carregando",victory:"Vitria",defeat:"Derrota",challenge:"Desafio",shop:"Comprar",setting:"Contexto","press-arrow-up-to-start":"PRESSIONE A SETA PARA CIMA PARA INICIAR","tap-to-start":"CLIQUE PARA COMEAR","daily-challenge":"DESAFIO DIRIO","reach-scores":"Alcance {nmero} pontuaes","reach-levels":"Jogue {nmero} partidas","collect-coins":"Colete {nmero} moedas","jump-times":"Pule {nmero} vezes","unlock-a-new-level":"Desbloqueie um novo nvel","unlock-a-new-skin":"Desbloqueie uma nova skin",claim:"Alegar",claimed:"Reivindicado","game-over":"GAME OVER",collected:"Coletado",home:"Lar",restart:"Reiniciar",skin:"PELE","unlock-now":"DESBLOQUEAR",complete:"CONCLUDO","claim-x2":"Reivindicar x2",sound:"Som",vibration:"Vibrao",language:"Linguagem","press-arrow-up-to-continue":"PRESSIONE A SETA PARA CIMA PARA CONTINUAR","tap-to-continue":"CLIQUE PARA CONTINUAR","character-uppercase":"PERSONAGEM",next:"Prximo",unreach:"Desalcanar","reach-2500-scores":"Alcance 2.500 pontuaes","collect-50-coins":"Colete 50 moedas","jump-1000-times":"Pule 1000 vezes","unlock-level-5":"Desbloquear nvel 5","reach-5000-scores":"Alcance 5.000 pontuaes","play-40-games":"Jogue 40 partidas","collect-100-coins":"Colete 100 moedas","jump-2000-times":"Pule 2.000 vezes","unlock-level-10":"Desbloquear nvel 10","reach-10000-scores":"Alcance 10.000 pontuaes","play-100-games":"Jogue 100 jogos","collect-150-coins":"Colete 150 moedas","jump-5000-times":"Pule 5.000 vezes","unlock-level-15":"Desbloquear nvel 15",levels:"Nveis","endless-mode":"Modo infinito",continue:"Continuar","continue-ask":"CONTINUAR?","open-daily-challenge":"Desafio dirio aberto","receive-reward":"Receba recompensa","no-thanks":"NO, OBRIGADO",replay:"Repetir","open-shop":"Loja aberta","click-to-skin":"Clique para skin","click-to-buy":"Clique para comprar","swipe-up-to-jump":"Deslize para cima para pular","swipe-down-to-crouch":"Deslize para baixo e segure para agachar","press-arrow-up-to-jump":"Pressione a seta para cima para pular","press-arrow-down-to-crouch":"Pressione a seta para baixo e segure para agachar","open-level":"Nvel aberto","click-to-play":"Clique para jogar","back-to-home":"De volta para casa"}},{info:{locale:"es"},messages:{loading:"Cargando",victory:"Victoria",defeat:"Fracaso",challenge:"Desafo",shop:"Comercio",setting:"Configuracin","press-arrow-up-to-start":"PRESIONE LA FLECHA ARRIBA PARA COMENZAR","tap-to-start":"TOCA PARA COMENZAR","daily-challenge":"RETO DIARIO","reach-scores":"Alcanza {nmero} puntuaciones","reach-levels":"Juega {nmero} juegos","collect-coins":"Recoge {nmero} monedas","jump-times":"Saltar {nmero} veces","unlock-a-new-level":"Desbloquea un nuevo nivel","unlock-a-new-skin":"Desbloquear una nueva piel",claim:"Afirmar",claimed:"Reclamado","game-over":"JUEGO TERMINADO",collected:"Recogido",home:"Hogar",restart:"Reanudar",skin:"PIEL","unlock-now":"DESBLOQUEAR",complete:"TERMINADO","claim-x2":"Reclamar x2",sound:"Sonido",vibration:"Vibracin",language:"Idioma","press-arrow-up-to-continue":"PRESIONE LA FLECHA ARRIBA PARA CONTINUAR","tap-to-continue":"PULSE PARA CONTINUAR","character-uppercase":"PERSONAJE",next:"Prximo",unreach:"no alcanzar","reach-2500-scores":"Alcanza 2500 puntuaciones","collect-50-coins":"Recoge 50 monedas","jump-1000-times":"Salta 1000 veces","unlock-level-5":"Desbloquear nivel 5","reach-5000-scores":"Alcanza 5000 puntuaciones","play-40-games":"Juega 40 juegos","collect-100-coins":"Recoge 100 monedas","jump-2000-times":"Salta 2000 veces","unlock-level-10":"Desbloquear nivel 10","reach-10000-scores":"Alcanza 10000 puntuaciones.","play-100-games":"Juega 100 juegos","collect-150-coins":"Recoge 150 monedas","jump-5000-times":"Salta 5000 veces","unlock-level-15":"Desbloquear nivel 15",levels:"Niveles","endless-mode":"Modo sin fin",continue:"Continuar","continue-ask":"CONTINUAR?","open-daily-challenge":"Desafo diario abierto","receive-reward":"Recibir recompensa","no-thanks":"NO, GRACIAS",replay:"Repeticin","open-shop":"Tienda abierta","click-to-skin":"Haga clic para piel","click-to-buy":"Haga clic para comprar","swipe-up-to-jump":"Desliza hacia arriba para saltar","swipe-down-to-crouch":"Desliza hacia abajo y mantn presionado para agacharte","press-arrow-up-to-jump":"Pulsa la flecha hacia arriba para saltar.","press-arrow-down-to-crouch":"Presione la flecha hacia abajo y mantngala presionada para agacharse","open-level":"nivel abierto","click-to-play":'Dele "click" para jugar',"back-to-home":"De vuelta a casa"}},{info:{locale:"tr"},messages:{loading:"Ykleniyor",victory:"Zafer",defeat:"Yenmek",challenge:"Meydan okumak",shop:"Maaza",setting:"Ayar","press-arrow-up-to-start":"BALAMAK N YUKARI OK TUUNA BASIN","tap-to-start":"BALAMAK N DOKUN","daily-challenge":"GNLK MEYDAN OKUMA","reach-scores":"{number} puana ulan","reach-levels":"{number} oyun oyna","collect-coins":"{number} para topla","jump-times":"{number} kez atla","unlock-a-new-level":"Yeni bir seviyenin kilidini a","unlock-a-new-skin":"Yeni bir grnmn kilidini an",claim:"ddia",claimed:"Hak talebinde bulunuldu","game-over":"OYUN BTT",collected:"Toplanm",home:"Ev",restart:"Tekrar balat",skin:"DER","unlock-now":"KLDN A",complete:"TAMAMLANMI","claim-x2":"x2'yi talep et",sound:"Ses",vibration:"Titreim",language:"Dil","press-arrow-up-to-continue":"DEVAM ETMEK N YUKARI OK TUUNA BASIN","tap-to-continue":"DEVAM ETMEK N DOKUNUN","character-uppercase":"KARAKTER",next:"Sonraki",unreach:"Ulalamaz","reach-2500-scores":"2500 puana ulan","collect-50-coins":"50 jeton topla","jump-1000-times":"1000 kez atla","unlock-level-5":"5. seviyenin kilidini a","reach-5000-scores":"5000 puana ulan","play-40-games":"40 oyun oyna","collect-100-coins":"100 jeton topla","jump-2000-times":"2000 kez atla","unlock-level-10":"10. seviyenin kilidini a","reach-10000-scores":"10000 puana ulan","play-100-games":"100 oyun oyna","collect-150-coins":"150 jeton topla","jump-5000-times":"5000 kez atla","unlock-level-15":"15. seviyenin kilidini a",levels:"Seviyeler","endless-mode":"Sonsuz Mod",continue:"Devam etmek","continue-ask":"DEVAM ETMEK?","open-daily-challenge":"Gnlk mcadeleyi a","receive-reward":"dl al","no-thanks":"HAYIR, TEEKKRLER",replay:"Tekrar oynat","open-shop":"Ak dkkan","click-to-skin":"D grnm iin tklayn","click-to-buy":"Satn almak iin tkla","swipe-up-to-jump":"Atlamak iin yukar kaydrn","swipe-down-to-crouch":"melmek iin aa kaydrn ve basl tutun","press-arrow-up-to-jump":"Atlamak iin yukar oka basn","press-arrow-down-to-crouch":"melmek iin aa ok tuuna basn ve basl tutun","open-level":"Ak seviye","click-to-play":"Oynatmak iin tklayn","back-to-home":"Eve geri dn"}},{info:{locale:"ar"},messages:{loading:"",victory:"",defeat:"",challenge:"",shop:"",setting:"","press-arrow-up-to-start":"    ","tap-to-start":" ","daily-challenge":" ","reach-scores":"  {number}  ","reach-levels":"  {number}.","collect-coins":" {number}   ","jump-times":" {number} ","unlock-a-new-level":"  ","unlock-a-new-skin":"  ",claim:"",claimed:"","game-over":" ",collected:" ",home:"",restart:" ",skin:"","unlock-now":" ",complete:"","claim-x2":"  2",sound:"",vibration:"",language:"","press-arrow-up-to-continue":"    ","tap-to-continue":" ","character-uppercase":"",next:"",unreach:"  ","reach-2500-scores":"  2500 ","collect-50-coins":" 50  ","jump-1000-times":" 1000 ","unlock-level-5":"  5","reach-5000-scores":"  5000 ","play-40-games":" 40 ","collect-100-coins":" 100  ","jump-2000-times":" 2000 ","unlock-level-10":"  10","reach-10000-scores":"  10000 ","play-100-games":" 100 ","collect-150-coins":" 150  ","jump-5000-times":" 5000 ","unlock-level-15":"  15",levels:"","endless-mode":"    ",continue:"","continue-ask":"","open-daily-challenge":"  ","receive-reward":"  ","no-thanks":" ",replay:" ","open-shop":" ","click-to-skin":"  ","click-to-buy":" ","swipe-up-to-jump":"  ","swipe-down-to-crouch":"     ","press-arrow-up-to-jump":"    ","press-arrow-down-to-crouch":"      ","open-level":" ","click-to-play":" ","back-to-home":"  "}},{info:{locale:"fr"},messages:{loading:"Chargement",victory:"La victoire",defeat:"Dfaite",challenge:"Dfi",shop:"Boutique",setting:"Paramtre","press-arrow-up-to-start":"APPUYEZ SUR LA FLCHE HAUT POUR COMMENCER","tap-to-start":"APPUYEZ POUR COMMENCER","daily-challenge":"CHALLENGE QUOTIDIEN","reach-scores":"Atteignez {number}scores","reach-levels":"Jouez  {number}jeux","collect-coins":"Collectez {number}pices","jump-times":"Sauter {nombre}fois","unlock-a-new-level":"Dbloquez un nouveau niveau","unlock-a-new-skin":"Dbloquez un nouveau skin",claim:"Rclamer",claimed:"Revendiqu","game-over":"JEU TERMIN",collected:"Collect",home:"Maison",restart:"Redmarrage",skin:"PEAU","unlock-now":"OUVRIR",complete:"COMPLT","claim-x2":"Rclamation x2",sound:"Son",vibration:"Vibration",language:"Langue","press-arrow-up-to-continue":"APPUYEZ SUR LA FLCHE HAUT POUR CONTINUER","tap-to-continue":"APPUYEZ POUR CONTINUER","character-uppercase":"PERSONNAGE",next:"Suivant",unreach:"Non atteint","reach-2500-scores":"Atteindre 2500 points","collect-50-coins":"Collectez 50 pices","jump-1000-times":"Sauter 1000 fois","unlock-level-5":"Dbloquez le niveau 5","reach-5000-scores":"Atteindre 5000 points","play-40-games":"Jouez  40 jeux","collect-100-coins":"Collectez 100 pices","jump-2000-times":"Sauter 2000 fois","unlock-level-10":"Dbloquez le niveau 10","reach-10000-scores":"Atteindre 10 000 points","play-100-games":"Jouez  100 jeux","collect-150-coins":"Collectez 150 pices","jump-5000-times":"Sauter 5000 fois","unlock-level-15":"Dbloquez le niveau 15",levels:"Les niveaux","endless-mode":"Mode sans fin",continue:"Continuer","continue-ask":"CONTINUER?","open-daily-challenge":"Dfi quotidien ouvert","receive-reward":"Recevoir une rcompense","no-thanks":"NON MERCI",replay:"Rejouer","open-shop":"Boutique ouverte","click-to-skin":"Cliquez pour skin","click-to-buy":"Cliquez pour acheter","swipe-up-to-jump":"Glissez vers le haut pour sauter","swipe-down-to-crouch":"Faites glisser votre doigt vers le bas et maintenez-le enfonc pour vous accroupir","press-arrow-up-to-jump":"Appuyez sur la flche vers le haut pour sauter","press-arrow-down-to-crouch":"Appuyez sur la flche vers le bas et maintenez-la enfonce pour vous accroupir","open-level":"Niveau ouvert","click-to-play":"Cliquez pour jouer","back-to-home":"De retour  la maison"}},{info:{locale:"hi"},messages:{loading:"   ",victory:"",defeat:"",challenge:"",shop:"",setting:"","press-arrow-up-to-start":"        ","tap-to-start":"     ","daily-challenge":" ","reach-scores":"{}   ","reach-levels":"{}  ","collect-coins":"{}   ","jump-times":"{}  ","unlock-a-new-level":"    ","unlock-a-new-skin":"    ",claim:"",claimed:" ","game-over":" ",collected:"  ",home:"",restart:"  ",skin:"","unlock-now":"",complete:" ","claim-x2":" x2",sound:"",vibration:"",language:"","press-arrow-up-to-continue":"      ","tap-to-continue":"    ","character-uppercase":"",next:"",unreach:"  ","reach-2500-scores":"2500   ","collect-50-coins":"50   ","jump-1000-times":"1000  ","unlock-level-5":" 5  ","reach-5000-scores":"5000   ","play-40-games":"40  ","collect-100-coins":"100   ","jump-2000-times":"2000  ","unlock-level-10":" 10  ","reach-10000-scores":"10000   ","play-100-games":"100  ","collect-150-coins":"150   ","jump-5000-times":"5000  ","unlock-level-15":" 15  ",levels:"","endless-mode":" ",continue:" ","continue-ask":" ?","open-daily-challenge":"  ","receive-reward":" ","no-thanks":" , ",replay:"REPLAY","open-shop":" ","click-to-skin":"   ","click-to-buy":"   ","swipe-up-to-jump":"       ","swipe-down-to-crouch":"          ","press-arrow-up-to-jump":"     ","press-arrow-down-to-crouch":"          ","open-level":" ","click-to-play":"    ","back-to-home":"    "}},{info:{locale:"id"},messages:{loading:"Memuat",victory:"Kemenangan",defeat:"Mengalahkan",challenge:"Tantangan",shop:"Toko",setting:"Pengaturan","press-arrow-up-to-start":"TEKAN PANAH KE ATAS UNTUK MEMULAI","tap-to-start":"KETUK UNTUK MEMULAI","daily-challenge":"TANTANGAN SEHARI-HARI","reach-scores":"Raih skor {number}","reach-levels":"Mainkan {number} permainan","collect-coins":"Kumpulkan {number} koin","jump-times":"Lompat {number} kali","unlock-a-new-level":"Buka kunci level baru","unlock-a-new-skin":"Buka kunci kulit baru",claim:"Mengeklaim",claimed:"Diklaim","game-over":"PERMAINAN TELAH BERAKHIR",collected:"Dikumpulkan",home:"Rumah",restart:"Mengulang kembali",skin:"KULIT","unlock-now":"MEMBUKA KUNCI",complete:"LENGKAP","claim-x2":"Klaim x2",sound:"Suara",vibration:"Getaran",language:"Bahasa","press-arrow-up-to-continue":"TEKAN PANAH KE ATAS UNTUK MELANJUTKAN","tap-to-continue":"KETUK UNTUK MELANJUTKAN","character-uppercase":"KARAKTER",next:"Berikutnya",unreach:"Tidak terjangkau","reach-2500-scores":"Raih 2500 skor","collect-50-coins":"Kumpulkan 50 koin","jump-1000-times":"Lompat 1000 kali","unlock-level-5":"Buka kunci level 5","reach-5000-scores":"Raih 5000 skor","play-40-games":"Mainkan 40 permainan","collect-100-coins":"Kumpulkan 100 koin","jump-2000-times":"Lompat 2000 kali","unlock-level-10":"Buka kunci level 10","reach-10000-scores":"Raih 10.000 skor","play-100-games":"Mainkan 100 permainan","collect-150-coins":"Kumpulkan 150 koin","jump-5000-times":"Lompat 5000 kali","unlock-level-15":"Buka kunci level 15",levels:"Tingkat","endless-mode":"Modus Tanpa Akhir",continue:"Melanjutkan","continue-ask":"MELANJUTKAN?","open-daily-challenge":"Buka tantangan harian","receive-reward":"Terima hadiah","no-thanks":"TIDAK, TERIMA KASIH",replay:"Memutar ulang","open-shop":"Buka toko","click-to-skin":"Klik untuk menguliti","click-to-buy":"Klik untuk membeli","swipe-up-to-jump":"Geser ke atas untuk melompat","swipe-down-to-crouch":"Geser ke bawah dan tahan untuk berjongkok","press-arrow-up-to-jump":"Tekan panah ke atas untuk melompat","press-arrow-down-to-crouch":"Tekan panah ke bawah dan tahan untuk berjongkok","open-level":"Tingkat terbuka","click-to-play":"Klik untuk main","back-to-home":"Kembali ke rumah"}},{info:{locale:"it"},messages:{loading:"Caricamento",victory:"Vittoria",defeat:"Sconfitta",challenge:"Sfida",shop:"Negozio",setting:"Collocamento","press-arrow-up-to-start":"PREMERE LA FRECCIA IN ALTO PER INIZIARE","tap-to-start":"TOCCA PER INIZIARE","daily-challenge":"SFIDA QUOTIDIANA","reach-scores":"Raggiungi {numero} punteggi","reach-levels":"Gioca a {numero} giochi","collect-coins":"Raccogli {numero} monete","jump-times":"Salta {numero} volte","unlock-a-new-level":"Sblocca un nuovo livello","unlock-a-new-skin":"Sblocca una nuova skin",claim:"Reclamo",claimed:"Reclamato","game-over":"GAME OVER",collected:"Raccolto",home:"Casa",restart:"Ricomincia",skin:"PELLE","unlock-now":"SBLOCCARE",complete:"COMPLETATO","claim-x2":"Richiedi x2",sound:"Suono",vibration:"Vibrazione",language:"Lingua","press-arrow-up-to-continue":"PREMERE LA FRECCIA IN ALTO PER CONTINUARE","tap-to-continue":"TOCCA PER CONTINUARE","character-uppercase":"CARATTERE",next:"Prossimo",unreach:"Non raggiungere","reach-2500-scores":"Raggiungi 2500 punteggi","collect-50-coins":"Raccogli 50 monete","jump-1000-times":"Salta 1000 volte","unlock-level-5":"Sblocca il livello 5","reach-5000-scores":"Raggiungi 5000 punteggi","play-40-games":"Gioca 40 partite","collect-100-coins":"Raccogli 100 monete","jump-2000-times":"Salta 2000 volte","unlock-level-10":"Sblocca il livello 10","reach-10000-scores":"Raggiungi 10.000 punteggi","play-100-games":"Gioca a 100 giochi","collect-150-coins":"Raccogli 150 monete","jump-5000-times":"Salta 5000 volte","unlock-level-15":"Sblocca il livello 15",levels:"Livelli","endless-mode":"Modalit infinita",continue:"Continua","continue-ask":"CONTINUA?","open-daily-challenge":"Sfida quotidiana aperta","receive-reward":"Ricevi una ricompensa","no-thanks":"NO GRAZIE",replay:"Rigiocare","open-shop":"Negozio aperto","click-to-skin":"Fare clic sulla pelle","click-to-buy":"Clicca per comprare","swipe-up-to-jump":"Scorri verso l'alto per saltare","swipe-down-to-crouch":"Scorri verso il basso e tieni premuto per accovacciarti","press-arrow-up-to-jump":"Premi la freccia su per saltare","press-arrow-down-to-crouch":"Premi la freccia verso il basso e tieni premuto per accovacciarti","open-level":"Livello aperto","click-to-play":"Clicca per giocare","back-to-home":"Tornare a casa"}},{info:{locale:"ja"},messages:{loading:"",victory:"",defeat:"",challenge:"",shop:"",setting:"","press-arrow-up-to-start":"","tap-to-start":"","daily-challenge":"","reach-scores":"{} ","reach-levels":"{number} ","collect-coins":"{number} ","jump-times":"{number} ","unlock-a-new-level":"","unlock-a-new-skin":"",claim:"",claimed:"","game-over":"",collected:"",home:"",restart:"",skin:"","unlock-now":"",complete:"","claim-x2":" x2",sound:"",vibration:"",language:"","press-arrow-up-to-continue":"","tap-to-continue":"","character-uppercase":"",next:"",unreach:"","reach-2500-scores":"2500 ","collect-50-coins":"50","jump-1000-times":"1000","unlock-level-5":"5","reach-5000-scores":"5000 ","play-40-games":"40 ","collect-100-coins":"100","jump-2000-times":"2000","unlock-level-10":"10","reach-10000-scores":"10000","play-100-games":"100 ","collect-150-coins":"150","jump-5000-times":"5000","unlock-level-15":"15",levels:"","endless-mode":"",continue:"","continue-ask":"","open-daily-challenge":"","receive-reward":"","no-thanks":"",replay:"","open-shop":"","click-to-skin":"","click-to-buy":"","swipe-up-to-jump":"","swipe-down-to-crouch":"","press-arrow-up-to-jump":"","press-arrow-down-to-crouch":"","open-level":"","click-to-play":"","back-to-home":""}},{info:{locale:"ko"},messages:{loading:" ",victory:"",defeat:"",challenge:"",shop:"",setting:"","press-arrow-up-to-start":"   .","tap-to-start":" ","daily-challenge":" ","reach-scores":"{number} ","reach-levels":"{number}  ","collect-coins":"{number}  ","jump-times":"{number} ","unlock-a-new-level":"   ","unlock-a-new-skin":"   ",claim:"",claimed:"","game-over":" ",collected:"",home:"",restart:"",skin:"","unlock-now":"",complete:"","claim-x2":"2 ",sound:"",vibration:"",language:"","press-arrow-up-to-continue":"   .","tap-to-continue":" .","character-uppercase":"",next:"",unreach:" ","reach-2500-scores":"2500 ","collect-50-coins":" 50 ","jump-1000-times":"1000 ","unlock-level-5":" 5  ","reach-5000-scores":"5000 ","play-40-games":"40  ","collect-100-coins":"100  ","jump-2000-times":"2000 ","unlock-level-10":" 10  ","reach-10000-scores":"10000 ","play-100-games":"100  ","collect-150-coins":" 150 ","jump-5000-times":"5000 ","unlock-level-15":" 15  ",levels:"","endless-mode":" ",continue:"","continue-ask":"?","open-daily-challenge":"  ","receive-reward":" ","no-thanks":"   ",replay:" ","open-shop":" ","click-to-skin":" ","click-to-buy":" ","swipe-up-to-jump":"  .","swipe-down-to-crouch":"     ","press-arrow-up-to-jump":"   .","press-arrow-down-to-crouch":"     .","open-level":" ","click-to-play":" .","back-to-home":""}},{info:{locale:"nl"},messages:{loading:"Bezig met laden",victory:"zege",defeat:"Verlies",challenge:"Uitdaging",shop:"Winkel",setting:"Instelling","press-arrow-up-to-start":"DRUK OP PIJL OMHOOG OM TE STARTEN","tap-to-start":"KLIK OM TE BEGINNEN","daily-challenge":"DAGELIJKSE UITDAGING","reach-scores":"Behaal {aantal} scores","reach-levels":"Speel {aantal} spellen","collect-coins":"Verzamel {aantal} munten","jump-times":"Spring {aantal} keer","unlock-a-new-level":"Ontgrendel een nieuw niveau","unlock-a-new-skin":"Ontgrendel een nieuwe skin",claim:"Claim",claimed:"Geclaimd","game-over":"SPEL IS OVER",collected:"Verzameld",home:"Thuis",restart:"Herstarten",skin:"HUID","unlock-now":"ONTGRENDELEN",complete:"VOLTOOID","claim-x2":"Claim x2",sound:"Geluid",vibration:"Trillingen",language:"Taal","press-arrow-up-to-continue":"DRUK OP PIJL OMHOOG OM DOOR TE GAAN","tap-to-continue":"Tik om verder te gaan","character-uppercase":"KARAKTER",next:"Volgende",unreach:"Onbereikbaar","reach-2500-scores":"Bereik 2500 scores","collect-50-coins":"Verzamel 50 munten","jump-1000-times":"Spring 1000 keer","unlock-level-5":"Ontgrendel niveau 5","reach-5000-scores":"Bereik 5000 scores","play-40-games":"Speel 40 spellen","collect-100-coins":"Verzamel 100 munten","jump-2000-times":"Spring 2000 keer","unlock-level-10":"Ontgrendel niveau 10","reach-10000-scores":"Bereik 10.000 scores","play-100-games":"Speel 100 spellen","collect-150-coins":"Verzamel 150 munten","jump-5000-times":"Spring 5000 keer","unlock-level-15":"Ontgrendel niveau 15",levels:"Niveaus","endless-mode":"Eindeloze modus",continue:"Doorgaan","continue-ask":"DOORGAAN?","open-daily-challenge":"Open dagelijkse uitdaging","receive-reward":"Ontvang beloning","no-thanks":"NEE BEDANKT",replay:"Herhaling","open-shop":"Open winkel","click-to-skin":"Klik om te skin","click-to-buy":"Klik om te kopen","swipe-up-to-jump":"Veeg omhoog om te springen","swipe-down-to-crouch":"Veeg naar beneden en houd vast om te bukken","press-arrow-up-to-jump":"Druk op de pijl omhoog om te springen","press-arrow-down-to-crouch":"Houd de pijl naar beneden ingedrukt om te bukken","open-level":"Open niveau","click-to-play":"Klik om te spelen","back-to-home":"Terug naar huis"}},{info:{locale:"ru"},messages:{loading:"",victory:"",defeat:"",challenge:"",shop:"",setting:"","press-arrow-up-to-start":"  ,  ","tap-to-start":",  ","daily-challenge":" ","reach-scores":" {number} ","reach-levels":"  {number} ","collect-coins":" {number} .","jump-times":" {number} ","unlock-a-new-level":"  ","unlock-a-new-skin":"  ",claim:"",claimed:"","game-over":" ",collected:"",home:"",restart:"",skin:"","unlock-now":"",complete:"","claim-x2":" x2",sound:"",vibration:"",language:"","press-arrow-up-to-continue":"  ,  ","tap-to-continue":",  ","character-uppercase":"",next:"",unreach:"","reach-2500-scores":" 2500 ","collect-50-coins":" 50 ","jump-1000-times":" 1000 ","unlock-level-5":"  5","reach-5000-scores":" 5000 ","play-40-games":" 40 ","collect-100-coins":" 100 ","jump-2000-times":" 2000 .","unlock-level-10":"  10","reach-10000-scores":" 10 000 ","play-100-games":" 100 ","collect-150-coins":" 150 .","jump-5000-times":" 5000 ","unlock-level-15":"  15",levels:"","endless-mode":" ",continue:"","continue-ask":"?","open-daily-challenge":"  ","receive-reward":" ","no-thanks":", ",replay:"","open-shop":" ","click-to-skin":",  ","click-to-buy":",  ","swipe-up-to-jump":"  ,  ","swipe-down-to-crouch":"    ,  ","press-arrow-up-to-jump":"  ,  ","press-arrow-down-to-crouch":"    ,  ","open-level":" ","click-to-play":",  ","back-to-home":" "}},{info:{locale:"sv"},messages:{loading:"Lser in",victory:"Seger",defeat:"Nederlag",challenge:"Utmaning",shop:"affr",setting:"Milj","press-arrow-up-to-start":"TRYCK PIL UPP FR ATT STARTA","tap-to-start":"KNAPP FR ATT STARTA","daily-challenge":"DAGLIG UTMANING","reach-scores":"N {number} pong","reach-levels":"Spela {number} spel","collect-coins":"Samla {number} mynt","jump-times":"Hoppa {number} gnger","unlock-a-new-level":"Ls upp en ny niv","unlock-a-new-skin":"Ls upp ett nytt skal",claim:"Krav",claimed:"Pstod","game-over":"SPEL SLUT",collected:"Samlade in",home:"Hem",restart:"Omstart",skin:"HUD","unlock-now":"LSA UPP",complete:"AVSLUTAD","claim-x2":"Ansprk x2",sound:"Ljud",vibration:"Vibration",language:"Sprk","press-arrow-up-to-continue":"TRYCK PIL UPP FR ATT FORTSTTA","tap-to-continue":"KLICKA FR ATT FORTSTTA","character-uppercase":"KARAKTR",next:"Nsta",unreach:"Unreach","reach-2500-scores":"N 2500 pong","collect-50-coins":"Samla 50 mynt","jump-1000-times":"Hoppa 1000 gnger","unlock-level-5":"Ls upp niv 5","reach-5000-scores":"N 5000 pong","play-40-games":"Spela 40 spel","collect-100-coins":"Samla 100 mynt","jump-2000-times":"Hoppa 2000 gnger","unlock-level-10":"Ls upp niv 10","reach-10000-scores":"N 10 000 pong","play-100-games":"Spela 100 spel","collect-150-coins":"Samla 150 mynt","jump-5000-times":"Hoppa 5000 gnger","unlock-level-15":"Ls upp niv 15",levels:"Niver","endless-mode":"ndlst lge",continue:"Fortstta","continue-ask":"FORTSTTA?","open-daily-challenge":"ppen daglig utmaning","receive-reward":"Ta emot belning","no-thanks":"NEJ TACK",replay:"Repris","open-shop":"ppen butik","click-to-skin":"Klicka till skal","click-to-buy":"Klicka fr att kpa","swipe-up-to-jump":"Svep uppt fr att hoppa","swipe-down-to-crouch":"Svep ned och hll fr att huka","press-arrow-up-to-jump":"Tryck pil upp fr att hoppa","press-arrow-down-to-crouch":"Tryck ner pilen och hll ned fr att huka","open-level":"ppen niv","click-to-play":"Klicka fr att spela","back-to-home":"Tillbaka till hemmet"}},{info:{locale:"th"},messages:{loading:"",victory:"",defeat:"",challenge:"",shop:"",setting:"","press-arrow-up-to-start":"","tap-to-start":"","daily-challenge":"","reach-scores":" {number} ","reach-levels":" {number}","collect-coins":" {number} ","jump-times":" {number} ","unlock-a-new-level":"","unlock-a-new-skin":"",claim:"",claimed:"","game-over":"",collected:"",home:"",restart:"",skin:"","unlock-now":"",complete:"","claim-x2":" x2",sound:"",vibration:"",language:"","press-arrow-up-to-continue":"","tap-to-continue":"","character-uppercase":"",next:"",unreach:"","reach-2500-scores":" 2,500 ","collect-50-coins":" 50 ","jump-1000-times":" 1,000 ","unlock-level-5":" 5","reach-5000-scores":" 5,000 ","play-40-games":" 40 ","collect-100-coins":" 100 ","jump-2000-times":" 2,000 ","unlock-level-10":" 10","reach-10000-scores":" 10,000 ","play-100-games":" 100 ","collect-150-coins":" 150 ","jump-5000-times":" 5,000 ","unlock-level-15":" 15",levels:"","endless-mode":"",continue:"","continue-ask":"?","open-daily-challenge":"","receive-reward":"","no-thanks":"",replay:"","open-shop":"","click-to-skin":"","click-to-buy":"","swipe-up-to-jump":"","swipe-down-to-crouch":"","press-arrow-up-to-jump":"","press-arrow-down-to-crouch":"","open-level":"","click-to-play":"","back-to-home":""}},{info:{locale:"zh"},messages:{loading:"",victory:"",defeat:"",challenge:"",shop:"",setting:"","press-arrow-up-to-start":"","tap-to-start":"","daily-challenge":"","reach-scores":" {number} ","reach-levels":" {number} ","collect-coins":" {number} ","jump-times":" {number} ","unlock-a-new-level":"","unlock-a-new-skin":"",claim:"",claimed:"","game-over":"",collected:"",home:"",restart:"",skin:"","unlock-now":"",complete:"","claim-x2":"x2",sound:"",vibration:"",language:"","press-arrow-up-to-continue":"","tap-to-continue":"","character-uppercase":"",next:"",unreach:"","reach-2500-scores":" 2500 ","collect-50-coins":" 50 ","jump-1000-times":"1000","unlock-level-5":"5","reach-5000-scores":" 5000 ","play-40-games":" 40 ","collect-100-coins":" 100 ","jump-2000-times":"2000","unlock-level-10":"10","reach-10000-scores":" 10000 ","play-100-games":" 100 ","collect-150-coins":" 150 ","jump-5000-times":"5000","unlock-level-15":"15",levels:"","endless-mode":"",continue:"","continue-ask":"","open-daily-challenge":"","receive-reward":"","no-thanks":"",replay:"","open-shop":"","click-to-skin":"","click-to-buy":"","swipe-up-to-jump":"","swipe-down-to-crouch":"","press-arrow-up-to-jump":"","press-arrow-down-to-crouch":"","open-level":"","click-to-play":"","back-to-home":""}},{info:{locale:"pl"},messages:{loading:"adowanie",victory:"Zwycistwo",defeat:"Pokona",challenge:"Wyzwanie",shop:"Sklep",setting:"Ustawienie","press-arrow-up-to-start":"NACINIJ STRZAK W GR, ABY ROZPOCZ","tap-to-start":"NACINIJ ABY ZACZ","daily-challenge":"WYZWANIE DNIA","reach-scores":"Zdobd {number} punktw","reach-levels":"Zagraj w gry w liczbie {number}","collect-coins":"Zbierz {number} monet","jump-times":"Skocz {numer} razy","unlock-a-new-level":"Odblokuj nowy poziom","unlock-a-new-skin":"Odblokuj now skrk",claim:"Prawo",claimed:"Przejte","game-over":"KONIEC GRY",collected:"Zebrane",home:"Dom",restart:"Uruchom ponownie",skin:"SKRA","unlock-now":"ODBLOKOWA",complete:"ZAKOCZONY","claim-x2":"Odbierz x2",sound:"Dwik",vibration:"Wibracja",language:"Jzyk","press-arrow-up-to-continue":"NACINIJ STRZAK W GR, ABY KONTYNUOWA","tap-to-continue":"KLIKNIJ, ABY KONTYNUOWA","character-uppercase":"POSTA",next:"Nastpny",unreach:"Niedosign","reach-2500-scores":"Zdobd 2500 punktw","collect-50-coins":"Zbierz 50 monet","jump-1000-times":"Skocz 1000 razy","unlock-level-5":"Odblokuj poziom 5","reach-5000-scores":"Zdobd 5000 wynikw","play-40-games":"Zagraj w 40 gier","collect-100-coins":"Zbierz 100 monet","jump-2000-times":"Skocz 2000 razy","unlock-level-10":"Odblokuj poziom 10","reach-10000-scores":"Zdobd 10000 wynikw","play-100-games":"Zagraj w 100 gier","collect-150-coins":"Zbierz 150 monet","jump-5000-times":"Skocz 5000 razy","unlock-level-15":"Odblokuj poziom 15",levels:"Poziomy","endless-mode":"Tryb nieskoczony",continue:"Kontynuowa","continue-ask":"KONTYNUOWA?","open-daily-challenge":"Otwrz codzienne wyzwanie","receive-reward":"Odbierz nagrod","no-thanks":"NIE, DZIKUJ",replay:"Powtrna rozgrywka","open-shop":"Otwarty sklep","click-to-skin":"Kliknij, aby przej do skrki","click-to-buy":"Kliknij by kupi","swipe-up-to-jump":"Przesu w gr, aby skoczy","swipe-down-to-crouch":"Przesu w d i przytrzymaj, aby kucn","press-arrow-up-to-jump":"Nacinij strzak w gr, aby skoczy","press-arrow-down-to-crouch":"Nacinij strzak w d i przytrzymaj, aby kucn","open-level":"Poziom otwarty","click-to-play":"Kliknij aby zagra","back-to-home":"Wrci do domu"}},{info:{locale:"ro"},messages:{loading:"Se ncarc",victory:"Victorie",defeat:"nfrngere",challenge:"Provocare",shop:"Magazin",setting:"Setare","press-arrow-up-to-start":"APSAI SGEAT SUS PENTRU A NCEPE","tap-to-start":"Atingei pentru a ncepe","daily-challenge":"PROVOCARE ZILNIC","reach-scores":"Atingei {number} scoruri","reach-levels":"Joac {number} jocuri","collect-coins":"Strngei {numr} monede","jump-times":"Sari de {number} ori","unlock-a-new-level":"Deblocai un nou nivel","unlock-a-new-skin":"Deblocai o nou piele",claim:"Revendicare",claimed:"Revendicat","game-over":"JOC NCHEIAT",collected:"Colectat",home:"Acas",restart:"Repornire",skin:"PIELE","unlock-now":"DEBLOCARE",complete:"EFECTUAT","claim-x2":"Revendicare x2",sound:"Sunet",vibration:"Vibraie",language:"Limba","press-arrow-up-to-continue":"APSAI SGEAT SUS PENTRU A CONTINUA","tap-to-continue":"APAS PENTRU A CONTINUA","character-uppercase":"CARACTER",next:"Urmtorul",unreach:"Neajuns","reach-2500-scores":"Atinge 2500 de scoruri","collect-50-coins":"Strngei 50 de monede","jump-1000-times":"Sari de 1000 de ori","unlock-level-5":"Deblocai nivelul 5","reach-5000-scores":"Atinge 5000 de scoruri","play-40-games":"Joac 40 de jocuri","collect-100-coins":"Strngei 100 de monede","jump-2000-times":"Sari de 2000 de ori","unlock-level-10":"Deblocai nivelul 10","reach-10000-scores":"Atinge 10000 de scoruri","play-100-games":"Joac 100 de jocuri","collect-150-coins":"Strngei 150 de monede","jump-5000-times":"Sari de 5000 de ori","unlock-level-15":"Deblocai nivelul 15",levels:"Niveluri","endless-mode":"Modul fr sfrit",continue:"Continua","continue-ask":"CONTINUA?","open-daily-challenge":"Deschidei provocarea zilnic","receive-reward":"Primii recompens","no-thanks":"NU, MULUMESC",replay:"Reluare","open-shop":"Deschide magazinul","click-to-skin":"Facei clic pe piele","click-to-buy":"Facei clic pentru a cumpra","swipe-up-to-jump":"Glisai n sus pentru a sri","swipe-down-to-crouch":"Glisai n jos i inei apsat pentru a v ghemui","press-arrow-up-to-jump":"Apsai sgeata n sus pentru a sri","press-arrow-down-to-crouch":"Apsai sgeata n jos i inei apsat pentru a v ghemui","open-level":"Nivel deschis","click-to-play":"Facei clic pentru a juca","back-to-home":"napoi acas"}}],BG={header:FG,data:kG};class mw{static config(){this.scene=Z.app.scene,this._configScene()}static _configScene(){this.configAmbientLight(new y(200,200,200)),this.scene.gammaCorrection=Hy}static configAmbientLight(e){this.scene.ambientLight=ve.createColor(e.x,e.y,e.z)}static configLocalize(){Z.app.i18n.addData(BG)}}var _w={};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const GE=function(r){const e=[];let t=0;for(let s=0;s<r.length;s++){let i=r.charCodeAt(s);i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&s+1<r.length&&(r.charCodeAt(s+1)&64512)===56320?(i=65536+((i&1023)<<10)+(r.charCodeAt(++s)&1023),e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e},NG=function(r){const e=[];let t=0,s=0;for(;t<r.length;){const i=r[t++];if(i<128)e[s++]=String.fromCharCode(i);else if(i>191&&i<224){const n=r[t++];e[s++]=String.fromCharCode((i&31)<<6|n&63)}else if(i>239&&i<365){const n=r[t++],a=r[t++],o=r[t++],l=((i&7)<<18|(n&63)<<12|(a&63)<<6|o&63)-65536;e[s++]=String.fromCharCode(55296+(l>>10)),e[s++]=String.fromCharCode(56320+(l&1023))}else{const n=r[t++],a=r[t++];e[s++]=String.fromCharCode((i&15)<<12|(n&63)<<6|a&63)}}return e.join("")},HE={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(r,e){if(!Array.isArray(r))throw Error("encodeByteArray takes an array as a parameter");this.init_();const t=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,s=[];for(let i=0;i<r.length;i+=3){const n=r[i],a=i+1<r.length,o=a?r[i+1]:0,l=i+2<r.length,c=l?r[i+2]:0,d=n>>2,h=(n&3)<<4|o>>4;let u=(o&15)<<2|c>>6,f=c&63;l||(f=64,a||(u=64)),s.push(t[d],t[h],t[u],t[f])}return s.join("")},encodeString(r,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(r):this.encodeByteArray(GE(r),e)},decodeString(r,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(r):NG(this.decodeStringToByteArray(r,e))},decodeStringToByteArray(r,e){this.init_();const t=e?this.charToByteMapWebSafe_:this.charToByteMap_,s=[];for(let i=0;i<r.length;){const n=t[r.charAt(i++)],o=i<r.length?t[r.charAt(i)]:0;++i;const c=i<r.length?t[r.charAt(i)]:64;++i;const h=i<r.length?t[r.charAt(i)]:64;if(++i,n==null||o==null||c==null||h==null)throw new UG;const u=n<<2|o>>4;if(s.push(u),c!==64){const f=o<<4&240|c>>2;if(s.push(f),h!==64){const p=c<<6&192|h;s.push(p)}}}return s},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let r=0;r<this.ENCODED_VALS.length;r++)this.byteToCharMap_[r]=this.ENCODED_VALS.charAt(r),this.charToByteMap_[this.byteToCharMap_[r]]=r,this.byteToCharMapWebSafe_[r]=this.ENCODED_VALS_WEBSAFE.charAt(r),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[r]]=r,r>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(r)]=r,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(r)]=r)}}};class UG extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const zG=function(r){const e=GE(r);return HE.encodeByteArray(e,!0)},WE=function(r){return zG(r).replace(/\./g,"")},VG=function(r){try{return HE.decodeString(r,!0)}catch(e){console.error("base64Decode failed: ",e)}return null};/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function GG(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const HG=()=>GG().__FIREBASE_DEFAULTS__,WG=()=>{if(typeof process>"u"||typeof _w>"u")return;const r=_w.__FIREBASE_DEFAULTS__;if(r)return JSON.parse(r)},jG=()=>{if(typeof document>"u")return;let r;try{r=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const e=r&&VG(r[1]);return e&&JSON.parse(e)},$G=()=>{try{return HG()||WG()||jG()}catch(r){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${r}`);return}},jE=()=>{var r;return(r=$G())===null||r===void 0?void 0:r.config};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class XG{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}wrapCallback(e){return(t,s)=>{t?this.reject(t):this.resolve(s),typeof e=="function"&&(this.promise.catch(()=>{}),e.length===1?e(t):e(t,s))}}}function qG(){const r=typeof chrome=="object"?chrome.runtime:typeof browser=="object"?browser.runtime:void 0;return typeof r=="object"&&r.id!==void 0}function $E(){try{return typeof indexedDB=="object"}catch{return!1}}function XE(){return new Promise((r,e)=>{try{let t=!0;const s="validate-browser-context-for-indexeddb-analytics-module",i=self.indexedDB.open(s);i.onsuccess=()=>{i.result.close(),t||self.indexedDB.deleteDatabase(s),r(!0)},i.onupgradeneeded=()=>{t=!1},i.onerror=()=>{var n;e(((n=i.error)===null||n===void 0?void 0:n.message)||"")}}catch(t){e(t)}})}function KG(){return!(typeof navigator>"u"||!navigator.cookieEnabled)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const YG="FirebaseError";class mo extends Error{constructor(e,t,s){super(t),this.code=e,this.customData=s,this.name=YG,Object.setPrototypeOf(this,mo.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,rm.prototype.create)}}class rm{constructor(e,t,s){this.service=e,this.serviceName=t,this.errors=s}create(e,...t){const s=t[0]||{},i=`${this.service}/${e}`,n=this.errors[e],a=n?ZG(n,s):"Error",o=`${this.serviceName}: ${a} (${i}).`;return new mo(i,o,s)}}function ZG(r,e){return r.replace(JG,(t,s)=>{const i=e[s];return i!=null?String(i):`<${s}?>`})}const JG=/\{\$([^}]+)}/g;function Of(r,e){if(r===e)return!0;const t=Object.keys(r),s=Object.keys(e);for(const i of t){if(!s.includes(i))return!1;const n=r[i],a=e[i];if(gw(n)&&gw(a)){if(!Of(n,a))return!1}else if(n!==a)return!1}for(const i of s)if(!t.includes(i))return!1;return!0}function gw(r){return r!==null&&typeof r=="object"}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const QG=1e3,e4=2,t4=4*60*60*1e3,s4=.5;function yw(r,e=QG,t=e4){const s=e*Math.pow(t,r),i=Math.round(s4*s*(Math.random()-.5)*2);return Math.min(t4,s+i)}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function qE(r){return r&&r._delegate?r._delegate:r}class Vr{constructor(e,t,s){this.name=e,this.instanceFactory=t,this.type=s,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ma="[DEFAULT]";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class i4{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const s=new XG;if(this.instancesDeferred.set(t,s),this.isInitialized(t)||this.shouldAutoInitialize())try{const i=this.getOrInitializeService({instanceIdentifier:t});i&&s.resolve(i)}catch{}}return this.instancesDeferred.get(t).promise}getImmediate(e){var t;const s=this.normalizeInstanceIdentifier(e==null?void 0:e.identifier),i=(t=e==null?void 0:e.optional)!==null&&t!==void 0?t:!1;if(this.isInitialized(s)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:s})}catch(n){if(i)return null;throw n}else{if(i)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,!!this.shouldAutoInitialize()){if(r4(e))try{this.getOrInitializeService({instanceIdentifier:ma})}catch{}for(const[t,s]of this.instancesDeferred.entries()){const i=this.normalizeInstanceIdentifier(t);try{const n=this.getOrInitializeService({instanceIdentifier:i});s.resolve(n)}catch{}}}}clearInstance(e=ma){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter(t=>"INTERNAL"in t).map(t=>t.INTERNAL.delete()),...e.filter(t=>"_delete"in t).map(t=>t._delete())])}isComponentSet(){return this.component!=null}isInitialized(e=ma){return this.instances.has(e)}getOptions(e=ma){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:t={}}=e,s=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(s))throw Error(`${this.name}(${s}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const i=this.getOrInitializeService({instanceIdentifier:s,options:t});for(const[n,a]of this.instancesDeferred.entries()){const o=this.normalizeInstanceIdentifier(n);s===o&&a.resolve(i)}return i}onInit(e,t){var s;const i=this.normalizeInstanceIdentifier(t),n=(s=this.onInitCallbacks.get(i))!==null&&s!==void 0?s:new Set;n.add(e),this.onInitCallbacks.set(i,n);const a=this.instances.get(i);return a&&e(a,i),()=>{n.delete(e)}}invokeOnInitCallbacks(e,t){const s=this.onInitCallbacks.get(t);if(s)for(const i of s)try{i(e,t)}catch{}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let s=this.instances.get(e);if(!s&&this.component&&(s=this.component.instanceFactory(this.container,{instanceIdentifier:n4(e),options:t}),this.instances.set(e,s),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(s,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,s)}catch{}return s||null}normalizeInstanceIdentifier(e=ma){return this.component?this.component.multipleInstances?e:ma:e}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function n4(r){return r===ma?void 0:r}function r4(r){return r.instantiationMode==="EAGER"}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class a4{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new i4(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var et;(function(r){r[r.DEBUG=0]="DEBUG",r[r.VERBOSE=1]="VERBOSE",r[r.INFO=2]="INFO",r[r.WARN=3]="WARN",r[r.ERROR=4]="ERROR",r[r.SILENT=5]="SILENT"})(et||(et={}));const o4={debug:et.DEBUG,verbose:et.VERBOSE,info:et.INFO,warn:et.WARN,error:et.ERROR,silent:et.SILENT},l4=et.INFO,h4={[et.DEBUG]:"log",[et.VERBOSE]:"log",[et.INFO]:"info",[et.WARN]:"warn",[et.ERROR]:"error"},c4=(r,e,...t)=>{if(e<r.logLevel)return;const s=new Date().toISOString(),i=h4[e];if(i)console[i](`[${s}]  ${r.name}:`,...t);else throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`)};class KE{constructor(e){this.name=e,this._logLevel=l4,this._logHandler=c4,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in et))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel=typeof e=="string"?o4[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if(typeof e!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,et.DEBUG,...e),this._logHandler(this,et.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,et.VERBOSE,...e),this._logHandler(this,et.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,et.INFO,...e),this._logHandler(this,et.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,et.WARN,...e),this._logHandler(this,et.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,et.ERROR,...e),this._logHandler(this,et.ERROR,...e)}}const d4=(r,e)=>e.some(t=>r instanceof t);let vw,Sw;function u4(){return vw||(vw=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function f4(){return Sw||(Sw=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const YE=new WeakMap,Zg=new WeakMap,ZE=new WeakMap,C_=new WeakMap,O0=new WeakMap;function p4(r){const e=new Promise((t,s)=>{const i=()=>{r.removeEventListener("success",n),r.removeEventListener("error",a)},n=()=>{t(Mr(r.result)),i()},a=()=>{s(r.error),i()};r.addEventListener("success",n),r.addEventListener("error",a)});return e.then(t=>{t instanceof IDBCursor&&YE.set(t,r)}).catch(()=>{}),O0.set(e,r),e}function m4(r){if(Zg.has(r))return;const e=new Promise((t,s)=>{const i=()=>{r.removeEventListener("complete",n),r.removeEventListener("error",a),r.removeEventListener("abort",a)},n=()=>{t(),i()},a=()=>{s(r.error||new DOMException("AbortError","AbortError")),i()};r.addEventListener("complete",n),r.addEventListener("error",a),r.addEventListener("abort",a)});Zg.set(r,e)}let Jg={get(r,e,t){if(r instanceof IDBTransaction){if(e==="done")return Zg.get(r);if(e==="objectStoreNames")return r.objectStoreNames||ZE.get(r);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return Mr(r[e])},set(r,e,t){return r[e]=t,!0},has(r,e){return r instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in r}};function _4(r){Jg=r(Jg)}function g4(r){return r===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){const s=r.call(A_(this),e,...t);return ZE.set(s,e.sort?e.sort():[e]),Mr(s)}:f4().includes(r)?function(...e){return r.apply(A_(this),e),Mr(YE.get(this))}:function(...e){return Mr(r.apply(A_(this),e))}}function y4(r){return typeof r=="function"?g4(r):(r instanceof IDBTransaction&&m4(r),d4(r,u4())?new Proxy(r,Jg):r)}function Mr(r){if(r instanceof IDBRequest)return p4(r);if(C_.has(r))return C_.get(r);const e=y4(r);return e!==r&&(C_.set(r,e),O0.set(e,r)),e}const A_=r=>O0.get(r);function JE(r,e,{blocked:t,upgrade:s,blocking:i,terminated:n}={}){const a=indexedDB.open(r,e),o=Mr(a);return s&&a.addEventListener("upgradeneeded",l=>{s(Mr(a.result),l.oldVersion,l.newVersion,Mr(a.transaction),l)}),t&&a.addEventListener("blocked",l=>t(l.oldVersion,l.newVersion,l)),o.then(l=>{n&&l.addEventListener("close",()=>n()),i&&l.addEventListener("versionchange",c=>i(c.oldVersion,c.newVersion,c))}).catch(()=>{}),o}const v4=["get","getKey","getAll","getAllKeys","count"],S4=["put","add","delete","clear"],P_=new Map;function xw(r,e){if(!(r instanceof IDBDatabase&&!(e in r)&&typeof e=="string"))return;if(P_.get(e))return P_.get(e);const t=e.replace(/FromIndex$/,""),s=e!==t,i=S4.includes(t);if(!(t in(s?IDBIndex:IDBObjectStore).prototype)||!(i||v4.includes(t)))return;const n=async function(a,...o){const l=this.transaction(a,i?"readwrite":"readonly");let c=l.store;return s&&(c=c.index(o.shift())),(await Promise.all([c[t](...o),i&&l.done]))[0]};return P_.set(e,n),n}_4(r=>({...r,get:(e,t,s)=>xw(e,t)||r.get(e,t,s),has:(e,t)=>!!xw(e,t)||r.has(e,t)}));/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class x4{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map(t=>{if(w4(t)){const s=t.getImmediate();return`${s.library}/${s.version}`}else return null}).filter(t=>t).join(" ")}}function w4(r){const e=r.getComponent();return(e==null?void 0:e.type)==="VERSION"}const Qg="@firebase/app",ww="0.10.7";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const to=new KE("@firebase/app"),b4="@firebase/app-compat",T4="@firebase/analytics-compat",E4="@firebase/analytics",C4="@firebase/app-check-compat",A4="@firebase/app-check",P4="@firebase/auth",M4="@firebase/auth-compat",I4="@firebase/database",R4="@firebase/database-compat",L4="@firebase/functions",D4="@firebase/functions-compat",O4="@firebase/installations",F4="@firebase/installations-compat",k4="@firebase/messaging",B4="@firebase/messaging-compat",N4="@firebase/performance",U4="@firebase/performance-compat",z4="@firebase/remote-config",V4="@firebase/remote-config-compat",G4="@firebase/storage",H4="@firebase/storage-compat",W4="@firebase/firestore",j4="@firebase/vertexai-preview",$4="@firebase/firestore-compat",X4="firebase";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ey="[DEFAULT]",q4={[Qg]:"fire-core",[b4]:"fire-core-compat",[E4]:"fire-analytics",[T4]:"fire-analytics-compat",[A4]:"fire-app-check",[C4]:"fire-app-check-compat",[P4]:"fire-auth",[M4]:"fire-auth-compat",[I4]:"fire-rtdb",[R4]:"fire-rtdb-compat",[L4]:"fire-fn",[D4]:"fire-fn-compat",[O4]:"fire-iid",[F4]:"fire-iid-compat",[k4]:"fire-fcm",[B4]:"fire-fcm-compat",[N4]:"fire-perf",[U4]:"fire-perf-compat",[z4]:"fire-rc",[V4]:"fire-rc-compat",[G4]:"fire-gcs",[H4]:"fire-gcs-compat",[W4]:"fire-fst",[$4]:"fire-fst-compat",[j4]:"fire-vertex","fire-js":"fire-js",[X4]:"fire-js-all"};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ff=new Map,K4=new Map,ty=new Map;function bw(r,e){try{r.container.addComponent(e)}catch(t){to.debug(`Component ${e.name} failed to register with FirebaseApp ${r.name}`,t)}}function so(r){const e=r.name;if(ty.has(e))return to.debug(`There were multiple attempts to register component ${e}.`),!1;ty.set(e,r);for(const t of Ff.values())bw(t,r);for(const t of K4.values())bw(t,r);return!0}function am(r,e){const t=r.container.getProvider("heartbeat").getImmediate({optional:!0});return t&&t.triggerHeartbeat(),r.container.getProvider(e)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Y4={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},Ir=new rm("app","Firebase",Y4);/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Z4{constructor(e,t,s){this._isDeleted=!1,this._options=Object.assign({},e),this._config=Object.assign({},t),this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=s,this.container.addComponent(new Vr("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw Ir.create("app-deleted",{appName:this._name})}}function QE(r,e={}){let t=r;typeof e!="object"&&(e={name:e});const s=Object.assign({name:ey,automaticDataCollectionEnabled:!1},e),i=s.name;if(typeof i!="string"||!i)throw Ir.create("bad-app-name",{appName:String(i)});if(t||(t=jE()),!t)throw Ir.create("no-options");const n=Ff.get(i);if(n){if(Of(t,n.options)&&Of(s,n.config))return n;throw Ir.create("duplicate-app",{appName:i})}const a=new a4(i);for(const l of ty.values())a.addComponent(l);const o=new Z4(t,s,a);return Ff.set(i,o),o}function J4(r=ey){const e=Ff.get(r);if(!e&&r===ey&&jE())return QE();if(!e)throw Ir.create("no-app",{appName:r});return e}function Rr(r,e,t){var s;let i=(s=q4[r])!==null&&s!==void 0?s:r;t&&(i+=`-${t}`);const n=i.match(/\s|\//),a=e.match(/\s|\//);if(n||a){const o=[`Unable to register library "${i}" with version "${e}":`];n&&o.push(`library name "${i}" contains illegal characters (whitespace or "/")`),n&&a&&o.push("and"),a&&o.push(`version name "${e}" contains illegal characters (whitespace or "/")`),to.warn(o.join(" "));return}so(new Vr(`${i}-version`,()=>({library:i,version:e}),"VERSION"))}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Q4="firebase-heartbeat-database",eH=1,jc="firebase-heartbeat-store";let M_=null;function eC(){return M_||(M_=JE(Q4,eH,{upgrade:(r,e)=>{switch(e){case 0:try{r.createObjectStore(jc)}catch(t){console.warn(t)}}}}).catch(r=>{throw Ir.create("idb-open",{originalErrorMessage:r.message})})),M_}async function tH(r){try{const t=(await eC()).transaction(jc),s=await t.objectStore(jc).get(tC(r));return await t.done,s}catch(e){if(e instanceof mo)to.warn(e.message);else{const t=Ir.create("idb-get",{originalErrorMessage:e==null?void 0:e.message});to.warn(t.message)}}}async function Tw(r,e){try{const s=(await eC()).transaction(jc,"readwrite");await s.objectStore(jc).put(e,tC(r)),await s.done}catch(t){if(t instanceof mo)to.warn(t.message);else{const s=Ir.create("idb-set",{originalErrorMessage:t==null?void 0:t.message});to.warn(s.message)}}}function tC(r){return`${r.name}!${r.options.appId}`}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const sH=1024,iH=30*24*60*60*1e3;class nH{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new aH(t),this._heartbeatsCachePromise=this._storage.read().then(s=>(this._heartbeatsCache=s,s))}async triggerHeartbeat(){var e,t;const i=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),n=Ew();if(!(((e=this._heartbeatsCache)===null||e===void 0?void 0:e.heartbeats)==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null))&&!(this._heartbeatsCache.lastSentHeartbeatDate===n||this._heartbeatsCache.heartbeats.some(a=>a.date===n)))return this._heartbeatsCache.heartbeats.push({date:n,agent:i}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter(a=>{const o=new Date(a.date).valueOf();return Date.now()-o<=iH}),this._storage.overwrite(this._heartbeatsCache)}async getHeartbeatsHeader(){var e;if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,((e=this._heartbeatsCache)===null||e===void 0?void 0:e.heartbeats)==null||this._heartbeatsCache.heartbeats.length===0)return"";const t=Ew(),{heartbeatsToSend:s,unsentEntries:i}=rH(this._heartbeatsCache.heartbeats),n=WE(JSON.stringify({version:2,heartbeats:s}));return this._heartbeatsCache.lastSentHeartbeatDate=t,i.length>0?(this._heartbeatsCache.heartbeats=i,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),n}}function Ew(){return new Date().toISOString().substring(0,10)}function rH(r,e=sH){const t=[];let s=r.slice();for(const i of r){const n=t.find(a=>a.agent===i.agent);if(n){if(n.dates.push(i.date),Cw(t)>e){n.dates.pop();break}}else if(t.push({agent:i.agent,dates:[i.date]}),Cw(t)>e){t.pop();break}s=s.slice(1)}return{heartbeatsToSend:t,unsentEntries:s}}class aH{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return $E()?XE().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const t=await tH(this.app);return t!=null&&t.heartbeats?t:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(e){var t;if(await this._canUseIndexedDBPromise){const i=await this.read();return Tw(this.app,{lastSentHeartbeatDate:(t=e.lastSentHeartbeatDate)!==null&&t!==void 0?t:i.lastSentHeartbeatDate,heartbeats:e.heartbeats})}else return}async add(e){var t;if(await this._canUseIndexedDBPromise){const i=await this.read();return Tw(this.app,{lastSentHeartbeatDate:(t=e.lastSentHeartbeatDate)!==null&&t!==void 0?t:i.lastSentHeartbeatDate,heartbeats:[...i.heartbeats,...e.heartbeats]})}else return}}function Cw(r){return WE(JSON.stringify({version:2,heartbeats:r})).length}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function oH(r){so(new Vr("platform-logger",e=>new x4(e),"PRIVATE")),so(new Vr("heartbeat",e=>new nH(e),"PRIVATE")),Rr(Qg,ww,r),Rr(Qg,ww,"esm2017"),Rr("fire-js","")}oH("");var lH="firebase",hH="10.12.4";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Rr(lH,hH,"app");/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */const cH={};/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */function Lu(r){return Object.isFrozen(r)&&Object.isFrozen(r.raw)}function Du(r){return r.toString().indexOf("`")===-1}Du(r=>r``)||Du(r=>r`\0`)||Du(r=>r`\n`)||Du(r=>r`\u0000`);Lu``&&Lu`\0`&&Lu`\n`&&Lu`\u0000`;/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */let sC="google#safe";function dH(){if(typeof window<"u")return window.trustedTypes}function iC(){var r;return sC!==""&&(r=dH())!==null&&r!==void 0?r:null}let Ou;function uH(){var r,e;if(Ou===void 0)try{Ou=(e=(r=iC())===null||r===void 0?void 0:r.createPolicy(sC,{createHTML:t=>t,createScript:t=>t,createScriptURL:t=>t}))!==null&&e!==void 0?e:null}catch{Ou=null}return Ou}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */class nC{constructor(e,t){this.privateDoNotAccessOrElseWrappedResourceUrl=e}toString(){return this.privateDoNotAccessOrElseWrappedResourceUrl.toString()}}function Aw(r){var e;const t=r,s=(e=uH())===null||e===void 0?void 0:e.createScriptURL(t);return s??new nC(t,cH)}function fH(r){var e;if(!((e=iC())===null||e===void 0)&&e.isScriptURL(r))return r;if(r instanceof nC)return r.privateDoNotAccessOrElseWrappedResourceUrl;{let t="";throw new Error(t)}}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */function pH(r,...e){if(e.length===0)return Aw(r[0]);r[0].toLowerCase();let t=r[0];for(let s=0;s<e.length;s++)t+=encodeURIComponent(e[s])+r[s+1];return Aw(t)}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */function mH(r){return _H("script",r)}function _H(r,e){var t;const s=e.document,i=(t=s.querySelector)===null||t===void 0?void 0:t.call(s,`${r}[nonce]`);return i&&(i.nonce||i.getAttribute("nonce"))||""}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */function gH(r){const e=r.ownerDocument&&r.ownerDocument.defaultView,t=mH(e||window);t&&r.setAttribute("nonce",t)}function yH(r,e,t){r.src=fH(e),!(t!=null&&t.omitNonce)&&gH(r)}const rC="@firebase/installations",F0="0.6.8";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const aC=1e4,oC=`w:${F0}`,lC="FIS_v2",vH="https://firebaseinstallations.googleapis.com/v1",SH=60*60*1e3,xH="installations",wH="Installations";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const bH={"missing-app-config-values":'Missing App configuration value: "{$valueName}"',"not-registered":"Firebase Installation is not registered.","installation-not-found":"Firebase Installation not found.","request-failed":'{$requestName} request failed with error "{$serverCode} {$serverStatus}: {$serverMessage}"',"app-offline":"Could not process request. Application offline.","delete-pending-registration":"Can't delete installation while there is a pending registration request."},io=new rm(xH,wH,bH);function hC(r){return r instanceof mo&&r.code.includes("request-failed")}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function cC({projectId:r}){return`${vH}/projects/${r}/installations`}function dC(r){return{token:r.token,requestStatus:2,expiresIn:EH(r.expiresIn),creationTime:Date.now()}}async function uC(r,e){const s=(await e.json()).error;return io.create("request-failed",{requestName:r,serverCode:s.code,serverMessage:s.message,serverStatus:s.status})}function fC({apiKey:r}){return new Headers({"Content-Type":"application/json",Accept:"application/json","x-goog-api-key":r})}function TH(r,{refreshToken:e}){const t=fC(r);return t.append("Authorization",CH(e)),t}async function pC(r){const e=await r();return e.status>=500&&e.status<600?r():e}function EH(r){return Number(r.replace("s","000"))}function CH(r){return`${lC} ${r}`}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function AH({appConfig:r,heartbeatServiceProvider:e},{fid:t}){const s=cC(r),i=fC(r),n=e.getImmediate({optional:!0});if(n){const c=await n.getHeartbeatsHeader();c&&i.append("x-firebase-client",c)}const a={fid:t,authVersion:lC,appId:r.appId,sdkVersion:oC},o={method:"POST",headers:i,body:JSON.stringify(a)},l=await pC(()=>fetch(s,o));if(l.ok){const c=await l.json();return{fid:c.fid||t,registrationStatus:2,refreshToken:c.refreshToken,authToken:dC(c.authToken)}}else throw await uC("Create Installation",l)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function mC(r){return new Promise(e=>{setTimeout(e,r)})}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function PH(r){return btoa(String.fromCharCode(...r)).replace(/\+/g,"-").replace(/\//g,"_")}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const MH=/^[cdef][\w-]{21}$/,sy="";function IH(){try{const r=new Uint8Array(17);(self.crypto||self.msCrypto).getRandomValues(r),r[0]=112+r[0]%16;const t=RH(r);return MH.test(t)?t:sy}catch{return sy}}function RH(r){return PH(r).substr(0,22)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function om(r){return`${r.appName}!${r.appId}`}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const _C=new Map;function gC(r,e){const t=om(r);yC(t,e),LH(t,e)}function yC(r,e){const t=_C.get(r);if(t)for(const s of t)s(e)}function LH(r,e){const t=DH();t&&t.postMessage({key:r,fid:e}),OH()}let Pa=null;function DH(){return!Pa&&"BroadcastChannel"in self&&(Pa=new BroadcastChannel("[Firebase] FID Change"),Pa.onmessage=r=>{yC(r.data.key,r.data.fid)}),Pa}function OH(){_C.size===0&&Pa&&(Pa.close(),Pa=null)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const FH="firebase-installations-database",kH=1,no="firebase-installations-store";let I_=null;function k0(){return I_||(I_=JE(FH,kH,{upgrade:(r,e)=>{switch(e){case 0:r.createObjectStore(no)}}})),I_}async function kf(r,e){const t=om(r),i=(await k0()).transaction(no,"readwrite"),n=i.objectStore(no),a=await n.get(t);return await n.put(e,t),await i.done,(!a||a.fid!==e.fid)&&gC(r,e.fid),e}async function vC(r){const e=om(r),s=(await k0()).transaction(no,"readwrite");await s.objectStore(no).delete(e),await s.done}async function lm(r,e){const t=om(r),i=(await k0()).transaction(no,"readwrite"),n=i.objectStore(no),a=await n.get(t),o=e(a);return o===void 0?await n.delete(t):await n.put(o,t),await i.done,o&&(!a||a.fid!==o.fid)&&gC(r,o.fid),o}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function B0(r){let e;const t=await lm(r.appConfig,s=>{const i=BH(s),n=NH(r,i);return e=n.registrationPromise,n.installationEntry});return t.fid===sy?{installationEntry:await e}:{installationEntry:t,registrationPromise:e}}function BH(r){const e=r||{fid:IH(),registrationStatus:0};return SC(e)}function NH(r,e){if(e.registrationStatus===0){if(!navigator.onLine){const i=Promise.reject(io.create("app-offline"));return{installationEntry:e,registrationPromise:i}}const t={fid:e.fid,registrationStatus:1,registrationTime:Date.now()},s=UH(r,t);return{installationEntry:t,registrationPromise:s}}else return e.registrationStatus===1?{installationEntry:e,registrationPromise:zH(r)}:{installationEntry:e}}async function UH(r,e){try{const t=await AH(r,e);return kf(r.appConfig,t)}catch(t){throw hC(t)&&t.customData.serverCode===409?await vC(r.appConfig):await kf(r.appConfig,{fid:e.fid,registrationStatus:0}),t}}async function zH(r){let e=await Pw(r.appConfig);for(;e.registrationStatus===1;)await mC(100),e=await Pw(r.appConfig);if(e.registrationStatus===0){const{installationEntry:t,registrationPromise:s}=await B0(r);return s||t}return e}function Pw(r){return lm(r,e=>{if(!e)throw io.create("installation-not-found");return SC(e)})}function SC(r){return VH(r)?{fid:r.fid,registrationStatus:0}:r}function VH(r){return r.registrationStatus===1&&r.registrationTime+aC<Date.now()}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function GH({appConfig:r,heartbeatServiceProvider:e},t){const s=HH(r,t),i=TH(r,t),n=e.getImmediate({optional:!0});if(n){const c=await n.getHeartbeatsHeader();c&&i.append("x-firebase-client",c)}const a={installation:{sdkVersion:oC,appId:r.appId}},o={method:"POST",headers:i,body:JSON.stringify(a)},l=await pC(()=>fetch(s,o));if(l.ok){const c=await l.json();return dC(c)}else throw await uC("Generate Auth Token",l)}function HH(r,{fid:e}){return`${cC(r)}/${e}/authTokens:generate`}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function N0(r,e=!1){let t;const s=await lm(r.appConfig,n=>{if(!xC(n))throw io.create("not-registered");const a=n.authToken;if(!e&&$H(a))return n;if(a.requestStatus===1)return t=WH(r,e),n;{if(!navigator.onLine)throw io.create("app-offline");const o=qH(n);return t=jH(r,o),o}});return t?await t:s.authToken}async function WH(r,e){let t=await Mw(r.appConfig);for(;t.authToken.requestStatus===1;)await mC(100),t=await Mw(r.appConfig);const s=t.authToken;return s.requestStatus===0?N0(r,e):s}function Mw(r){return lm(r,e=>{if(!xC(e))throw io.create("not-registered");const t=e.authToken;return KH(t)?Object.assign(Object.assign({},e),{authToken:{requestStatus:0}}):e})}async function jH(r,e){try{const t=await GH(r,e),s=Object.assign(Object.assign({},e),{authToken:t});return await kf(r.appConfig,s),t}catch(t){if(hC(t)&&(t.customData.serverCode===401||t.customData.serverCode===404))await vC(r.appConfig);else{const s=Object.assign(Object.assign({},e),{authToken:{requestStatus:0}});await kf(r.appConfig,s)}throw t}}function xC(r){return r!==void 0&&r.registrationStatus===2}function $H(r){return r.requestStatus===2&&!XH(r)}function XH(r){const e=Date.now();return e<r.creationTime||r.creationTime+r.expiresIn<e+SH}function qH(r){const e={requestStatus:1,requestTime:Date.now()};return Object.assign(Object.assign({},r),{authToken:e})}function KH(r){return r.requestStatus===1&&r.requestTime+aC<Date.now()}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function YH(r){const e=r,{installationEntry:t,registrationPromise:s}=await B0(e);return s?s.catch(console.error):N0(e).catch(console.error),t.fid}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function ZH(r,e=!1){const t=r;return await JH(t),(await N0(t,e)).token}async function JH(r){const{registrationPromise:e}=await B0(r);e&&await e}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function QH(r){if(!r||!r.options)throw R_("App Configuration");if(!r.name)throw R_("App Name");const e=["projectId","apiKey","appId"];for(const t of e)if(!r.options[t])throw R_(t);return{appName:r.name,projectId:r.options.projectId,apiKey:r.options.apiKey,appId:r.options.appId}}function R_(r){return io.create("missing-app-config-values",{valueName:r})}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const wC="installations",eW="installations-internal",tW=r=>{const e=r.getProvider("app").getImmediate(),t=QH(e),s=am(e,"heartbeat");return{app:e,appConfig:t,heartbeatServiceProvider:s,_delete:()=>Promise.resolve()}},sW=r=>{const e=r.getProvider("app").getImmediate(),t=am(e,wC).getImmediate();return{getId:()=>YH(t),getToken:i=>ZH(t,i)}};function iW(){so(new Vr(wC,tW,"PUBLIC")),so(new Vr(eW,sW,"PRIVATE"))}iW();Rr(rC,F0);Rr(rC,F0,"esm2017");/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Bf="analytics",nW="firebase_id",rW="origin",aW=60*1e3,oW="https://firebase.googleapis.com/v1alpha/projects/-/apps/{app-id}/webConfig",lW="https://www.googletagmanager.com/gtag/js";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ns=new KE("@firebase/analytics");/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function bC(r){return Promise.all(r.map(e=>e.catch(t=>t)))}function hW(r,e){const t=document.createElement("script"),s=pH`https://www.googletagmanager.com/gtag/js?l=${r}&id=${e}`;yH(t,s),t.async=!0,document.head.appendChild(t)}function cW(r){let e=[];return Array.isArray(window[r])?e=window[r]:window[r]=e,e}async function dW(r,e,t,s,i,n){const a=s[i];try{if(a)await e[a];else{const l=(await bC(t)).find(c=>c.measurementId===i);l&&await e[l.appId]}}catch(o){Ns.error(o)}r("config",i,n)}async function uW(r,e,t,s,i){try{let n=[];if(i&&i.send_to){let a=i.send_to;Array.isArray(a)||(a=[a]);const o=await bC(t);for(const l of a){const c=o.find(h=>h.measurementId===l),d=c&&e[c.appId];if(d)n.push(d);else{n=[];break}}}n.length===0&&(n=Object.values(e)),await Promise.all(n),r("event",s,i||{})}catch(n){Ns.error(n)}}function fW(r,e,t,s){async function i(n,...a){try{if(n==="event"){const[o,l]=a;await uW(r,e,t,o,l)}else if(n==="config"){const[o,l]=a;await dW(r,e,t,s,o,l)}else if(n==="consent"){const[o,l]=a;r("consent",o,l)}else if(n==="get"){const[o,l,c]=a;r("get",o,l,c)}else if(n==="set"){const[o]=a;r("set",o)}else r(n,...a)}catch(o){Ns.error(o)}}return i}function pW(r,e,t,s,i){let n=function(...a){window[s].push(arguments)};return window[i]&&typeof window[i]=="function"&&(n=window[i]),window[i]=fW(n,r,e,t),{gtagCore:n,wrappedGtag:window[i]}}function mW(r){const e=window.document.getElementsByTagName("script");for(const t of Object.values(e))if(t.src&&t.src.includes(lW)&&t.src.includes(r))return t;return null}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const _W={"already-exists":"A Firebase Analytics instance with the appId {$id}  already exists. Only one Firebase Analytics instance can be created for each appId.","already-initialized":"initializeAnalytics() cannot be called again with different options than those it was initially called with. It can be called again with the same options to return the existing instance, or getAnalytics() can be used to get a reference to the already-intialized instance.","already-initialized-settings":"Firebase Analytics has already been initialized.settings() must be called before initializing any Analytics instanceor it will have no effect.","interop-component-reg-failed":"Firebase Analytics Interop Component failed to instantiate: {$reason}","invalid-analytics-context":"Firebase Analytics is not supported in this environment. Wrap initialization of analytics in analytics.isSupported() to prevent initialization in unsupported environments. Details: {$errorInfo}","indexeddb-unavailable":"IndexedDB unavailable or restricted in this environment. Wrap initialization of analytics in analytics.isSupported() to prevent initialization in unsupported environments. Details: {$errorInfo}","fetch-throttle":"The config fetch request timed out while in an exponential backoff state. Unix timestamp in milliseconds when fetch request throttling ends: {$throttleEndTimeMillis}.","config-fetch-failed":"Dynamic config fetch failed: [{$httpStatus}] {$responseMessage}","no-api-key":'The "apiKey" field is empty in the local Firebase config. Firebase Analytics requires this field tocontain a valid API key.',"no-app-id":'The "appId" field is empty in the local Firebase config. Firebase Analytics requires this field tocontain a valid app ID.',"no-client-id":'The "client_id" field is empty.',"invalid-gtag-resource":"Trusted Types detected an invalid gtag resource: {$gtagURL}."},li=new rm("analytics","Analytics",_W);/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const gW=30,yW=1e3;class vW{constructor(e={},t=yW){this.throttleMetadata=e,this.intervalMillis=t}getThrottleMetadata(e){return this.throttleMetadata[e]}setThrottleMetadata(e,t){this.throttleMetadata[e]=t}deleteThrottleMetadata(e){delete this.throttleMetadata[e]}}const TC=new vW;function SW(r){return new Headers({Accept:"application/json","x-goog-api-key":r})}async function xW(r){var e;const{appId:t,apiKey:s}=r,i={method:"GET",headers:SW(s)},n=oW.replace("{app-id}",t),a=await fetch(n,i);if(a.status!==200&&a.status!==304){let o="";try{const l=await a.json();!((e=l.error)===null||e===void 0)&&e.message&&(o=l.error.message)}catch{}throw li.create("config-fetch-failed",{httpStatus:a.status,responseMessage:o})}return a.json()}async function wW(r,e=TC,t){const{appId:s,apiKey:i,measurementId:n}=r.options;if(!s)throw li.create("no-app-id");if(!i){if(n)return{measurementId:n,appId:s};throw li.create("no-api-key")}const a=e.getThrottleMetadata(s)||{backoffCount:0,throttleEndTimeMillis:Date.now()},o=new EW;return setTimeout(async()=>{o.abort()},t!==void 0?t:aW),EC({appId:s,apiKey:i,measurementId:n},a,o,e)}async function EC(r,{throttleEndTimeMillis:e,backoffCount:t},s,i=TC){var n;const{appId:a,measurementId:o}=r;try{await bW(s,e)}catch(l){if(o)return Ns.warn(`Timed out fetching this Firebase app's measurement ID from the server. Falling back to the measurement ID ${o} provided in the "measurementId" field in the local Firebase config. [${l==null?void 0:l.message}]`),{appId:a,measurementId:o};throw l}try{const l=await xW(r);return i.deleteThrottleMetadata(a),l}catch(l){const c=l;if(!TW(c)){if(i.deleteThrottleMetadata(a),o)return Ns.warn(`Failed to fetch this Firebase app's measurement ID from the server. Falling back to the measurement ID ${o} provided in the "measurementId" field in the local Firebase config. [${c==null?void 0:c.message}]`),{appId:a,measurementId:o};throw l}const d=Number((n=c==null?void 0:c.customData)===null||n===void 0?void 0:n.httpStatus)===503?yw(t,i.intervalMillis,gW):yw(t,i.intervalMillis),h={throttleEndTimeMillis:Date.now()+d,backoffCount:t+1};return i.setThrottleMetadata(a,h),Ns.debug(`Calling attemptFetch again in ${d} millis`),EC(r,h,s,i)}}function bW(r,e){return new Promise((t,s)=>{const i=Math.max(e-Date.now(),0),n=setTimeout(t,i);r.addEventListener(()=>{clearTimeout(n),s(li.create("fetch-throttle",{throttleEndTimeMillis:e}))})})}function TW(r){if(!(r instanceof mo)||!r.customData)return!1;const e=Number(r.customData.httpStatus);return e===429||e===500||e===503||e===504}class EW{constructor(){this.listeners=[]}addEventListener(e){this.listeners.push(e)}abort(){this.listeners.forEach(e=>e())}}async function CW(r,e,t,s,i){if(i&&i.global){r("event",t,s);return}else{const n=await e,a=Object.assign(Object.assign({},s),{send_to:n});r("event",t,a)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function AW(){if($E())try{await XE()}catch(r){return Ns.warn(li.create("indexeddb-unavailable",{errorInfo:r==null?void 0:r.toString()}).message),!1}else return Ns.warn(li.create("indexeddb-unavailable",{errorInfo:"IndexedDB is not available in this environment."}).message),!1;return!0}async function PW(r,e,t,s,i,n,a){var o;const l=wW(r);l.then(f=>{t[f.measurementId]=f.appId,r.options.measurementId&&f.measurementId!==r.options.measurementId&&Ns.warn(`The measurement ID in the local Firebase config (${r.options.measurementId}) does not match the measurement ID fetched from the server (${f.measurementId}). To ensure analytics events are always sent to the correct Analytics property, update the measurement ID field in the local config or remove it from the local config.`)}).catch(f=>Ns.error(f)),e.push(l);const c=AW().then(f=>{if(f)return s.getId()}),[d,h]=await Promise.all([l,c]);mW(n)||hW(n,d.measurementId),i("js",new Date);const u=(o=a==null?void 0:a.config)!==null&&o!==void 0?o:{};return u[rW]="firebase",u.update=!0,h!=null&&(u[nW]=h),i("config",d.measurementId,u),d.measurementId}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class MW{constructor(e){this.app=e}_delete(){return delete rc[this.app.options.appId],Promise.resolve()}}let rc={},Iw=[];const Rw={};let L_="dataLayer",IW="gtag",Lw,CC,Dw=!1;function RW(){const r=[];if(qG()&&r.push("This is a browser extension environment."),KG()||r.push("Cookies are not available."),r.length>0){const e=r.map((s,i)=>`(${i+1}) ${s}`).join(" "),t=li.create("invalid-analytics-context",{errorInfo:e});Ns.warn(t.message)}}function LW(r,e,t){RW();const s=r.options.appId;if(!s)throw li.create("no-app-id");if(!r.options.apiKey)if(r.options.measurementId)Ns.warn(`The "apiKey" field is empty in the local Firebase config. This is needed to fetch the latest measurement ID for this Firebase app. Falling back to the measurement ID ${r.options.measurementId} provided in the "measurementId" field in the local Firebase config.`);else throw li.create("no-api-key");if(rc[s]!=null)throw li.create("already-exists",{id:s});if(!Dw){cW(L_);const{wrappedGtag:n,gtagCore:a}=pW(rc,Iw,Rw,L_,IW);CC=n,Lw=a,Dw=!0}return rc[s]=PW(r,Iw,Rw,e,Lw,L_,t),new MW(r)}function DW(r=J4()){r=qE(r);const e=am(r,Bf);return e.isInitialized()?e.getImmediate():OW(r)}function OW(r,e={}){const t=am(r,Bf);if(t.isInitialized()){const i=t.getImmediate();if(Of(e,t.getOptions()))return i;throw li.create("already-initialized")}return t.initialize({options:e})}function AC(r,e,t,s){r=qE(r),CW(CC,rc[r.app.options.appId],e,t,s).catch(i=>Ns.error(i))}const Ow="@firebase/analytics",Fw="0.10.6";function FW(){so(new Vr(Bf,(e,{options:t})=>{const s=e.getProvider("app").getImmediate(),i=e.getProvider("installations-internal").getImmediate();return LW(s,i,t)},"PUBLIC")),so(new Vr("analytics-internal",r,"PRIVATE")),Rr(Ow,Fw),Rr(Ow,Fw,"esm2017");function r(e){try{const t=e.getProvider(Bf).getImmediate();return{logEvent:(s,i,n)=>AC(t,s,i,n)}}catch(t){throw li.create("interop-component-reg-failed",{reason:t})}}}FW();class Gt{static init(){QE({apiKey:"AIzaSyDgYUhVMC9cbBgid3JMbbO-LMgUa1SR0Lg",authDomain:"dino-runner-h5-dcd15.firebaseapp.com",projectId:"dino-runner-h5-dcd15",storageBucket:"dino-runner-h5-dcd15.appspot.com",messagingSenderId:"988642373554",appId:"1:988642373554:web:d21c33942709903f433eab",measurementId:"G-E7FH28CVXT"}),this.analytics=DW()}static log(e,t){AC(this.analytics,e,t),console.log(`Event logged: ${e}`,t)}}var Yt=Object.freeze({Linear:Object.freeze({None:function(r){return r},In:function(r){return this.None(r)},Out:function(r){return this.None(r)},InOut:function(r){return this.None(r)}}),Quadratic:Object.freeze({In:function(r){return r*r},Out:function(r){return r*(2-r)},InOut:function(r){return(r*=2)<1?.5*r*r:-.5*(--r*(r-2)-1)}}),Cubic:Object.freeze({In:function(r){return r*r*r},Out:function(r){return--r*r*r+1},InOut:function(r){return(r*=2)<1?.5*r*r*r:.5*((r-=2)*r*r+2)}}),Quartic:Object.freeze({In:function(r){return r*r*r*r},Out:function(r){return 1- --r*r*r*r},InOut:function(r){return(r*=2)<1?.5*r*r*r*r:-.5*((r-=2)*r*r*r-2)}}),Quintic:Object.freeze({In:function(r){return r*r*r*r*r},Out:function(r){return--r*r*r*r*r+1},InOut:function(r){return(r*=2)<1?.5*r*r*r*r*r:.5*((r-=2)*r*r*r*r+2)}}),Sinusoidal:Object.freeze({In:function(r){return 1-Math.sin((1-r)*Math.PI/2)},Out:function(r){return Math.sin(r*Math.PI/2)},InOut:function(r){return .5*(1-Math.sin(Math.PI*(.5-r)))}}),Exponential:Object.freeze({In:function(r){return r===0?0:Math.pow(1024,r-1)},Out:function(r){return r===1?1:1-Math.pow(2,-10*r)},InOut:function(r){return r===0?0:r===1?1:(r*=2)<1?.5*Math.pow(1024,r-1):.5*(-Math.pow(2,-10*(r-1))+2)}}),Circular:Object.freeze({In:function(r){return 1-Math.sqrt(1-r*r)},Out:function(r){return Math.sqrt(1- --r*r)},InOut:function(r){return(r*=2)<1?-.5*(Math.sqrt(1-r*r)-1):.5*(Math.sqrt(1-(r-=2)*r)+1)}}),Elastic:Object.freeze({In:function(r){return r===0?0:r===1?1:-Math.pow(2,10*(r-1))*Math.sin((r-1.1)*5*Math.PI)},Out:function(r){return r===0?0:r===1?1:Math.pow(2,-10*r)*Math.sin((r-.1)*5*Math.PI)+1},InOut:function(r){return r===0?0:r===1?1:(r*=2,r<1?-.5*Math.pow(2,10*(r-1))*Math.sin((r-1.1)*5*Math.PI):.5*Math.pow(2,-10*(r-1))*Math.sin((r-1.1)*5*Math.PI)+1)}}),Back:Object.freeze({In:function(r){var e=1.70158;return r===1?1:r*r*((e+1)*r-e)},Out:function(r){var e=1.70158;return r===0?0:--r*r*((e+1)*r+e)+1},InOut:function(r){var e=2.5949095;return(r*=2)<1?.5*(r*r*((e+1)*r-e)):.5*((r-=2)*r*((e+1)*r+e)+2)}}),Bounce:Object.freeze({In:function(r){return 1-Yt.Bounce.Out(1-r)},Out:function(r){return r<1/2.75?7.5625*r*r:r<2/2.75?7.5625*(r-=1.5/2.75)*r+.75:r<2.5/2.75?7.5625*(r-=2.25/2.75)*r+.9375:7.5625*(r-=2.625/2.75)*r+.984375},InOut:function(r){return r<.5?Yt.Bounce.In(r*2)*.5:Yt.Bounce.Out(r*2-1)*.5+.5}}),generatePow:function(r){return r===void 0&&(r=4),r=r<Number.EPSILON?Number.EPSILON:r,r=r>1e4?1e4:r,{In:function(e){return Math.pow(e,r)},Out:function(e){return 1-Math.pow(1-e,r)},InOut:function(e){return e<.5?Math.pow(e*2,r)/2:(1-Math.pow(2-e*2,r))/2+.5}}}}),il=function(){return performance.now()},PC=function(){function r(){this._tweens={},this._tweensAddedDuringUpdate={}}return r.prototype.getAll=function(){var e=this;return Object.keys(this._tweens).map(function(t){return e._tweens[t]})},r.prototype.removeAll=function(){this._tweens={}},r.prototype.add=function(e){this._tweens[e.getId()]=e,this._tweensAddedDuringUpdate[e.getId()]=e},r.prototype.remove=function(e){delete this._tweens[e.getId()],delete this._tweensAddedDuringUpdate[e.getId()]},r.prototype.update=function(e,t){e===void 0&&(e=il()),t===void 0&&(t=!1);var s=Object.keys(this._tweens);if(s.length===0)return!1;for(;s.length>0;){this._tweensAddedDuringUpdate={};for(var i=0;i<s.length;i++){var n=this._tweens[s[i]],a=!t;n&&n.update(e,a)===!1&&!t&&delete this._tweens[s[i]]}s=Object.keys(this._tweensAddedDuringUpdate)}return!0},r}(),Ma={Linear:function(r,e){var t=r.length-1,s=t*e,i=Math.floor(s),n=Ma.Utils.Linear;return e<0?n(r[0],r[1],s):e>1?n(r[t],r[t-1],t-s):n(r[i],r[i+1>t?t:i+1],s-i)},Bezier:function(r,e){for(var t=0,s=r.length-1,i=Math.pow,n=Ma.Utils.Bernstein,a=0;a<=s;a++)t+=i(1-e,s-a)*i(e,a)*r[a]*n(s,a);return t},CatmullRom:function(r,e){var t=r.length-1,s=t*e,i=Math.floor(s),n=Ma.Utils.CatmullRom;return r[0]===r[t]?(e<0&&(i=Math.floor(s=t*(1+e))),n(r[(i-1+t)%t],r[i],r[(i+1)%t],r[(i+2)%t],s-i)):e<0?r[0]-(n(r[0],r[0],r[1],r[1],-s)-r[0]):e>1?r[t]-(n(r[t],r[t],r[t-1],r[t-1],s-t)-r[t]):n(r[i?i-1:0],r[i],r[t<i+1?t:i+1],r[t<i+2?t:i+2],s-i)},Utils:{Linear:function(r,e,t){return(e-r)*t+r},Bernstein:function(r,e){var t=Ma.Utils.Factorial;return t(r)/t(e)/t(r-e)},Factorial:function(){var r=[1];return function(e){var t=1;if(r[e])return r[e];for(var s=e;s>1;s--)t*=s;return r[e]=t,t}}(),CatmullRom:function(r,e,t,s,i){var n=(t-r)*.5,a=(s-e)*.5,o=i*i,l=i*o;return(2*e-2*t+n+a)*l+(-3*e+3*t-2*n-a)*o+n*i+e}}},U0=function(){function r(){}return r.nextId=function(){return r._nextId++},r._nextId=0,r}(),iy=new PC,MC=function(){function r(e,t){t===void 0&&(t=iy),this._object=e,this._group=t,this._isPaused=!1,this._pauseStart=0,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._isDynamic=!1,this._initialRepeat=0,this._repeat=0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=0,this._easingFunction=Yt.Linear.None,this._interpolationFunction=Ma.Linear,this._chainedTweens=[],this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._id=U0.nextId(),this._isChainStopped=!1,this._propertiesAreSetUp=!1,this._goToEnd=!1}return r.prototype.getId=function(){return this._id},r.prototype.isPlaying=function(){return this._isPlaying},r.prototype.isPaused=function(){return this._isPaused},r.prototype.to=function(e,t){if(t===void 0&&(t=1e3),this._isPlaying)throw new Error("Can not call Tween.to() while Tween is already started or paused. Stop the Tween first.");return this._valuesEnd=e,this._propertiesAreSetUp=!1,this._duration=t,this},r.prototype.duration=function(e){return e===void 0&&(e=1e3),this._duration=e,this},r.prototype.dynamic=function(e){return e===void 0&&(e=!1),this._isDynamic=e,this},r.prototype.start=function(e,t){if(e===void 0&&(e=il()),t===void 0&&(t=!1),this._isPlaying)return this;if(this._group&&this._group.add(this),this._repeat=this._initialRepeat,this._reversed){this._reversed=!1;for(var s in this._valuesStartRepeat)this._swapEndStartRepeatValues(s),this._valuesStart[s]=this._valuesStartRepeat[s]}if(this._isPlaying=!0,this._isPaused=!1,this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._isChainStopped=!1,this._startTime=e,this._startTime+=this._delayTime,!this._propertiesAreSetUp||t){if(this._propertiesAreSetUp=!0,!this._isDynamic){var i={};for(var n in this._valuesEnd)i[n]=this._valuesEnd[n];this._valuesEnd=i}this._setupProperties(this._object,this._valuesStart,this._valuesEnd,this._valuesStartRepeat,t)}return this},r.prototype.startFromCurrentValues=function(e){return this.start(e,!0)},r.prototype._setupProperties=function(e,t,s,i,n){for(var a in s){var o=e[a],l=Array.isArray(o),c=l?"array":typeof o,d=!l&&Array.isArray(s[a]);if(!(c==="undefined"||c==="function")){if(d){var h=s[a];if(h.length===0)continue;for(var u=[o],f=0,p=h.length;f<p;f+=1){var _=this._handleRelativeValue(o,h[f]);if(isNaN(_)){d=!1,console.warn("Found invalid interpolation list. Skipping.");break}u.push(_)}d&&(s[a]=u)}if((c==="object"||l)&&o&&!d){t[a]=l?[]:{};var m=o;for(var g in m)t[a][g]=m[g];i[a]=l?[]:{};var h=s[a];if(!this._isDynamic){var v={};for(var g in h)v[g]=h[g];s[a]=h=v}this._setupProperties(m,t[a],h,i[a],n)}else(typeof t[a]>"u"||n)&&(t[a]=o),l||(t[a]*=1),d?i[a]=s[a].slice().reverse():i[a]=t[a]||0}}},r.prototype.stop=function(){return this._isChainStopped||(this._isChainStopped=!0,this.stopChainedTweens()),this._isPlaying?(this._group&&this._group.remove(this),this._isPlaying=!1,this._isPaused=!1,this._onStopCallback&&this._onStopCallback(this._object),this):this},r.prototype.end=function(){return this._goToEnd=!0,this.update(1/0),this},r.prototype.pause=function(e){return e===void 0&&(e=il()),this._isPaused||!this._isPlaying?this:(this._isPaused=!0,this._pauseStart=e,this._group&&this._group.remove(this),this)},r.prototype.resume=function(e){return e===void 0&&(e=il()),!this._isPaused||!this._isPlaying?this:(this._isPaused=!1,this._startTime+=e-this._pauseStart,this._pauseStart=0,this._group&&this._group.add(this),this)},r.prototype.stopChainedTweens=function(){for(var e=0,t=this._chainedTweens.length;e<t;e++)this._chainedTweens[e].stop();return this},r.prototype.group=function(e){return e===void 0&&(e=iy),this._group=e,this},r.prototype.delay=function(e){return e===void 0&&(e=0),this._delayTime=e,this},r.prototype.repeat=function(e){return e===void 0&&(e=0),this._initialRepeat=e,this._repeat=e,this},r.prototype.repeatDelay=function(e){return this._repeatDelayTime=e,this},r.prototype.yoyo=function(e){return e===void 0&&(e=!1),this._yoyo=e,this},r.prototype.easing=function(e){return e===void 0&&(e=Yt.Linear.None),this._easingFunction=e,this},r.prototype.interpolation=function(e){return e===void 0&&(e=Ma.Linear),this._interpolationFunction=e,this},r.prototype.chain=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this._chainedTweens=e,this},r.prototype.onStart=function(e){return this._onStartCallback=e,this},r.prototype.onEveryStart=function(e){return this._onEveryStartCallback=e,this},r.prototype.onUpdate=function(e){return this._onUpdateCallback=e,this},r.prototype.onRepeat=function(e){return this._onRepeatCallback=e,this},r.prototype.onComplete=function(e){return this._onCompleteCallback=e,this},r.prototype.onStop=function(e){return this._onStopCallback=e,this},r.prototype.update=function(e,t){if(e===void 0&&(e=il()),t===void 0&&(t=!0),this._isPaused)return!0;var s,i,n=this._startTime+this._duration;if(!this._goToEnd&&!this._isPlaying){if(e>n)return!1;t&&this.start(e,!0)}if(this._goToEnd=!1,e<this._startTime)return!0;this._onStartCallbackFired===!1&&(this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),this._onEveryStartCallbackFired===!1&&(this._onEveryStartCallback&&this._onEveryStartCallback(this._object),this._onEveryStartCallbackFired=!0),i=(e-this._startTime)/this._duration,i=this._duration===0||i>1?1:i;var a=this._easingFunction(i);if(this._updateProperties(this._object,this._valuesStart,this._valuesEnd,a),this._onUpdateCallback&&this._onUpdateCallback(this._object,i),i===1)if(this._repeat>0){isFinite(this._repeat)&&this._repeat--;for(s in this._valuesStartRepeat)!this._yoyo&&typeof this._valuesEnd[s]=="string"&&(this._valuesStartRepeat[s]=this._valuesStartRepeat[s]+parseFloat(this._valuesEnd[s])),this._yoyo&&this._swapEndStartRepeatValues(s),this._valuesStart[s]=this._valuesStartRepeat[s];return this._yoyo&&(this._reversed=!this._reversed),this._repeatDelayTime!==void 0?this._startTime=e+this._repeatDelayTime:this._startTime=e+this._delayTime,this._onRepeatCallback&&this._onRepeatCallback(this._object),this._onEveryStartCallbackFired=!1,!0}else{this._onCompleteCallback&&this._onCompleteCallback(this._object);for(var o=0,l=this._chainedTweens.length;o<l;o++)this._chainedTweens[o].start(this._startTime+this._duration,!1);return this._isPlaying=!1,!1}return!0},r.prototype._updateProperties=function(e,t,s,i){for(var n in s)if(t[n]!==void 0){var a=t[n]||0,o=s[n],l=Array.isArray(e[n]),c=Array.isArray(o),d=!l&&c;d?e[n]=this._interpolationFunction(o,i):typeof o=="object"&&o?this._updateProperties(e[n],a,o,i):(o=this._handleRelativeValue(a,o),typeof o=="number"&&(e[n]=a+(o-a)*i))}},r.prototype._handleRelativeValue=function(e,t){return typeof t!="string"?t:t.charAt(0)==="+"||t.charAt(0)==="-"?e+parseFloat(t):parseFloat(t)},r.prototype._swapEndStartRepeatValues=function(e){var t=this._valuesStartRepeat[e],s=this._valuesEnd[e];typeof s=="string"?this._valuesStartRepeat[e]=this._valuesStartRepeat[e]+parseFloat(s):this._valuesStartRepeat[e]=this._valuesEnd[e],this._valuesEnd[e]=t},r}(),kW="21.1.1",BW=U0.nextId,an=iy,NW=an.getAll.bind(an),UW=an.removeAll.bind(an),zW=an.add.bind(an),VW=an.remove.bind(an),GW=an.update.bind(an),D_={Easing:Yt,Group:PC,Interpolation:Ma,now:il,Sequence:U0,nextId:BW,Tween:MC,VERSION:kW,getAll:NW,removeAll:UW,add:zW,remove:VW,update:GW};class HW extends MC{constructor(e,t){super(e,t)}}const Oi=class Oi{static init(e){e.on("start",()=>{e.on("update",this.update,this)})}static update(){D_.update()}static createLocalTranslateTween(e,t={},s=Oi.defaultConfig){const i=e.getLocalPosition().clone(),n=new y,a=Object.keys(t),o=this.createTween(i,t,s);return o.onUpdate(()=>{n.copy(e.getLocalPosition()),a.forEach(l=>n[l]=i[l]),e.setLocalPosition(n)}),o}static createGlobalTranslateTween(e,t={},s=Oi.defaultConfig){const i=e.getPosition().clone(),n=new y,a=Object.keys(t),o=this.createTween(i,t,s);return o.onUpdate(()=>{n.copy(e.getPosition()),a.forEach(l=>n[l]=i[l]),e.setPosition(n)}),o}static createRotateTween(e,t={},s=Oi.defaultConfig){const i=e.getLocalEulerAngles().clone(),n=new y,a=Object.keys(t),o=this.createTween(i,t,s);return o.onUpdate(()=>{n.copy(e.getLocalEulerAngles()),a.forEach(l=>n[l]=i[l]),e.setLocalEulerAngles(n)}),o}static createScaleTween(e,t={},s=Oi.defaultConfig){const i=e.getLocalScale().clone(),n=new y,a=Object.keys(t),o=this.createTween(i,t,s);return o.onUpdate(()=>{n.copy(e.getLocalScale()),a.forEach(l=>n[l]=i[l]),e.setLocalScale(n)}),o}static createCountTween(e=Oi.defaultConfig){const t={percent:0};return this.createTween(t,{percent:1},e)}static createTween(e,t={},s=Oi.defaultConfig){const i=this._setupConfig(s),n=new HW(e);return n.to(t,i.duration*1e3),this._setupTween(n,i),n}static _setupConfig(e){return ve.copyObject(e,ve.copyObject(Oi.defaultConfig))}static _setupTween(e,t){e.easing(t.easing),e.delay(t.delay*1e3),e.repeatDelay(t.repeatDelay*1e3),t.loop?e.repeat(1/0):e.repeat(t.repeat),e.yoyo(t.yoyo),e.onStart(t.onStart),e.onRepeat(t.onRepeat),e.onStop(t.onStop),e.onUpdate(t.onUpdate),e.onComplete(t.onComplete)}static get Easing(){return D_.Easing}};Oi.defaultConfig=Object.freeze({duration:1,easing:D_.Easing.Linear.None,loop:!1,yoyo:!1,delay:0,repeatDelay:0,repeat:0,onStart:()=>{},onRepeat:()=>{},onStop:()=>{},onUpdate:()=>{},onComplete:()=>{}});let Q=Oi;const Fi=class Fi{static async init(){if(this.adsConfig=window.LAGGED_SDK_CONFIG,!this.adsConfig.SHOW_ADS){this.isReady=!0;return}await this._loadSDK(),this._createBackground(),LaggedAPI.init(this.adsConfig.DEV_ID,this.adsConfig.PUBLISHER_ID),await new Promise(e=>{setTimeout(()=>{Fi.isReady=!0,this.emitter.fire("ready"),e()},550)})}static async _loadSDK(){await new Promise(e=>{const t=document.createElement("script"),s=this.adsConfig.SDK_URL;t.src=s,t.onload=e,document.body.appendChild(t)})}static _createBackground(){this._background=document.createElement("div"),this._background.style.top="0px",this._background.style.left="0px",this._background.style.margin="0px",this._background.style.padding="0px",this._background.id="ads-background",this._background.style.position="absolute",this._background.style.width="100%",this._background.style.height="100%",this._background.style.backgroundColor="black",this._background.style.opacity="0.8",this._background.style.zIndex="100",document.body.appendChild(this._background),this._background.style.display="none";const e=t=>{t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation()};this._background.addEventListener("mousedown",e),this._background.addEventListener("mousemove",e),this._background.addEventListener("mouseup",e),this._background.addEventListener("touchstart",e),this._background.addEventListener("touchmove",e),this._background.addEventListener("touchend",e),this._background.addEventListener("pointerdown",e),this._background.addEventListener("pointermove",e),this._background.addEventListener("pointerup",e),this._background.addEventListener("keydown",e),this._background.addEventListener("keyup",e),this._background.addEventListener("keypress",e),this._background.addEventListener("contextmenu",e),this.alphaInTween=Q.createTween({opacity:0},{opacity:.8},{duration:.2,onStart:()=>{this._background.style.display="block"},onUpdate:t=>{this._background.style.opacity=t.opacity}}),this.alphaOutTween=Q.createTween({opacity:.8},{opacity:0},{duration:.2,onUpdate:t=>{this._background.style.opacity=t.opacity},onComplete:()=>{this._background.style.display="none"}})}static _showBackground(){this.alphaInTween.stop(),this.alphaOutTween.stop(),this._background.style.display="block",this._background.style.opacity="0.8"}static _hideBackground(){this.alphaInTween.stop(),this.alphaOutTween.stop(),this._background.style.display="none",this._background.style.opacity="0.0"}static _showBackgroundNoOpacity(){this._background.style.display="block",this._background.style.opacity="0.0"}static _hideBackgroundNoOpacity(){this._background.style.display="none",this._background.style.opacity="0.0"}static showInterstitialAds(e,t=!0){if(this.isShowingInterstitialAds){e==null||e();return}if(!this.adsConfig.SHOW_ADS){e==null||e();return}if(!this.isReady){this.emitter.once("ready",()=>{this.showInterstitialAds(e)});return}this.emitter.fire("ads-start"),t?this._showBackground():this._showBackgroundNoOpacity(),this.isShowingInterstitialAds=!0,LaggedAPI.APIAds.show(()=>{t?this._hideBackground():this._hideBackgroundNoOpacity(),this.isShowingInterstitialAds=!1,this.emitter.fire("ads-complete"),e==null||e()})}static saveAchievement(e,t){if(!this.adsConfig.SHOW_ADS){t==null||t();return}LaggedAPI.Achievements.save([e],s=>{s.success?t==null||t():(console.warn(s.errormsg),t==null||t(s.errormsg))})}static saveHighScore(e,t){if(!this.adsConfig.SHOW_ADS){t==null||t();return}let s={};s.score=e,s.board=this.HS_BOARD_ID,LaggedAPI.Scores.save(s,i=>{i.success?t==null||t():(console.warn(i.errormsg),t==null||t(i.errormsg))})}static checkIsRewardAdsReady(e){if(!this.adsConfig.SHOW_ADS){e==null||e(!1);return}if(!this.isReady){this.emitter.once("ready",()=>{this.checkIsRewardAdsReady(e)});return}if(performance.now()-this._lastCallRewardAds<this._rewardAdsThreshold){e==null||e(!1,"Too fast");return}this._lastCallRewardAds=performance.now();let t=!1,s=(a,o)=>{t||(t=!0,e==null||e(a,o))};if(this._showRewardAdsFn){s(!0);return}let i=(a,o)=>{a?(this._showRewardAdsFn=o,s(!0)):s(!1,"Reward ads not ready")},n=a=>{var o,l;this._rewardAdsSuccessCallback&&(a?(o=this._rewardAdsSuccessCallback)==null||o.call(this):(l=this._rewardAdsSuccessCallback)==null||l.call(this,"Reward ads failed"))};LaggedAPI.GEvents.reward(i,n)}static showRewardAds(e){if(!this.adsConfig.SHOW_ADS){e==null||e();return}if(!this._showRewardAdsFn){e==null||e("Reward ads not ready");return}if(!this.isReady){this.emitter.once("ready",()=>{this.showRewardAds(e)});return}this._showBackground(),this._rewardAdsSuccessCallback=t=>{this._hideBackground(),e==null||e(t),this._rewardAdsSuccessCallback=null},this._showRewardAdsFn(),this._showRewardAdsFn=null}};Qn(Fi,"isReady",!1),Qn(Fi,"emitter",new ie),Qn(Fi,"HS_BOARD_ID","dino_runner_hsbdgca"),Qn(Fi,"_lastCallRewardAds",0),Qn(Fi,"_rewardAdsThreshold",1e3),Qn(Fi,"_showRewardAdsFn",null),Qn(Fi,"_rewardAdsSuccessCallback",null);let Wt=Fi;const $f=class $f{static init(e){this.scenes=e}static loadScene(e){const t=this.currentScene;this.currentScene=e,this.additiveScenes.forEach(s=>s.destroy()),Z.app.root.addChild(this.currentScene),this.currentScene.create(),t&&(Z.app.root.removeChild(t),t.destroy())}static loadSceneAddtive(e){this.additiveScenes.push(e),e.create(),Z.app.root.addChild(e)}static update(){var e;(e=this.currentScene)==null||e.update(),this.additiveScenes.forEach(t=>t.update())}static resize(){var e;(e=this.currentScene)==null||e.resize(),this.additiveScenes.forEach(t=>t.resize())}static pause(){var e;(e=this.currentScene)==null||e.pause(),this.additiveScenes.forEach(t=>t.pause())}static resume(){var e;(e=this.currentScene)==null||e.resume(),this.additiveScenes.forEach(t=>t.resume())}static getScene(e){return this.scenes.find(t=>t.key===e)}};$f.scenes=[],$f.additiveScenes=[];let Js=$f;const dl=class dl extends ${constructor(e="UIScreen"){super(e),this.addComponent("screen",{screenSpace:!0,scaleMode:Id,resolution:new M(O.GAME_WIDTH,O.GAME_HEIGHT),referenceResolution:new M(O.GAME_WIDTH,O.GAME_HEIGHT)}),this.enabled=!1,this.created=!1}create(){if(this.created){console.error(`UIScreen ${typeof this} already created!`);return}this.created=!0}onActivated(){this.enabled=!0,this.fire(dl.EVENT_ACTIVATED,this)}onDeactivated(){this.enabled=!1,this.fire(dl.EVENT_DEACTIVATED,this)}update(){}resize(){}pause(){}resume(){}show(){this.enabled=!0}destroyChildren(){for(;this.children.length>0;)this.children[0].destroy()}getScreenSpacePosition(e,t=new y){return this.screen?(t.x=e.x*Z.app.graphicsDevice.maxPixelRatio,t.y=Z.app.graphicsDevice.height-e.y*Z.app.graphicsDevice.maxPixelRatio,t.z=0,t.mulScalar(1/this.screen.scale),t):y.ZERO}};dl.EVENT_ACTIVATED="UIScreen:ACTIVATED",dl.EVENT_DEACTIVATED="UIScreen:DEACTIVATED";let Lt=dl;const ki=class ki extends ${constructor(e){super(e),this.screens=[],this.key=e}onActivated(){this.fire(ki.EVENT_ACTIVATED,this)}onDeactivated(){this.fire(ki.EVENT_DEACTIVATED,this)}update(){this.screens.forEach(e=>e.enabled&&e.update())}pause(){this.screens.forEach(e=>e.enabled&&e.pause())}resume(){this.screens.forEach(e=>e.enabled&&e.resume())}resize(){this.screens.forEach(e=>e.enabled&&e.resize())}addScreen(e){const t=new e("screen");return this.addChild(t),this.screens.push(t),t.create(),t.on(Lt.EVENT_ACTIVATED,()=>this.fire(ki.EVENT_SCREEN_ACTIVATED,t)),t.on(Lt.EVENT_DEACTIVATED,()=>this.fire(ki.EVENT_SCREEN_DEACTIVATED,t)),t}setScreenActive(e,t=!0){const s=this.getScreen(e);if(!s){console.error(`Screen ${e.name} not found!`);return}t?s.onActivated():s.onDeactivated()}disableAllScreens(){this.screens.forEach(e=>{e.enabled&&e.onDeactivated()})}getScreen(e){return this.screens.find(t=>t instanceof e)}getScreenByName(e){return this.screens.find(t=>t.name===e)}isExist(e){return!!this.getScreen(e)}};ki.EVENT_ACTIVATED="UILayer:ACTIVATED",ki.EVENT_DEACTIVATED="UILayer:DEACTIVATED",ki.EVENT_SCREEN_ACTIVATED="UILayer:SCREEN_ACTIVATED",ki.EVENT_SCREEN_DEACTIVATED="UILayer:SCREEN_DEACTIVATED";let _a=ki;const Bi=class Bi extends ${constructor(){super("ui_manager"),this._layers={},this._currentScreenPriority=0}update(){Object.keys(this._layers).forEach(e=>this._layers[e].enabled&&this._layers[e].update())}pause(){Object.keys(this._layers).forEach(e=>this._layers[e].enabled&&this._layers[e].pause())}resume(){Object.keys(this._layers).forEach(e=>this._layers[e].enabled&&this._layers[e].resume())}resize(){Object.keys(this._layers).forEach(e=>this._layers[e].resize())}addLayer(e,...t){if(this._layers[e]){console.error(`UILayer with key ${e} already exists!`);return}const s=new _a(e);this._layers[e]=s,this.addChild(s),t.forEach(i=>{const n=s.addScreen(i);n.resize(),n.screen&&(n.screen.priority=this._currentScreenPriority++)}),s.on(_a.EVENT_SCREEN_ACTIVATED,i=>this.fire(Bi.EVENT_SCREEN_ACTIVATED,i)),s.on(_a.EVENT_SCREEN_DEACTIVATED,i=>this.fire(Bi.EVENT_SCREEN_DEACTIVATED,i)),s.on(_a.EVENT_ACTIVATED,i=>this.fire(Bi.EVENT_LAYER_ACTIVATED,i)),s.on(_a.EVENT_DEACTIVATED,i=>this.fire(Bi.EVENT_LAYER_DEACTIVATED,i)),s.screens.forEach(i=>i.enabled=!1)}removeLayer(e){if(!this._layers[e]){console.error(`UILayer with key ${e} does not exist!`);return}this._layers[e].destroy(),delete this._layers[e]}setLayerActive(e,t=!0){const s=this._layers[e];if(!s){console.error(`UILayer with key ${e} does not exist!`);return}s.enabled=t,t?s.onActivated():s.onDeactivated()}disableAllLayers(){Object.keys(this._layers).forEach(e=>{const t=this._layers[e];t.enabled&&(t.enabled=!1,t.onDeactivated())})}getScreenByName(e,t){let s=this._layers[e].getScreenByName(t);return s!==null?s:null}getScreen(e){for(const t in this._layers){const s=this._layers[t].getScreen(e);if(s)return s}}getScreenOfLayer(e,t){const s=this._layers[e];if(!s){console.error(`UILayer with key ${e} does not exist!`);return}return s.getScreen(t)}setScreenActive(e,t=!0){for(const s in this._layers){const i=this._layers[s];i.isExist(e)&&i.setScreenActive(e,t)}}setScreenActiveOfLayer(e,t,s=!0){const i=this._layers[e];if(!i){console.error(`UILayer with key ${e} does not exist!`);return}i.setScreenActive(t,s)}disableAllScreens(){Object.keys(this._layers).forEach(e=>this.disableAllScreenOfLayer(e))}disableAllScreenOfLayer(e){const t=this._layers[e];if(!t){console.error(`UILayer with key ${e} does not exist!`);return}t.disableAllScreens()}getLayer(e){return this._layers[e]}};Bi.EVENT_LAYER_ACTIVATED="UIManager:LAYER_ACTIVATED",Bi.EVENT_LAYER_DEACTIVATED="UIManager:LAYER_DEACTIVATED",Bi.EVENT_SCREEN_ACTIVATED="UIManager:SCREEN_ACTIVATED",Bi.EVENT_SCREEN_DEACTIVATED="UIManager:SCREEN_DEACTIVATED";let ny=Bi;class IC extends ${constructor(e){super(e),this.key=e,this.ui=new ny,this.addChild(this.ui)}update(){this.ui.update()}resize(){this.ui.resize()}pause(){this.ui.pause()}resume(){this.ui.resume()}create(){}}const hc=class hc extends ${constructor(){super(),this.isStarted=!1,this.isPaused=!1,this.score=0,this.coinCollected=0}load(){}start(){this.isStarted||(this.isStarted=!0,this.fire(hc.Event.Start))}setPause(e){this.isStarted&&(this.isPaused=e)}update(e){}destroy(){super.destroy()}stop(){}};hc.Type={Tutorial:"tutorial",Challenge:"challenge",Endless:"endless"},hc.Event={Loaded:"level:loaded",Start:"level:start",Complete:"level:complete",UpdateScore:"level:updateScore"};let Ie=hc;const cc=class cc extends Rt{constructor(e){super(e),this.class=null,this.args=[],this.poolSize=10,this.pool=[]}static get scriptName(){return"Spawner"}initialize(){this.pool=[]}postInitialize(){this._createPool()}spawn(e=null,t=-1){let s=this.pool.pop();return s||(s=this.createEntity()),s.enabled=!0,s.once(cc.Event.Despawn,()=>this.despawn(s)),e&&(t>=0?e.insertChild(s,t):e.addChild(s)),s.fire(cc.Event.Spawn),s}despawn(e){e.enabled=!1,e.parent.removeChild(e),this.pool.push(e)}spawnAt(e,t=null,s=-1){let i=e.getPosition(),n=this.spawn(t||e,s);return n.setPosition(i),n}spawnTo(e,t=null,s=-1){let i=this.spawn(t||this.entity,s);return i.setPosition(e),i}_createPool(){for(let e=0;e<this.poolSize;e++)this.pool.push(this.createEntity())}createEntity(){return new this.class(...this.args)}};cc.Event={Spawn:"spawn",Despawn:"despawn"};let zn=cc;const ul=class ul extends Rt{static get scriptName(){return"inputHandler"}initialize(){this._initMouse(),this._initTouch()}_initMouse(){if(!this.app.mouse)return;let e=this.app.mouse;e.on(Ry,t=>this._handleInputEvent(t,this._onMouseDown.bind(this))),e.on(Ly,t=>this._handleInputEvent(t,this._onMouseMove.bind(this))),e.on(Dy,t=>this._handleInputEvent(t,this._onMouseUp.bind(this)))}_initTouch(){if(!this.app.touch)return;let e=this.app.touch;e.on(pM,t=>this._handleInputEvent(t,this._onMouseDown.bind(this))),e.on(_M,t=>this._handleInputEvent(t,this._onMouseMove.bind(this))),e.on(mM,t=>this._handleInputEvent(t,this._onMouseUp.bind(this))),e.on(gM,t=>this._handleInputEvent(t,this._onMouseUp.bind(this)))}_handleInputEvent(e,t){e instanceof Vh&&e.event.preventDefault(),this.enabled&&t(e)}_onMouseDown(e){this.app.fire(ul.InputEvent.PointerDown,e)}_onMouseMove(e){this.app.fire(ul.InputEvent.PointerMove,e)}_onMouseUp(e){this.app.fire(ul.InputEvent.PointerUp,e)}};ul.InputEvent={PointerDown:"inputHandler:pointerdown",PointerMove:"inputHandler:pointermove",PointerUp:"inputHandler:pointerup"};let An=ul;const Ni=class Ni extends Rt{constructor(){super(...arguments),this.onGround=!1,this.isDead=!1,this.isRunning=!1,this.isBending=!1,this.isFinished=!1,this.touchedDown=!1,this.startPos=0,this.currPos=0,this._offsetMouseMove=5}static get scriptName(){return"playerController"}initialize(){}handleKeyDown(e){this._isCanMove()&&(e.code===O.SPACE_KEY&&this.fire(Ni.Event.KEY_SPACE_PRESSED),e.code===O.ARROW_UP_KEY&&this.fire(Ni.Event.KEY_UP_PRESSED),e.code===O.ARROW_DOWN_KEY&&this.fire(Ni.Event.KEY_DOWN_PRESSED))}handleKeyUp(e){this._isCanMove()&&e.code===O.ARROW_DOWN_KEY&&this.fire(Ni.Event.KEY_DOWN_RELEASED)}registerTouchEvent(){this.app.on(An.InputEvent.PointerDown,this.onPointerDown,this),this.app.on(An.InputEvent.PointerMove,this.onPointerMove,this),this.app.on(An.InputEvent.PointerUp,this.onPointerUp,this),this.app.on(O.MOUSE_MOVE_OUT_OF_CANVAS_EVENT,this.onPointerUp,this)}unregisterTouchEvent(){this.app.off(An.InputEvent.PointerDown,this.onPointerDown,this),this.app.off(An.InputEvent.PointerMove,this.onPointerMove,this),this.app.off(An.InputEvent.PointerUp,this.onPointerUp,this),this.app.off(O.MOUSE_MOVE_OUT_OF_CANVAS_EVENT,this.onPointerUp,this)}onPointerDown(e){this._isCanMove()&&(e.touches&&e.touches[0]?this.startPos=e.touches[0].y:this.startPos=e.y,this.touchedDown=!0)}onPointerMove(e){if(!(!this.touchedDown||!this._isCanMove())){if(e.touches&&e.touches[0]){this.currPos=e.touches[0].y;let t=e.touches;for(let s=0;s<t.length;s++){let i=t[s],n=i.touch.clientX,a=i.touch.clientY;if(n<0||n>window.innerWidth||a<0||a>window.innerHeight){this.onPointerUp(e);return}}}else this.currPos=e.y;this.currPos-this.startPos>this._offsetMouseMove?(this.isBending=!0,this.currPos=0,this.startPos=0,this.fire(Ni.Event.KEY_DOWN_PRESSED)):this.currPos-this.startPos<-this._offsetMouseMove&&this.onGround&&(this._reset(),this.fire(Ni.Event.KEY_UP_PRESSED))}}onPointerUp(e){this.touchedDown&&(this._reset(),this.isBending=!1,this.fire(Ni.Event.KEY_DOWN_RELEASED))}_reset(){this.touchedDown=!1,this.currPos=0,this.startPos=0}_isCanMove(){return!this.isDead&&this.isRunning&&!this.isFinished}};Ni.Event={KEY_SPACE_PRESSED:"keySpacePressed",KEY_UP_PRESSED:"keyUpPressed",KEY_DOWN_PRESSED:"keyDownPressed",KEY_DOWN_RELEASED:"keyDownReleased"};let ga=Ni;var z0={exports:{}},Cl=typeof Reflect=="object"?Reflect:null,kw=Cl&&typeof Cl.apply=="function"?Cl.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)},Zu;Cl&&typeof Cl.ownKeys=="function"?Zu=Cl.ownKeys:Object.getOwnPropertySymbols?Zu=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Zu=function(e){return Object.getOwnPropertyNames(e)};function WW(r){console&&console.warn&&console.warn(r)}var RC=Number.isNaN||function(e){return e!==e};function He(){He.init.call(this)}z0.exports=He;z0.exports.once=qW;He.EventEmitter=He;He.prototype._events=void 0;He.prototype._eventsCount=0;He.prototype._maxListeners=void 0;var Bw=10;function hm(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(He,"defaultMaxListeners",{enumerable:!0,get:function(){return Bw},set:function(r){if(typeof r!="number"||r<0||RC(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");Bw=r}});He.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};He.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||RC(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function LC(r){return r._maxListeners===void 0?He.defaultMaxListeners:r._maxListeners}He.prototype.getMaxListeners=function(){return LC(this)};He.prototype.emit=function(e){for(var t=[],s=1;s<arguments.length;s++)t.push(arguments[s]);var i=e==="error",n=this._events;if(n!==void 0)i=i&&n.error===void 0;else if(!i)return!1;if(i){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var l=n[e];if(l===void 0)return!1;if(typeof l=="function")kw(l,this,t);else for(var c=l.length,d=BC(l,c),s=0;s<c;++s)kw(d[s],this,t);return!0};function DC(r,e,t,s){var i,n,a;if(hm(t),n=r._events,n===void 0?(n=r._events=Object.create(null),r._eventsCount=0):(n.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),n=r._events),a=n[e]),a===void 0)a=n[e]=t,++r._eventsCount;else if(typeof a=="function"?a=n[e]=s?[t,a]:[a,t]:s?a.unshift(t):a.push(t),i=LC(r),i>0&&a.length>i&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=r,o.type=e,o.count=a.length,WW(o)}return r}He.prototype.addListener=function(e,t){return DC(this,e,t,!1)};He.prototype.on=He.prototype.addListener;He.prototype.prependListener=function(e,t){return DC(this,e,t,!0)};function jW(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function OC(r,e,t){var s={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},i=jW.bind(s);return i.listener=t,s.wrapFn=i,i}He.prototype.once=function(e,t){return hm(t),this.on(e,OC(this,e,t)),this};He.prototype.prependOnceListener=function(e,t){return hm(t),this.prependListener(e,OC(this,e,t)),this};He.prototype.removeListener=function(e,t){var s,i,n,a,o;if(hm(t),i=this._events,i===void 0)return this;if(s=i[e],s===void 0)return this;if(s===t||s.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,s.listener||t));else if(typeof s!="function"){for(n=-1,a=s.length-1;a>=0;a--)if(s[a]===t||s[a].listener===t){o=s[a].listener,n=a;break}if(n<0)return this;n===0?s.shift():$W(s,n),s.length===1&&(i[e]=s[0]),i.removeListener!==void 0&&this.emit("removeListener",e,o||t)}return this};He.prototype.off=He.prototype.removeListener;He.prototype.removeAllListeners=function(e){var t,s,i;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[e]),this;if(arguments.length===0){var n=Object.keys(s),a;for(i=0;i<n.length;++i)a=n[i],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=s[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function FC(r,e,t){var s=r._events;if(s===void 0)return[];var i=s[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?XW(i):BC(i,i.length)}He.prototype.listeners=function(e){return FC(this,e,!0)};He.prototype.rawListeners=function(e){return FC(this,e,!1)};He.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):kC.call(r,e)};He.prototype.listenerCount=kC;function kC(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}He.prototype.eventNames=function(){return this._eventsCount>0?Zu(this._events):[]};function BC(r,e){for(var t=new Array(e),s=0;s<e;++s)t[s]=r[s];return t}function $W(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function XW(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function qW(r,e){return new Promise(function(t,s){function i(a){r.removeListener(e,n),s(a)}function n(){typeof r.removeListener=="function"&&r.removeListener("error",i),t([].slice.call(arguments))}NC(r,e,n,{once:!0}),e!=="error"&&KW(r,i,{once:!0})})}function KW(r,e,t){typeof r.on=="function"&&NC(r,"error",e,t)}function NC(r,e,t,s){if(typeof r.on=="function")s.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function i(n){s.once&&r.removeEventListener(e,i),t(n)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}var UC=z0.exports;const zC=OG(UC),Tn=class Tn{constructor(e){this.id=e.type+e.id,this.type=e.type,this.mode=e.mode,this.description=e.description,this.rewardPerUnit=e.rewardPerUnit,this.goalRange=e.goalRange,this.currentGoal=0,this.progress=0,this.completed=!1,this.claimed=!1,this.timer=0,this.timeRemaining=e.timeRemaining||Number.MAX_VALUE,this.isActive=!0,this.emitter=new UC.EventEmitter}setData(e){this.currentGoal=e.currentGoal,this.progress=e.progress,this.completed=e.completed,this.claimed=e.claimed}randomize(){this.currentGoal=Math.floor(Math.random()*(this.goalRange[1]-this.goalRange[0]+1))+this.goalRange[0],this.currentGoal>=10&&(this.currentGoal=Math.round(this.currentGoal/10)*10),this.progress=0,this.completed=!1,this.claimed=!1,this.isActive=!0,this.started=!0,this.emitter.emit(Tn.Event.UPDATE,this)}update(e){!this.isActive||!this.started||(this.timeRemaining-=e,this.timeRemaining<=0&&(this.isActive=!1,this.emitter.emit(Tn.Event.FAILED,this)))}updateProgress(e){this.completed||!this.isActive||(this.progress+=e,this.progress>=this.currentGoal&&(this.progress=this.currentGoal),this.emitter.emit(Tn.Event.UPDATE,this),this.progress>=this.currentGoal&&(this.completed=!0,this.started=!1,this.emitter.emit(Tn.Event.COMPLETED,this)))}};Tn.Type={REACH_SCORE:"reach_score",REACH_LEVEL:"reach_level",COLLECT:"collect",REACH_JUMP:"reach_jump",UNLOCK_CHARACTER:"unlock_character",UNLOCK_LEVEL:"unlock_level"},Tn.Mode={ENDLESS:"endless",LEVEL:"level"},Tn.Event={COMPLETED:"completed",UPDATE:"update",FAILED:"failed"};let Ps=Tn;const Xf=class Xf{constructor(){this.challenges=[],this.data=K.find("dailyChallengeData.json").resources,this.generateChallenges();let e=new Date,t=new Date(Y.currentDate);e.getDate()!==t.getDate()||e.getMonth()!==t.getMonth()||e.getFullYear()!==t.getFullYear()?(this._resetChallenges(),this.randomizeChallenges(),Y.currentDate=e.toString()):this.setDataChallenges()}static get instance(){return this._instance||(this._instance=new Xf),this._instance}update(e){this.challenges.forEach(t=>{t.update(e)})}generateChallenges(){this.data.forEach(e=>{let t=new Ps(e);this.challenges.push(t),t.emitter.on(Ps.Event.COMPLETED,this._onChallengeCompleted.bind(this)),t.emitter.on(Ps.Event.UPDATE,this._onChallengeUpdated.bind(this))})}setDataChallenges(){let e=Y.getDailyChallengeData();for(let t=0;t<e.length;t++){let s=e[t],i=this._findDailyChallengeById(s.id);i&&i.setData(s)}}randomizeChallenges(){this.challenges.forEach(e=>{e.randomize()})}updateCollectChallenge(e){this._updateChallenge(Ps.Type.COLLECT,e)}updateReachLevelChallenge(e){this._updateChallenge(Ps.Type.REACH_LEVEL,e)}updateReachScoreChallenge(e){this.challenges.forEach(t=>{if(t.type===Ps.Type.REACH_SCORE){if(e<=t.progress)return;let s=t.progress;t.updateProgress(e-s)}})}updateReachJumpChallenge(e){this._updateChallenge(Ps.Type.REACH_JUMP,e)}updateUnlockSkinChallenge(e){this._updateChallenge(Ps.Type.UNLOCK_CHARACTER,e)}updateUnlockLevelChallenge(e){this._updateChallenge(Ps.Type.UNLOCK_LEVEL,e)}_updateChallenge(e,t){this.challenges.forEach(s=>{s.type===e&&s.updateProgress(t)})}_resetChallenges(){Y.setDailyChallengeData([])}_onChallengeUpdated(e){let t=Y.getDailyChallengeData(),s=!1;if(t.forEach(i=>{i.type===e.type&&i.id===e.id&&(i.progress=e.progress,s=!0)}),!s){let i={id:e.id,type:e.type,currentGoal:e.currentGoal,progress:e.progress,completed:!1,claimed:!1};t.push(i)}Y.setDailyChallengeData(t)}_onChallengeCompleted(e){let t=Y.getDailyChallengeData();t.forEach(s=>{s.type===e.type&&s.id===e.id&&(s.completed=!0)}),Y.setDailyChallengeData(t)}_findDailyChallengeById(e){return this.challenges.find(t=>t.id===e)}};Xf.Event={UPDATE:"update",COMPLETED:"completed"};let Ls=Xf;const gr=class gr{static init(){this._initTutorialData(),this._initChallengeData(),this._initDailyChallengeData(),this._initSkinData(),this._initCurrency(),this._initHighestScore(),this._firstOpen=ye.instance.getBoolean(O.STORAGE_KEY_FIRST_OPEN,!1)}static _initTutorialData(){let e=ye.instance.getItem(O.STORAGE_KEY_IS_TUTORIAL_COMPLETED);e===null?(this._isTutorialCompleted=!1,ye.instance.setItem(O.STORAGE_KEY_IS_TUTORIAL_COMPLETED,this._isTutorialCompleted)):this._isTutorialCompleted=e==="true"}static get firstOpen(){return this._firstOpen}static set firstOpen(e){this._firstOpen=e,ye.instance.setItem(O.STORAGE_KEY_FIRST_OPEN,e)}static _initChallengeData(){this._currentChallengeLevel=ye.instance.getInt(O.STORAGE_KEY_CURRENT_CHALLENGE_LEVEL),this._currentChallengeLevel===0&&(this._currentChallengeLevel=1,ye.instance.setItem(O.STORAGE_KEY_CURRENT_CHALLENGE_LEVEL,this._currentChallengeLevel)),this._highestChallengeLevel=ye.instance.getInt(O.STORAGE_KEY_HIGHEST_CHALLENGE_LEVEL),this._highestChallengeLevel===0&&(this._highestChallengeLevel=1,ye.instance.setItem(O.STORAGE_KEY_HIGHEST_CHALLENGE_LEVEL,this._highestChallengeLevel)),this._currentMode=ye.instance.getString(O.STORAGE_KEY_CURRENT_MODE,Ie.Type.Endless)}static _initSkinData(){const e=ye.instance.getItem(O.STORAGE_KEY_SKIN_UNLOCKED);try{this._skinUnlocked=JSON.parse(e)||[O.STORAGE_KEY_DEFAULT_SKIN],ye.instance.setItem(O.STORAGE_KEY_SKIN_UNLOCKED,JSON.stringify(this._skinUnlocked))}catch{this._skinUnlocked=[]}this._currentSkin=ye.instance.getItem(O.STORAGE_KEY_CURRENT_SKIN),this._currentSkin||(this._currentSkin=O.STORAGE_KEY_DEFAULT_SKIN,ye.instance.setItem(O.STORAGE_KEY_CURRENT_SKIN,this._currentSkin))}static _initDailyChallengeData(){let e=ye.instance.getObject(O.STORAGE_KEY_DAILY_CHALLENGE_DATA);if(ve.isObjectEmpty(e)?(this._dailyChallengeData=[],ye.instance.setItem(O.STORAGE_KEY_DAILY_CHALLENGE_DATA,JSON.stringify(this._dailyChallengeData))):this._dailyChallengeData=e,this._currentDate=ye.instance.getString(O.STORAGE_KEY_CURRENT_DATE),!this._currentDate){let s=new Date("1970-01-01");this._currentDate=s.toString(),ye.instance.setItem(O.STORAGE_KEY_CURRENT_DATE,this._currentDate)}}static get currentDate(){return this._currentDate}static set currentDate(e){this._currentDate=e,ye.instance.setItem(O.STORAGE_KEY_CURRENT_DATE,e)}static getDailyChallengeData(){return this._dailyChallengeData}static setDailyChallengeData(e){this._dailyChallengeData=e,ye.instance.setItem(O.STORAGE_KEY_DAILY_CHALLENGE_DATA,JSON.stringify(this._dailyChallengeData))}static IsSkinUnlocked(e){return this._skinUnlocked.includes(e)}static unlockSkin(e){if(!this._skinUnlocked.includes(e)&&(this._skinUnlocked.push(e),ye.instance.setItem(O.STORAGE_KEY_SKIN_UNLOCKED,JSON.stringify(this._skinUnlocked)),this._skinUnlocked.length===2)){let t=window.LAGGED_SDK_CONFIG;Wt.saveAchievement(t.API_AWARDS.unlockNewSkin)}}static updateHighestChallengeLevel(){this._currentChallengeLevel>this._highestChallengeLevel&&(this._highestChallengeLevel=this._currentChallengeLevel,ye.instance.setItem(O.STORAGE_KEY_HIGHEST_CHALLENGE_LEVEL,this._highestChallengeLevel),Ls.instance.updateUnlockLevelChallenge(1))}static _initCurrency(){this._currency=ye.instance.getInt(O.STORAGE_KEY_CURRENCY,this._currency),this.currency||(this.currency=O.DEFAULT_CURRENCY,ye.instance.setItem(O.STORAGE_KEY_CURRENCY,this.currency))}static saveCurrency(){ye.instance.setItem(O.STORAGE_KEY_CURRENCY,this._currency)}static _initHighestScore(){this._highestScore=ye.instance.getInt(O.STORAGE_KEY_HIGHEST_SCORE),this._highestScore===0&&ye.instance.setItem(O.STORAGE_KEY_HIGHEST_SCORE,this._highestScore)}static get highestScore(){return this._highestScore}static set highestScore(e){this._highestScore=e,ye.instance.setItem(O.STORAGE_KEY_HIGHEST_SCORE,e)}static get currentMode(){return this._currentMode}static set currentMode(e){this._currentMode=e,ye.instance.setItem(O.STORAGE_KEY_CURRENT_MODE,e)}static get highestChallengeLevel(){return this._highestChallengeLevel}static get currentChallengeLevel(){return this._currentChallengeLevel}static set currentChallengeLevel(e){this._currentChallengeLevel=e,ye.instance.setItem(O.STORAGE_KEY_CURRENT_CHALLENGE_LEVEL,e)}static get currentSkin(){return this._currentSkin}static set currentSkin(e){this._currentSkin=e,ye.instance.setItem(O.STORAGE_KEY_CURRENT_SKIN,this.currentSkin)}static get currency(){return this._currency}static set currency(e){this._currency=e,this.emitter.emit(this.Event.CurrencyChanged),this.saveCurrency()}static get isTutorialCompleted(){return this._isTutorialCompleted}static set isTutorialCompleted(e){this._isTutorialCompleted=e,ye.instance.setItem(O.STORAGE_KEY_IS_TUTORIAL_COMPLETED,e)}};gr.Event={CurrencyChanged:"currency-changed"},gr._isTutorialCompleted=!1,gr._currentChallengeLevel=0,gr._highestChallengeLevel=0,gr._currency=0,gr.emitter=new zC;let Y=gr;class YW{static vibrate(e=.1){navigator.vibrate&&ni.get("vibration")&&navigator.vibrate(e*1e3)}}class Vt{static init(e){this.emitter=new zC,this.state=e}static get state(){return this._state}static set state(e){this._state!==e&&(this.prevState=this.state,this._state=e,this.emitter&&this.emitter.emit("changed",this.state,this.prevState))}static isState(...e){for(let t=0;t<e.length;t++)if(e[t]===this.state)return!0;return!1}static registerOnStateChangedCallback(e){this.emitter.on("changed",e)}static removeOnStateChangedCallback(e){this.emitter.off("changed",e)}}var zt=(r=>(r.MainMenu="mainmenu",r.Playing="playing",r.Paused="paused",r.Lose="lose",r.Win="win",r.GameOver="gameover",r.Tutorial="tutorial",r.AutoPlay="autoplay",r.AutoPlayOver="autoplayover",r.Revive="revive",r))(zt||{});const De=class De extends ${constructor(){super("player"),this.currentCheckPointPos=null,this.currentPosMap=y.ZERO,this.tapJump=null,this.isCollision=!1,this.scale=.004,this._position=new y(-.8,-.2,.001),this._bodyCollisionEntity=null,this._collisionSizeNormal=new y(.052,.06,1),this._linearOffsetNormal=new y(0,0,0),this._collisionSizeBendDown=new y(.075,.035,1),this._linearOffsetBendDown=new y(0,0,0),this._angularOffsetNormal=new P(0,0,0,1),this._angularOffsetBendDown=new P(0,0,0,1),this._isKeyDownPressing=!1,this._isAllowJump=!1,this._isAllowBendDown=!1,this.skinStatData=[],this.objectEntity=null,this.isImmortal=!1,this.forceRequireJump=!1,this.forceRequireBendDown=!1,De._instance=this,this._init(),this.setLocalScale(this.scale,this.scale,this.scale),this.setLocalPosition(this._position)}static get instance(){return this._instance||(this._instance=new De),this._instance}_init(){this._loadSkinStatData(),this._addController(),this._initSprite(),this._initPhysics(),this._registerCollisionEvents(),this.loadSkin(Y.currentSkin)}_loadSkinStatData(){this.skinStatData=K.find("skinStatData.json").resources,this.skinStatData||console.warn("Skin stat data not found")}_addController(){this.controller=this.addScript(ga,{attributes:{}}),this.controller.on(ga.Event.KEY_UP_PRESSED,this.jump.bind(this)),this.controller.on(ga.Event.KEY_SPACE_PRESSED,()=>{Y.currentMode!==Ie.Type.Tutorial&&this.jump()}),this.controller.on(ga.Event.KEY_DOWN_PRESSED,this._onKeyDownPressed.bind(this)),this.controller.on(ga.Event.KEY_DOWN_RELEASED,this._onKeyDownReleased.bind(this))}_onKeyDownPressed(){this.forceRequireJump||!this._isAllowBendDown&&!this.forceRequireBendDown||(this.rigidbody.linearVelocity=new y(0,-2,0),this.controller.onGround&&(this.controller.isBending=!0,this._bodyCollisionEntity.collision.halfExtents=this._collisionSizeBendDown,this._bodyCollisionEntity.collision.linearOffset=this._linearOffsetBendDown,this._bodyCollisionEntity.collision.angularOffset=this._angularOffsetBendDown,this.changeAnimation(De.ANIMATION_NAME.BEND_DOWN)),this._isKeyDownPressing=!0,this.forceRequireBendDown&&(this.forceRequireBendDown=!1,this.fire(De.Event.BendDownStarted)))}_onKeyDownReleased(){this._bodyCollisionEntity.collision.halfExtents=this._collisionSizeNormal,this._bodyCollisionEntity.collision.linearOffset=this._linearOffsetNormal,this._bodyCollisionEntity.collision.angularOffset=this._angularOffsetNormal,this._isKeyDownPressing=!1,this.controller.isBending=!1,this.changeAnimation(De.ANIMATION_NAME.RUN)}jump(){var e;this.controller.isBending||!this.controller.onGround||this.forceRequireBendDown||!this._isAllowJump&&!this.forceRequireJump||(this.rigidbody.linearVelocity=y.ZERO,(e=this.rigidbody)==null||e.applyImpulse(new y(0,2.3,0)),Ls.instance.updateReachJumpChallenge(1),this.changeAnimation(De.ANIMATION_NAME.JUMP),Se.play("sfx_jump"),this.forceRequireJump&&(this.forceRequireJump=!1,this.fire(De.Event.JumpStarted)),this.tapJump&&(this.tapJump.playCollisionEffect(),this.tapJump=null))}_initSprite(){this.objectEntity=new $("player"),this.addChild(this.objectEntity),this.objectEntity.addComponent("sprite",{type:"sprite"}),this.objectEntity.setLocalScale(.3,.3,.3)}async loadSkin(e){let t=this.skinStatData.find(f=>f.name===e);if(!t){console.warn(`Skin stat not found for ${e}`);return}this.objectEntity.sprite&&(this.objectEntity.sprite.clips={},this.objectEntity.sprite.stop()),this._updateStat(t),await this._loadSpriteAnimation(`${e}_idle`);let s=K.find(`${e}_idle`),i=new Ht(this.objectEntity.sprite,{fps:t.idleAnimation.fps,loop:!0,name:De.ANIMATION_NAME.IDLE,spriteAsset:s.id});await this._loadSpriteAnimation(`${e}_run`);let n=K.find(`${e}_run`),a=new Ht(this.objectEntity.sprite,{fps:t.runAnimation.fps,loop:!0,name:De.ANIMATION_NAME.RUN,spriteAsset:n.id});await this._loadSpriteAnimation(`${e}_jump`);let o=K.find(`${e}_jump`),l=new Ht(this.objectEntity.sprite,{fps:t.jumpAnimation.fps,loop:!0,name:De.ANIMATION_NAME.JUMP,spriteAsset:o.id});await this._loadSpriteAnimation(`${e}_bend_down`);let c=K.find(`${e}_bend_down`),d=new Ht(this.objectEntity.sprite,{fps:t.bendDownAnimation.fps,loop:!0,name:De.ANIMATION_NAME.BEND_DOWN,spriteAsset:c.id});await this._loadSpriteAnimation(`${e}_die`);let h=K.find(`${e}_die`),u=new Ht(this.objectEntity.sprite,{fps:t.dieAnimation.fps,loop:!1,name:De.ANIMATION_NAME.DIE,spriteAsset:h.id});this.objectEntity.sprite.clips={idleAnimationClip:i,runAnimationClip:a,jumpAnimationClip:l,bendDownAnimationClip:d,dieAnimationClip:u},this.objectEntity.sprite.play(De.ANIMATION_NAME.IDLE),this.fire(De.Event.SkinLoaded)}_updateStat(e){this._collisionSizeNormal=this._arrayToVec3(e.bodyCollision.normalSize),this._bodyCollisionEntity.collision.halfExtents=this._collisionSizeNormal,this._linearOffsetNormal=this._arrayToVec3(e.bodyCollision.normalLinearOffset),this._bodyCollisionEntity.collision.linearOffset=this._linearOffsetNormal,this._angularOffsetNormal=this._arrayToVec4(e.bodyCollision.normalAngularOffset),this._bodyCollisionEntity.collision.angularOffset=this._angularOffsetNormal,this._collisionSizeBendDown=this._arrayToVec3(e.bodyCollision.bendDownSize),this._linearOffsetBendDown=this._arrayToVec3(e.bodyCollision.bendDownLinearOffset),this._angularOffsetBendDown=this._arrayToVec4(e.bodyCollision.bendDownAngularOffset),this.collision.halfExtents=this._arrayToVec3(e.collision.halfExtends),this.collision.linearOffset=this._arrayToVec3(e.collision.linearOffset)}async _loadSpriteAnimation(e){K.find(e)||(K.hasResource(e)?await K.loadResource(e,"spriteAnimations"):console.warn(`Asset not found ${e} in spriteAnimations`))}_initPhysics(){this._bodyCollisionEntity=new $(De.BODY_COLLISION_NAME),this.addChild(this._bodyCollisionEntity),this._bodyCollisionEntity.addComponent("collision",{type:"box",linearOffset:this._linearOffsetNormal,halfExtents:this._collisionSizeNormal,group:O.MASK_PLAYER,mask:vf|O.MASK_OBSTACLE|O.MASK_MAP_OBJECT}),this._bodyCollisionEntity.addComponent("rigidbody",{type:"kinematic",angularFactor:new y(0,0,0),linearFactor:new y(1,1,1),useGravity:!0,restitution:0,group:O.MASK_PLAYER,mask:vf|O.MASK_OBSTACLE|O.MASK_MAP_OBJECT}),this.addComponent("rigidbody",{type:"dynamic",angularFactor:new y(0,0,0),linearFactor:new y(0,1,0),useGravity:!0,restitution:0,friction:0,group:O.MASK_PLAYER,mask:O.MASK_GROUND}),this.addComponent("collision",{type:"box",halfExtents:new y(.04,.05,1),linearOffset:new y(-.0112,-.01,0),group:O.MASK_PLAYER,mask:O.MASK_GROUND});let e=this.rigidbody.body;e.setContactProcessingThreshold(0),e.setCcdMotionThreshold(1e-7),e.setCcdSweptSphereRadius(.05)}_registerCollisionEvents(){var e,t,s,i;this.collision.on("collisionstart",this._onCollisionStart,this),this.rigidbody.on("triggerenter",this._onCollisionStart,this),this.collision.on("collisionend",this._onCollisionEnd,this),this.rigidbody.on("triggerleave",this._onCollisionEnd,this),(e=this._bodyCollisionEntity)==null||e.collision.on("collisionstart",this._onBodyCollisionStart,this),(t=this._bodyCollisionEntity)==null||t.collision.on("collisionend",this._onBodyCollisionEnd,this),(s=this._bodyCollisionEntity)==null||s.rigidbody.on("triggerenter",this._onBodyCollisionStart,this),(i=this._bodyCollisionEntity)==null||i.rigidbody.on("triggerleave",this._onBodyCollisionEnd,this)}_onCollisionStart(e){let t=e.other?e.other.name:e.name;this.controller.isRunning&&t===O.GROUND_NAME&&(this.controller.onGround=!0,this.changeAnimation(De.ANIMATION_NAME.RUN),this._isKeyDownPressing&&(this.rigidbody.linearVelocity=y.ZERO,this._onKeyDownPressed()))}_onCollisionEnd(e){let t=e.other?e.other.name:e.name;this.controller.isRunning&&t===O.GROUND_NAME&&(this.controller.onGround=!1)}_onBodyCollisionStart(e){if(this.isImmortal)return;let t=e.other?e.other.name:e.name;if(t===O.OBSTACLE_COLLISION_NAME&&this._handleCollisionWithObstacle(),t===O.FINISH_POINT_NAME&&(this.currentCheckPointPos=null,this.currentPosMap=y.ZERO,this._onReachFinishPoint()),t===O.AUTO_JUMP_POINT_NAME&&(this.controller.onGround=!0,e.other.parent.playEffectCollision(),this.jump()),t===O.TAP_JUMP_POINT_NAME&&(this.controller.onGround=!0,this.tapJump=e.parent),t===O.COIN_NAME&&(this.collectCoin(),e.other?e.other.destroy():e.destroy()),t===O.CHECK_POINT_NAME){this.currentCheckPointPos=e.getPosition();let s=this.levelManager.currentLevel;this.currentPosMap=s._map.getLocalPosition().clone(),e.parent.playEffect(),(!this._isAllowBendDown||!this._isAllowJump)&&(this._isAllowBendDown=!0,this._isAllowJump=!0)}if(t===O.JUMP_INSTRUCTION_NAME){if(this.controller.isDead)return;this.fire(De.Event.CollideJumpTutorial)}if(t===O.BEND_DOWN_INSTRUCTION_NAME){if(this.controller.isDead||Vt.state!==zt.Playing)return;this.fire(De.Event.CollideBendDownTutorial)}}_handleCollisionWithObstacle(){this.isImmortal||this.isCollision||(Vt.state!==zt.Playing&&(Vt.state=zt.Playing),this.isCollision=!0,this.tapJump=null,this.controller.isDead=!0,this.controller.touchedDown=!1,this.changeAnimation(De.ANIMATION_NAME.IDLE),Vt.state=zt.Paused,this.controller.isRunning=!1,this.fire(De.Event.ReachCheckPoint),Se.play("sfx_collision"),YW.vibrate(),Q.createCountTween({duration:.1,onComplete:()=>{this.isCollision=!1}}).start())}collectCoin(){Se.play("sfx_collect_coin"),this.fire(De.Event.CoinCollected)}_onBodyCollisionEnd(e){let t=e.other?e.other.name:e.name;t===O.AUTO_JUMP_POINT_NAME&&(this.controller.onGround=!1),t===O.TAP_JUMP_POINT_NAME&&(this.controller.onGround=!1)}_onReachFinishPoint(){this.controller.unregisterTouchEvent(),this.controller.isBending&&this._onKeyDownReleased(),this.controller.isRunning=!1,this.rigidbody.type="static",this.controller.isFinished=!0,this.changeAnimation(De.ANIMATION_NAME.IDLE),Y.currentMode===Ie.Type.Tutorial?(Y.isTutorialCompleted=!0,Gt.log("tutorial_completed",{name:"true"})):(Y.currentChallengeLevel++,Y.updateHighestChallengeLevel()),this.fire(De.Event.ReachFinishPoint)}_arrayToVec3(e){return e.length<3?(console.warn("Invalid array to convert to Vec3"),new y):new y(e[0],e[1],e[2])}_arrayToVec4(e){return e.length<4?(console.warn("Invalid array to convert to Vec4"),new P):new P(e[0],e[1],e[2],e[3])}forceStopAnimation(){var e;this.controller.isBending&&this._onKeyDownReleased(),(e=this.objectEntity.sprite)==null||e.pause()}pause(){this.forceStopAnimation(),this.rigidbody.type="static",this.controller.isRunning=!1}resume(){var e;this.rigidbody.type="dynamic",this.controller.isRunning=!0,(e=this.objectEntity.sprite)==null||e.resume()}run(){this.controller.isRunning=!0,this.changeAnimation(De.ANIMATION_NAME.RUN)}die(){this.isImmortal||this.controller.isDead||(this.controller.unregisterTouchEvent(),this.controller.isBending&&this._onKeyDownReleased(),this.controller.isDead=!0,this.controller.isRunning=!1,this.rigidbody.type="static",this.changeAnimation(De.ANIMATION_NAME.DIE),this.fire(De.Event.Dead))}reset(){this.currentCheckPointPos=null,this.currentPosMap=y.ZERO,this.controller.isDead=!1,this.controller.onGround=!0,this.controller.isBending=!1,this.controller.isFinished=!1,this.controller.isRunning=!1,this.isImmortal=!1,this.forceRequireBendDown=!1,this.forceRequireJump=!1,this._isKeyDownPressing=!1,this.setLocalPosition(this._position),this.rigidbody.type="dynamic",this.changeAnimation(De.ANIMATION_NAME.IDLE),this._isAllowBendDown=Y.currentMode!==Ie.Type.Tutorial,this._isAllowJump=Y.currentMode!==Ie.Type.Tutorial}changeAnimation(e){this.objectEntity&&this.currentAnimation()!==e&&this.objectEntity.sprite.play(e)}currentAnimation(){return this.objectEntity.sprite.currentClip?this.objectEntity.sprite.currentClip.name:""}onRevive(){if(this.currentCheckPointPos){let t=this.currentCheckPointPos.y+O.REVIVE_OFFSET+this._position.y;this.setLocalPosition(this._position.x,t,this._position.z)}else this.setLocalPosition(this._position.x,-.235,this._position.z);this.levelManager.currentLevel._map.setLocalPosition(this.currentPosMap),this.forceRequireBendDown=!1,this.forceRequireJump=!1,this.controller.isDead=!1,this._isKeyDownPressing=!1}};De.ANIMATION_NAME={IDLE:"idle",RUN:"run",BEND_DOWN:"bend_down",DIE:"die",JUMP:"jump"},De.Event={SkinLoaded:"player:skinLoaded",Dead:"player:dead",ReachFinishPoint:"player:reachFinishPoint",CoinCollected:"player:collectCoin",ReachCheckPoint:"player:reachCheckPoint",CollideJumpTutorial:"player:collideJumpTutorial",CollideBendDownTutorial:"player:collideBendDownTutorial",JumpStarted:"player:jumpStarted",BendDownStarted:"player:bendDownStarted"},De.BODY_COLLISION_NAME="bodyCollision";let Ye=De;class VC extends ${constructor(e){super(e),this.type=e}destroy(){super.destroy()}getType(){return this.type}onCollisionStart(e){e.name===Ye.BODY_COLLISION_NAME&&Ye.instance.die()}async loadSpriteAsset(e,t="spriteAnimations"){K.find(e)||(K.hasResource(e)?await K.loadResource(e,t):console.warn(`Asset not found ${e} in ${t}`))}stopAnimation(){}}class ZW extends VC{constructor(){super("birdObstacle"),this.objScale=.001,this._initSprite(),this._initCollision(),this._registerEventCollision()}async _initSprite(){this.object=new $,this.addChild(this.object),this.object.addComponent("sprite",{type:Ur}),await this.loadSpriteAsset("bird_fly");let e=K.find("bird_fly"),t=new Ht(this.object.sprite,{fps:6,loop:!0,name:"fly",spriteAsset:e.id});this.object.sprite.clips={flyAnimationClip:t},this.object.sprite.play("fly"),this.object.setLocalScale(this.objScale,this.objScale,this.objScale)}_initCollision(){this.object.addComponent("collision",{type:"box",halfExtents:new y(.038,.015,.1),linearOffset:new y(.002,.002,0),angularOffset:new P(0,0,-.2,1)})}_registerEventCollision(){this.object.collision.on("collisionstart",this.onCollisionStart,this),this.object.collision.on("triggerenter",this.onCollisionStart,this)}playFlyAnimation(){this.object.sprite.play("fly")}stopAnimation(){this.object.sprite.stop()}}class GC extends ${constructor(e){super(),this.obstacleSpawner=null,this._obstacleName="",this._obstacleName=e,this.initialize()}initialize(){}spawnObstacle(e){return this.obstacleSpawner.spawn(e)}getObstacleName(){return this._obstacleName}}class JW extends GC{constructor(){super("birdObstacle"),this._randomPosY=[-.17,-.24,-.06]}initialize(){this.obstacleSpawner=this.addScript(zn,{attributes:{class:ZW,poolSize:10}})}spawnObstacle(e){let t=this.obstacleSpawner.spawn(e);t.playFlyAnimation();let s=new y(0,ve.randomFromList(this._randomPosY),0);return t.setLocalPosition(s),t}}class Nf{static async loadModel(e){let t=K.find(e);if(!t)if(K.hasResource(e,"model"))t=await K.loadResource(e,"model");else return console.error(`Model ${e} not found`),null;return t}static async loadGameSprite(e){let t=K.find(e);t||K.hasResource(e,"texture")&&(t=await K.loadResource(e,"texture"));let s=new sc;return s.texture=t.resource,s.texture.name=e,s.frames={[e]:{rect:new P(0,0,s.texture.width,s.texture.height),pivot:new M(.5,.5),border:new P(0,0,0,0)}},new tc(Z.app.graphicsDevice,{atlas:s,frameKeys:[e],pixelsPerUnit:1})}static async loadAnim(e){let t=K.find(e);if(!t)if(K.hasResource(e,"animation"))t=await K.loadResource(e,"animation");else return console.error(`Animation ${e} not found`),null;return t}static async loadTexture(e){let t=K.find(e);if(!t)if(K.hasResource(e,"texture"))t=await K.loadResource(e,"texture");else return console.error(`Texture ${e} not found`),null;return t}}const qf=class qf extends VC{constructor(){super("cactusObstacle"),this._cactusList=[],this._initHolder(),this.randomizeCactus()}_initHolder(){this._holder=new $("cactusHolder"),this._holder.setLocalPosition(0,-.23,0),this.addChild(this._holder)}async _initSmallCactus(){let e=new $("smallCactus"),t=await Nf.loadGameSprite("spr_cactus_obstacle_small");return this._holder.addChild(e),e.addComponent("sprite",{type:Ur,sprite:t}),e.setLocalScale(7e-4,7e-4,7e-4),e.setLocalPosition(0,-.032,0),e.addComponent("collision",{type:"box",halfExtents:new y(.015,.03,.02)}),e.collision.on("collisionstart",this.onCollisionStart,this),e.collision.on("triggerenter",this.onCollisionStart,this),e}async _initBigCactus(){let e=new $("bigCactus");this._holder.addChild(e);let t=await Nf.loadGameSprite("spr_cactus_obstacle_big");return e.addComponent("sprite",{type:Ur,sprite:t}),e.setLocalScale(7e-4,7e-4,7e-4),e.setLocalPosition(0,-.018,0),e.addComponent("collision",{type:"box",halfExtents:new y(.023,.045,.02)}),e.collision.on("collisionstart",this.onCollisionStart,this),e.collision.on("triggerenter",this.onCollisionStart,this),e}async randomizeCactus(){this._cactusList=[],this._removeAllCactus();let e=ve.randomFromList(qf.CactusData.randomList);for(let t=0;t<e.length;t++){let s=await this._createCactus(e[t]);if(s){this._cactusList.push(s);let i=s.getLocalPosition();if(t===0)s.setLocalPosition(0,i.y,i.z);else{let n=this._cactusList[t-1],a=this._getOffsetX(s.name,n.name);s.setLocalPosition(n.getLocalPosition().x+a,i.y,i.z)}}}}async _removeAllCactus(){[...this._holder.children].forEach(t=>{this._holder.removeChild(t),t.destroy()})}_getOffsetX(e,t){return e==="smallCactus"&&t==="smallCactus"?.045:e==="bigCactus"&&t==="bigCactus"?.065:.055}async _createCactus(e){let t=null;switch(e){case 1:t=await this._initSmallCactus();break;case 2:t=await this._initBigCactus();break}return t}};qf.CactusData={randomList:[[1],[2],[1,1],[1,2],[2,2],[2,1],[1,2,1],[1,1,1]]};let ry=qf;class QW extends GC{constructor(){super("cactusObstacle")}initialize(){this.obstacleSpawner=this.addScript(zn,{attributes:{class:ry,poolSize:10}})}spawnObstacle(e){let t=this.obstacleSpawner.spawn(e);return t.randomizeCactus(),t}}const ej={birdObstacle:JW,cactusObstacle:QW};class tj extends Rt{constructor(){super(...arguments),this.obstacleTypes=[],this.initialDistanceBetweenObstacles=10,this._spawnControllerList=[],this._isInitialized=!1}static get scriptName(){return"ObstacleSpawner"}initialize(){this._isInitialized||(this._spawnControllerList=[],this.obstacleTypes.forEach(e=>{let t=ej[e],s=new t;this._spawnControllerList.push(s),this.entity.addChild(s)}),this._isInitialized=!0)}spawnObstacle(e,t){let s=this._findSpawner(e);return s?s.spawnObstacle(t):null}_findSpawner(e){return this._spawnControllerList.find(s=>s.getObstacleName().toLocaleLowerCase()===e.toLocaleLowerCase())}}const Kf=class Kf extends Rt{constructor(){super(...arguments),this.entityCheck=null,this.z=0,this._isOutOfScreen=!1}static get scriptName(){return"CheckOutOfScreen"}initialize(){}update(){this._isOutOfScreen||this.entityCheck.getLocalPosition().x<this.z&&(this._isOutOfScreen=!0,this.fire(Kf.Event.OutOfScreen))}reset(){this._isOutOfScreen=!1}};Kf.Event={OutOfScreen:"outOfScreen"};let Pi=Kf;class sj extends ${constructor(){super("cloud"),this.moveSpeed=0,this._initSprite(),this.setLocalScale(.001,.001,.001)}_initSprite(){this.addComponent("sprite",{type:Ur,spriteAsset:K.find("spr_cloud")})}update(e){let t=this.moveSpeed*e,s=this.getPosition(),i=new y(s.x-t,s.y,s.z);this.setLocalPosition(i)}}class HC extends ${constructor(e){super("decor"),this.isMoving=!1,this.data=e,this.initHolder(),this.initSpawner(),Z.app.on("update",this.update,this)}initHolder(){}initSpawner(){}preSpawn(){}update(e){}}class ij extends HC{constructor(e){super(e),this.cloudList=[],this.maxCloud=10,this.data.isPreSpawn&&this.preSpawn()}initHolder(){this.holder=new $("cloudHolder"),this.holder.setLocalPosition(0,0,0),this.addChild(this.holder)}initSpawner(){this.spawner=this.addScript(zn,{attributes:{class:sj,poolSize:10}})}preSpawn(){for(let e=0;e<this.maxCloud;e++)this._spawnCloud()}update(e){this.isMoving&&(this.cloudList.length<this.maxCloud&&this._spawnCloud(),this._moveAllCloud(e))}_spawnCloud(){let e=this.spawner.spawn(this.holder);e.moveSpeed=this.data.moveSpeed;let t=e.getScript(Pi);if(t)t.enabled=!0,t.reset();else{let a=e.addScript(Pi,{attributes:{entityCheck:e,z:-2}});a.on(Pi.Event.OutOfScreen,()=>{e.moveSpeed=0,e.fire(zn.Event.Despawn),a.enabled=!1,this._removeCloudFromList()})}this.cloudList.push(e);let s=ve.random(this.data.randomDistance[0],this.data.randomDistance[1]),i=ve.random(this.data.randomPosY[0],this.data.randomPosY[1]),n=this.data.initialPosX;this.cloudList.length>1&&(n=this.cloudList[this.cloudList.length-2].getLocalPosition().x+s),e.setPosition(n,i,0)}_removeCloudFromList(){[...this.cloudList].forEach((t,s)=>{t.enabled||this.cloudList.splice(s,1)})}_moveAllCloud(e){this.cloudList.forEach(t=>{t.update(e)})}}class nj extends ${constructor(){super("ground"),this.moveSpeed=0,this.width=0,this._initSprite(),this.setLocalScale(.001,.001,.001)}async _initSprite(){let e=await Nf.loadGameSprite("spr_ground_01_dino_theme");this.addComponent("sprite",{type:Ur,sprite:e}),this.changeSprite("spr_ground_01_dino_theme")}update(e){let t=this.moveSpeed*e,s=this.getLocalPosition(),i=new y(s.x-t,s.y,s.z);this.setLocalPosition(i)}async changeSprite(e){let t=await Nf.loadGameSprite(e);if(!t){console.error("Sprite not found: ",e);return}this.sprite&&(this.sprite.sprite=t)}}class V0 extends HC{constructor(e){super(e),this.groundList=[],this.maxGround=5,this.speed=1.2,this.data.isPreSpawn&&this.preSpawn()}initHolder(){this.holder=new $("groundHolder"),this.holder.setLocalPosition(0,-.28,0),this.addChild(this.holder)}initSpawner(){this.spawner=this.addScript(zn,{attributes:{class:nj,poolSize:10}})}preSpawn(){for(let e=0;e<this.maxGround;e++)this._spawnGround()}update(e){this.isMoving&&(this.groundList.length<this.maxGround&&this._spawnGround(),this._moveAllGround(e))}_spawnGround(){let e=this.spawner.spawn(this.holder),t=ve.randomInt(0,this.data.sprites.length-1),s=this.data.sprites[t];e.changeSprite(s),e.moveSpeed=this.speed;let i=e.getScript(Pi);if(i)i.enabled=!0,i.reset();else{let a=e.addScript(Pi,{attributes:{entityCheck:e,z:-2}});a.on(Pi.Event.OutOfScreen,()=>{e.moveSpeed=0,e.fire(zn.Event.Despawn),a.enabled=!1,this._removeGroundFromList()})}this.groundList.push(e);let n=this.data.initialPosX;this.groundList.length>1&&(n=this.groundList[this.groundList.length-2].getLocalPosition().x+this.data.distanceBetweenGround),e.setLocalPosition(n,this.data.posY[t],0)}_removeGroundFromList(){[...this.groundList].forEach((t,s)=>{t.enabled||this.groundList.splice(s,1)})}_moveAllGround(e){this.groundList.forEach(t=>{t.update(e)})}setMoveSpeed(e){this.speed=e,this.groundList.forEach(t=>{t.moveSpeed=e})}}const WC={cloud:ij,ground:V0};class Nw extends Ie{constructor(e){super(),this.obstacleList=[],this.decorList=[],this.maxObstacles=10,this.obstacleMoveSpeed=1,this.distanceBetweenObstacles=0,this._offsetX=.3,this._spawnOffset=3,this._scoreStep=0,this.timeCounter=0,this.data=e.data,this._obstacleData=this.data.obstacle,this._initObstaclesSpawner()}async load(){this.obstacleMoveSpeed=this._obstacleData.initialSpeed,this.distanceBetweenObstacles=this._obstacleData.initialDistanceBetweenObstacles,this._loadDecor(),this.fire(Ie.Event.Loaded)}_loadDecor(){this.data.decorData.forEach(t=>{let s=new WC[t.decorType](t);this.addChild(s),this.decorList.push(s),s instanceof V0&&(this._groundDecor=s,this._groundDecor.setMoveSpeed(this.obstacleMoveSpeed))}),this._setMoveDecors(!1)}_setMoveDecors(e){this.decorList.forEach(t=>{t.isMoving=e})}start(){this.isStarted||(this.isPaused=!1,this._scoreStep=this.data.scoreStep.initial,this.isStarted=!0,this.timeCounter=0,this._setMoveDecors(!0),this.fire(Ie.Event.Start))}update(e){if(!(!this.isStarted||this.isPaused)){if(this.obstacleList.length<this.maxObstacles&&this._spawnObstacle(),this.timeCounter+=e,this.timeCounter>this.data.speedIncreaseInterval){let t=Math.min(this.obstacleMoveSpeed+this._obstacleData.speedIncrease,this._obstacleData.maxSpeed);if(this._playTweenIncreaseObstacleSpeed(this.obstacleMoveSpeed,t),t<this._obstacleData.maxSpeed){let s=this.distanceBetweenObstacles+this._obstacleData.distanceIncrease;this._playTweenIncreaseDistance(this.distanceBetweenObstacles,s),this._scoreStep+=this.data.scoreStep.increaseInterval}this.timeCounter=0}this._moveObstacles(e),this.score+=e*this._scoreStep,this.fire(Ie.Event.UpdateScore,Math.floor(this.score))}}stop(){this.isStarted=!1,this._setMoveDecors(!1),this.obstacleList.forEach(e=>{e.stopAnimation()})}setPause(e){this.isStarted&&(this.isPaused=e,this._setMoveDecors(!e),this.obstacleList.forEach(t=>{this._setPauseChildren(t,e)}))}_initObstaclesSpawner(){let e=new $("Obstacle");this.addChild(e),this.obstacleSpawner=e.addScript(tj,{attributes:{obstacleTypes:this._obstacleData.obstacleTypes,initialDistanceBetweenObstacles:this._obstacleData.initialDistanceBetweenObstacles}}),this.obstacleSpawner.initialize()}async _spawnObstacle(){let e=this.obstacleSpawner.spawnObstacle(this._obstacleData.obstacleTypes[ve.randomInt(0,this._obstacleData.obstacleTypes.length-1)],this);if(e===null)return;let t=e.getLocalPosition();this.obstacleList.push(e);let s=this._spawnOffset;if(this.obstacleList.length>1){s=this.obstacleList[this.obstacleList.length-2].getLocalPosition().x+this.distanceBetweenObstacles;let n=ve.random(-this._offsetX,this._offsetX);s+=n}e.setLocalPosition(s,t.y,0);let i=e.getScript(Pi);if(i)i.enabled=!0,i.reset();else{let n=e.addScript(Pi,{attributes:{entityCheck:e,z:-2}});n.on(Pi.Event.OutOfScreen,()=>{e.fire(zn.Event.Despawn),n.enabled=!1,this._removeObstacleFromList()})}}_moveObstacles(e){this.obstacleList.forEach(t=>{let s=this.obstacleMoveSpeed*e,i=t.getLocalPosition(),n=new y(i.x-s,i.y,i.z);t.setLocalPosition(n)})}_removeObstacleFromList(){[...this.obstacleList].forEach((t,s)=>{t.enabled||this.obstacleList.splice(s,1)})}_playTweenIncreaseObstacleSpeed(e,t){this.obstacleMoveSpeed>=t||Q.createTween({speed:e},{speed:t},{duration:2,onUpdate:s=>{this.obstacleMoveSpeed=s.speed,this._groundDecor.setMoveSpeed(s.speed)}}).start()}_playTweenIncreaseDistance(e,t){this.distanceBetweenObstacles>=t||Q.createTween({distance:e},{distance:t},{duration:1,onUpdate:s=>{this.distanceBetweenObstacles=s.distance}}).start()}_setPauseChildren(e,t){e.children.forEach(s=>{var i,n,a,o;t?((i=s.sprite)==null||i.pause(),(n=s.particlesystem)==null||n.pause()):((a=s.sprite)==null||a.resume(),(o=s.particlesystem)==null||o.unpause()),s.children.length>0&&this._setPauseChildren(s,t)})}destroy(){[...this.children].forEach(t=>{this.removeChild(t),t.destroy()}),this.obstacleList=[],this.decorList=[],super.destroy()}}class jC extends Rt{constructor(){super(...arguments),this.speed=new y}static get scriptName(){return"rotate"}initialize(){this._tempRot=new y}update(e){this.entity.rotateLocal(this.speed.x*e,this.speed.y*e,this.speed.z*e)}}const yr=class yr extends ${constructor(e,t=!1,s,i={autoLoad:!0}){super(e.name),this.isCaching=t,this.options=i,this.data=e,this.data.children=this.data.children||[],this._modelLoaded=!1,this._parentEntity=s,this._childrenLoaded=0,this.once(yr.Event.ModelLoaded,this.checkLoaded,this),(!this.options||this.options.autoLoad)&&this.load()}async load(){this._addTags(),this._applyTransformData();let e=[];e.push(this._initComponents()),await this._initComponents(),this.data.children.length===0&&(this.data.components&&!this.data.components.model||!this.data.components)&&this.checkLoaded();for(let t of this.children)t.load&&e.push(t.load());await Promise.allSettled(e)}_addTags(){this.data.tags&&this.data.tags.forEach(e=>{this.tags.add(e)})}_applyTransformData(){let e=this.data.eulerAngles||this.data.rotation;this.data.position&&this.setLocalPosition(...this.data.position),e&&this.setLocalEulerAngles(...e),this.data.scale&&this.setLocalScale(...this.data.scale)}async _initModel(e,t){if(e){let s=K.find(e);if(!s){if(K.hasResource(e))try{await K.loadResource(e,"model"),await this._initModel(e,t)}catch(i){console.error(i)}else console.error(`Model ${e} not found`);return}t.asset=s}t.castShadows=!1,this.addComponent("model",t),this._modelLoaded=!0,this.fire(yr.Event.ModelLoaded),this.options.layers&&(this.model.layers=this.options.layers)}_initParticle(e){for(let t in e)(t.toLowerCase().includes("asset")||t==="mesh")&&(e[t]=K.find(e[t]));this.addComponent("particlesystem",e)}async _initComponents(){if(this.data.components)for(let e in this.data.components)e==="model"?await this._initModel(this.data.components[e].asset,this.data.components[e]):e==="particlesystem"?this._initParticle(this.data.components[e]):e==="script"?this._initScripts(this.data.components[e]):(this.addComponent(e,this.data.components[e]),e==="rigidbody"&&(this.rigidbody.friction=0))}_initScripts(e){for(let t in e){let s=e[t];t==="rotate"&&this.addScript(jC,{speed:new y(s.speed)})}}get loaded(){let e=!0;return this.data.components&&this.data.components.model&&!this._modelLoaded&&(e=!1),this._childrenLoaded<this.data.children.length&&(e=!1),e}checkLoaded(){this.loaded&&(this.fire(yr.Event.Loaded),this._parentEntity&&this._parentEntity instanceof yr&&this._parentEntity.onChildLoaded())}onChildLoaded(){this._childrenLoaded+=1,this.checkLoaded(),this.fire(yr.Event.OnProgress,this._childrenLoaded/this.data.children.length)}};yr.Event={ModelLoaded:"resourceEntity:modelLoaded",Loaded:"resourceEntity:loaded",OnProgress:"resourceEntity:progress"};let Gr=yr;class Lr extends Gr{constructor(e,t=!1,s,i={autoLoad:!0}){super(e,t,s,i),this.mapObjectCollisionList=[],this.mapObjectCollisionList.push("FinishCollision","AutoJumpCollision","TapJumpCollision","CheckPointCollision","coin","JumpInstructionCollision","BendDownInstructionCollision")}async _initComponents(){if(this.data.components)for(let e in this.data.components)e==="model"?await this._initModel(this.data.components[e].asset,this.data.components[e]):e==="particlesystem"?this._initParticle(this.data.components[e]):e==="script"?this._initScripts(this.data.components[e]):e==="sprite"?this._initSprite(this.data.components[e]):(this.data.name==="ObstacleCollision"?this.data.components[e].group=O.MASK_OBSTACLE:this.data.name==="JumpCollision"?this.data.components[e].group=O.MASK_GROUND:this.mapObjectCollisionList.includes(this.data.name)&&(this.data.components[e].group=O.MASK_MAP_OBJECT),this.addComponent(e,this.data.components[e]),e==="rigidbody"&&(this.rigidbody.friction=0))}async _initSprite(e){e.type==="simple"?(e.sprite=await K.loadSprite(e.spriteAsset),this.addComponent("sprite",e)):e.type==="animated"&&console.warn("Animated sprite not supported yet")}}class rj extends Lr{constructor(e){super(e),this.loaded?this.onLoaded():this.once(Gr.Event.Loaded,this.onLoaded,this)}checkLoaded(){super.checkLoaded()}async onLoaded(){this.effect=this.findByName("effect"),this._initSmokeEffect(),this.playSmokeEffect(),this._initSpriteEffect()}async _initSpriteEffect(){let e=await K.loadSprite("tex_glow_inner_2");this.spriteEffect=new $,this.spriteEffect.addComponent("sprite",{type:Ur,sprite:e}),this.effect.addChild(this.spriteEffect),this.spriteEffect.setLocalPosition(0,.16,0),this.spriteEffect.sprite.opacity=0,this.initEffectCollision()}initEffectCollision(){this.scaleTween=Q.createScaleTween(this.effect,{x:5,y:5,z:5},{duration:.2,easing:Yt.Quadratic.InOut}),this.alphaTween=Q.createTween({alpha:0},{alpha:.5},{duration:.1,easing:Yt.Quadratic.Out,onUpdate:e=>{this.spriteEffect.sprite.opacity=e.alpha},onComplete:()=>{var e;(e=this.alphaTween2)==null||e.start()}}),this.alphaTween2=Q.createTween({alpha:.5},{alpha:0},{duration:.1,easing:Yt.Quadratic.In,onUpdate:e=>{this.spriteEffect.sprite.opacity=e.alpha}})}playEffectCollision(){var e,t;(e=this.scaleTween)==null||e.start(),(t=this.alphaTween)==null||t.start()}_initSmokeEffect(){this.fxSmoke=new $("blood_particle"),this.fxSmoke.setLocalPosition(0,-.2,0),this.fxSmoke.setLocalScale(.5,.5,.5),this.addChild(this.fxSmoke);const e=new St([[0,0],[0,2],[0,0]]),t=new St([[0,0],[0,1],[0,0]]),s=new St([[0,0],[0,0],[0,0]]),i=new St([[0,0],[0,0],[0,0]]);let n=new dt([0,.015,1,0]),a=new dt([0,.015,1,0]),o=new dt([0,.2,1,0]),l=K.find("tex_white").resource;this.fxSmoke.addComponent("particlesystem",{numParticles:100,lifetime:1,rate:.03,autoPlay:!0,loop:!0,emitterExtents:new y(2,0,0),colorMap:l,blendType:Bt,localSpace:!0,localVelocityGraph:e,localVelocityGraph2:t,VelocityGraph:s,VelocityGraph2:i,scaleGraph:n,scaleGraph2:a,alphaGraph:o})}playSmokeEffect(){var e,t;(e=this.fxSmoke.particlesystem)==null||e.reset(),(t=this.fxSmoke.particlesystem)==null||t.play()}}const dc=class dc extends Rt{static get scriptName(){return"CheckEnable"}initialize(){}update(){}onEnable(){this.fire(dc.Event.OnEnable)}onDisable(){this.fire(dc.Event.OnDisable)}};dc.Event={OnEnable:"onEnable",OnDisable:"onDisable"};let qi=dc;class aj extends Lr{constructor(e){super(e),this.loaded?this.onLoaded():this.once(Gr.Event.Loaded,this.onLoaded,this)}checkLoaded(){super.checkLoaded(),this.setLocalScale(7e-4,7e-4,7e-4)}async onLoaded(){this.sprite||this.addComponent("sprite",{type:wf}),K.find("bird_fly")||await K.loadResource("bird_fly","spriteAnimations");let t=K.find("bird_fly"),s=new Ht(this.sprite,{fps:6,loop:!0,name:"fly",spriteAsset:t.id});this.sprite.clips={flyAnimationClip:s},this.addComponent("collision",{type:"box",halfExtents:new y(.03,.015,1),group:O.MASK_OBSTACLE}),this.addComponent("rigidbody",{type:"kinematic",friction:0,restitution:0,group:O.MASK_OBSTACLE}),this.name=O.OBSTACLE_COLLISION_NAME,Ye.instance.on(Ye.Event.Dead,this._stopAnimation,this),this._checkEnableScript=this.addScript(qi),this._checkEnableScript.on(qi.Event.OnEnable,this._startAnimation,this),this._startAnimation()}_startAnimation(){this.sprite.play("fly")}_stopAnimation(){Ye.instance.off(Ye.Event.Dead,this._stopAnimation,this),this._checkEnableScript.off(qi.Event.OnEnable,this._startAnimation,this),this.sprite.stop()}destroy(){Ye.instance.off(Ye.Event.Dead,this._stopAnimation,this),this._checkEnableScript.off(qi.Event.OnEnable,this._startAnimation,this),super.destroy()}}class oj extends Lr{constructor(e){super(e),this.loaded?this.onLoaded():this.once(Gr.Event.Loaded,this.onLoaded,this)}checkLoaded(){super.checkLoaded(),this.setLocalScale(5e-4,5e-4,5e-4)}async onLoaded(){this.sprite||this.addComponent("sprite",{type:wf}),K.find("coin")||await K.loadResource("coin","spriteAnimations");let t=K.find("coin"),s=new Ht(this.sprite,{fps:15,loop:!0,name:"rotate",spriteAsset:t.id});this.sprite.clips={flyAnimationClip:s},this.sprite.play("rotate"),this.addComponent("collision",{type:"box",halfExtents:new y(.023,.023,1),group:O.MASK_MAP_OBJECT}),this.name=O.COIN_NAME,Ye.instance.on(Ye.Event.Dead,this._stopAnimation,this),this._checkEnableScript=this.addScript(qi),this._checkEnableScript.on(qi.Event.OnEnable,this._startAnimation,this),this._startAnimation()}_startAnimation(){this.sprite.play("rotate")}_stopAnimation(){Ye.instance.off(Ye.Event.Dead,this._stopAnimation,this),this._checkEnableScript.off(qi.Event.OnEnable,this._startAnimation,this),this.sprite.stop()}destroy(){Ye.instance.off(Ye.Event.Dead,this._stopAnimation,this),this._checkEnableScript.off(qi.Event.OnEnable,this._startAnimation,this),super.destroy()}}const lj=Object.freeze({}),G0=class G0 extends ${constructor(e,t=!1,s=lj,i={autoLoad:!0}){super(e.name||"map"),this.data=e,this.finish=null,this.isCaching=t,this._objectMapping=s,this.options=i,this.rootNode=this._addEntityNode(e,void 0,!1),this.rootNode.once(Lr.Event.Loaded,this.fire.bind(this,Lr.Event.Loaded)),this.options.autoLoad&&this.load(),this.addChild(this.rootNode)}load(){this.rootNode.load()}get loaded(){return this.rootNode.loaded}_addEntityNode(e,t,s=!0){let i=this._createEntityNode(e,t,s);return t==null||t.addChild(i),i}_createEntityNode(e,t,s=!0){var n;let i;return this._objectMapping[e.name]?i=new this._objectMapping[e.name](e,this.isCaching,t,{autoLoad:s}):(n=e.tags)==null||n.forEach(a=>{i||this._objectMapping[a]&&(i=new this._objectMapping[a](e,this.isCaching,t,{autoLoad:s}))}),i||(i=new Lr(e,this.isCaching,t,{autoLoad:s})),e.children&&e.children.length>0&&e.children.forEach(a=>{this._addEntityNode(a,i,s)}),i}};G0.Event={Loaded:"jsonEntity:loaded",Progress:"jsonEntity:progress"};let ay=G0;class hj extends Lr{constructor(e){super(e),this.loaded?this.onLoaded():this.once(Gr.Event.Loaded,this.onLoaded,this)}checkLoaded(){super.checkLoaded()}async onLoaded(){this.tapSprite=this.findByName("tapSprite"),this.rotateAnim=this.addScript(jC,{attributes:{speed:new y(0,0,100)}}),this._initAnimation(),this._initSmokeEffect(),this._initEffect(),this.playSmokeEffect()}_initAnimation(){this.scaleTween=Q.createScaleTween(this.tapSprite,{x:.6,y:.6,z:.6},{duration:2,loop:!0,yoyo:!0})}_initSmokeEffect(){this.fxSmoke=new $("blood_particle"),this.fxSmoke.setLocalPosition(0,0,0),this.fxSmoke.setLocalScale(.5,.5,.5),this.addChild(this.fxSmoke);const e=new St([[0,2],[0,2],[0,2]]),t=new St([[0,-2],[0,-2],[0,-2]]),s=new St([[0,0],[0,0],[0,0]]),i=new St([[0,0],[0,0],[0,0]]);let n=new dt([0,0,.8,.02,1,0]),a=new dt([0,0,.8,.01,1,0]),o=new dt([0,0,.8,.2,1,0]),l=K.find("tex_white").resource;this.fxSmoke.addComponent("particlesystem",{numParticles:50,lifetime:1,rate:.02,autoPlay:!0,loop:!0,emitterShape:Lb,emitterRadius:2,colorMap:l,blendType:Bt,localSpace:!0,localVelocityGraph:e,localVelocityGraph2:t,VelocityGraph:s,VelocityGraph2:i,scaleGraph:n,scaleGraph2:a,alphaGraph:o})}_initEffect(){this.glow=new $("particle"),this.glow.setLocalPosition(0,0,0),this.glow.setLocalScale(.1,.1,.1),this.addChild(this.glow);let e=new St([[0,0],[0,0],[0,0]]),t=new dt([0,0,1,1]),s=new St([[0,153/255],[0,153/255],[0,153/255]]),i=new dt([0,1,1,0]),n=K.find("tex_glow_inner").resource;this.glow.addComponent("particlesystem",{numParticles:2,lifetime:.35,rate:.06,autoPlay:!1,loop:!1,colorMap:n,startAngle:0,startAngle2:360,localSpace:!0,blendType:Bt,velocityGraph:e,scaleGraph:t,colorGraph:s,alphaGraph:i})}playCollisionEffect(){var e,t;(e=this.glow.particlesystem)==null||e.reset(),(t=this.glow.particlesystem)==null||t.play()}playSmokeEffect(){var e,t,s;(e=this.fxSmoke.particlesystem)==null||e.reset(),(t=this.fxSmoke.particlesystem)==null||t.play(),(s=this.scaleTween)==null||s.start()}}class cj extends Lr{constructor(e){super(e),this.firstEffect=!1,this.loaded?this.onLoaded():this.once(Gr.Event.Loaded,this.onLoaded,this)}checkLoaded(){super.checkLoaded()}async onLoaded(){this.iconSprite=this.findByName("icon"),this.spriteAsset=await K.loadSprite("tex_checkpoint_main_2"),this._initEffect()}async changeSprite(){this.iconSprite.sprite&&(this.iconSprite.sprite.sprite=this.spriteAsset)}_initEffect(){this.glow=new $("particle"),this.glow.setLocalPosition(0,.479,0),this.glow.setLocalScale(.1,.1,.1),this.addChild(this.glow);let e=new St([[0,0],[0,0],[0,0]]),t=new dt([0,0,1,1]),s=new St([[0,48/255],[0,250/255],[0,0]]),i=new dt([0,1,1,0]),n=K.find("tex_glow_inner").resource;this.glow.addComponent("particlesystem",{numParticles:2,lifetime:.3,rate:.05,autoPlay:!1,loop:!1,colorMap:n,startAngle:0,startAngle2:360,localSpace:!0,blendType:Bt,velocityGraph:e,scaleGraph:t,colorGraph:s,alphaGraph:i})}playEffect(){var e,t;this.firstEffect||((e=this.glow.particlesystem)==null||e.reset(),(t=this.glow.particlesystem)==null||t.play(),Se.play("sfx_check_point_4",2),this.changeSprite(),this.firstEffect=!0)}}const dj={bird:aj,autoJump:rj,tapJump:hj,coin:oj,checkPoint:cj};let uj=class extends ay{constructor(e){super(e,!1,dj)}setPause(e){this._setPauseChildren(this.rootNode,e)}_setPauseChildren(e,t){e.children.forEach(s=>{var i,n,a,o;t?((i=s.sprite)==null||i.pause(),(n=s.particlesystem)==null||n.pause()):((a=s.sprite)==null||a.resume(),(o=s.particlesystem)==null||o.unpause()),s.children.length>0&&this._setPauseChildren(s,t)})}update(){this.rootNode.children.forEach(e=>{let t=e.getPosition().x;t>O.MAP_MAX_X||t<O.MAP_MIN_X?e.enabled=!1:e.enabled=!0})}};class Uw extends Ie{constructor(e){super(),this._decorList=[],this._moveSpeed=0,this.data=e,this._moveSpeed=this.data.speedData.initialSpeed}update(e){if(this._map&&this._map.update(),!(!this.isStarted||this.isPaused)&&this._map){let t=this._moveSpeed*e,s=this._map.getLocalPosition(),i=new y(s.x-t,s.y,s.z);this._map.setLocalPosition(i)}}async load(){await this._loadMap(),this._loadDecors(),this.fire(Ie.Event.Loaded)}start(){this.isStarted||(this.isPaused=!1,this.isStarted=!0,this.coinCollected=0,this._setMoveDecors(!0),this.fire(Ie.Event.Start))}stop(){this.isStarted=!1,this._setMoveDecors(!1)}setPause(e){this.isStarted&&(this.isPaused=e,this._setMoveDecors(!e),this._map.setPause(e))}_setMoveDecors(e){this._decorList.forEach(t=>{t.isMoving=e})}async _loadMap(){let e=await K.loadResource(this.data.map,"json");this._map=new uj(e.resource),this._map.load(),this.addChild(this._map)}_loadDecors(){this.data.decorData.forEach(t=>{let s=new WC[t.decorType](t);this.addChild(s),this._decorList.push(s),s instanceof V0&&(this._groundDecor=s,this._groundDecor.setMoveSpeed(this.data.speedData.initialSpeed))})}destroy(){[...this.children].forEach(t=>{this.removeChild(t),t.destroy()}),this._decorList=[],super.destroy()}}const uc=class uc extends ${constructor(){super("levelManager"),this.currentLevel=null,this._loadData()}update(e){var t;(t=this.currentLevel)==null||t.update(e)}_loadData(){if(this.endLessLevelData=K.find("endLessLevelData.json").resources,!this.endLessLevelData){console.error("Endless level data not found");return}if(this.challengeLevelData=K.find("challengeLevelData.json").resources,!this.challengeLevelData){console.error("Challenge level data not found");return}if(this.tutorialLevelData=K.find("tutorialLevelData.json").resources,!this.tutorialLevelData){console.error("Tutorial level data not found");return}}async loadEndlessLevel(e=""){let t=-1;if(e==="")t=Math.floor(Math.random()*this.endLessLevelData.length);else if(t=this._findEndlessLevelIndexById(e),t===-1){console.error("Endless level not found");return}let s=new Nw(this.endLessLevelData[t]);this.currentLevel&&this.currentLevel.destroy();let i=new Nw(s);this._registerLevelEvents(i),this.currentLevel=i,Y.currentMode=Ie.Type.Endless,await i.load(),this.addChild(i)}async loadChallengeLevel(e=-1){this.currentLevel&&this.currentLevel.destroy();let t=e>0?e:Y.currentChallengeLevel,s=this._findChallengeLevelIndexById(t);s||(s=this.challengeLevelData[this.challengeLevelData.length-1]);let i=new Uw(s);this._registerLevelEvents(i),this.currentLevel=i,Y.currentMode=Ie.Type.Challenge,await i.load(),this.addChild(i)}async loadTutorialLevel(){this.currentLevel&&this.currentLevel.destroy();let e=new Uw(this.tutorialLevelData[0]);this._registerLevelEvents(e),this.currentLevel=e,Y.currentMode=Ie.Type.Tutorial,await e.load(),this.addChild(e),Y.currentMode=Ie.Type.Tutorial}reloadCurrentLevel(){}stopCurrentLevel(){var e;(e=this.currentLevel)==null||e.stop()}_registerLevelEvents(e){e.on(Ie.Event.Loaded,()=>{this.fire(uc.Event.LevelLoaded)},this),e.on(Ie.Event.UpdateScore,t=>{this.fire(uc.Event.LevelUpdateScore,t)},this)}_findEndlessLevelIndexById(e){return this.endLessLevelData.findIndex(t=>t.id===e)}_findChallengeLevelIndexById(e){return this.challengeLevelData.find(t=>t.level===e)}};uc.Event={LevelLoaded:"levelManager:levelLoaded",LevelUpdateScore:"levelManager:levelUpdateScore"};let ac=uc;class $C extends Rt{constructor(){super(...arguments),this.orientation=Pe,this.margin=0,this.includeExcludedChildren=!0}static get scriptName(){return"LayoutGroupFitter"}fit(){this.orientation===Pe?this.fitVertical():this.orientation===pe&&this.fitHorizontal()}fitVertical(){var i;const e=this.entity.layoutgroup;if(!e||!this.entity.element)return;let t=e.padding.y+e.padding.w;const s=this.entity.children;for(let n=0;n<s.length;++n){const a=s[n];!a._enabled||!a.element||!this.includeExcludedChildren&&((i=a.layoutchild)!=null&&i.excludeFromLayout)||(t+=a.element.height)}t+=Math.max(0,s.length)*e.spacing.y,this.entity.element.height=t+this.margin}fitHorizontal(){var i;const e=this.entity.layoutgroup;if(!e||!this.entity.element)return;let t=e.padding.x+e.padding.z;const s=this.entity.children;for(let n=0;n<s.length;++n){const a=s[n];!a._enabled||!a.element||!this.includeExcludedChildren&&((i=a.layoutchild)!=null&&i.excludeFromLayout)||(t+=a.element.width)}t+=Math.max(0,s.length)*e.spacing.x,this.entity.element.width=t+this.margin}}class z{static createCamera(e,t){const s=new $(e);return s.addComponent("camera",t),s}static createColorBackground(e=new k,t=1){const s=new $("spr_bg");return s.addComponent("element",{type:"image",anchor:new P(0,0,1,1),color:e,opacity:t}),s}static createModel(e,...t){const s=K.find(e);if(!s)throw new Error(`Asset ${e} not found`);const i=new $(s.name);return i.addComponent("model",{asset:s}),t.forEach((n,a)=>{var l;const o=(l=K.find(n))==null?void 0:l.resource;i.model&&(i.model.meshInstances[a].material=o)}),i}static createBox(e){var s;const t=new $;if(t.addComponent("model",{type:"box"}),e){const i=(s=K.find(e))==null?void 0:s.resource;t.model&&(t.model.meshInstances[0].material=i)}return t}static createSphere(e){var s;const t=new $;if(t.addComponent("model",{type:"sphere"}),e){const i=(s=K.find(e))==null?void 0:s.resource;t.model&&(t.model.meshInstances[0].material=i)}return t}static createCone(e){const t=new $;return t.addComponent("model",{type:"cone"}),e&&t.model&&(t.model.meshInstances[0].material=e),t}static createPlane(e){const t=new $;if(t.addComponent("model",{type:"plane"}),e){const s=K.find(e);t.model&&(t.model.meshInstances[0].material=s==null?void 0:s.resource)}return t}static createSprite(e){const t=K.find(e);if(!t)throw new Error(`Asset ${e} not found`);const s=new $(t.name);return s.addComponent("sprite",{spriteAsset:t}),s}static createImageElement(e,t={}){var c;t.type=pt;const s=t.scale||1;if(e)if(t.spriteAsset=K.find(e),t.spriteAsset){const d=ve.getSpriteFrame(t.spriteAsset.resource,s);t.width=t.width||d.width,t.height=t.height||d.height}else console.error(`Asset ${e} not found`);t.opacity=t.opacity||1,t.anchor=t.anchor||new P(.5,.5,.5,.5),t.pivot=t.pivot||new M(.5,.5),t.useInput=t.useInput||!1;const i=t.name||((c=t.spriteAsset)==null?void 0:c.name),n=new $(i);n.addComponent("element",t);const a=t.x||0,o=t.y||0,l=t.z||0;return n.setLocalPosition(a,o,l),n}static createEmptyImageElement(e={}){e.type=pt,e.width=e.width||100,e.height=e.height||100,e.opacity=e.opacity||1,e.anchor=e.anchor||new P(.5,.5,.5,.5),e.pivot=e.pivot||new M(.5,.5),e.useInput=e.useInput||!1,e.color=e.color||new k(1,1,1);const t=new $("element");t.addComponent("element",e);const s=e.x||0,i=e.y||0,n=e.z||0;return t.setLocalPosition(s,i,n),t}static createButtonElement(e,t={}){t.useInput===void 0&&(t.useInput=!0);const s=this.createImageElement(e,t),i=t.hoverTint||new k(.9,.9,.9),n=t.pressedTint||new k(.5,.5,.5),a=t.inactiveTint||new k(.5,.5,.5);return s.addComponent("button",{active:!0,hoverTint:i,pressedTint:n,imageEntity:s,inactiveTint:a}),s}static createGroupElement(e={}){e.type=Bs,e.anchor=e.anchor||new P(.5,.5,.5,.5),e.pivot=e.pivot||new M(.5,.5);const t=e.name||"groupElement",s=new $(t);s.addComponent("element",e);const i=e.x||0,n=e.y||0,a=e.z||0;return s.setLocalPosition(i,n,a),s}static createTextElement(e,t){var o;t.fontAsset=K.find(e),t.fontAsset||console.error(`Asset ${e} not found`),t.type=o0,t.text=t.text||"Text",t.fontSize=t.fontSize||32,t.anchor=t.anchor||new P(.5,.5,.5,.5),t.pivot=t.pivot||new M(.5,.5),t.alignment=t.alignment||new M(.5,.5),t.color=t.color||new k(0,0,0),t.opacity=t.opacity||1,t.margin=t.margin||new P(0,0,0,0),t.wrapLines=t.wrapLines===void 0?!0:t.wrapLines,t.autoWidth=t.autoWidth===void 0?!t.width:t.autoWidth,t.autoHeight=t.autoHeight===void 0?!t.height:t.autoHeight,t.lineHeight=t.lineHeight||32,t.autoFitWidth=t.autoFitWidth===void 0?!1:t.autoFitWidth,t.autoFitHeight=t.autoFitHeight===void 0?!1:t.autoFitHeight,t.maxWidth=t.maxWidth||0,t.maxLines=t.maxLines||Number.MAX_SAFE_INTEGER;const s=t.name||((o=t.fontAsset)==null?void 0:o.name),i=new $(s);i.addComponent("element",t);const n=t.x||0,a=t.y||0;return i.setLocalPosition(n,a,0),i}static createLayoutGroupElement(e={}){const t=this.createGroupElement(e);return e.orientation=e.orientation!==void 0?e.orientation:pe,e.spacing=e.spacing||new M(0,0),e.alignment=e.alignment||new M(.5,.5),e.widthFitting=e.widthFitting!==void 0?e.widthFitting:Nc,e.heightFitting=e.heightFitting!==void 0?e.heightFitting:Nc,e.wrap=e.wrap!==void 0?e.wrap:!1,e.padding=e.padding||new P(0,0,0,0),e.reverseX=e.reverseX!==void 0?e.reverseX:!1,e.reverseY=e.reverseY!==void 0?e.reverseY:!1,e.autoWidth=e.autoWidth!==void 0?e.autoWidth:!1,e.autoHeight=e.autoHeight!==void 0?e.autoHeight:!1,t.addComponent("layoutgroup",e),t}static createFittedLayoutGroupElement(e={}){const t=this.createLayoutGroupElement(e),s=t.addScript($C,{attributes:{orientation:e.orientation}});return t.fitter=s,t}}const ha=[{displayName:"English",name:"English",code:"en",flag:"spr_flag_england"},{displayName:"",name:"Arabic",code:"ar",font:"NotoSansArabic-Black",flag:"spr_flag_united_arab_emirates"},{displayName:"",name:"Chinese",code:"zh",font:"NotoSansSC-Black",flag:"spr_flag_china"},{displayName:"Deutsch",name:"German",code:"de",flag:"spr_flag_germany"},{displayName:"Dutch",name:"Nederlands",code:"nl",flag:"spr_flag_netherlands"},{displayName:"Espaol",name:"Spanish",code:"es",flag:"spr_flag_spain"},{displayName:"Franais",name:"French",code:"fr",flag:"spr_flag_france"},{displayName:"",name:"Hindi",code:"hi",flag:"spr_flag_india"},{displayName:"Bahasa Indonesia",name:"Indonesian",code:"id",flag:"spr_flag_indonesia"},{displayName:"Italiano",name:"Italian",code:"it",flag:"spr_flag_italy"},{displayName:"",name:"Japanese",code:"ja",font:"NotoSansJP-Black",flag:"spr_flag_japan"},{displayName:"",name:"Korean",code:"ko",font:"NotoSansKR-Black",flag:"spr_flag_south_korea"},{displayName:"Polski",name:"Polish",code:"pl",flag:"spr_flag_polish"},{displayName:"Portugus",name:"Portuguese",code:"pt",flag:"spr_flag_portugal"},{displayName:"Romn",name:"Romanian",code:"ro",flag:"spr_flag_romania"},{displayName:"",name:"Russian",code:"ru",flag:"spr_flag_russia"},{displayName:"Svenska",name:"Swedish",code:"sv",flag:"spr_flag_sweden"},{displayName:"Ting Vit",name:"Vietnamese",code:"vi",flag:"spr_flag_vietnam"},{displayName:"Trke",name:"Turkish",code:"tr",flag:"spr_flag_turkey"},{displayName:"",name:"Thai",code:"th",font:"NotoSerifThai-Black",flag:"spr_flag_thailand"}],Yf=class Yf{static init(e){this.app=e;let t=this.findCurrentLanguage();this.currentLanguageCode=ye.instance.getString(O.STORAGE_KEY_LANGUAGE,t),this.setLanguage({code:this.currentLanguageCode})}static async setLanguage(e){this.currentLanguageCode=e.code,await this.changeFontWithLanguage(),ye.instance.setItem(O.STORAGE_KEY_LANGUAGE,e.code)}static getLanguageByName(e){return ha.find(t=>t.name===e)}static getLanguageByCode(e){return ha.find(t=>t.code===e)}static getLanguageCodeByName(e){return this.getLanguageByName(e).code}static getFlagByCode(e){return this.getLanguageByCode(e).flag}static getAllLanguage(){let e=[];for(let t=0;t<ha.length;t++)e.push(ha[t]);return e}static getLanguageByIndex(e){return e<0||e>=ha.length?null:ha[e]}static getTextByKey(e){return Z.app.i18n.getText(e,this.currentLanguageCode)}static async changeFontWithLanguage(){K.find(O.GAME_FONT_NOTOSANS_BLACK)||await K.loadResource(O.GAME_FONT_NOTOSANS_BLACK,"font");let t=K.find(O.GAME_FONT_NOTOSANS_BLACK),s=this.getLanguageByCode(this.currentLanguageCode);if(!s.font){Z.app.i18n.locale=s.code;return}if(K.find(s.font)){Z.app.i18n.locale=s.code;return}K.hasResource(s.font,"font")&&await K.loadResource(s.font,"font").then(i=>{let n=s.code;t._i18n={...t._i18n,[n]:i._id},Z.app.i18n.locale=n})}static findCurrentLanguage(){let e=Z.app.i18n.locale;if(navigator.language&&(e=navigator.language),ha.find(i=>i.code===e))return e;let s=this.findFallbackLanguageByLocale(e);return s===null?this.defaultLanguageCode:s}static findFallbackLanguageByLocale(e){for(let t in this.DEFAULT_LOCALE_FALLBACKS)if(this.DEFAULT_LOCALE_FALLBACKS[t]===e)return t;return null}};Yf.defaultLanguageCode="en",Yf.DEFAULT_LOCALE_FALLBACKS={en:"en-US",es:"en-ES",zh:"zh-CN",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"};let Ds=Yf;const zw={hand:{scale:1,angle:0,moveSpeed:1,moveDistance:50,offsetX:0,offsetY:0},focus:{shape:"circle",radius:100,x:0,y:0,width:0,height:0},message:{text:"",distance:200,anchor:new M(.8,.5),angle:0,offsetX:0,offsetY:0},backgroundColor:"#000000",backgroundOpacity:.85,blockInput:!0};var Ju=(r=>(r.TutorialCompleted="FocusTutorial:TutorialCompleted",r.ClickOnFocusArea="FocusTutorial:ClickOnFocusArea",r))(Ju||{});const ba=class ba extends ie{static get instance(){return ba._instance||(ba._instance=new ba),ba._instance}constructor(){super(),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.tutorialData=zw,this.handTween=null,this.focusTween=null,this.ratio=1,this.sizeRatio=1,this.referenceResolution={x:1080,y:1920},this.actualResolution={x:window.innerWidth*window.devicePixelRatio,y:window.innerHeight*window.devicePixelRatio},this._calculateScaleFactor(),this.init()}init(){this.canvas=document.createElement("canvas"),this.canvas.width=Z.app.graphicsDevice.width,this.canvas.height=Z.app.graphicsDevice.height,this.canvas.style.position="absolute",this.canvas.style.top="0px",this.canvas.style.left="0px",this.canvas.style.zIndex="1",this.canvas.style.background="transparent",document.body.appendChild(this.canvas),this.canvas.addEventListener("contextmenu",s=>s.preventDefault()),this.context=this.canvas.getContext("2d");let e=K.find("spr_hand_focus").resource;this.hand={image:e.getSource(),x:0,y:0,angle:0,width:e.width,height:e.height,anchor:new M(.3,0),scale:1,offsetX:0,offsetY:0};let t=K.find("tex_white").resource;this.messageFrame={image:t.getSource(),x:0,y:0,angle:0,distance:150,width:604,height:256,scale:1,offsetX:0,offsetY:0},this.onResize(),this.on("FocusTutorial:TutorialCompleted",this.hide,this)}_copyData(e){let t={...zw},s={...t.hand},i={...t.focus},n={...t.message};return e.hand&&(s={...e.hand}),e.focus&&(i={...e.focus}),e.message&&(n={...e.message}),t.hand=s,t.focus=i,t.message=n,t}pointingTutorial(e){if(!e)return;Z.app.on("resize",this.onResize,this),Z.app.on("postrender",this.draw,this),this.canvas.style.display="block",this.tutorialData=this._copyData(e),this.hand.x=this.tutorialData.focus.x+this.tutorialData.hand.offsetX,this.hand.y=this.tutorialData.focus.y+this.tutorialData.hand.offsetY,this.hand.angle=this.tutorialData.hand.angle,this.hand.scale=this.tutorialData.hand.scale,this.handTween&&this.handTween.stop();let t={x:this.hand.x,y:this.hand.y};if(t.x-=this.tutorialData.hand.moveDistance*Math.cos(this.hand.angle*H.DEG_TO_RAD-Math.PI/2),t.y-=this.tutorialData.hand.moveDistance*Math.sin(this.hand.angle*H.DEG_TO_RAD-Math.PI/2),this.handTween=Q.createTween(this.hand,t,{duration:1/this.tutorialData.hand.moveSpeed,loop:!0,yoyo:!0,easing:Q.Easing.Sinusoidal.InOut}).start(),this.focusTween&&this.focusTween.stop(),this.tutorialData.focus.shape==="circle"){let s=Math.abs(this.tutorialData.focus.radius*this.scaleFactor),i=5e3;this.focusTween=Q.createTween({radius:i},{radius:s},{duration:.35,onUpdate:n=>{this.tutorialData.focus.radius=n.radius}}).start()}else{let s=Math.abs(this.tutorialData.focus.width),i=Math.abs(this.tutorialData.focus.height),n=5e3,a=5e3;this.focusTween=Q.createTween({width:n,height:a},{width:s,height:i},{duration:.6,onUpdate:o=>{this.tutorialData.focus.width=o.width,this.tutorialData.focus.height=o.height}}).start()}this.canvas.style.pointerEvents="auto",document.addEventListener("mousedown",this._handleInputEvent.bind(this)),document.addEventListener("touchstart",this._handleInputEvent.bind(this))}_handleInputEvent(e){if(this.canvas.style.display==="none")return!1;if(!this.tutorialData.blockInput)return this.fire("FocusTutorial:ClickOnFocusArea",e),!0;let t=0,s=0;e instanceof MouseEvent&&(t=e.clientX,s=e.clientY);let i=!1,n=1/window.devicePixelRatio;if(this.tutorialData.focus.shape==="circle")Math.sqrt((t-this.tutorialData.focus.x*n)**2+(s-this.tutorialData.focus.y*n)**2)<this.tutorialData.focus.radius*n&&(i=!0);else{let a=this.tutorialData.focus.width*n,o=this.tutorialData.focus.height*n,l=this.tutorialData.focus.x*n,c=this.tutorialData.focus.y*n;t>l-a*.5&&t<l+a*.5&&s>c-o*.5&&s<c+o*.5&&(i=!0)}if("sender"in e&&e.sender===this)return!1;if(i&&this.tutorialData.blockInput&&!this.focusTween.isPlaying()){this.fire("FocusTutorial:ClickOnFocusArea",e);let a=this.cloneEvent(e,this);return Z.app.graphicsDevice.canvas.dispatchEvent(a),!0}else return e instanceof TouchEvent||e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),!1}cloneMouseEvent(e){return new MouseEvent(e.type,e)}cloneTouchEvent(e){let t=[],s=[],i=[];for(let a=0;a<e.touches.length;a++){let o=e.touches.item(a),l=new Touch(o);t.push(l)}for(let a=0;a<e.targetTouches.length;a++){let o=e.targetTouches.item(a),l=new Touch(o);s.push(l)}for(let a=0;a<e.changedTouches.length;a++){let o=e.changedTouches.item(a),l=new Touch(o);i.push(l)}return new TouchEvent(e.type,{...e,touches:t,targetTouches:s,changedTouches:i})}cloneEvent(e,t){if(e instanceof MouseEvent){let s=this.cloneMouseEvent(e);return s.sender=t,s}else if(e instanceof TouchEvent){let s=this.cloneTouchEvent(e);return s.sender=t,s}else throw new Error("Unsupported event type")}drawHand(){let e=this.hand.width*this.hand.scale,t=this.hand.height*this.hand.scale,s=this.hand.x,i=this.hand.y;s*=this.ratio,i*=this.ratio,e*=this.ratio*this.scaleFactor,t*=this.ratio*this.scaleFactor,this.context.save(),this.context.translate(s,i),this.context.rotate(this.hand.angle*H.DEG_TO_RAD),this.context.translate(-e*this.hand.anchor.x,-t*this.hand.anchor.y),this.context.drawImage(this.hand.image,0,0,e,t),this.context.translate(-e*this.hand.anchor.x,-t*this.hand.anchor.y),this.context.rotate(-this.hand.angle*H.DEG_TO_RAD),this.context.translate(-s,-i),this.context.restore()}hide(){var e,t;this.canvas.style.display="none",(e=this.handTween)==null||e.stop(),(t=this.focusTween)==null||t.stop(),Z.app.off("resize",this.onResize,this),Z.app.off("postrender",this.draw,this),document.removeEventListener("mousedown",this._handleInputEvent),document.removeEventListener("touchstart",this._handleInputEvent),this.canvas.style.pointerEvents="none"}maskRect(e,t,s,i,n="#000000",a=.75){this.context.fillStyle=n,this.context.globalAlpha=a,this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.clearRect(e,t,s,i),this.context.globalAlpha=1}maskCircle(e,t,s,i="#000000",n=.75){this.context.fillStyle=i,this.context.globalAlpha=n,this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.globalCompositeOperation="destination-out",this.context.beginPath(),this.context.arc(e,t,s,0,2*Math.PI,!1),this.context.fill(),this.context.globalCompositeOperation="source-over",this.context.globalAlpha=1}drawMask(){let e=this.tutorialData.focus.x*this.ratio,t=this.tutorialData.focus.y*this.ratio,s=this.tutorialData.focus.width*this.ratio*this.scaleFactor,i=this.tutorialData.focus.height*this.ratio*this.scaleFactor,n=this.tutorialData.focus.radius*this.ratio;this.tutorialData.focus.shape==="circle"?this.maskCircle(e,t,n,this.tutorialData.backgroundColor,this.tutorialData.backgroundOpacity):(e-=s*.5,t-=i*.5,this.maskRect(e,t,s,i,this.tutorialData.backgroundColor,this.tutorialData.backgroundOpacity))}drawMessage(){if(!this.messageFrame.image||!this.tutorialData.message||this.tutorialData.message.text==="")return;let e=this.messageFrame.width*this.sizeRatio*this.messageFrame.scale*this.scaleFactor,t=this.messageFrame.height*this.sizeRatio*this.messageFrame.scale*this.scaleFactor,s=this.tutorialData.focus.x*this.ratio,i=this.tutorialData.focus.y*this.ratio;s+=this.tutorialData.message.distance*this.scaleFactor*Math.cos(this.tutorialData.message.angle*H.DEG_TO_RAD-Math.PI/2)+this.tutorialData.message.offsetX*this.scaleFactor,i+=this.tutorialData.message.distance*this.scaleFactor*Math.sin(this.tutorialData.message.angle*H.DEG_TO_RAD-Math.PI/2)+this.tutorialData.message.offsetY,s-=this.tutorialData.message.anchor.x*e,i-=this.tutorialData.message.anchor.y*t;let n=40*this.sizeRatio*this.scaleFactor;this.context.save(),this.context.translate(s,i);let a=Ds.getTextByKey(this.tutorialData.message.text);this._wrapText(a,e*.35,t*.7,e*.6,n),this.context.translate(-s,-i),this.context.restore()}_configText(e=24){this.context.textAlign="center",this.context.textBaseline="top",e*=this.sizeRatio*this.scaleFactor;let t=this._getCurrentFont();this.context.font=`bold ${e}px ${t}`,this.context.fillStyle="#b2b2b2",this.context.globalAlpha=1,this.context.globalCompositeOperation="source-over"}_wrapText(e,t,s,i,n){i/=this.sizeRatio,this._configText(40);let a=this._getLines(e,i),o=a.length*n;s-=o*.5;for(let l=0;l<a.length;l++)this.context.fillText(a[l],t,s+l*n,i)}_getLines(e,t,s=3,i=24){this._configText(40);let n=[];for(let a of e.split(`
`)){let o=a.split(" "),l=o[0];for(let c=1;c<o.length;c++){let d=o[c];this.context.measureText(`${l} ${d}`).width/this.sizeRatio<t?l+=` ${d}`:(n.push(l),l=d)}n.push(l)}return n.length>s?this._getLines(e,t,s,i-2):n}onResize(){this.canvas.width=window.innerWidth*window.devicePixelRatio,this.canvas.height=window.innerHeight*window.devicePixelRatio,this.ratio=1,this.sizeRatio=1,this.canvas.style.width=`${window.innerWidth}px`,this.canvas.style.height=`${window.innerHeight}px`,this.actualResolution={x:this.canvas.width,y:this.canvas.height},this._calculateScaleFactor()}_calculateScaleFactor(){let e=this.canvas.width<this.canvas.height?this.actualResolution.x/this.referenceResolution.x:this.actualResolution.y/this.referenceResolution.x,t=this.canvas.width<this.canvas.height?this.actualResolution.y/this.referenceResolution.y:this.actualResolution.x/this.referenceResolution.y;this.scaleFactor=Math.min(e,t)}_getCurrentFont(){let e="NotoSans-Black",t=Ds.getLanguageByCode(Ds.currentLanguageCode);return t.font&&(e=`${t.font}`),e}draw(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.tutorialData&&(this.drawMask(),this.drawHand(),this.drawMessage())}};ba._instance=null;let br=ba;var Uf=(r=>(r.ActionCompleted="TutorialAction:ActionCompleted",r))(Uf||{});class fj extends ie{constructor(e){super(),this.type=e}doAction(e){this._onActionCompleted()}_onActionCompleted(){this.fire("TutorialAction:ActionCompleted")}}class pj extends fj{constructor(e){super("FocusTutorialActor"),this.uiManager=e,this.data=null,this.entityWithInput=null}doAction(e){var f,p,_,m,g,v,x,S,w,T,b,C;this.data=e;let t=this.uiManager.getScreenByName(e.layerName,e.screen);if(!t||!t.enabled){console.warn(`Can't find screen ${e.screen}`);return}let s=t.findByName(e.element);if(!s){console.warn(`Can't find element ${e.element} in screen ${e.screen}`);return}let i=s.element;if(e.blockInput!==!1){let E=this._getInputElementEntity(s);if(E)this.entityWithInput=E,E.button?E.button.on("click",this._onActionCompleted,this):(E.element.on("mousedown",this._onActionCompleted,this),E.element.on("touchstart",this._onActionCompleted,this));else{console.warn(`Can't find element with input in element ${e.element} in screen ${e.screen}`),br.instance.once(Ju.ClickOnFocusArea,this._onActionCompleted,this);return}}else br.instance.once(Ju.ClickOnFocusArea,this._onActionCompleted,this);if(!i)return;let n=i.entity.getLocalScale(),a=i.width*n.x*.75,o=i.height*n.y*.75,l=this._elementToDeviceScreenPosition(i),c=((f=e.focus)==null?void 0:f.shape)||"circle",d=Math.sqrt(a*a+o*o)*(((p=e.focus)==null?void 0:p.radius)||.75),h=new M(.5,.5);(_=e.message)!=null&&_.anchor&&(h.x=e.message.anchor.x||h.x,h.y=e.message.anchor.y||h.y);let u={focus:{shape:c,x:l.x+(((m=e.focus)==null?void 0:m.x)||0),y:l.y+(((g=e.focus)==null?void 0:g.y)||0),width:a*(((v=e.focus)==null?void 0:v.width)||1.5),height:o*(((x=e.focus)==null?void 0:x.height)||1.5),radius:d},hand:{scale:.5,angle:((S=e.hand)==null?void 0:S.angle)||0,moveDistance:((w=e.hand)==null?void 0:w.moveDistance)||50,moveSpeed:((T=e.hand)==null?void 0:T.moveSpeed)||1,offsetX:((b=e.hand)==null?void 0:b.offsetX)||0,offsetY:((C=e.hand)==null?void 0:C.offsetY)||0},message:{text:e.message.text||"",angle:e.message.angle||0,anchor:h,distance:e.message.distance||150,offsetX:e.message.offsetX||0,offsetY:e.message.offsetY||0}};Z.app.once("resize",this._onResize,this),br.instance.pointingTutorial(u)}_getInputElementEntity(e){if(e.element){if(e.element.useInput||e.button)return e;if(e.children.length===0)return null}for(let t=0;t<e.children.length;t++){let s=e.children[t],i=this._getInputElementEntity(s);if(i)return i}return null}_onResize(){if(this.data){if(this.entityWithInput){let e=this.entityWithInput;e.button?e.button.off("click",this._onActionCompleted,this):(e.element.off("mousedown",this._onActionCompleted,this),e.element.off("touchstart",this._onActionCompleted,this))}br.instance.off(Ju.ClickOnFocusArea,this._onActionCompleted,this),setTimeout(()=>{this.doAction(this.data)},10)}}_onActionCompleted(){if(br.instance.hide(),this.entityWithInput){let e=this.entityWithInput;e.button?e.button.off("click",this._onActionCompleted,this):(e.element.off("mousedown",this._onActionCompleted,this),e.element.off("touchstart",this._onActionCompleted,this))}this.data=null,this.entityWithInput=null,Z.app.off("resize",this._onResize,this),this.fire("TutorialAction:ActionCompleted")}_elementToDeviceScreenPosition(e){let t=e.screenCorners,s=t[0].clone().add(t[2]).scale(.5);return s.y=Z.app.graphicsDevice.height-s.y,s}}class oh{constructor(e){this.type=e}checkCondition(e){return!1}}class mj extends oh{constructor(){super("localStorage")}checkCondition(e){let t=ye.instance.getItem(e.key);if(t===null)return!1;switch(e.operator){case is.EQUAL:return t===e.value;case is.GREATER_THAN:return t>e.value;case is.GREATER_THAN_OR_EQUAL:return t>=e.value;case is.LESS_THAN:return t<e.value;case is.LESS_THAN_OR_EQUAL:return t<=e.value;case is.NOT_EQUAL:return t!==e.value}return!1}}class _j extends oh{constructor(){super("tutorialCompleted")}checkCondition(e){return ds.instance.isTutorialCompleted(e.key)}}class gj extends oh{constructor(){super("localStorageArray")}checkCondition(e){let t=ye.instance.getItem(e.key);if(t===null)return!1;switch(e.operator){case is.EQUAL:return t.includes(e.value);case is.NOT_EQUAL:return!t.includes(e.value)}return!1}}class yj extends oh{constructor(){super("localStorageObject")}checkCondition(e){let t=ye.instance.getItem(e.key);if(t===null)return!1;let i=JSON.parse(t).find(a=>a.key===e.objectKey);if(i===null)return!1;let n=i[e.objectAttribute];switch(e.operator){case is.EQUAL:return n===e.value;case is.GREATER_THAN:return n>e.value;case is.GREATER_THAN_OR_EQUAL:return n>=e.value;case is.LESS_THAN:return n<e.value;case is.LESS_THAN_OR_EQUAL:return n<=e.value;case is.NOT_EQUAL:return n!==e.value}return!1}}class vj extends oh{constructor(){super("dailyChallenge")}checkCondition(e){let t=ye.instance.getItem(e.storageKey);if(t===null)return!1;let s=JSON.parse(t);for(let i=0;i<s.length;i++){let n=s[i];if(this.checkAttributes(n,e.objectAttributes,e.value))return!0}return!1}checkAttributes(e,t,s){for(let i=0;i<t.length;i++)if(e[t[i]]!==s)return!1;return!0}}class Sj extends oh{constructor(e){super("activeScreen"),this._uiManager=e}checkCondition(e){let t=this._uiManager.getScreenByName(e.layerName,e.screenName);return t?t.enabled===e.isEnable:(console.warn(`Screen ${e.screen} not found in layer ${e.layerName}`),!1)}}var XC=(r=>(r.TutorialCompleted="TutorialHandler:ActionCompleted",r))(XC||{});class qC extends ie{constructor(e="single",t=null){super(),this.type=e,this.actor=t}playTutorial(e,t){this.actor&&(this.actor.once(Uf.ActionCompleted,this.fire.bind(this,"TutorialHandler:ActionCompleted")),this.tutorialName=e,this.actor.doAction(t))}}class xj extends qC{constructor(e=null,{delayBetweenActions:t=.5}={}){super("sequence",e),this.index=0,this.data=[],this.delayBetweenActions=t}playTutorial(e,t){for(this.index=0;this.isActionSaveInProgress(this.index);)if(this.index++,this.index>=this.data.length){this.fire("TutorialHandler:ActionCompleted");return}this.data=t,this.tutorialName=e,this._onActionCompleted()}_onActionCompleted(){if(this.index>=this.data.length){this.fire("TutorialHandler:ActionCompleted");return}if(this.isActionSaveInProgress(this.data.length-1)){this.fire("TutorialHandler:ActionCompleted");return}for(;this.isActionSaveInProgress(this.index);)if(this.index++,this.index>=this.data.length){this.fire("TutorialHandler:ActionCompleted");return}setTimeout(()=>{this.actor.once(Uf.ActionCompleted,this._onActionCompleted,this),this.actor.once(Uf.ActionCompleted,this._saveProgress.bind(this,this.index)),this.actor.doAction(this.data[this.index]),this.index++},this.delayBetweenActions*1e3)}_saveProgress(e){if(e>=this.data.length){this.fire("TutorialHandler:ActionCompleted");return}this.data[e].saveProgress&&this._saveActionProgress(e)}_saveActionProgress(e){let t=ye.instance.getItem(this.tutorialName);t?t=JSON.parse(t):t={},this.data[e].name?t[this.data[e].name]=!0:t[e]=!0,ye.instance.setItem(this.tutorialName,JSON.stringify(t))}isActionSaveInProgress(e){let t=ye.instance.getItem(this.tutorialName);if(t){t=JSON.parse(t);let s=this.data[e];return s.name?t[s.name]&&s.saveProgress:t[e]&&s.saveProgress}else return!1}}var is=(r=>(r.EQUAL="=",r.GREATER_THAN=">",r.GREATER_THAN_OR_EQUAL=">=",r.LESS_THAN="<",r.LESS_THAN_OR_EQUAL="<=",r.NOT_EQUAL="!=",r))(is||{});const fc=class fc extends ie{static get instance(){return fc._instance}constructor(e){super(),fc._instance=this,this.uiManager=e,this.tutorials=K.find("tutorial_data.json").resources,this.comparator={localStorage:new mj,tutorialCompleted:new _j,localStorageArray:new gj,localStorageObject:new yj,dailyChallenge:new vj,activeScreen:new Sj(this.uiManager)},this.actors={trackScreenElement:new pj(e)},this.handlers={single:new qC("single",this.actors.trackScreenElement),sequence:new xj(this.actors.trackScreenElement,{delayBetweenActions:.1})}}checkTutorial(){let e=!1;this.tutorials.forEach(t=>{if(!e&&this._checkUnlockCondition(t)&&!this.isTutorialCompleted(t.name)){this._playTutorial(t),e=!0;return}})}_checkUnlockCondition(e){return e.unlockConditions.every(t=>this._checkCondition(t))}_checkCondition(e){let t=this.comparator[e.type];return t?t.checkCondition(e):(console.warn(`Comparator ${e.type} not found!`),!1)}playTutorial(e){let t=this.tutorials.find(s=>s.name===e);if(!t){console.warn(`Tutorial ${e} not found!`);return}this._playTutorial(t)}_playTutorial(e){let t=this.handlers[e.type];if(!t){console.warn(`Tutorial handler ${e.type} not found!`);return}this.showingTutorial=e,t.once(XC.TutorialCompleted,this._completeTutorial.bind(this,e)),t.playTutorial(e.name,e.actions)}completeTutorial(){this.tutorials.forEach(e=>{this._checkUnlockCondition(e)&&this._completeTutorial(e)})}_completeTutorial(e){let t=[],s=ye.instance.getItem(O.STORAGE_COMPLETED_TUTORIALS);if(s)try{t=JSON.parse(s)}catch(i){console.error("Error parsing completed tutorials from storage:",i)}Gt.log("game_tutorial_completed",{name:e.name}),t.push(e.name),ye.instance.setItem(O.STORAGE_COMPLETED_TUTORIALS,JSON.stringify(t)),this.showingTutorial=null,Ko().then(()=>{this.fire("TutorialManager:TutorialCompleted",e.name)})}isTutorialCompleted(e){let t=ye.instance.getItem(O.STORAGE_COMPLETED_TUTORIALS);return t?(t=JSON.parse(t),t.includes(e)):!1}completeCurrentTutorial(){this.showingTutorial&&(br.instance.hide(),this._completeTutorial(this.showingTutorial))}getActiveTutorial(){return this.showingTutorial}};fc._instance=null;let ds=fc;const Ta=class Ta extends Lt{constructor(){super(O.HOME_SCREEN_NAME),this.lineList=[]}create(){super.create(),this._createLinesIcon(),this._createChallengeButton(),this._createShopButton(),this._createSettingButton(),this._createDailyChallengeButton(),this._createEndlessModeText(),this.resize()}resize(){super.resize(),this._onResizeEndlessModeText()}update(){this._checkEnableNotification()}_createLinesIcon(){let e=z.createImageElement("spr_icon_line",{anchor:new P(0,1,0,1),pivot:new M(0,1),x:125,y:-285,height:225});this.addChild(e);let t=z.createImageElement("spr_icon_line",{anchor:new P(0,1,0,1),pivot:new M(0,1),x:250,y:-285,height:225});this.addChild(t),this.lineList.push(e,t)}_createChallengeButton(){this.challengeButton=z.createButtonElement("spr_button_shop",{anchor:new P(0,1,0,1),pivot:new M(0,1),x:50,y:-350}),this.addChild(this.challengeButton),this.challengeButton.name="buttonChallenge",this.textChallenge=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"Levels",size:30,autoWidth:!1,autoFitWidth:!0,minFontSize:25,maxFontSize:35,width:260,wrapLines:!1,anchor:new P(.5,.5,.5,.5),pivot:new M(.5,.5),color:k.WHITE}),this.challengeButton.addChild(this.textChallenge),this.textChallenge.element.key="levels",this.challengeButton.button.on("click",e=>{e.touch&&e.event.preventDefault(),!(ds.instance.showingTutorial&&ds.instance.showingTutorial.name!==O.TUTORIAL_CHOOSE_LEVEL_NAME)&&(Se.play("sfx_button"),this.fire(Ta.EVENT.ChallengeButtonClicked))})}_createShopButton(){this.shopButton=z.createButtonElement("spr_button_shop",{anchor:new P(0,1,0,1),pivot:new M(0,1),x:50,y:-495}),this.addChild(this.shopButton),this.shopButton.name="buttonShop",this.textShop=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"Shop",size:30,autoWidth:!1,autoFitWidth:!0,minFontSize:25,maxFontSize:35,width:260,anchor:new P(.5,.5,.5,.5),pivot:new M(.5,.5),color:k.WHITE}),this.shopButton.addChild(this.textShop),this.textShop.element.key="shop",this.shopButton.button.on("click",s=>{s.touch&&s.event.preventDefault(),!(ds.instance.showingTutorial&&ds.instance.showingTutorial.name!==O.TUTORIAL_SHOP_NAME)&&(Se.play("sfx_button"),this.fire(Ta.EVENT.ShopButtonClicked))}),this.hintEnoughCoin=z.createImageElement("spr_icon_notification",{anchor:new P(1,1,1,1),pivot:new M(.5,.5),scale:.6}),this.shopButton.addChild(this.hintEnoughCoin),this.hintEnoughCoin.enabled=!1;let e=Q.createRotateTween(this.hintEnoughCoin,{z:10},{duration:.06,repeat:5,yoyo:!0,easing:Q.Easing.Quadratic.InOut}),t=Q.createCountTween({duration:.5});e.chain(t),t.chain(e),e.start()}_createSettingButton(){this.settingButton=z.createButtonElement("spr_icon_setting",{anchor:new P(1,1,1,1),pivot:new M(1,1),x:-50,y:-50}),this.addChild(this.settingButton),this.settingButton.button.on("click",e=>{e.touch&&e.event.preventDefault(),!ds.instance.showingTutorial&&(Se.play("sfx_button"),this.fire(Ta.EVENT.SettingButtonClicked))})}_createDailyChallengeButton(){this.dailyChallengeButton=z.createButtonElement("spr_button_daily_challenge",{anchor:new P(0,1,0,1),pivot:new M(0,1),x:50,y:-175}),this.addChild(this.dailyChallengeButton),this.dailyChallengeButton.name="buttonDailyChallenge",this.textDailyChallenge=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:`DAILY
CHALLENGE`,size:25,autoWidth:!1,autoFitWidth:!0,minFontSize:20,maxFontSize:25,width:160,lineHeight:40,color:k.WHITE,anchor:new P(0,.5,0,.5),pivot:new M(-.7,.5),alignment:new M(0,.5)}),this.dailyChallengeButton.addChild(this.textDailyChallenge),this.textDailyChallenge.element.key="daily-challenge",this.dailyChallengeButton.button.on("click",s=>{s.touch&&s.event.preventDefault(),!(ds.instance.showingTutorial&&ds.instance.showingTutorial.name!==O.TUTORIAL_DAILY_CHALLENGE_NAME)&&(Se.play("sfx_button"),this.fire(Ta.EVENT.DailyChallengeButtonClicked))}),this.notificationEntity=z.createImageElement("spr_icon_notification",{anchor:new P(1,1,1,1),pivot:new M(.5,.5),scale:.6}),this.dailyChallengeButton.addChild(this.notificationEntity);let e=Q.createRotateTween(this.notificationEntity,{z:10},{duration:.06,repeat:5,yoyo:!0,easing:Q.Easing.Quadratic.InOut}),t=Q.createCountTween({duration:.5});e.chain(t),t.chain(e),e.start()}_createEndlessModeText(){this.endlessModeText=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"Endless Mode",size:50,autoWidth:!1,autoFitWidth:!0,minFontSize:45,maxFontSize:50,width:750,wrapLines:!1,anchor:new P(.5,.2,.5,.2)}),this.endlessModeText.element.key="endless-mode",this.addChild(this.endlessModeText)}_onResizeEndlessModeText(){let e=225,t=Z.width/Z.height,s=new P(.5,.16,.5,.16);t>.65&&(s=new P(.5,.1,.5,.1)),Z.isLandscape&&(e=240,s=new P(.5,.1,.5,.1),t<=1.57&&(e=150),t>=2&&(e=150)),this.endlessModeText.element.anchor=s,this.endlessModeText.setLocalPosition(0,e,0)}_checkEnableNotification(){let e=Y.getDailyChallengeData(),t=!1;e.forEach(s=>{s.completed&&!s.claimed&&(t=!0)}),this.notificationEntity.enabled=t}setActiveHintEnoughCoin(e){this.hintEnoughCoin.enabled=e}setEnableLeftButtons(e=!0){this.challengeButton.enabled=e,this.shopButton.enabled=e,this.dailyChallengeButton.enabled=e,this.endlessModeText.enabled=e,this.lineList.forEach(t=>{t.enabled=e})}};Ta.EVENT={ChallengeButtonClicked:"HomeScreen:Challenge",ShopButtonClicked:"HomeScreen:Shop",SettingButtonClicked:"HomeScreen:Setting",DailyChallengeButtonClicked:"HomeScreen:DailyChallenge"};let bn=Ta;const pc=class pc extends Lt{constructor(){super(O.LOSE_SCREEN_NAME),this.totalCoin=0,this.coefficient=1,this.rewardCoin=0,this._coinClaimSFXId=-1}create(){super.create(),this._createBackground(),this._createTitle(),this._createButtons(),this._createCollectedCoinElement(),this._checkIsRewardAdsAvailable(),this._initHorizontalSpin(),this.resize()}resize(){super.resize()}onActivated(){var e;super.onActivated(),(e=this.arrowTween)==null||e.start()}_createBackground(){this.fakeBackground=z.createEmptyImageElement({color:k.BLACK,useInput:!0,opacity:1}),this.fakeBackground.element.opacity=.5,this.fakeBackground.element.anchor=new P(0,0,1,1),this.addChild(this.fakeBackground)}_createButtons(){this.buttonGroup=z.createGroupElement({anchor:new P(.5,.4,.5,.4),y:-300}),this.addChild(this.buttonGroup),this._createAdsButton(),this._createNoThanksButton()}_createAdsButton(){this.adsButton=z.createButtonElement("spr_btn_white",{width:250,height:100,anchor:new P(.5,.5,.5,.5),y:145}),this.buttonGroup.addChild(this.adsButton),this.adsButton.button.on("click",this._onAdsButtonClicked,this),this.adsText=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"CLAIM X2",size:35,color:k.BLACK,anchor:new P(.5,.5,.5,.5),autoWidth:!1,autoFitWidth:!0,minFontSize:30,maxFontSize:40,width:200,wrapLines:!1}),this.adsButton.addChild(this.adsText),this.adsIcon=z.createImageElement("spr_icon_ads",{x:-90,y:0}),this.adsButton.addChild(this.adsIcon);let e=z.createImageElement("spr_icon_coin",{x:90});this.adsButton.addChild(e)}_createNoThanksButton(){this.noThanksButton=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"NO THANKS",color:k.WHITE,size:30,anchor:new P(.5,.5,.5,.5),autoWidth:!1,autoFitWidth:!0,minFontSize:25,maxFontSize:35,width:400,wrapLines:!1,useInput:!0}),this.noThanksButton.addComponent("button",{hoverTint:new k(.8,.8,.8)}),this.noThanksButton.element.key="no-thanks",this.buttonGroup.addChild(this.noThanksButton),this.noThanksButton.element.on("click",this._onBackHome.bind(this))}_createTitle(){let e=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"GAME OVER",size:90,color:k.WHITE,anchor:new P(.5,.6,.5,.6),autoWidth:!1,autoFitWidth:!0,minFontSize:75,maxFontSize:105,width:750,y:250,wrapLines:!1});e.element.key="game-over",this.addChild(e)}_createCollectedCoinElement(){this.collectText=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"COLLECTED",size:50,color:k.WHITE,anchor:new P(.5,.6,.5,.6),autoWidth:!1,autoFitWidth:!0,minFontSize:40,maxFontSize:60,width:500,y:100}),this.addChild(this.collectText),this.collectText.element.key="collected",this.rewardGroup=z.createLayoutGroupElement({anchor:new P(.5,.6,.5,.6),pivot:new M(.5,.5),type:pe,alignment:new M(.5,.5),spacing:new M(10,0)}),this.addChild(this.rewardGroup);let e=z.createImageElement("spr_icon_coin",{anchor:new P(.5,.5,.5,.5),pivot:new M(.5,.5),scale:1.2});this.rewardGroup.addChild(e),this.textCollectedCoin=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"100",fontSize:50,color:k.WHITE,anchor:new P(.5,.2,.5,.2),autoWidth:!0}),this.rewardGroup.addChild(this.textCollectedCoin)}_initHorizontalSpin(){this.horizontalSpin=z.createImageElement("spr_spin_horizontal",{anchor:new P(.5,.5,.5,.5),scale:1.5,y:-50}),this.addChild(this.horizontalSpin);let e=792;this.arrow=z.createImageElement("spr_icon_arrow",{x:-e/2,y:-60,scale:1.2});let t=e/7;this.horizontalSpin.addChild(this.arrow),this.arrowTween=Q.createTween(this.arrow.getLocalPosition(),{x:396},{duration:1,loop:!0,yoyo:!0,onUpdate:()=>{this.arrow.setLocalPosition(this.arrow.getLocalPosition().x,-60,0);let s=this.arrow.getLocalPosition().x,i=Math.floor((s+e/2)/t+1);i<=4?this.coefficient=i+1:i===5?this.coefficient=4:i===6?this.coefficient=3:this.coefficient=2,this.rewardCoin=this.totalCoin*this.coefficient,this._updateCoinRewardText()}}).start()}_updateCoinRewardText(){this.adsText&&(this.adsText.element.text=this.rewardCoin.toString())}_onBackHome(){Y.currency+=this.totalCoin,Se.play("sfx_button"),this.fire(pc.EVENT.BACK_TO_HOME)}_onAdsButtonClicked(){var e;Gt.log("reward_show",{name:"increase_coin"}),this._disableButtons(),this.adsButton.element.useInput=!1,Se.play("sfx_button"),(e=this.arrowTween)==null||e.stop(),Q.createCountTween({duration:.1,onComplete:()=>{Z.pause(),Wt.showRewardAds(()=>{console.log("Reward Ads Success"),this._onPlayCoinReceiveAnimation(),Z.resume()})}}).start()}setCollectedCoin(e){this.totalCoin=e,this.textCollectedCoin.element.text=e.toString()}_checkIsRewardAdsAvailable(){this.checkRewardAdsIntervalID&&clearInterval(this.checkRewardAdsIntervalID),this._activeButtonAds(!1),this.checkRewardAdsIntervalID=setInterval(()=>{Wt.checkIsRewardAdsReady(e=>{e?(this._activeButtonAds(!0),clearInterval(this.checkRewardAdsIntervalID)):this._activeButtonAds(!1)})},1e3)}_activeButtonAds(e){this.adsButton.element.useInput=e;let t=e?1:.5;this.adsButton.element.opacity=t,this.adsText.element.opacity=t,this.adsIcon.element.opacity=t}_enableButtons(){this.adsButton.element.useInput=!0,this.noThanksButton.element.useInput=!0}_disableButtons(){this.adsButton.element.useInput=!1,this.noThanksButton.element.useInput=!1}_onPlayCoinReceiveAnimation(){this._coinClaimSFXId=Se.play("sfx_coin_claimed",1,!0),Q.createTween({value:parseInt(this.textCollectedCoin.element.text)},{value:this.rewardCoin},{duration:1,onUpdate:t=>{const s=t.value;this.textCollectedCoin.element.text=Math.floor(s).toString()},onComplete:()=>{this._coinClaimSFXId!==-1&&Se.stop("sfx_coin_claimed",this._coinClaimSFXId),Q.createCountTween({duration:.5,onComplete:()=>{Y.currency+=this.rewardCoin,this.fire(pc.EVENT.BACK_TO_HOME),this._enableButtons(),this._checkIsRewardAdsAvailable()}}).start()}}).start()}};pc.EVENT={BACK_TO_HOME:"backToHome",RESTART:"restart"};let ya=pc;const fl=class fl extends Lt{constructor(){super(O.WIN_SCREEN_NAME),this.coefficient=1,this.totalCoin=0,this.rewardCoin=0,this._coinClaimSFXId=-1}create(){super.create(),this._createBackground(),this._createTitle(),this._createCollectedCoinElement(),this._initHorizontalSpin(),this._createButtons(),this._checkIsRewardAdsAvailable(),this.resize()}resize(){super.resize(),this._onResizeTitle(),this._onResizeCollectedCoinElement()}onActivated(){var e;super.onActivated(),(e=this.arrowTween)==null||e.start(),this._enableButtons()}_createBackground(){this.fakeBackground=z.createEmptyImageElement({color:k.BLACK,useInput:!0}),this.fakeBackground.element.opacity=.6,this.fakeBackground.element.anchor=new P(0,0,1,1),this.addChild(this.fakeBackground)}_createTitle(){this.titleEntity=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"COMPLETE !!",size:90,color:k.WHITE,anchor:new P(.5,.5,.5,.5),autoWidth:!1,autoFitWidth:!0,minFontSize:75,maxFontSize:105,width:750,y:450}),this.addChild(this.titleEntity),this.titleEntity.element.key="complete"}_onResizeTitle(){let e=350;Z.isLandscape&&(e=310),this.titleEntity.setLocalPosition(0,e,0)}_createCollectedCoinElement(){this.coinGroupEntity=z.createGroupElement({anchor:new P(.5,.5,.5,.5)}),this.addChild(this.coinGroupEntity);let e=z.createImageElement("spr_icon_coin",{scale:1.5,x:-80,y:-4});this.coinGroupEntity.addChild(e),this.textCollectedCoin=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"0",size:65,color:k.WHITE,anchor:new P(.5,.5,.5,.5),autoWidth:!1,autoFitWidth:!0,minFontSize:55,maxFontSize:75,width:500,pivot:new M(0,.5),alignment:new M(0,.5),x:-20}),this.coinGroupEntity.addChild(this.textCollectedCoin)}_onResizeCollectedCoinElement(){let e=200;Z.isLandscape&&(e=170),this.coinGroupEntity.setLocalPosition(0,e,0)}_initHorizontalSpin(){this.horizontalSpin=z.createImageElement("spr_spin_horizontal",{anchor:new P(.5,.5,.5,.5),scale:1.5}),this.addChild(this.horizontalSpin);let e=792;this.arrow=z.createImageElement("spr_icon_arrow",{x:-e/2,y:-60,scale:1.2});let t=e/7;this.horizontalSpin.addChild(this.arrow),this.arrowTween=Q.createTween(this.arrow.getLocalPosition(),{x:e/2},{duration:1,loop:!0,yoyo:!0,onUpdate:()=>{this.arrow.setLocalPosition(this.arrow.getLocalPosition().x,-60,0);let s=this.arrow.getLocalPosition().x,i=Math.floor((s+e/2)/t+1);i<=4?this.coefficient=i+1:i===5?this.coefficient=4:i===6?this.coefficient=3:this.coefficient=2,this.rewardCoin=this.totalCoin*this.coefficient,this._updateCoinRewardText()}}).start()}_updateCoinRewardText(){this.adsText&&(this.adsText.element.text=this.rewardCoin.toString())}_createButtons(){this.buttonGroup=z.createGroupElement({anchor:new P(.5,.5,.5,.5),y:-200}),this.addChild(this.buttonGroup),this._createHomeButton(),this._createAdsButton(),this._createNextButton()}_createHomeButton(){this.homeButton=z.createButtonElement("spr_icon_home",{scale:.45,anchor:new P(0,1,0,1),y:-70,x:90}),this.addChild(this.homeButton),this.homeButton.button.on("click",e=>{e.touch&&e.event.preventDefault(),Se.play("sfx_button"),Y.currency+=this.totalCoin,this.fire(fl.EVENT.BACK_TO_HOME)})}_createNextButton(){this.nextButton=z.createButtonElement("spr_btn_white",{width:250,height:100,y:-150}),this.nextButton.button.on("click",this._onNextButtonClicked,this),this.buttonGroup.addChild(this.nextButton);let e=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"Next",size:30,color:k.BLACK,anchor:new P(.5,.5,.5,.5),autoWidth:!1,autoFitWidth:!0,minFontSize:25,maxFontSize:35,width:200});this.nextButton.addChild(e),e.element.key="next"}_createAdsButton(){this.adsButton=z.createButtonElement("spr_btn_white",{width:300,height:100,x:0}),this.buttonGroup.addChild(this.adsButton),this.adsButton.button.on("click",this._onAdsButtonClicked,this),this.adsText=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"1000",size:45,color:k.BLACK,anchor:new P(.6,.5,.6,.5),autoWidth:!1,autoFitWidth:!0,minFontSize:40,maxFontSize:50,width:180}),this.adsButton.addChild(this.adsText),this.adsIcon=z.createImageElement("spr_icon_ads",{x:-90,y:0,scale:1.3}),this.adsButton.addChild(this.adsIcon)}_onNextButtonClicked(){Se.play("sfx_button"),Y.currency+=this.totalCoin,this.fire(fl.EVENT.NEXT)}_onAdsButtonClicked(){var e;Se.play("sfx_button"),(e=this.arrowTween)==null||e.stop(),this._disableButtons(),Q.createCountTween({duration:.1,onComplete:()=>{Z.pause(),Wt.showRewardAds(()=>{console.log("Reward Ads Success"),this._onPlayCoinReceiveAnimation(),Z.resume()})}}).start()}_onPlayCoinReceiveAnimation(){this._coinClaimSFXId=Se.play("sfx_coin_claimed",1,!0),Q.createTween({value:parseInt(this.textCollectedCoin.element.text)},{value:this.rewardCoin},{duration:1,onUpdate:t=>{const s=t.value;this.textCollectedCoin.element.text=Math.floor(s).toString()},onComplete:()=>{this._coinClaimSFXId!==-1&&Se.stop("sfx_coin_claimed",this._coinClaimSFXId),Q.createCountTween({duration:.5,onComplete:()=>{Y.currency+=this.rewardCoin,this.fire(fl.EVENT.NEXT),this._enableButtons(),this._checkIsRewardAdsAvailable()}}).start()}}).start()}setCollectedCoin(e){this.totalCoin=e,this.textCollectedCoin.element.text=e.toString()}_checkIsRewardAdsAvailable(){this.checkRewardAdsIntervalID&&clearInterval(this.checkRewardAdsIntervalID),this._activeButtonAds(!1),this.checkRewardAdsIntervalID=setInterval(()=>{Wt.checkIsRewardAdsReady(e=>{e?(this._activeButtonAds(!0),clearInterval(this.checkRewardAdsIntervalID)):this._activeButtonAds(!1)})},1e3)}_activeButtonAds(e){this.adsButton.element.useInput=e;let t=e?1:.5;this.adsButton.element.opacity=t,this.adsText.element.opacity=t,this.adsIcon.element.opacity=t}_enableButtons(){this.adsButton.element.useInput=!0,this.nextButton.element.useInput=!0,this.homeButton.element.useInput=!0}_disableButtons(){this.adsButton.element.useInput=!1,this.nextButton.element.useInput=!1,this.homeButton.element.useInput=!1}};fl.EVENT={BACK_TO_HOME:"backToHome",NEXT:"next"};let va=fl;class oc extends ${constructor(){super("mainCamera"),this._minAspectRatio=1.15,this._stepAspectRatio=.1,this._minDivisor=4,this._stepDivisor=.2,this.addComponent("camera",{clearColor:new k(1,1,1),farClip:1e3,nearClip:.1,orthoHeight:1,projection:Ua}),this.translate(0,0,1),this.resize()}static get instance(){return this._instance||(this._instance=new oc),this._instance}resize(){let e=Z.width,s=Z.height/e;if(s>1){let i=this._getDivisorByAspectRatio(s);this.camera.orthoHeight=s/1.5,this.setLocalPosition(-s/i,0,1)}else this.camera.orthoHeight=s,this.setLocalPosition(0,0,1)}_getDivisorByAspectRatio(e){return e<this._minAspectRatio?this._minDivisor:(e-this._minAspectRatio)/this._stepAspectRatio*this._stepDivisor+this._minDivisor}}const mc=class mc extends ${constructor(e){super(),this._isSelected=!1,this._isLocked=!0,this._skinData=e,this.addComponent("element",{type:Bs,anchor:new P(.5,.5,.5,.5),useInput:!0,width:300,height:300}),this.addComponent("button",{active:!0}),this._frameUnselected=z.createImageElement("spr_bg_item_shop",{width:300,height:300}),this.addChild(this._frameUnselected),this._frameSelected=z.createImageElement("spr_frame_selected",{width:300,height:300}),this.addChild(this._frameSelected),this._frameSelected.enabled=!1,this._frameLockUnselected=z.createImageElement("spr_frame_lock",{width:300,height:300}),this.addChild(this._frameLockUnselected),this._frameLockSelected=z.createImageElement("spr_frame_lock_selected",{width:300,height:300}),this.addChild(this._frameLockSelected),this._frameLockSelected.enabled=!1,this._imageSkin=z.createImageElement(this._skinData.iconSprite,{scale:1.5}),this.addChild(this._imageSkin),this.setLocalScale(.8,.8,.8),this._iconLock=z.createImageElement("spr_icon_lock",{x:-100,y:100}),this.addChild(this._iconLock),this.button.on("click",this.onClick,this),this.setLocked(this._skinData.locked),this.setSelected(!1),this._hintEnoughCoin=z.createImageElement("spr_icon_notification",{anchor:new P(0,1,0,1),pivot:new M(.5,.5),scale:.75}),this._frameLockUnselected.addChild(this._hintEnoughCoin);let t=Q.createRotateTween(this._hintEnoughCoin,{z:10},{duration:.06,repeat:5,yoyo:!0,easing:Q.Easing.Quadratic.InOut}),s=Q.createCountTween({duration:.5});t.chain(s),s.chain(t),t.start()}setLocked(e){this._isLocked=e,this._iconLock.enabled=e,this._frameLockUnselected.enabled=e}setSelected(e){this._isSelected=e,this._frameSelected.enabled=e}setLockSelected(e){this._frameLockSelected.enabled=e}checkEnoughCoin(){return Y.currency>=this._skinData.price&&!Y.IsSkinUnlocked(this._skinData.name)?(this._hintEnoughCoin.enabled=!0,!0):(this._hintEnoughCoin.enabled=!1,!1)}onClick(){if(Se.play("sfx_button"),!this._isLocked){this.fire(mc.EVENT.SELECTED,this._skinData);return}this.setLockSelected(!0),this.fire(mc.EVENT.UNLOCK,this._skinData)}get nameSkin(){return this._skinData.name}get price(){return this._skinData.price}};mc.EVENT={UNLOCK:"unlock",SELECTED:"selected"};let zf=mc;const wj=[{name:"dino",iconSprite:"iconDino",price:0,locked:!1},{name:"minecraft",iconSprite:"minecraft",price:500,locked:!0},{name:"onion",iconSprite:"onion",price:1e3,locked:!0},{name:"cheese",iconSprite:"cheese",price:1500,locked:!0},{name:"dino_purple",iconSprite:"dino_2",price:2e3,locked:!0},{name:"radish",iconSprite:"iconRadish",price:2500,locked:!0},{name:"phin",iconSprite:"iconPhin",price:3e3,locked:!0},{name:"pig",iconSprite:"pig",price:3500,locked:!0},{name:"rabbit_pink",iconSprite:"pink",price:4e3,locked:!0},{name:"owlet",iconSprite:"owlet",price:4500,locked:!0},{name:"dude",iconSprite:"dude",price:5e3,locked:!0},{name:"naruto",iconSprite:"naruto",price:5500,locked:!0}];class KC{static init(e){this.app=e}static getData(){return wj}}const pl=class pl extends Lt{constructor(){super(O.SHOP_SCREEN_NAME),this.items=[],this._itemColumn=3}create(){super.create(),this._createBackground(),this._createBackButton(),this._createBuyByCoinBtn(),this._createBuyByAdsBtn(),this._createTextTitle(),this._createScrollView(),this._createItemList(),this._initFakePointTutorial(),this._checkIsRewardAdsAvailable(),this.resize()}resize(){super.resize(),this._onResizeLevelList()}onActivated(){super.onActivated();const e=Y.currentSkin;this.buyByAdsBtn.enabled=!1,this.buyByCoinBtn.enabled=!1,this.items.forEach(t=>{const s=t.nameSkin,i=Y.IsSkinUnlocked(s);t.setLockSelected(!1),t.checkEnoughCoin(),i&&t.setLocked(!1),s===e&&t.setSelected(!0)}),this.levelContainer.scrollview.scroll=new M(0,0),ds.instance.showingTutorial?(this.fakePointTutorial.enabled=!0,this.levelContainer.scrollview.vertical=!1):(this.fakePointTutorial.enabled=!1,this.levelContainer.scrollview.vertical=!0),this.resize()}async _createItemList(){this.data=KC.getData();for(let e=0;e<this.data.length;e++){const t=new zf(this.data[e]),{EVENT:s}=zf;t.on(s.UNLOCK,this._onItemUnlock,this),t.on(s.SELECTED,this._onItemSelected,this),this.items.push(t),this.content.addChild(t)}this._reCalculateLayout()}_initFakePointTutorial(){this.fakePointTutorial=z.createEmptyImageElement({color:k.GREEN,width:220,height:220,anchor:new P(.5,1,.5,1),pivot:new M(.5,1),x:0,y:-50,opacity:.01,useInput:!0}),this.levelContainer.addChild(this.fakePointTutorial),this.fakePointTutorial.addComponent("button",{active:!0}),this.fakePointTutorial.button.on("click",e=>{if(this.items.length===0)return;let t=this.items.find(s=>s.nameSkin==="minecraft");t&&t.onClick(),this.levelContainer.scrollview.vertical=!0}),this.fakePointTutorial.name="fake-point-tutorial"}_onResizeLevelList(){let e=Z.width/Z.height,t=3,s=720,i=-130,n=.85,a=new y(1,1.3,1),o=-20;e>=2.1&&(n=.8),Z.isPortrait&&(t=3,s=800,n=1,i=-180,a=new y(1,1.4,1.2),o=-20),this._itemColumn=t,this.levelContainer.element.height=s,this.levelContainer.setLocalPosition(0,i,0),this.levelContainer.setLocalScale(n,n,n),this.background.setLocalScale(a),this.background.setLocalPosition(0,o,0),this._reCalculateLayout()}_createBackground(){this._fakeBackground=z.createEmptyImageElement({color:k.WHITE,useInput:!0,opacity:1}),this._fakeBackground.element.opacity=1,this._fakeBackground.element.anchor=new P(0,0,1,1),this.addChild(this._fakeBackground)}_createBackButton(){this.backButton=z.createButtonElement("spr_button_back",{anchor:new P(0,1,0,1),pivot:new M(0,1),x:50,y:-175}),this.addChild(this.backButton),this.backButton.button.on("click",()=>{Se.play("sfx_button"),this.fire(pl.EVENT.BACK_BUTTON_CLICKED)})}_createTextTitle(){this.textTitle=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"SKIN",fontSize:65,color:new k(.4,.4,.4),anchor:new P(.5,.9,.5,.7)}),this.textTitle.element.key="character-uppercase",this.addChild(this.textTitle)}_createBuyByCoinBtn(){this.buyByCoinBtn=z.createButtonElement("spr_frame_rectangle",{anchor:new P(.25,.05,.25,.05),pivot:new M(.5,.35)}),this.addChild(this.buyByCoinBtn),this.buyByCoinBtn.enabled=!1,this.buyByCoinBtn.name="buy-by-coin",this.iconCoin=z.createImageElement("spr_icon_coin",{anchor:new P(.25,.5,.25,.5),scale:1.4}),this.buyByCoinBtn.addChild(this.iconCoin),this.textBuyByCoin=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:1e3,size:45,color:k.WHITE,autoWidth:!1,autoFitWidth:!0,minFontSize:20,maxFontSize:50,width:260,anchor:new P(.6,.5,.6,.5)}),this.buyByCoinBtn.addChild(this.textBuyByCoin),this.buyByCoinBtn.button.on("click",this._onBtnBuyByCoinClicked.bind(this)),this.hintEnoughCoin=z.createImageElement("spr_icon_notification",{anchor:new P(0,1,0,1),pivot:new M(.5,.5),scale:.75}),this.buyByCoinBtn.addChild(this.hintEnoughCoin);let e=Q.createRotateTween(this.hintEnoughCoin,{z:10},{duration:.06,repeat:5,yoyo:!0,easing:Q.Easing.Quadratic.InOut}),t=Q.createCountTween({duration:.5});e.chain(t),t.chain(e),e.start()}_createBuyByAdsBtn(){this.buyByAdsBtn=z.createButtonElement("spr_frame_rectangle",{anchor:new P(.75,.05,.75,.05),pivot:new M(.5,.35)}),this.addChild(this.buyByAdsBtn),this.buyByAdsBtn.enabled=!1,this.iconAds=z.createImageElement("spr_icon_ads",{anchor:new P(.12,.5,.12,.5),scale:1.35}),this.buyByAdsBtn.addChild(this.iconAds),this.textBuyByAds=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"UNLOCK NOW",size:30,color:k.WHITE,autoWidth:!1,autoFitWidth:!0,minFontSize:20,maxFontSize:40,width:300,anchor:new P(.6,.5,.6,.5),wrapLines:!1}),this.textBuyByAds.element.key="unlock-now",this.buyByAdsBtn.addChild(this.textBuyByAds),this.buyByAdsBtn.button.on("click",this._onBtnBuyByAdsClicked.bind(this))}_createScrollView(){this.levelContainer=z.createGroupElement({width:1260,height:600,anchor:new P(.5,.65,.5,.65)}),this.addChild(this.levelContainer),this.background=z.createImageElement("spr_frame_shop",{anchor:new P(.5,.5,.5,.5),pivot:new M(.5,.5)}),this.levelContainer.addChild(this.background),this._createViewPort(),this.levelContainer.addComponent("scrollview",{scrollMode:$l,bounceAmount:.1,friction:.05,useMouseWheel:!0,mouseWheelSensitivity:new M(1,1),viewportEntity:this.viewport,contentEntity:this.content,vertical:!0,verticalScrollbarEntity:this.scrollbarPanel,verticalScrollbarVisibility:tm})}_createViewPort(){this.viewport=new $("viewport"),this.viewport.addComponent("element",{type:pt,anchor:new P(0,0,1,1),pivot:new M(.5,.5),color:new k(.2,.2,.2),margin:new P(0,0,0,0),padding:new P(0,0,0,0),mask:!0,opacity:1,rect:new P(0,0,1,1)}),this.levelContainer.addChild(this.viewport),this.content=new $("content"),this.content.addComponent("element",{type:Bs,anchor:new P(0,1,0,1),pivot:new M(0,1),margin:new P,height:650,useInput:!0}),this.content.addComponent("layoutgroup",{orientation:pe,padding:new P(70,0,0,-20),alignment:new M(0,1),spacing:new M(-20,-15),wrap:!0}),this.viewport.addChild(this.content)}_reCalculateLayout(){let e=this.items;if(!e[0]||!e[0].element)return;let t=e[0],s=t.element.height,i=t.element.width,n=this._itemColumn,a=n*i+(n-1)*this.content.layoutgroup.spacing.x+this.content.layoutgroup.padding.x+this.content.layoutgroup.padding.z,o=Math.ceil(e.length/n)*s+(Math.ceil(e.length/n)-1)*this.content.layoutgroup.spacing.y;this.content.element.width=a,this.content.element.height=o,this.levelContainer.element.width=a+10}_onItemUnlock(e){this.dataItemSelected=e;const t=e.name;if(this.items.forEach(s=>{s.nameSkin!==t&&s.setLockSelected(!1)}),this.buyByCoinBtn.enabled=!0,this.textBuyByCoin.element.text=e.price,this.buyByAdsBtn.enabled=!0,Y.currency<e.price){this.buyByCoinBtn.button.active=!1,this.textBuyByCoin.element.opacity=.5,this.buyByCoinBtn.element.opacity=.5,this.iconCoin.element.opacity=.5,this.hintEnoughCoin.element.enabled=!1;return}this.buyByCoinBtn.button.active=!0,this.textBuyByCoin.element.opacity=1,this.buyByCoinBtn.element.opacity=1,this.iconCoin.element.opacity=1,this.hintEnoughCoin.element.enabled=!0}_onItemSelected(e){const t=e.name;this.fire(pl.EVENT.CHANGE_ITEM_SKIN,t),Y.currentSkin=t,this.items.forEach(s=>{if(s.setLockSelected(!1),s.nameSkin===t){s.setSelected(!0);return}s.setSelected(!1)}),this.buyByAdsBtn.enabled=!1,this.buyByCoinBtn.enabled=!1}_onBtnBuyByCoinClicked(){Se.play("sfx_button");const e=this.dataItemSelected.name,t=this.dataItemSelected.price;Y.unlockSkin(e),Y.currency-=t,Gt.log("shop_item_bought",{shop_item_key:e}),this.fire(pl.EVENT.UNLOCK_ITEM_SKIN),this.items.forEach(s=>{s.checkEnoughCoin(),s.nameSkin===e&&(s.setLocked(!1),s.setLockSelected(!1))}),Ls.instance.updateUnlockSkinChallenge(1),this.buyByAdsBtn.enabled=!1,this.buyByCoinBtn.enabled=!1,this._onItemSelected(this.dataItemSelected)}_onBtnBuyByAdsClicked(){this.items.forEach(e=>{e.element.useInput=!1}),Se.play("sfx_button"),Gt.log("reward_show",{skin_name:this.dataItemSelected.name}),Q.createCountTween({duration:.1,onComplete:()=>{Z.pause(),Wt.showRewardAds(()=>{const e=this.dataItemSelected.name;Y.unlockSkin(e),this.items.forEach(t=>{t.element.useInput=!0,t.nameSkin===e&&(t.setLocked(!1),t.setLockSelected(!1))}),Ls.instance.updateUnlockSkinChallenge(1),this.buyByAdsBtn.enabled=!1,this.buyByCoinBtn.enabled=!1,this._onItemSelected(this.dataItemSelected),this._checkIsRewardAdsAvailable(),console.log("Reward Ads Success"),Z.resume()})}}).start()}checkEnableHintEnoughCoin(){return this.items.some(e=>e.checkEnoughCoin()===!0)}_checkIsRewardAdsAvailable(){this.checkRewardAdsIntervalID&&clearInterval(this.checkRewardAdsIntervalID),this._activeButtonAds(!1),this.checkRewardAdsIntervalID=setInterval(()=>{Wt.checkIsRewardAdsReady(e=>{e?(this._activeButtonAds(!0),clearInterval(this.checkRewardAdsIntervalID)):this._activeButtonAds(!1)})},1e3)}_activeButtonAds(e){this.buyByAdsBtn.button.active=e;let t=e?1:.5;this.buyByAdsBtn.element.opacity=t,this.textBuyByAds.element.opacity=t,this.iconAds.element.opacity=t}};pl.EVENT={BACK_BUTTON_CLICKED:"ShopScreen: BackButtonClicked",CHANGE_ITEM_SKIN:"ShopScreen: ChangeItemSkin",UNLOCK_ITEM_SKIN:"ShopScreen: UnlockItemSkin"};let _r=pl;const ca=20,Fu=550,bj=20,dr=10,ml=class ml extends ${constructor(e,t="#0794d2",s){super(`${e} dialog}`),this.tapAnywhereToClose=!1,this.closed=!1,this.color=ve.hexToRgb(t),window.addEventListener("keyup",i=>this._onKeyPress(i)),this.addComponent("element",{type:pt,anchor:new P(.5,.5,.5,.5),width:Fu+ca+dr*2,height:dr*2,pivot:new M(.5,.5),margin:new P(0,0,0,0),spriteAsset:K.find("spr_dialog_frame_stroke")}),this.element.color=this.color,this._createContainer(),this.createTitle(e,s),Ko(5).then(()=>this.resize()),window.addEventListener("resize",()=>this.resize())}resize(){Z.width/Z.height<O.GAME_RESIZE_RATIO?(this.element&&(this.element.width=(Fu+ca+dr*2)*1.5,Ko(20).then(()=>{this.element.height=this.container.element.height*1.5+dr*2.5})),this.container.setLocalScale(1.5,1.5,1.5)):(this.element&&(this.element.width=Fu+ca+dr*2,Ko(20).then(()=>{this.element.height=this.container.element.height+dr*2})),this.container.setLocalScale(1,1,1))}_createContainer(){this.container=z.createImageElement("spr_dialog_frame",{width:Fu+ca,height:0}),this.container.addComponent("layoutgroup",{orientation:Pe,padding:new P(ca,0,ca,ca+dr),spacing:new M(0,bj),alignment:new M(.5,1),reverseY:!1}),this.addChild(this.container),this.fitter=this.container.addScript($C)}createTitle(e,t){this.titleText=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{fontSize:32,text:e,color:new k(64/255,12/255,16/255)});const s=z.createGroupElement();if(s.element.margin=new P(0,0,0,0),s.addComponent("layoutgroup",{orientation:pe,spacing:new M(20,0),alignment:new M(.5,.5)}),t){const i=z.createImageElement(t),n=70;i.element.width=i.element.width*(n/i.element.height)*.7,i.element.height=n*.7,s.addChild(i),this.icon=i}s.addChild(this.titleText),this.title=s,this.addContent(s,!1)}addTapToClose(){this.tapAnywhereToClose=!0}addButtonClose(){var t;const e=z.createButtonElement("spr_button_close_dialog",{anchor:new P(0,1,0,1),pivot:new M(.5,.5),scale:1.5});this.addChild(e),(t=e.element)==null||t.on("click",()=>{this.close(),Se.play("sfx_menu_button")}),this.buttonClose=e}close(){this.closed||(this.closed=!0,this.fire(ml.EVENT_CLOSE),Ko().then(()=>this.destroy()))}addContent(e,t=!0,s=-1){s===-1?this.container.insertChild(e,0):this.container.insertChild(e,s),t&&this.fit()}fit(){this.fitter.fit(),Ko(2).then(()=>{this.element&&this.container&&this.container.element&&(this.element.height=this.container.element.height+dr*2)})}_onKeyPress(e){e.key==="Escape"&&(this.tapAnywhereToClose||this.buttonClose)&&this.close()}};ml.EVENT_CLOSE="dialog:close",ml.EVENT_OPTION_SELECTED="dialog:optionSelected",ml.EVENT_SHOW="dialog:onShow";let nl=ml;class Sa extends Lt{constructor(){super("dialogScreen"),this.dialogQueue=[],Sa._instance=this}static get Instance(){return Sa._instance||(Sa._instance=new Sa),Sa._instance}create(){super.create(),this._createBackground(),this._createForeground()}_createForeground(){this.foreground=z.createEmptyImageElement({color:k.BLACK,opacity:.01,useInput:!0}),this.foreground.element&&(this.foreground.element.anchor=new P(0,0,1,1),this.foreground.element.pivot=new M(.5,1)),this.foreground.enabled=!1}_createBackground(){this.background=z.createEmptyImageElement({color:k.BLACK,opacity:.8,useInput:!0}),this.background.element&&(this.background.element.anchor=new P(0,0,1,1),this.background.element.pivot=new M(.5,1)),this.addChild(this.background),this.background.enabled=!1}showDialog(e){if(this.currentDialog){this.dialogQueue.push(e);return}this.currentDialog=e,this.addChild(e),e.fit(),e.tapAnywhereToClose&&ve.registerOnceTouch(this.background.element,this.closeDialog.bind(this,e)),e.once(nl.EVENT_CLOSE,this._onDialogClosed,this),e.fire(nl.EVENT_SHOW),this.background.enabled=!0,this.foreground.enabled=!0,this.addChild(this.foreground),setTimeout(()=>{this.foreground.enabled=!1,this.removeChild(this.foreground)},500)}closeDialog(e){e.close(),this.fire(nl.EVENT_CLOSE,e)}_onDialogClosed(){this.currentDialog=void 0,this.dialogQueue.length>0?this.showDialog(this.dialogQueue.shift()):this.background.enabled=!1,this.fire(nl.EVENT_CLOSE)}}class O_ extends Lt{constructor(){super(O.ADS_SCREEN_NAME)}create(){super.create(),this.bg=new $("AdsScreenBG"),this.addChild(this.bg),this.bg.addComponent("element",{type:pt,anchor:new P(0,0,1,1),margin:new P,opacity:0,useInput:!0})}}const Zf=class Zf extends ${constructor(){super(),this.addComponent("element",{type:Bs,anchor:new P(0,.5,1,.5),pivot:new M(.5,.5),margin:new P,height:100}),this.addComponent("layoutgroup",{orientation:pe,reverseY:!0,alignment:new M(.5,.5),padding:new P(0,0,0,0),spacing:new M(20,0),widthFitting:Rg}),this._initUI()}_initUI(){this.challengeStatus="unreach",this._initText(),this._initProgressText(),this._initButtonClaim()}_initText(){this.text=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{anchor:new P(.5,.5,.5,.5),pivot:new M(0,.5),margin:new P(0,0,0,0),alignment:new M(0,.5),color:k.WHITE,text:"Challenge",width:400,autoWidth:!1,autoFitWidth:!0,minFontSize:25,maxFontSize:32,wrapLines:!1}),this.addChild(this.text)}_initProgressText(){this.progressText=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{anchor:new P(.5,.5,.5,.5),pivot:new M(.5,.5),margin:new P(0,0,0,0),text:"Progress",color:k.WHITE,width:100,autoWidth:!1,autoFitWidth:!0,minFontSize:25,maxFontSize:32,wrapLines:!1}),this.addChild(this.progressText)}_initButtonClaim(){this.claimButton=z.createButtonElement("spr_frame_rectangle_white",{anchor:new P(.5,.5,.5,.5),pivot:new M(.5,.5),margin:new P(0,0,0,0),pressedTint:new k(.7,.7,.7)});let e=z.createGroupElement({anchor:new P(.5,.5,.5,.5),pivot:new M(.5,.5)});this.claimButton.addChild(e),this.addChild(this.claimButton),this.rewardEntity=new $("reward"),this.rewardEntity.addComponent("element",{type:Bs}),this.rewardEntity.addComponent("layoutgroup",{orientation:pe,alignment:new M(.5,.5),padding:new P(0,0,0,-10),spacing:new M(20,0)}),e.addChild(this.rewardEntity);let t=z.createImageElement("spr_icon_coin",{pivot:new M(.5,.5),anchor:new P(.5,.5,.5,.5),scale:1.2});this.rewardEntity.addChild(t),this.rewardText=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{anchor:new P(.5,.5,.5,.5),pivot:new M(.5,.5),alignment:new M(.5,.5),margin:new P(0,0,0,0),color:ve.createColor(123,123,123),text:"200",wrapLines:!1,fontSize:50}),this.rewardEntity.addChild(this.rewardText),this.rewardEntity.setLocalScale(.7,.7,.7),this.claimText=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{width:180,height:50,autoWidth:!1,autoFitWidth:!0,minFontSize:20,maxFontSize:28,autoHeight:!1,autoFitHeight:!0,color:ve.createColor(123,123,123),text:"Claim"}),e.addChild(this.claimText),this.claimText.element.key="claimed",this.claimButton.button.on("click",s=>{this.onButtonClaimClicked(s)})}setData(e){this.challenge=e,this.challenge.emitter.on(Ps.Event.COMPLETED,()=>{this.onComplete()}),this.challenge.emitter.on(Ps.Event.UPDATE,t=>{this.challenge.progress=t.progress,this._updateUI()}),this._updateUI()}_updateUI(){this.text.element.key=this.challenge.description,this.text.element.localizeParams={number:this.challenge.currentGoal},this.progressText.element.text=`${this.challenge.progress}/${this.challenge.currentGoal}`,this.rewardText.element.text=`${this.challenge.rewardPerUnit*this.challenge.currentGoal}`,this._updateButton()}_updateButton(){let e=Y.getDailyChallengeData(),t=!1;e.forEach(s=>{s.type===this.challenge.type&&s.id===this.challenge.id&&s.claimed&&(t=!0)}),this.challenge.completed?(this._enableClaimButton(),t&&this._onRewardClaimed()):this._disableClaimButton()}_claimReward(){let e=Y.getDailyChallengeData();e.forEach(t=>{t.type===this.challenge.type&&t.id===this.challenge.id&&(t.claimed=!0,this._onRewardClaimed())}),Y.currency+=this.challenge.rewardPerUnit*this.challenge.currentGoal,Y.setDailyChallengeData(e)}_disableClaimButton(){this.claimText.enabled=!1,this.rewardEntity.enabled=!0,this.claimButton.element.color=ve.createColor(186,186,186),this.claimText.element.color=ve.createColor(123,123,123),this.claimButton.element.useInput=!1}_enableClaimButton(){this.fire(Zf.Event.Claim,this),this.challengeStatus="open",this.claimText.enabled=!1,this.rewardEntity.enabled=!0,this.claimButton.element.color=ve.createColor(255,255,255),this.claimText.element.color=ve.createColor(123,123,123),this.claimButton.element.useInput=!0}_onRewardClaimed(){this.challengeStatus="claimed",this.claimText.enabled=!0,this.rewardEntity.enabled=!1,this.claimButton.element.color=ve.createColor(68,68,68),this.claimText.element.color=ve.createColor(123,123,123),this.claimButton.element.useInput=!1}onButtonClaimClicked(e){e.touch&&e.event.preventDefault(),Se.play("sfx_button"),this._claimReward()}onComplete(){this._enableClaimButton()}checkStatusChallenge(){return this.challengeStatus}};Zf.Event={Claim:"DailyChallengeUI:Claim",Claimed:"DailyChallengeUI:Claimed"};let Vf=Zf;const Jf=class Jf extends Lt{constructor(){super(O.DAILY_CHALLENGE_SCREEN_NAME),this.challengeUIs=[]}create(){super.create(),this._initFakeBg(),this._initBackButton(),this._createTextTitle(),this._initPanel(),this._initScrollView(),this._initFakePointTutorial(),this.resize()}resize(){super.resize();let e=this.panelEntity.element.height*.5+100;this.textTitle.setLocalPosition(0,e,0)}onActivated(){super.onActivated(),this.scrollViewEntity.scrollview.scroll=new M(0,0),this.challengeUIs.forEach(e=>{e.challengeStatus==="claimed"&&this._onMoveBottomChallengeUI(e)}),ds.instance.showingTutorial?(this.fakePointTutorial.enabled=!0,this.scrollViewEntity.scrollview.vertical=!1):(this.fakePointTutorial.enabled=!1,this.scrollViewEntity.scrollview.vertical=!0)}_initFakeBg(){this.fakeBackground=z.createEmptyImageElement({color:k.WHITE,useInput:!0,opacity:1}),this.fakeBackground.element.anchor=new P(0,0,1,1),this.addChild(this.fakeBackground)}_initBackButton(){let e=z.createImageElement("spr_button_back",{anchor:new P(.1,.9,.1,.9),useInput:!0,scale:1});this.addChild(e),e.addComponent("button",{active:!0,imageEntity:e,hoverTint:new k(.9,.9,.9),pressTint:new k(.5,.5,.5)}),e.button.on("click",t=>{t.touch&&t.event.preventDefault(),Se.play("sfx_button"),this.fire(Jf.Event.Back)})}_createTextTitle(){this.textTitle=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"DAILY CHALLENGE",fontSize:65,color:new k(.4,.4,.4),anchor:new P(.5,.5,.5,.5)}),this.textTitle.element.key="daily-challenge",this.addChild(this.textTitle)}_initPanel(){this.panelEntity=z.createImageElement("spr_frame_panel",{anchor:new P(.5,.5,.5,.5),pivot:new M(.5,.5),margin:new P(0,0,0,0),scale:1}),this.addChild(this.panelEntity)}_initFakePointTutorial(){this.fakePointTutorial=z.createEmptyImageElement({color:k.BLACK,width:190,height:80,anchor:new P(1,1,1,1),pivot:new M(1,1),x:-40,y:-50,opacity:.01,useInput:!0}),this.panelEntity.addChild(this.fakePointTutorial),this.fakePointTutorial.addComponent("button",{active:!0}),this.fakePointTutorial.button.on("click",e=>{if(this.contentEntity.children.length===0)return;this.contentEntity.children[0].onButtonClaimClicked(e),this.fakePointTutorial.button.active=!1,this.scrollViewEntity.scrollview.vertical=!0}),this.fakePointTutorial.name="fake-point-tutorial"}_initScrollView(){this.scrollViewEntity=new $,this.panelEntity.addChild(this.scrollViewEntity),this.scrollViewEntity.addComponent("element",{type:"group",anchor:new P(0,0,1,1),pivot:new M(.5,1),margin:new P(0,50,0,40)}),this.scrollViewEntity.addComponent("scrollview",{horizontal:!1,vertical:!0,scrollMode:$l,bounceAmount:.1,friction:.05});let e=new $;e.addComponent("element",{type:"image",pivot:new M(.5,1),anchor:new P(.05,0,.95,1),mask:!0,margin:new P(0,0,0,0)}),this.scrollViewEntity.addChild(e),this.scrollViewEntity.scrollview.viewportEntity=e,this.contentEntity=z.createGroupElement({pivot:new M(.5,1),anchor:new P(.5,1,.5,1),width:1e3,height:1e3,useInput:!0}),this.contentEntity.addComponent("layoutgroup",{orientation:Pe,reverseY:!0,alignment:new M(.5,1),padding:new P(0,0,0,0),spacing:new M(0,10)}),e.addChild(this.contentEntity),this.scrollViewEntity.scrollview.contentEntity=this.contentEntity;const t=[],s=[],i=[];Ls.instance.challenges.forEach(n=>{let a=new Vf;a.setData(n),a.on(Vf.Event.Claim,this._onMoveTopChallengeUI.bind(this)),this.challengeUIs.push(a);const o=a.challengeStatus;o==="open"?t.push(a):o==="claimed"?i.push(a):s.push(a)}),t.forEach(n=>this.contentEntity.addChild(n)),s.forEach(n=>this.contentEntity.addChild(n)),i.forEach(n=>this.contentEntity.addChild(n)),this._onContentChanged()}_onContentChanged(){let e=this.challengeUIs;if(!e[0]||!e[0].element)return;let t=e[0],s=t.element.height,i=t.element.width,n=1,a=n*i+(n-1)*this.contentEntity.layoutgroup.spacing.x+this.contentEntity.layoutgroup.padding.x+this.contentEntity.layoutgroup.padding.z,o=Math.ceil(e.length/n)*s+(Math.ceil(e.length/n)-1)*this.contentEntity.layoutgroup.spacing.y;this.contentEntity.element.width=a,this.contentEntity.element.height=o}_onMoveTopChallengeUI(e){let t=this.challengeUIs.indexOf(e);t<0||(this.challengeUIs.splice(t,1),this.challengeUIs.unshift(e),this.contentEntity.removeChild(e),this.contentEntity.insertChild(e,0),this._onContentChanged())}_onMoveBottomChallengeUI(e){let t=this.challengeUIs.indexOf(e);t<0||(this.challengeUIs.splice(t,1),this.challengeUIs.push(e),this.contentEntity.removeChild(e),this.contentEntity.addChild(e),this._onContentChanged())}};Jf.Event={Back:"DailyChallengeScreen:Back"};let rl=Jf;class al{static init(e){this._current=0,this._dt=0,this.scale=1}static update(e){this._dt=e*this.scale,this._current+=this._dt}static get dt(){return this._dt}static get current(){return this._current}static get currentMS(){return this._current*1e3}}const Qf=class Qf extends ${constructor(e){super(),this._isLocked=!1,this._level=e,this.addComponent("element",{type:Bs,anchor:new P(.5,.5,.5,.5),useInput:!0,width:190,height:190}),this._frameLocked=z.createImageElement("spr_frame_square",{width:190,height:190}),this.addChild(this._frameLocked),this._frameUnlocked=z.createImageElement("spr_frame_level_item_unocked",{width:190,height:190}),this.addChild(this._frameUnlocked),this._textLevel=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:`${e}`,fontSize:90,alignment:new M(.5,.5),color:ve.createColor(255,255,255,1)}),this.addComponent("button",{active:!0,imageEntity:this._frameUnlocked,hoverTint:new k(.9,.9,.9),pressedTint:new k(.7,.7,.7)}),this.addChild(this._textLevel),this.setLocalScale(.8,.8,.8),this.button.on("click",this.onClick,this),this.setLocked(!0)}setLocked(e){this._isLocked=e,this._textLevel.element.color=e?ve.createColor(255,255,255,1):ve.createColor(101,101,101,.5),this._frameUnlocked.enabled=!e,this.button.enabled=!e}onClick(e){e.touch&&e.event.preventDefault(),Se.play("sfx_button"),this.fire(Qf.EVENT.SELECTED,this._level)}get level(){return this._level}};Qf.EVENT={SELECTED:"selected"};let Gf=Qf;const _c=class _c extends Lt{constructor(){super(O.CHALLENGE_LEVEL_SELECTOR_SCREEN_NAME),this.items=[],this._levelColumn=5}create(){super.create(),this._createBackground(),this._initTextTitle(),this._initBackButton(),this._createScrollView(),this._createLevelList(),this._createFakePointTutorial(),this.resize()}resize(){super.resize(),this._onResizeLevelList()}onActivated(){super.onActivated();let e=Y.highestChallengeLevel;for(let t=0;t<this.items.length;t++)this.items[t].setLocked(t>=e);this._onResizeLevelList(),this.scrollbarPanel.scrollbar.value=0,ds.instance.showingTutorial?(this.fakePointTutorial.enabled=!0,this.levelContainer.scrollview.vertical=!1):(this.fakePointTutorial.enabled=!1,this.levelContainer.scrollview.vertical=!0)}_createBackground(){this._fakeBackground=z.createEmptyImageElement({color:k.WHITE,useInput:!0,opacity:1}),this._fakeBackground.element.opacity=1,this._fakeBackground.element.anchor=new P(0,0,1,1),this.addChild(this._fakeBackground)}_initTextTitle(){let e=z.createGroupElement({anchor:new P(.5,.8,.5,.8),pivot:new M(.5,.5)});this.addChild(e);let t=z.createImageElement("spr_frame_rectangle",{width:350,height:120});e.addChild(t);let s=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"LEVELS",size:40,color:k.WHITE,autoWidth:!1,autoFitWidth:!0,minFontSize:35,maxFontSize:45,width:260,anchor:new P(.5,.5,.5,.5),wrapLines:!1});e.addChild(s),s.element.key="levels"}_initBackButton(){let e=z.createImageElement("spr_button_back",{anchor:new P(.1,.9,.1,.9),useInput:!0,scale:1});this.addChild(e),e.addComponent("button",{active:!0,imageEntity:e,hoverTint:new k(.9,.9,.9),pressTint:new k(.5,.5,.5)}),e.button.on("click",t=>{t.touch&&t.event.preventDefault(),Se.play("sfx_button"),this.fire(_c.EVENT.BACK)})}async _createLevelList(){for(let e=0;e<20;e++){let t=new Gf(e+1);t.on(Gf.EVENT.SELECTED,this._onItemSelected,this),this.items.push(t),this.content.addChild(t)}this._reCalculateLayout()}_onResizeLevelList(){let e=Z.width/Z.height,t=5,s=600,i=-130;Z.isPortrait&&(t=3,s=1200,i=-180,e>.65&&(t=4,s=900,i=-120)),this._levelColumn=t,this.levelContainer.element.height=s,this.levelContainer.setLocalPosition(0,i,0),this._reCalculateLayout()}_onItemSelected(e){this.fire(_c.EVENT.ITEM_SELECTED,e)}_createScrollView(){this.levelContainer=z.createGroupElement({width:1260,height:600,y:-150}),this.addChild(this.levelContainer),this._createViewPort(),this._createVerticalScrollBar(),this.levelContainer.addComponent("scrollview",{scrollMode:$l,bounceAmount:.1,friction:.05,useMouseWheel:!0,mouseWheelSensitivity:new M(1,1),viewportEntity:this.viewport,contentEntity:this.content,vertical:!0,verticalScrollbarEntity:this.scrollbarPanel,verticalScrollbarVisibility:tm}),this.scrollbarPanel.scrollbar._updateHandlePositionAndSize()}_createViewPort(){this.viewport=new $("viewport"),this.viewport.addComponent("element",{type:pt,anchor:new P(0,0,1,1),pivot:new M(.5,.5),color:new k(.2,.2,.2),margin:new P(0,0,0,0),padding:new P(0,0,0,0),mask:!0,opacity:1,rect:new P(0,0,1,1)}),this.levelContainer.addChild(this.viewport),this.content=new $("content"),this.content.addComponent("element",{type:Bs,anchor:new P(0,1,0,1),pivot:new M(0,1),margin:new P,height:650,useInput:!0}),this.content.addComponent("layoutgroup",{orientation:pe,padding:new P(20,0,0,-20),alignment:new M(0,1),spacing:new M(70,70),wrap:!0}),this.viewport.addChild(this.content)}_createVerticalScrollBar(){this.handle=new $("handle"),this.handle.addComponent("element",{type:pt,color:ve.createColor(102,102,102,1),anchor:new P(0,1,1,1),pivot:new M(1,1),width:0,height:20,margin:new P(0,0,0,0),useInput:!0}),this.handle.addComponent("button",{active:!0,hoverTint:new k(.9,.9,.9),pressedTint:new k(.5,.5,.5),imageEntity:this.handle}),this.scrollbarPanel=new $("scrollbar"),this.scrollbarPanel.addComponent("element",{type:pt,anchor:new P(1,0,1,1),pivot:new M(1,1),width:7,margin:new P(0,0,0,0),rect:new P(0,0,1,1),color:ve.createColor(178,178,178,1)}),this.scrollbarPanel.addChild(this.handle),this.scrollbarPanel.addComponent("scrollbar",{orientation:Pe,value:0,handleSize:.5,handleEntity:this.handle}),this.levelContainer.addChild(this.scrollbarPanel)}_reCalculateLayout(){let e=this.items;if(!e[0]||!e[0].element)return;let t=e[0],s=t.element.height,i=t.element.width,n=this._levelColumn,a=n*i+(n-1)*this.content.layoutgroup.spacing.x+this.content.layoutgroup.padding.x+this.content.layoutgroup.padding.z,o=Math.ceil(e.length/n)*s+(Math.ceil(e.length/n)-1)*this.content.layoutgroup.spacing.y;this.content.element.width=a,this.content.element.height=o,this.levelContainer.element.width=a+10,this.scrollbarPanel.scrollbar._updateHandlePositionAndSize()}_createFakePointTutorial(){this.fakePointTutorial=z.createEmptyImageElement({color:k.GREEN,width:150,height:150,anchor:new P(0,1,0,1),pivot:new M(0,1),x:20,y:-20,opacity:.01,useInput:!0}),this.levelContainer.addChild(this.fakePointTutorial),this.fakePointTutorial.name="fakePointTutorial",this.fakePointTutorial.addComponent("button",{active:!0}),this.fakePointTutorial.button.on("click",e=>{if(this.items.length===0)return;let t=this.items[0];t&&t.onClick(e),this.levelContainer.scrollview.vertical=!0})}};_c.EVENT={BACK:"back",ITEM_SELECTED:"itemSelected"};let xa=_c;const ep=class ep extends Lt{constructor(){super(O.TAP_ZONE_SCREEN_NAME),this._isTapping=!1}create(){super.create(),this._createTapZone(),this.resize()}resize(){super.resize()}update(){super.update()}_createTapZone(){this.tapZone=z.createImageElement("spr_white",{color:k.RED,useInput:!0,opacity:.01}),this.tapZone.element.anchor=new P(0,0,1,1),this.addChild(this.tapZone),this.tapZone.element.on("touchstart",this._onTapStart,this),this.tapZone.element.on("mousedown",this._onTapStart,this),this.tapZone.element.on("touchend",this._onTapEnd,this),this.tapZone.element.on("mouseup",this._onTapEnd,this)}_onTapStart(){this._isTapping=!0,this.fire(ep.EVENT.TAP)}_onTapEnd(){this._isTapping=!1}disableTapZone(){this.tapZone.element.useInput=!1,this.tapZone.enabled=!1}enableTapZone(){this.tapZone.element.useInput=!0,this.tapZone.enabled=!0}};ep.EVENT={TAP:"tap"};let ol=ep;class da extends Lt{constructor(){super(O.CURRENCY_SCREEN_NAME),Y.emitter.on(Y.Event.CurrencyChanged,this.updateCurrency.bind(this))}create(){super.create(),this._createCurrency(),this.resize()}resize(){super.resize()}_createCurrency(){this.currency=this._formatCurrency(Y.currency),this.frameCoin=z.createImageElement("spr_frame_rectangle",{anchor:new P(0,1,0,1),pivot:new M(0,1),x:50,y:-50,scale:.72}),this.addChild(this.frameCoin),this.iconCoin=z.createImageElement("spr_icon_coin",{anchor:new P(0,0,0,0),pivot:new M(0,0),x:25,y:15,scale:1.25}),this.frameCoin.addChild(this.iconCoin),this.textCoin=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:this.currency.toString(),size:55,color:k.WHITE,autoWidth:!1,autoFitWidth:!0,minFontSize:35,maxFontSize:55,width:260,anchor:new P(1,.5,1,.5),pivot:new M(1,.5),x:15}),this.frameCoin.addChild(this.textCoin),this.updateCurrency()}updateCurrency(){this.currency=this._formatCurrency(Y.currency),this.textCoin.element.text=this.currency}_formatCurrency(e){if(e>=1e3&&e<1e6){let t=e/1e3;return t%1!==0?`${Math.floor(t*10)/10}K`:`${t}K`}else if(e>=1e6){let t=e/1e6;return t%1!==0?`${Math.floor(t*10)/10}M`:`${t}M`}else return e.toString()}}const Vw="press-arrow-up-to-continue",Gw="tap-to-continue",Tj="press-arrow-up-to-jump",Ej="swipe-up-to-jump",Cj="press-arrow-down-to-crouch",Aj="swipe-down-to-crouch",F_="tutorial-continue",Hw="tutorial-jump",Ww="tutorial-crouch";class vn extends Lt{constructor(){super(O.PAUSE_SCREEN_NAME),this.tutorialState=F_,this.topSwipePosition=new M(-360,-195),this.bottomSwipePosition=new M(-360,-395),this.tweenSwipeUp=null,this.tweenMoveUp=null,this.tweenSwipeDown=null,this.tweenMoveDown=null,this.delayTween=null,this._delayCrouchTween=null}create(){super.create(),this._createTutorialText(),this._initTextTutorialScaleTween(),this._createConnectionBar(),this._createSwipeUpTutorial(),this._createTweenSwipeUp(),this._createSwipeDownTutorial(),this._createTweenSwipeDown(),this._createPressArrowUpTutorial(),this._createPressArrowDownTutorial(),this.resize()}resize(){switch(super.resize(),this.tutorialState){case F_:this.changeToContinueTutorialText();break;case Hw:this.changeToJumpTutorialText();break;case Ww:this.changeToCrouchTutorialText();break;default:console.error("Invalid tutorial state");break}this._onResizeSwipeTutorial(),this._onResizeConnectionBar()}_createTutorialText(){this.tutorialText=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"HI",fontSize:50,color:new k(.4,.4,.4),anchor:new P(.5,.5,.5,.5),y:-400,autoWidth:!1,autoFitWidth:!0,width:500,wrapLines:!0,spacing:1.05,lineHeight:40}),this.tutorialText.element.isUpperCase=!0,ve.checkDevice()===O.DEVICE_DESKTOP_NAME?this.tutorialText.element.key=Vw:this.tutorialText.element.key=Gw,this.addChild(this.tutorialText)}_initTextTutorialScaleTween(){Q.createScaleTween(this.tutorialText,new M(1.15,1.15),{duration:.5,loop:!0,yoyo:!0,easing:Yt.Quadratic.InOut}).start()}_createConnectionBar(){this.connectionBar=z.createImageElement("spr_connection_bar",{anchor:new P(.5,.5,.5,.5),y:-400,x:-350,scale:1.5}),this.addChild(this.connectionBar),this.connectionBar.enabled=!1}_onResizeConnectionBar(){let e=new y(-350,-300,0);Z.isPortrait&&(e.y=-450),this.connectionBar.setLocalPosition(e.x,e.y,e.z)}_createSwipeUpTutorial(){this.groupSwipeUp=z.createGroupElement({y:-100}),this.addChild(this.groupSwipeUp),this.startPointSwipeUp=z.createImageElement("spr_start_point",{anchor:new P(.5,.5,.5,.5),y:-400,x:-350}),this.groupSwipeUp.addChild(this.startPointSwipeUp),this.endPointSwipeUp=z.createImageElement("spr_end_point",{anchor:new P(.5,.5,.5,.5),y:-200,x:-350}),this.groupSwipeUp.addChild(this.endPointSwipeUp),this.handSwipeUp=z.createImageElement("spr_hand_2",{anchor:new P(.5,.5,.5,.5),x:0,y:0,scale:.85,pivot:new M(0,1)}),this.groupSwipeUp.addChild(this.handSwipeUp),this.groupSwipeUp.enabled=!1}_createSwipeDownTutorial(){this.groupSwipeDown=z.createGroupElement({y:-100}),this.addChild(this.groupSwipeDown),this.startPointSwipeDown=z.createImageElement("spr_start_point",{anchor:new P(.5,.5,.5,.5),y:-200,x:-350}),this.groupSwipeDown.addChild(this.startPointSwipeDown),this.endPointSwipeDown=z.createImageElement("spr_end_point",{anchor:new P(.5,.5,.5,.5),y:-400,x:-350}),this.groupSwipeDown.addChild(this.endPointSwipeDown),this.handSwipeDown=z.createImageElement("spr_hand_2",{anchor:new P(.5,.5,.5,.5),x:0,y:0,scale:.85,pivot:new M(0,1)}),this.groupSwipeDown.addChild(this.handSwipeDown),this.groupSwipeDown.enabled=!1}_createTweenSwipeUp(){this.handSwipeUp.setLocalPosition(this.bottomSwipePosition.x,this.bottomSwipePosition.y,0),this.tweenMoveUp=Q.createTween(this.handSwipeUp.getLocalPosition(),{x:this.topSwipePosition.x,y:this.topSwipePosition.y},{duration:1,easing:Yt.Quadratic.InOut,onUpdate:e=>{this.handSwipeUp.setLocalPosition(e.x,e.y,0)},onComplete:()=>{this.handSwipeUp.setLocalPosition(this.bottomSwipePosition.x,this.bottomSwipePosition.y,0),this.tweenSwipeUp.start()}}),this.tweenSwipeUp=Q.createScaleTween(this.handSwipeUp,new M(.5,.5),{duration:.5,easing:Yt.Quadratic.InOut,onComplete:()=>{this.tweenMoveUp.start()}})}_createTweenSwipeDown(){this.handSwipeDown.setLocalPosition(this.topSwipePosition.x,this.topSwipePosition.y,0),this.tweenMoveDown=Q.createTween(this.handSwipeDown.getLocalPosition(),{x:this.bottomSwipePosition.x,y:this.bottomSwipePosition.y},{duration:1,easing:Yt.Quadratic.InOut,onUpdate:e=>{this.handSwipeDown.setLocalPosition(e.x,e.y,0)},onComplete:()=>{this.delayTween.start()}}),this.delayTween=Q.createTween({},{},{duration:.5,onComplete:()=>{this.handSwipeDown.setLocalPosition(this.topSwipePosition.x,this.topSwipePosition.y,0),this.tweenSwipeDown.start()}}),this.tweenSwipeDown=Q.createScaleTween(this.handSwipeDown,new M(.5,.5),{duration:.5,easing:Yt.Quadratic.InOut,onComplete:()=>{this.tweenMoveDown.start()}})}_onResizeSwipeTutorial(){let e=0;Z.isPortrait&&(e=-150),this.groupSwipeUp.setLocalPosition(0,e,0),this.groupSwipeDown.setLocalPosition(0,e,0)}_createPressArrowUpTutorial(){this._jumpTutorialPCGroup=z.createGroupElement({anchor:new P(.5,.5,.5,.5),y:-430,x:-500}),this.addChild(this._jumpTutorialPCGroup);let e=z.createImageElement("spr_icon_arrow_up",{pivot:new M(.5,0)});this._jumpTutorialPCGroup.addChild(e),Q.createScaleTween(e,{x:.9,y:.9,z:1},{duration:.3,repeat:1/0,yoyo:!0,repeatDelay:.1}).start();let t=z.createImageElement("spr_hand",{pivot:new M(0,1),scale:1.2,x:10,y:30});Q.createScaleTween(t,{x:.9,y:.9,z:1},{duration:.3,repeat:1/0,yoyo:!0,repeatDelay:.1}).start(),this._jumpTutorialPCGroup.addChild(t),this._jumpTutorialPCGroup.enabled=!1}_createPressArrowDownTutorial(){this._crouchTutorialPCGroup=z.createGroupElement({anchor:new P(.5,.5,.5,.5),y:-430,x:-500}),this.addChild(this._crouchTutorialPCGroup);let e=z.createImageElement("spr_icon_arrow_down",{pivot:new M(.5,0)});this._crouchTutorialPCGroup.addChild(e);let t=Q.createScaleTween(e,{x:.8,y:.8,z:1},{delay:.4,duration:.3}),s=z.createImageElement("spr_hand",{pivot:new M(0,1),scale:1.2,x:10,y:30}),i=Q.createScaleTween(s,{x:.8,y:.8,z:1},{delay:.4,duration:.3,onComplete:()=>{n.start()}});this._crouchTutorialPCGroup.addChild(s);let n=Q.createCountTween({duration:.5,onComplete:()=>{e.setLocalScale(1,1,1),s.setLocalScale(1,1,1),t.start(),i.start()}});this._delayCrouchTween=Q.createCountTween({duration:0,onComplete:()=>{e.setLocalScale(1,1,1),s.setLocalScale(1,1,1),t.start(),i.start()}})}changeToContinueTutorialText(){ve.checkDevice()===O.DEVICE_DESKTOP_NAME?this.tutorialText.element.key=Vw:this.tutorialText.element.key=Gw,this._hideAllTweenSwipe(),this._hideAllTutorialPC(),this.tutorialState=F_}changeToJumpTutorialText(){ve.checkDevice()===O.DEVICE_DESKTOP_NAME?(this.tutorialText.element.key=Tj,this._showJumpTutorialPC()):(this.tutorialText.element.key=Ej,this._showTweenSwipeUp()),this.tutorialState=Hw}changeToCrouchTutorialText(){ve.checkDevice()===O.DEVICE_DESKTOP_NAME?(this.tutorialText.element.key=Cj,this._showCrouchTutorialPC()):(this.tutorialText.element.key=Aj,this._showTweenSwipeDown()),this.tutorialState=Ww}_showTweenSwipeUp(){var e,t;this.groupSwipeUp.enabled=!0,(e=this.tweenSwipeUp)==null||e.start(),this.groupSwipeDown.enabled=!1,(t=this.tweenSwipeDown)==null||t.stop(),this.connectionBar.enabled=!0,this._hideAllTutorialPC()}_showTweenSwipeDown(){var e,t;this.groupSwipeDown.enabled=!0,(e=this.tweenSwipeDown)==null||e.start(),this.groupSwipeUp.enabled=!1,(t=this.tweenSwipeUp)==null||t.stop(),this.connectionBar.enabled=!0,this._hideAllTutorialPC()}_hideAllTweenSwipe(){var e,t;this.groupSwipeUp.enabled=!1,(e=this.tweenSwipeUp)==null||e.stop(),this.groupSwipeDown.enabled=!1,(t=this.tweenSwipeDown)==null||t.stop(),this.connectionBar.enabled=!1}_showJumpTutorialPC(){this._jumpTutorialPCGroup.enabled=!0,this._crouchTutorialPCGroup.enabled=!1,this._hideAllTweenSwipe()}_showCrouchTutorialPC(){var e,t;this._crouchTutorialPCGroup.enabled=!0,(e=this._delayCrouchTween)==null||e.stop(),(t=this._delayCrouchTween)==null||t.start(),this._jumpTutorialPCGroup.enabled=!1,this._hideAllTweenSwipe()}_hideAllTutorialPC(){this._jumpTutorialPCGroup.enabled=!1,this._crouchTutorialPCGroup.enabled=!1}}class YC extends ${constructor(){super(),this.addComponent("screen",{screenSpace:!0,scaleMode:Id,resolution:new M(O.GAME_WIDTH,O.GAME_HEIGHT),referenceResolution:new M(O.GAME_WIDTH,O.GAME_HEIGHT),priority:100}),this.create()}create(){this._createBackground(),this._createLoadingIcon()}_createBackground(){this.background=z.createEmptyImageElement({color:k.BLACK,useInput:!0,opacity:.85}),this.background.element.anchor=new P(0,0,1,1),this.addChild(this.background)}_createLoadingIcon(){this.loadingIcon=z.createImageElement("spr_icon_loading",{scale:.5}),this.addChild(this.loadingIcon),this._initLoadingIconTween()}_initLoadingIconTween(){Q.createRotateTween(this.loadingIcon,{z:360},{duration:1.5,loop:!0}).start()}}const tp=class tp extends ${constructor(){super("languagePopup"),this.items=[],this.addComponent("element",{type:Bs,anchor:new P(0,0,1,1),pivot:new M(.5,.5)}),this.create()}create(){this._createBackground(),this._createButtonClose(),this._createScrollView(),this._createLanguageList(),this._createLoadingPanel()}_createBackground(){this.fakeBackground=z.createEmptyImageElement({color:k.BLACK,useInput:!0,opacity:.6}),this.fakeBackground.element.anchor=new P(0,0,1,1),this.addChild(this.fakeBackground),this.background=z.createImageElement("spr_panel_settings",{width:820,height:850,x:-20,y:-35}),this.addChild(this.background);let e=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"Language",fontSize:65,minFontSize:60,maxFontSize:65,autoWidth:!1,autoFitWidth:!0,anchor:new P(.5,.93,.5,.93),pivot:new M(.5,.5),wrapLines:!1});e.element.key="language",this.background.addChild(e)}_createButtonClose(){this.buttonClose=z.createButtonElement("spr_button_close",{anchor:new P(1,1,1,1),scale:1,y:-15}),this.background.addChild(this.buttonClose),this.buttonClose.button.on("click",()=>{Se.play("sfx_button"),this.enabled=!1})}_createScrollView(){this.languageContainer=z.createGroupElement({width:680,height:635,y:-50,x:-10}),this.addChild(this.languageContainer),this._createViewPort(),this._createVerticalScrollBar(),this.languageContainer.addComponent("scrollview",{scrollMode:$l,bounceAmount:.1,friction:.05,useMouseWheel:!0,mouseWheelSensitivity:new M(1,1),viewportEntity:this.viewport,contentEntity:this.content,vertical:!0,verticalScrollbarEntity:this.scrollbarPanel,verticalScrollbarVisibility:tm}),this.scrollbarPanel.scrollbar._updateHandlePositionAndSize()}_createViewPort(){this.viewport=new $("viewport"),this.viewport.addComponent("element",{type:pt,anchor:new P(0,0,1,1),pivot:new M(.5,.5),color:new k(.2,.2,.2),margin:new P(0,0,0,0),padding:new P(0,0,0,0),mask:!0,opacity:1,rect:new P(0,0,1,1)}),this.languageContainer.addChild(this.viewport),this.content=new $("content"),this.content.addComponent("element",{type:Bs,anchor:new P(0,1,0,1),pivot:new M(0,1),height:650,useInput:!0}),this.content.addComponent("layoutgroup",{orientation:pe,padding:new P(25,0,0,25),alignment:new M(0,1),spacing:new M(20,20),wrap:!0}),this.viewport.addChild(this.content)}_createVerticalScrollBar(){this.handle=new $("handle"),this.handle.addComponent("element",{type:pt,color:ve.createColor(102,102,102,1),anchor:new P(0,1,1,1),pivot:new M(1,1),width:0,height:20,margin:new P(0,0,0,0),useInput:!0}),this.handle.addComponent("button",{active:!0,hoverTint:new k(.9,.9,.9),pressedTint:new k(.5,.5,.5),imageEntity:this.handle}),this.scrollbarPanel=new $("scrollbar"),this.scrollbarPanel.addComponent("element",{type:pt,anchor:new P(1,0,1,1),pivot:new M(1,1),width:7,margin:new P(0,0,0,0),rect:new P(0,0,1,1),color:ve.createColor(178,178,178,1)}),this.scrollbarPanel.addChild(this.handle),this.scrollbarPanel.addComponent("scrollbar",{orientation:Pe,value:0,handleSize:.5,handleEntity:this.handle}),this.languageContainer.addChild(this.scrollbarPanel)}async _createLanguageList(){let e=Ds.getAllLanguage();for(let t=0;t<e.length;t++){let s=e[t].displayName,i=z.createImageElement(e[t].flag,{scale:1.1,useInput:!0}),n=z.createImageElement("spr_flag_selected",{scale:1.1,useInput:!0});i.addChild(n),n.enabled=!1,i.stroke=n,Ds.getLanguageByName(e[t].name).code===Ds.currentLanguageCode&&(n.enabled=!0),i.addComponent("button",{active:!0,hoverTint:new k(.9,.9,.9),pressedTint:new k(.5,.5,.5),imageEntity:i}),this.content.addChild(i),this.items.push(i),i.button.on("click",async o=>{o.touch&&o.event.preventDefault(),this.loadingPanel.enabled=!0,Se.play("sfx_button");let l=Ds.getLanguageByName(e[t].name);await Ds.setLanguage(l),this.disableAllStroke(),i.stroke.enabled=!0,this.fire(tp.EVENT_LANGUAGE_CHANGED,s),this.loadingPanel.enabled=!1})}this._reCalculateLayout()}disableAllStroke(){for(let e=0;e<this.items.length;e++)this.items[e].stroke.enabled=!1}_reCalculateLayout(){let e=this.items;if(!e[0]||!e[0].element)return;let t=e[0],s=t.element.height,i=t.element.width,n=4,a=n*i+(n-1)*this.content.layoutgroup.spacing.x+this.content.layoutgroup.padding.x+this.content.layoutgroup.padding.z,o=Math.ceil(e.length/n)*s+(Math.ceil(e.length/n)-1)*this.content.layoutgroup.spacing.y+this.content.layoutgroup.padding.y+this.content.layoutgroup.padding.w;this.content.element.width=a,this.content.element.height=o,this.scrollbarPanel.scrollbar._updateHandlePositionAndSize()}_createLoadingPanel(){this.loadingPanel=new YC,this.loadingPanel.enabled=!1,this.addChild(this.loadingPanel)}};tp.EVENT_LANGUAGE_CHANGED="languageChanged";let Hf=tp;const sp=class sp extends Lt{constructor(){super(O.SETTING_IN_GAME_SCREEN_NAME),this.controlPivot=new M(1,.5),this.controlEntityName="control",this.buttonOnEntityName="buttonOn",this.buttonOffEntityName="buttonOff"}create(){this._createBackground(),this._createButtonClose(),this._initElement(),this._initLanguageDropDown(),this._initTween(),this._initPopupLanguage()}onActivated(){super.onActivated(),this.checkSetting(),this.playAnim(),this._selectCurrentLanguage()}onDeactivated(){super.onDeactivated(),this.languagePopup.enabled=!1}_createBackground(){this.fakeBackground=z.createEmptyImageElement({color:k.BLACK,useInput:!0,opacity:.5}),this.fakeBackground.element.anchor=new P(0,0,1,1),this.addChild(this.fakeBackground),this.background=z.createImageElement("spr_panel_settings",{scale:1.25}),this.addChild(this.background);let e=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"Setting",fontSize:65,color:k.WHITE,autoWidth:!1,autoFitWidth:!0,minFontSize:55,maxFontSize:65,wrapLines:!1,width:400,anchor:new P(.5,.85,.5,.2),pivot:new M(.5,.5),outlineThickness:.7,outlineColor:k.BLACK});e.element.key="setting",this.background.addChild(e)}_createButtonClose(){this.buttonClose=z.createButtonElement("spr_button_close",{anchor:new P(1,1,1,1)}),this.background.addChild(this.buttonClose),this.buttonClose.button.on("click",e=>{e.touch&&e.event.preventDefault(),Se.play("sfx_button"),this.fire(sp.EVENTS.BackToHome)})}_initElement(){this.elementGroup=z.createGroupElement({y:-100}),this.background.addChild(this.elementGroup),this.elementGroup.addComponent("layoutgroup",{orientation:Pe,alignment:new M(.5,0),spacing:new M(0,85)}),this.soundElement=this._createElement("Sound","sound"),this.elementGroup.addChild(this.soundElement),this.vibrateElement=this._createElement("Vibration","vibration"),this.elementGroup.addChild(this.vibrateElement)}_createElement(e,t){let s=z.createGroupElement({});s.name=t;let i=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{fontSize:50,width:240,autoWidth:!1,autoFitWidth:!0,minFontSize:45,maxFontSize:50,x:-150,wrapLines:!1});i.element.key=t,s.addChild(i);let n=z.createGroupElement({x:165});s.addChild(n);let a=z.createButtonElement("spr_frame_sound",{pivot:new M(.5,.5)});a.name=this.buttonOnEntityName,n.addChild(a);let o=z.createButtonElement("spr_frame_sound",{pivot:new M(.5,.5)});o.name=this.buttonOffEntityName,n.addChild(o);let l=z.createImageElement("spr_circle_sound",{pivot:new M(1,.5),y:1.3});l.name=this.controlEntityName,n.addChild(l);let c=Q.createTween({x:1},{x:0},{duration:.2,easing:Q.Easing.Circular.Out,onUpdate:h=>{l.element.pivot=new M(h.x-.05,.5),l.element.opacity=1}}),d=Q.createTween({x:0},{x:1},{duration:.2,easing:Q.Easing.Circular.Out,onUpdate:h=>{l.element.pivot=new M(h.x+.05,.5),l.element.opacity=.5}});return a.button.on("click",h=>{h.touch&&h.event.preventDefault(),Se.play("sfx_button"),d.stop(),d.start(),a.enabled=!1,o.enabled=!0,this.isEnable=!1,ni.set(t,this.isEnable)}),o.button.on("click",h=>{h.touch&&h.event.preventDefault(),Se.play("sfx_button"),c.stop(),c.start(),o.enabled=!1,a.enabled=!0,this.isEnable=!0,ni.set(t,this.isEnable)}),s}_initTween(){this.tween=Q.createScaleTween(this.background,new M(1.2,1.2),{duration:.12,loop:!1,yoyo:!0,repeat:1,easing:Yt.Quadratic.Out})}checkSetting(){this._checkSettingElement(this.soundElement,"sound"),this._checkSettingElement(this.vibrateElement,"vibration")}_checkSettingElement(e,t){let s=e.findByName(this.controlEntityName);if(s===void 0)return;ni.get(t)?(s.element.pivot=new M(-.05,.5),s.element.opacity=1):(s.element.pivot=new M(1.05,.5),s.element.opacity=.5);let n=e.findByName(this.buttonOnEntityName);if(n===void 0)return;let a=e.findByName(this.buttonOffEntityName);a!==void 0&&(n.enabled=ni.get(t),a.enabled=!ni.get(t))}playAnim(){this.tween.stop(),this.tween.start()}_onSwitchChanged(e,t){ni.set(e,t)}_initLanguageDropDown(){let e=z.createGroupElement({});this.elementGroup.addChild(e);let t=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{fontSize:50,width:240,autoWidth:!1,autoFitWidth:!0,minFontSize:45,maxFontSize:50,x:-150,wrapLines:!1});t.element.key="language",e.addChild(t);let s=z.createImageElement("spr_frame_rectangle",{width:130,height:90,x:165,useInput:!0});e.addChild(s),s.addComponent("button",{active:!0,hoverTint:new k(.9,.9,.9),pressedTint:new k(.5,.5,.5),imageEntity:s}),s.button.on("click",()=>{Se.play("sfx_button"),this.languagePopup.enabled=!0}),this.flag=z.createImageElement("spr_flag_vietnam",{width:95,height:60}),s.addChild(this.flag)}_selectCurrentLanguage(){let e=Ds.getFlagByCode(Ds.currentLanguageCode);this.flag.element.spriteAsset=K.find(e)}_initPopupLanguage(){this.languagePopup=new Hf,this.languagePopup.on(Hf.EVENT_LANGUAGE_CHANGED,()=>{this._selectCurrentLanguage()}),this.languagePopup.enabled=!1,this.addChild(this.languagePopup)}};sp.EVENTS={Open:"settingPanel:open",BackToHome:"settingPanel:backToHome"};let ll=sp;const gc=class gc extends Lt{constructor(){super(O.LOSE_SCREEN_CHALLENGE_NAME),this.totalCoin=0}create(){super.create(),this._createBackground(),this._createTitle(),this._createCollectedCoinElement(),this._createButtons(),this._checkIsRewardAdsAvailable(),this.resize()}resize(){super.resize()}onActivated(){super.onActivated()}_createBackground(){this.fakeBackground=z.createEmptyImageElement({color:k.BLACK,useInput:!0,opacity:1}),this.fakeBackground.element.opacity=.5,this.fakeBackground.element.anchor=new P(0,0,1,1),this.addChild(this.fakeBackground)}_createTitle(){let e=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"GAME OVER",size:90,color:k.WHITE,anchor:new P(.5,.6,.5,.6),autoWidth:!1,autoFitWidth:!0,minFontSize:75,maxFontSize:105,width:750,y:250,wrapLines:!1});e.element.key="game-over",this.addChild(e)}_createCollectedCoinElement(){this.collectText=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"COLLECTED",size:50,color:k.WHITE,anchor:new P(.5,.6,.5,.6),autoWidth:!1,autoFitWidth:!0,minFontSize:40,maxFontSize:60,width:500,y:100}),this.addChild(this.collectText),this.collectText.element.key="collected",this.rewardGroup=z.createLayoutGroupElement({anchor:new P(.5,.6,.5,.6),pivot:new M(.5,.5),type:pe,alignment:new M(.5,.5),spacing:new M(10,0)}),this.addChild(this.rewardGroup);let e=z.createImageElement("spr_icon_coin",{anchor:new P(.5,.5,.5,.5),pivot:new M(.5,.5),scale:1.2});this.rewardGroup.addChild(e),this.textCollectedCoin=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"100",fontSize:50,color:k.WHITE,anchor:new P(.5,.2,.5,.2),autoWidth:!0}),this.rewardGroup.addChild(this.textCollectedCoin)}_createButtons(){this.buttonGroup=z.createGroupElement({anchor:new P(.5,.4,.5,.4),y:-250}),this.addChild(this.buttonGroup),this._createAdsButton(),this._createReplayButton()}_createAdsButton(){this.adsButton=z.createButtonElement("spr_btn_white",{anchor:new P(.5,.5,.5,.5),scale:1.5,y:175}),this.buttonGroup.addChild(this.adsButton),this.adsButton.button.on("click",this._onAdsButtonClicked,this),this.adsText=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"+ 3",size:40,color:k.BLACK,anchor:new P(.5,.5,.5,.5),autoWidth:!1,autoFitWidth:!0,minFontSize:35,maxFontSize:45,width:200,wrapLines:!1}),this.adsButton.addChild(this.adsText),this.adsIcon=z.createImageElement("spr_icon_ads",{x:-90,y:0}),this.adsButton.addChild(this.adsIcon);let e=z.createImageElement("spr_heart",{x:90,scale:.85});this.adsButton.addChild(e)}_createReplayButton(){this.replayButton=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"Replay",color:k.WHITE,size:45,anchor:new P(.5,.5,.5,.5),autoWidth:!1,autoFitWidth:!0,minFontSize:40,maxFontSize:50,width:400,wrapLines:!1,useInput:!0}),this.replayButton.element.key="replay",this.replayButton.addComponent("button",{hoverTint:new k(.8,.8,.8)}),this.buttonGroup.addChild(this.replayButton),this.replayButton.element.on("click",()=>{Y.currency+=this.totalCoin,Se.play("sfx_button"),this.fire(gc.EVENT.Replay)})}_onAdsButtonClicked(){this._disableButtons(),this.adsButton.element.useInput=!1,Gt.log("reward_show",{name:"increase_life"}),Se.play("sfx_button"),Q.createCountTween({duration:.1,onComplete:()=>{Z.pause(),Wt.showRewardAds(()=>{Z.resume(),this._enableButtons(),this.fire(gc.EVENT.Continue),this._checkIsRewardAdsAvailable(),console.log("Reward Ads Success")})}}).start()}setCollectedCoin(e){this.totalCoin=e,this.textCollectedCoin.element.text=e.toString()}_checkIsRewardAdsAvailable(){this.checkRewardAdsIntervalID&&clearInterval(this.checkRewardAdsIntervalID),this._activeButtonAds(!1),this.checkRewardAdsIntervalID=setInterval(()=>{Wt.checkIsRewardAdsReady(e=>{e?(this._activeButtonAds(!0),clearInterval(this.checkRewardAdsIntervalID)):this._activeButtonAds(!1)})},1e3)}_activeButtonAds(e){this.adsButton.element.useInput=e;let t=e?1:.5;this.adsButton.element.opacity=t,this.adsText.element.opacity=t,this.adsIcon.element.opacity=t}_enableButtons(){this.adsButton.element.useInput=!0,this.replayButton.element.useInput=!0}_disableButtons(){this.adsButton.element.useInput=!1,this.replayButton.element.useInput=!1}};gc.EVENT={Continue:"continue",Replay:"replay"};let wa=gc;const _l=class _l extends ie{constructor(){super(),this.playTime=0,this.lastTime=0,this.isPlaying=!1,Z.app.on("update",this.update,this)}start(){this.isPlaying=!0,this.lastTime=Date.now(),this.playTime=0,this.fire(_l.Event.Start)}stop(){this.isPlaying=!1,this.playTime+=Date.now()-this.lastTime,this.fire(_l.Event.Stop)}update(){if(this.isPlaying){const e=Date.now();this.playTime+=e-this.lastTime,this.lastTime=e,this.fire(_l.Event.Update,this.playTime)}}};_l.Event={Start:"playTimeTracker:start",Stop:"playTimeTracker:stop",Update:"playTimeTracker:update"};let Wf=_l;const ip=class ip extends Lt{constructor(){super(O.PLAY_SCREEN_NAME),this._padScoreCount=5,this._curScore=0,this._highScore=0,this._curCoin=0,this._blinkTween=null,this._isBlinking=!1,this._initScoreText(),this._initHomeButton(),this._initCurrentGameLife(),this._initPlayTimeTracker(),this._initCurrency(),this.resize()}resize(){super.resize()}onActivated(){super.onActivated(),Y.currentMode===Ie.Type.Endless?(this._textHolder.enabled=!0,this._heartIcons.forEach(e=>e.enabled=!1),this._heartGrayIcons.forEach(e=>e.enabled=!1),this._coinFrame.enabled=!1):(Y.currentMode===Ie.Type.Challenge||Y.currentMode===Ie.Type.Tutorial)&&(this._coinFrame.enabled=!0,this._textHolder.enabled=!1,this._heartIcons.forEach(e=>e.enabled=!0),this._heartGrayIcons.forEach(e=>e.enabled=!0))}_initScoreText(){this._highScore=Y.highestScore,this._textHolder=z.createGroupElement({anchor:new P(0,1,0,1),pivot:new M(.5,.5),x:225,y:-70}),this.addChild(this._textHolder),this._curScoreText=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{fontSize:50,color:new k(.4,.4,.4),x:200}),this._textHolder.addChild(this._curScoreText),this._curScoreText.element.text=this._formatScore(this._curScore);let e=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"HI",fontSize:45,color:new k(.4,.4,.4),x:-150});this._textHolder.addChild(e),this._highScoreText=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{fontSize:50,color:new k(.4,.4,.4)}),this._textHolder.addChild(this._highScoreText),this._highScoreText.element.text=this._formatScore(this._highScore),this._curScore=0}_initHomeButton(){this.homeButton=z.createButtonElement("spr_icon_home",{color:ve.createColor(89,89,89),scale:.35,anchor:new P(0,1,0,1),y:-175,x:90,hoverTint:ve.createColor(70,70,70),pressedTint:ve.createColor(40,40,40)}),this.addChild(this.homeButton),this.homeButton.name="buttonHome",this.homeButton.button.on("click",e=>{e.touch&&e.event.preventDefault(),Se.play("sfx_button"),this.fire(ip.EVENT.BACK_TO_HOME)})}_initCurrentGameLife(){this._heartGrayIcons=[z.createImageElement("spr_heart_gray",{anchor:new P(0,1,0,1),x:75,y:-70}),z.createImageElement("spr_heart_gray",{anchor:new P(0,1,0,1),x:150,y:-70}),z.createImageElement("spr_heart_gray",{anchor:new P(0,1,0,1),x:225,y:-70})],this._heartGrayIcons.forEach(e=>this.addChild(e)),this._heartIcons=[z.createImageElement("spr_heart",{anchor:new P(0,1,0,1),x:75,y:-70}),z.createImageElement("spr_heart",{anchor:new P(0,1,0,1),x:150,y:-70}),z.createImageElement("spr_heart",{anchor:new P(0,1,0,1),x:225,y:-70})],this._heartIcons.forEach(e=>this.addChild(e))}_initPlayTimeTracker(){this._timeTrackerText=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"00:00",fontSize:50,color:new k(.4,.4,.4),anchor:new P(.5,1,.5,1),y:-150}),this.addChild(this._timeTrackerText),this.playTimeTracker=new Wf,this.playTimeTracker.on(Wf.Event.Update,e=>{let t=Math.floor(e/1e3/60),s=Math.floor(e/1e3%60);this._timeTrackerText.element.text=`${ve.padNumber(t,2)}:${ve.padNumber(s,2)}`});{this._timeTrackerText.element.enabled=!1;return}}_initCurrency(){this._coinFrame=z.createImageElement("spr_frame_rectangle",{anchor:new P(.5,1,.5,1),pivot:new M(.5,.5),y:-75,scale:.65}),this.addChild(this._coinFrame),this._coinIcon=z.createImageElement("spr_icon_coin",{anchor:new P(0,0,0,0),pivot:new M(0,0),x:25,y:10,scale:1.25}),this._coinFrame.addChild(this._coinIcon),this._coinText=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:this._curCoin.toString(),size:45,color:k.WHITE,autoWidth:!1,autoFitWidth:!0,minFontSize:40,maxFontSize:50,width:260,wrapLines:!1,anchor:new P(1,.5,1,.5),pivot:new M(1,.5),x:25}),this._coinFrame.addChild(this._coinText)}startPlayTimeTracker(){this.playTimeTracker.start()}stopPlayTimeTracker(){this.playTimeTracker.stop()}resetPlayTimeTracker(){this._timeTrackerText.element.text="00:00"}updateScore(e){this._isBlinking||(this._curScore=e,this._curScoreText.element.text=this._formatScore(this._curScore),e%100===0&&e>0&&this._blinkScore())}updateHighScore(){Ls.instance.updateReachScoreChallenge(this._curScore),!(this._curScore<=this._highScore||Y.currentMode!==Ie.Type.Endless)&&(this._highScore=this._curScore,Y.highestScore=this._highScore,Wt.saveHighScore(this._highScore),this._highScoreText.element.text=this._formatScore(this._highScore))}resetScore(){this._curScore=0,this._curScoreText.element.text=this._formatScore(this._curScore)}_blinkScore(){this._isBlinking=!0,this._blinkTween?this._blinkTween.stop():this._blinkTween=Q.createTween(this._curScoreText.element,{opacity:0},{duration:.2,yoyo:!0,repeatDelay:.1,repeat:3,onComplete:()=>{this._curScoreText.element.opacity=1,this._isBlinking=!1}}),this._blinkTween.start()}_formatScore(e){return e.toString().padStart(this._padScoreCount,"0")}setCurrentGameLife(e){this._heartIcons.forEach((t,s)=>{t.element.enabled=s<e})}setCoin(e){this._curCoin=e,this._coinText.element.text=this._curCoin.toString()}resetCoin(){this._curCoin=0,this._coinText.element.text=this._curCoin.toString()}get currentScore(){return this._curScore}};ip.EVENT={BACK_TO_HOME:"backToHome"};let hl=ip;const Pj="press-arrow-up-to-start",Mj="tap-to-start";class k_ extends Lt{constructor(){super(O.TUTORIAL_SCREEN_NAME),this.resize()}create(){super.create(),this._createTutorialText(),this._initTextTutorialScaleTween(),this.resize()}resize(){super.resize(),this._onResizeTutorialText()}_createTutorialText(){this.tutorialText=z.createTextElement(O.GAME_FONT_NOTOSANS_BLACK,{text:"HI",fontSize:50,color:new k(.4,.4,.4),anchor:new P(.5,.5,.5,.5),y:-400,autoWidth:!1,autoFitWidth:!0,width:500,wrapLines:!0,spacing:1.05,lineHeight:40}),ve.checkDevice()===O.DEVICE_DESKTOP_NAME?this.tutorialText.element.text=O.TEXT_TUTORIAL_PC_DEVICE:this.tutorialText.element.text=O.TEXT_TUTORIAL_MOBILE_DEVICE,this.addChild(this.tutorialText)}_onResizeTutorialText(){if(!this.tutorialText)return;ve.checkDevice()===O.DEVICE_DESKTOP_NAME?this.tutorialText.element.key=Pj:this.tutorialText.element.key=Mj;let e=Z.width/Z.height,t=125,s=new P(.5,.16,.5,.16);e>.65&&(s=new P(.5,.1,.5,.1)),Z.isLandscape&&(s=new P(.5,.05,.5,.05),e>=2&&(t=60,s=new P(.5,.01,.5,.01))),this.tutorialText.element.anchor=s,this.tutorialText.setLocalPosition(0,t,0)}_initTextTutorialScaleTween(){Q.createScaleTween(this.tutorialText,new M(1.15,1.15),{duration:.5,loop:!0,yoyo:!0,easing:Yt.Quadratic.InOut}).start()}}class Ij extends IC{constructor(){super(O.SCENE_PLAY),this.currentGameLife=0,this.achievementData=[{challengeCompleted:2,achievementId:"complete2Challenges"},{challengeCompleted:5,achievementId:"complete5Challenges"},{challengeCompleted:10,achievementId:"complete10Challenges"},{challengeCompleted:15,achievementId:"complete15Challenges"},{challengeCompleted:20,achievementId:"complete20Challenges"}]}create(){super.create(),this.transitionScene=Js.getScene(O.SCENE_TRANSITION),this.transitionScene||console.warn("Transition scene not found"),this._initTutorial(),this._initUI(),this._initGamePlay(),this._registerKeyEvents(),Vt.registerOnStateChangedCallback(this._onGameStageChanged.bind(this))}update(){super.update(),this.levelManager.update(al.dt),Ls.instance.update(al.dt)}resize(){super.resize(),oc.instance.resize()}_registerKeyEvents(){document.addEventListener("keydown",this._onKeydown.bind(this)),document.addEventListener("keyup",this._onKeyup.bind(this))}_onKeydown(e){this.player.controller.handleKeyDown(e),!(e.code!==O.ARROW_UP_KEY&&e.code!==O.SPACE_KEY)&&(this.transitionScene.isPlaying||Z.loadingScreen.enabled||this._tutorial.showingTutorial||e.code===O.SPACE_KEY&&Y.currentMode===Ie.Type.Tutorial||this._checkGameStart())}_onKeyup(e){this.player.controller.handleKeyUp(e)}_onGameStageChanged(e,t){e===zt.Paused&&t===zt.Playing&&this.levelManager.currentLevel.isStarted&&this._pauseCurrentLevel()}_initUI(){this.ui.addLayer(O.LAYER_TAP_ZONE,ol),this.ui.addLayer(O.UI_LAYER_MAIN,hl,bn,k_,vn,rl,ya,va,xa,_r,da,ll,wa),this.ui.addLayer(O.UI_LAYER_POPUP,Sa),this.ui.addLayer(O.UI_LAYER_ADS,O_),this.currencyScreen=this.ui.getScreen(da),this.homeScreen=this.ui.getScreen(bn),this.playScreen=this.ui.getScreen(hl),this.tutorialScreen=this.ui.getScreen(k_),this.loseScreen=this.ui.getScreen(ya),this.winScreen=this.ui.getScreen(va),this.challengeLevelSelectorScreen=this.ui.getScreen(xa),this.tapZoneScreen=this.ui.getScreen(ol),this.shopScreen=this.ui.getScreen(_r),this.dailyChallengeScreen=this.ui.getScreen(rl),this.pauseScreen=this.ui.getScreen(vn),this.settingPanel=this.ui.getScreen(ll),this.loseScreenChallenge=this.ui.getScreen(wa),this._showStartScreens(),this._registerUIEvents(),Wt.emitter.on("ads-start",()=>this.ui.setScreenActiveOfLayer(O.UI_LAYER_ADS,O_)),Wt.emitter.on("ads-complete",()=>this.ui.setScreenActiveOfLayer(O.UI_LAYER_ADS,O_,!1)),this._initLoadingPanel()}_registerUIEvents(){this._registerHomeScreenEvent(),this._registerLoseScreenEvent(),this._registerPlayScreenEvent(),this._registerWinScreenEvent(),this._registerChallengeLevelSelectorScreenEvent(),this._registerTapZoneScreenEvent(),this._registerShopScreenEvent(),this._registerDailyChallengeScreenEvent(),this._registerSettingPanelEvent(),this._registerLoseScreenChallengeEvent()}_registerTapZoneScreenEvent(){this.tapZoneScreen.on(ol.EVENT.TAP,this._onTapScreen.bind(this))}_registerHomeScreenEvent(){this.homeScreen.on(bn.EVENT.ChallengeButtonClicked,()=>{this.ui.disableAllScreens(),this.ui.setScreenActive(xa,!0),this.ui.setScreenActive(da,!1)}),this.homeScreen.on(bn.EVENT.ShopButtonClicked,()=>{this.ui.disableAllScreens(),this.ui.setScreenActive(_r,!0),this.ui.setScreenActive(da,!0)}),this.homeScreen.on(bn.EVENT.SettingButtonClicked,()=>{this.ui.setScreenActive(ll,!0)}),this.homeScreen.on(bn.EVENT.DailyChallengeButtonClicked,()=>{this.ui.disableAllScreens(),this.ui.setScreenActive(rl,!0),this.ui.setScreenActive(da,!1)})}_registerLoseScreenEvent(){this.loseScreen.on(ya.EVENT.RESTART,()=>this.transitionScene.playFadeIn(this._onRestartLevel.bind(this))),this.loseScreen.on(ya.EVENT.BACK_TO_HOME,()=>this.transitionScene.playFadeIn(this._onBackToHome.bind(this)))}_registerPlayScreenEvent(){this.playScreen.on(hl.EVENT.BACK_TO_HOME,()=>{this.player.controller.isDead||(this.player.isImmortal=!0,this.transitionScene.playFadeIn(()=>{this._stop(),this._onBackToHome()}))},this)}_registerWinScreenEvent(){this.winScreen.on(va.EVENT.NEXT,()=>{Y.currentMode===Ie.Type.Tutorial?this.transitionScene.playFadeIn(this._onBackToHome.bind(this)):this.transitionScene.playFadeIn(this._onNextLevel.bind(this))}),this.winScreen.on(va.EVENT.BACK_TO_HOME,()=>this.transitionScene.playFadeIn(this._onBackToHome.bind(this)))}_registerChallengeLevelSelectorScreenEvent(){this.challengeLevelSelectorScreen.on(xa.EVENT.ITEM_SELECTED,e=>{this.transitionScene.playFadeIn(()=>{this.levelManager.loadChallengeLevel(e),Y.currentChallengeLevel=e,this.playScreen.resetCoin(),this._showPlayScreen(),this._showTutorialScreen()})}),this.challengeLevelSelectorScreen.on(xa.EVENT.BACK,()=>{this._delayCheckTutorial(.5),this._showStartScreens()})}_registerShopScreenEvent(){this.shopScreen.on(_r.EVENT.BACK_BUTTON_CLICKED,()=>{this._delayCheckTutorial(.5),this._showStartScreens()}),this.shopScreen.on(_r.EVENT.CHANGE_ITEM_SKIN,e=>{this.loadingPanel.enabled=!0,this.player.loadSkin(e)}),this.shopScreen.on(_r.EVENT.UNLOCK_ITEM_SKIN,()=>{this.currencyScreen.updateCurrency()})}_registerDailyChallengeScreenEvent(){this.dailyChallengeScreen.on(rl.Event.Back,()=>{this._delayCheckTutorial(.5),this._showStartScreens()})}_registerSettingPanelEvent(){this.settingPanel.on(ll.EVENTS.BackToHome,()=>{this._delayCheckTutorial(.5),this._showStartScreens()})}_registerLoseScreenChallengeEvent(){this.loseScreenChallenge.on(wa.EVENT.Continue,()=>{this.currentGameLife=O.TOTAL_GAME_LIFE_PER_BY_ADS,this.playScreen.setCurrentGameLife(this.currentGameLife),this.player.onRevive(),this._showPlayScreen(),this.pauseScreen.changeToContinueTutorialText(),this.ui.setScreenActive(vn,!0),Vt.state=zt.Paused}),this.loseScreenChallenge.on(wa.EVENT.Replay,()=>{this.transitionScene.playFadeIn(this._onRestartLevel.bind(this)),Vt.state=zt.Paused})}_initLoadingPanel(){this.loadingPanel=new YC,this.loadingPanel.enabled=!1,this.addChild(this.loadingPanel)}_onTapScreen(){if(!(this.player.controller.isDead||this.player.controller.isRunning||this._tutorial.showingTutorial)){if(this.levelManager.currentLevel.isStarted){this._resumeCurrentLevel();return}this.player.jump(),this.onStart()}}_onBackToHome(){Y.isTutorialCompleted?this.levelManager.loadEndlessLevel():this.levelManager.loadTutorialLevel(),this._showStartScreens(),this._delayCheckTutorial(.5),this.currencyScreen.updateCurrency()}_onRestartLevel(){this.playScreen.resetScore(),Y.currentMode===Ie.Type.Endless?this.levelManager.loadEndlessLevel():(this.currentGameLife=O.TOTAL_GAME_LIFE_PER_BY_ADS,this.playScreen.setCurrentGameLife(this.currentGameLife),Y.currentMode===Ie.Type.Challenge?(this.playScreen.resetCoin(),this.levelManager.loadChallengeLevel()):Y.currentMode===Ie.Type.Tutorial&&this.levelManager.loadTutorialLevel()),this._showPlayScreen(),this._showTutorialScreen(),this.currencyScreen.updateCurrency()}_onNextLevel(){this.levelManager.loadChallengeLevel(),this.playScreen.resetCoin(),this._showPlayScreen(),this._showTutorialScreen(),this.currencyScreen.updateCurrency()}_initGamePlay(){this._initInputHandler(),this._initLight(),this._initCamera(),this._initPlayer(),this._initLevelManager(),this._initGround()}_initTutorial(){this._tutorial=new ds(this.ui)}_initInputHandler(){let e=new $;e.addScript(An),this.addChild(e)}_initLight(){const e=new $;e.addComponent("light",{type:"directional",intensity:.8,color:new k(1,1,1),castShadows:!1}),e.setLocalEulerAngles(90,0,0),this.addChild(e)}_initCamera(){this.addChild(oc.instance),this.mainCamera=oc.instance}_initLevelManager(){this.levelManager=new ac,this.addChild(this.levelManager),this.player.levelManager=this.levelManager,this.levelManager.on(ac.Event.LevelLoaded,this._onLevelLoaded.bind(this)),this.levelManager.on(ac.Event.LevelUpdateScore,this._updateScore.bind(this)),Y.isTutorialCompleted?this.levelManager.loadEndlessLevel():this.levelManager.loadTutorialLevel()}_onLevelLoaded(){this.currentGameLife=O.DEFAULT_GAME_LIFE_EACH_LEVEL,this.playScreen.setCurrentGameLife(this.currentGameLife),this.player.reset(),this.tapZoneScreen.enableTapZone(),this.playScreen.resetPlayTimeTracker(),this.transitionScene.playFadeOut(),Y.currentMode===Ie.Type.Challenge&&this._tutorial.checkTutorial()}_updateScore(e){this.playScreen.updateScore(e)}_initGround(){let e=z.createSprite("spr_white");e.name=O.GROUND_NAME,e.sprite.color=new k(.2,0,0),e.sprite.opacity=.01,e.setLocalScale(.005,2e-4,.001),e.setLocalPosition(0,-.368,0),this.addChild(e),e.addComponent("collision",{type:"box",halfExtents:new y(1,.08,.5)}),e.addComponent("rigidbody",{type:"kinematic",friction:0,restitution:0,group:O.MASK_GROUND})}_checkGameStart(){if(!(this.player.controller.isDead||this.player.controller.isRunning||this.player.controller.isFinished)){if(this.levelManager.currentLevel.isStarted){this._resumeCurrentLevel();return}this.player.jump(),this.onStart()}}_showInterstitialAds(e=null){Gt.log("inter_show",{}),Z.pause(),Wt.showInterstitialAds(()=>{Z.resume(),e==null||e()})}onStart(){Y.currentMode===Ie.Type.Challenge?Gt.log("challenge_start",{level_index:Y.currentChallengeLevel,character_skin:Y.currentSkin}):Y.currentMode===Ie.Type.Endless&&Gt.log("endless_start",{character_skin:Y.currentSkin}),this._showPlayScreen(),this.player.run(),this._registerPlayerTouchEvent(),this.playScreen.startPlayTimeTracker(),this.levelManager.currentLevel.start(),Vt.state=zt.Playing}_registerPlayerTouchEvent(){const e=Y.currentMode===Ie.Type.Tutorial,t=ve.checkDevice()===O.DEVICE_MOBILE_NAME;(!e||t)&&this.player.controller.registerTouchEvent()}_initPlayer(){this.player=new Ye,this.addChild(this.player),this.player.on(Ye.Event.SkinLoaded,()=>{Z.loadingScreen.enabled&&(Z.loadingScreen.setFullProgress(),this._delayCheckTutorial(1)),this.loadingPanel.enabled=!1},this),this.player.on(Ye.Event.Dead,this._onPlayerDead.bind(this)),this.player.on(Ye.Event.ReachFinishPoint,this._onPlayerReachFinishPoint.bind(this)),this.player.on(Ye.Event.CoinCollected,()=>{this.levelManager.currentLevel.coinCollected+=O.QUANTITY_PER_SINGLE_COIN,this.playScreen.setCoin(this.levelManager.currentLevel.coinCollected)}),this.player.on(Ye.Event.ReachCheckPoint,()=>{if(this.currentGameLife>1){this.ui.setScreenActive(vn,!1),Q.createCountTween({duration:.4,onComplete:()=>{this.transitionScene.playFadeIn(()=>{this.transitionScene.playFadeOut(),this.ui.setScreenActive(vn,!0),this.currentGameLife--,this.playScreen.setCurrentGameLife(this.currentGameLife),this.player.onRevive()})}}).start();return}Ls.instance.updateReachLevelChallenge(1),this.playScreen.setCurrentGameLife(0),this.ui.disableAllScreens(),Gt.log("challenge_failed",{level_index:Y.currentChallengeLevel}),Q.createCountTween({duration:O.DELAY_TIME_BEFORE_SHOW_INTERSTITIAL_ADS,onComplete:()=>{this._showInterstitialAds(()=>{this._showLoseScreenChallenge()})}}).start()}),this.player.on(Ye.Event.CollideJumpTutorial,()=>{this.player.forceRequireJump=!0,this._stopMoveMap(),this.pauseScreen.changeToJumpTutorialText()}),this.player.on(Ye.Event.CollideBendDownTutorial,()=>{this.player.forceRequireBendDown=!0,this._stopMoveMap(),this.pauseScreen.changeToCrouchTutorialText()}),this.player.on(Ye.Event.JumpStarted,()=>{this._resumeMoveMap()}),this.player.on(Ye.Event.BendDownStarted,()=>{this._resumeMoveMap()})}_onPlayerReachFinishPoint(){this._stop(),Ls.instance.updateReachLevelChallenge(1),Vt.state=zt.Win,Gt.log("level_completed",{level_index:Y.currentChallengeLevel}),this._showWinScreen(),this._saveAchievement()}_saveAchievement(){let e=Y.highestChallengeLevel;this.achievementData.forEach(t=>{if(t.challengeCompleted===e-1){let s=window.LAGGED_SDK_CONFIG;Wt.saveAchievement(s.API_AWARDS[t.achievementId])}})}_onPlayerDead(){let e=this._checkIsEndlessMode();if(Se.play("sfx_collision"),this.playScreen.updateHighScore(),this._stop(),Ls.instance.updateReachLevelChallenge(1),Y.currentMode===Ie.Type.Endless){let t=this.playScreen.playTimeTracker.playTime;Gt.log("endless_ended",{playTime:t/1e3,score:this.playScreen.currentScore,highestScore:Y.highestScore})}Q.createCountTween({duration:O.DELAY_TIME_BEFORE_SHOW_INTERSTITIAL_ADS,onComplete:()=>{this._showInterstitialAds(()=>{if(e){this._showLoseScreen();return}})}}).start()}_showLoseScreen(){Vt.state=zt.Lose;let e=this.playScreen.currentScore;this.loseScreen.setCollectedCoin(e),this.ui.disableAllScreens(),this.ui.setScreenActive(ya),Se.play("sfx_lose")}_showPlayScreen(){this.ui.disableAllScreens(),this.ui.setScreenActive(hl,!0),this._showTapZoneScreen(),this.ui.setScreenActive(da,!1)}_showWinScreen(){Q.createCountTween({duration:O.DELAY_TIME_BEFORE_SHOW_INTERSTITIAL_ADS,onComplete:()=>{this._showInterstitialAds(()=>{let e=this.levelManager.currentLevel.data.coinReward+this.levelManager.currentLevel.coinCollected;Ls.instance.updateCollectChallenge(this.levelManager.currentLevel.coinCollected/O.QUANTITY_PER_SINGLE_COIN),this.winScreen.setCollectedCoin(e),this.ui.disableAllScreens(),this.ui.setScreenActive(va),Se.play("sfx_win")})}}).start()}_showHomeScreen(){if(this.ui.disableAllScreens(),this.ui.setScreenActive(bn),Y.isTutorialCompleted?(this.homeScreen.setEnableLeftButtons(),this.ui.setScreenActive(da,!0)):this.homeScreen.setEnableLeftButtons(!1),this.shopScreen.checkEnableHintEnoughCoin()){this.homeScreen.setActiveHintEnoughCoin(!0);return}this.homeScreen.setActiveHintEnoughCoin(!1)}_delayCheckTutorial(e=0){Q.createCountTween({duration:e,onComplete:()=>{this.homeScreen.enabled&&!this.settingPanel.enabled&&!this.shopScreen.enabled&&this._tutorial.checkTutorial()}}).start()}_showTutorialScreen(){this.ui.setScreenActive(k_)}_showTapZoneScreen(){this.ui.setScreenActive(ol)}_showStartScreens(){this._showHomeScreen(),this._showTutorialScreen(),this._showTapZoneScreen()}_stopMoveMap(){this.player.forceStopAnimation(),this.levelManager.currentLevel.setPause(!0),this.ui.setScreenActive(vn,!0)}_resumeMoveMap(){this.levelManager.currentLevel.setPause(!1),this.ui.setScreenActive(vn,!1)}_stop(){this.levelManager.stopCurrentLevel(),this.tapZoneScreen.disableTapZone(),this.playScreen.stopPlayTimeTracker()}_pauseCurrentLevel(){this.player.forceRequireBendDown||this.player.forceRequireJump||(this.player.pause(),this.levelManager.currentLevel.setPause(!0),this.ui.setScreenActive(vn,!0),this.pauseScreen.changeToContinueTutorialText())}_resumeCurrentLevel(){this.player.forceRequireBendDown||this.player.forceRequireJump||(Vt.state=zt.Playing,this.player.resume(),this.levelManager.currentLevel.setPause(!1),this.ui.setScreenActive(vn,!1))}_showLoseScreenChallenge(){Vt.state=zt.Lose;let e=this.levelManager.currentLevel.coinCollected;this.loseScreenChallenge.setCollectedCoin(e),this.ui.disableAllScreens(),this.ui.setScreenActive(wa,!0),Se.play("sfx_lose")}_checkIsEndlessMode(){return Y.currentMode===Ie.Type.Endless}}const gl=class gl extends ${constructor(e){super(),this.timeLoading=0,this.timeLoading=Date.now(),this.layer=new mr({name:"LoadingLayer"}),e.scene.layers.insert(this.layer,0),Promise.all([K.loadResource("spr_game_logo","texture"),K.loadResource("spr_game_name","texture"),K.loadResource("spr_main_progress_loading","texture"),K.loadResource(O.GAME_FONT_NOTOSANS_BLACK,"font"),K.loadResource("spr_logo_lagged","texture")]).then(()=>{this.fire(gl.EVENT_RESOURCE_LOADED),this.addComponent("camera",{clearColor:new k(.1,.1,.1),layers:[this.layer.id],priority:100}),this.addComponent("screen",{screenSpace:!0,scaleMode:Id,resolution:new M(O.GAME_WIDTH,O.GAME_HEIGHT),referenceResolution:new M(O.GAME_WIDTH,O.GAME_HEIGHT)}),this._createBackground(),this._createLogo(),this._createGameName(),this._createLoadingIcon(),this._createLogoLagged(),this.resize(),this.updateProgress(.9),this.fire(gl.EVENT_LOADED)})}_createBackground(){this.background=new $("background"),this.background.addComponent("element",{type:pt,anchor:new P(.5,.5,.5,.5),pivot:new M(.5,.5),width:O.GAME_WIDTH,height:O.GAME_HEIGHT,layers:[this.layer.id],useInput:!0}),this.addChild(this.background)}resize(){var e;if(this.screen){Z.app.resizeCanvas(window.innerWidth,window.innerHeight);let t=this.screen.resolution,s=t.x/this.screen.scale,i=t.y/this.screen.scale,n=1/Math.min(s/O.GAME_WIDTH,i/O.GAME_HEIGHT);(e=this.background)==null||e.setLocalScale(n,n,1),this._onResizeGameLogo(),this._onResizeLogoLagged(),this._onResizeGameName(),this._onResizeLoadingIcon()}}_createLogo(){this.logo=new $("spr_game_logo");let e=K.find("spr_game_logo");this.logo.addComponent("element",{type:pt,anchor:new P(.5,.5,.5,.5),pivot:new M(.5,.5),width:e.resource.width,height:e.resource.height,textureAsset:e,color:new k(1,1,1,1),layers:[this.layer.id]}),this.logo.setLocalScale(1.3,1.3,1.3),this.addChild(this.logo),this._onResizeGameLogo()}_onResizeGameLogo(){if(!this.logo)return;let e=new y(0,150,0),t=1.6;window.innerWidth>window.innerHeight&&(e=new y(0,80,0),t=1.3),this.logo.setLocalPosition(e.x,e.y,e.z),this.logo.setLocalScale(t,t,t)}_createGameName(){this.gameName=new $("spr_game_name");let e=K.find("spr_game_name");this.gameName.addComponent("element",{type:pt,anchor:new P(.5,.5,.5,.5),pivot:new M(.5,.5),width:e.resource.width,height:e.resource.height,textureAsset:e,color:new k(1,1,1,1),layers:[this.layer.id]}),this.gameName.setLocalScale(1.3,1.3,1.3),this.addChild(this.gameName)}_onResizeGameName(){if(!this.gameName)return;let e=1.3,t=new y(0,-120,0);window.innerWidth>window.innerHeight&&(t=new y(0,-150,0),e=1.3),this.gameName.setLocalScale(e,e,e),this.gameName.setLocalPosition(t.x,t.y,t.z)}_createLogoLagged(){this.logoLagged=new $;let e=K.find("spr_logo_lagged");this.logoLagged.addComponent("element",{type:pt,anchor:new P(.5,.9,.5,.9),pivot:new M(.5,.5),width:e.resource.width,height:e.resource.height,textureAsset:e,color:new k(1,1,1,1),layers:[this.layer.id]}),this.addChild(this.logoLagged),this.logoLagged.setLocalScale(.8,.8,.8)}_onResizeLogoLagged(){if(!this.logoLagged)return;let e=.8,t=new P(.5,.93,.5,.93);window.innerWidth>window.innerHeight&&(e=.6,t=new P(.5,.9,.5,.9)),this.logoLagged.setLocalScale(e,e,e),this.logoLagged.element.anchor=t}_createLoadingIcon(){this.slide=new $("progressBar"),this.slide.addComponent("element",{type:pt,textureAsset:K.find("spr_main_progress_loading"),anchor:new P(.5,.25,.5,.25),pivot:new M(.5,.5),width:700,height:60,color:ve.createColor(83,83,83),layers:[this.layer.id]}),this.addChild(this.slide),this.mask=new $("mask"),this.slide.addChild(this.mask),this.mask.addComponent("element",{type:pt,anchor:new P(0,.5,0,.5),pivot:new M(0,.5),mask:!1,width:700,height:60,opacity:1}),this.fill=new $("mainProgressBar"),this.fill.addComponent("element",{type:pt,textureAsset:K.find("spr_main_progress_loading"),anchor:new P(.007,.5,.007,.5),color:new k(1,1,1,1),pivot:new M(0,.5),width:0,height:50,layers:[this.layer.id]}),this.mask.addChild(this.fill)}_onResizeLoadingIcon(){if(!this.slide)return;let e=new P(.5,.25,.5,.25);window.innerWidth>window.innerHeight&&(e=new P(.5,.15,.5,.15)),this.slide.element.anchor=e}updateProgress(e){this.fill&&Q.createTween(this.fill.element,{width:e*692},{duration:1.5}).start()}setFullProgress(){this.fill&&Q.createTween(this.fill.element,{width:692},{duration:.3,onComplete:()=>{this.hide()}}).start()}show(){this.enabled=!0}hide(){this.enabled&&(this.timeLoading=Date.now()-this.timeLoading,this.timeLoading=Math.floor(this.timeLoading/1e3),Gt.log("loading_duration",{duration:this.timeLoading}),Y.firstOpen||(Y.firstOpen=!0,Gt.log("first_open",{name:Te.name,mobile:Te.mobile,desktop:Te.desktop,browserName:Te.browserName}))),this.enabled=!1}};gl.EVENT_LOADED="loaded",gl.EVENT_RESOURCE_LOADED="resourceLoaded";let lc=gl;class Rj extends IC{constructor(){super(O.SCENE_TRANSITION),this.isPlaying=!1}create(){super.create(),this._initScreen(),this._initFakeBg()}_initScreen(){this.transitionScreen=new $("transitionScreen"),this.transitionScreen.addComponent("screen",{screenSpace:!0,scaleMode:Id,resolution:new M(O.GAME_WIDTH,O.GAME_HEIGHT),referenceResolution:new M(O.GAME_WIDTH,O.GAME_HEIGHT),priority:100}),this.addChild(this.transitionScreen)}_initFakeBg(){this.fakeBackground=z.createEmptyImageElement({color:k.BLACK,useInput:!1,opacity:1}),this.fakeBackground.element.opacity=.01,this.fakeBackground.enabled=!1,this.fakeBackground.element.anchor=new P(0,0,1,1),this.transitionScreen.addChild(this.fakeBackground),this.playFadeOut()}playFadeIn(e){this.isPlaying=!0,this.fakeBackground.element.opacity=.01,this.fakeBackground.element.useInput=!0,this.fakeBackground.enabled=!0,Q.createTween(this.fakeBackground.element,{opacity:1},{duration:.5,easing:Q.Easing.Quadratic.Out,onComplete:()=>{e()}}).start()}playFadeOut(){this.isPlaying&&Q.createTween(this.fakeBackground.element,{opacity:.01},{duration:.55,easing:Q.Easing.Quadratic.In,onComplete:()=>{this.fakeBackground.element.useInput=!1,this.fakeBackground.element.opacity=.01,this.fakeBackground.enabled=!1,this.isPlaying=!1}}).start()}}const Ui=class Ui{static async load(){this.canvas=document.createElement("canvas"),this.canvas.id="application-canvas",this.canvas.style.zIndex="0",this.canvas.style.margin="0",this.canvas.style.padding="0",this.canvas.style.backgroundColor="black",document.body.appendChild(this.canvas),this.canvas.addEventListener("mouseleave",this.onMouseMoveOutOfCanvas.bind(this)),this.canvas.addEventListener("mouseout",this.onMouseMoveOutOfCanvas.bind(this));const e=window.location.href,t={deviceTypes:["webgl2","webgl"],glslangUrl:`${e}assets/scripts/glslang.js`,antialias:!1},s=await ZP(this.canvas,t);this.app=new lV(this.canvas,{elementInput:new El(this.canvas),keyboard:new Fy(window),graphicsDevice:s}),Te.touch?this.app.touch=new sI(this.canvas):this.app.mouse=new Nr(this.canvas),this.app.graphicsDevice.maxPixelRatio=window.devicePixelRatio,this.app.setCanvasFillMode(yk),this.app.setCanvasResolution(pg),Q.init(this.app),ni.loadSetting(),Vt.init(zt.Tutorial),Gt.init(),al.init(this.app),await K.init(this.app),this._initLoadingScreen(),K.loadScript("Ammo",K.assetData.scripts.Ammo).then(()=>{this.app.systems.rigidbody.fixedTimeStep=1/180,this.app.systems.rigidbody.maxSubSteps=10,this.app.start()}),this.timeSession=Date.now(),Gt.log("game_open")}static _initLoadingScreen(){this.loadingScreen=new lc(this.app),this.app.root.addChild(this.loadingScreen),this.loadingScreen.on(lc.EVENT_RESOURCE_LOADED,()=>{Ds.init(this.app),KC.init(this.app),mw.configLocalize()}),this.loadingScreen.on(lc.EVENT_LOADED,()=>{Promise.all([Wt.init(),K.load()]).then(()=>{Y.init(),this.onAssetLoaded()})})}static onAssetLoaded(){this.create()}static create(){mw.config(),this.width=window.innerWidth,this.height=window.innerHeight,this.app.resizeCanvas(this.width,this.height),Js.init([new Ij,new Rj]);const e=Js.getScene(O.SCENE_PLAY);e&&Js.loadScene(e);const t=Js.getScene(O.SCENE_TRANSITION);t&&Js.loadSceneAddtive(t),this.canvas.focus(),this.app.on("update",this.update,this),window.addEventListener("unload",()=>{Ui.timeSession=Date.now()-Ui.timeSession,Ui.timeSession=Math.floor(Ui.timeSession/1e3),Gt.log("game_session_duration",{duration:Ui.timeSession})}),window.addEventListener("focus",()=>this.setPause(!1)),window.addEventListener("blur",()=>this.setPause(!0)),this.gameCreated=!0,this.app.fire("gameReady")}static setPause(e){this.gameCreated&&(e?this.pause():this.resume())}static update(e){this.gameCreated&&(al.update(e),Js.update())}static pause(){this.isPaused||(this.isPaused=!0,Vt.state=zt.Paused,al.scale=0,Se.muteAll(!0),Js.pause(),this.app.timeScale=0,this.app.fire("pause"),window.blur())}static resume(){this.isPaused&&(this.isPaused=!1,Vt.prevState!==zt.Paused&&(Vt.state=Vt.prevState),al.scale=1,Se.muteAll(!1),Js.resume(),this.app.timeScale=1,this.app.fire("resume"),this.canvas.focus(),window.focus())}static resize(e){this.gameCreated?(console.assert(e.width&&e.height,"Screen size must have width and height greater than 0"),this.width=e.width,this.height=e.height,this.app.graphicsDevice.maxPixelRatio=window.devicePixelRatio,this.app.resizeCanvas(this.width,this.height),Js.resize(),this.app.fire("resize")):console.warn("Resize function called before game creation",e)}static onWin(){}static onLose(){}static get isPortrait(){return this.width<this.height}static get isLandscape(){return this.width>this.height}static onMouseMoveOutOfCanvas(e){this.gameCreated&&this.app.fire(O.MOUSE_MOVE_OUT_OF_CANVAS_EVENT,e)}};Ui.resumable=!0,Ui.isPaused=!1,Ui.timeSession=0;let Z=Ui;document.addEventListener("visibilitychange",()=>{Z.setPause(document.hidden)});window.addEventListener("touchstart",()=>Z.setPause(!1));window.addEventListener("mousedown",()=>Z.setPause(!1));window.addEventListener("focus",()=>Z.setPause(!1));window.addEventListener("blur",()=>Z.setPause(!0));window.addEventListener("resize",()=>{var r;Z.resize({width:window.innerWidth,height:window.innerHeight}),(r=Z.loadingScreen)==null||r.resize()});window.focus();$.prototype.addScript=function(r,e={}){var i;if(this.script||this.addComponent("script"),!r)throw new Error("Script must be defined");let t=null,s=r.scriptName;if(!s)throw new Error("Script must have a name, please override the static property 'scriptName'");if(r.__name=s,!Z.app.scripts.has(s)){let n={},a=new r({app:Z.app,entity:this});Object.keys(a).filter(l=>l!=="app"&&l!=="entity"&&!l.startsWith("_")).forEach(l=>{n[l]={type:typeof a[l],default:a[l]}}),a=void 0,Object.keys(n).forEach(l=>{r.attributes.add(l,n[l])}),qT(r)}if(e.attributes||(e.attributes={}),t=(i=this.script)==null?void 0:i.create(s,e),!t)throw new Error("Script instance could not be created");return t.onEnable&&t.on("enable",t.onEnable,t),t.onDisable&&t.on("disable",t.onDisable,t),t.onDestroy&&t.once("destroy",t.onDestroy,t),t.enable||(t.enable=()=>t.enabled=!0),t.disable||(t.disable=()=>t.enabled=!1),t};$.prototype.getScript=function(r){if(!this.script)return null;let e=r.scriptName;if(!e)throw new Error("Script must have a name, please override the static property 'scriptName'");return this.script[e]};let Lj=qr.prototype.add;qr.prototype.add=function(r,e){e||(e={type:"string"}),e.type||(e.type="string"),e.default||(e.default=""),Lj.call(this,r,e)};function lt(r,e=!0,t=!0){const s={};return s[`${r}Map`]="texture",s[`${r}MapTiling`]="vec2",s[`${r}MapOffset`]="vec2",s[`${r}MapRotation`]="number",s[`${r}MapUv`]="number",e&&(s[`${r}MapChannel`]="string",t&&(s[`${r}VertexColor`]="boolean",s[`${r}VertexColorChannel`]="string")),s}const jw={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean",...lt("ao"),...lt("aoDetail",!0,!1),aoDetailMode:"string",diffuse:"rgb",diffuseTint:"boolean",...lt("diffuse"),...lt("diffuseDetail",!0,!1),diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",...lt("specular"),occludeSpecular:"enum:occludeSpecular",specularityFactor:"number",specularityFactorTint:"boolean",...lt("specularityFactor"),useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean",...lt("metalness"),useMetalnessSpecularColor:"boolean",conserveEnergy:"boolean",shininess:"number",gloss:"number",glossInvert:"boolean",...lt("gloss"),clearCoat:"number",...lt("clearCoat"),clearCoatGloss:"number",clearCoatGlossInvert:"boolean",...lt("clearCoatGloss"),clearCoatBumpiness:"number",...lt("clearCoatNormal",!1),useSheen:"boolean",sheen:"rgb",sheenTint:"boolean",...lt("sheen"),sheenGloss:"number",sheenGlossTint:"boolean",sheenGlossInvert:"boolean",...lt("sheenGloss"),fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean",...lt("emissive"),emissiveIntensity:"number",...lt("normal",!1),bumpiness:"number",...lt("normalDetail",!1),normalDetailMapBumpiness:"number",...lt("height",!0,!1),heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number",...lt("opacity"),opacityFadesSpecular:"boolean",reflectivity:"number",refraction:"number",refractionTint:"boolean",...lt("refraction"),refractionIndex:"number",thickness:"number",thicknessTint:"boolean",...lt("thickness"),attenuation:"rgb",attenuationDistance:"number",useDynamicRefraction:"boolean",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",useIridescence:"boolean",iridescence:"number",iridescenceTint:"boolean",...lt("iridescence"),iridescenceThicknessTint:"boolean",iridescenceThicknessMin:"number",iridescenceThicknessMax:"number",iridescenceRefractionIndex:"number",...lt("iridescenceThickness"),...lt("light"),depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",envAtlas:"texture",twoSidedLighting:"boolean"},ZC=[];for(const r in jw)jw[r]==="texture"&&ZC.push(r);Xn.prototype._loadModel=function(r,e){const t=r.getFileUrl(),s=me.getExtension(t);if(s===".json"||s===".glb"){const i=me.getDirectory(t),n=me.getBasename(t),a=me.join(i,n.replace(s,".mapping.json"));this._loader.load(a,"json",(o,l)=>{l||(l={mapping:[]}),o?(r.data={mapping:[]},e(r)):this._loadMaterials(r,l,(c,d)=>{r.data=l,r.once("load",()=>{for(let u=0;u<l.mapping.length;u++)if(l.mapping[u].path){var h=d.find(f=>f.file.url===l.mapping[u].path);h&&(r.resource.meshInstances[u].material=h.resource)}}),e(r)})})}else e(r)};Xn.prototype._loadMaterials=function(r,e,t){const s=[];let i=e.mapping.filter(a=>a.path).length;if(i===0){t(null,s);return}const n=(a,o)=>{this._loadTextures(o,(l,c)=>{s.push(o),s.length===i&&t(l,s)})};for(let a=0;a<e.mapping.length;a++){const o=e.mapping[a].path;if(o){const l=o;this.loadFromUrl(l,"material",n)}}};Xn.prototype._loadTextures=function(r,e){const t=r.data,s=[],i=ZC;let n=i.filter(o=>t[o]&&typeof t[o]=="string").length;if(t.mappingFormat!=="path"){e(null,s);return}const a=(o,l)=>{s.push(l),s.length===n&&e(o,s)};for(let o=0;o<i.length;o++){const l=t[i[o]];if(l&&typeof l=="string"){const c=l;this.loadFromUrl(c,"texture",(d,h)=>{a(d,h),r.resource[i[o]]=h.resource})}}n===0&&e(null,s)};const Dj=l0.prototype._updateText;l0.prototype._updateText=function(r){r===void 0&&(r=this._text),this._entity.element.localizeParams&&Object.keys(this._entity.element.localizeParams).forEach(t=>{r.includes(`{${t}}`)&&(r=r.replace(`{${t}}`,this._entity.element.localizeParams[t]))}),this._entity.element.isUpperCase&&(r=r.toUpperCase()),Dj.bind(this,r)()};window.addEventListener("contextmenu",r=>r.preventDefault());window.onload=()=>{Z.load()};
