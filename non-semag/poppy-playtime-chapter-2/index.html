<html>
<head><script>(function(w,i,g){w[g]=w[g]||[];if(typeof w[g].push=='function')w[g].push(i)})
(window,'AW-1055364430','google_tags_first_party');</script><script async src="/925q/"></script>
			<script>
				window.dataLayer = window.dataLayer || [];
				function gtag(){dataLayer.push(arguments);}
				gtag('js', new Date());
				gtag('set', 'developer_id.dYzg1YT', true);
				gtag('config', 'AW-1055364430');
			</script>
			
<!--Meta stuff-->
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.0.0/animate.min.css"/>
<script src="https://kit.fontawesome.com/9881acdaa7.js" crossorigin="anonymous"></script>
<script type="text/javascript" src="js/lagged.js"></script>
<title>Mommy Long Legs Escape</title>
<style>
    * {
        -moz-box-sizing: border-box;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        font-family: sans-serif;
        font-weight: 400;
        outline: none;
        user-select: none;
    }
    body {
        margin: 0;
        overflow: hidden;
    }
    #loading {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        color: white;
        text-align: center;
        font-size: 30px;
        font-weight: 100;
        background-color: #4153A5;
        text-shadow:         /* create a black outline */
        -1px -1px 0 #000,
         0   -1px 0 #000,
         1px -1px 0 #000,
         1px  0   0 #000,
         1px  1px 0 #000,
         0    1px 0 #000,
        -1px  1px 0 #000,
        -1px  0   0 #000;

    }
    #loading>div {
        margin-top: 30vh;
    }
    .progress {
        margin-top: 1vh;
        display: inline-block;
        border-radius: 10vw;
        width: 50vw;
        height: 1.5vw;
        background-color: #2B292A;
    }
    #progressbar {
        width: 0;
        border-radius: 10vw;
        height: 1.5vw;
        background: rgb(253,105,41);
        background: -moz-linear-gradient(90deg, rgba(253,105,41,1) 19%, rgba(244,192,41,1) 100%);
        background: -webkit-linear-gradient(90deg, rgba(253,105,41,1) 19%, rgba(244,192,41,1) 100%);
        background: linear-gradient(90deg, rgba(253,105,41,1) 19%, rgba(244,192,41,1) 100%);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr="#fd6929",endColorstr="#f4c029",GradientType=1);
    }
    #lagged {
        margin-bottom: 10vh;
        display: inline-block;
        width: 30vh;
        height: 30vh;
        background-image: url(Images/lagged.png);
        background-repeat: no-repeat;
        background-size:contain;
    }
    #c {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        display: block;
    }
    #menuUI {
        position: fixed;
        text-align: center;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        visibility: hidden;
    }
    #title {
        position: fixed;
        right: 10px;
        top: 30%;
        width: 600px;
        height: 70px;
        background-image: url(Images/title.png);
        background-repeat: no-repeat;
        background-size: contain;
        opacity: 0.9;
    }
    #laggedMenu {
        position: fixed;
        right: 16px;
        bottom: 20px;
        width: 250px;
        height: 200px;
        background-image: url(Images/lagged.png);
        background-repeat: no-repeat;
        background-size: contain;
    }
    #btnPlay {
        position: fixed;
        right: 29px;
        top: 44%;
        width: 440px;
        height: 71px;
        background-image: url(Images/btnPlay.png);
        background-repeat: no-repeat;
        background-size: contain;
        opacity: 0.9;
    }
    #tutorial {
        position: fixed;
        text-align: center;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        visibility: hidden;
    }
    #tutorialImage {
        display: inline-block;
        width: 700px;
        height: 500px;
        background-image: url(Images/keyboardControls.png);
        background-repeat: no-repeat;
        background-size: contain;
        margin-top: 250px;
    }
    #gameUI {
        position: fixed;
        text-align: center;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        visibility: hidden;
    }
    #lvlNo {
        display: inline-block;
        margin-top: 5px;
        text-align: center;
        color: white;
        font-size: 300%;
        font-weight: 800;
        text-shadow: 0px 4px 0px rgba(0, 0, 0, 0.6),2px 2px 4px #000000,         /* create a black outline */
        -1px -1px 0 #000,
         0   -1px 0 #000,
         1px -1px 0 #000,
         1px  0   0 #000,
         1px  1px 0 #000,
         0    1px 0 #000,
        -1px  1px 0 #000,
        -1px  0   0 #000;
        opacity: 0.6;
    }
    #collectedList{
        display: inline-block;
        text-align: center;
        list-style-type:none;
        width: 100%;
        margin: 0;
        padding: 0;
        margin-top: 10px;
    }
    #collectedList li {
        display: inline-block;
        margin-left: 5px;
        background-image: url(Images/imageIcon.png);
        background-repeat: no-repeat;
        background-size:contain;
        width: 70px;
        height: 70px;
        opacity: 0.3;
    }
    #gameOverUI {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        text-align: center;
        visibility: hidden;
        background-color: rgba(0,0,0,0.5);
    }
    #moreGames {
        display: inline-block;
        width: 300px;
        height: 340px;
        background-color: rgba(0,0,0,0.5);
        color: white;
        margin-top: -0.5%;
    }
    /* add #moreGames h3 and .thumbWrapper style ~lagged template */
    #moreGames h3{float:left;clear:both;width:100%;line-height:16px;height:16px;font-size:16px;font-weight:600;padding-top:3px}
    .thumbWrapper{float:left;overflow:hidden;position:relative;background-color:#a5a5a5;box-shadow:0 0 4px 0 rgba(0,0,0,.5);margin:3% 0 0 5%;width:43%;padding-bottom:43%;border-radius:5px}
    .thumbWrapper div{position: absolute;top:0;left:0;right:0;bottom:0;overflow:hidden;border-radius:5px}
    .thumbWrapper a{position: absolute; top:0;left:0;bottom:0;right:0;z-index:200;text-indent:-99999px}
    .thumbWrapper img{width:100%;height:100%;border-radius:2px}
    .thumbWrapper span.thumbname{position:absolute;transition:bottom .6s ease;font-size:15px;font-weight:700;letter-spacing:1px;width:100%;bottom:-125%;left:0;height:auto;min-height:18px;line-height:20px;padding:7px 0 4px;text-align:center;text-transform:uppercase;background-color:rgba(42,100,144,.8);color:#fff;border-bottom-left-radius:2px;border-bottom-right-radius:2px}
    .thumbWrapper:hover span{display:block}

    #btnNext{
        display: inline-block;
        margin-top: 16vh;
        background-image: url(Images/btnNextLevel.png);
        background-repeat: no-repeat;
        background-size:contain;
        width: 300px;
        height: 140px;
    }
    #btnRestart{
        display: inline-block;
        margin-top: 16vh;
        background-image: url(Images/btnRestart.png);
        background-repeat: no-repeat;
        background-size:contain;
        width: 300px;
        height: 140px;
    }
    #goMessage {
        color: white;
        font-size: 300%;
        font-weight: 800;

        display: inline-block;
        margin-top: 1%;
        text-shadow: 0px 4px 0px rgba(0, 0, 0, 0.6),2px 2px 4px #000000,
        -1px -1px 0 #000,
         0   -1px 0 #000,
         1px -1px 0 #000,
         1px  0   0 #000,
         1px  1px 0 #000,
         0    1px 0 #000,
        -1px  1px 0 #000,
        -1px  0   0 #000;
    }
    /*SEPERATE THEN GAME AND GAMEOVER UI BUTTONS*/
    #btnSound {
        position: fixed;
        left: 10px;
        top: 15px;
        font-size: 30px;
        visibility: hidden;
        color: white;
    }
    .button {
        transition: all .1s;
        cursor: pointer;
        user-select: none;
    }
    .button:hover {
        transform: scale(1.15);
    }
    /*RESPONSIVE*/
    #rotateDeviceBG {
        background-color: rgba(0,0,0,1);
        position: fixed;
        width: 100%;
        height: 100%;
        text-align: center;
        visibility: hidden;
    }
    .phone {
        margin-top: 20%;
        display: inline-block;
        height: 100px;
        width: 200px;
        border: 4px solid white;
        border-radius: 10px;
        animation: rotate 1.5s ease-in-out infinite alternate;
    }
    .message {
        position: fixed;
        width: 100%;
        height: 10%;
        left: 0;
        text-align: center;
        color: white;
        font-size: 200%;
        font-weight: 800;
        bottom: 10%;
      /* display: none; */
    }
    #redFX{
        position: fixed;
        right: 0%;
        top: 0%;
        width: 100%;
        height: 100%;
        background-color: rgba(255,0,0,0.3);
        visibility: hidden;
        user-select: none;
        pointer-events: none;
        --animate-duration: 0.6s;
    }
    @keyframes rotate {
      0% {
            transform: rotate(0deg)
        }
        50% {
            transform: rotate(-90deg)
        }
        100% {
            transform: rotate(-90deg)
        }
    }
    #touchLeft {
        position: fixed;
        left: 0%;
        top: 0%;
        width: 50%;
        height: 100%;
        opacity: 0.5;
    }
    #touchRight {
        position: fixed;
        right: 0%;
        top: 0%;
        width: 50%;
        height: 100%;

    }
    @media only screen and (max-width: 900px) {
        #loading {
            font-size: 20px;
        }
        .progress {
            width: 70vw;
        }
        #title {
            width: 300px;
        }
        #laggedMenu {
            width: 150px;
            height: 100px;
        }
        #btnPlay {
            width: 240px;
            height: 71px;
        }
        #lvlNo {
            font-size: 200%;
        }
        #collectedList li {
            width: 40px;
            height: 40px;
        }
        #btnSound {
            font-size: 25px;
        }
        #moreGames {
            width: 200px;
            height: 200px;
            margin-top: -1.5%;
        }
        #goMessage {
            font-size: 150%;
            font-weight: 800;
            margin-top: 1%
        }
        #btnNext{
            width: 200px;
            height: 90px;
            margin-top: 12vh;
        }
        #btnRestart{
            width: 200px;
            height: 90px;
            margin-top: 12vh;
        }
    }

</style>

</head>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r113/three.min.js"></script>
<script src="./Libs/FBXLoader.js"></script>
<script src="./Libs/inflate.min.js"></script>
<script src="./Libs/SkeletonUtils.js"></script>
<script src="./Libs/virtualjoystick.js"></script>

<div id="loading" onclick="init();" style="display:block;z-index:5000">
    <div>
        <div id="lagged"></div>
        <div id="progressText">0%</div>
        <div class="progress"><div id="progressbar"></div></div>

        <div id="loadplay">Loading...</div>
    </div>
</div>

<canvas id="c"></canvas>

<div id="menuUI">
    <div id="title"></div>
    <div id="laggedMenu"></div>
    <div id="btnPlay" class="button" onclick="btnPlay()"></div>
</div>

<div id="tutorial">
    <div id="tutorialImage"></div><br>
</div>

<div id="gameUI">
    <div id="lvlNo">Level 1</div><br>
    <ul id="collectedList">

    </ul>
    <div id="touchLeft" ></div>
    <div id="touchRight" ></div>
</div>

<div id="gameOverUI">
    <div id="btnRestart" onclick="btnRestart()" class="animate__animated animate__rubberBand animate__infinite animate__slow button"></div><br>
    <div id="btnNext" onclick="btnNext()" class="animate__animated animate__rubberBand animate__infinite animate__slow button"></div><br>
    <div id="moreGames">

<!--can use these defaults for more games ~lagged template-->

      <h3>More Games</h3>
      <div class="thumbWrapper newboxshadow firstgame"><div>
      <a href="https://lagged.com/en/g/poppy-playtime" target="_blank">Poppy Playtime</a>
      <img src="https://imgs2.dab3games.com/poppy-playtime-game45.png" width="200" height="200" alt="game" />
      <span class="thumbname"><span>Poppy Playtime</span></span>
      </div></div>

      <div class="thumbWrapper newboxshadow"><div>
      <a href="https://lagged.com/en/g/baby-in-yellow" target="_blank" title="game">Baby in Yellow</a>
      <img src="https://imgs2.dab3games.com/baby-in-yellow-game34.png" width="200" height="200" alt="game" />
      <span class="thumbname"><span>Baby in Yellow</span></span>
      </div></div>

    <div class="thumbWrapper newboxshadow"><div>
    <a href="https://lagged.com/en/g/baldi-2" target="_blank" title="game">Baldi 2</a>
    <img src="https://imgs2.dab3games.com/baldi-2-game.png" width="200" height="200" alt="game" />
    <span class="thumbname"><span>Baldi 2</span></span>
    </div></div>

    <div class="thumbWrapper newboxshadow"><div>
    <a href="https://lagged.com/en/g/momo-scary-story" target="_blank">Momo Scary Story</a>
    <img src="https://imgs2.dab3games.com/momo-horror-game839.png" width="200" height="200" alt="game" />
    <span class="thumbname"><span>Momo Scary Story</span></span>
    </div></div>

  </div>
    <br>
    <div id="goMessage" class="animate__animated animate__tada animate__infinite">Level Complete!</div><br>
</div>

<div id="btnSound"  class="button" onclick="btnSound()"><i class="fa-solid fa-volume-high"></i></div>

<div id="redFX" class="animate__fast"></div>

<div id="rotateDeviceBG">
    <div class="phone">
    </div>
    <div class="message">
      Please rotate your device!
    </div>
</div>

<script>
// GLOBAL VAR
//console.warn = function(){};
var scene = null;
var camera = null;
var renderer = null;
var clock = new THREE.Clock();
var onMobile = false;
var jumpScareCamera = null;
var jumpScareScene = null;
var joystick = null;

// RESETABLE VARS
var player = null;
var mommy = null;
var gameOver = false;
var level = 0;
let loadSave = null;
var levelSave = 0;
// try{
//     loadSave = parseInt(localStorage.getItem("MommyLongLegsSave"));
// }catch(e){
//   console.log(e);
// }
// if (loadSave){
//     levelSave = loadSave;
// }

var totalDolls = 0;

// RESETABLE ARRAYS
var updateArray = [];
var doorArray = [];
var blinkLightsArray = [];
var colliders = [];
var triggersArray = [];
var dollArray = [];

const BaseModel = {
    level0: {url: 'Models/level0.fbx'},
    menu: {url: 'Models/menu.fbx'},
    level1: {url: 'Models/level1.fbx'},
    level2: {url: 'Models/level2.fbx'},
    level3: {url: 'Models/level3.fbx'},
    level4: {url: 'Models/level4.fbx'},
    level5: {url: 'Models/level5.fbx'},
    level6: {url: 'Models/level6.fbx'},
    level7: {url: 'Models/level7.fbx'},
    level8: {url: 'Models/level8.fbx'},
    level9: {url: 'Models/level9.fbx'},
    level10: {url: 'Models/level10.fbx'},
    doll: {url: 'Models/doll.fbx'},
}
const Anims = {
    /*run: {url: 'Models/Anim_Running.fbx'},*/
}
const Textures = {
    mummyNormal: {url: 'Images/mummyNormal.png'},
}
const Sound = {
    button: {url: 'Sound/button.mp3'},
    gameOver: {url: 'Sound/gameOver.mp3'},
    jumpscare: {url: 'Sound/jumpscare.mp3'},
    music: {url: 'Sound/music.mp3'},
    walk: {url: 'Sound/walk.mp3'},
    collect: {url: 'Sound/collect.mp3'},
}

// DOM elements
const CANVAS = document.querySelector('#c');
const PROGRESS_TEXT = document.querySelector('#progressText');
const TUTORIAL = document.querySelector('#tutorial');
const TUTORIAL_IMAGE = document.querySelector('#tutorialImage');
const MENU_UI = document.querySelector('#menuUI');
const GAME_UI = document.querySelector('#gameUI');
const LEVEL_TEXT = document.querySelector('#lvlNo');
const COLLECTED_LIST = document.querySelector('#collectedList');
const GAMEOVER_UI = document.querySelector('#gameOverUI');
const GO_MESSAGE = document.querySelector('#goMessage');
const BTN_RESTART = document.querySelector('#btnRestart');
const BTN_NEXT = document.querySelector('#btnNext');
const BTN_SOUND = document.querySelector('#btnSound');
const RED_FX = document.querySelector('#redFX');
const ROTATE_MSG  = document.querySelector('#rotateDeviceBG');
const TOUCH_LEFT = document.querySelector('#touchLeft');
const TOUCH_RIGHT = document.querySelector('#touchRight');
var isloadready=false;
function preload() {
    const progressbarElem = document.querySelector('#progressbar');
    let manager = new THREE.LoadingManager();
    manager.onStart = function ( url, itemsLoaded, itemsTotal ) {
        //console.log( 'Started loading file: ' + url + '.\nLoaded ' + itemsLoaded + ' of ' + itemsTotal + ' files.' );
        LaggedAPI.init('lagdev_2', 'ca-pub-8999528956543364');
    };
    manager.onLoad = function ( ) {

        //init();

        // const loadingElem = document.querySelector('#loading');
        // loadingElem.style.display = 'none';

        isloadready=true;
        document.getElementById("loadplay").innerHTML="Click to Play";


    };
    manager.onProgress = function ( url, itemsLoaded, itemsTotal ) {
        //console.log( 'Loading file: ' + url + '.\nLoaded ' + itemsLoaded + ' of ' + itemsTotal + ' files.' );
        progressbarElem.style.width = `${itemsLoaded / itemsTotal * 100 | 0}%`;
        PROGRESS_TEXT.innerHTML = `${itemsLoaded / itemsTotal * 100 | 0}%`;
    };
    manager.onError = function ( url ) {
        //console.log( 'There was an error loading ' + url );
    };

    var loader = new THREE.FBXLoader( manager );
    // load base character model
    for (const model of Object.values(BaseModel)) {
        loader.load( model.url, function ( fbx ) {
            model.fbx = fbx;
        });
    }
    // load anims
    for (const model of Object.values(Anims)) {
        loader.load( model.url, function ( fbx ) {
            //model.fbx = fbx;
            model.animation = fbx.animations[ 0 ];
        });
    }
    // load textures
    var loaderTex = new THREE.TextureLoader(manager);
    for (const img of Object.values(Textures)) {
        loaderTex.load( img.url, function(texture) {
            texture.encoding = THREE.sRGBEncoding;
            img.texture = texture;
        });
    }
    // load audio
    Sound.listener = new THREE.AudioListener();
    const audioLoader = new THREE.AudioLoader( manager );
    for (const key of Object.values(Sound)) {
        audioLoader.load( key.url, function(buffer) {
            key.sound = new THREE.Audio( Sound.listener );
            key.sound.setBuffer( buffer );
            key.sound.setVolume( 2 );
            if (key.url == 'Sound/music.mp3'){
                key.sound.setLoop( true );
                key.sound.setVolume( 0.7 );
            }
        });
    }

    // Load Mommy hahahahaha :)
    loader.load( 'Models/mommy.fbx', function( object ) {
        object.traverse(function(child) {
            if (child instanceof THREE.Mesh) {
                const oldMat = child.material;
                child.material = new THREE.MeshPhongMaterial( {
                    skinning : true,
                    map: oldMat.map,
                    normalMap: Textures.mummyNormal.texture,
                });
            }
        });
        object.scale.set(8,8,8);
        object.rotation.x = THREE.Math.degToRad(90);
        BaseModel.mommy = object;
        BaseModel.mommy.animationsArray = object.animations;
    });
}

function init(){
  if(!isloadready){return;}

  LaggedAPI.APIAds.show(function() {
  });

  const loadingElem = document.querySelector('#loading');
  loadingElem.style.display = 'none';

    if (is_touch_device()){
        onMobile = true;
        joystick	= new VirtualJoystick({
            container	: TOUCH_LEFT,
            mouseSupport	: true,
            strokeStyle	: 'white',
            limitStickTravel: true,
            stickRadius	: 50
        });
        TOUCH_RIGHT.addEventListener('touchmove', touchMoved, false);
        TOUCH_RIGHT.addEventListener('touchstart', touchStart, false);

    }
    BTN_SOUND.style.visibility = "visible";
    GAME_UI.style.visibility = "visible";

    renderer = new THREE.WebGLRenderer({canvas: CANVAS, antialias: false,});
    renderer.setPixelRatio( 0.5 );
    renderer.autoClear = false;
    renderer.setSize( window.innerWidth, window.innerHeight );
    renderer.outputEncoding = THREE.sRGBEncoding;


    camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 14000 );
    camera.position.set(0, 500, 1000);
    camera.lookAt(0,0,0);
    camera.add( Sound.listener );

    scene = new THREE.Scene();
    scene.background = new THREE.Color( 0x000000 );

    jumpScareCamera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 5000);
    jumpScareScene = new THREE.Scene();

    window.addEventListener( 'resize', onWindowResize, false );
    window.addEventListener("mousemove", onMouseMove, false);
    window.addEventListener("keydown", onKeyDown, false);
    window.addEventListener("keyup", onKeyUp, false);
    GAME_UI.onclick = function () {
         this.requestPointerLock();
    }

    setUpLevel(0);
    animate();
    Sound.walk.sound.play();
    Sound.walk.sound.pause();
}

function setUpMenu() {
  try{
    document.exitPointerLock();
  }catch(e){
    console.log(e);
  }
    GAME_UI.style.visibility = "hidden";
    MENU_UI.style.visibility = "visible";
    camera.position.set(200, 200, -400);
    camera.lookAt(-10, 200, 0);
    level = 'menu';
    mommy = new Mommy(false);
    mommy.group.visible = false;
    let firstLight = true;
    let levelModel = BaseModel.menu.fbx.clone();
    levelModel.traverse(function ( child ) {
        if ( child instanceof THREE.Mesh ) {
            const oldMat = child.material;
            child.material = new THREE.MeshPhongMaterial( {map: oldMat.map, side: THREE.DoubleSide, shininess: 0});
            if (oldMat.name.substring(0,5) == 'trans'){
                child.material = new THREE.MeshPhongMaterial( { map: oldMat.map, transparent: true, emissiveIntensity: 2 });
            }
            if (oldMat.name == 'Light'){
                let pointLight = new THREE.PointLight( 0xFFFFFF, 1, 1000 );
                pointLight.position.x = child.position.x;
                pointLight.position.y = child.position.y-50;
                pointLight.position.z = child.position.z;
                scene.add( pointLight );
                pointLight.timer = 2;
                child.material = new THREE.MeshBasicMaterial( { map: oldMat.map });
                blinkLightsArray.push(pointLight);
                pointLight.model = child;
                if (firstLight){
                    pointLight.timer = 8;
                }
                firstLight = false;
            }
        }
    });
    scene.add(levelModel);
    //levelModel.position.y = -230;
}

function setUpLevel(levelNum) {
    GAME_UI.style.visibility = "visible";
    MENU_UI.style.visibility = "hidden";
    GAMEOVER_UI.style.visibility = "hidden";
    // LIGHTS
    var ambientLight = new THREE.AmbientLight( 0xFFFFFF, 0.01 );
    scene.add( ambientLight );
    // PLAYER AND MOMMY
    player = new Player();
    //mommy = new Mommy(true); //HEHEHEH
    // ENVIRONMENT - LEVEL
    if (level == 0){
        LEVEL_TEXT.innerHTML = "INTRO";
        if (!onMobile){
            TUTORIAL_IMAGE.style.backgroundImage = 'url(Images/keyboardControls.png)';
        }else {
            TUTORIAL_IMAGE.style.backgroundImage = 'url(Images/touchControls.png)';
            TUTORIAL_IMAGE.style.width = '80%';
            TUTORIAL_IMAGE.style.height = '100%';
            TUTORIAL_IMAGE.style.marginTop = '20px';
        }
        TUTORIAL.style.visibility = "visible";
        setTimeout(function(){
            TUTORIAL.style.visibility = "hidden";
        },6000)
    }
    else {
        LEVEL_TEXT.innerHTML = "LEVEL "+level;
    }

    levelModel = null;
    if (level < 11)
        levelModel = eval('BaseModel.level'+levelNum+'.fbx.clone()');
    else {
        let randomLevel = rand(5,10);
        levelModel = eval('BaseModel.level'+randomLevel+'.fbx.clone()');
    }
    levelModel.traverse(function ( child ) {
        if ( child instanceof THREE.Mesh ) {
            const oldMat = child.material;
            child.material = new THREE.MeshPhongMaterial( {map: oldMat.map, side: THREE.DoubleSide, shininess: 0});
            if (oldMat.name == 'Door_White'){
                doorArray.push(child);
                child.rotateTo = child.rotation.z;//THREE.Math.degToRad(155);
                child.defaultRotation = child.rotation.z;
            }
            if (oldMat.name == 'collision'){
                colliders.push(child);
                child.material = new THREE.MeshBasicMaterial( { visible: false });
                child.box3 = new THREE.Box3().setFromObject(child);
            }
            if (oldMat.name == 'trigger'){ // mommy trigger
                triggersArray.push(child);
                child.material = new THREE.MeshBasicMaterial( { visible: false });
                child.box3 = new THREE.Box3().setFromObject(child);
            }
            if (oldMat.name.substring(0,5) == 'trans'){
                child.material = new THREE.MeshLambertMaterial( { map: oldMat.map, transparent: true, });
            }
            if (oldMat.name == 'Light'){
                let pointLight = new THREE.PointLight( 0xFFFFFF, 1, 1000 );
                pointLight.position.x = child.position.x;
                pointLight.position.y = child.position.y-50;
                pointLight.position.z = child.position.z;
                scene.add( pointLight );
                pointLight.timer = rand(30, 80);
                child.material = new THREE.MeshBasicMaterial( { map: oldMat.map });
                blinkLightsArray.push(pointLight);
                pointLight.model = child;
            }
            if (oldMat.name == 'doll'){
                let doll = BaseModel.doll.fbx.clone();
                child.visible = false;
                doll.traverse(function ( child ) {
                    if ( child instanceof THREE.Mesh ) {
                        const oldMat2 = child.material;
                        child.material = new THREE.MeshPhongMaterial( { emissiveIntensity: 1.3, map: oldMat2.map,});
                    }
                });
                scene.add(doll);
                doll.position.copy(child.position);
                doll.position.y = -175;
                doll.scale.set(0.7,0.7,0.7);
                doll.box3 = new THREE.Box3().setFromObject(doll);
                dollArray.push(doll);
            }
        }
    });
    scene.add(levelModel);
    levelModel.position.y = -230;
    totalDolls = dollArray.length;
    COLLECTED_LIST.innerHTML = "";
    if (totalDolls > 0){
        for (let i = 0; i < totalDolls; i ++){
            var li = document.createElement("li");
            //li.setAttribute("class", "you");
            COLLECTED_LIST.appendChild(li);
        }
    }
    camera.lookAt(0,0,0);
    inputs.yaw = 0;
    inputs.pitch = 0;
}

function Player() {
    var self = {
        score: 0,
        position: new THREE.Vector3(0, 0, 0),
        velocity: new THREE.Vector3(),
        maxMovementSpeed: 4,
        friction: 0,
        acceleration: 0,
        maxSpeedTime: 0.2,
        stopTime: 0.2,
        raycaster: new THREE.Raycaster(),
        dirTemp: new THREE.Vector3(0,0,0),
        posTemp: new THREE.Vector3(),
        sin: 0,
        state: 'idle',
        initialCooldown: 100,
        dollsCollected: 0,
    }
    self.init = function(){
        self.friction= self.maxMovementSpeed / self.stopTime;
        self.acceleration= self.friction + self.maxMovementSpeed / self.maxSpeedTime;

        // boundingbox
        self.box = new THREE.Mesh(new THREE.BoxGeometry(70, 220, 60), new THREE.MeshBasicMaterial( { color: 0x124463, wireframe:true, /*side: THREE.DoubleSide,*/ visible: false }));
        scene.add(self.box);
        self.box3 = new THREE.Box3().setFromObject(self.box);

        // Flashlight
        self.spotLight = new THREE.SpotLight(0xffffff, 1, 0, Math.PI * 0.12, 0.4);
        scene.add(self.spotLight);
        scene.add( self.spotLight.target );
    }
    self.getMovementDir = function() {
        var moveDir = new THREE.Vector3();
        if (inputs.moveForward) {
            moveDir.x += Math.sin(inputs.yaw);
            moveDir.z += Math.cos(inputs.yaw);
        } else if (inputs.moveBackward) {
            moveDir.x -= Math.sin(inputs.yaw);
            moveDir.z -= Math.cos(inputs.yaw);
        }
        if (inputs.moveRight) {
            moveDir.x -= Math.cos(inputs.yaw);
            moveDir.z += Math.sin(inputs.yaw);
        } else if (inputs.moveLeft) {
            moveDir.x += Math.cos(inputs.yaw);
            moveDir.z -= Math.sin(inputs.yaw);
        }
        return moveDir;
    }
    self.move = function(delta) {
        var moveDir = self.getMovementDir();

        var acc = self.acceleration;
        var fric = self.friction;

        var max = self.maxMovementSpeed;

        accelerate(delta, self.velocity, moveDir, acc, max);
        friction(delta, self.velocity, fric);

        self.position.add(self.velocity);
        self.box.position.copy(self.position);
        //self.box.position.y += 50;
    }
    self.collision = function(delta){
        for (let i in colliders){
            let child = colliders[i];
            if (child instanceof THREE.Mesh) {
                collision = self.box3.intersectsBox(child.box3);
                if (collision){

                    var overlapX = Math.min( self.box3.max.x, child.box3.max.x ) - Math.max( self.box3.min.x, child.box3.min.x );

                    if ( overlapX < 0 ) return false;

                    var overlapY = Math.min( self.box3.max.y, child.box3.max.y ) - Math.max( self.box3.min.y, child.box3.min.y );

                    if ( overlapY < 0 ) return false;

                    var overlapZ = Math.min( self.box3.max.z, child.box3.max.z ) - Math.max( self.box3.min.z, child.box3.min.z );

                    if ( overlapZ < 0 ) return false;

                    var minOverlap = Math.min( overlapX, overlapZ );
                    var x = y = z = 0;

                    switch ( minOverlap ) {

                        case overlapX:

                            x = Math.sign( self.box3.min.x + self.box3.max.x - child.box3.min.x - child.box3.max.x );
                            self.position.x += (x * minOverlap);
                            break;

                        case overlapY:

                            y = Math.sign( self.box3.min.y + self.box3.max.y - child.box3.min.y - child.box3.max.y );
                            break;

                        case overlapZ:

                            z = Math.sign( self.box3.min.z + self.box3.max.z - child.box3.min.z - child.box3.max.z );
                            self.position.z += (z * minOverlap);
                            break;
                    }
                }
            }
        }

        // opening closing doors when near and looking at
        self.posTemp.copy(camera.position);
        camera.getWorldDirection(self.dirTemp);
        self.raycaster.set(self.posTemp,self.dirTemp);
        const intersect = self.raycaster.intersectObjects(doorArray);
        if (intersect.length>0){
            if (intersect[0].distance < 500){
                // open doors
                intersect[0].object.rotateTo = intersect[0].object.defaultRotation+THREE.Math.degToRad(-150);
            }
            else {
                intersect[0].object.rotateTo = intersect[0].object.defaultRotation;
            }
        }

        // trigger check
        self.initialCooldown -= 100*delta;
        for (let i in triggersArray){
            let child = triggersArray[i];
            let collision = self.box3.intersectsBox(child.box3);
            if (collision && self.initialCooldown < 0){
                // trigger jump scare
                mommy = new Mommy(true); //HEHEHEH
                triggersArray = [];
                self.redFX();
                if (Sound.jumpscare.sound.isPlaying)
                    Sound.jumpscare.sound.stop();
                Sound.jumpscare.sound.play();
            }
        } // collect dolls
        for (let i in dollArray){
            let child = dollArray[i];
            let collision = self.box3.intersectsBox(child.box3);
            if (collision && self.initialCooldown < 0){
                scene.remove(dollArray[i]);
                dollArray.splice(i,1);
                let child_nodes = COLLECTED_LIST.childNodes;
                child_nodes[self.dollsCollected].style.opacity = '1';
                self.dollsCollected ++;
                Sound.collect.sound.play();
                if (self.dollsCollected == totalDolls){
                    gameOverFunction('win');
                }
            }
        }
    }
    self.redFX = function() {
        RED_FX.style.visibility = "visible";
        RED_FX.classList.add('animate__animated', 'animate__fadeOut');
        RED_FX.addEventListener('animationend', removeMenu);
        function removeMenu() {
            RED_FX.removeEventListener('animationend', removeMenu);
            RED_FX.classList.remove('animate__animated', 'animate__fadeOut');
            RED_FX.style.visibility = "hidden";
            RED_FX.style.opacity = "1";
        }
    }
    self.update = function(delta) {
        self.box3.setFromObject(self.box);
        if(!gameOver) {
            self.box3.setFromObject(self.box);
            self.collision(delta);
            self.move(delta);

            // Flashlight
            self.spotLight.position.copy(camera.position);
            self.posTemp.x = camera.position.x;
            self.posTemp.z = camera.position.z;
            camera.getWorldDirection(self.dirTemp);
            var distance = 1000; // at what distance to determine pointB
            var pointB = new THREE.Vector3();
            pointB.addVectors ( self.posTemp, self.dirTemp.multiplyScalar( distance ) );
            let flashLightDelay = 7;
            self.spotLight.target.position.x = THREE.Math.lerp( self.spotLight.target.position.x, pointB.x, flashLightDelay*delta  );
            self.spotLight.target.position.y = THREE.Math.lerp( self.spotLight.target.position.y, pointB.y, flashLightDelay*delta  );
            self.spotLight.target.position.z = THREE.Math.lerp( self.spotLight.target.position.z, pointB.z, flashLightDelay*delta  );
            //

            // WALK ANIM + RUN
            if (inputs.moveLeft || inputs.moveRight || inputs.moveForward || inputs.moveBackward) {
                self.sin += 20*delta;
                self.state = 'walk';
                self.maxMovementSpeed = 6;
                Sound.walk.sound.play();
            }
            else {
                self.state = 'idle';
                Sound.walk.sound.pause();
            }
            //

            // CAMERA AS PLAYER
            camera.quaternion.setFromEuler(new THREE.Euler(inputs.pitch, inputs.yaw + Math.PI, 0, "YXZ"));
            //camera.position.copy(self.position);
            camera.position.x = self.position.x;
            camera.position.z = self.position.z;
            // WALK ANIM
            if (self.state != 'idle'){
                // if (self.state == 'run')
                //     camera.position.y +=  Math.sin(self.sin)*(600*delta);
                // else
                    camera.position.y +=  Math.sin(self.sin)*(300*delta);
            }
            if (self.state == 'idle'){
                camera.position.y = 0;
            }
            //
        }
        else if (gameOver){
        }
    }

    self.init();
    updateArray.push(self);
    return self;
}

function Mommy(jumpscare) {
    var self = {
        group: null,
        model: null,
        mixer: null,
    }
    self.init = function(){
        //animations[7] - jump down
        //[8] - crawl from insideout kind
        //[9] - walk looking Right
        //[10] - walk
        //[12] - jumpscare
        //[13] - walk with surrounding close

        if (jumpscare)
            self.createJumpScare();
        else
            self.createMenu();
    }
    self.createMenu = function() { // normal model in normal scene
        console.log('creatingNormal');
        self.group = new THREE.Object3D();
        scene.add(self.group);
        self.model = THREE.SkeletonUtils.clone(BaseModel.mommy);
        self.model.traverse( function( object ) { object.frustumCulled = false; } );

        self.group.position.set(0,-50,650);
        self.group.add(self.model);
        self.group.rotation.y = THREE.Math.degToRad(180);
        //self.group.rotation.x = THREE.Math.degToRad(-60);
        self.mixer = new THREE.AnimationMixer(self.model);
        self.anim1 = self.mixer.clipAction(THREE.AnimationUtils.subclip(BaseModel.mommy.animations[6], 'idle', 1, 175, 10 ));
        self.anim1.play();
    }
    self.createJumpScare = function() { // jumpscare model in special scene
        console.log('creatingJumpScare');
        self.group = new THREE.Object3D();
        jumpScareScene.add(self.group);
        self.model = THREE.SkeletonUtils.clone(BaseModel.mommy);
        self.model.traverse( function( object ) { object.frustumCulled = false; } );

        self.group.position.set(140,-260,-120);
        self.group.add(self.model);
        //self.group.rotation.y = THREE.Math.degToRad(180);
        //self.group.rotation.x = THREE.Math.degToRad(-60);
        self.group.rotation.z = 0.5;
        self.group.rotation.x = -0.6;
        self.mixer = new THREE.AnimationMixer(self.model);
        self.jumpScare = self.mixer.clipAction(THREE.AnimationUtils.subclip(BaseModel.mommy.animations[12], 'idle', 1, 34, 30 ));
        self.jumpScare.setLoop( THREE.LoopOnce );
        self.jumpScare.clampWhenFinished = true;
        self.jumpScare._clip.name = "jumpScare"
        self.mixer.addEventListener( 'finished', function( e ) {
            if (e.action._clip.name == "jumpScare"){
                reset();
                if (level == 0){
                    setUpMenu();
                }
                else {
                    gameOverFunction('loose');
                }
            }
        });
        self.jumpScare.play();
        let pointLight = new THREE.PointLight( 0xFFFFFF, 2, 1000 );
        pointLight.position.x = -200;
        pointLight.position.y = 200;
        pointLight.position.z = 0;
        jumpScareScene.add( pointLight );
    }
    self.update = function(delta) {
        self.mixer.update(delta);
    }

    self.init();
    updateArray.push(self);
    return self;
}

function gameOverFunction(type) {
    Sound.walk.sound.pause();
    Sound.gameOver.sound.play();
    try{
      document.exitPointerLock();
    }catch(e){
      console.log(e);
    }
    console.log(type);
    gameOver = true;
    GAMEOVER_UI.style.visibility = "visible";
    if (type == 'loose'){
        //Sound.gameOver.sound.play();
        GO_MESSAGE.innerHTML = "Try Again..!";
        BTN_RESTART.style.display = "inline-block";
        BTN_NEXT.style.display = "none";

    }else {
        //Sound.applause.sound.play();
        level ++;
        // Save
        try{
            localStorage.setItem("MommyLongLegsSave",level);
        }catch(e){
          console.log(e);
        }
        GO_MESSAGE.innerHTML = "Level Complete!";
        BTN_RESTART.style.display = "none";
        BTN_NEXT.style.display = "inline-block";

        var ach=false;
        var ach_numb=[];
        //lvl 2
        if(level>2){
            ach=true;
            ach_numb.push("poppy_playtimchaptwo_vkf001");
        }
        //lvl 5
        if(level>5){
            ach=true;
            ach_numb.push("poppy_playtimchaptwo_vkf002");
        }
        //lvl 10
        if(level>10){
            ach=true;
            ach_numb.push("poppy_playtimchaptwo_vkf003");
        }

        //can push more then one award at a time
        if(ach){
            LaggedAPI.Achievements.save(ach_numb, function(response) {
                if(response.success) {
                    console.log('achievement saved')
                }else {
                    console.log(response.errormsg);
                }
            });
        }

    }

    // LaggedAPI.APIAds.show(function(){
    //   console.log("ad completed");
    // });

}

function reset() {
    for( var i = scene.children.length - 1; i >= 0; i--)
        scene.remove(scene.children[i]);
    for( var i = jumpScareScene.children.length - 1; i >= 0; i--)
        jumpScareScene.remove(jumpScareScene.children[i]);
    player = null;
    mommy = null;
    gameOver = false;
    updateArray = [];
    doorArray = [];
    blinkLightsArray = [];
    colliders = [];
    triggersArray = [];
    //totalDolls = 0;
    dollArray = [];
}

// BUTTONS
function btnRestart() {

  reset();
  LaggedAPI.APIAds.show(function() {
    setUpLevel(level);
  });

    //Sound.button.sound.play();

}

function btnNext() {

  reset();
  LaggedAPI.APIAds.show(function() {
    setUpLevel(level);
  });

    //Sound.button.sound.play();

}

function btnSound() {
    Sound.button.sound.play();
    if (BTN_SOUND.style.opacity == 1){
        BTN_SOUND.style.opacity = 0.5;
        Sound.listener.setMasterVolume(0);
    }
    else {
        BTN_SOUND.style.opacity = 1;
        Sound.listener.setMasterVolume(1);
    }
}

// CONTROLS
var inputs = {
  moveForward: false,
  moveBackward: false,
  moveLeft: false,
  moveRight: false,
  run: false,
  yaw: 0,
  pitch: 0,
};
var active = false;
document.onpointerlockchange = function () {
    if (document.pointerLockElement) {
        active = true;
        if (!Sound.music.sound.isPlaying)
            Sound.music.sound.play();
    } else {
        active = false;
    }
}


var previousEvent = {screenX: 0, screenY: 0};
function touchStart(event) {
    let touch = event.changedTouches[0];
    previousEvent.screenX = touch.pageX;
    previousEvent.screenY = touch.pageY;
    if (!Sound.music.sound.isPlaying)
        Sound.music.sound.play();
}
function touchMoved(event) {
    let movementX = 0;
    let movementY = 0;
    let touch = event.changedTouches[0];
    movementX = touch.pageX - previousEvent.screenX;
    movementY = touch.pageY - previousEvent.screenY;

    inputs.yaw -= movementX * 0.0001;// 0.001
    inputs.pitch -= movementY * 0.0001;// 0.001
    if (inputs.pitch < -1.5){
        inputs.pitch = -1.5;
    }
    else if (inputs.pitch > 1.5){
        inputs.pitch = 1.5;
    }

}


function onMouseMove(event) {
  if (active) {
    inputs.yaw -= event.movementX * 0.003;// 0.001
    inputs.pitch -= event.movementY * 0.003;// 0.001
      if (inputs.pitch < -1.5){
          inputs.pitch = -1.5;
      }
      else if (inputs.pitch > 1.5){
          inputs.pitch = 1.5;
      }
  }
}

function onKeyDown(event) {
  switch (event.keyCode) {
    case 87:
      inputs.moveForward = true;
      break;
    case 83:
      inputs.moveBackward = true;
      break;
    case 65:
      inputs.moveLeft = true;
      break;
    case 68:
      inputs.moveRight = true;
      break;
    case 82: // R to restart
        reset();
        setUpMenu();
        break;
    case 16:
      inputs.run = true;
      break;
  }
}

function onKeyUp(event) {
  switch (event.keyCode) {
    case 87:
      inputs.moveForward = false;
      break;
    case 83:
      inputs.moveBackward = false;
      break;
    case 65:
      inputs.moveLeft = false;
      break;
    case 68:
      inputs.moveRight = false;
      break;
    case 16:
      inputs.run = false;
      break;
  }
}

// ACTUAL GAME
function animate(){
    requestAnimationFrame( animate );
    var delta = clock.getDelta();

    for (let i in updateArray){
        updateArray[i].update(delta);
    }
    for (let i in doorArray){
        doorArray[i].rotation.z = THREE.Math.lerp( doorArray[i].rotation.z, doorArray[i].rotateTo, 2*delta  );
    }
    for (let i in dollArray){
        dollArray[i].rotation.y += 1.3*delta;
    }
    for (let i in blinkLightsArray){
        blinkLightsArray[i].timer -= 10*delta;
        if (blinkLightsArray[i].timer < 0){
            blinkLightsArray[i].timer = rand(30, 80);
            blinkLightsArray[i].intensity = 0;
            blinkLightsArray[i].model.visible = false;
            if (level == 'menu' && i == 0){
                mommy.group.visible = true;
            }
            setTimeout(function(){
                blinkLightsArray[i].intensity = 0.5;
                blinkLightsArray[i].model.visible = true;
                if (level == 'menu' && i == 0){
                    mommy.group.visible = false;
                }
                setTimeout(function(){
                    blinkLightsArray[i].intensity = 0;
                    blinkLightsArray[i].model.visible = false;
                    if (level == 'menu' && i == 0){
                        mommy.group.visible = true;
                    }
                    setTimeout(function(){
                        blinkLightsArray[i].intensity = 1;
                        blinkLightsArray[i].model.visible = true;
                        if (level == 'menu' && i == 0){
                            mommy.group.visible = false;
                        }
                    }, 1000)
                }, 1000)
            }, 1000)
        }
    }

    touchControls();
    showLandscapeMessage();
    render();
}
preload();

function render() {
  renderer.clear();
  renderer.render(scene, camera);
  renderer.clearDepth();
  renderer.render(jumpScareScene, jumpScareCamera);
}

// HELPER AND EXTRA STUFF
function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    jumpScareCamera.aspect = window.innerWidth / window.innerHeight;
    jumpScareCamera.updateProjectionMatrix();

    renderer.setSize( window.innerWidth, window.innerHeight );
}

function rand(min, max) {
    min = Math.ceil(min);
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min + 1)) + min; //The maximum is inclusive and the minimum is inclusive
}

function showLandscapeMessage() { // landscape on mobile
    if (onMobile) {
        if (window.innerWidth < window.innerHeight){
            ROTATE_MSG.style.visibility = "visible";
        }
        else if (ROTATE_MSG.style.visibility == "visible"){
            ROTATE_MSG.style.visibility = "hidden";
        }
    }
}

function is_touch_device() {
  try {
    document.createEvent("TouchEvent");
    return true;
  } catch (e) {
    return false;
  }
}

// HELPER MOve
function accelerate(delta, velocity, moveDir, acceleration, maxSpeed) {
  var projection = velocity.dot(moveDir);
  var amount = acceleration * delta;
  if (maxSpeed && projection + amount > maxSpeed) {
    amount = maxSpeed - projection;
  }
  velocity.add(moveDir.clone().multiplyScalar(amount));
}

function friction(delta, velocity, amount) {
  var speed = Math.hypot(velocity.x, velocity.z);
  if (speed > 0) {
    var newSpeed = speed - amount * delta;
    if (newSpeed < 0) newSpeed = 0;
    velocity.x *= newSpeed / speed;
    velocity.z *= newSpeed / speed;
  }
}

function btnPlay() {
    Sound.button.sound.play();

    reset();
    // after menu, level will always say "menu", so save level in a var and now use it or start at 1
    if (levelSave > 1){
      level = levelSave
    }else{
      level = 1;
    }

        LaggedAPI.APIAds.show(function() {
          setUpLevel(level);
        });

}

// TOUCH WALKING
function touchControls() {
    if (!joystick) return;

    if ( joystick.left() ) {
        inputs.moveLeft = true;
    }
    else if (inputs.moveLeft) {
        inputs.moveLeft = false;
    }
    if ( joystick.right() ) {
        inputs.moveRight = true;
    }
    else if (inputs.moveRight){
        inputs.moveRight = false;
    }
    if ( joystick.up() ) {
        inputs.moveForward = true;
    }
    else if (inputs.moveForward){
        inputs.moveForward = false;
    }
    if ( joystick.down() ) {
        inputs.moveBackward = true;
    }
    else if (inputs.moveBackward){
        inputs.moveBackward = false;
    }
}

</script>
</body>
</html>
