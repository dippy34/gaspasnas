<!DOCTYPE html>
<html class="sl-theme-dark" lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Proxy - Nova Hub</title>
	<link rel="icon" href="/nova-favicon.ico" />
	<link rel="stylesheet" href="/style.css" />
	<link rel="stylesheet" href="/css/gaming-theme.css" />
	<script src="/js/all.min.js"></script>
	<script src="/js/proxy.js"></script>
	<script src="/js/gaming-navbar.js"></script>
	<style>
		.proxy-page {
			display: flex;
			flex-direction: column;
			min-height: 100vh;
			min-height: 100dvh;
			background: var(--gaming-bg, #000);
			padding-top: 4.5rem; /* clear fixed gaming navbar */
			box-sizing: border-box;
		}
		.proxy-toolbar {
			flex-shrink: 0;
			display: flex;
			align-items: center;
			gap: 0.5rem;
			padding: 0.5rem 1rem;
			background: rgba(0, 0, 0, 0.95);
			border-bottom: 1px solid var(--gaming-border, rgba(0, 255, 0, 0.3));
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
		}
		.proxy-toolbar input[type="url"],
		.proxy-toolbar input[type="text"] {
			flex: 1;
			min-width: 0;
			padding: 0.5rem 1rem;
			font-size: 1rem;
			background: var(--inputbg, rgba(0, 0, 0, 0.8));
			border: 1px solid var(--gaming-border);
			border-radius: 4px;
			color: var(--gaming-text, #fff);
			font-family: 'Rajdhani', sans-serif;
		}
		.proxy-toolbar input::placeholder {
			color: var(--gaming-text-dim, #888);
		}
		.proxy-toolbar input:focus {
			outline: none;
			box-shadow: 0 0 0 2px var(--gaming-accent);
		}
		.proxy-toolbar button {
			flex-shrink: 0;
			padding: 0.5rem 1rem;
			background: rgba(0, 255, 0, 0.15);
			border: 1px solid var(--gaming-accent);
			border-radius: 4px;
			color: var(--gaming-accent);
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s ease;
		}
		.proxy-toolbar button:hover {
			background: rgba(0, 255, 0, 0.25);
			box-shadow: 0 0 10px var(--gaming-glow);
		}
		.proxy-toolbar button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}
		.proxy-gateway-row {
			flex-shrink: 0;
			display: flex;
			align-items: center;
			gap: 0.5rem;
			padding: 0.35rem 1rem;
			background: rgba(0, 0, 0, 0.6);
			border-bottom: 1px solid var(--gaming-border, rgba(0, 255, 0, 0.2));
			font-size: 0.9rem;
		}
		.proxy-gateway-row label {
			color: var(--gaming-text-dim, #888);
			white-space: nowrap;
		}
		.proxy-gateway-row input {
			flex: 1;
			min-width: 0;
			padding: 0.35rem 0.6rem;
			font-size: 0.9rem;
			background: var(--inputbg, rgba(0, 0, 0, 0.8));
			border: 1px solid var(--gaming-border);
			border-radius: 4px;
			color: var(--gaming-text, #fff);
		}
		.proxy-gateway-row input::placeholder {
			color: var(--gaming-text-dim, #666);
		}
		.proxy-frame-wrap {
			flex: 1;
			min-height: 0;
			position: relative;
			background: #000;
		}
		.proxy-frame {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			border: none;
			display: block;
		}
		body.gaming-theme .proxy-page,
		body.ocean-theme .proxy-page,
		body.purple-theme .proxy-page,
		body.sunset-theme .proxy-page {
			background: var(--gaming-bg);
		}
	</style>
</head>
<body id="noscroll" class="gaming-theme">
	<main class="proxy-page">
		<div class="proxy-toolbar">
			<button type="button" id="proxy-back" title="Back" aria-label="Back">←</button>
			<button type="button" id="proxy-reload" title="Reload" aria-label="Reload">↻</button>
			<form id="proxy-form" style="flex:1;min-width:0;display:flex;gap:0.5rem;">
				<input type="text" id="proxy-input" name="url" placeholder="Enter URL or search..." spellcheck="false" enterkeyhint="go" />
				<button type="submit" id="proxy-go">Go</button>
			</form>
			<button type="button" id="proxy-newtab" title="Open in new tab" aria-label="Open in new tab">↗</button>
		</div>
		<div class="proxy-gateway-row">
			<label for="proxy-gateway">Proxy gateway:</label>
			<input type="text" id="proxy-gateway" name="gateway" placeholder="e.g. https://your-proxy.com/ or https://proxy.com/?url= (avoids X-Frame-Options)" spellcheck="false" />
		</div>
		<div class="proxy-frame-wrap">
			<iframe id="proxy-frame" class="proxy-frame" title="Proxy browser" src="about:blank" sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox allow-downloads"></iframe>
		</div>
	</main>
	<script>
		(function () {
			var GATEWAY_KEY = 'nova.proxyGateway';
			var form = document.getElementById('proxy-form');
			var input = document.getElementById('proxy-input');
			var gatewayInput = document.getElementById('proxy-gateway');
			var frame = document.getElementById('proxy-frame');
			var backBtn = document.getElementById('proxy-back');
			var reloadBtn = document.getElementById('proxy-reload');
			var newTabBtn = document.getElementById('proxy-newtab');

			// Persist gateway
			try {
				var saved = localStorage.getItem(GATEWAY_KEY);
				if (saved != null) gatewayInput.value = saved;
			} catch (e) {}
			gatewayInput.addEventListener('change', function () {
				try { localStorage.setItem(GATEWAY_KEY, gatewayInput.value.trim()); } catch (e) {}
			});
			gatewayInput.addEventListener('blur', function () {
				try { localStorage.setItem(GATEWAY_KEY, gatewayInput.value.trim()); } catch (e) {}
			});

			function getGateway() {
				return (gatewayInput && gatewayInput.value ? gatewayInput.value : '').trim();
			}

			/** Build the URL to load in the iframe: use gateway if set to avoid X-Frame-Options. */
			function buildFrameSrc(normalizedUrl) {
				var gw = getGateway();
				if (!gw) return normalizedUrl;
				var enc = encodeURIComponent(normalizedUrl);
				if (gw.indexOf('?') !== -1) {
					// Query style: ?url= or &url= or append &url=
					if (/[?&]url=$/.test(gw)) return gw + enc;
					return gw + (gw.charAt(gw.length - 1) === '&' || gw.charAt(gw.length - 1) === '?' ? '' : '&') + 'url=' + enc;
				}
				return gw.replace(/\/?$/, '') + '/' + enc;
			}

			function currentDisplayUrl() {
				try {
					var href = frame.contentWindow.location.href;
					if (href && href !== 'about:blank') return href;
				} catch (e) {}
				return '';
			}

			function goToUrl(url) {
				if (!url) return;
				var normalized = window.NovaProxy ? window.NovaProxy.normalizeUrl(url) : url;
				input.value = normalized;
				frame.src = buildFrameSrc(normalized);
			}

			form.addEventListener('submit', function (e) {
				e.preventDefault();
				goToUrl(input.value.trim());
			});

			backBtn.addEventListener('click', function () {
				try {
					if (frame.contentWindow && frame.contentWindow.history.length > 1) {
						frame.contentWindow.history.back();
						input.value = frame.contentWindow.location.href;
					}
				} catch (err) {
					// Cross-origin: can't read history; no-op
				}
			});

			reloadBtn.addEventListener('click', function () {
				try {
					frame.contentWindow.location.reload();
				} catch (err) {
					if (frame.src && frame.src !== 'about:blank') {
						frame.src = frame.src;
					}
				}
			});

			newTabBtn.addEventListener('click', function () {
				var u = (input.value || '').trim();
				if (!u) return;
				var normalized = window.NovaProxy ? window.NovaProxy.normalizeUrl(u) : u;
				window.open(normalized, '_blank', 'noopener,noreferrer');
			});

			// Optional: sync input when frame navigates (same-origin only)
			frame.addEventListener('load', function () {
				var u = currentDisplayUrl();
				if (u) input.value = u;
			});

			// Start at Google on first load (optional)
			var hash = (window.location.hash || '').slice(1);
			if (hash) {
				goToUrl(decodeURIComponent(hash));
			} else {
				input.placeholder = 'Enter URL or search...';
			}
		})();
	</script>
</body>
</html>
